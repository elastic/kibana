/*
 * Licensed to Elasticsearch B.V. under one or more contributor
 * license agreements. See the NOTICE file distributed with
 * this work for additional information regarding copyright
 * ownership. Elasticsearch B.V. licenses this file to you under
 * the Apache License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *    http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */

import { platform } from 'os';
import { REPO_ROOT } from '../repo_root';

const SCRIPT_SOURCE_SH = `#!/bin/sh
#
# ** THIS IS AN AUTO-GENERATED FILE **
# ** PLEASE DO NOT CHANGE IT MANUALLY **
#
# GENERATED BY KIBANA \`node scripts/register_kbn_node\`
# IF YOU WANT TO CHANGE SOMETHING IN THIS SCRIPT
# PLEASE RE-RUN 'yarn kbn bootstrap' or 'node scripts/register_kbn_node'

DIR=${REPO_ROOT}
CONFIG_DIR=\${KIBANA_PATH_CONF:-"$DIR/config"}

# Setup node dev options file to node.dev.options
NODE_DEV_OPTIONS_FILE=\${CONFIG_DIR}/node.dev.options

# Fallback to node.ci.options in case node.dev.options not exists
if [ ! -f "$NODE_DEV_OPTIONS_FILE" ]; then
  NODE_DEV_OPTIONS_FILE=\${CONFIG_DIR}/node.ci.options
fi

NODE_OPTIONS="$(grep -v ^# < $NODE_DEV_OPTIONS_FILE | xargs) $NODE_OPTIONS" exec "node" \${@}
`;

const SCRIPT_SOURCE_CMD = `::
:: ** THIS IS AN AUTO-GENERATED FILE **
:: ** PLEASE DO NOT CHANGE IT MANUALLY **
::
:: GENERATED BY KIBANA \`node scripts/register_kbn_node\`
:: IF YOU WANT TO CHANGE SOMETHING IN THIS SCRIPT
:: PLEASE RE-RUN 'yarn kbn bootstrap' or 'node scripts/register_kbn_node'

@echo off

SETLOCAL ENABLEDELAYEDEXPANSION

set DIR=${REPO_ROOT}

set CONFIG_DIR=%KIBANA_PATH_CONF%
If [%KIBANA_PATH_CONF%] == [] (
  set CONFIG_DIR=%DIR%config
)

:: Setup node dev options file to node.dev.options
set NODE_DEV_OPTIONS_FILE=%CONFIG_DIR%\\node.dev.options

:: Fallback to node.ci.options in case node.dev.options not exists
If not exist "%NODE_DEV_OPTIONS_FILE%" (
  set NODE_DEV_OPTIONS_FILE=%CONFIG_DIR%\\node.ci.options
)

for /F "eol=# tokens=*" %%i in (%NODE_DEV_OPTIONS_FILE%) do (
  If [!NODE_OPTIONS!] == [] (
    set "NODE_OPTIONS=%%i"
  )Else (
    set "NODE_OPTIONS=!NODE_OPTIONS! %%i"
  )
)

:: This should run independently as the last instruction
:: as we need NODE_OPTIONS previously set to expand
node %*

:finally

ENDLOCAL
`;

export function getScriptSource() {
  return platform() === 'win32' ? SCRIPT_SOURCE_CMD : SCRIPT_SOURCE_SH;
}
