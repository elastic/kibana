# APM Server

This module provides a CLI and API for running APM Server instances. We want to start running APM Server instances in CI along with Kibana and ES, so we needed a mechanism that provides us with a few important features:

 - control over which version is running per-branch
 - automate-able verification and promotion of revisions from upstream project branches to be used in CI. We don't want to lag too far behind upstream branches or have breaking changes from upstream projects automatically deployed to CI and break everything
 - simple API to run instances on developer machines and in CI that automatically picks the right revision, creates a fresh install of that package, and runs using sensible defaults for our use-cases.
 - long-term support for old branches which may need to be tested in the future

This module accomplishes these goals by interacting with a GCS bucket where we are storing APM Server distributions which were previously built from the latest changes on a number of [elastic/apm-server](https://github.com/elastic/apm-server) branches. The process of building these distributables is independent from this effort, we use a REST API to pull information about recent builds by version, download the artifacts from these builds, validate their checksums, do additional validation to ensure compatibility, and then finally upload them to our GCS bucket where they can be downloaded by other users of this tool. An illustration of this process:

 1. `node scripts/apm_server staging-download --version 7.14.0-SNAPSHOT` is executed which talks to the Artifacts API and downloads the latest build created for version `7.14.0-SNAPSHOT`, which is the version associated with the `7.14` branch of [elastic/apm-server](https://github.com/elastic/apm-server). The artifacts are downloaded to a special "staging" area in Kibana's `data/test-apm-server` directory so that they are separate from artifacts downloaded for normal operation of this tool
 2. `node scripts/apm_server run --staging` is executed (or alternatively `ApmServer#run({ staging: true })`) to start the APM server, make sure that process works, and can be combined with other tools to verify that this revision of the APM server distributable is compatible with Kibana tests/CI/development needs.
 3. `node scripts/apm_server staging-upload --branch 7.14 --force --promote` is executed to upload the staging artifacts to the GCS bucket, `--force` prevents the CLI from requesting confirmation before uploading, and `--promote` prevents the CLI from requesting confirmation before promoting the newly uploaded artifacts to be the "latest", meaning they can be uploaded but might not be used by all users immediately.
 4. `node scripts/apm_server run --branch 7.14` is executed (or alternatively `ApmServer#run({ branch: '7.14' })`), causing the "latest" version for the `7.14` branch to be fetched, which points to the artifact we just uploaded. The checksum of that artifact for our current platform is also fetched and compared to any artifacts we might have downloaded locally. Since we just uploaded this artifact it won't match any local `7.14` artifact we have locally cached so the local cache will be deleted and replaced with the asset from the GCS bucket. Finally the asset is extracted into an "install" directory, the `apm-server.yml` file is customized, and finally `./apm-server` is executed and run forever in the foreground, printing logs to the configured `ToolingLog` instance.