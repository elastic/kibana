rules:
  - name: 'ES|QL rule - layer 1'
    id: 'esql-parent-id'
    enabled: true
    tags: ['parent']
    schedule: '1m'
    # We previously called this entity key
    group_key: ['host.name']
    # Powered by ESQL variables
    variables:
      outcome: 'failure'
    # The "active" alert query. Do we want to append the status condition
    # Eg: EVAL status = "active"
    # programmatically to the user's query, or require a user to write it explicitly?
    esql: |
      FROM kbn-data-forge-fake_stack.message_processor-*
      | STATS 
          failure = COUNT(*) WHERE processor.outcome == ?outcome,
          total = COUNT(*)
        BY host.name
      | EVAL failure_rate = (failure * 100  / total)
      | WHERE failure_rate > 50
      | KEEP host.name, status, failure_rate
    timeField: '@timestamp'
    lookbackWindow: '5m'
    track:
      # Creates a recovery rule that tracks recovery events
      # on the level 1 rule when defined
      # Optionally can include a custom ESQL query for recovery events
      # Automatically adds an `internal` and `recovery` (maybe) tag/flag so we can hide from the UI
      # Or optionally set the rule type as recovery
      recovery:
        enabled: true
        schedule: '1m'
        lookbackWindow: '5m'
      # Create a flapping rule that tracks flapping events
      # Automatically adds an `internal` and `flapping` (maybe) tag/flag so we can hide from the UI
      # Or optionally set the rule type as flapping
      flapping:
        enabled: true
        schedule: '30m'
        lookbackWindow: '15m'
        recovery_count: 3
    notification_policies:
      active:
        - WHERE: 'host.name == "prod-*"'
          workflowId: 'prod-critical-workflow-id'
        - workflowId: 'default-active-workflow-id'
      flapping:
        - workflow:
            version: 1
            name: 'Notify on Flapping Rule'
            description: 'Sends a Slack notification when a rule is flapping.'
            triggers:
              - type: manual
            steps:
              - name: Send Slack message
                type: slack
                connector-id: 'slack-uuid-prod'
                with:
                  channel: '#alerts-flapping'
                  message: "Rule '{{rule.name}}' is flapping. Please investigate."
      recovered:
        - workflowId: 'standard-recovery-workflow-v1'
