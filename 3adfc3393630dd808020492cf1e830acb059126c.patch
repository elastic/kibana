From 3adfc3393630dd808020492cf1e830acb059126c Mon Sep 17 00:00:00 2001
From: Tiago Costa <tiagoffcc@hotmail.com>
Date: Tue, 5 Oct 2021 15:13:12 +0100
Subject: [PATCH] fix(NA): @elastic/apm-generator bazel build

---
 package.json                                 |  2 +-
 packages/BUILD.bazel                         |  3 ++-
 packages/elastic-apm-generator/BUILD.bazel   | 21 ++++++++++----------
 packages/elastic-apm-generator/tsconfig.json |  3 ++-
 4 files changed, 15 insertions(+), 14 deletions(-)

diff --git a/packages/BUILD.bazel b/packages/BUILD.bazel
index 75c8d700e2843..ace4f982b8515 100644
--- a/packages/BUILD.bazel
+++ b/packages/BUILD.bazel
@@ -3,7 +3,8 @@
 filegroup(
   name = "build",
   srcs = [
-     "//packages/elastic-datemath:build",
+      "//packages/elastic-apm-generator:build",
+      "//packages/elastic-datemath:build",
       "//packages/elastic-eslint-config-kibana:build",
       "//packages/elastic-safer-lodash-set:build",
       "//packages/kbn-ace:build",
diff --git a/packages/elastic-apm-generator/BUILD.bazel b/packages/elastic-apm-generator/BUILD.bazel
index 72e357efd2d8a..6b46b2b9181e5 100644
--- a/packages/elastic-apm-generator/BUILD.bazel
+++ b/packages/elastic-apm-generator/BUILD.bazel
@@ -7,10 +7,9 @@ PKG_REQUIRE_NAME = "@elastic/apm-generator"
 
 SOURCE_FILES = glob(
   [
-    "src/**/*",
-    "scripts/**/*",
-    "test/**/*",
+    "src/**/*.ts",
   ],
+  exclude = ["**/*.test.*"],
 )
 
 SRCS = SOURCE_FILES
@@ -26,25 +25,25 @@ NPM_MODULE_EXTRA_FILES = [
 ]
 
 RUNTIME_DEPS = [
+  "@npm//@elastic/elasticsearch",
   "@npm//lodash",
-  "@npm//utility-types",
-  "@npm//object-hash",
   "@npm//moment",
+  "@npm//object-hash",
+  "@npm//p-limit",
+  "@npm//utility-types",
   "@npm//uuid",
   "@npm//yargs",
-  "@npm//@elastic/elasticsearch",
-  "@npm//p-limit",
 ]
 
 TYPES_DEPS = [
+  "@npm//@elastic/elasticsearch",
+  "@npm//moment",
+  "@npm//p-limit",
   "@npm//@types/jest",
   "@npm//@types/lodash",
   "@npm//@types/node",
   "@npm//@types/uuid",
   "@npm//@types/object-hash",
-  "@npm//moment",
-  "@npm//@elastic/elasticsearch",
-  "@npm//p-limit",
 ]
 
 jsts_transpiler(
@@ -71,8 +70,8 @@ ts_project(
   declaration_map = True,
   emit_declaration_only = True,
   out_dir = "target_types",
-  source_map = True,
   root_dir = "src",
+  source_map = True,
   tsconfig = ":tsconfig",
 )
 
diff --git a/packages/elastic-apm-generator/tsconfig.json b/packages/elastic-apm-generator/tsconfig.json
index 54483d767cd76..534e8481dce9a 100644
--- a/packages/elastic-apm-generator/tsconfig.json
+++ b/packages/elastic-apm-generator/tsconfig.json
@@ -4,6 +4,7 @@
     "declaration": true,
     "declarationMap": true,
     "emitDeclarationOnly": true,
+    "outDir": "target_types",
     "rootDir": "./src",
     "sourceMap": true,
     "sourceRoot": "../../../../packages/elastic-apm-generator/src",
@@ -13,6 +14,6 @@
     ]
   },
   "include": [
-    "./**"
+    "./src/**/*.ts"
   ]
 }
