---
- job:
    name: elastic+kibana+7.x
    display-name: 'elastic / kibana # 7.x'
    description: Exhaustive testing of the Kibana 7.x branch.
    parameters:
    - string:
        name: branch_specifier
        default: refs/heads/7.x
        description: the Git branch specifier to build (&lt;branchName&gt;, &lt;tagName&gt;,
          &lt;commitId&gt;, etc.)
    properties:
    - github:
        url: https://github.com/elastic/kibana/
    - inject:
        properties-content: |-
          CI=true
          HOME=$JENKINS_HOME
    axes:
    - axis:
        type: slave
        name: node
        values:
        - immutable
    - axis:
        type: yaml
        filename: kibana/.ci/jobs.yml
        name: JOB
    yaml-strategy:
      exclude-key: exclude
      filename: kibana/.ci/jobs.yml
    triggers:
    - github
    - timed: '@hourly'
    builders:
    - shell: |-
        #!/usr/local/bin/runbld

        set -euo pipefail

        # Set GITHUB_TOKEN for reporting test failures
        set +x
        export VAULT_TOKEN=$(vault write -field=token auth/approle/login role_id="$VAULT_ROLE_ID" secret_id="$VAULT_SECRET_ID")
        unset VAULT_ROLE_ID VAULT_SECRET_ID
        export GITHUB_TOKEN=$(vault read -field=github_token secret/kibana-issues/dev/kibanamachine)
        export KIBANA_CI_REPORTER_KEY=$(vault read -field=value secret/kibana-issues/dev/kibanamachine-reporter)
        export PERCY_TOKEN=$(vault read -field=value secret/kibana-issues/dev/percy)
        unset VAULT_TOKEN
        set -x

        ./.ci/run.sh
    publishers:
    - email-ext:
        recipients: build-kibana@elastic.co
        content-type: html
        subject: '$PROJECT_NAME - Build # $BUILD_NUMBER - $BUILD_STATUS'
        body: ${SCRIPT,template="groovy-html.template"}
        matrix-trigger: only-parent
    - google-cloud-storage:
        credentials-id: kibana-ci-gcs-plugin
        uploads:
        - classic:
            file-pattern: kibana/target/kibana-*
            storage-location: gs://kibana-ci-artifacts/jobs/$JOB_NAME/$BUILD_NUMBER
            share-publicly: true
            upload-for-failed-jobs: true
            show-inline: true
        - classic:
            file-pattern: kibana/target/junit/**/*
            storage-location: gs://kibana-ci-artifacts/jobs/$JOB_NAME/$BUILD_NUMBER
            share-publicly: true
            upload-for-failed-jobs: true
            show-inline: true
        - classic:
            file-pattern: kibana/test/**/screenshots/**/*.png
            storage-location: gs://kibana-ci-artifacts/jobs/$JOB_NAME/$BUILD_NUMBER
            share-publicly: true
            upload-for-failed-jobs: true
            show-inline: true
        - classic:
            file-pattern: kibana/test/functional/failure_debug/html/*.html
            storage-location: gs://kibana-ci-artifacts/jobs/$JOB_NAME/$BUILD_NUMBER
            share-publicly: true
            upload-for-failed-jobs: true
            show-inline: true
        - classic:
            file-pattern: kibana/x-pack/test/**/screenshots/**/*.png
            storage-location: gs://kibana-ci-artifacts/jobs/$JOB_NAME/$BUILD_NUMBER
            share-publicly: true
            upload-for-failed-jobs: true
            show-inline: true
        - classic:
            file-pattern: kibana/x-pack/test/functional/failure_debug/html/*.html
            storage-location: gs://kibana-ci-artifacts/jobs/$JOB_NAME/$BUILD_NUMBER
            share-publicly: true
            upload-for-failed-jobs: true
            show-inline: true
        - classic:
            file-pattern: kibana/x-pack/test/functional/apps/reporting/reports/session/*.pdf
            storage-location: gs://kibana-ci-artifacts/jobs/$JOB_NAME/$BUILD_NUMBER
            share-publicly: true
            upload-for-failed-jobs: true
            show-inline: true
    - junit:
        results: kibana/target/junit/**/*.xml
        keep-long-stdio: true
        allow-empty-results: true
