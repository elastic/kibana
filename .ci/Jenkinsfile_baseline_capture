#!/bin/groovy

library 'kibana-pipeline-library'
kibanaLibrary.load()

kibanaPipeline(timeoutMinutes: 120) {
  githubCommitStatus.trackBuild(params.commit, 'kibana-ci-baseline') {
    ciStats.trackBuild {
      catchError {
        parallel([
          'oss-visualRegression': {
            workers.ci(name: 'oss-visualRegression', size: 's-highmem', ramDisk: true) {
              kibanaPipeline.functionalTestProcess('oss-visualRegression', './test/scripts/jenkins_visual_regression.sh')(1)
            }
          },
          'xpack-visualRegression': {
            workers.ci(name: 'xpack-visualRegression', size: 's-highmem', ramDisk: true) {
              kibanaPipeline.functionalTestProcess('xpack-visualRegression', './test/scripts/jenkins_xpack_visual_regression.sh')(1)
            }
          },
        ])
      }

      kibanaPipeline.sendMail()
      slackNotifications.onFailure()
    }
  }
}
