#!/bin/groovy

library 'kibana-pipeline-library'
kibanaLibrary.load()

kibanaPipeline(timeoutMinutes: 180) {
  slackNotifications.onFailure(
    disabled: !params.NOTIFY_ON_FAILURE,
    channel: '#security-solution-slack-testing'
  ) {
    catchError {
      withEnv([
        'CI_PARALLEL_PROCESS_NUMBER=1'
      ]) {
        def job = 'xpack-securityCypress'

        workers.ci(name: job, size: 'l', ramDisk: true) {
          kibanaPipeline.bash('test/scripts/jenkins_xpack_build_kibana.sh', 'Build Default Distributable')
          kibanaPipeline.functionalTestProcess(job, 'test/scripts/jenkins_security_solution_cypress.sh')()
        }
      }
    }
  }

  if (params.NOTIFY_ON_FAILURE) {
    kibanaPipeline.sendMail(to: 'siem_dev_team@elastic.co')
  }
}
