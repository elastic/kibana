/*
 * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one
 * or more contributor license agreements. Licensed under the "Elastic License
 * 2.0", the "GNU Affero General Public License v3.0 only", and the "Server Side
 * Public License v 1"; you may not use this file except in compliance with, at
 * your election, the "Elastic License 2.0", the "GNU Affero General Public
 * License v3.0 only", or the "Server Side Public License, v 1".
 */

import { readFileSync, existsSync } from 'fs';
import { join } from 'path';

import globby from 'globby';

import { REPO_ROOT } from '@kbn/repo-info';
import { run } from '@kbn/dev-cli-runner';
import { getPackages } from '@kbn/repo-packages';
import { File } from './file';
import { checkFileCasing } from './precommit_hook/check_file_casing';

const EXCEPTIONS_JSON_PATH = join(__dirname, 'exceptions.json');

run(
  async ({ log, flagsReader }) => {
    const generateExceptions = flagsReader.boolean('generate-exceptions');

    const paths = await globby('**/*', {
      cwd: REPO_ROOT,
      onlyFiles: true,
      gitignore: true,
      ignore: [
        '.buildkite/**/*',
        '.github/**/*',
        '**/__fixtures__/**/*',
        '**/__mocks__/**/*',
        '**/.*',
        '**/.codeql/**/*',
        '**/{Dockerfile,docker-compose.yml}',
        '**/*.codeql/**/*',
        '**/*.log',
        '**/*.txt',
        '**/+([A-Z_]).asciidoc',
        '**/+([A-Z_]).md',
        '**/+([A-Z_]).mdx',
        '**/apm-diagnostics-*.json',
        '**/assets/**/*',
        '**/bin/**/*',
        '**/build/**/*',
        '**/data/**/*',
        // ecs templates
        '**/ecs/fields/**/*',
        // Support for including http-client.env.json configurations
        '**/http-client.env.json',
        '**/LICENSE',
        // the gitignore: true option makes sure that we don't
        // include files from node_modules in the result, but it still
        // loads all of the files from node_modules before filtering
        // so it's still super slow. This prevents loading the files
        // and still relies on gitignore to final ignores
        '**/node_modules',
        '**/target',
        '**/test/**/fixtures/**/*',
        // filename must match language code which requires capital letters
        '**/translations/*.json',
        // Match elastic wide naming convention for catalog-info.yaml
        'catalog-info.yaml',
        'Dockerfile*',
        // Required to match the name in the docs.elastic.dev repo.
        'dev_docs/nav-kibana-dev.docnav.json',
        'docs/**/*',
        // generator templates use weird filenames based on the requirements for the files they're generating
        'packages/kbn-generate/templates/**/*',
        'packages/kbn-plugin-generator/template/**/*',
        'src/dev/code_coverage/ingest_coverage/integration_tests/mocks/**/*',
        // filename must match upstream filenames from handlebars
        'src/platform/packages/private/kbn-handlebars/.patches/**/*',
        'src/platform/packages/private/kbn-handlebars/src/upstream/**/*',
        // filename must match upstream filenames from lodash
        'src/platform/packages/shared/kbn-safer-lodash-set/**/*',
        'src/platform/packages/shared/kbn-test/*/jest-preset.js',
        'src/platform/packages/shared/kbn-utility-types/test-d/**/*',
        // updatecli configuration for driving the UBI/Ironbank image updates
        'updatecli-compose.yaml',
        'x-pack/platform/plugins/private/canvas/canvas_plugin_src/**/*',
        'x-pack/platform/plugins/private/canvas/tasks/**/*',
        'x-pack/platform/plugins/private/monitoring/public/lib/jquery_flot/**/*',
        'x-pack/platform/plugins/shared/cases/docs/**/*',
        'x-pack/platform/plugins/shared/fleet/cypress/packages/*.zip',
        'x-pack/platform/plugins/shared/maps/server/fonts/**/*',
        'x-pack/platform/test/api_integration_deployment_agnostic/apis/streams/snapshots',
        // naming convention follow this pattern: kb-product-doc-{{productName}}-{{versionMajor}}.{{versionMinor}}.zip: https://github.com/elastic/kibana/blob/33993b7123bc0d6c85d9c42b15610cc0d5092281/docs/reference/configuration-reference/ai-assistant-settings.md
        'x-pack/solutions/observability/test/api_integration_deployment_agnostic/apis/ai_assistant/complete/product_docs/**/*',
        // ignore autogenerated snapshots
        'x-pack/solutions/observability/test/api_integration_deployment_agnostic/apis/ai_assistant/knowledge_base/snapshots',
      ],
    });

    const files = paths.map((path) => new File(path));

    const packages = getPackages(REPO_ROOT);
    const packageRootDirs = new Set(
      packages
        .filter((pkg) => !pkg.isPlugin())
        .map((pkg) => pkg.normalizedRepoRelativeDir.replace(/\\/g, '/'))
    );

    let exceptions: Array<{ path: string; expected: string }> = [];
    if (existsSync(EXCEPTIONS_JSON_PATH)) {
      try {
        const raw = readFileSync(EXCEPTIONS_JSON_PATH, 'utf8');
        const data = JSON.parse(raw);
        exceptions = Array.isArray(data) ? data : [];
      } catch {
        exceptions = [];
      }
    }

    await checkFileCasing(log, files, {
      packageRootDirs,
      exceptions,
      generateExceptions,
    });
  },
  {
    flags: {
      boolean: ['generate-exceptions'],
      help: `
        --generate-exceptions  Collect current violations and append them to exceptions.json, then exit successfully.
      `,
    },
  }
);
