---
id: kibCoreDeprecationsService
slug: /kibana-dev-docs/services/deprecations-service
title: Core Deprecations service
description: The Deprecations service helps surface deprecated configs and features for plugins to our users
date: 2021-06-27
tags: ['kibana','dev', 'contributor', 'api docs']
---

# Core Deprecations service
This guide is written in the format of a FAQ to help you get started using the deprecations service.
For more details on the service contract we have documented all the service apis and properties under the
deprecation service docs generated by in core.

## What is the deprecations service?
The deprecations service provides a way for the Kibana platform to communicate deprecated features
and configs with its users. These deprecations are only communicated to the user if the deployment is using
these features, allowing for a user tailored experience for upgrading the stack version.

The Upgrade Assistant (UA) is the main consumer of these deprecations. The UA displays them to users and signals to
Cloud that the Stack is ready for a major upgrade.


## Where are deprecations displayed to users?
The Upgrade Assistant (UA) in Kibana is consuming the core deprecations service in order to surface plugin
deprecations. Each deprecation is required to provide manual steps that we display in the UI. Additionally
each deprecation can provide an optional API to automatically resolve the deprecation.

To check your plugin deprecations, go to the UA interface via **Stack Management > Stack > Upgrade Assistant**
and click on `View deprecations` under the Kibana section.

To display deprecations in the UA set `xpack.upgrade_assistant.readonly: false` in the kibana configurations.
The UA is in read-only mode and will be enabled up until the last minor before the next major release.

## How do I use this service for deprecated plugin configurations?
The deprecations service automatically hooks deprecated configs with the deprecations service. 

All the config deprecation functions (`unused`, `unusedFromRoot`, `rename`, `renameFromRoot`) accept an
optional parameter to customize the deprecation details.

To read more about the deprecation functions check `/kibana-dev-docs/corePluginApi` in the new doc
system under `core.ConfigDeprecationFactory`. You can also check the `ConfigDeprecationFactory`
[interface docs](../../../../src/platform/packages/shared/kbn-config/src/deprecation/types.ts).

### Example
```ts
export const config: PluginConfigDescriptor<ConfigType> = {
  schema: configSchema,
  deprecations: ({ renameFromRoot }) => [
    renameFromRoot('ui_metric.debug', 'usageCollection.uiCounters.debug', {
      documentationUrl: 'elastic.co/some-url',
    }),
  ],
};
```

The service will show the following deprecation details when the users set the above deprecated kibana
config `ui_metric.debug`.

```ts
import { i18n } from '@kbn/i18n';

{
  deprecationsInfo:[{
    domainId: 'usageCollection',
    title: i18n.translate('usageCollection.uiCounters.deprecations.uiMetricDebugTitle', {
      defaultMessage: 'Setting "ui_metric.debug" is deprecated',
    });
    level: 'critical',
    title: i18n.translate('usageCollection.uiCounters.deprecations.uiMetricDebugMessage', {
      defaultMessage: '"ui_metric.debug" is deprecated and has been replaced by "usageCollection.uiCounters.debug"',
    });
    documentationUrl: 'elastic.co/some-url',
    correctiveActions:{
      manualSteps: [
        title: i18n.translate('usageCollection.uiCounters.deprecations.uiMetricDebug.manualStepOneMessage', {
          defaultMessage: 'Replace "ui_metric.debug" with "usageCollection.uiCounters.debug" in the Kibana config file, CLI flag, or environment variable (in Docker only).',
        }),
      ]
    },
  }],
}
```

#### Custom deprecations for plugin configs
Custom config deprecation handling allows specifying the deprecation details via the `addDeprecation`.

##### Example

```ts
import { i18n } from '@kbn/i18n';

export const config: PluginConfigDescriptor<ConfigSchema> = {
  exposeToBrowser: {
    defaultAppId: true,
  },
  schema: configSchema,
  deprecations: () => [
    (
      completeConfig: Record<string, any>,
      rootPath: string,
      addDeprecation: AddConfigDeprecation
    ) => {
      if (
        get(completeConfig, 'kibana.defaultAppId') === undefined &&
        get(completeConfig, 'kibana_legacy.defaultAppId') === undefined
      ) {
        return completeConfig;
      }
      addDeprecation({
        title: i18n.translate('kibana_legacy.deprecations.defaultAppIdTitle', {
          defaultMessage: 'Setting "kibana.defaultAppId" is deprecated',
        }),
        message: i18n.translate('kibana_legacy.deprecations.defaultAppIdMessage', {
          defaultMessage: 'Use the "defaultRoute" advanced setting instead of "kibana.defaultAppId".',
        }),
        correctiveActions: {
          manualSteps: [
            i18n.translate('kibana_legacy.deprecations.defaultAppId.manualStepOneMessage', {
              defaultMessage: 'Go to Stack Management > Advanced Settings.',
            }),
            i18n.translate('kibana_legacy.deprecations.defaultAppId.manualStepTwoMessage', {
              defaultMessage: 'Update the "defaultRoute" setting in the General section.',
            }),
            i18n.translate('kibana_legacy.deprecations.defaultAppId.manualStepThreeMessage', {
              defaultMessage: 'Remove "kibana.defaultAppId" from the kibana.yml config file.',
            }),
          ],
        },
      });
      return completeConfig;
    },
  ],
};
```

## How do I add deprecations for non-config plugin deprecations?
Plugins are responsible for registering any deprecations during the `setup` lifecycle by using
the deprecations service.

Examples of non-config deprecations include things like
- kibana_user security roles 

This service is not intended to be used for non-user facing deprecations or cases where the deprecation
cannot be 'detected' by this mechanism.

### Usage
```ts
coreSetup.deprecations.registerDeprecations({
  getDeprecations: ({ esClient, savedObjectsClient }) => [{ ...`<list of deprecations>` }],
});
```

The `getDeprecations` function is invoked when the user requests to see the deprecations affecting their deployment.
The function provides a context object which contains a scoped Elasticsearch client and a Saved Objects client.

⚠️When using the Saved Objects client, bear in mind that all Spaces must be checked for deprecations:
By default, the Saved Objects client retrieves data from the current Space only. To override this behavior, add the 
option `namespaces: ['*']` to search in all Spaces. When getting by ID, it's best to loop through all the spaces and get with `namespaces: [mySpaceOverride]`.  

To check the full TS types of the service please check the [generated core docs](https://docs.elastic.dev/kibana-dev-docs/api/kbn-core-deprecations-server).

### Example
```ts
import { DeprecationsDetails, GetDeprecationsContext } from 'src/core/server';
import { i18n } from '@kbn/i18n';

async function getDeprecations({ esClient, savedObjectsClient }: GetDeprecationsContext): Promise<DeprecationsDetails[]> {
  const deprecations: DeprecationsDetails[] = [];
  const testDashboardUser = await getTestDashboardUser(savedObjectsClient);

  if (testDashboardUser) {
    deprecations.push({
      title: i18n.translate('security.deprecations.kibanaUserRoleTitle', {
        defaultMessage: 'Deprecated roles are assigned to some users',
      }),
      message: i18n.translate('security.deprecations.kibanaUserRoleMessage', {
        defaultMessage: 'User "test_dashboard_user" is using a deprecated role: "kibana_user".',
      }),
      documentationUrl: 'https://www.elastic.co/guide/en/elasticsearch/reference/current/security-api-put-user.html',
      level: 'critical',
      correctiveActions: {
        api: {
            path: '/internal/security/users/test_dashboard_user',
            method: 'POST',
            body: {
              username: 'test_dashboard_user',
              roles: [
                'machine_learning_user',
                'enrich_user',
                'kibana_admin'
              ],
              full_name: 'Alison Goryachev',
              email: 'alisongoryachev@gmail.com',
              metadata: {},
              enabled: true
            }
        },
        manualSteps: [
          i18n.translate('security.deprecations.kibanaUserRole.manualStepOneMessage', {
            defaultMessage: 'Switch all users with the "kibana_user" role to the kibana_admin role in Management > Security > Users.',
          }),
          i18n.translate('security.deprecations.kibanaUserRole.manualStepTwoMessage', {
            defaultMessage: 'Update all mappings in Management > Security > Role Mappings to assign the "kibana_admin" role instead of the "kibana_user" role.'
          }),
        ],
      },
    });
  }

  return deprecations;
}
 ```

## How do I implement the API corrective action?
The deprecations API allows plugins to provide an API call that can be used to automatically fix specific deprecations.
To do so create a `PUT` or `POST` route in your plugin and specify data you want to be passed in the payload for the deprecation.

In the example above, `/internal/security/users/test_dashboard_user` will be called when users click on `Quick Resolve` in the UA. The service will automatically pass the body provided in the api corrective action to provide context to the route for fixing the deprecation. If you need to omit the deprecation details context in the request of the body, you can use the property `omitContextFromBody`.

The deprecations service expects a `200` status code to recognize the corrective action as a success.

## How do I test my deprecations?
We recommend testing the route for your api corrective actions via unit and plugin functional tests.
To check the deprecation in the UI please check the UA page.

To test that your logic registering the deprecations with the deprecations service during `setup` is valid we recommend adding
unit tests to check that the `getDeprecations` is returning the expected array of deprecations at different scenarios.

Core provides mocks for the service which should help you focus on testing only your specific requirements.

You can also use the deprecations service API; The deprecations service exposes an api `GET /api/deprecations/` which provides
a list of deprecations and possible corrective actions required to resolve these entries. The context is scoped to the requesting
user, hence a user with limited access might not be able to see all the deprecations affecting the deployment.

Currently we do not have test objects to run functional tests against the Upgrade Assistant directly.

## Should I use the service for all the deprecations before 8.0?
Yes. Using this service should help users find and resolve any issues specific to their deployment before upgrading.
We recommend adding a `documentationUrl` for every deprecation you expose to further assist our users if they need extra help.

## Writing deprecation details

State what is being deprecated and what action the user needs to take:

> Abc is deprecated. Use Xyz to do the thing.

Provide as much context as possible for what triggered the deprecation warning.
If action is not required (for example the default behavior is changing), describe the impact of doing nothing.

Examples:
- > Setting `xpack.reporting.roles.enabled` is deprecated. Use feature controls to grant reporting privileges. 
- > The Joda Time century-of era-formatter (C) is deprecated. Use a `java.time` formatter instead.
- > The default for the `cluster.routing.allocation.disk.watermark` setting is changing from false to true.
  > If you do not explicitly configure this setting when you upgrade, indices in this one node cluster will
  > become read-only if disk usage reaches 95%. 

## Note on i18n
All deprecation titles, messages, and manual steps should be wrapped in `i18n.translate`. This 
provides a better user experience using different locales. Follow the writing guidelines below for
best practices to writing the i18n messages and ids.

### Writing guidelines
The deprecation service enables you to specify a `title`, `message`, `documentationUrl`,
and the `manual steps` for resolving a deprecation issue.

#### Title:
No end punctuation is required.
i18n id: `{plugin_domain}.deprecations.{deprecationTitle}Title`

Example:
```ts
title: i18n.translate('xpack.reporting.deprecations.reportingRoleTitle', {
  defaultMessage: `Found deprecated reporting roles`,
})
```

#### Message
Keep it brief, but multiple sentences are allowed if needed.
i18n id: `{plugin_domain}.deprecations.{deprecationTitle}Message`

Example:
```ts
message: i18n.translate('xpack.reporting.deprecations.reportingRoleMessage', {
  defaultMessage: `The deprecated "${deprecatedRole}" role has been found for ${numReportingUsers} user(s): "${usernames}"`,
  values: { deprecatedRole, numReportingUsers, usernames },
}),
```

#### Documentation URL
Don’t link to the Migration guide/breaking changes. 
Only specify a doc URL if the user truly needs to “learn more” to understand what actions they need to take.

Example:
```ts
documentationUrl: 'https://www.elastic.co/guide/en/kibana/current/secure-reporting.html',
```
#### Manual steps
State the action first for each step.
i18n id: `{plugin_domain}.deprecations.{deprecationTitle}.manualStep{Step#}Message`

Example:
```ts
manualSteps: [
  i18n.translate('xpack.reporting.deprecations.reportingRole.manualStepTwoMessage', {
    defaultMessage: `Create one or more custom roles that provide Kibana application privileges to reporting features in **Management > Security > Roles**.`,
  }),
  i18n.translate('xpack.reporting.deprecations.reportingRole.manualStepThreeMessage', {
    defaultMessage: `Assign the custom role(s) as desired, and remove the "${deprecatedRole}" role from the user(s).`,
    values: { deprecatedRole },
  }),
]
```

#### General Guidelines

##### What is deprecated
Use the present tense: 
- Types are deprecated in geo_shape queries.
- Sorting is deprecated in reindex requests.

Avoid:
- The type should no longer be specified in geo_shape queries.
- Sorting has been deprecated in reindex requests.

##### What action the user needs to take
Use the imperative voice:
- Do not specify a type in the indexed_shape section. 
- Use query filtering to reindex a subset of documents.

Avoid:
- Please use query filtering instead.
- You should use query filtering instead.
- Instead consider using query filtering to find the desired subset of data.

##### Context
Where possible, provide the specific context that resulted in the warning:
- The Abc timezone used by rollup job Def is deprecated. Use Xyz instead.

##### Impact
Many deprecations are clearcut--you are using this old thing and need to switch to using this new thing.
Others are more nuanced and don’t necessarily require any changes. In this case, the warning needs to address
the impact of not taking action:
- The default for the `cluster.routing.allocation.disk.watermark` setting is changing from false to true.
  If you do not explicitly configure this setting when you upgrade, indices in this one node cluster will
  become read-only if disk usage reaches 95%. 

##### Version
You do not need to include any form of "and will be removed in a future release".
The assumption is that deprecated things are going to be removed, and the standard schedule for removal
is the next major version. 

If things are targeted for removal in a specific minor release, the message should include that information:
- Abc is deprecated. Use Xyz to do the thing. Support for Abc will be removed in n.n.

If an item is deprecated, but won’t be removed in the next major version, the message should indicate that:
- Abc is deprecated. Use Xyz to do the thing. Support for Abc will be removed following the release of n.0. 

Avoid:
- Xyz is deprecated and will be removed in 8.0.
- Xyz is deprecated and will be unsupported in future.
- Xyz is deprecated and will not be supported in the next major version of Elasticsearch.

##### Formatting
- Sentence style capitalization and punctuation. 
- Avoid quotes for emphasis.
