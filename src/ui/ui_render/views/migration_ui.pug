extends ./chrome

block content
  style.
    * {
      box-sizing: border-box;
    }

    body, html {
      width: 100%;
      height: 100%;
      margin: 0;
    }

    .kibanaWelcomeView {
      background-color: #F5F5F5;
      background-image: linear-gradient(0deg, #F5F5F5 0%, #FFF 100%);
      font-family: Sans-serif;
    }

    .kibanaWelcomeText {
      font-size: 20px;
      margin: 20px auto 16px;
    }

    .kibanaProgressText {
      opacity: 0.65;
    }

    .kibanaWelcomeLogoCircle {
      margin-bottom: 32px;
      display: inline-block;
      width: 80px;
      height: 80px;
      line-height: 80px;
      text-align: center;
      background-color: #FFF;
      border-radius: 100%;
      padding: 16px;
      box-shadow: 0 6px 12px -1px rgba(153, 153, 153, 0.2), 0 4px 4px -1px rgba(153, 153, 153, 0.2), 0 2px 2px 0 rgba(153, 153, 153, 0.2);
    }

    .kibanaWelcomeLogo {
      background-repeat: no-repeat;
      background-size: contain;
      width: 40px;
      height: 40px;
      margin: 4px 9px;
    }

    .upgradeProgress {
      width: 200px;
      background: white;
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 8px;
    }

    .upgradeProgressbar {
      background: #3ebeb0;
      transition: all 2.5s linear;
      width: 1%;
      height: 8px;
      box-shadow: 2px 2px 2px rgba(0, 0, 0, 0.1);
    }

    .bottomBranding {
      position: absolute;
      bottom: 0;
      left: 0;
    }

    .topBranding {
      position: absolute;
      top: 0;
      right: 0;
    }

  .kibanaWelcomeView
    .kibanaLoaderWrap
      .kibanaLoader
      .kibanaWelcomeLogoCircle
        .kibanaWelcomeLogo
    .upgradeProgress
      .upgradeProgressbar(data-progress-url=migrationProgressUrl)
    .kibanaWelcomeText
      | #{i18n('common.ui.migrationTitle', { defaultMessage: 'Updating Kibana' })}
    .kibanaProgressText
      | #{i18n('common.ui.migrationSubtitle', { defaultMessage: 'Migrating the Kibana index...' })}
    <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" class="bottomBranding" width="1169" height="880" viewBox="0 0 1169 880">
      <defs>
        <radialGradient id="bg_bottom_branded-b" cx="44.645%" cy="43.259%" r="93.821%" fx="44.645%" fy="43.259%" gradientTransform="matrix(.54075 .76504 -.6424 .64398 .483 -.188)">
          <stop offset="0%" stop-color="#D9D9D9"/>
          <stop offset="100%"/>
        </radialGradient>
        <polygon id="bg_bottom_branded-a" points="0 0 1048 880 0 880"/>
        <linearGradient id="bg_bottom_branded-c" x1="98.924%" x2="7.157%" y1="48.924%" y2="48.924%">
          <stop offset="0%" stop-color="#DFDDDD" stop-opacity=".25"/>
          <stop offset="100%" stop-color="#FFF" stop-opacity=".2"/>
        </linearGradient>
        <linearGradient id="bg_bottom_branded-e" x1="0%" y1="47.421%" y2="47.421%">
          <stop offset="0%" stop-color="#FFF" stop-opacity=".6"/>
          <stop offset="100%" stop-opacity=".25"/>
        </linearGradient>
        <polygon id="bg_bottom_branded-d" points="560 364 1169 880 560 880"/>
        <linearGradient id="bg_bottom_branded-g" x1="0%" y1="0%" y2="100%">
          <stop offset="0%" stop-color="#FFF" stop-opacity=".2"/>
          <stop offset="100%" stop-opacity="0"/>
        </linearGradient>
        <radialGradient id="bg_bottom_branded-h" cx="0%" cy="0%" r="127.62%" fx="0%" fy="0%" gradientTransform="scale(.9322 1) rotate(42.99)">
          <stop offset="0%" stop-color="#BBB" stop-opacity=".1"/>
          <stop offset="100%" stop-opacity=".5"/>
        </radialGradient>
        <polygon id="bg_bottom_branded-f" points="-12 538 342 868 -12 868"/>
        <linearGradient id="bg_bottom_branded-j" x1="0%" y1="0%" y2="100%">
          <stop offset="0%" stop-color="#FFF" stop-opacity=".4"/>
          <stop offset="100%" stop-opacity="0"/>
        </linearGradient>
        <radialGradient id="bg_bottom_branded-k" cx="0%" cy="0%" r="148.368%" fx="0%" fy="0%" gradientTransform="matrix(.674 .674 -.73874 .61493 0 0)">
          <stop offset="0%" stop-color="#FFF" stop-opacity=".101"/>
          <stop offset="100%" stop-opacity=".15"/>
        </radialGradient>
        <path id="bg_bottom_branded-i" d="M197,880 L374,880 C365.385564,795.927984 296.005151,723.868711 197,686 L197,880 Z"/>
        <radialGradient id="bg_bottom_branded-m" cx="0%" cy="0%" r="127.62%" fx="0%" fy="0%" gradientTransform="scale(1 .9322) rotate(47.01)">
          <stop offset="0%" stop-color="#BBB" stop-opacity=".1"/>
          <stop offset="100%" stop-opacity=".5"/>
        </radialGradient>
        <polygon id="bg_bottom_branded-l" points="165 703 330 880 165 880"/>
      </defs>
      <g fill="none" fill-rule="evenodd">
        <g opacity=".1">
          <use fill="#E4E4E4" xlink:href="#bg_bottom_branded-a"/>
          <use fill="url(#bg_bottom_branded-b)" xlink:href="#bg_bottom_branded-a" style="mix-blend-mode:overlay"/>
        </g>
        <g opacity=".05">
          <use fill="url(#bg_bottom_branded-c)" xlink:href="#bg_bottom_branded-d"/>
          <use fill="url(#bg_bottom_branded-e)" xlink:href="#bg_bottom_branded-d" style="mix-blend-mode:overlay"/>
        </g>
        <g opacity=".65" transform="matrix(0 -1 -1 0 868 868)">
          <use fill="#DD0A73" xlink:href="#bg_bottom_branded-f"/>
          <use fill="url(#bg_bottom_branded-g)" xlink:href="#bg_bottom_branded-f" style="mix-blend-mode:overlay"/>
          <use fill="url(#bg_bottom_branded-h)" xlink:href="#bg_bottom_branded-f" style="mix-blend-mode:overlay"/>
        </g>
        <g opacity=".65">
          <use fill="#017F75" xlink:href="#bg_bottom_branded-i"/>
          <use fill="url(#bg_bottom_branded-j)" xlink:href="#bg_bottom_branded-i" style="mix-blend-mode:overlay"/>
          <use fill="url(#bg_bottom_branded-k)" xlink:href="#bg_bottom_branded-i" style="mix-blend-mode:overlay"/>
        </g>
        <g opacity=".15">
          <use fill="#353535" xlink:href="#bg_bottom_branded-l"/>
          <use fill="url(#bg_bottom_branded-g)" xlink:href="#bg_bottom_branded-l" style="mix-blend-mode:overlay"/>
          <use fill="url(#bg_bottom_branded-m)" xlink:href="#bg_bottom_branded-l" style="mix-blend-mode:overlay"/>
        </g>
      </g>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" class="topBranding" width="400" height="373" viewBox="0 0 400 373">
      <defs>
        <linearGradient id="bg_top_branded-a" x1="10.793%" y1="50%" y2="50%">
          <stop offset="0%" stop-color="#FFF" stop-opacity=".5"/>
          <stop offset="100%" stop-color="#E2E2E2" stop-opacity="0"/>
        </linearGradient>
        <radialGradient id="bg_top_branded-c" cx="0%" cy="0%" r="146.629%" fx="0%" fy="0%" gradientTransform="matrix(.68199 .682 -.63596 .73135 0 0)">
          <stop offset="0%" stop-color="#FFF" stop-opacity=".5"/>
          <stop offset="100%" stop-opacity=".2"/>
        </radialGradient>
        <polygon id="bg_top_branded-b" points="400 373 0 0 400 0"/>
        <linearGradient id="bg_top_branded-e" x1="0%" y1="35.11%" y2="0%">
          <stop offset="0%" stop-color="#FFF" stop-opacity=".6"/>
          <stop offset="100%" stop-opacity="0"/>
        </linearGradient>
        <radialGradient id="bg_top_branded-f" cy="0%" r="146.096%" fx="50%" fy="0%" gradientTransform="matrix(-.68448 .68448 -.64265 -.72903 .842 -.342)">
          <stop offset="0%" stop-color="#FFF" stop-opacity=".7"/>
          <stop offset="100%"/>
        </radialGradient>
        <polygon id="bg_top_branded-d" points="400 169 220 0 400 0"/>
      </defs>
      <g fill="none" fill-rule="evenodd">
        <g opacity=".1">
          <use fill="url(#bg_top_branded-a)" xlink:href="#bg_top_branded-b"/>
          <use fill="url(#bg_top_branded-c)" xlink:href="#bg_top_branded-b" style="mix-blend-mode:overlay"/>
        </g>
        <g opacity=".05">
          <use fill="#F5F5F5" xlink:href="#bg_top_branded-d"/>
          <use fill="url(#bg_top_branded-e)" xlink:href="#bg_top_branded-d" style="mix-blend-mode:overlay"/>
          <use fill="url(#bg_top_branded-f)" xlink:href="#bg_top_branded-d" style="mix-blend-mode:darken"/>
        </g>
      </g>
    </svg>

  script.
    (function() {
      setTimeout(function poll() {
        fetchProgress(function(req) {
          // If we get an error fetching migration progress, do some UX
          // tricks (move the progress bar, and delay a bit) then refresh.
          // This prevents this page from hanging in an error condition, or
          // getting into a tight refresh loop.
          if (req.status >= 300) {
            setProgress(1);
            return setTimeout(refresh, 500);
          }

          var progress = parseProgress(req);
          setProgress(progress);

          if (progress >= 1) {
            refresh();
          } else {
            setTimeout(poll, 2500);
          }
        });
      });

      var bar = document.querySelector('.upgradeProgressbar');

      function setProgress(n) {
        // We fudge the UX a bit and always nudge the bar to at least 5%
        // to indicate that the page itself isn't stuck.
        bar.style.width = Math.max(5, n * 100) + '%';
      }

      function parseProgress(req) {
        try {
          var result = JSON.parse(req.responseText);
          return result.progress || 0;
        } catch (err) {
          return 1;
        }
      }

      function refresh(ms) {
        document.location.reload();
      }

      function fetchProgress(callback) {
        var migrationProgressUrl = bar.getAttribute('data-progress-url');
        var req = new XMLHttpRequest();
        req.onreadystatechange = function () {
          if (req.readyState === 4) {
            callback(req);
          }
        };
        req.open('GET', migrationProgressUrl);
        req.setRequestHeader('Cache-Control', 'no-cache');
        req.send();
      }
    }());
