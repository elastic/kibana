{
  "summary": {
    "total": 384,
    "skipped": 0,
    "succeeded": 338,
    "failed": 46
  },
  "results": {
    "updated": [
      {
        "name": "Google Workspace 2SV Policy Disabled",
        "description": "Google Workspace admins may setup 2-step verification (2SV) to add an extra layer of security to user accounts by asking users to verify their identity when they use login credentials. Admins have the ability to enforce 2SV from the admin console as well as the methods acceptable for verification and enrollment period. 2SV requires enablement on admin accounts prior to it being enabled for users within organization units. Adversaries may disable 2SV to lower the security requirements to access a valid account.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Google Workspace 2SV Policy Disabled\n\nGoogle Workspace administrators manage password policies to enforce password requirements for an organization's compliance needs. Administrators have the capability to set restrictions on password length, reset frequencies, reuse capability, expiration, and much more. Google Workspace also allows multi-factor authentication (MFA) and 2-step verification (2SV) for authentication. 2SV allows users to verify their identity using security keys, Google prompt, authentication codes, text messages, and more.\n\n2SV adds an extra authentication layer for Google Workspace users to verify their identity. If 2SV or MFA aren't implemented, users only authenticate with their user name and password credentials. This authentication method has often been compromised and can be susceptible to credential access techniques when weak password policies are used.\n\nThis rule detects when a 2SV policy is disabled in Google Workspace.\n\n#### Possible investigation steps\n\n- Identify the associated user account(s) by reviewing `user.name` or `source.user.email` in the alert.\n- Identify what password setting was created or adjusted by reviewing `google_workspace.admin.setting.name`.\n- Review if a password setting was enabled or disabled by reviewing `google_workspace.admin.new_value` and `google_workspace.admin.old_value`.\n- After identifying the involved user account, verify administrative privileges are scoped properly.\n- Filter `event.dataset` for `google_workspace.login` and aggregate by `user.name`, `event.action`.\n  - The `google_workspace.login.challenge_method` field can be used to identify the challenge method that was used for failed and successful logins.\n\n### False positive analysis\n\n- After finding the user account that updated the password policy, verify whether the action was intentional.\n- Verify whether the user should have Google Workspace administrative privileges that allow them to modify password policies.\n- Review organizational units or groups the role may have been added to and ensure its privileges are properly aligned.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Disable or limit the account during the investigation and response.\n- Identify the possible impact of the incident and prioritize accordingly; the following actions can help you gain context:\n    - Identify the account role in the cloud environment.\n    - Assess the criticality of affected services and servers.\n    - Work with your IT team to identify and minimize the impact on users.\n    - Identify if the attacker is moving laterally and compromising other accounts, servers, or services.\n    - Identify any regulatory or legal ramifications related to this activity.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords or delete API keys as needed to revoke the attacker's access to the environment. Work with your IT teams to minimize the impact on business operations during these actions.\n- Review the permissions assigned to the implicated user to ensure that the least privilege principle is being followed.\n- Implement security best practices [outlined](https://support.google.com/a/answer/7587183) by Google.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection via the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n\n\n\n### Important Information Regarding Google Workspace Event Lag Times\n- As per Google's documentation, Google Workspace administrators may observe lag times ranging from minutes up to 3 days between the time of an event's occurrence and the event being visible in the Google Workspace admin/audit logs.\n- This rule is configured to run every 10 minutes with a lookback time of 130 minutes.\n- To reduce the risk of false negatives, consider reducing the interval that the Google Workspace (formerly G Suite) Filebeat module polls Google's reporting API for new events.\n- By default, `var.interval` is set to 2 hours (2h). Consider changing this interval to a lower value, such as 10 minutes (10m).\n- See the following references for further information:\n  - https://support.google.com/a/answer/7061566\n  - https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-module-google_workspace.html",
        "output_index": "",
        "version": 107,
        "tags": [
          "Domain: Cloud",
          "Data Source: Google Workspace",
          "Use Case: Configuration Audit",
          "Tactic: Persistence",
          "Resources: Investigation Guide"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-7800s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Administrators may remove 2-step verification (2SV) temporarily for testing or during maintenance. If 2SV was previously enabled, it is not common to disable this policy for extended periods of time."
        ],
        "references": [
          "https://support.google.com/a/answer/9176657?hl=en",
          "https://www.elastic.co/security-labs/google-workspace-attack-surface-part-one",
          "https://www.elastic.co/security-labs/google-workspace-attack-surface-part-two"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1556",
                "name": "Modify Authentication Process",
                "reference": "https://attack.mitre.org/techniques/T1556/"
              }
            ]
          }
        ],
        "setup": "The Google Workspace Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "google_workspace",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "d96ef471-65ca-41e3-84ef-426ea7b6f43c",
        "rule_id": "5e161522-2545-11ed-ac47-f661ea17fbce",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:13.382Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:05.942Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-google_workspace*"
        ],
        "filters": [],
        "query": "event.dataset:\"google_workspace.login\" and event.action:\"2sv_disable\"",
        "language": "kuery"
      },
      {
        "name": "Potential Masquerading as Communication Apps",
        "description": "Identifies suspicious instances of communications apps, both unsigned and renamed ones, that can indicate an attempt to conceal malicious activity, bypass security features such as allowlists, or trick users into executing malware.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 6,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1036",
                "name": "Masquerading",
                "reference": "https://attack.mitre.org/techniques/T1036/",
                "subtechnique": [
                  {
                    "id": "T1036.001",
                    "name": "Invalid Code Signature",
                    "reference": "https://attack.mitre.org/techniques/T1036/001/"
                  },
                  {
                    "id": "T1036.005",
                    "name": "Match Legitimate Name or Location",
                    "reference": "https://attack.mitre.org/techniques/T1036/005/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1554",
                "name": "Compromise Host Software Binary",
                "reference": "https://attack.mitre.org/techniques/T1554/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.code_signature.subject_name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.code_signature.trusted",
            "type": "boolean",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "7fd11da1-8d6b-408e-9bcb-84acadec459d",
        "rule_id": "c9482bfa-a553-4226-8ea2-4959bd4f7923",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:13.421Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:16.299Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and\n  event.type == \"start\" and\n  (\n    /* Slack */\n    (process.name : \"slack.exe\" and not\n      (process.code_signature.subject_name in (\n        \"Slack Technologies, Inc.\",\n        \"Slack Technologies, LLC\"\n       ) and process.code_signature.trusted == true)\n    ) or\n\n    /* WebEx */\n    (process.name : \"WebexHost.exe\" and not\n      (process.code_signature.subject_name in (\"Cisco WebEx LLC\", \"Cisco Systems, Inc.\") and process.code_signature.trusted == true)\n    ) or\n\n    /* Teams */\n    (process.name : \"Teams.exe\" and not\n      (process.code_signature.subject_name == \"Microsoft Corporation\" and process.code_signature.trusted == true)\n    ) or\n\n    /* Discord */\n    (process.name : \"Discord.exe\" and not\n      (process.code_signature.subject_name == \"Discord Inc.\" and process.code_signature.trusted == true)\n    ) or\n\n    /* RocketChat */\n    (process.name : \"Rocket.Chat.exe\" and not\n      (process.code_signature.subject_name == \"Rocket.Chat Technologies Corp.\" and process.code_signature.trusted == true)\n    ) or\n\n    /* Mattermost */\n    (process.name : \"Mattermost.exe\" and not\n      (process.code_signature.subject_name == \"Mattermost, Inc.\" and process.code_signature.trusted == true)\n    ) or\n\n    /* WhatsApp */\n    (process.name : \"WhatsApp.exe\" and not\n      (process.code_signature.subject_name in (\n        \"WhatsApp LLC\",\n        \"WhatsApp, Inc\",\n        \"24803D75-212C-471A-BC57-9EF86AB91435\"\n       ) and process.code_signature.trusted == true)\n    ) or\n\n    /* Zoom */\n    (process.name : \"Zoom.exe\" and not\n      (process.code_signature.subject_name == \"Zoom Video Communications, Inc.\" and process.code_signature.trusted == true)\n    ) or\n\n    /* Outlook */\n    (process.name : \"outlook.exe\" and not\n      (process.code_signature.subject_name == \"Microsoft Corporation\" and process.code_signature.trusted == true)\n    ) or\n\n    /* Thunderbird */\n    (process.name : \"thunderbird.exe\" and not\n      (process.code_signature.subject_name == \"Mozilla Corporation\" and process.code_signature.trusted == true)\n    )\n  )",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*"
        ],
        "filters": []
      },
      {
        "name": "Potential Linux Ransomware Note Creation Detected",
        "description": "This rule identifies a sequence of a mass file encryption event in conjunction with the creation of a .txt file with a file name containing ransomware keywords executed by the same process in a 1 second timespan. Ransomware is a type of malware that encrypts a victim's files or systems and demands payment (usually in cryptocurrency) in exchange for the decryption key. One important indicator of a ransomware attack is the mass encryption of the file system, after which a new file extension is added to the file.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 10,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Impact",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0040",
              "name": "Impact",
              "reference": "https://attack.mitre.org/tactics/TA0040/"
            },
            "technique": [
              {
                "id": "T1486",
                "name": "Data Encrypted for Impact",
                "reference": "https://attack.mitre.org/techniques/T1486/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "1cd32737-e013-4177-9884-6ddae6ba07b3",
        "rule_id": "c8935a8b-634a-4449-98f7-bb24d3b2c0af",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:13.471Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:04.184Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by process.entity_id, host.id with maxspan=1s \n  [file where host.os.type == \"linux\" and event.type == \"change\" and event.action == \"rename\" and file.extension : \"?*\" \n   and process.executable : (\"./*\", \"/tmp/*\", \"/var/tmp/*\", \"/dev/shm/*\", \"/var/run/*\", \"/boot/*\") and\n   file.path : (\n     \"/home/*/Downloads/*\", \"/home/*/Documents/*\", \"/root/*\", \"/bin/*\", \"/usr/bin/*\", \"/var/log/*\", \"/var/lib/log/*\",\n     \"/var/backup/*\", \"/var/www/*\") and\n   not process.name : (\n     \"dpkg\", \"yum\", \"dnf\", \"rpm\", \"dockerd\", \"go\", \"java\", \"pip*\", \"python*\", \"node\", \"containerd\", \"php\", \"p4d\",\n     \"conda\", \"chrome\", \"imap\", \"cmake\", \"firefox\", \"semanage\", \"semodule\", \"ansible-galaxy\", \"fc-cache\", \"jammy\", \"git\",\n     \"systemsettings\", \"vmis-launcher\", \"bundle\", \"kudu-tserver\", \"suldownloader\", \"rustup-init\"\n    )\n  ] with runs=25\n  [file where host.os.type == \"linux\" and event.action == \"creation\" and\n   file.name : (\"*restore*\", \"*lock*\", \"*recovery*\", \"*read*\", \"*instruction*\", \"*how_to*\", \"*ransom*\")\n  ]",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Potential Shell via Wildcard Injection Detected",
        "description": "This rule monitors for the execution of a set of linux binaries, that are potentially vulnerable to wildcard injection, with suspicious command line flags followed by a shell spawn event. Linux wildcard injection is a type of security vulnerability where attackers manipulate commands or input containing wildcards (e.g., *, ?, []) to execute unintended operations or access sensitive data by tricking the system into interpreting the wildcard characters in unexpected ways.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 6,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Tactic: Execution",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.exploit-db.com/papers/33930"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1068",
                "name": "Exploitation for Privilege Escalation",
                "reference": "https://attack.mitre.org/techniques/T1068/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "1ee1784e-bad2-47fc-bdb2-725dda41955c",
        "rule_id": "0b803267-74c5-444d-ae29-32b5db2d562a",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:14.265Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:16.392Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by host.id with maxspan=1s\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and (\n    (process.name == \"tar\" and process.args : \"--checkpoint=*\" and process.args : \"--checkpoint-action=*\") or\n    (process.name == \"rsync\" and process.args : \"-e*\") or\n    (process.name == \"zip\" and process.args == \"--unzip-command\")\n   ) and not process.executable : \"/tmp/newroot/*\"\n  ]  by process.entity_id\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and \n     process.parent.name : (\"tar\", \"rsync\", \"zip\") and \n     process.name : (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\")\n  ] by process.parent.entity_id",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Abnormal Process ID or Lock File Created",
        "description": "Identifies the creation of a Process ID (PID), lock or reboot file created in temporary file storage paradigm (tmpfs) directory /var/run. On Linux, the PID files typically hold the process ID to track previous copies running and manage other tasks. Certain Linux malware use the /var/run directory for holding data, executables and other tasks, disguising itself or these files as legitimate PID files.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Abnormal Process ID or Lock File Created\n\nLinux applications may need to save their process identification number (PID) for various purposes: from signaling that a program is running to serving as a signal that a previous instance of an application didn't exit successfully. PID files contain its creator process PID in an integer value.\n\nLinux lock files are used to coordinate operations in files so that conflicts and race conditions are prevented.\n\nThis rule identifies the creation of PID, lock, or reboot files in the /var/run/ directory. Attackers can masquerade malware, payloads, staged data for exfiltration, and more as legitimate PID files.\n\n#### Possible investigation steps\n\n- Retrieve the file and determine if it is malicious:\n    - Check the contents of the PID files. They should only contain integer strings.\n    - Check the file type of the lock and PID files to determine if they are executables. This is only observed in     malicious files.\n    - Check the size of the subject file. Legitimate PID files should be under 10 bytes.\n    - Check if the lock or PID file has high entropy. This typically indicates an encrypted payload.\n        - Analysts can use tools like `ent` to measure entropy.\n    - Examine the reputation of the SHA-256 hash in the PID file. Use a database like VirusTotal to identify additional pivots and artifacts for investigation.\n- Trace the file's creation to ensure it came from a legitimate or authorized process.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate any abnormal account behavior, such as command executions, file creations or modifications, and network connections.\n- Investigate any abnormal behavior by the subject process such as network connections, file modifications, and any spawned child processes.\n\n### False positive analysis\n\n- False positives can appear if the PID file is legitimate and holding a process ID as intended. If the PID file is an executable or has a file size that's larger than 10 bytes, it should be ruled suspicious.\n- If this activity is expected and noisy in your environment, consider adding exceptions â€” preferably with a combination of file name and process executable conditions.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Block the identified indicators of compromise (IoCs).\n- Take actions to terminate processes and connections used by the attacker.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 214,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Threat: BPFDoor",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "False-Positives (FP) can appear if the PID file is legitimate and holding a process ID as intended. To differentiate, if the PID file is an executable or larger than 10 bytes, it should be ruled suspicious."
        ],
        "references": [
          "https://www.sandflysecurity.com/blog/linux-file-masquerading-and-malicious-pids-sandfly-1-2-6-update/",
          "https://twitter.com/GossiTheDog/status/1522964028284411907",
          "https://exatrack.com/public/Tricephalic_Hellkeeper.pdf",
          "https://www.elastic.co/security-labs/a-peek-behind-the-bpfdoor"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1106",
                "name": "Native API",
                "reference": "https://attack.mitre.org/techniques/T1106/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "e0f9ef80-9730-4bc7-b491-d2a3260faa70",
        "rule_id": "cac91072-d165-11ec-a764-f661ea17fbce",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:14.273Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:04.064Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "host.os.type:linux and event.category:file and event.action:(creation or file_create_event) and\nfile.extension:(pid or lock or reboot) and file.path:(/var/run/* or /run/*) and (\n  (process.name : (\n    bash or dash or sh or tcsh or csh or zsh or ksh or fish or ash or touch or nano or vim or vi or editor or mv or cp)\n  ) or (\n  process.executable : (\n    ./* or /tmp/* or /var/tmp/* or /dev/shm/* or /var/run/* or /boot/* or /srv/* or /run/*\n  ))\n) and not (\n  process.executable : (\n  /tmp/newroot/* or /run/containerd/* or /run/k3s/containerd/* or /run/k0s/container* or /snap/* or /vz/* or\n  /var/lib/docker/* or /etc/*/universal-hooks/pkgs/mysql-community-server/* or /var/lib/snapd/* or /etc/rubrik/* or\n  /run/udev/data/*\n  ) or\n  process.name : (\n    go or git or containerd* or snap-confine or cron or crond or sshd or unattended-upgrade or vzctl or ifup or\n    rpcbind or runc or gitlab-runner-helper or elastic-agent or metricbeat or redis-server or\n    s6-ipcserver-socketbinder or xinetd\n  ) or\n  file.name : (\n    jem.*.pid or lynis.pid or redis.pid or yum.pid or MFS.pid or jenkins.pid or nvmupdate.pid or openlitespeed.pid or\n    rhnsd.pid\n  ) or\n  file.path : (/run/containerd/* or /var/run/docker/containerd/* or /var/run/jem*.pid)\n)",
        "new_terms_fields": [
          "process.executable",
          "file.name"
        ],
        "history_window_start": "now-14d",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Potential Reverse Shell via Suspicious Child Process",
        "description": "This detection rule detects the creation of a shell through a suspicious process chain. Any reverse shells spawned by the specified utilities that are initialized from a single process followed by a network connection attempt will be captured through this rule. Attackers may spawn reverse shells to establish persistence onto a target system.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 9,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Reverse%20Shell%20Cheatsheet.md"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.004",
                    "name": "Unix Shell",
                    "reference": "https://attack.mitre.org/techniques/T1059/004/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            },
            "technique": [
              {
                "id": "T1071",
                "name": "Application Layer Protocol",
                "reference": "https://attack.mitre.org/techniques/T1071/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args_count",
            "type": "long",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "afd0017a-ce21-44b5-9d0a-9b29bca33c04",
        "rule_id": "76e4d92b-61c1-4a95-ab61-5fd94179a1ee",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:14.280Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:06.001Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by host.id, process.entity_id with maxspan=1s\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"fork\") and (\n    (process.name : \"python*\" and process.args : \"-c\" and process.args : (\n     \"*import*pty*spawn*\", \"*import*subprocess*call*\"\n    )) or\n    (process.name : \"perl*\" and process.args : \"-e\" and process.args : \"*socket*\" and process.args : (\n     \"*exec*\", \"*system*\"\n    )) or\n    (process.name : \"ruby*\" and process.args : (\"-e\", \"-rsocket\") and process.args : (\n     \"*TCPSocket.new*\", \"*TCPSocket.open*\"\n     )) or\n    (process.name : \"lua*\" and process.args : \"-e\" and process.args : \"*socket.tcp*\" and process.args : (\n     \"*io.popen*\", \"*os.execute*\"\n    )) or\n    (process.name : \"php*\" and process.args : \"-r\" and process.args : \"*fsockopen*\" and process.args : \"*/bin/*sh*\") or \n    (process.name : (\"awk\", \"gawk\", \"mawk\", \"nawk\") and process.args : \"*/inet/tcp/*\") or\n    (process.name : \"openssl\" and process.args : \"-connect\") or\n    (process.name : (\"nc\", \"ncat\", \"netcat\") and process.args == \"-e\" and process.args_count >= 3 and \n     not process.args == \"-z\") or\n    (process.name : \"telnet\" and process.args_count >= 3)\n  ) and process.parent.name : (\n    \"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\", \"python*\", \"php*\", \"perl\", \"ruby\", \"lua*\",\n    \"openssl\", \"nc\", \"netcat\", \"ncat\", \"telnet\", \"awk\")]\n  [network where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"connection_attempted\", \"connection_accepted\") and \n    process.name : (\"python*\", \"php*\", \"perl\", \"ruby\", \"lua*\", \"openssl\", \"nc\", \"netcat\", \"ncat\", \"telnet\", \"awk\") and \n    destination.ip != null and not cidrmatch(destination.ip, \"127.0.0.0/8\", \"169.254.0.0/16\", \"224.0.0.0/4\", \"::1\")]",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Google Workspace Admin Role Assigned to a User",
        "description": "Assigning the administrative role to a user will grant them access to the Google Admin console and grant them administrator privileges which allow them to access and manage various resources and applications. An adversary may create a new administrator account for persistence or apply the admin role to an existing user to carry out further intrusion efforts. Users with super-admin privileges can bypass single-sign on if enabled in Google Workspace.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Google Workspace Admin Role Assigned to a User\n\nGoogle Workspace roles allow administrators to assign specific permissions to users or groups. These assignments should follow the principle of least privilege (PoLP). Admin roles in Google Workspace grant users access to the Google Admin console, where more domain-wide settings are accessible. Google Workspace contains prebuilt administrator roles for performing business functions related to users, groups, and services. Custom administrator roles can be created when prebuilt roles are not sufficient.\n\nAdministrator roles assigned to users will grant them additional permissions and privileges within the Google Workspace domain. Administrative roles also give users access to the admin console, where domain-wide settings can be adjusted. Threat actors might rely on these new privileges to advance their intrusion efforts and laterally move throughout the organization. Users with unexpected administrative privileges may also cause operational dysfunction if unfamiliar settings are adjusted without warning.\n\nThis rule identifies when a Google Workspace administrative role is assigned to a user.\n\n#### Possible investigation steps\n\n- Identify the associated user accounts by reviewing `user.name` or `user.email` fields in the alert.\n  - The `user.target.email` field contains the user who received the admin role.\n- Identify the role given to the user by reviewing the `google_workspace.admin.role.name` field in the alert.\n- After identifying the involved user, verify their administrative privileges are scoped properly.\n- To identify other users with this role, search the alert for `event.action: ASSIGN_ROLE`.\n  - Add `google_workspace.admin.role.name` with the role added as an additional filter.\n  - Adjust the relative time accordingly to identify all users that were assigned this admin role.\n- Identify if the user account was recently created by searching for `event.action: CREATE_USER`.\n  - Add `user.email` with the target user account that recently received this new admin role.\n- After identifying the involved user, create a filter with their `user.name` or `user.target.email`. Review the last 48 hours of their activity for anything that may indicate a compromise.\n\n### False positive analysis\n\n- After identifying user account that added the admin role, verify the action was intentional.\n- Verify that the target user who was assigned the admin role should have administrative privileges in Google Workspace.\n- Review organizational units or groups the target user might have been added to and ensure the admin role permissions align.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Disable or limit the account during the investigation and response.\n- Identify the possible impact of the incident and prioritize accordingly; the following actions can help you gain context:\n    - Identify the account role in the cloud environment.\n    - Assess the criticality of affected services and servers.\n    - Work with your IT team to identify and minimize the impact on users.\n    - Identify if the attacker is moving laterally and compromising other accounts, servers, or services.\n    - Identify any regulatory or legal ramifications related to this activity.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords or delete API keys as needed to revoke the attacker's access to the environment. Work with your IT teams to minimize the impact on business operations during these actions.\n- Review the permissions assigned to the implicated user to ensure that the least privilege principle is being followed.\n- Implement security best practices [outlined](https://support.google.com/a/answer/7587183) by Google.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection via the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n\n\n\n### Important Information Regarding Google Workspace Event Lag Times\n- As per Google's documentation, Google Workspace administrators may observe lag times ranging from minutes up to 3 days between the time of an event's occurrence and the event being visible in the Google Workspace admin/audit logs.\n- This rule is configured to run every 10 minutes with a lookback time of 130 minutes.\n- To reduce the risk of false negatives, consider reducing the interval that the Google Workspace (formerly G Suite) Filebeat module polls Google's reporting API for new events.\n- By default, `var.interval` is set to 2 hours (2h). Consider changing this interval to a lower value, such as 10 minutes (10m).\n- See the following references for further information:\n  - https://support.google.com/a/answer/7061566\n  - https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-module-google_workspace.html",
        "output_index": "",
        "version": 207,
        "tags": [
          "Domain: Cloud",
          "Data Source: Google Workspace",
          "Use Case: Identity and Access Audit",
          "Tactic: Persistence",
          "Resources: Investigation Guide"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-7800s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Google Workspace admin role assignments may be modified by system administrators. Verify that the configuration change was expected. Exceptions can be added to this rule to filter expected behavior."
        ],
        "references": [
          "https://support.google.com/a/answer/172176?hl=en",
          "https://www.elastic.co/security-labs/google-workspace-attack-surface-part-one",
          "https://www.elastic.co/security-labs/google-workspace-attack-surface-part-two"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1098",
                "name": "Account Manipulation",
                "reference": "https://attack.mitre.org/techniques/T1098/",
                "subtechnique": [
                  {
                    "id": "T1098.003",
                    "name": "Additional Cloud Roles",
                    "reference": "https://attack.mitre.org/techniques/T1098/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The Google Workspace Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "google_workspace",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "google_workspace.admin.role.name",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "google_workspace.event.type",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "d77949c8-6796-4079-85b8-cc2b16f84ea7",
        "rule_id": "68994a6c-c7ba-4e82-b476-26a26877adf6",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:14.288Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:05.984Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-google_workspace*"
        ],
        "filters": [],
        "query": "event.dataset:\"google_workspace.admin\" and event.category:\"iam\" and event.action:\"ASSIGN_ROLE\"\n  and google_workspace.event.type:\"DELEGATED_ADMIN_SETTINGS\" and google_workspace.admin.role.name : *_ADMIN_ROLE",
        "language": "kuery"
      },
      {
        "name": "Potential Cross Site Scripting (XSS)",
        "description": "Cross-Site Scripting (XSS) is a type of attack in which malicious scripts are injected into trusted websites. In XSS attacks, an attacker uses a benign web application to send malicious code, generally in the form of a browser-side script. This detection rule identifies the potential malicious executions of such browser-side scripts.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 2,
        "tags": [
          "Data Source: APM",
          "Use Case: Threat Detection",
          "Tactic: Initial Access",
          "Rule Type: BBR"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/payloadbox/xss-payload-list"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1189",
                "name": "Drive-by Compromise",
                "reference": "https://attack.mitre.org/techniques/T1189/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "apm",
            "version": "^8.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "processor.name",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "url.fragment",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "6f09e9e8-03c0-44e1-9b88-1f05027e1974",
        "rule_id": "4aa58ac6-4dc0-4d18-b713-f58bf8bd015c",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:14.290Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:17.161Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "any where processor.name == \"transaction\" and\nurl.fragment : (\"<iframe*\", \"*prompt(*)*\", \"<script*>\", \"<svg*>\", \"*onerror=*\", \"*javascript*alert*\", \"*eval*(*)*\", \"*onclick=*\",\n\"*alert(document.cookie)*\", \"*alert(document.domain)*\",\"*onresize=*\",\"*onload=*\",\"*onmouseover=*\")",
        "language": "eql",
        "index": [
          "apm-*-transaction*",
          "traces-apm*"
        ],
        "filters": []
      },
      {
        "name": "Linux User Added to Privileged Group",
        "description": "Identifies attempts to add a user to a privileged group. Attackers may add users to a privileged group in order to establish persistence on a system.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Linux User User Added to Privileged Group\n\nThe `usermod`, `adduser`, and `gpasswd` commands can be used to assign user accounts to new groups in Linux-based operating systems.\n\nAttackers may add users to a privileged group in order to escalate privileges or establish persistence on a system or domain.\n\nThis rule identifies the usages of `usermod`, `adduser` and `gpasswd` to assign user accounts to a privileged group.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n> This investigation guide uses [placeholder fields](https://www.elastic.co/guide/en/security/current/osquery-placeholder-fields.html) to dynamically pass alert data into Osquery queries. Placeholder fields were introduced in Elastic Stack version 8.7.0. If you're using Elastic Stack version 8.6.0 or earlier, you'll need to manually adjust this investigation guide's queries to ensure they properly run.\n\n#### Possible investigation steps\n\n- Investigate whether the user was succesfully added to the privileged group.\n  - !{osquery{\"label\":\"Osquery - Retrieve Information for a Specific User\",\"query\":\"SELECT * FROM users WHERE username = {{user.name}}\"}}\n- Investigate whether the user is currently logged in and active.\n  - !{osquery{\"label\":\"Osquery - Investigate the Account Authentication Status\",\"query\":\"SELECT * FROM logged_in_users WHERE user = {{user.name}}\"}}\n- Retrieve information about the privileged group to which the user was added.\n  - !{osquery{\"label\":\"Osquery - Retrieve Information for a Specific Group\",\"query\":\"SELECT * FROM groups WHERE groupname = {{group.name}}\"}}\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence and whether they are located in expected locations.\n  - !{osquery{\"label\":\"Osquery - Retrieve Running Processes by User\",\"query\":\"SELECT pid, username, name FROM processes p JOIN users u ON u.uid = p.uid ORDER BY username\"}}\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n\n### False positive analysis\n\n- Adding accounts to a group is a common administrative task, so there is a high chance of the activity being legitimate. Before investigating further, verify that this activity is not benign.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Review the privileges assigned to the involved users to ensure that the least privilege principle is being followed.\n- Delete the account that seems to be involved in malicious activity.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 8,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Data Source: Elastic Endgame",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend",
          "Data Source: Auditd Manager"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/security-labs/primer-on-persistence-mechanisms"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1136",
                "name": "Create Account",
                "reference": "https://attack.mitre.org/techniques/T1136/",
                "subtechnique": [
                  {
                    "id": "T1136.001",
                    "name": "Local Account",
                    "reference": "https://attack.mitre.org/techniques/T1136/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "auditd_manager",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "1e7e59f7-7c96-42a8-8c31-0337e4ab06ed",
        "rule_id": "43d6ec12-2b1c-47b5-8f35-e9de65551d3b",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:14.348Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:09.111Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\", \"executed\", \"process_started\")\n and process.args in (\n  \"root\", \"admin\", \"wheel\", \"staff\", \"sudo\",\"disk\", \"video\", \"shadow\", \"lxc\", \"lxd\"\n) and\n(\n  process.name in (\"usermod\", \"adduser\") or\n  (process.name == \"gpasswd\" and process.args in (\"-a\", \"--add\", \"-M\", \"--members\")) \n)",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*",
          "auditbeat-*",
          "logs-auditd_manager.auditd-*"
        ],
        "filters": []
      },
      {
        "name": "PowerShell Script with Webcam Video Capture Capabilities",
        "description": "Detects PowerShell scripts that can be used to record webcam video. Attackers can capture this information to extort or spy on victims.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 106,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Collection",
          "Data Source: PowerShell Logs"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/EmpireProject/Empire/blob/master/lib/modules/powershell/collection/WebcamRecorder.py"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0009",
              "name": "Collection",
              "reference": "https://attack.mitre.org/tactics/TA0009/"
            },
            "technique": [
              {
                "id": "T1125",
                "name": "Video Capture",
                "reference": "https://attack.mitre.org/techniques/T1125/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'PowerShell Script Block Logging' logging policy must be enabled.\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nAdministrative Templates >\nWindows PowerShell >\nTurn on PowerShell Script Block Logging (Enable)\n```\n\nSteps to implement the logging policy via registry:\n\n```\nreg add \"hklm\\SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\ScriptBlockLogging\" /v EnableScriptBlockLogging /t REG_DWORD /d 1\n```\n",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "powershell.file.script_block_text",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "125f9cfa-1632-41b7-bdd7-38009d8dd76f",
        "rule_id": "eb44611f-62a8-4036-a5ef-587098be6c43",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:14.502Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:17.275Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-windows.powershell*"
        ],
        "filters": [],
        "query": "event.category:process and host.os.type:windows and\n  powershell.file.script_block_text : (\n    \"NewFrameEventHandler\" or\n    \"VideoCaptureDevice\" or\n    \"DirectX.Capture.Filters\" or\n    \"VideoCompressors\" or\n    \"Start-WebcamRecorder\" or\n    (\n      (\"capCreateCaptureWindowA\" or\n       \"capCreateCaptureWindow\" or\n       \"capGetDriverDescription\") and\n      (\"avicap32.dll\" or \"avicap32\")\n    )\n  )",
        "language": "kuery"
      },
      {
        "name": "Potential Privilege Escalation via UID INT_MAX Bug Detected",
        "description": "This rule monitors for the execution of the systemd-run command by a user with a UID that is larger than the maximum allowed UID size (INT_MAX). Some older Linux versions were affected by a bug which allows user accounts with a UID greater than INT_MAX to escalate privileges by spawning a shell through systemd-run.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 5,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://twitter.com/paragonsec/status/1071152249529884674",
          "https://github.com/mirchr/security-research/blob/master/vulnerabilities/CVE-2018-19788.sh",
          "https://gitlab.freedesktop.org/polkit/polkit/-/issues/74"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1068",
                "name": "Exploitation for Privilege Escalation",
                "reference": "https://attack.mitre.org/techniques/T1068/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args_count",
            "type": "long",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "4760bd2f-cc94-4837-9129-b57aa0dd6144",
        "rule_id": "d55436a8-719c-445f-92c4-c113ff2f9ba5",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:14.510Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:17.259Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\") and \nprocess.name == \"systemd-run\" and process.args == \"-t\" and process.args_count >= 3 and user.id >= \"1000000000\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious File Changes Activity Detected",
        "description": "This rule identifies a sequence of 100 file extension rename events within a set of common file paths by the same process in a timespan of 1 second. Ransomware is a type of malware that encrypts a victim's files or systems and demands payment (usually in cryptocurrency) in exchange for the decryption key. One important indicator of a ransomware attack is the mass encryption of the file system, after which a new file extension is added to the file.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 8,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Impact",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0040",
              "name": "Impact",
              "reference": "https://attack.mitre.org/tactics/TA0040/"
            },
            "technique": [
              {
                "id": "T1486",
                "name": "Data Encrypted for Impact",
                "reference": "https://attack.mitre.org/techniques/T1486/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "035b0ac7-895d-44bf-8319-45fb8bf1d6fd",
        "rule_id": "28738f9f-7427-4d23-bc69-756708b5f624",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:14.513Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:04.098Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by process.entity_id, host.id with maxspan=1s\n  [file where host.os.type == \"linux\" and event.type == \"change\" and event.action == \"rename\" and file.extension : \"?*\" \n   and process.executable : (\"./*\", \"/tmp/*\", \"/var/tmp/*\", \"/dev/shm/*\", \"/var/run/*\", \"/boot/*\", \"/srv/*\", \"/run/*\") and\n   file.path : (\n     \"/home/*/Downloads/*\", \"/home/*/Documents/*\", \"/root/*\", \"/bin/*\", \"/usr/bin/*\", \"/var/log/*\", \"/var/lib/log/*\",\n     \"/var/backup/*\", \"/var/www/*\"\n   ) and\n   not process.name : (\n     \"dpkg\", \"yum\", \"dnf\", \"rpm\", \"dockerd\", \"go\", \"java\", \"pip*\", \"python*\", \"node\", \"containerd\", \"php\", \"p4d\",\n     \"conda\", \"chrome\", \"imap\", \"cmake\", \"firefox\", \"semanage\", \"semodule\", \"ansible-galaxy\", \"fc-cache\", \"jammy\", \"git\",\n     \"systemsettings\", \"vmis-launcher\", \"bundle\", \"kudu-tserver\", \"suldownloader\"\n    )\n   ] with runs=25",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Sudo Command Enumeration Detected",
        "description": "This rule monitors for the usage of the sudo -l command, which is used to list the allowed and forbidden commands for the invoking user. Attackers may execute this command to enumerate commands allowed to be executed with sudo permissions, potentially allowing to escalate privileges to root.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 6,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1033",
                "name": "System Owner/User Discovery",
                "reference": "https://attack.mitre.org/techniques/T1033/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args_count",
            "type": "long",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "c68ea8b3-6843-4795-8e6b-68aba43dbaa2",
        "rule_id": "28d39238-0c01-420a-b77a-24e5a7378663",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:14.521Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:16.408Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and \nprocess.name == \"sudo\" and process.args == \"-l\" and process.args_count == 2 and\nprocess.parent.name in (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\") and \nnot process.args == \"dpkg\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Potential Code Execution via Postgresql",
        "description": "This rule monitors for suspicious activities that may indicate an attacker attempting to execute arbitrary code within a PostgreSQL environment. Attackers can execute code via PostgreSQL as a result of gaining unauthorized access to a public facing PostgreSQL database or exploiting vulnerabilities, such as remote command execution and SQL injection attacks, which can result in unauthorized access and malicious actions, and facilitate post-exploitation activities for unauthorized access and malicious actions.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 7,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.004",
                    "name": "Unix Shell",
                    "reference": "https://attack.mitre.org/techniques/T1059/004/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.parent.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "0917d093-c4c4-4130-bda2-1da2f55025b1",
        "rule_id": "2a692072-d78d-42f3-a48a-775677d79c4e",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:14.529Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:09.018Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and\nevent.action in (\"exec\", \"exec_event\", \"fork\", \"fork_event\") and user.name == \"postgres\" and (\n  (process.parent.args : \"*sh\" and process.parent.args : \"echo*\") or \n  (process.args : \"*sh\" and process.args : \"echo*\")\n) and not (\n  process.parent.name == \"puppet\" or\n  process.command_line like \"*BECOME-SUCCESS-*\" or\n  process.parent.command_line like \"*BECOME-SUCCESS-*\"\n)",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "Potential Network Sweep Detected",
        "description": "This rule identifies a potential network sweep. A network sweep is a method used by attackers to scan a target network, identifying active hosts, open ports, and available services to gather information on vulnerabilities and weaknesses. This reconnaissance helps them plan subsequent attacks and exploit potential entry points for unauthorized access, data theft, or other malicious activities. This rule proposes threshold logic to check for connection attempts from one source host to 10 or more destination hosts on commonly used network services.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 8,
        "tags": [
          "Domain: Network",
          "Tactic: Discovery",
          "Tactic: Reconnaissance",
          "Use Case: Network Security Monitoring",
          "Data Source: Elastic Defend",
          "Data Source: PAN-OS"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 5,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1046",
                "name": "Network Service Discovery",
                "reference": "https://attack.mitre.org/techniques/T1046/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0043",
              "name": "Reconnaissance",
              "reference": "https://attack.mitre.org/tactics/TA0043/"
            },
            "technique": [
              {
                "id": "T1595",
                "name": "Active Scanning",
                "reference": "https://attack.mitre.org/techniques/T1595/",
                "subtechnique": [
                  {
                    "id": "T1595.001",
                    "name": "Scanning IP Blocks",
                    "reference": "https://attack.mitre.org/techniques/T1595/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "network_traffic",
            "version": "^1.1.0"
          },
          {
            "package": "panw",
            "version": "^4.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.port",
            "type": "long",
            "ecs": true
          },
          {
            "name": "source.ip",
            "type": "ip",
            "ecs": true
          }
        ],
        "id": "740b8754-7dae-40f7-bf67-dca007e96239",
        "rule_id": "781f8746-2180-4691-890c-4c96d11ca91d",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:14.538Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:13.974Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "threshold",
        "query": "destination.port : (21 or 22 or 23 or 25 or 139 or 445 or 3389 or 5985 or 5986) and\nsource.ip : (10.0.0.0/8 or 172.16.0.0/12 or 192.168.0.0/16)",
        "threshold": {
          "field": [
            "source.ip"
          ],
          "value": 1,
          "cardinality": [
            {
              "field": "destination.ip",
              "value": 100
            }
          ]
        },
        "index": [
          "packetbeat-*",
          "auditbeat-*",
          "filebeat-*",
          "logs-network_traffic.*",
          "logs-endpoint.events.network-*",
          "logs-panw.panos*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Potential Suspicious DebugFS Root Device Access",
        "description": "This rule monitors for the usage of the built-in Linux DebugFS utility to access a disk device without root permissions. Linux users that are part of the \"disk\" group have sufficient privileges to access all data inside of the machine through DebugFS. Attackers may leverage DebugFS in conjunction with \"disk\" permissions to read sensitive files owned by root, such as the shadow file, root ssh private keys or other sensitive files that may allow them to further escalate privileges.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 6,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://book.hacktricks.xyz/linux-hardening/privilege-escalation/interesting-groups-linux-pe#disk-group"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1078",
                "name": "Valid Accounts",
                "reference": "https://attack.mitre.org/techniques/T1078/",
                "subtechnique": [
                  {
                    "id": "T1078.003",
                    "name": "Local Accounts",
                    "reference": "https://attack.mitre.org/techniques/T1078/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "group.Ext.real.id",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.Ext.real.id",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "77866932-535b-4bdf-98f2-e97c4fe1a67d",
        "rule_id": "2605aa59-29ac-4662-afad-8d86257c7c91",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:14.540Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:16.401Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and \nprocess.name == \"debugfs\" and process.args : \"/dev/sd*\" and not process.args == \"-R\" and \nnot user.Ext.real.id == \"0\" and not group.Ext.real.id == \"0\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Enumeration of Kernel Modules",
        "description": "Loadable Kernel Modules (or LKMs) are pieces of code that can be loaded and unloaded into the kernel upon demand. They extend the functionality of the kernel without the need to reboot the system. This identifies attempts to enumerate information about a kernel module.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 210,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Security tools and device drivers may run these programs in order to enumerate kernel modules. Use of these programs by ordinary users is uncommon. These can be exempted by process name or username."
        ],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1082",
                "name": "System Information Discovery",
                "reference": "https://attack.mitre.org/techniques/T1082/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "cd91151c-df05-4b51-b797-a8888558a803",
        "rule_id": "2d8043ed-5bda-4caf-801c-c1feb7410504",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:14.548Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:05.878Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "event.category:process and host.os.type:linux and event.type:start and event.action:(exec or exec_event) and (\n (process.name:(lsmod or modinfo)) or \n (process.name:kmod and process.args:list) or \n (process.name:depmod and process.args:(--all or -a))\n) and\nnot (\n  process.parent.name:(\n    mkinitramfs or cryptroot or framebuffer or dracut or jem or thin-provisioning-tools or readykernel or lvm2 or\n    vz-start or iscsi or mdadm or ovalprobes or bcache or plymouth or dkms or overlayroot or weak-modules or zfs or\n    systemd or whoopsie-upload-all or kdumpctl or apport-gtk or casper or rear or kernel-install\n  )\n)",
        "new_terms_fields": [
          "process.executable",
          "process.parent.executable"
        ],
        "history_window_start": "now-14d",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Potential SYN-Based Network Scan Detected",
        "description": "This rule identifies a potential SYN-Based port scan. A SYN port scan is a technique employed by attackers to scan a target network for open ports by sending SYN packets to multiple ports and observing the response. Attackers use this method to identify potential entry points or services that may be vulnerable to exploitation, allowing them to launch targeted attacks or gain unauthorized access to the system or network, compromising its security and potentially leading to data breaches or further malicious activities. This rule proposes threshold logic to check for connection attempts from one source host to 10 or more destination ports using 2 or less packets per port.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 7,
        "tags": [
          "Domain: Network",
          "Tactic: Discovery",
          "Tactic: Reconnaissance",
          "Use Case: Network Security Monitoring",
          "Data Source: Elastic Defend",
          "Data Source: PAN-OS"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 5,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1046",
                "name": "Network Service Discovery",
                "reference": "https://attack.mitre.org/techniques/T1046/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0043",
              "name": "Reconnaissance",
              "reference": "https://attack.mitre.org/tactics/TA0043/"
            },
            "technique": [
              {
                "id": "T1595",
                "name": "Active Scanning",
                "reference": "https://attack.mitre.org/techniques/T1595/",
                "subtechnique": [
                  {
                    "id": "T1595.001",
                    "name": "Scanning IP Blocks",
                    "reference": "https://attack.mitre.org/techniques/T1595/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "network_traffic",
            "version": "^1.1.0"
          },
          {
            "package": "panw",
            "version": "^4.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.port",
            "type": "long",
            "ecs": true
          },
          {
            "name": "network.packets",
            "type": "long",
            "ecs": true
          },
          {
            "name": "source.ip",
            "type": "ip",
            "ecs": true
          }
        ],
        "id": "8f0aa4de-93a9-44db-9964-fae3d0ff1250",
        "rule_id": "bbaa96b9-f36c-4898-ace2-581acb00a409",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:14.557Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:16.259Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "threshold",
        "query": "destination.port : * and network.packets <= 2 and source.ip : (10.0.0.0/8 or 172.16.0.0/12 or 192.168.0.0/16)",
        "threshold": {
          "field": [
            "destination.ip",
            "source.ip"
          ],
          "value": 1,
          "cardinality": [
            {
              "field": "destination.port",
              "value": 250
            }
          ]
        },
        "index": [
          "logs-endpoint.events.network-*",
          "logs-network_traffic.*",
          "packetbeat-*",
          "auditbeat-*",
          "filebeat-*",
          "logs-panw.panos*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Shared Object Created or Changed by Previously Unknown Process",
        "description": "This rule monitors the creation of shared object files by previously unknown processes. The creation of a shared object file involves compiling code into a dynamically linked library that can be loaded by other programs at runtime. While this process is typically used for legitimate purposes, malicious actors can leverage shared object files to execute unauthorized code, inject malicious functionality into legitimate processes, or bypass security controls. This allows malware to persist on the system, evade detection, and potentially compromise the integrity and confidentiality of the affected system and its data.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Shared Object Created or Changed by Previously Unknown Process\n\nA shared object file is a compiled library file (typically with a .so extension) that can be dynamically linked to executable programs at runtime, allowing for code reuse and efficient memory usage. The creation of a shared object file involves compiling code into a dynamically linked library that can be loaded by other programs at runtime.\n\nMalicious actors can leverage shared object files to execute unauthorized code, inject malicious functionality into legitimate processes, or bypass security controls. This allows malware to persist on the system, evade detection, and potentially compromise the integrity and confidentiality of the affected system and its data.\n\nThis rule monitors the creation of shared object files by previously unknown processes through the usage of the new terms rule type.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n> This investigation guide uses [placeholder fields](https://www.elastic.co/guide/en/security/current/osquery-placeholder-fields.html) to dynamically pass alert data into Osquery queries. Placeholder fields were introduced in Elastic Stack version 8.7.0. If you're using Elastic Stack version 8.6.0 or earlier, you'll need to manually adjust this investigation guide's queries to ensure they properly run.\n\n#### Possible Investigation Steps\n\n- Investigate the shared object that was created or modified through OSQuery.\n  - !{osquery{\"label\":\"Osquery - Retrieve File Listing Information\",\"query\":\"SELECT * FROM file WHERE path = {{file.path}}\\n\"}}\n  - !{osquery{\"label\":\"Osquery - Retrieve Additional File Listing Information\",\"query\":\"SELECT f.path, u.username AS file_owner, g.groupname AS group_owner, datetime(f.atime, 'unixepoch') AS\\nfile_last_access_time, datetime(f.mtime, 'unixepoch') AS file_last_modified_time, datetime(f.ctime, 'unixepoch') AS\\nfile_last_status_change_time, datetime(f.btime, 'unixepoch') AS file_created_time, f.size AS size_bytes FROM file f LEFT\\nJOIN users u ON f.uid = u.uid LEFT JOIN groups g ON f.gid = g.gid WHERE path = {{file.path}}\\n\"}}\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence and whether they are located in expected locations.\n  - !{osquery{\"label\":\"Osquery - Retrieve Running Processes by User\",\"query\":\"SELECT pid, username, name FROM processes p JOIN users u ON u.uid = p.uid ORDER BY username\"}}\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Validate the activity is not related to planned patches, updates, network administrator activity, or legitimate software installations.\n- Investigate whether the altered scripts call other malicious scripts elsewhere on the file system. \n  - If scripts or executables were dropped, retrieve the files and determine if they are malicious:\n    - Use a private sandboxed malware analysis system to perform analysis.\n      - Observe and collect information about the following activities:\n        - Attempts to contact external domains and addresses.\n          - Check if the domain is newly registered or unexpected.\n          - Check the reputation of the domain or IP address.\n        - File access, modification, and creation activities.\n        - Cron jobs, services and other persistence mechanisms.\n            - !{osquery{\"label\":\"Osquery - Retrieve Crontab Information\",\"query\":\"SELECT * FROM crontab\"}}\n- Investigate abnormal behaviors by the subject process/user such as network connections, file modifications, and any other spawned child processes.\n  - Investigate listening ports and open sockets to look for potential command and control traffic or data exfiltration.\n    - !{osquery{\"label\":\"Osquery - Retrieve Listening Ports\",\"query\":\"SELECT pid, address, port, socket, protocol, path FROM listening_ports\"}}\n    - !{osquery{\"label\":\"Osquery - Retrieve Open Sockets\",\"query\":\"SELECT pid, family, remote_address, remote_port, socket, state FROM process_open_sockets\"}}\n  - Identify the user account that performed the action, analyze it, and check whether it should perform this kind of action.\n    - !{osquery{\"label\":\"Osquery - Retrieve Information for a Specific User\",\"query\":\"SELECT * FROM users WHERE username = {{user.name}}\"}}\n- Investigate whether the user is currently logged in and active.\n    - !{osquery{\"label\":\"Osquery - Investigate the Account Authentication Status\",\"query\":\"SELECT * FROM logged_in_users WHERE user = {{user.name}}\"}}\n\n### False Positive Analysis\n\n- If this activity is related to new benign software installation activity, consider adding exceptions â€” preferably with a combination of user and command line conditions.\n- If this activity is related to a system administrator that performed these actions for administrative purposes, consider adding exceptions for this specific administrator user account. \n- Try to understand the context of the execution by thinking about the user, machine, or business purpose. A small number of endpoints, such as servers with unique software, might appear unusual but satisfy a specific business need.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Leverage the incident response data and logging to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 9,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://threatpost.com/sneaky-malware-backdoors-linux/180158/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1574",
                "name": "Hijack Execution Flow",
                "reference": "https://attack.mitre.org/techniques/T1574/",
                "subtechnique": [
                  {
                    "id": "T1574.006",
                    "name": "Dynamic Linker Hijacking",
                    "reference": "https://attack.mitre.org/techniques/T1574/006/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "fde654de-08d2-4d24-81f3-e7abb3b4bf12",
        "rule_id": "aebaa51f-2a91-4f6a-850b-b601db2293f4",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:14.559Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:14.974Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "host.os.type:linux and event.action:(creation or file_create_event or file_rename_event or rename) and \nfile.path:(/dev/shm/* or /usr/lib/*) and file.extension:so and process.name:* and not (\n  process.name:(\n    \"dockerd\" or \"dpkg\" or \"rpm\" or \"snapd\" or \"yum\" or \"vmis-launcher\" or \"pacman\" or \"apt-get\" or \"dnf\" or \"podman\" or\n    platform-python* or \"dnf-automatic\" or \"unattended-upgrade\" or \"apk\" or \"snap-update-ns\" or \"install\" or \"exe\" or\n    \"systemd\" or \"root\" or \"sshd\" or \"pip\" or \"jlink\" or python* or \"update-alternatives\" or pip* or\n    \"installer.bin.inst\" or \"uninstall-bin\" or \"linux_agent.inst\"\n  ) or \n  (process.name:vmware-install.pl and file.path:/usr/lib/vmware-tools/*) or\n  process.executable : (/dev/fd/* or \"/\" or \"/kaniko/executor\" or \"/usr/bin/buildah\")\n)",
        "new_terms_fields": [
          "file.path",
          "process.executable"
        ],
        "history_window_start": "now-10d",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Potential Unauthorized Access via Wildcard Injection Detected",
        "description": "This rule monitors for the execution of the \"chown\" and \"chmod\" commands with command line flags that could indicate a wildcard injection attack. Linux wildcard injection is a type of security vulnerability where attackers manipulate commands or input containing wildcards (e.g., *, ?, []) to execute unintended operations or access sensitive data by tricking the system into interpreting the wildcard characters in unexpected ways.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 5,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Tactic: Credential Access",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Auditd Manager"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.exploit-db.com/papers/33930"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1068",
                "name": "Exploitation for Privilege Escalation",
                "reference": "https://attack.mitre.org/techniques/T1068/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1003",
                "name": "OS Credential Dumping",
                "reference": "https://attack.mitre.org/techniques/T1003/",
                "subtechnique": [
                  {
                    "id": "T1003.008",
                    "name": "/etc/passwd and /etc/shadow",
                    "reference": "https://attack.mitre.org/techniques/T1003/008/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "auditd_manager",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "ae7195ba-e0b9-498c-a099-c9ddeec9d9f8",
        "rule_id": "4a99ac6f-9a54-4ba5-a64f-6eb65695841b",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:14.568Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:17.158Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\", \"executed\", \"process_started\")\n and process.name in (\"chown\", \"chmod\") and process.args == \"-R\" and process.args : \"--reference=*\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*",
          "auditbeat-*",
          "logs-auditd_manager.auditd-*"
        ],
        "filters": []
      },
      {
        "name": "Potential Reverse Shell",
        "description": "This detection rule identifies suspicious network traffic patterns associated with TCP reverse shell activity. This activity consists of a parent-child relationship where a network event is followed by the creation of a shell process. An attacker may establish a Linux TCP reverse shell to gain remote access to a target system.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 9,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Reverse%20Shell%20Cheatsheet.md"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.004",
                    "name": "Unix Shell",
                    "reference": "https://attack.mitre.org/techniques/T1059/004/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            },
            "technique": [
              {
                "id": "T1071",
                "name": "Application Layer Protocol",
                "reference": "https://attack.mitre.org/techniques/T1071/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "e37e4cd7-3d3a-4b5f-adde-79920873ea0e",
        "rule_id": "48b3d2e3-f4e8-41e6-95e6-9b2091228db3",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:14.576Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:05.915Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by host.id with maxspan=5s\n  [network where event.type == \"start\" and host.os.type == \"linux\" and\n     event.action in (\"connection_attempted\", \"connection_accepted\") and\n     process.name : (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\", \"socat\") and destination.ip != null and\n     not cidrmatch(destination.ip, \"127.0.0.0/8\", \"169.254.0.0/16\", \"224.0.0.0/4\", \"::1\")] by process.entity_id\n  [process where event.type == \"start\" and host.os.type == \"linux\" and event.action in (\"exec\", \"fork\") and\n     process.name in (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\") and (\n       (process.args : (\"-i\", \"-l\")) or (process.parent.name == \"socat\" and process.parent.args : \"*exec*\")\n   )] by process.parent.entity_id",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Kernel Load or Unload via Kexec Detected",
        "description": "This detection rule identifies the usage of kexec, helping to uncover unauthorized kernel replacements and potential compromise of the system's integrity. Kexec is a Linux feature that enables the loading and execution of a different kernel without going through the typical boot process. Malicious actors can abuse kexec to bypass security measures, escalate privileges, establish persistence or hide their activities by loading a malicious kernel, enabling them to tamper with the system's trusted state, allowing e.g. a VM Escape.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 7,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Tactic: Privilege Escalation",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame",
          "Data Source: Auditd Manager"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.crowdstrike.com/blog/venom-vulnerability-details/",
          "https://www.makeuseof.com/what-is-venom-vulnerability/",
          "https://madaidans-insecurities.github.io/guides/linux-hardening.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1611",
                "name": "Escape to Host",
                "reference": "https://attack.mitre.org/techniques/T1611/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1547",
                "name": "Boot or Logon Autostart Execution",
                "reference": "https://attack.mitre.org/techniques/T1547/",
                "subtechnique": [
                  {
                    "id": "T1547.006",
                    "name": "Kernel Modules and Extensions",
                    "reference": "https://attack.mitre.org/techniques/T1547/006/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1601",
                "name": "Modify System Image",
                "reference": "https://attack.mitre.org/techniques/T1601/",
                "subtechnique": [
                  {
                    "id": "T1601.001",
                    "name": "Patch System Image",
                    "reference": "https://attack.mitre.org/techniques/T1601/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "auditd_manager",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "c129eddc-4668-4c9e-a476-f9d93eec21b9",
        "rule_id": "4d4c35f4-414e-4d0c-bb7e-6db7c80a6957",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:14.579Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:09.121Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\", \"executed\", \"process_started\")\n and process.name == \"kexec\" and process.args in (\"--exec\", \"-e\", \"--load\", \"-l\", \"--unload\", \"-u\") and not\n process.parent.name in (\"kdumpctl\", \"unload.sh\")",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*",
          "auditbeat-*",
          "logs-auditd_manager.auditd-*"
        ],
        "filters": []
      },
      {
        "name": "Potential Privilege Escalation via Container Misconfiguration",
        "description": "This rule monitors for the execution of processes that interact with Linux containers through an interactive shell without root permissions. Utilities such as runc and ctr are universal command-line utilities leveraged to interact with containers via root permissions. On systems where the access to these utilities are misconfigured, attackers might be able to create and run a container that mounts the root folder or spawn a privileged container vulnerable to a container escape attack, which might allow them to escalate privileges and gain further access onto the host file system.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 5,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Domain: Container",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://book.hacktricks.xyz/linux-hardening/privilege-escalation/runc-privilege-escalation",
          "https://book.hacktricks.xyz/linux-hardening/privilege-escalation/containerd-ctr-privilege-escalation"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1611",
                "name": "Escape to Host",
                "reference": "https://attack.mitre.org/techniques/T1611/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\nSession View uses process data collected by the Elastic Defend integration, but this data is not always collected by default. Session View is available on enterprise subscription for versions 8.3 and above.\n#### To confirm that Session View data is enabled:\n- Go to â€œManage â†’ Policiesâ€, and edit one or more of your Elastic Defend integration policies.\n- Select theâ€ Policy settingsâ€ tab, then scroll down to the â€œLinux event collectionâ€ section near the bottom.\n- Check the box for â€œProcess eventsâ€, and turn on the â€œInclude session dataâ€ toggle.\n- If you want to include file and network alerts in Session View, check the boxes for â€œNetwork and File eventsâ€.\n- If you want to enable terminal output capture, turn on the â€œCapture terminal outputâ€ toggle.\nFor more information about the additional fields collected when this setting is enabled and the usage of Session View for Analysis refer to the [helper guide](https://www.elastic.co/guide/en/security/current/session-view.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "group.Ext.real.id",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.interactive",
            "type": "boolean",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.interactive",
            "type": "boolean",
            "ecs": true
          },
          {
            "name": "user.Ext.real.id",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "da818365-be1e-44e4-8a2e-51bca0d8aaf9",
        "rule_id": "afe6b0eb-dd9d-4922-b08a-1910124d524d",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:14.587Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:17.218Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and (\n  (process.name == \"runc\" and process.args == \"run\") or\n  (process.name == \"ctr\" and process.args == \"run\" and process.args in (\"--privileged\", \"--mount\"))\n) and not user.Ext.real.id == \"0\" and not group.Ext.real.id == \"0\" and \nprocess.interactive == true and process.parent.interactive == true",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Linux Restricted Shell Breakout via Linux Binary(s)",
        "description": "Identifies the abuse of a Linux binary to break out of a restricted shell or environment by spawning an interactive system shell. The activity of spawning a shell from a binary is not common behavior for a user or system administrator, and may indicate an attempt to evade detection, increase capabilities or enhance the stability of an adversary.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Shell Evasion via Linux Utilities\nDetection alerts from this rule indicate that a Linux utility has been abused to breakout of restricted shells or\nenvironments by spawning an interactive system shell.\nHere are some possible avenues of investigation:\n- Examine the entry point to the host and user in action via the Analyse View.\n  - Identify the session entry leader and session user\n- Examine the contents of session leading to the abuse via the Session View.\n  - Examine the command execution pattern in the session, which may lead to suspricous activities\n- Examine the execution of commands in the spawned shell.\n  - Identify imment threat to the system from the executed commands\n  - Take necessary incident response actions to contain any malicious behviour caused via this execution.\n\n### Related rules\n\n- A malicious spawned shell can execute any of the possible MITTRE ATT&CK vectors mainly to impair defences.\n- Hence its adviced to enable defence evasion and privilige escalation rules accordingly in your environment\n\n### Response and remediation\n\nInitiate the incident response process based on the outcome of the triage.\n\n- If the triage releaved suspicious netwrok activity from the malicious spawned shell,\n  - Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware execution via the maliciously spawned shell,\n  - Search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- If the triage revelaed defence evasion for imparing defenses\n  - Isolate the involved host to prevent further post-compromise behavior.\n  - Identified the disabled security guard components on the host and take necessary steps in renebaling the same.\n  - If any tools have been disbaled / uninstalled or config tampered work towards reenabling the same.\n- If the triage revelaed addition of persistence mechanism exploit like auto start scripts\n  - Isolate further login to the systems that can initae auto start scripts.\n  - Identify the auto start scripts and disable and remove the same from the systems\n- If the triage revealed data crawling or data export via remote copy\n  - Investigate credential exposure on systems compromised / used / decoded by the attacker during the data crawling\n  - Intiate compromised credential deactivation and credential rotation process for all exposed crednetials.\n  - Investiagte if any IPR data was accessed during the data crawling and take appropriate actions.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 113,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://gtfobins.github.io/gtfobins/apt/",
          "https://gtfobins.github.io/gtfobins/apt-get/",
          "https://gtfobins.github.io/gtfobins/nawk/",
          "https://gtfobins.github.io/gtfobins/mawk/",
          "https://gtfobins.github.io/gtfobins/awk/",
          "https://gtfobins.github.io/gtfobins/gawk/",
          "https://gtfobins.github.io/gtfobins/busybox/",
          "https://gtfobins.github.io/gtfobins/c89/",
          "https://gtfobins.github.io/gtfobins/c99/",
          "https://gtfobins.github.io/gtfobins/cpulimit/",
          "https://gtfobins.github.io/gtfobins/crash/",
          "https://gtfobins.github.io/gtfobins/env/",
          "https://gtfobins.github.io/gtfobins/expect/",
          "https://gtfobins.github.io/gtfobins/find/",
          "https://gtfobins.github.io/gtfobins/flock/",
          "https://gtfobins.github.io/gtfobins/gcc/",
          "https://gtfobins.github.io/gtfobins/mysql/",
          "https://gtfobins.github.io/gtfobins/nice/",
          "https://gtfobins.github.io/gtfobins/ssh/",
          "https://gtfobins.github.io/gtfobins/vi/",
          "https://gtfobins.github.io/gtfobins/vim/",
          "https://gtfobins.github.io/gtfobins/capsh/",
          "https://gtfobins.github.io/gtfobins/byebug/",
          "https://gtfobins.github.io/gtfobins/git/",
          "https://gtfobins.github.io/gtfobins/ftp/",
          "https://www.elastic.co/security-labs/sequel-on-persistence-mechanisms"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.004",
                    "name": "Unix Shell",
                    "reference": "https://attack.mitre.org/techniques/T1059/004/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\nSession View uses process data collected by the Elastic Defend integration, but this data is not always collected by default. Session View is available on enterprise subscription for versions 8.3 and above.\n#### To confirm that Session View data is enabled:\n- Go to â€œManage â†’ Policiesâ€, and edit one or more of your Elastic Defend integration policies.\n- Select theâ€ Policy settingsâ€ tab, then scroll down to the â€œLinux event collectionâ€ section near the bottom.\n- Check the box for â€œProcess eventsâ€, and turn on the â€œInclude session dataâ€ toggle.\n- If you want to include file and network alerts in Session View, check the boxes for â€œNetwork and File eventsâ€.\n- If you want to enable terminal output capture, turn on the â€œCapture terminal outputâ€ toggle.\nFor more information about the additional fields collected when this setting is enabled and the usage of Session View for Analysis refer to the [helper guide](https://www.elastic.co/guide/en/security/current/session-view.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args_count",
            "type": "long",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "79c0b74a-6cbc-45a4-85b3-bf4daa74b3ea",
        "rule_id": "52376a86-ee86-4967-97ae-1a05f55816f0",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:14.595Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:04.041Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and\n(\n  /* launching shell from capsh */\n  (process.name == \"capsh\" and process.args == \"--\") or\n  \n  /* launching shells from unusual parents or parent+arg combos */\n  (process.name in (\"bash\", \"dash\", \"ash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\") and (\n    (process.parent.name : \"*awk\" and process.parent.args : \"BEGIN {system(*)}\") or\n    (process.parent.name == \"git\" and process.parent.args : (\"*PAGER*\", \"!*sh\", \"exec *sh\") or \n     process.args : (\"*PAGER*\", \"!*sh\", \"exec *sh\") and not process.name == \"ssh\" ) or\n    (process.parent.name : (\"byebug\", \"ftp\", \"strace\", \"zip\", \"tar\") and \n    (\n      process.parent.args : \"BEGIN {system(*)}\" or\n      (process.parent.args : (\"*PAGER*\", \"!*sh\", \"exec *sh\") or process.args : (\"*PAGER*\", \"!*sh\", \"exec *sh\")) or\n      (\n        (process.parent.args : \"exec=*sh\" or (process.parent.args : \"-I\" and process.parent.args : \"*sh\")) or\n        (process.args : \"exec=*sh\" or (process.args : \"-I\" and process.args : \"*sh\"))\n        )\n      )\n    ) or\n    \n    /* shells specified in parent args */\n    /* nice rule is broken in 8.2 */\n    (process.parent.args : \"*sh\" and\n      (\n        (process.parent.name == \"nice\") or\n        (process.parent.name == \"cpulimit\" and process.parent.args == \"-f\") or\n        (process.parent.name == \"find\" and process.parent.args == \".\" and process.parent.args == \"-exec\" and \n         process.parent.args == \";\" and process.parent.args : \"/bin/*sh\") or\n        (process.parent.name == \"flock\" and process.parent.args == \"-u\" and process.parent.args == \"/\")\n      )\n    )\n  )) or\n\n  /* shells specified in args */\n  (process.args : \"*sh\" and (\n    (process.parent.name == \"crash\" and process.parent.args == \"-h\") or\n    (process.name == \"sensible-pager\" and process.parent.name in (\"apt\", \"apt-get\") and process.parent.args == \"changelog\")\n    /* scope to include more sensible-pager invoked shells with different parent process to reduce noise and remove false positives */\n    \n  )) or\n  (process.name == \"busybox\" and event.action == \"exec\" and process.args_count == 2 and process.args : \"*sh\" and not \n   process.executable : \"/var/lib/docker/overlay2/*/merged/bin/busybox\" and not (process.parent.args == \"init\" and\n   process.parent.args == \"runc\") and not process.parent.args in (\"ls-remote\", \"push\", \"fetch\") and not process.parent.name == \"mkinitramfs\") or\n  (process.name == \"env\" and process.args_count == 2 and process.args : \"*sh\") or\n  (process.parent.name in (\"vi\", \"vim\") and process.parent.args == \"-c\" and process.parent.args : \":!*sh\") or\n  (process.parent.name in (\"c89\", \"c99\", \"gcc\") and process.parent.args : \"*sh,-s\" and process.parent.args == \"-wrapper\") or\n  (process.parent.name == \"expect\" and process.parent.args == \"-c\" and process.parent.args : \"spawn *sh;interact\") or\n  (process.parent.name == \"mysql\" and process.parent.args == \"-e\" and process.parent.args : \"\\\\!*sh\") or\n  (process.parent.name == \"ssh\" and process.parent.args == \"-o\" and process.parent.args : \"ProxyCommand=;*sh 0<&2 1>&2\")\n)",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious Network Activity to the Internet by Previously Unknown Executable",
        "description": "This rule monitors for network connectivity to the internet from a previously unknown executable located in a suspicious directory. An alert from this rule can indicate the presence of potentially malicious activity, such as the execution of unauthorized or suspicious processes attempting to establish connections to unknown or suspicious destinations such as a command and control server. Detecting and investigating such behavior can help identify and mitigate potential security threats, protecting the system and its data from potential compromise.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Suspicious Network Activity to the Internet by Previously Unknown Executable\n\nAfter being installed, malware will often call out to its command and control server to receive further instructions by its operators.\n\nThis rule leverages the new terms rule type to detect previously unknown processes, initiating network connections to external IP-addresses. \n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n> This investigation guide uses [placeholder fields](https://www.elastic.co/guide/en/security/current/osquery-placeholder-fields.html) to dynamically pass alert data into Osquery queries. Placeholder fields were introduced in Elastic Stack version 8.7.0. If you're using Elastic Stack version 8.6.0 or earlier, you'll need to manually adjust this investigation guide's queries to ensure they properly run.\n\n#### Possible investigation steps\n\n- Identify any signs of suspicious network activity or anomalies that may indicate malicious behavior. This could include unexpected traffic patterns or unusual network behavior.\n  - Investigate listening ports and open sockets to look for potential malicious processes, reverse shells or data exfiltration.\n    - !{osquery{\"label\":\"Osquery - Retrieve Listening Ports\",\"query\":\"SELECT pid, address, port, socket, protocol, path FROM listening_ports\"}}\n    - !{osquery{\"label\":\"Osquery - Retrieve Open Sockets\",\"query\":\"SELECT pid, family, remote_address, remote_port, socket, state FROM process_open_sockets\"}}\n- Identify the user account that performed the action, analyze it, and check whether it should perform this kind of action.\n  - !{osquery{\"label\":\"Osquery - Retrieve Information for a Specific User\",\"query\":\"SELECT * FROM users WHERE username = {{user.name}}\"}}\n- Investigate whether the user is currently logged in and active.\n  - !{osquery{\"label\":\"Osquery - Investigate the Account Authentication Status\",\"query\":\"SELECT * FROM logged_in_users WHERE user = {{user.name}}\"}}\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence and whether they are located in expected locations.\n  - !{osquery{\"label\":\"Osquery - Retrieve Running Processes by User\",\"query\":\"SELECT pid, username, name FROM processes p JOIN users u ON u.uid = p.uid ORDER BY username\"}}\n  - !{osquery{\"label\":\"Osquery - Retrieve Process Info\",\"query\":\"SELECT name, cmdline, parent, path, uid FROM processes\"}}\n- Investigate other alerts associated with the user/host during the past 48 hours.\n  - If scripts or executables were dropped, retrieve the files and determine if they are malicious:\n    - Use a private sandboxed malware analysis system to perform analysis.\n      - Observe and collect information about the following activities:\n        - Attempts to contact external domains and addresses.\n          - Check if the domain is newly registered or unexpected.\n          - Check the reputation of the domain or IP address.\n        - File access, modification, and creation activities.\n\n### Related rules\n\n- Network Activity Detected via cat - afd04601-12fc-4149-9b78-9c3f8fe45d39\n\n### False positive analysis\n\n- If this activity is related to new benign software installation activity, consider adding exceptions â€” preferably with a combination of user and command line conditions.\n- Try to understand the context of the execution by thinking about the user, machine, or business purpose. A small number of endpoints, such as servers with unique software, might appear unusual but satisfy a specific business need.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors, such as reverse shells, reverse proxies, or droppers, that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Leverage the incident response data and logging to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 11,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Command and Control",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-3540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            },
            "technique": [
              {
                "id": "T1071",
                "name": "Application Layer Protocol",
                "reference": "https://attack.mitre.org/techniques/T1071/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from one of the following integrations:\n- Elastic Defend\n- Auditbeat\n- Filebeat\n- Packetbeat\n\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows\nthe Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest to select \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n### Auditbeat Setup\nAuditbeat is a lightweight shipper that you can install on your servers to audit the activities of users and processes on your systems. For example, you can use Auditbeat to collect and centralize audit events from the Linux Audit Framework. You can also use Auditbeat to detect changes to critical files, like binaries and configuration files, and identify potential security policy violations.\n\n#### The following steps should be executed in order to add the Auditbeat on a Linux System:\n- Elastic provides repositories available for APT and YUM-based distributions. Note that we provide binary packages, but no source packages.\n- To install the APT and YUM repositories follow the setup instructions in this [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/setup-repositories.html).\n- To run Auditbeat on Docker follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/running-on-docker.html).\n- To run Auditbeat on Kubernetes follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/running-on-kubernetes.html).\n- For complete â€œSetup and Run Auditbeatâ€ information refer to the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/setting-up-and-running.html).\n\n### Filebeat Setup\nFilebeat is a lightweight shipper for forwarding and centralizing log data. Installed as an agent on your servers, Filebeat monitors the log files or locations that you specify, collects log events, and forwards them either to Elasticsearch or Logstash for indexing.\n\n#### The following steps should be executed in order to add the Filebeat on a Linux System:\n- Elastic provides repositories available for APT and YUM-based distributions. Note that we provide binary packages, but no source packages.\n- To install the APT and YUM repositories follow the setup instructions in this [helper guide](https://www.elastic.co/guide/en/beats/filebeat/current/setup-repositories.html).\n- To run Filebeat on Docker follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/filebeat/current/running-on-docker.html).\n- To run Filebeat on Kubernetes follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/filebeat/current/running-on-kubernetes.html).\n- For quick start information for Filebeat refer to the [helper guide](https://www.elastic.co/guide/en/beats/filebeat/8.11/filebeat-installation-configuration.html).\n- For complete â€œSetup and Run Filebeatâ€ information refer to the [helper guide](https://www.elastic.co/guide/en/beats/filebeat/current/setting-up-and-running.html).\n\n### Packetbeat Setup\nPacketbeat is a real-time network packet analyzer that you can use for application monitoring, performance analytics, and threat detection. Packetbeat works by capturing the network traffic between your application servers, decoding the application layer protocols (HTTP, MySQL, Redis, and so on), correlating the requests with the responses, and recording the interesting fields for each transaction.\n\n#### The following steps should be executed in order to add the Packetbeat on a  Linux System:\n- Elastic provides repositories available for APT and YUM-based distributions. Note that we provide binary packages, but no source packages.\n- To install the APT and YUM repositories follow the setup instructions in this [helper guide](https://www.elastic.co/guide/en/beats/packetbeat/current/setup-repositories.html).\n- To run Packetbeat on Docker follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/packetbeat/current/running-on-docker.html).\n- For quick start information for Packetbeat refer to the [helper guide](https://www.elastic.co/guide/en/beats/packetbeat/current/packetbeat-installation-configuration.html).\n- For complete â€œSetup and Run Packetbeatâ€ information refer to the [helper guide](https://www.elastic.co/guide/en/beats/packetbeat/current/setting-up-and-running.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "source.ip",
            "type": "ip",
            "ecs": true
          }
        ],
        "id": "5fe06d35-3b47-42cc-ac0f-4dac27e8ca63",
        "rule_id": "53617418-17b4-4e9c-8a2c-8deb8086ca4b",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:14.597Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:09.142Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "host.os.type:linux and event.category:network and event.action:(connection_attempted or ipv4_connection_attempt_event) and\nprocess.executable : (\n  /etc/crontab or /etc/rc.local or ./* or /boot/* or /dev/shm/* or /etc/cron.*/* or /etc/init.d/* or /etc/rc*.d/* or\n  /etc/update-motd.d/* or /home/*/.* or /tmp/* or /usr/lib/update-notifier/* or /var/log/* or /var/tmp/*\n) and process.name : * and\nnot (\n  process.executable : (\n    /tmp/newroot/* or /tmp/snap.rootfs* or /etc/cron.hourly/BitdefenderRedline or /tmp/go-build* or /srv/snp/docker/* or\n    /run/containerd/* or /tmp/.mount* or /run/k3s/containerd/* or /tmp/selenium* or /tmp/tmp.*/juliainstaller or\n    /tmp/.criu.mntns* or /home/*/.local/share/containers/* or /etc/update-motd.d/*\n  ) or\n  source.ip:(10.0.0.0/8 or 127.0.0.0/8 or 172.16.0.0/12 or 192.168.0.0/16) or\n  process.name : (\n    apt or chrome or curl or dnf or dockerd or dpkg or firefox-bin or git-remote-https or java or kite-update or\n    kited or node or rpm or saml2aws or selenium-manager or solana-validator or wget or yum or ansible* or aws* or\n    php* or pip* or python* or steam* or terraform*\n  ) or\n  destination.ip:(\n    0.0.0.0 or 10.0.0.0/8 or 100.64.0.0/10 or 127.0.0.0/8 or 169.254.0.0/16 or 172.16.0.0/12 or 192.0.0.0/24 or\n    192.0.0.0/29 or 192.0.0.10/32 or 192.0.0.170/32 or 192.0.0.171/32 or 192.0.0.8/32 or 192.0.0.9/32 or 192.0.2.0/24 or\n    192.168.0.0/16 or 192.175.48.0/24 or 192.31.196.0/24 or 192.52.193.0/24 or 192.88.99.0/24 or 198.18.0.0/15 or\n    198.51.100.0/24 or 203.0.113.0/24 or 224.0.0.0/4 or 240.0.0.0/4 or \"::1\" or \"FE80::/10\" or \"FF00::/8\"\n  )\n)",
        "new_terms_fields": [
          "process.executable"
        ],
        "history_window_start": "now-20d",
        "index": [
          "auditbeat-*",
          "filebeat-*",
          "packetbeat-*",
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Process Spawned from Message-of-the-Day (MOTD)",
        "description": "Message of the day (MOTD) is the message that is presented to the user when a user connects to a Linux server via SSH or a serial connection. Linux systems contain several default MOTD files located in the \"/etc/update-motd.d/\" directory. These scripts run as the root user every time a user connects over SSH or a serial connection. Adversaries may create malicious MOTD files that grant them persistence onto the target every time a user connects to the system by executing a backdoor script or command. This rule detects the execution of potentially malicious processes through the MOTD utility.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Process Spawned from Message-of-the-Day (MOTD)\n\nThe message-of-the-day (MOTD) is used to display a customizable system-wide message or information to users upon login in Linux.\n\nAttackers can abuse message-of-the-day (motd) files to run scripts, commands or malicious software every time a user connects to a system over SSH or a serial connection, by creating a new file within the `/etc/update-motd.d/` directory. Files in these directories will automatically run with root privileges when they are made executable.\n\nThis rule identifies the execution of potentially malicious processes from a MOTD script, which is not likely to occur as default benign behavior. \n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n> This investigation guide uses [placeholder fields](https://www.elastic.co/guide/en/security/current/osquery-placeholder-fields.html) to dynamically pass alert data into Osquery queries. Placeholder fields were introduced in Elastic Stack version 8.7.0. If you're using Elastic Stack version 8.6.0 or earlier, you'll need to manually adjust this investigation guide's queries to ensure they properly run.\n\n#### Possible Investigation Steps\n\n- Investigate the file that was created or modified from which the suspicious process was executed.\n  - !{osquery{\"label\":\"Osquery - Retrieve File Information\",\"query\":\"SELECT * FROM file WHERE path = {{file.path}}\"}}\n- Investigate whether any other files in the `/etc/update-motd.d/` directory have been altered.\n  - !{osquery{\"label\":\"Osquery - Retrieve File Listing Information\",\"query\":\"SELECT * FROM file WHERE path LIKE '/etc/update-motd.d/%'\"}}\n  - !{osquery{\"label\":\"Osquery - Retrieve Additional File Listing Information\",\"query\":\"SELECT f.path, u.username AS file_owner, g.groupname AS group_owner, datetime(f.atime, 'unixepoch') AS\\nfile_last_access_time, datetime(f.mtime, 'unixepoch') AS file_last_modified_time, datetime(f.ctime, 'unixepoch') AS\\nfile_last_status_change_time, datetime(f.btime, 'unixepoch') AS file_created_time, f.size AS size_bytes FROM file f LEFT\\nJOIN users u ON f.uid = u.uid LEFT JOIN groups g ON f.gid = g.gid WHERE path LIKE '/etc/update-motd.d/%'\\n\"}}\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence and whether they are located in expected locations.\n  - !{osquery{\"label\":\"Osquery - Retrieve Running Processes by User\",\"query\":\"SELECT pid, username, name FROM processes p JOIN users u ON u.uid = p.uid ORDER BY username\"}}\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate whether the altered scripts call other malicious scripts elsewhere on the file system. \n  - If scripts or executables were dropped, retrieve the files and determine if they are malicious:\n    - Use a private sandboxed malware analysis system to perform analysis.\n      - Observe and collect information about the following activities:\n        - Attempts to contact external domains and addresses.\n          - Check if the domain is newly registered or unexpected.\n          - Check the reputation of the domain or IP address.\n        - File access, modification, and creation activities.\n        - Cron jobs, services, and other persistence mechanisms.\n            - !{osquery{\"label\":\"Osquery - Retrieve Crontab Information\",\"query\":\"SELECT * FROM crontab\"}}\n\n### Related Rules\n\n- Message-of-the-Day (MOTD) File Creation - 96d11d31-9a79-480f-8401-da28b194608f\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Any activity that triggered the alert and is not inherently malicious must be monitored by the security team.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Delete the MOTD files or restore them to the original configuration.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Leverage the incident response data and logging to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 10,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Data Source: Elastic Endgame",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://pberba.github.io/security/2022/02/06/linux-threat-hunting-for-persistence-initialization-scripts-and-shell-configuration/#10-boot-or-logon-initialization-scripts-motd"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1037",
                "name": "Boot or Logon Initialization Scripts",
                "reference": "https://attack.mitre.org/techniques/T1037/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args_count",
            "type": "long",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "e7c45f69-f9d1-4612-a90a-d11455001f48",
        "rule_id": "4ec47004-b34a-42e6-8003-376a123ea447",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:14.606Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:04.123Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where event.type == \"start\" and host.os.type == \"linux\" and event.action : (\"exec\", \"exec_event\") and\n  process.parent.executable : \"/etc/update-motd.d/*\" and (\n  (process.name in (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\") and (\n    (process.args : (\"-i\", \"-l\")) or (process.parent.name == \"socat\" and process.parent.args : \"*exec*\"))) or\n  (process.name : (\"nc\", \"ncat\", \"netcat\", \"nc.openbsd\") and process.args_count >= 3 and \n    not process.args : (\"-*z*\", \"-*l*\")) or\n  (process.name : \"python*\" and process.args : \"-c\" and process.args : (\n     \"*import*pty*spawn*\", \"*import*subprocess*call*\"\n  )) or\n  (process.name : \"perl*\" and process.args : \"-e\" and process.args : \"*socket*\" and process.args : (\n     \"*exec*\", \"*system*\"\n  )) or\n  (process.name : \"ruby*\" and process.args : (\"-e\", \"-rsocket\") and process.args : (\n     \"*TCPSocket.new*\", \"*TCPSocket.open*\"\n  )) or\n  (process.name : \"lua*\" and process.args : \"-e\" and process.args : \"*socket.tcp*\" and process.args : (\n     \"*io.popen*\", \"*os.execute*\"\n  )) or\n  (process.name : \"php*\" and process.args : \"-r\" and process.args : \"*fsockopen*\" and process.args : \"*/bin/*sh*\") or \n  (process.name : (\"awk\", \"gawk\", \"mawk\", \"nawk\") and process.args : \"*/inet/tcp/*\") or \n  (process.name in (\"openssl\", \"telnet\")) or\n  (process.args : (\n    \"./*\", \"/boot/*\", \"/dev/shm/*\", \"/etc/cron.*/*\", \"/etc/init.d/*\", \"/etc/update-motd.d/*\", \"/run/*\", \"/srv/*\",\n    \"/tmp/*\", \"/var/tmp/*\", \"/var/log/*\", \"/opt/*\"\n    ) and process.args_count == 1\n  )\n) and \nnot (\n  process.parent.args == \"--force\" or\n  process.args in (\"/usr/games/lolcat\", \"/usr/bin/screenfetch\") or\n  process.parent.name == \"system-crash-notification\"\n)",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "Linux Clipboard Activity Detected",
        "description": "This rule monitors for the usage of the most common clipboard utilities on unix systems by an uncommon process group leader. Adversaries may collect data stored in the clipboard from users copying information within or between applications.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 5,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Collection",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame",
          "Data Source: Auditd Manager"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0009",
              "name": "Collection",
              "reference": "https://attack.mitre.org/tactics/TA0009/"
            },
            "technique": [
              {
                "id": "T1115",
                "name": "Clipboard Data",
                "reference": "https://attack.mitre.org/techniques/T1115/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "auditd_manager",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "bbeff3b1-4bba-4801-ad7a-9cdbbc0ebd72",
        "rule_id": "884e87cc-c67b-4c90-a4ed-e1e24a940c82",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:14.613Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:17.205Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "event.category:process and host.os.type:\"linux\" and event.type:\"start\" and\nevent.action:(\"exec\" or \"exec_event\" or \"executed\" or \"process_started\") and\nprocess.name:(\"xclip\" or \"xsel\" or \"wl-clipboard\" or \"clipman\" or \"copyq\") and\nnot process.parent.name:(\"bwrap\" or \"micro\")",
        "new_terms_fields": [
          "host.id",
          "process.group_leader.executable"
        ],
        "history_window_start": "now-7d",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*",
          "auditbeat-*",
          "logs-auditd_manager.auditd-*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "SUID/SGUID Enumeration Detected",
        "description": "This rule monitors for the usage of the \"find\" command in conjunction with SUID and SGUID permission arguments. SUID (Set User ID) and SGID (Set Group ID) are special permissions in Linux that allow a program to execute with the privileges of the file owner or group, respectively, rather than the privileges of the user running the program. In case an attacker is able to enumerate and find a binary that is misconfigured, they might be able to leverage this misconfiguration to escalate privileges by exploiting vulnerabilities or built-in features in the privileged program.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 6,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Tactic: Privilege Escalation",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/security-labs/primer-on-persistence-mechanisms"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1083",
                "name": "File and Directory Discovery",
                "reference": "https://attack.mitre.org/techniques/T1083/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1548",
                "name": "Abuse Elevation Control Mechanism",
                "reference": "https://attack.mitre.org/techniques/T1548/",
                "subtechnique": [
                  {
                    "id": "T1548.001",
                    "name": "Setuid and Setgid",
                    "reference": "https://attack.mitre.org/techniques/T1548/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            }
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "group.Ext.real.id",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args_count",
            "type": "long",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.Ext.real.id",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "a0d67f94-c486-47ec-b44b-d75786f1f9a1",
        "rule_id": "5b06a27f-ad72-4499-91db-0c69667bffa5",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:14.616Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:17.177Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and \nprocess.name == \"find\" and process.args : \"-perm\" and process.args : (\n  \"/6000\", \"-6000\", \"/4000\", \"-4000\", \"/2000\", \"-2000\", \"/u=s\", \"-u=s\", \"/g=s\", \"-g=s\", \"/u=s,g=s\", \"/g=s,u=s\"\n) and not (\n  user.Ext.real.id == \"0\" or group.Ext.real.id == \"0\" or process.args_count >= 12 or \n  (process.args : \"/usr/bin/pkexec\" and process.args : \"-xdev\" and process.args_count == 7)\n)",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious Symbolic Link Created",
        "description": "Identifies the creation of a symbolic link to a suspicious file or location. A symbolic link is a reference to a file or directory that acts as a pointer or shortcut, allowing users to access the target file or directory from a different location in the file system. An attacker can potentially leverage symbolic links for privilege escalation by tricking a privileged process into following the symbolic link to a sensitive file, giving the attacker access to data or capabilities they would not normally have.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 6,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Tactic: Credential Access",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1548",
                "name": "Abuse Elevation Control Mechanism",
                "reference": "https://attack.mitre.org/techniques/T1548/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1003",
                "name": "OS Credential Dumping",
                "reference": "https://attack.mitre.org/techniques/T1003/",
                "subtechnique": [
                  {
                    "id": "T1003.008",
                    "name": "/etc/passwd and /etc/shadow",
                    "reference": "https://attack.mitre.org/techniques/T1003/008/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "group.Ext.real.id",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.working_directory",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.Ext.real.id",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "fb64490b-b590-4120-8ca0-8ebf0a6897bf",
        "rule_id": "8a024633-c444-45c0-a4fe-78128d8c1ab6",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:14.625Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:17.212Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\nprocess.name == \"ln\" and process.args in (\"-s\", \"-sf\") and \n  (\n    /* suspicious files */\n    (process.args in (\"/etc/shadow\", \"/etc/shadow-\", \"/etc/shadow~\", \"/etc/gshadow\", \"/etc/gshadow-\") or \n    (process.working_directory == \"/etc\" and process.args in (\"shadow\", \"shadow-\", \"shadow~\", \"gshadow\", \"gshadow-\"))) or \n    \n    /* suspicious bins */\n    (process.args in (\"/bin/bash\", \"/bin/dash\", \"/bin/sh\", \"/bin/tcsh\", \"/bin/csh\", \"/bin/zsh\", \"/bin/ksh\", \"/bin/fish\") or \n    (process.working_directory == \"/bin\" and process.args : (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\"))) or \n    (process.args in (\"/usr/bin/bash\", \"/usr/bin/dash\", \"/usr/bin/sh\", \"/usr/bin/tcsh\", \"/usr/bin/csh\", \"/usr/bin/zsh\", \"/usr/bin/ksh\", \"/usr/bin/fish\") or \n    (process.working_directory == \"/usr/bin\" and process.args in (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\"))) or\n    \n    /* suspicious locations */\n    (process.args : (\"/etc/cron.d/*\", \"/etc/cron.daily/*\", \"/etc/cron.hourly/*\", \"/etc/cron.weekly/*\", \"/etc/cron.monthly/*\")) or\n    (process.args : (\"/home/*/.ssh/*\", \"/root/.ssh/*\",\"/etc/sudoers.d/*\", \"/dev/shm/*\"))\n  ) and \n  process.parent.name in (\"bash\", \"dash\", \"ash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\") and \n  not user.Ext.real.id == \"0\" and not group.Ext.real.id == \"0\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Potential Antimalware Scan Interface Bypass via PowerShell",
        "description": "Identifies the execution of PowerShell script with keywords related to different Antimalware Scan Interface (AMSI) bypasses. An adversary may attempt first to disable AMSI before executing further malicious powershell scripts to evade detection.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Potential Antimalware Scan Interface Bypass via PowerShell\n\nPowerShell is one of the main tools system administrators use for automation, report routines, and other tasks. This makes it available for use in various environments, and creates an attractive way for attackers to execute code.\n\nThe Windows Antimalware Scan Interface (AMSI) is a versatile interface standard that allows your applications and services to integrate with any antimalware product on a machine. AMSI integrates with multiple Windows components, ranging from User Account Control (UAC) to VBA macros and PowerShell.\n\nThis rule identifies scripts that contain methods and classes that can be abused to bypass AMSI.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Examine the script content that triggered the detection; look for suspicious DLL imports, collection or exfiltration capabilities, suspicious functions, encoded or compressed data, and other potentially malicious characteristics.\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Determine whether the script was executed and capture relevant information, such as arguments that reveal intent or are indicators of compromise (IoCs).\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate commands and scripts executed after this activity was observed.\n- Inspect the host for suspicious or abnormal behavior in the alert timeframe:\n  - Observe and collect information about the following activities in the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Restrict PowerShell usage outside of IT and engineering business units using GPOs, AppLocker, Intune, or similar software.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 110,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: PowerShell Logs",
          "Resources: Investigation Guide"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/S3cur3Th1sSh1t/Amsi-Bypass-Powershell"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.001",
                    "name": "Disable or Modify Tools",
                    "reference": "https://attack.mitre.org/techniques/T1562/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "powershell.file.script_block_text",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "4ce1d5a9-970e-4a7e-890f-351f46b7adff",
        "rule_id": "1f0a69c0-3392-4adf-b7d5-6012fd292da8",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:14.633Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:04.059Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-windows.powershell*"
        ],
        "filters": [],
        "query": "event.category:\"process\" and host.os.type:windows and\n  (\n    powershell.file.script_block_text : (\n      \"System.Management.Automation.AmsiUtils\" or\n\t\t\tamsiInitFailed or \n\t\t\t\"Invoke-AmsiBypass\" or \n\t\t\t\"Bypass.AMSI\" or \n\t\t\t\"amsi.dll\" or \n\t\t\tAntimalwareProvider  or \n\t\t\tamsiSession or \n\t\t\tamsiContext or\n\t\t\tAmsiInitialize or \n\t\t\tunloadobfuscated or \n\t\t\tunloadsilent or \n\t\t\tAmsiX64 or \n\t\t\tAmsiX32 or \n\t\t\tFindAmsiFun\n    ) or\n    powershell.file.script_block_text:(\"[System.Runtime.InteropServices.Marshal]::Copy\" and \"VirtualProtect\") or\n    powershell.file.script_block_text:(\"[Ref].Assembly.GetType(('System.Management.Automation\" and \".SetValue(\")\n  ) and\n  not powershell.file.script_block_text : (\n    \"sentinelbreakpoints\" and \"Set-PSBreakpoint\"\n  )",
        "language": "kuery"
      },
      {
        "name": "PowerShell Script with Archive Compression Capabilities",
        "description": "Identifies the use of Cmdlets and methods related to archive compression activities. Adversaries will often compress and encrypt data in preparation for exfiltration.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 208,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Collection",
          "Data Source: PowerShell Logs",
          "Rule Type: BBR"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0009",
              "name": "Collection",
              "reference": "https://attack.mitre.org/tactics/TA0009/"
            },
            "technique": [
              {
                "id": "T1560",
                "name": "Archive Collected Data",
                "reference": "https://attack.mitre.org/techniques/T1560/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'PowerShell Script Block Logging' logging policy must be enabled.\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nAdministrative Templates >\nWindows PowerShell >\nTurn on PowerShell Script Block Logging (Enable)\n```\n\nSteps to implement the logging policy via registry:\n\n```\nreg add \"hklm\\SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\ScriptBlockLogging\" /v EnableScriptBlockLogging /t REG_DWORD /d 1\n```\n",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.directory",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "powershell.file.script_block_text",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "db2abaaa-13fe-4bbb-857f-51806915bca6",
        "rule_id": "27071ea3-e806-4697-8abc-e22c92aa4293",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:14.908Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:16.405Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-windows.powershell*"
        ],
        "filters": [
          {
            "meta": {
              "negate": true
            },
            "query": {
              "wildcard": {
                "file.path": {
                  "case_insensitive": true,
                  "value": "?:\\\\ProgramData\\\\Microsoft\\\\Windows Defender Advanced Threat Protection\\\\Downloads\\\\*"
                }
              }
            }
          },
          {
            "meta": {
              "negate": true
            },
            "query": {
              "wildcard": {
                "file.path": {
                  "case_insensitive": true,
                  "value": "?:\\\\ProgramData\\\\Microsoft\\\\Windows Defender Advanced Threat Protection\\\\DataCollection\\\\*"
                }
              }
            }
          },
          {
            "meta": {
              "negate": true
            },
            "query": {
              "wildcard": {
                "file.path": {
                  "case_insensitive": true,
                  "value": "?:\\\\Program Files\\\\WindowsPowerShell\\\\Modules\\\\dbatools\\\\*\\\\optional\\\\Expand-Archive.ps1"
                }
              }
            }
          },
          {
            "meta": {
              "negate": true
            },
            "query": {
              "wildcard": {
                "file.path": {
                  "case_insensitive": true,
                  "value": "?:\\\\Program Files\\\\WindowsPowerShell\\\\Modules\\\\dbatools\\\\*\\\\optional\\\\Compress-Archive.ps1"
                }
              }
            }
          },
          {
            "meta": {
              "negate": true
            },
            "query": {
              "wildcard": {
                "file.path": {
                  "case_insensitive": true,
                  "value": "?:\\\\Program Files\\\\Azure\\\\StorageSyncAgent\\\\AFSDiag.ps1"
                }
              }
            }
          }
        ],
        "query": "event.category:process and host.os.type:windows and\n(\n  powershell.file.script_block_text : (\n    \"IO.Compression.ZipFile\" or\n    \"IO.Compression.ZipArchive\" or\n    \"ZipFile.CreateFromDirectory\" or\n    \"IO.Compression.BrotliStream\" or\n    \"IO.Compression.DeflateStream\" or\n    \"IO.Compression.GZipStream\" or\n    \"IO.Compression.ZLibStream\"\n  ) and \n  powershell.file.script_block_text : (\n    \"CompressionLevel\" or\n    \"CompressionMode\" or\n    \"ZipArchiveMode\"\n  ) or\n  powershell.file.script_block_text : \"Compress-Archive\"\n) and\nnot powershell.file.script_block_text : (\n  \"Compress-Archive -Path 'C:\\ProgramData\\Lenovo\\Udc\\diagnostics\\latest\" or\n  (\"Copyright: (c) 2017, Ansible Project\" and \"Ansible.ModuleUtils.Backup\")\n) and\nnot file.directory : \"C:\\Program Files\\Microsoft Dependency Agent\\plugins\\lib\"",
        "language": "kuery"
      },
      {
        "name": "PowerShell Script with Encryption/Decryption Capabilities",
        "description": "Identifies the use of Cmdlets and methods related to encryption/decryption of files in PowerShell scripts, which malware and offensive security tools can abuse to encrypt data or decrypt payloads to bypass security solutions.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating PowerShell Script with Encryption/Decryption Capabilities\n\nPowerShell is one of the main tools system administrators use for automation, report routines, and other tasks, making it available for use in various environments, creating an attractive way for attackers to execute code.\n\nPowerShell offers encryption and decryption functionalities that attackers can abuse for various purposes, such as concealing payloads, C2 communications, and encrypting data as part of ransomware operations.\n\n#### Possible investigation steps\n\n- Examine the script content that triggered the detection; look for suspicious DLL imports, collection or exfiltration capabilities, suspicious functions, encoded or compressed data, and other potentially malicious characteristics.\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Examine file or network events from the involved PowerShell process for suspicious behavior.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Evaluate whether the user needs to use PowerShell to complete tasks.\n\n### False positive analysis\n\n- This is a dual-use mechanism, meaning its usage is not inherently malicious. Analysts can dismiss the alert if the script doesn't contain malicious functions or potential for abuse, no other suspicious activity was identified, and there are justifications for the execution.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Restrict PowerShell usage outside of IT and engineering business units using GPOs, AppLocker, Intune, or similar software.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 109,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: PowerShell Logs",
          "Resources: Investigation Guide"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Legitimate PowerShell Scripts which makes use of encryption."
        ],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1027",
                "name": "Obfuscated Files or Information",
                "reference": "https://attack.mitre.org/techniques/T1027/"
              },
              {
                "id": "T1140",
                "name": "Deobfuscate/Decode Files or Information",
                "reference": "https://attack.mitre.org/techniques/T1140/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "powershell.file.script_block_text",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "ba05ad39-54cd-40a6-a345-0c4bfd33663f",
        "rule_id": "1d9aeb0b-9549-46f6-a32d-05e2a001b7fd",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:14.919Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:04.082Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-windows.powershell*"
        ],
        "filters": [],
        "query": "event.category:process and host.os.type:windows and\n  powershell.file.script_block_text : (\n    (\n      \"Cryptography.AESManaged\" or\n      \"Cryptography.RijndaelManaged\" or\n      \"Cryptography.SHA1Managed\" or\n      \"Cryptography.SHA256Managed\" or\n      \"Cryptography.SHA384Managed\" or\n      \"Cryptography.SHA512Managed\" or\n      \"Cryptography.SymmetricAlgorithm\" or\n      \"PasswordDeriveBytes\" or\n      \"Rfc2898DeriveBytes\"\n    ) and\n    (\n      CipherMode and PaddingMode\n    ) and\n    (\n      \".CreateEncryptor\" or\n      \".CreateDecryptor\"\n    )\n  ) and\n  not user.id : \"S-1-5-18\" and\n  not (\n    file.name : \"Bootstrap.Octopus.FunctionAppenderContext.ps1\" and\n    powershell.file.script_block_text : (\"function Decrypt-Variables\" or \"github.com/OctopusDeploy\")\n  )",
        "language": "kuery"
      },
      {
        "name": "PowerShell Suspicious Script with Audio Capture Capabilities",
        "description": "Detects PowerShell scripts that can record audio, a common feature in popular post-exploitation tooling.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating PowerShell Suspicious Script with Audio Capture Capabilities\n\nPowerShell is one of the main tools system administrators use for automation, report routines, and other tasks. This makes it available for use in various environments, and creates an attractive way for attackers to execute code.\n\nAttackers can use PowerShell to interact with the Windows API with the intent of capturing audio from input devices connected to the victim's computer.\n\n#### Possible investigation steps\n\n- Examine the script content that triggered the detection; look for suspicious DLL imports, collection or exfiltration capabilities, suspicious functions, encoded or compressed data, and other potentially malicious characteristics.\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Examine file or network events from the involved PowerShell process for suspicious behavior.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Evaluate whether the user needs to use PowerShell to complete tasks.\n- Investigate if the script stores the recorded data locally and determine if anything was recorded.\n- Investigate whether the script contains exfiltration capabilities and identify the exfiltration server.\n- Assess network data to determine if the host communicated with the exfiltration server.\n\n### False positive analysis\n\n- Regular users should not need scripts to capture audio, which makes false positives unlikely. In the case of authorized benign true positives (B-TPs), exceptions can be added.\n\n### Related rules\n\n- PowerShell PSReflect Script - 56f2e9b5-4803-4e44-a0a4-a52dc79d57fe\n- Potential Process Injection via PowerShell - 2e29e96a-b67c-455a-afe4-de6183431d0d\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Prioritize the response if this alert involves key executives or potentially valuable targets for espionage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Restrict PowerShell usage outside of IT and engineering business units using GPOs, AppLocker, Intune, or similar software.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 212,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Collection",
          "Resources: Investigation Guide",
          "Data Source: PowerShell Logs"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/PowerShellMafia/PowerSploit/blob/master/Exfiltration/Get-MicrophoneAudio.ps1"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0009",
              "name": "Collection",
              "reference": "https://attack.mitre.org/tactics/TA0009/"
            },
            "technique": [
              {
                "id": "T1123",
                "name": "Audio Capture",
                "reference": "https://attack.mitre.org/techniques/T1123/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              },
              {
                "id": "T1106",
                "name": "Native API",
                "reference": "https://attack.mitre.org/techniques/T1106/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'PowerShell Script Block Logging' logging policy must be enabled.\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nAdministrative Templates >\nWindows PowerShell >\nTurn on PowerShell Script Block Logging (Enable)\n```\n\nSteps to implement the logging policy via registry:\n\n```\nreg add \"hklm\\SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\ScriptBlockLogging\" /v EnableScriptBlockLogging /t REG_DWORD /d 1\n```\n",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "powershell.file.script_block_text",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "b74bb9a1-8f3e-4e52-bc00-abd6baf426cf",
        "rule_id": "2f2f4939-0b34-40c2-a0a3-844eb7889f43",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:14.933Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:05.881Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-windows.powershell*"
        ],
        "filters": [],
        "query": "event.category:process and host.os.type:windows and\n  powershell.file.script_block_text : (\n    \"Get-MicrophoneAudio\" or\n    \"WindowsAudioDevice-Powershell-Cmdlet\" or\n    (waveInGetNumDevs and mciSendStringA)\n  )\n  and not powershell.file.script_block_text : (\n    \"sentinelbreakpoints\" and \"Set-PSBreakpoint\" and \"PowerSploitIndicators\"\n  )\n  and not user.id : \"S-1-5-18\"",
        "language": "kuery"
      },
      {
        "name": "Okta Brute Force or Password Spraying Attack",
        "description": "Identifies a high number of failed Okta user authentication attempts from a single IP address, which could be indicative of a brute force or password spraying attack. An adversary may attempt a brute force or password spraying attack to obtain unauthorized access to user accounts.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Okta Brute Force or Password Spraying Attack\n\nThis rule alerts when a high number of failed Okta user authentication attempts occur from a single IP address. This could be indicative of a brute force or password spraying attack, where an adversary may attempt to gain unauthorized access to user accounts by guessing the passwords.\n\n#### Possible investigation steps:\n\n- Review the `source.ip` field to identify the IP address from which the high volume of failed login attempts originated.\n- Look into the `event.outcome` field to verify that these are indeed failed authentication attempts.\n- Determine the `user.name` or `user.email` related to these failed login attempts. If the attempts are spread across multiple accounts, it might indicate a password spraying attack.\n- Check the timeline of the events. Are the failed attempts spread out evenly, or are there burst periods, which might indicate an automated tool?\n- Determine the geographical location of the source IP. Is this location consistent with the user's typical login location?\n- Analyze any previous successful logins from this IP. Was this IP previously associated with successful logins?\n\n### False positive analysis:\n\n- A single user or automated process that attempts to authenticate using expired or wrong credentials multiple times may trigger a false positive.\n- Analyze the behavior of the source IP. If the IP is associated with legitimate users or services, it may be a false positive.\n\n### Response and remediation:\n\n- If you identify unauthorized access attempts, consider blocking the source IP at the firewall level.\n- Notify the users who are targeted by the attack. Ask them to change their passwords and ensure they use unique, complex passwords.\n- Enhance monitoring on the affected user accounts for any suspicious activity.\n- If the attack is persistent, consider implementing CAPTCHA or account lockouts after a certain number of failed login attempts.\n- If the attack is persistent, consider implementing multi-factor authentication (MFA) for the affected user accounts.\n- Review and update your security policies based on the findings from the incident.",
        "output_index": "",
        "version": 412,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Data Source: Okta",
          "Tactic: Credential Access"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Automated processes that attempt to authenticate using expired credentials and unbounded retries may lead to false positives."
        ],
        "references": [
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1110",
                "name": "Brute Force",
                "reference": "https://attack.mitre.org/techniques/T1110/"
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "1a36ffd0-b42e-4edc-8df5-9f88edc25204",
        "rule_id": "42bf698b-4738-445b-8231-c834ddefd8a0",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:14.935Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:05.901Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "threshold",
        "query": "event.dataset:okta.system and event.category:authentication and event.outcome:failure",
        "threshold": {
          "field": [
            "source.ip"
          ],
          "value": 25
        },
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Potential Credential Access via DCSync",
        "description": "This rule identifies when a User Account starts the Active Directory Replication Process. Attackers can use the DCSync technique to get credential information of individual accounts or the entire domain, thus compromising the entire domain.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Potential Credential Access via DCSync\n\nActive Directory replication is the process by which the changes that originate on one domain controller are automatically transferred to other domain controllers that store the same data.\n\nActive Directory data consists of objects that have properties, or attributes. Each object is an instance of an object class, and object classes and their respective attributes are defined in the Active Directory schema. Objects are defined by the values of their attributes, and changes to attribute values must be transferred from the domain controller on which they occur to every other domain controller that stores a replica of an affected object.\n\nAdversaries can use the DCSync technique that uses Windows Domain Controller's API to simulate the replication process from a remote domain controller, compromising major credential material such as the Kerberos krbtgt keys used legitimately for tickets creation, but also tickets forging by attackers. This attack requires some extended privileges to succeed (DS-Replication-Get-Changes and DS-Replication-Get-Changes-All), which are granted by default to members of the Administrators, Domain Admins, Enterprise Admins, and Domain Controllers groups. Privileged accounts can be abused to grant controlled objects the right to DCsync/Replicate.\n\nMore details can be found on [Threat Hunter Playbook](https://threathunterplaybook.com/library/windows/active_directory_replication.html?highlight=dcsync#directory-replication-services-auditing) and [The Hacker Recipes](https://www.thehacker.recipes/ad/movement/credentials/dumping/dcsync).\n\nThis rule monitors for Event ID 4662 (Operation was performed on an Active Directory object) and identifies events that use the access mask 0x100 (Control Access) and properties that contain at least one of the following or their equivalent Schema-Id-GUID (DS-Replication-Get-Changes, DS-Replication-Get-Changes-All, DS-Replication-Get-Changes-In-Filtered-Set). It also filters out events that use computer accounts and also Azure AD Connect MSOL accounts (more details [here](https://techcommunity.microsoft.com/t5/microsoft-defender-for-identity/ad-connect-msol-user-suspected-dcsync-attack/m-p/788028)).\n\n#### Possible investigation steps\n\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account and system owners and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Correlate security events 4662 and 4624 (Logon Type 3) by their Logon ID (`winlog.logon.id`) on the Domain Controller (DC) that received the replication request. This will tell you where the AD replication request came from, and if it came from another DC or not.\n- Scope which credentials were compromised (for example, whether all accounts were replicated or specific ones).\n\n### False positive analysis\n\n- Administrators may use custom accounts on Azure AD Connect, investigate if it is the case, and if it is properly secured. If noisy in your environment due to expected activity, consider adding the corresponding account as a exception.\n- Although replicating Active Directory (AD) data to non-Domain Controllers is not a common practice and is generally not recommended from a security perspective, some software vendors may require it for their products to function correctly. If this rule is noisy in your environment due to expected activity, consider adding the corresponding account as a exception.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- If the entire domain or the `krbtgt` user was compromised:\n  - Activate your incident response plan for total Active Directory compromise which should include, but not be limited to, a password reset (twice) of the `krbtgt` user.\n- Investigate how the attacker escalated privileges and identify systems they used to conduct lateral movement. Use this information to determine ways the attacker could regain access to the environment.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 215,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Tactic: Privilege Escalation",
          "Data Source: Active Directory",
          "Resources: Investigation Guide",
          "Use Case: Active Directory Monitoring",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://threathunterplaybook.com/notebooks/windows/06_credential_access/WIN-180815210510.html",
          "https://threathunterplaybook.com/library/windows/active_directory_replication.html?highlight=dcsync#directory-replication-services-auditing",
          "https://github.com/SigmaHQ/sigma/blob/master/rules/windows/builtin/security/win_ad_replication_non_machine_account.yml",
          "https://github.com/atc-project/atomic-threat-coverage/blob/master/Atomic_Threat_Coverage/Logging_Policies/LP_0027_windows_audit_directory_service_access.md",
          "https://attack.stealthbits.com/privilege-escalation-using-mimikatz-dcsync",
          "https://www.thehacker.recipes/ad/movement/credentials/dumping/dcsync",
          "https://www.elastic.co/security-labs/siestagraph-new-implant-uncovered-in-asean-member-foreign-ministry"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1003",
                "name": "OS Credential Dumping",
                "reference": "https://attack.mitre.org/techniques/T1003/",
                "subtechnique": [
                  {
                    "id": "T1003.006",
                    "name": "DCSync",
                    "reference": "https://attack.mitre.org/techniques/T1003/006/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1078",
                "name": "Valid Accounts",
                "reference": "https://attack.mitre.org/techniques/T1078/",
                "subtechnique": [
                  {
                    "id": "T1078.002",
                    "name": "Domain Accounts",
                    "reference": "https://attack.mitre.org/techniques/T1078/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'Audit Directory Service Access' logging policy must be configured for (Success, Failure).\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nPolicies >\nWindows Settings >\nSecurity Settings >\nAdvanced Audit Policies Configuration >\nAudit Policies >\nDS Access >\nAudit Directory Service Access (Success,Failure)\n```\n",
        "related_integrations": [
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.code",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.event_data.AccessMask",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "winlog.event_data.Properties",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "winlog.event_data.SubjectUserName",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "731e3390-1e2e-482f-aa5e-9fc025dab41c",
        "rule_id": "9f962927-1a4f-45f3-a57b-287f2c7029c1",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:14.948Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:04.169Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "any where event.action : (\"Directory Service Access\", \"object-operation-performed\") and\n  event.code == \"4662\" and winlog.event_data.Properties : (\n\n    /* Control Access Rights/Permissions Symbol */\n\n    \"*DS-Replication-Get-Changes*\",\n    \"*DS-Replication-Get-Changes-All*\",\n    \"*DS-Replication-Get-Changes-In-Filtered-Set*\",\n\n    /* Identifying GUID used in ACE */\n\n    \"*1131f6ad-9c07-11d1-f79f-00c04fc2dcd2*\",\n    \"*1131f6aa-9c07-11d1-f79f-00c04fc2dcd2*\",\n    \"*89e95b76-444d-4c62-991a-0facbeda640c*\")\n\n    /* The right to perform an operation controlled by an extended access right. */\n\n    and winlog.event_data.AccessMask : \"0x100\" and\n    not winlog.event_data.SubjectUserName : (\n          \"*$\", \"MSOL_*\", \"OpenDNS_Connector\", \"adconnect\", \"SyncADConnect\",\n          \"SyncADConnectCM\", \"aadsync\", \"svcAzureADSync\", \"-\"\n        )\n\n    /* The Umbrella AD Connector uses the OpenDNS_Connector account to perform replication */",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-system.*",
          "logs-windows.*"
        ],
        "filters": []
      },
      {
        "name": "Threat Intel Hash Indicator Match",
        "description": "This rule is triggered when a hash indicator from the Threat Intel Filebeat module or integrations has a match against an event that contains file hashes, such as antivirus alerts, process creation, library load, and file operation events.",
        "risk_score": 99,
        "severity": "critical",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "timeline_id": "495ad7a7-316e-4544-8a0f-9c098daee76e",
        "timeline_title": "Generic Threat Match Timeline",
        "license": "Elastic License v2",
        "note": "## Triage and Analysis\n\n### Investigating Threat Intel Hash Indicator Match\n\nThreat Intel indicator match rules allow matching from a local observation, such as an endpoint event that records a file hash with an entry of a file hash stored within the Threat Intel integrations index.\n\nMatches are based on threat intelligence data that's been ingested during the last 30 days. Some integrations don't place expiration dates on their threat indicators, so we strongly recommend validating ingested threat indicators and reviewing match results. When reviewing match results, check associated activity to determine whether the event requires additional investigation.\n\nThis rule is triggered when a hash indicator from the Threat Intel Filebeat module or an indicator ingested from a threat intelligence integration matches against an event that contains file hashes, such as antivirus alerts, file operation events, etc.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Gain context about the field that matched the local observation. This information can be found in the `threat.indicator.matched.field` field.\n- Investigate the hash , which can be found in the `threat.indicator.matched.atomic` field:\n  - Search for the existence and reputation of the hash in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n  - Scope other potentially compromised hosts in your environment by mapping hosts with file operations involving the same hash.\n- Identify the process that created the file.\n  - Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n  - Enrich the information that you have right now by determining how the file was dropped, where it was downloaded from, etc. This can help you determine if the event is part of an ongoing campaign against the organization.\n- Retrieve the involved file and examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the process executable using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n- Using the data collected through the analysis, scope users targeted and other machines infected in the environment.\n\n### False Positive Analysis\n\n- Adversaries often use legitimate tools as network administrators, such as `PsExec` or `AdFind`. These tools are often included in indicator lists, which creates the potential for false positives.\n\n### Response and Remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 8,
        "tags": [
          "OS: Windows",
          "Data Source: Elastic Endgame",
          "Rule Type: Threat Match"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "1h",
        "from": "now-3900s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-module-threatintel.html",
          "https://www.elastic.co/guide/en/security/master/es-threat-intel-integrations.html",
          "https://www.elastic.co/security/tip"
        ],
        "max_signals": 100,
        "threat": [],
        "setup": "## Setup\n\nThis rule needs threat intelligence indicators to work.\nThreat intelligence indicators can be collected using an [Elastic Agent integration](https://www.elastic.co/guide/en/security/current/es-threat-intel-integrations.html#agent-ti-integration),\nthe [Threat Intel module](https://www.elastic.co/guide/en/security/current/es-threat-intel-integrations.html#ti-mod-integration),\nor a [custom integration](https://www.elastic.co/guide/en/security/current/es-threat-intel-integrations.html#custom-ti-integration).\n\nMore information can be found [here](https://www.elastic.co/guide/en/security/current/es-threat-intel-integrations.html).\n",
        "related_integrations": [],
        "required_fields": [
          {
            "name": "dll.hash.*",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "file.hash.*",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "process.hash.*",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "e931d96b-4976-4294-995d-840660d87bb6",
        "rule_id": "aab184d3-72b3-4639-b242-6597c99d8bca",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:14.956Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:14.927Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "threat_match",
        "query": "file.hash.*:* or process.hash.*:* or dll.hash.*:*",
        "threat_query": "@timestamp >= \"now-30d/d\" and event.module:(threatintel or ti_*) and (threat.indicator.file.hash.*:* or threat.indicator.file.pe.imphash:*) and not labels.is_ioc_transform_source:\"true\"",
        "threat_mapping": [
          {
            "entries": [
              {
                "field": "file.hash.md5",
                "type": "mapping",
                "value": "threat.indicator.file.hash.md5"
              }
            ]
          },
          {
            "entries": [
              {
                "field": "file.hash.sha1",
                "type": "mapping",
                "value": "threat.indicator.file.hash.sha1"
              }
            ]
          },
          {
            "entries": [
              {
                "field": "file.hash.sha256",
                "type": "mapping",
                "value": "threat.indicator.file.hash.sha256"
              }
            ]
          },
          {
            "entries": [
              {
                "field": "dll.hash.md5",
                "type": "mapping",
                "value": "threat.indicator.file.hash.md5"
              }
            ]
          },
          {
            "entries": [
              {
                "field": "dll.hash.sha1",
                "type": "mapping",
                "value": "threat.indicator.file.hash.sha1"
              }
            ]
          },
          {
            "entries": [
              {
                "field": "dll.hash.sha256",
                "type": "mapping",
                "value": "threat.indicator.file.hash.sha256"
              }
            ]
          },
          {
            "entries": [
              {
                "field": "process.hash.md5",
                "type": "mapping",
                "value": "threat.indicator.file.hash.md5"
              }
            ]
          },
          {
            "entries": [
              {
                "field": "process.hash.sha1",
                "type": "mapping",
                "value": "threat.indicator.file.hash.sha1"
              }
            ]
          },
          {
            "entries": [
              {
                "field": "process.hash.sha256",
                "type": "mapping",
                "value": "threat.indicator.file.hash.sha256"
              }
            ]
          }
        ],
        "threat_index": [
          "filebeat-*",
          "logs-ti_*"
        ],
        "index": [
          "auditbeat-*",
          "endgame-*",
          "filebeat-*",
          "logs-*",
          "winlogbeat-*"
        ],
        "filters": [],
        "threat_filters": [
          {
            "$state": {
              "store": "appState"
            },
            "meta": {
              "disabled": false,
              "key": "event.category",
              "negate": false,
              "params": {
                "query": "threat"
              },
              "type": "phrase"
            },
            "query": {
              "match_phrase": {
                "event.category": "threat"
              }
            }
          },
          {
            "$state": {
              "store": "appState"
            },
            "meta": {
              "disabled": false,
              "key": "event.kind",
              "negate": false,
              "params": {
                "query": "enrichment"
              },
              "type": "phrase"
            },
            "query": {
              "match_phrase": {
                "event.kind": "enrichment"
              }
            }
          },
          {
            "$state": {
              "store": "appState"
            },
            "meta": {
              "disabled": false,
              "key": "event.type",
              "negate": false,
              "params": {
                "query": "indicator"
              },
              "type": "phrase"
            },
            "query": {
              "match_phrase": {
                "event.type": "indicator"
              }
            }
          }
        ],
        "threat_indicator_path": "threat.indicator",
        "threat_language": "kuery",
        "language": "kuery"
      },
      {
        "name": "Attempt to Deactivate an Okta Policy",
        "description": "Detects attempts to deactivate an Okta policy. An adversary may attempt to deactivate an Okta policy in order to weaken an organization's security controls. For example, an adversary may attempt to deactivate an Okta multi-factor authentication (MFA) policy in order to weaken the authentication requirements for user accounts.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Attempt to Deactivate an Okta Policy\n\nOkta policies define rules to manage user access to resources. Policies such as multi-factor authentication (MFA) are critical for enforcing strong security measures. Deactivation of an Okta policy could potentially weaken the security posture, allowing for unauthorized access or facilitating other malicious activities.\n\nThis rule is designed to detect attempts to deactivate an Okta policy, which could be indicative of an adversary's attempt to weaken an organization's security controls. For example, disabling an MFA policy could lower the security of user authentication processes.\n\n#### Possible investigation steps:\n\n- Identify the actor related to the alert by reviewing `okta.actor.id`, `okta.actor.type`, `okta.actor.alternate_id`, or `okta.actor.display_name` fields in the alert.\n- Review the `okta.client.user_agent.raw_user_agent` field to understand the device and software used by the actor.\n- Examine the `okta.outcome.reason` field for additional context around the deactivation attempt.\n- Check the `okta.outcome.result` field to confirm the policy deactivation attempt.\n- Check if there are multiple policy deactivation attempts from the same actor or IP address (`okta.client.ip`).\n- Check for successful logins immediately following the policy deactivation attempt.\n- Verify whether the actor's activity aligns with typical behavior or if any unusual activity took place around the time of the deactivation attempt.\n\n### False positive analysis:\n\n- Check if there were issues with the Okta system at the time of the deactivation attempt. This could indicate a system error rather than a genuine threat activity.\n- Check the geographical location (`okta.request.ip_chain.geographical_context`) and time of the deactivation attempt. If these match the actor's normal behavior, it might be a false positive.\n- Verify the actor's administrative rights to ensure they are correctly configured.\n\n### Response and remediation:\n\n- If unauthorized policy deactivation is confirmed, initiate the incident response process.\n- Immediately lock the affected actor account and require a password change.\n- Consider resetting MFA tokens for the actor and require re-enrollment.\n- Check if the compromised account was used to access or alter any sensitive data or systems.\n- If a specific deactivation technique was used, ensure your systems are patched or configured to prevent such techniques.\n- Assess the criticality of affected services and servers.\n- Work with your IT team to minimize the impact on users and maintain business continuity.\n- If multiple accounts are affected, consider a broader reset or audit of MFA tokens.\n- Implement security best practices [outlined](https://www.okta.com/blog/2019/10/9-admin-best-practices-to-keep-your-org-secure/) by Okta.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).",
        "output_index": "",
        "version": 410,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Data Source: Okta",
          "Tactic: Defense Evasion"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "If the behavior of deactivating Okta policies is expected, consider adding exceptions to this rule to filter false positives."
        ],
        "references": [
          "https://help.okta.com/en/prod/Content/Topics/Security/Security_Policies.htm",
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.007",
                    "name": "Disable or Modify Cloud Firewall",
                    "reference": "https://attack.mitre.org/techniques/T1562/007/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "53ee8fbf-1727-4abd-818f-bcaee8bb6b4e",
        "rule_id": "b719a170-3bdb-4141-b0e3-13e3cf627bfe",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:14.958Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:06.973Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset:okta.system and event.action:policy.lifecycle.deactivate",
        "language": "kuery"
      },
      {
        "name": "Attempt to Delete an Okta Policy",
        "description": "Detects attempts to delete an Okta policy. An adversary may attempt to delete an Okta policy in order to weaken an organization's security controls. For example, an adversary may attempt to delete an Okta multi-factor authentication (MFA) policy in order to weaken the authentication requirements for user accounts.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Attempt to Delete an Okta Policy\n\nOkta policies are critical to managing user access and enforcing security controls within an organization. The deletion of an Okta policy could drastically weaken an organization's security posture by allowing unrestricted access or facilitating other malicious activities.\n\nThis rule detects attempts to delete an Okta policy, which could be indicative of an adversary's attempt to weaken an organization's security controls. Adversaries may do this to bypass security barriers and enable further malicious activities.\n\n#### Possible investigation steps:\n\n- Identify the actor related to the alert by reviewing `okta.actor.id`, `okta.actor.type`, `okta.actor.alternate_id`, or `okta.actor.display_name` fields in the alert.\n- Review the `okta.client.user_agent.raw_user_agent` field to understand the device and software used by the actor.\n- Examine the `okta.outcome.reason` field for additional context around the deletion attempt.\n- Check the `okta.outcome.result` field to confirm the policy deletion attempt.\n- Check if there are multiple policy deletion attempts from the same actor or IP address (`okta.client.ip`).\n- Check for successful logins immediately following the policy deletion attempt.\n- Verify whether the actor's activity aligns with typical behavior or if any unusual activity took place around the time of the deletion attempt.\n\n### False positive analysis:\n\n- Check if there were issues with the Okta system at the time of the deletion attempt. This could indicate a system error rather than a genuine threat activity.\n- Check the geographical location (`okta.request.ip_chain.geographical_context`) and time of the deletion attempt. If these match the actor's normal behavior, it might be a false positive.\n- Verify the actor's administrative rights to ensure they are correctly configured.\n\n### Response and remediation:\n\n- If unauthorized policy deletion is confirmed, initiate the incident response process.\n- Immediately lock the affected actor account and require a password change.\n- Consider resetting MFA tokens for the actor and require re-enrollment.\n- Check if the compromised account was used to access or alter any sensitive data or systems.\n- If a specific deletion technique was used, ensure your systems are patched or configured to prevent such techniques.\n- Assess the criticality of affected services and servers.\n- Work with your IT team to minimize the impact on users and maintain business continuity.\n- If multiple accounts are affected, consider a broader reset or audit of MFA tokens.\n- Implement security best practices [outlined](https://www.okta.com/blog/2019/10/9-admin-best-practices-to-keep-your-org-secure/) by Okta.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).",
        "output_index": "",
        "version": 410,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Data Source: Okta",
          "Tactic: Defense Evasion"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Consider adding exceptions to this rule to filter false positives if Okta policies are regularly deleted in your organization."
        ],
        "references": [
          "https://help.okta.com/en/prod/Content/Topics/Security/Security_Policies.htm",
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.007",
                    "name": "Disable or Modify Cloud Firewall",
                    "reference": "https://attack.mitre.org/techniques/T1562/007/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "22c510f9-009b-47a3-97c6-fa58e5187fd7",
        "rule_id": "b4bb1440-0fcb-4ed1-87e5-b06d58efc5e9",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:14.963Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:06.965Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset:okta.system and event.action:policy.lifecycle.delete",
        "language": "kuery"
      },
      {
        "name": "PowerShell Script with Log Clear Capabilities",
        "description": "Identifies the use of Cmdlets and methods related to Windows event log deletion activities. This is often done by attackers in an attempt to evade detection or destroy forensic evidence on a system.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 208,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: PowerShell Logs",
          "Rule Type: BBR"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://learn.microsoft.com/en-us/dotnet/api/system.diagnostics.eventlog.clear",
          "https://learn.microsoft.com/en-us/dotnet/api/system.diagnostics.eventing.reader.eventlogsession.clearlog"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1070",
                "name": "Indicator Removal",
                "reference": "https://attack.mitre.org/techniques/T1070/",
                "subtechnique": [
                  {
                    "id": "T1070.001",
                    "name": "Clear Windows Event Logs",
                    "reference": "https://attack.mitre.org/techniques/T1070/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'PowerShell Script Block Logging' logging policy must be enabled.\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nAdministrative Templates >\nWindows PowerShell >\nTurn on PowerShell Script Block Logging (Enable)\n```\n\nSteps to implement the logging policy via registry:\n\n```\nreg add \"hklm\\SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\ScriptBlockLogging\" /v EnableScriptBlockLogging /t REG_DWORD /d 1\n```\n",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.directory",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "powershell.file.script_block_text",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "be23c856-58f3-4037-b5a7-2bb6c8039fdf",
        "rule_id": "3d3aa8f9-12af-441f-9344-9f31053e316d",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:14.968Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:16.417Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-windows.powershell*"
        ],
        "filters": [
          {
            "meta": {
              "negate": true
            },
            "query": {
              "wildcard": {
                "file.path": {
                  "case_insensitive": true,
                  "value": "?:\\\\Windows\\\\system32\\\\WindowsPowerShell\\\\v1.0\\\\Modules\\\\Microsoft.PowerShell.Management\\\\*.psd1"
                }
              }
            }
          },
          {
            "meta": {
              "negate": true
            },
            "query": {
              "wildcard": {
                "file.path": {
                  "case_insensitive": true,
                  "value": "?:\\\\Program Files\\\\Microsoft Monitoring Agent\\\\Agent\\\\Health Service State\\\\Resources\\\\*\\\\M365Library.ps1"
                }
              }
            }
          }
        ],
        "query": "event.category:process and host.os.type:windows and\n  powershell.file.script_block_text : (\n    \"Clear-EventLog\" or\n    \"Remove-EventLog\" or\n    (\"Eventing.Reader.EventLogSession\" and \".ClearLog\") or\n    (\"Diagnostics.EventLog\" and \".Clear\")\n  ) and\n  not powershell.file.script_block_text : (\n    \"CmdletsToExport=@(\\\"Add-Content\\\"\"\n  ) and\n  not file.directory : \"C:\\Program Files\\WindowsAdminCenter\\PowerShellModules\\Microsoft.WindowsAdminCenter.Configuration\"",
        "language": "kuery"
      },
      {
        "name": "Potential Network Share Discovery",
        "description": "Adversaries may look for folders and drives shared on remote systems to identify sources of information to gather as a precursor for collection and identify potential systems of interest for Lateral Movement.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 106,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Tactic: Collection",
          "Rule Type: BBR",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1135",
                "name": "Network Share Discovery",
                "reference": "https://attack.mitre.org/techniques/T1135/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0009",
              "name": "Collection",
              "reference": "https://attack.mitre.org/tactics/TA0009/"
            },
            "technique": [
              {
                "id": "T1039",
                "name": "Data from Network Shared Drive",
                "reference": "https://attack.mitre.org/techniques/T1039/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "source.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "source.port",
            "type": "long",
            "ecs": true
          },
          {
            "name": "user.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.event_data.ShareName",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "b636153a-1526-46b2-a7b4-466c98a3c87d",
        "rule_id": "b2318c71-5959-469a-a3ce-3a0768e63b9c",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:14.970Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:17.222Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by user.name, source.port, source.ip with maxspan=15s \n [file where event.action == \"network-share-object-access-checked\" and \n  winlog.event_data.ShareName in (\"\\\\\\\\*\\\\ADMIN$\", \"\\\\\\\\*\\\\C$\") and \n  source.ip != null and source.ip != \"0.0.0.0\" and source.ip != \"::1\" and source.ip != \"::\" and source.ip != \"127.0.0.1\"]\n [file where event.action == \"network-share-object-access-checked\" and \n  winlog.event_data.ShareName in (\"\\\\\\\\*\\\\ADMIN$\", \"\\\\\\\\*\\\\C$\") and \n  source.ip != null and source.ip != \"0.0.0.0\" and source.ip != \"::1\" and source.ip != \"::\" and source.ip != \"127.0.0.1\"]",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-windows.*",
          "logs-system.security*"
        ],
        "filters": []
      },
      {
        "name": "Attempted Bypass of Okta MFA",
        "description": "Detects attempts to bypass Okta multi-factor authentication (MFA). An adversary may attempt to bypass the Okta MFA policies configured for an organization in order to obtain unauthorized access to an application.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Attempted Bypass of Okta MFA\n\nMulti-factor authentication (MFA) is a crucial security measure in preventing unauthorized access. Okta MFA, like other MFA solutions, requires the user to provide multiple means of identification at login. An adversary might attempt to bypass Okta MFA to gain unauthorized access to an application.\n\nThis rule detects attempts to bypass Okta MFA. It might indicate a serious attempt to compromise a user account within the organization's network.\n\n#### Possible investigation steps\n\n- Identify the actor related to the alert by reviewing `okta.actor.id`, `okta.actor.type`, `okta.actor.alternate_id`, or `okta.actor.display_name` fields in the alert.\n- Review the `okta.client.user_agent.raw_user_agent` field to understand the device and software used by the actor.\n- Examine the `okta.outcome.reason` field for additional context around the bypass attempt.\n- Check the `okta.outcome.result` field to confirm the MFA bypass attempt.\n- Check if there are multiple unsuccessful MFA attempts from the same actor or IP address (`okta.client.ip`).\n- Check for successful logins immediately following the MFA bypass attempt.\n- Verify whether the actor's activity aligns with typical behavior or if any unusual activity took place around the time of the bypass attempt.\n\n### False positive analysis\n\n- Check if there were issues with the MFA system at the time of the bypass attempt. This could indicate a system error rather than a genuine bypass attempt.\n- Check the geographical location (`okta.request.ip_chain.geographical_context`) and time of the login attempt. If these match the actor's normal behavior, it might be a false positive.\n- Verify the actor's MFA settings to ensure they are correctly configured.\n\n### Response and remediation\n\n- If unauthorized access is confirmed, initiate the incident response process.\n- Immediately lock the affected actor account and require a password change.\n- Consider resetting MFA tokens for the actor and require re-enrollment.\n- Check if the compromised account was used to access or alter any sensitive data or systems.\n- If a specific MFA bypass technique was used, ensure your systems are patched or configured to prevent such techniques.\n- Assess the criticality of affected services and servers.\n- Work with your IT team to minimize the impact on users and maintain business continuity.\n- If multiple accounts are affected, consider a broader reset or audit of MFA tokens.\n- Implement security best practices [outlined](https://www.okta.com/blog/2019/10/9-admin-best-practices-to-keep-your-org-secure/) by Okta.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).",
        "output_index": "",
        "version": 411,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Data Source: Okta",
          "Tactic: Credential Access"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/okta-and-lapsus-what-you-need-to-know",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1111",
                "name": "Multi-Factor Authentication Interception",
                "reference": "https://attack.mitre.org/techniques/T1111/"
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "f76b3fb6-af8d-4b75-8290-43febb04ec31",
        "rule_id": "3805c3dc-f82c-4f8d-891e-63c24d3102b0",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:14.976Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:05.894Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset:okta.system and event.action:user.mfa.attempt_bypass",
        "language": "kuery"
      },
      {
        "name": "Process Discovery via Built-In Applications",
        "description": "Identifies the use of built-in tools attackers can use to discover running processes on an endpoint.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 3,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "OS: macOS",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Rule Type: BBR",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1057",
                "name": "Process Discovery",
                "reference": "https://attack.mitre.org/techniques/T1057/"
              },
              {
                "id": "T1518",
                "name": "Software Discovery",
                "reference": "https://attack.mitre.org/techniques/T1518/",
                "subtechnique": [
                  {
                    "id": "T1518.001",
                    "name": "Security Software Discovery",
                    "reference": "https://attack.mitre.org/techniques/T1518/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "a4364255-dd65-42a2-9583-1663bc5045d8",
        "rule_id": "3f4d7734-2151-4481-b394-09d7c6c91f75",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:14.981Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:16.421Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where event.type == \"start\" and event.action in (\"exec\", \"exec_event\") and process.name in (\n  \"ps\", \"pstree\", \"htop\", \"pgrep\"\n) and \nnot process.parent.name in (\"amazon-ssm-agent\", \"snap\")",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "Potential Privilege Escalation via OverlayFS",
        "description": "Identifies an attempt to exploit a local privilege escalation (CVE-2023-2640 and CVE-2023-32629) via a flaw in Ubuntu's modifications to OverlayFS. These flaws allow the creation of specialized executables, which, upon execution, grant the ability to escalate privileges to root on the affected machine.",
        "risk_score": 73,
        "severity": "high",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 5,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Use Case: Vulnerability",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.wiz.io/blog/ubuntu-overlayfs-vulnerability",
          "https://twitter.com/liadeliyahu/status/1684841527959273472"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1068",
                "name": "Exploitation for Privilege Escalation",
                "reference": "https://attack.mitre.org/techniques/T1068/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "205893f1-7608-457a-bc72-a49ccbd58b9d",
        "rule_id": "b51dbc92-84e2-4af1-ba47-65183fcd0c57",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:14.983Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:17.225Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by process.parent.entity_id, host.id with maxspan=5s\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and \n    process.name == \"unshare\" and process.args : (\"-r\", \"-rm\", \"m\") and process.args : \"*cap_setuid*\"  and user.id != \"0\"]\n  [process where host.os.type == \"linux\" and event.action == \"uid_change\" and event.type == \"change\" and \n    user.id == \"0\"]",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Threat Intel Windows Registry Indicator Match",
        "description": "This rule is triggered when a Windows registry indicator from the Threat Intel Filebeat module or integrations has a match against an event that contains registry data.",
        "risk_score": 99,
        "severity": "critical",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "timeline_id": "495ad7a7-316e-4544-8a0f-9c098daee76e",
        "timeline_title": "Generic Threat Match Timeline",
        "license": "Elastic License v2",
        "note": "## Triage and Analysis\n\n### Investigating Threat Intel Windows Registry Indicator Match\n\nThreat Intel indicator match rules allow matching from a local observation, such as an endpoint event that records a file hash with an entry of a file hash stored within the Threat Intel integrations index.\n\nMatches are based on threat intelligence data that's been ingested during the last 30 days. Some integrations don't place expiration dates on their threat indicators, so we strongly recommend validating ingested threat indicators and reviewing match results. When reviewing match results, check associated activity to determine whether the event requires additional investigation.\n\nThis rule is triggered when a Windows registry indicator from the Threat Intel Filebeat module or a threat intelligence integration matches against an event that contains registry data.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Check related threat reports to gain context about the registry indicator of compromise (IoC) and to understand if it's a system-native mechanism abused for persistence, to store data, to disable security mechanisms, etc. Use this information to define the appropriate triage and respond steps.\n- Identify the process responsible for the registry operation and investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Retrieve the involved process executable and examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the process executable using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n- Using the data collected through the analysis, scope users targeted and other machines infected in the environment.\n\n### False Positive Analysis\n\n- Adversaries can leverage dual-use registry mechanisms that are commonly used by normal applications. These registry keys can be added into indicator lists creating the potential for false positives.\n\n### Response and Remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 7,
        "tags": [
          "OS: Windows",
          "Data Source: Elastic Endgame",
          "Rule Type: Threat Match"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "1h",
        "from": "now-3900s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-module-threatintel.html",
          "https://www.elastic.co/guide/en/security/master/es-threat-intel-integrations.html",
          "https://www.elastic.co/security/tip"
        ],
        "max_signals": 100,
        "threat": [],
        "setup": "## Setup\n\nThis rule needs threat intelligence indicators to work.\nThreat intelligence indicators can be collected using an [Elastic Agent integration](https://www.elastic.co/guide/en/security/current/es-threat-intel-integrations.html#agent-ti-integration),\nthe [Threat Intel module](https://www.elastic.co/guide/en/security/current/es-threat-intel-integrations.html#ti-mod-integration),\nor a [custom integration](https://www.elastic.co/guide/en/security/current/es-threat-intel-integrations.html#custom-ti-integration).\n\nMore information can be found [here](https://www.elastic.co/guide/en/security/current/es-threat-intel-integrations.html).\n",
        "related_integrations": [],
        "required_fields": [
          {
            "name": "registry.path",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "5b727670-b202-438b-b177-9a61dc34bb23",
        "rule_id": "a61809f3-fb5b-465c-8bff-23a8a068ac60",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:14.988Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:14.342Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "threat_match",
        "query": "registry.path:*",
        "threat_query": "@timestamp >= \"now-30d/d\" and event.module:(threatintel or ti_*) and threat.indicator.registry.path:* and not labels.is_ioc_transform_source:\"true\"",
        "threat_mapping": [
          {
            "entries": [
              {
                "field": "registry.path",
                "type": "mapping",
                "value": "threat.indicator.registry.path"
              }
            ]
          }
        ],
        "threat_index": [
          "filebeat-*",
          "logs-ti_*"
        ],
        "index": [
          "auditbeat-*",
          "endgame-*",
          "filebeat-*",
          "logs-*",
          "winlogbeat-*"
        ],
        "filters": [],
        "threat_filters": [
          {
            "$state": {
              "store": "appState"
            },
            "meta": {
              "disabled": false,
              "key": "event.category",
              "negate": false,
              "params": {
                "query": "threat"
              },
              "type": "phrase"
            },
            "query": {
              "match_phrase": {
                "event.category": "threat"
              }
            }
          },
          {
            "$state": {
              "store": "appState"
            },
            "meta": {
              "disabled": false,
              "key": "event.kind",
              "negate": false,
              "params": {
                "query": "enrichment"
              },
              "type": "phrase"
            },
            "query": {
              "match_phrase": {
                "event.kind": "enrichment"
              }
            }
          },
          {
            "$state": {
              "store": "appState"
            },
            "meta": {
              "disabled": false,
              "key": "event.type",
              "negate": false,
              "params": {
                "query": "indicator"
              },
              "type": "phrase"
            },
            "query": {
              "match_phrase": {
                "event.type": "indicator"
              }
            }
          }
        ],
        "threat_indicator_path": "threat.indicator",
        "threat_language": "kuery",
        "language": "kuery"
      },
      {
        "name": "PowerShell Invoke-NinjaCopy script",
        "description": "Detects PowerShell scripts that contain the default exported functions used on Invoke-NinjaCopy. Attackers can use Invoke-NinjaCopy to read SYSTEM files that are normally locked, such as the NTDS.dit file or registry hives.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating PowerShell Invoke-NinjaCopy script\n\nPowerShell is one of the main tools system administrators use for automation, report routines, and other tasks, making it available for use in various environments, creating an attractive way for attackers to execute code.\n\nInvoke-NinjaCopy is a PowerShell script capable of reading SYSTEM files that were normally locked, such as `NTDS.dit` or sensitive registry locations. It does so by using the direct volume access technique, which enables attackers to bypass access control mechanisms and file system monitoring by reading the raw data directly from the disk and extracting the file by parsing the file system structures.\n\n#### Possible investigation steps\n\n- Examine the script content that triggered the detection; look for suspicious DLL imports, collection or exfiltration capabilities, suspicious functions, encoded or compressed data, and other potentially malicious characteristics.\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Examine file or network events from the involved PowerShell process for suspicious behavior.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Evaluate whether the user needs to use PowerShell to complete tasks.\n- Determine whether the script stores the captured data locally.\n- Check if the imported function was executed and which file it targeted.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Any activity that triggered the alert and is not inherently malicious must be monitored by the security team.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Restrict PowerShell usage outside of IT and engineering business units using GPOs, AppLocker, Intune, or similar software.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 108,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Data Source: PowerShell Logs",
          "Resources: Investigation Guide"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/BC-SECURITY/Empire/blob/main/empire/server/data/module_source/collection/Invoke-NinjaCopy.ps1"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1003",
                "name": "OS Credential Dumping",
                "reference": "https://attack.mitre.org/techniques/T1003/",
                "subtechnique": [
                  {
                    "id": "T1003.002",
                    "name": "Security Account Manager",
                    "reference": "https://attack.mitre.org/techniques/T1003/002/"
                  },
                  {
                    "id": "T1003.003",
                    "name": "NTDS",
                    "reference": "https://attack.mitre.org/techniques/T1003/003/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1006",
                "name": "Direct Volume Access",
                "reference": "https://attack.mitre.org/techniques/T1006/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "powershell.file.script_block_text",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "9e7b790c-6f75-4972-a667-7ae4815bcf26",
        "rule_id": "b8386923-b02c-4b94-986a-d223d9b01f88",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:14.994Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:06.977Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-windows.powershell*"
        ],
        "filters": [],
        "query": "event.category:process and host.os.type:windows and\n  powershell.file.script_block_text : (\n    \"StealthReadFile\" or\n    \"StealthReadFileAddr\" or\n    \"StealthCloseFileDelegate\" or\n    \"StealthOpenFile\" or\n    \"StealthCloseFile\" or\n    \"StealthReadFile\" or\n    \"Invoke-NinjaCopy\"\n   )\n  and not user.id : \"S-1-5-18\"\n  and not powershell.file.script_block_text : (\n    \"sentinelbreakpoints\" and \"Set-PSBreakpoint\" and \"PowerSploitIndicators\"\n  )",
        "language": "kuery"
      },
      {
        "name": "Linux Group Creation",
        "description": "Identifies attempts to create a new group. Attackers may create new groups to establish persistence on a system.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Linux Group Creation\n\nThe `groupadd` and `addgroup` commands are used to create new user groups in Linux-based operating systems.\n\nAttackers may create new groups to maintain access to victim systems or escalate privileges by assigning a compromised account to a privileged group.\n\nThis rule identifies the usages of `groupadd` and `addgroup` to create new groups.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n> This investigation guide uses [placeholder fields](https://www.elastic.co/guide/en/security/current/osquery-placeholder-fields.html) to dynamically pass alert data into Osquery queries. Placeholder fields were introduced in Elastic Stack version 8.7.0. If you're using Elastic Stack version 8.6.0 or earlier, you'll need to manually adjust this investigation guide's queries to ensure they properly run.\n\n#### Possible investigation steps\n\n- Investigate whether the group was created succesfully.\n  - !{osquery{\"label\":\"Osquery - Retrieve Information for a Specific Group\",\"query\":\"SELECT * FROM groups WHERE groupname = {{group.name}}\"}}\n- Identify if a user account was added to this group after creation.\n  - !{osquery{\"label\":\"Osquery - Retrieve Information for a Specific User\",\"query\":\"SELECT * FROM users WHERE username = {{user.name}}\"}}\n- Investigate whether the user is currently logged in and active.\n  - !{osquery{\"label\":\"Osquery - Investigate the Account Authentication Status\",\"query\":\"SELECT * FROM logged_in_users WHERE user = {{user.name}}\"}}\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence and whether they are located in expected locations.\n  - !{osquery{\"label\":\"Osquery - Retrieve Running Processes by User\",\"query\":\"SELECT pid, username, name FROM processes p JOIN users u ON u.uid = p.uid ORDER BY username\"}}\n- Investigate other alerts associated with the user/host during the past 48 hours.\n\n### False positive analysis\n\n- Group creation is a common administrative task, so there is a high chance of the activity being legitimate. Before investigating further, verify that this activity is not benign.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Review the privileges assigned to the involved users to ensure that the least privilege principle is being followed.\n- Delete the created group and, in case an account was added to this group, delete the account.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Leverage the incident response data and logging to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 6,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Resources: Investigation Guide"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/security-labs/primer-on-persistence-mechanisms"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1136",
                "name": "Create Account",
                "reference": "https://attack.mitre.org/techniques/T1136/",
                "subtechnique": [
                  {
                    "id": "T1136.001",
                    "name": "Local Account",
                    "reference": "https://attack.mitre.org/techniques/T1136/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Filebeat.\n\n### Filebeat Setup\nFilebeat is a lightweight shipper for forwarding and centralizing log data. Installed as an agent on your servers, Filebeat monitors the log files or locations that you specify, collects log events, and forwards them either to Elasticsearch or Logstash for indexing.\n\n#### The following steps should be executed in order to add the Filebeat on a Linux System:\n- Elastic provides repositories available for APT and YUM-based distributions. Note that we provide binary packages, but no source packages.\n- To install the APT and YUM repositories follow the setup instructions in this [helper guide](https://www.elastic.co/guide/en/beats/filebeat/current/setup-repositories.html).\n- To run Filebeat on Docker follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/filebeat/current/running-on-docker.html).\n- To run Filebeat on Kubernetes follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/filebeat/current/running-on-kubernetes.html).\n- For quick start information for Filebeat refer to the [helper guide](https://www.elastic.co/guide/en/beats/filebeat/8.11/filebeat-installation-configuration.html).\n- For complete â€œSetup and Run Filebeatâ€ information refer to the [helper guide](https://www.elastic.co/guide/en/beats/filebeat/current/setting-up-and-running.html).\n\n#### Rule Specific Setup Note\n- This rule requires the â€œFilebeat System Moduleâ€ to be enabled.\n- The system module collects and parses logs created by the system logging service of common Unix/Linux based distributions.\n- To run the system module of Filebeat on Linux follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-module-system.html).\n",
        "related_integrations": [
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "group.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "6b9ae958-fca1-403b-8c82-5e2e2d193212",
        "rule_id": "a1c2589e-0c8c-4ca8-9eb6-f83c4bbdbe8f",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:14.996Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:14.305Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "iam where host.os.type == \"linux\" and (event.type == \"group\" and event.type == \"creation\") and\nprocess.name in (\"groupadd\", \"addgroup\") and group.name != null",
        "language": "eql",
        "index": [
          "filebeat-*",
          "logs-system.auth-*"
        ],
        "filters": []
      },
      {
        "name": "Potential Suspicious File Edit",
        "description": "This rule monitors for the potential edit of a suspicious file. In Linux, when editing a file through an editor, a temporary .swp file is created. By monitoring for the creation of this .swp file, we can detect potential file edits of suspicious files. The execution of this rule is not a clear sign of the file being edited, as just opening the file through an editor will trigger this event. Attackers may alter any of the files added in this rule to establish persistence, escalate privileges or perform reconnaisance on the system.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 5,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Tactic: Privilege Escalation",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 1,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1037",
                "name": "Boot or Logon Initialization Scripts",
                "reference": "https://attack.mitre.org/techniques/T1037/",
                "subtechnique": [
                  {
                    "id": "T1037.004",
                    "name": "RC Scripts",
                    "reference": "https://attack.mitre.org/techniques/T1037/004/"
                  }
                ]
              },
              {
                "id": "T1543",
                "name": "Create or Modify System Process",
                "reference": "https://attack.mitre.org/techniques/T1543/",
                "subtechnique": [
                  {
                    "id": "T1543.002",
                    "name": "Systemd Service",
                    "reference": "https://attack.mitre.org/techniques/T1543/002/"
                  }
                ]
              },
              {
                "id": "T1574",
                "name": "Hijack Execution Flow",
                "reference": "https://attack.mitre.org/techniques/T1574/",
                "subtechnique": [
                  {
                    "id": "T1574.006",
                    "name": "Dynamic Linker Hijacking",
                    "reference": "https://attack.mitre.org/techniques/T1574/006/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1548",
                "name": "Abuse Elevation Control Mechanism",
                "reference": "https://attack.mitre.org/techniques/T1548/",
                "subtechnique": [
                  {
                    "id": "T1548.003",
                    "name": "Sudo and Sudo Caching",
                    "reference": "https://attack.mitre.org/techniques/T1548/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "c4470ff5-75bd-4b4b-b0c7-cb7f0ca1d7ed",
        "rule_id": "3728c08d-9b70-456b-b6b8-007c7d246128",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:15.001Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:16.414Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"linux\" and event.action in (\"creation\", \"file_create_event\") and file.extension == \"swp\" and\nfile.path : (\n  /* common interesting files and locations */\n  \"/etc/.shadow.swp\", \"/etc/.shadow-.swp\", \"/etc/.shadow~.swp\", \"/etc/.gshadow.swp\", \"/etc/.gshadow-.swp\",\n  \"/etc/.passwd.swp\", \"/etc/.pwd.db.swp\", \"/etc/.master.passwd.swp\", \"/etc/.spwd.db.swp\", \"/etc/security/.opasswd.swp\",\n  \"/etc/.environment.swp\", \"/etc/.profile.swp\", \"/etc/sudoers.d/.*.swp\", \"/etc/ld.so.conf.d/.*.swp\",\n  \"/etc/init.d/.*.swp\", \"/etc/.rc.local.swp\", \"/etc/rc*.d/.*.swp\", \"/dev/shm/.*.swp\", \"/etc/update-motd.d/.*.swp\",\n  \"/usr/lib/update-notifier/.*.swp\",\n\n  /* service, timer, want, socket and lock files */\n  \"/etc/systemd/system/.*.swp\", \"/usr/local/lib/systemd/system/.*.swp\", \"/lib/systemd/system/.*.swp\",\n  \"/usr/lib/systemd/system/.*.swp\",\"/home/*/.config/systemd/user/.*.swp\", \"/run/.*.swp\", \"/var/run/.*.swp/\",\n\n  /* profile and shell configuration files */  \n  \"/home/*.profile.swp\", \"/home/*.bash_profile.swp\", \"/home/*.bash_login.swp\", \"/home/*.bashrc.swp\", \"/home/*.bash_logout.swp\",\n  \"/home/*.zshrc.swp\", \"/home/*.zlogin.swp\", \"/home/*.tcshrc.swp\", \"/home/*.kshrc.swp\", \"/home/*.config.fish.swp\",\n  \"/root/*.profile.swp\", \"/root/*.bash_profile.swp\", \"/root/*.bash_login.swp\", \"/root/*.bashrc.swp\", \"/root/*.bash_logout.swp\",\n  \"/root/*.zshrc.swp\", \"/root/*.zlogin.swp\", \"/root/*.tcshrc.swp\", \"/root/*.kshrc.swp\", \"/root/*.config.fish.swp\"\n)",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "PowerShell Script with Discovery Capabilities",
        "description": "Identifies the use of Cmdlets and methods related to discovery activities. Attackers can use these to perform various situational awareness related activities, like enumerating users, shares, sessions, domain trusts, groups, etc.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 209,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Collection",
          "Tactic: Discovery",
          "Data Source: PowerShell Logs",
          "Rule Type: BBR"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1087",
                "name": "Account Discovery",
                "reference": "https://attack.mitre.org/techniques/T1087/",
                "subtechnique": [
                  {
                    "id": "T1087.001",
                    "name": "Local Account",
                    "reference": "https://attack.mitre.org/techniques/T1087/001/"
                  },
                  {
                    "id": "T1087.002",
                    "name": "Domain Account",
                    "reference": "https://attack.mitre.org/techniques/T1087/002/"
                  }
                ]
              },
              {
                "id": "T1482",
                "name": "Domain Trust Discovery",
                "reference": "https://attack.mitre.org/techniques/T1482/"
              },
              {
                "id": "T1082",
                "name": "System Information Discovery",
                "reference": "https://attack.mitre.org/techniques/T1082/"
              },
              {
                "id": "T1083",
                "name": "File and Directory Discovery",
                "reference": "https://attack.mitre.org/techniques/T1083/"
              },
              {
                "id": "T1615",
                "name": "Group Policy Discovery",
                "reference": "https://attack.mitre.org/techniques/T1615/"
              },
              {
                "id": "T1135",
                "name": "Network Share Discovery",
                "reference": "https://attack.mitre.org/techniques/T1135/"
              },
              {
                "id": "T1201",
                "name": "Password Policy Discovery",
                "reference": "https://attack.mitre.org/techniques/T1201/"
              },
              {
                "id": "T1057",
                "name": "Process Discovery",
                "reference": "https://attack.mitre.org/techniques/T1057/"
              },
              {
                "id": "T1518",
                "name": "Software Discovery",
                "reference": "https://attack.mitre.org/techniques/T1518/",
                "subtechnique": [
                  {
                    "id": "T1518.001",
                    "name": "Security Software Discovery",
                    "reference": "https://attack.mitre.org/techniques/T1518/001/"
                  }
                ]
              },
              {
                "id": "T1012",
                "name": "Query Registry",
                "reference": "https://attack.mitre.org/techniques/T1012/"
              },
              {
                "id": "T1082",
                "name": "System Information Discovery",
                "reference": "https://attack.mitre.org/techniques/T1082/"
              },
              {
                "id": "T1049",
                "name": "System Network Connections Discovery",
                "reference": "https://attack.mitre.org/techniques/T1049/"
              },
              {
                "id": "T1007",
                "name": "System Service Discovery",
                "reference": "https://attack.mitre.org/techniques/T1007/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'PowerShell Script Block Logging' logging policy must be enabled.\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nAdministrative Templates >\nWindows PowerShell >\nTurn on PowerShell Script Block Logging (Enable)\n```\n\nSteps to implement the logging policy via registry:\n\n```\nreg add \"hklm\\SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\ScriptBlockLogging\" /v EnableScriptBlockLogging /t REG_DWORD /d 1\n```\n",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "powershell.file.script_block_text",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "c15cb95e-b32b-4e09-8e0f-ef5df7c7c092",
        "rule_id": "1e0a3f7c-21e7-4bb1-98c7-2036612fb1be",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:15.006Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:16.398Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-windows.powershell*"
        ],
        "filters": [
          {
            "meta": {
              "negate": true
            },
            "query": {
              "wildcard": {
                "file.path": {
                  "case_insensitive": true,
                  "value": "?:\\\\Program Files\\\\WindowsPowerShell\\\\Modules\\\\*.ps?1"
                }
              }
            }
          },
          {
            "meta": {
              "negate": true
            },
            "query": {
              "wildcard": {
                "file.path": {
                  "case_insensitive": true,
                  "value": "?:\\\\Program Files\\\\Microsoft Azure AD Sync\\\\Extensions\\\\AADConnector.psm1"
                }
              }
            }
          },
          {
            "meta": {
              "negate": true
            },
            "query": {
              "wildcard": {
                "file.path": {
                  "case_insensitive": true,
                  "value": "*ServiceNow MID Server*\\\\agent\\\\scripts\\\\PowerShell\\\\*.psm1"
                }
              }
            }
          },
          {
            "meta": {
              "negate": true
            },
            "query": {
              "wildcard": {
                "file.path": {
                  "case_insensitive": true,
                  "value": "?:\\\\Windows\\\\IMECache\\\\HealthScripts\\\\*\\\\detect.ps1"
                }
              }
            }
          },
          {
            "meta": {
              "negate": true
            },
            "query": {
              "wildcard": {
                "file.path": {
                  "case_insensitive": true,
                  "value": "?:\\\\Windows\\\\TEMP\\\\SDIAG*"
                }
              }
            }
          },
          {
            "meta": {
              "negate": true
            },
            "query": {
              "wildcard": {
                "file.path": {
                  "case_insensitive": true,
                  "value": "?:\\\\Temp\\\\SDIAG*"
                }
              }
            }
          },
          {
            "meta": {
              "negate": true
            },
            "query": {
              "wildcard": {
                "file.path": {
                  "case_insensitive": true,
                  "value": "?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\SDIAG*"
                }
              }
            }
          },
          {
            "meta": {
              "negate": true
            },
            "query": {
              "wildcard": {
                "file.path": {
                  "case_insensitive": true,
                  "value": "?:\\\\Program Files\\\\Microsoft Monitoring Agent\\\\Agent\\\\Health Service State\\\\Monitoring Host Temporary Files*"
                }
              }
            }
          }
        ],
        "query": "event.category:process and host.os.type:windows and\n  powershell.file.script_block_text : (\n    (\n      \"Get-ADDefaultDomainPasswordPolicy\" or\n      \"Get-ADDomain\" or \"Get-ComputerInfo\" or\n      \"Get-Disk\" or \"Get-DnsClientCache\" or\n      \"Get-GPOReport\" or \"Get-HotFix\" or\n      \"Get-LocalUser\" or \"Get-NetFirewallProfile\" or\n      \"get-nettcpconnection\" or \"Get-NetAdapter\" or\n      \"Get-PhysicalDisk\" or \"Get-Process\" or\n      \"Get-PSDrive\" or \"Get-Service\" or\n      \"Get-SmbShare\" or \"Get-WinEvent\"\n    ) or\n    (\n      (\"Get-WmiObject\" or \"gwmi\" or \"Get-CimInstance\" or\n       \"gcim\" or \"Management.ManagementObjectSearcher\" or\n       \"System.Management.ManagementClass\" or\n       \"[WmiClass]\" or \"[WMI]\") and\n      (\n        \"AntiVirusProduct\" or \"CIM_BIOSElement\" or \"CIM_ComputerSystem\" or \"CIM_Product\" or \"CIM_DiskDrive\" or\n        \"CIM_LogicalDisk\" or \"CIM_NetworkAdapter\" or \"CIM_StorageVolume\" or \"CIM_OperatingSystem\" or\n        \"CIM_Process\" or \"CIM_Service\" or \"MSFT_DNSClientCache\" or \"Win32_BIOS\" or \"Win32_ComputerSystem\" or\n        \"Win32_ComputerSystemProduct\" or \"Win32_DiskDrive\" or \"win32_environment\" or \"Win32_Group\" or\n        \"Win32_groupuser\" or \"Win32_IP4RouteTable\" or \"Win32_logicaldisk\" or \"Win32_MappedLogicalDisk\" or\n        \"Win32_NetworkAdapterConfiguration\" or \"win32_ntdomain\" or \"Win32_OperatingSystem\" or\n        \"Win32_PnPEntity\" or \"Win32_Process\" or \"Win32_Product\" or \"Win32_quickfixengineering\" or\n        \"win32_service\" or \"Win32_Share\" or \"Win32_UserAccount\"\n      )\n    ) or\n    (\n      (\"ADSI\" and \"WinNT\") or\n      (\"Get-ChildItem\" and \"sysmondrv.sys\") or\n      (\"::GetIPGlobalProperties()\" and \"GetActiveTcpConnections()\") or\n      (\"ServiceProcess.ServiceController\" and \"::GetServices\") or\n      (\"Diagnostics.Process\" and \"::GetProcesses\") or\n      (\"DirectoryServices.Protocols.GroupPolicy\" and \".GetGPOReport()\") or\n      (\"DirectoryServices.AccountManagement\" and \"PrincipalSearcher\") or\n      (\"NetFwTypeLib.NetFwMgr\" and \"CurrentProfile\") or\n      (\"NetworkInformation.NetworkInterface\" and \"GetAllNetworkInterfaces\") or\n      (\"Automation.PSDriveInfo\") or\n      (\"Microsoft.Win32.RegistryHive\")\n    ) or\n    (\n      \"Get-ItemProperty\" and\n      (\n        \"\\Control\\SecurityProviders\\WDigest\" or\n        \"\\microsoft\\windows\\currentversion\\explorer\\runmru\" or\n        \"\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\Kerberos\\Parameters\" or\n        \"\\Microsoft\\Windows\\CurrentVersion\\Uninstall\" or\n        \"\\Microsoft\\Windows\\WindowsUpdate\" or\n        \"Policies\\Microsoft\\Windows\\Installer\" or\n        \"Software\\Microsoft\\Windows\\CurrentVersion\\Policies\" or\n        (\"\\Services\\SharedAccess\\Parameters\\FirewallPolicy\" and \"EnableFirewall\") or\n        (\"Microsoft\\Windows\\CurrentVersion\\Internet Settings\" and \"proxyEnable\")\n      )\n    ) or\n    (\n      (\"Directoryservices.Activedirectory\" or\n      \"DirectoryServices.AccountManagement\") and \n      (\n        \"Domain Admins\" or \"DomainControllers\" or\n        \"FindAllGlobalCatalogs\" or \"GetAllTrustRelationships\" or\n        \"GetCurrentDomain\" or \"GetCurrentForest\"\n      ) or\n      \"DirectoryServices.DirectorySearcher\" and\n      (\n        \"samAccountType=805306368\" or\n        \"samAccountType=805306369\" or\n        \"objectCategory=group\" or\n        \"objectCategory=groupPolicyContainer\" or\n        \"objectCategory=site\" or\n        \"objectCategory=subnet\" or\n        \"objectClass=trustedDomain\"\n      )\n    ) or\n    (\n      \"Get-Process\" and\n      (\n        \"mcshield\" or \"windefend\" or \"savservice\" or\n        \"TMCCSF\" or \"symantec antivirus\" or\n        \"CSFalcon\" or \"TmPfw\" or \"kvoop\"\n      )\n    )\n  ) and\n  not powershell.file.script_block_text : (\n    (\n      \"__cmdletization_BindCommonParameters\" and\n      \"Microsoft.PowerShell.Core\\Export-ModuleMember\" and\n      \"Microsoft.PowerShell.Cmdletization.Cim.CimCmdletAdapter\"\n    ) or\n    \"CmdletsToExport=@(\\\"Add-Content\\\",\"\n  ) and\n  not user.id : (\"S-1-5-18\" or \"S-1-5-19\" or \"S-1-5-20\")",
        "language": "kuery"
      },
      {
        "name": "Linux System Information Discovery",
        "description": "Enrich process events with uname and other command lines that imply Linux system information discovery.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 3,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Rule Type: BBR",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame",
          "Data Source: Auditd Manager"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1082",
                "name": "System Information Discovery",
                "reference": "https://attack.mitre.org/techniques/T1082/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "auditd_manager",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "a09903f6-98c0-4fcb-99c4-5608ef8d588a",
        "rule_id": "b81bd314-db5b-4d97-82e8-88e3e5fc9de5",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:15.008Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:17.228Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where event.type == \"start\" and event.action in (\"exec\", \"exec_event\", \"executed\", \"process_started\") and (\n  process.name: \"uname\" or (\n  process.name: (\"cat\", \"more\", \"less\") and process.args: (\"*issue*\", \"*version*\", \"*profile*\", \"*services*\", \"*cpuinfo*\")\n  )\n)",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*",
          "auditbeat-*",
          "logs-auditd_manager.auditd-*"
        ],
        "filters": []
      },
      {
        "name": "Potential Sudo Hijacking",
        "description": "Identifies the creation of a sudo binary located at /usr/bin/sudo. Attackers may hijack the default sudo binary and replace it with a custom binary or script that can read the user's password in clear text to escalate privileges or enable persistence onto the system every time the sudo binary is executed.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 107,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Tactic: Persistence",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://eapolsniper.github.io/2020/08/17/Sudo-Hijacking/",
          "https://www.elastic.co/security-labs/sequel-on-persistence-mechanisms"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1548",
                "name": "Abuse Elevation Control Mechanism",
                "reference": "https://attack.mitre.org/techniques/T1548/",
                "subtechnique": [
                  {
                    "id": "T1548.003",
                    "name": "Sudo and Sudo Caching",
                    "reference": "https://attack.mitre.org/techniques/T1548/003/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1574",
                "name": "Hijack Execution Flow",
                "reference": "https://attack.mitre.org/techniques/T1574/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.Ext.original.extension",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "file.Ext.original.path",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "962aa574-abb2-44cb-a9f4-1e661dd8c06b",
        "rule_id": "88fdcb8c-60e5-46ee-9206-2663adf1b1ce",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:14.636Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:17.208Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"linux\" and event.action in (\"creation\", \"rename\") and\nfile.path in (\"/usr/bin/sudo\", \"/bin/sudo\") and not (\n  file.Ext.original.path in (\"/usr/bin/sudo\", \"/bin/sudo\") or\n  process.executable in (\n    \"/bin/dpkg\", \"/usr/bin/dpkg\", \"/bin/dockerd\", \"/usr/bin/dockerd\", \"/usr/sbin/dockerd\", \"/bin/microdnf\",\n    \"/bin/rpm\", \"/usr/bin/rpm\", \"/bin/snapd\", \"/usr/bin/snapd\", \"/bin/yum\", \"/usr/bin/yum\", \"/bin/dnf\", \"/usr/bin/dnf\",\n    \"/bin/podman\", \"/usr/bin/podman\", \"/bin/dnf-automatic\", \"/usr/bin/dnf-automatic\", \"/bin/pacman\", \"/usr/bin/pacman\",\n    \"/usr/bin/dpkg-divert\", \"/bin/dpkg-divert\", \"/sbin/apk\", \"/usr/sbin/apk\", \"/usr/local/sbin/apk\", \"/usr/bin/apt\",\n    \"/usr/sbin/pacman\", \"/usr/bin/microdnf\", \"/usr/local/bin/dockerd\", \"/usr/local/bin/podman\", \"/usr/local/bin/dnf\",\n    \"/kaniko/executor\", \"/proc/self/exe\", \"/usr/bin/apt-get\", \"/usr/bin/apt-cache\", \"/usr/bin/apt-mark\"\n  ) or\n  file.Ext.original.extension == \"dpkg-new\" or\n  process.executable : (\n    \"/nix/store/*\", \"/var/lib/dpkg/*\", \"/tmp/vmis.*\", \"/snap/*\", \"/dev/fd/*\", \"/var/lib/docker/*\"\n  ) or\n  process.executable == null or\n  (process.name == \"sed\" and file.name : \"sed*\")\n)",
        "language": "eql",
        "index": [
          "logs-endpoint.events.file*"
        ],
        "filters": []
      },
      {
        "name": "Process Discovery Using Built-in Tools",
        "description": "This rule identifies the execution of commands that can be used to enumerate running processes. Adversaries may enumerate processes to identify installed applications and security solutions.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 106,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Rule Type: BBR",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1057",
                "name": "Process Discovery",
                "reference": "https://attack.mitre.org/techniques/T1057/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "94c9a47a-d1ef-429c-95f9-717295a29522",
        "rule_id": "4982ac3e-d0ee-4818-b95d-d9522d689259",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:15.434Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:17.155Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (\n    process.name :(\"PsList.exe\", \"qprocess.exe\") or \n   (process.name : \"powershell.exe\" and process.args : (\"*get-process*\", \"*Win32_Process*\")) or \n   (process.name : \"wmic.exe\" and process.args : (\"process\", \"*Win32_Process*\")) or\n   (process.name : \"tasklist.exe\" and not process.args : (\"pid eq*\")) or\n   (process.name : \"query.exe\" and process.args : \"process\")\n  ) and not user.id : \"S-1-5-18\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "logs-system.security*",
          "winlogbeat-*",
          "logs-windows.*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious Microsoft 365 Mail Access by ClientAppId",
        "description": "Identifies when a Microsoft 365 Mailbox is accessed by a ClientAppId that was observed for the fist time during the last 10 days.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Suspicious Microsoft 365 Mail Access by ClientAppId\n\n- Verify the ClientAppId, source.ip and geolocation associated with Mail Access.\n- Verify the total number of used ClientAppId by that specific user.id.\n- Verify if the mailbox owner was on leave and just resumed working or not.\n- Verify if there are other alerts associated with the same user.id.\n- Verify the total number of connections from that ClientAppId, if it's accessing other mailboxes and with a high frequency there is a high chance it's a false positive.\n\n### False positive analysis\n\n- Legit Microsoft or third party ClientAppId.\n- User changing of ClientAppId or new connection post an extended period of leave.\n- If the total number of accessed Mailboxes by ClientAppId is too high there is a high chance it's a false positive.\n",
        "output_index": "",
        "version": 107,
        "tags": [
          "Domain: Cloud",
          "Data Source: Microsoft 365",
          "Use Case: Configuration Audit",
          "Tactic: Initial Access"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-1800s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "User using a new mail client."
        ],
        "references": [
          "https://www.cisa.gov/news-events/cybersecurity-advisories/aa23-193a"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1078",
                "name": "Valid Accounts",
                "reference": "https://attack.mitre.org/techniques/T1078/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe Office 365 Logs Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.\n",
        "related_integrations": [
          {
            "package": "o365",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "o365.audit.ClientAppId",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "6eb040f3-42b9-45a8-81c8-f9d7f22e727e",
        "rule_id": "48819484-9826-4083-9eba-1da74cd0eaf2",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:15.384Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:17.285Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "event.dataset:o365.audit and event.provider:Exchange and event.category:web and event.action:MailItemsAccessed and event.outcome:success and \nnot o365.audit.ClientAppId : (\"13937bba-652e-4c46-b222-3003f4d1ff97\" or \"6326e366-9d6d-4c70-b22a-34c7ea72d73d\" or \n \"a3883eba-fbe9-48bd-9ed3-dca3e0e84250\" or \"d3590ed6-52b3-4102-aeff-aad2292ab01c\" or \"27922004-5251-4030-b22d-91ecd9a37ea4\" or \n \"1fec8e78-bce4-4aaf-ab1b-5451cc387264\" or \"26a7ee05-5602-4d76-a7ba-eae8b7b67941\" or \"00000002-0000-0000-c000-000000000000\" or \n \"00000002-0000-0ff1-ce00-000000000000\" or \"ffcb16e8-f789-467c-8ce9-f826a080d987\" or \"00000003-0000-0ff1-ce00-000000000000\" or \n \"00000004-0000-0ff1-ce00-000000000000\" or \"00000005-0000-0ff1-ce00-000000000000\" or  \"00000006-0000-0ff1-ce00-000000000000\" or \n \"00000007-0000-0000-c000-000000000000\" or \"00000007-0000-0ff1-ce00-000000000000\" or \n \"00000009-0000-0000-c000-000000000000\" or \"0000000c-0000-0000-c000-000000000000\" or \"00000015-0000-0000-c000-000000000000\" or \n \"0000001a-0000-0000-c000-000000000000\" or \"00b41c95-dab0-4487-9791-b9d2c32c80f2\" or \"022907d3-0f1b-48f7-badc-1ba6abab6d66\" or \n \"04b07795-8ddb-461a-bbee-02f9e1bf7b46\" or \"08e18876-6177-487e-b8b5-cf950c1e598c\" or \"0cb7b9ec-5336-483b-bc31-b15b5788de71\" or \n \"0cd196ee-71bf-4fd6-a57c-b491ffd4fb1e\" or \"0f698dd4-f011-4d23-a33e-b36416dcb1e6\" or \"13937bba-652e-4c46-b222-3003f4d1ff97\" or \n \"14d82eec-204b-4c2f-b7e8-296a70dab67e\" or \"16aeb910-ce68-41d1-9ac3-9e1673ac9575\" or \"1786c5ed-9644-47b2-8aa0-7201292175b6\" or \n \"17d5e35f-655b-4fb0-8ae6-86356e9a49f5\" or \"18fbca16-2224-45f6-85b0-f7bf2b39b3f3\" or \"1950a258-227b-4e31-a9cf-717495945fc2\" or \n \"1b3c667f-cde3-4090-b60b-3d2abd0117f0\" or \"1fec8e78-bce4-4aaf-ab1b-5451cc387264\" or \"20a11fe0-faa8-4df5-baf2-f965f8f9972e\" or \n \"23523755-3a2b-41ca-9315-f81f3f566a95\" or \"243c63a3-247d-41c5-9d83-7788c43f1c43\" or \"268761a2-03f3-40df-8a8b-c3db24145b6b\" or \n \"26a7ee05-5602-4d76-a7ba-eae8b7b67941\" or \"26abc9a8-24f0-4b11-8234-e86ede698878\" or \"27922004-5251-4030-b22d-91ecd9a37ea4\" or \n \"28b567f6-162c-4f54-99a0-6887f387bbcc\" or \"29d9ed98-a469-4536-ade2-f981bc1d605e\" or \"2abdc806-e091-4495-9b10-b04d93c3f040\" or \n \"2d4d3d8e-2be3-4bef-9f87-7875a61c29de\" or \"2d7f3606-b07d-41d1-b9d2-0d0c9296a6e8\" or \"3090ab82-f1c1-4cdf-af2c-5d7a6f3e2cc7\" or \n \"35d54a08-36c9-4847-9018-93934c62740c\" or \"37182072-3c9c-4f6a-a4b3-b3f91cacffce\" or \"38049638-cc2c-4cde-abe4-4479d721ed44\" or \n \"3c896ded-22c5-450f-91f6-3d1ef0848f6e\" or \"4345a7b9-9a63-4910-a426-35363201d503\" or \"45a330b1-b1ec-4cc1-9161-9f03992aa49f\" or \n \"4765445b-32c6-49b0-83e6-1d93765276ca\" or \"497effe9-df71-4043-a8bb-14cf78c4b63b\" or  \"4b233688-031c-404b-9a80-a4f3f2351f90\" or \n \"4d5c2d63-cf83-4365-853c-925fd1a64357\" or \"51be292c-a17e-4f17-9a7e-4b661fb16dd2\" or \n \"5572c4c0-d078-44ce-b81c-6cbf8d3ed39e\" or \"5e3ce6c0-2b1f-4285-8d4b-75ee78787346\" or \"60c8bde5-3167-4f92-8fdb-059f6176dc0f\" or \n \"61109738-7d2b-4a0b-9fe3-660b1ff83505\" or \"62256cef-54c0-4cb4-bcac-4c67989bdc40\" or \"6253bca8-faf2-4587-8f2f-b056d80998a7\" or \n \"65d91a3d-ab74-42e6-8a2f-0add61688c74\" or \"66a88757-258c-4c72-893c-3e8bed4d6899\" or \"67e3df25-268a-4324-a550-0de1c7f97287\" or \n \"69893ee3-dd10-4b1c-832d-4870354be3d8\" or \"74658136-14ec-4630-ad9b-26e160ff0fc6\" or \"74bcdadc-2fdc-4bb3-8459-76d06952a0e9\" or \n \"797f4846-ba00-4fd7-ba43-dac1f8f63013\" or \"7ab7862c-4c57-491e-8a45-d52a7e023983\" or \"7ae974c5-1af7-4923-af3a-fb1fd14dcb7e\" or \n \"7b7531ad-5926-4f2d-8a1d-38495ad33e17\" or \"80ccca67-54bd-44ab-8625-4b79c4dc7775\" or \"835b2a73-6e10-4aa5-a979-21dfda45231c\" or \n \"871c010f-5e61-4fb1-83ac-98610a7e9110\" or \"89bee1f7-5e6e-4d8a-9f3d-ecd601259da7\" or \"8edd93e1-2103-40b4-bd70-6e34e586362d\" or \n \"905fcf26-4eb7-48a0-9ff0-8dcc7194b5ba\" or \"91ca2ca5-3b3e-41dd-ab65-809fa3dffffa\" or \"93625bc8-bfe2-437a-97e0-3d0060024faa\" or \n \"93d53678-613d-4013-afc1-62e9e444a0a5\" or \"944f0bd1-117b-4b1c-af26-804ed95e767e\" or \"94c63fef-13a3-47bc-8074-75af8c65887a\" or \n \"95de633a-083e-42f5-b444-a4295d8e9314\" or \"97cb1f73-50df-47d1-8fb0-0271f2728514\" or \"98db8bd6-0cc0-4e67-9de5-f187f1cd1b41\" or \n \"99b904fd-a1fe-455c-b86c-2f9fb1da7687\" or \"9ea1ad79-fdb6-4f9a-8bc3-2b70f96e34c7\" or \"a3475900-ccec-4a69-98f5-a65cd5dc5306\" or \n \"a3b79187-70b2-4139-83f9-6016c58cd27b\" or \"a57aca87-cbc0-4f3c-8b9e-dc095fdc8978\" or \"a970bac6-63fe-4ec5-8884-8536862c42d4\" or \n \"a9b49b65-0a12-430b-9540-c80b3332c127\" or \"ab9b8c07-8f02-4f72-87fa-80105867a763\" or \"ae8e128e-080f-4086-b0e3-4c19301ada69\" or \n \"b23dd4db-9142-4734-867f-3577f640ad0c\" or \"b4bddae8-ab25-483e-8670-df09b9f1d0ea\" or \"b669c6ea-1adf-453f-b8bc-6d526592b419\" or \n \"b6e69c34-5f1f-4c34-8cdf-7fea120b8670\" or \"bb2a2e3a-c5e7-4f0a-88e0-8e01fd3fc1f4\" or \"bdd48c81-3a58-4ea9-849c-ebea7f6b6360\" or \n \"c1c74fed-04c9-4704-80dc-9f79a2e515cb\" or \"c35cb2ba-f88b-4d15-aa9d-37bd443522e1\" or \"c44b4083-3bb0-49c1-b47d-974e53cbdf3c\" or \n \"c9a559d2-7aab-4f13-a6ed-e7e9c52aec87\" or \"cc15fd57-2c6c-4117-a88c-83b1d56b4bbe\" or \"cf36b471-5b44-428c-9ce7-313bf84528de\" or \n \"cf53fce8-def6-4aeb-8d30-b158e7b1cf83\" or \"d176f6e7-38e5-40c9-8a78-3998aab820e7\" or \"d3590ed6-52b3-4102-aeff-aad2292ab01c\" or \n \"d73f4b35-55c9-48c7-8b10-651f6f2acb2e\" or \"d9b8ec3a-1e4e-4e08-b3c2-5baf00c0fcb0\" or \"de8bc8b5-d9f9-48b1-a8ad-b748da725064\" or \n \"dfe74da8-9279-44ec-8fb2-2aed9e1c73d0\" or \"e1ef36fd-b883-4dbf-97f0-9ece4b576fc6\" or \"e64aa8bc-8eb4-40e2-898b-cf261a25954f\" or \n \"e9f49c6b-5ce5-44c8-925d-015017e9f7ad\" or \"ee272b19-4411-433f-8f28-5c13cb6fd407\" or \"f5eaa862-7f08-448c-9c4e-f4047d4d4521\" or \n \"fb78d390-0c51-40cd-8e17-fdbfab77341b\" or \"fc0f3af4-6835-4174-b806-f7db311fd2f3\" or \"fdf9885b-dd37-42bf-82e5-c3129ef5a302\"\n)",
        "new_terms_fields": [
          "o365.audit.ClientAppId"
        ],
        "history_window_start": "now-25d",
        "index": [
          "filebeat-*",
          "logs-o365*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Potential Linux Backdoor User Account Creation",
        "description": "Identifies the attempt to create a new backdoor user by setting the user's UID to 0. Attackers may alter a user's UID to 0 to establish persistence on a system.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Potential Linux Backdoor User Account Creation\n\nThe `usermod` command is used to modify user account attributes and settings in Linux-based operating systems.\n\nAttackers may create new accounts with a UID of 0 to maintain root access to target systems without leveraging the root user account.\n\nThis rule identifies the usage of the `usermod` command to set a user's UID to 0, indicating that the user becomes a root account. \n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n> This investigation guide uses [placeholder fields](https://www.elastic.co/guide/en/security/current/osquery-placeholder-fields.html) to dynamically pass alert data into Osquery queries. Placeholder fields were introduced in Elastic Stack version 8.7.0. If you're using Elastic Stack version 8.6.0 or earlier, you'll need to manually adjust this investigation guide's queries to ensure they properly run.\n\n#### Possible investigation steps\n- Investigate the user account that got assigned a uid of 0, and analyze its corresponding attributes.\n  - !{osquery{\"label\":\"Osquery - Retrieve User Accounts with a UID of 0\",\"query\":\"SELECT description, gid, gid_signed, shell, uid, uid_signed, username FROM users WHERE username != 'root' AND uid LIKE\\n'0'\\n\"}}\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence and whether they are located in expected locations.\n  - !{osquery{\"label\":\"Osquery - Retrieve Running Processes by User\",\"query\":\"SELECT pid, username, name FROM processes p JOIN users u ON u.uid = p.uid ORDER BY username\"}}\n- Identify the user account that performed the action, analyze it, and check whether it should perform this kind of action.\n  - !{osquery{\"label\":\"Osquery - Retrieve Information for a Specific User\",\"query\":\"SELECT * FROM users WHERE username = {{user.name}}\"}}\n- Investigate whether the user is currently logged in and active.\n  - !{osquery{\"label\":\"Osquery - Investigate the Account Authentication Status\",\"query\":\"SELECT * FROM logged_in_users WHERE user = {{user.name}}\"}}\n- Identify if the account was added to privileged groups or assigned special privileges after creation.\n  - !{osquery{\"label\":\"Osquery - Retrieve Information for a Specific Group\",\"query\":\"SELECT * FROM groups WHERE groupname = {{group.name}}\"}}\n- Investigate other alerts associated with the user/host during the past 48 hours.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Any activity that triggered the alert and is not inherently malicious must be monitored by the security team.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Review the privileges assigned to the involved users to ensure that the least privilege principle is being followed.\n- Delete the created account.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Leverage the incident response data and logging to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 8,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Data Source: Elastic Endgame",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend",
          "Data Source: Auditd Manager"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/security-labs/primer-on-persistence-mechanisms"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1136",
                "name": "Create Account",
                "reference": "https://attack.mitre.org/techniques/T1136/",
                "subtechnique": [
                  {
                    "id": "T1136.001",
                    "name": "Local Account",
                    "reference": "https://attack.mitre.org/techniques/T1136/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "auditd_manager",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "a274f590-2453-4794-9b1c-7c87ced20731",
        "rule_id": "494ebba4-ecb7-4be4-8c6f-654c686549ad",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:15.971Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:09.117Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\", \"executed\", \"process_started\")\n and process.name == \"usermod\" and process.args : \"-u\" and process.args : \"0\" and process.args : \"-o\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*",
          "auditbeat-*",
          "logs-auditd_manager.auditd-*"
        ],
        "filters": []
      },
      {
        "name": "Attempt to Install Kali Linux via WSL",
        "description": "Detects attempts to install or use Kali Linux via Windows Subsystem for Linux. Adversaries may enable and use WSL for Linux to avoid detection.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 209,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://learn.microsoft.com/en-us/windows/wsl/wsl-config"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1202",
                "name": "Indirect Command Execution",
                "reference": "https://attack.mitre.org/techniques/T1202/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "bf1fa5f3-8b3b-4ad2-b779-57ec93cd0cad",
        "rule_id": "dd34b062-b9e3-4a6b-8c0c-6c8ca6dd450e",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:19.464Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:07.012Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n(\n  (process.name : \"wsl.exe\" and process.args : (\"-d\", \"--distribution\", \"-i\", \"--install\") and process.args : \"kali*\") or \n  process.executable : (\n    \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\packages\\\\kalilinux*\", \n    \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Microsoft\\\\WindowsApps\\\\kali.exe\",\n    \"?:\\\\Program Files*\\\\WindowsApps\\\\KaliLinux.*\\\\kali.exe\",\n    \"\\\\Device\\\\HarddiskVolume?\\\\Users\\\\*\\\\AppData\\\\Local\\\\packages\\\\kalilinux*\", \n    \"\\\\Device\\\\HarddiskVolume?\\\\Users\\\\*\\\\AppData\\\\Local\\\\Microsoft\\\\WindowsApps\\\\kali.exe\",\n    \"\\\\Device\\\\HarddiskVolume?\\\\Program Files*\\\\WindowsApps\\\\KaliLinux.*\\\\kali.exe\"\n  )\n)",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Windows System Information Discovery",
        "description": "Detects the execution of commands used to discover information about the system, which attackers may use after compromising a system to gain situational awareness.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 108,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Rule Type: BBR",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1082",
                "name": "System Information Discovery",
                "reference": "https://attack.mitre.org/techniques/T1082/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "4ed150f9-2993-420a-b60b-10ffeac0cfd5",
        "rule_id": "51176ed2-2d90-49f2-9f3d-17196428b169",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:19.469Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:17.164Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n(\n  (\n    process.name : \"cmd.exe\" and process.args : \"ver*\" and not\n    process.parent.executable : (\n        \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Keybase\\\\upd.exe\",\n        \"?:\\\\Users\\\\*\\\\python*.exe\"\n    )\n  ) or \n  process.name : (\"systeminfo.exe\", \"hostname.exe\") or \n  (process.name : \"wmic.exe\" and process.args : \"os\" and process.args : \"get\")\n) and not\nprocess.parent.executable : (\n    \"?:\\\\Program Files\\\\*\",\n    \"?:\\\\Program Files (x86)\\\\*\",\n    \"?:\\\\ProgramData\\\\*\"\n) and not user.id : \"S-1-5-18\"",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.*",
          "endgame-*",
          "logs-system.security*"
        ],
        "filters": []
      },
      {
        "name": "Exchange Mailbox Export via PowerShell",
        "description": "Identifies the use of the Exchange PowerShell cmdlet, New-MailBoxExportRequest, to export the contents of a primary mailbox or archive to a .pst file. Adversaries may target user email to collect sensitive information.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Exchange Mailbox Export via PowerShell\n\nThe `New-MailBoxExportRequest` cmdlet is used to begin the process of exporting contents of a primary mailbox or archive to a .pst file. Note that this is done on a per-mailbox basis and this cmdlet is available only in on-premises Exchange.\nAttackers can abuse this functionality in preparation for exfiltrating contents, which is likely to contain sensitive and strategic data.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate the export operation:\n  - Identify the user account that performed the action and whether it should perform this kind of action.\n  - Contact the account owner and confirm whether they are aware of this activity.\n  - Check if this operation was approved and performed according to the organization's change management policy.\n  - Retrieve the operation status and use the `Get-MailboxExportRequest` cmdlet to review previous requests.\n  - By default, no group in Exchange has the privilege to import or export mailboxes. Investigate administrators that assigned the \"Mailbox Import Export\" privilege for abnormal activity.\n- Investigate if there is a significant quantity of export requests in the alert timeframe. This operation is done on a per-mailbox basis and can be part of a mass export.\n- If the operation was completed successfully:\n  - Check if the file is on the path specified in the command.\n  - Investigate if the file was compressed, archived, or retrieved by the attacker for exfiltration.\n\n### False positive analysis\n\n- This mechanism can be used legitimately. Analysts can dismiss the alert if the administrator is aware of the activity and it is done with proper approval.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- If the involved host is not the Exchange server, isolate the host to prevent further post-compromise behavior.\n- Use the `Remove-MailboxExportRequest` cmdlet to remove fully or partially completed export requests.\n- Prioritize cases that involve personally identifiable information (PII) or other classified data.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Review the privileges of users with the \"Mailbox Import Export\" privilege to ensure that the least privilege principle is being followed.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 210,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Collection",
          "Resources: Investigation Guide",
          "Data Source: PowerShell Logs"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Legitimate exchange system administration activity."
        ],
        "references": [
          "https://www.volexity.com/blog/2020/12/14/dark-halo-leverages-solarwinds-compromise-to-breach-organizations/",
          "https://docs.microsoft.com/en-us/powershell/module/exchange/new-mailboxexportrequest?view=exchange-ps",
          "https://www.elastic.co/security-labs/siestagraph-new-implant-uncovered-in-asean-member-foreign-ministry"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0009",
              "name": "Collection",
              "reference": "https://attack.mitre.org/tactics/TA0009/"
            },
            "technique": [
              {
                "id": "T1005",
                "name": "Data from Local System",
                "reference": "https://attack.mitre.org/techniques/T1005/"
              },
              {
                "id": "T1114",
                "name": "Email Collection",
                "reference": "https://attack.mitre.org/techniques/T1114/",
                "subtechnique": [
                  {
                    "id": "T1114.001",
                    "name": "Local Email Collection",
                    "reference": "https://attack.mitre.org/techniques/T1114/001/"
                  },
                  {
                    "id": "T1114.002",
                    "name": "Remote Email Collection",
                    "reference": "https://attack.mitre.org/techniques/T1114/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "powershell.file.script_block_text",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "6d76e07f-686c-491a-8d87-321da8dd2c7d",
        "rule_id": "54a81f68-5f2a-421e-8eed-f888278bb712",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:19.475Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:05.922Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-windows.powershell*"
        ],
        "filters": [
          {
            "meta": {
              "negate": true
            },
            "query": {
              "wildcard": {
                "file.path": {
                  "case_insensitive": true,
                  "value": "?:\\\\Users\\\\*\\\\AppData\\\\Roaming\\\\Microsoft\\\\Exchange\\\\RemotePowerShell\\\\*"
                }
              }
            }
          },
          {
            "meta": {
              "negate": true
            },
            "query": {
              "wildcard": {
                "file.path": {
                  "case_insensitive": true,
                  "value": "?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\tmp_????????.???\\\\tmp_????????.???.ps?1"
                }
              }
            }
          },
          {
            "meta": {
              "negate": true
            },
            "query": {
              "wildcard": {
                "file.path": {
                  "case_insensitive": true,
                  "value": "?:\\\\Windows\\\\TEMP\\\\tmp_????????.???\\\\tmp_????????.???.ps?1"
                }
              }
            }
          }
        ],
        "query": "event.category:process and host.os.type:windows and\n  powershell.file.script_block_text : \"New-MailboxExportRequest\"",
        "language": "kuery"
      },
      {
        "name": "Attempts to Brute Force an Okta User Account",
        "description": "Identifies when an Okta user account is locked out 3 times within a 3 hour window. An adversary may attempt a brute force or password spraying attack to obtain unauthorized access to user accounts. The default Okta authentication policy ensures that a user account is locked out after 10 failed authentication attempts.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Attempts to Brute Force an Okta User Account\n\nBrute force attacks aim to guess user credentials through exhaustive trial-and-error attempts. In this context, Okta accounts are targeted.\n\nThis rule fires when an Okta user account has been locked out 3 times within a 3-hour window. This could indicate an attempted brute force or password spraying attack to gain unauthorized access to the user account. Okta's default authentication policy locks a user account after 10 failed authentication attempts.\n\n#### Possible investigation steps:\n\n- Identify the actor related to the alert by reviewing `okta.actor.alternate_id` field in the alert. This should give the username of the account being targeted.\n- Review the `okta.event_type` field to understand the nature of the events that led to the account lockout.\n- Check the `okta.severity` and `okta.display_message` fields for more context around the lockout events.\n- Look for correlation of events from the same IP address. Multiple lockouts from the same IP address might indicate a single source for the attack.\n- If the IP is not familiar, investigate it. The IP could be a proxy, VPN, Tor node, cloud datacenter, or a legitimate IP turned malicious.\n- Determine if the lockout events occurred during the user's regular activity hours. Unusual timing may indicate malicious activity.\n- Examine the authentication methods used during the lockout events by checking the `okta.authentication_context.credential_type` field.\n\n### False positive analysis:\n\n- Determine whether the account owner or an internal user made repeated mistakes in entering their credentials, leading to the account lockout.\n- Ensure there are no known network or application issues that might cause these events.\n\n### Response and remediation:\n\n- Alert the user and your IT department immediately.\n- If unauthorized access is confirmed, initiate your incident response process.\n- Investigate the source of the attack. If a specific machine or network is compromised, additional steps may need to be taken to address the issue.\n- Require the affected user to change their password.\n- If the attack is ongoing, consider blocking the IP address initiating the brute force attack.\n- Implement account lockout policies to limit the impact of brute force attacks.\n- Encourage users to use complex, unique passwords and consider implementing multi-factor authentication.\n- Check if the compromised account was used to access or alter any sensitive data or systems.",
        "output_index": "",
        "version": 412,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Data Source: Okta",
          "Tactic: Credential Access"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-10800s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic",
          "@BenB196",
          "Austin Songer"
        ],
        "false_positives": [],
        "references": [
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1110",
                "name": "Brute Force",
                "reference": "https://attack.mitre.org/techniques/T1110/"
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "796ff9ff-67e1-4caf-b1ac-4fd214d67383",
        "rule_id": "e08ccd49-0380-4b2b-8d71-8000377d6e49",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:19.514Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:07.019Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "threshold",
        "query": "event.dataset:okta.system and event.action:user.account.lock",
        "threshold": {
          "field": [
            "okta.actor.alternate_id"
          ],
          "value": 3
        },
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Suspicious .NET Reflection via PowerShell",
        "description": "Detects the use of Reflection.Assembly to load PEs and DLLs in memory in PowerShell scripts. Attackers use this method to load executables and DLLs without writing to the disk, bypassing security solutions.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Suspicious .NET Reflection via PowerShell\n\nPowerShell is one of the main tools system administrators use for automation, report routines, and other tasks. This makes it available for use in various environments, and creates an attractive way for attackers to execute code.\n\nAttackers can use .NET reflection to load PEs and DLLs in memory. These payloads are commonly embedded in the script, which can circumvent file-based security protections.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Examine the script content that triggered the detection; look for suspicious DLL imports, collection or exfiltration capabilities, suspicious functions, encoded or compressed data, and other potentially malicious characteristics.\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Examine file or network events from the involved PowerShell process for suspicious behavior.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Evaluate whether the user needs to use PowerShell to complete tasks.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the script using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately outside engineering or IT business units. As long as the analyst did not identify malware or suspicious activity related to the user or host, this alert can be dismissed.\n\n### Related rules\n\n- PowerShell PSReflect Script - 56f2e9b5-4803-4e44-a0a4-a52dc79d57fe\n- Potential Process Injection via PowerShell - 2e29e96a-b67c-455a-afe4-de6183431d0d\n- PowerShell Suspicious Payload Encoded and Compressed - 81fe9dc6-a2d7-4192-a2d8-eed98afc766a\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Restrict PowerShell usage outside of IT and engineering business units using GPOs, AppLocker, Intune, or similar software.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 316,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Tactic: Execution",
          "Resources: Investigation Guide",
          "Data Source: PowerShell Logs"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://docs.microsoft.com/en-us/dotnet/api/system.reflection.assembly.load"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1620",
                "name": "Reflective Code Loading",
                "reference": "https://attack.mitre.org/techniques/T1620/"
              },
              {
                "id": "T1055",
                "name": "Process Injection",
                "reference": "https://attack.mitre.org/techniques/T1055/",
                "subtechnique": [
                  {
                    "id": "T1055.001",
                    "name": "Dynamic-link Library Injection",
                    "reference": "https://attack.mitre.org/techniques/T1055/001/"
                  },
                  {
                    "id": "T1055.002",
                    "name": "Portable Executable Injection",
                    "reference": "https://attack.mitre.org/techniques/T1055/002/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'PowerShell Script Block Logging' logging policy must be enabled.\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nAdministrative Templates >\nWindows PowerShell >\nTurn on PowerShell Script Block Logging (Enable)\n```\n\nSteps to implement the logging policy via registry:\n\n```\nreg add \"hklm\\SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\ScriptBlockLogging\" /v EnableScriptBlockLogging /t REG_DWORD /d 1\n```\n",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "powershell.file.script_block_text",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "d6472200-7b39-4beb-ab84-86b91ca5c8be",
        "rule_id": "e26f042e-c590-4e82-8e05-41e81bd822ad",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:19.520Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:04.196Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-windows.powershell*"
        ],
        "filters": [
          {
            "meta": {
              "negate": true
            },
            "query": {
              "wildcard": {
                "file.path": {
                  "case_insensitive": true,
                  "value": "C:\\\\Program Files\\\\Microsoft Monitoring Agent\\\\Agent\\\\Health Service State\\\\Monitoring Host Temporary Files*\\\\AvailabilityGroupMonitoring.ps1"
                }
              }
            }
          }
        ],
        "query": "event.category:process and host.os.type:windows and\n  powershell.file.script_block_text : (\n    \"[System.Reflection.Assembly]::Load\" or\n    \"[Reflection.Assembly]::Load\"\n  ) and\n  not powershell.file.script_block_text : (\n        (\"CommonWorkflowParameters\" or \"RelatedLinksHelpInfo\") and\n        \"HelpDisplayStrings\"\n  ) and\n  not (powershell.file.script_block_text :\n        (\"Get-SolutionFiles\" or \"Get-VisualStudio\" or \"Select-MSBuildPath\") and\n        file.name : \"PathFunctions.ps1\"\n  ) and\n  not powershell.file.script_block_text : (\n        \"Microsoft.PowerShell.Workflow.ServiceCore\" and \"ExtractPluginProperties([string]$pluginDir\"\n  ) and \n  \n  not powershell.file.script_block_text : (\"reflection.assembly]::Load('System.\" or \"LoadWithPartialName('Microsoft.\" or \"::Load(\\\"Microsoft.\" or \"Microsoft.Build.Utilities.Core.dll\") and \n  \n  not user.id : \"S-1-5-18\"",
        "language": "kuery"
      },
      {
        "name": "System Network Connections Discovery",
        "description": "Adversaries may attempt to get a listing of network connections to or from a compromised system.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 3,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "OS: macOS",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Rule Type: BBR",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame",
          "Data Source: Auditd Manager"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1049",
                "name": "System Network Connections Discovery",
                "reference": "https://attack.mitre.org/techniques/T1049/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "auditd_manager",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "4b54b5a3-d551-4129-bd2a-14addf9a622c",
        "rule_id": "e2dc8f8c-5f16-42fa-b49e-0eb8057f7444",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:19.522Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:17.268Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where event.type == \"start\" and event.action in (\"exec\", \"exec_event\", \"executed\", \"process_started\") and\nprocess.name in (\"netstat\", \"lsof\", \"who\", \"w\")",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*",
          "auditbeat-*",
          "logs-auditd_manager.auditd-*"
        ],
        "filters": []
      },
      {
        "name": "Attempt to Modify an Okta Network Zone",
        "description": "Detects attempts to modify an Okta network zone. Okta network zones can be configured to limit or restrict access to a network based on IP addresses or geolocations. An adversary may attempt to modify, delete, or deactivate an Okta network zone in order to remove or weaken an organization's security controls.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Attempt to Modify an Okta Network Zone\n\nThe modification of an Okta network zone is a critical event as it could potentially allow an adversary to gain unrestricted access to your network. This rule detects attempts to modify, delete, or deactivate an Okta network zone, which may suggest an attempt to remove or weaken an organization's security controls.\n\n#### Possible investigation steps:\n\n- Identify the actor related to the alert by reviewing `okta.actor.id`, `okta.actor.type`, `okta.actor.alternate_id`, or `okta.actor.display_name` fields in the alert.\n- Review the `okta.client.user_agent.raw_user_agent` field to understand the device and software used by the actor.\n- Examine the `okta.outcome.reason` field for additional context around the modification attempt.\n- Check the `okta.outcome.result` field to confirm the network zone modification attempt.\n- Check if there are multiple network zone modification attempts from the same actor or IP address (`okta.client.ip`).\n- Check for successful logins immediately following the modification attempt.\n- Verify whether the actor's activity aligns with typical behavior or if any unusual activity took place around the time of the modification attempt.\n\n### False positive analysis:\n\n- Check if there were issues with the Okta system at the time of the modification attempt. This could indicate a system error rather than a genuine threat activity.\n- Check the geographical location (`okta.request.ip_chain.geographical_context`) and time of the modification attempt. If these match the actor's normal behavior, it might be a false positive.\n- Verify the actor's administrative rights to ensure they are correctly configured.\n\n### Response and remediation:\n\n- If unauthorized modification is confirmed, initiate the incident response process.\n- Immediately lock the affected actor account and require a password change.\n- Consider resetting MFA tokens for the actor and require re-enrollment.\n- Check if the compromised account was used to access or alter any sensitive data or systems.\n- If a specific modification technique was used, ensure your systems are patched or configured to prevent such techniques.\n- Assess the criticality of affected services and servers.\n- Work with your IT team to minimize the impact on users and maintain business continuity.\n- If multiple accounts are affected, consider a broader reset or audit of MFA tokens.\n- Implement security best practices [outlined](https://www.okta.com/blog/2019/10/9-admin-best-practices-to-keep-your-org-secure/) by Okta.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).",
        "output_index": "",
        "version": 410,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Data Source: Okta",
          "Use Case: Network Security Monitoring",
          "Tactic: Defense Evasion"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Consider adding exceptions to this rule to filter false positives if Oyour organization's Okta network zones are regularly modified."
        ],
        "references": [
          "https://help.okta.com/en/prod/Content/Topics/Security/network/network-zones.htm",
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.007",
                    "name": "Disable or Modify Cloud Firewall",
                    "reference": "https://attack.mitre.org/techniques/T1562/007/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "5bce8207-7f3e-43af-a9ec-630368d7c338",
        "rule_id": "e48236ca-b67a-4b4e-840c-fdc7782bc0c3",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:19.528Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:07.023Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset:okta.system and event.action:(zone.update or network_zone.rule.disabled or zone.remove_blacklist)",
        "language": "kuery"
      },
      {
        "name": "High Number of Okta User Password Reset or Unlock Attempts",
        "description": "Identifies a high number of Okta user password reset or account unlock attempts. An adversary may attempt to obtain unauthorized access to Okta user accounts using these methods and attempt to blend in with normal activity in their target's environment and evade detection.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating High Number of Okta User Password Reset or Unlock Attempts\n\nThis rule is designed to detect a suspiciously high number of password reset or account unlock attempts in Okta. Excessive password resets or account unlocks can be indicative of an attacker's attempt to gain unauthorized access to an account.\n\n#### Possible investigation steps:\n- Identify the actor associated with the excessive attempts. The `okta.actor.alternate_id` field can be used for this purpose.\n- Determine the client used by the actor. You can look at `okta.client.device`, `okta.client.ip`, `okta.client.user_agent.raw_user_agent`, `okta.client.ip_chain.ip`, and `okta.client.geographical_context`.\n- Review the `okta.outcome.result` and `okta.outcome.reason` fields to understand the outcome of the password reset or unlock attempts.\n- Review the event actions associated with these attempts. Look at the `event.action` field and filter for actions related to password reset and account unlock attempts.\n- Check for other similar patterns of behavior from the same actor or IP address. If there is a high number of failed login attempts before the password reset or unlock attempts, this may suggest a brute force attack.\n- Also, look at the times when these attempts were made. If these were made during off-hours, it could further suggest an adversary's activity.\n\n### False positive analysis:\n- This alert might be a false positive if there are legitimate reasons for a high number of password reset or unlock attempts. This could be due to the user forgetting their password or account lockouts due to too many incorrect attempts.\n- Check the actor's past behavior. If this is their usual behavior and they have a valid reason for it, then it might be a false positive.\n\n### Response and remediation:\n- If unauthorized attempts are confirmed, initiate the incident response process.\n- Reset the user's password and enforce MFA re-enrollment, if applicable.\n- Block the IP address or device used in the attempts, if they appear suspicious.\n- If the attack was facilitated by a particular technique, ensure your systems are patched or configured to prevent such techniques.\n- Consider a security review of your Okta policies and rules to ensure they follow security best practices.",
        "output_index": "",
        "version": 412,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Data Source: Okta",
          "Tactic: Defense Evasion"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-3600s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic",
          "@BenB196",
          "Austin Songer"
        ],
        "false_positives": [
          "The number of Okta user password reset or account unlock attempts will likely vary between organizations. To fit this rule to their organization, users can duplicate this rule and edit the schedule and threshold values in the new rule."
        ],
        "references": [
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1078",
                "name": "Valid Accounts",
                "reference": "https://attack.mitre.org/techniques/T1078/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1078",
                "name": "Valid Accounts",
                "reference": "https://attack.mitre.org/techniques/T1078/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1078",
                "name": "Valid Accounts",
                "reference": "https://attack.mitre.org/techniques/T1078/"
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "c1ea013b-4806-4aa7-9ba6-18f8f5a5148f",
        "rule_id": "e90ee3af-45fc-432e-a850-4a58cf14a457",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:19.533Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:07.027Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "threshold",
        "query": "event.dataset:okta.system and\n  event.action:(system.email.account_unlock.sent_message or system.email.password_reset.sent_message or\n                system.sms.send_account_unlock_message or system.sms.send_password_reset_message or\n                system.voice.send_account_unlock_call or system.voice.send_password_reset_call or\n                user.account.unlock_token)",
        "threshold": {
          "field": [
            "okta.actor.alternate_id"
          ],
          "value": 5
        },
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "PowerShell Kerberos Ticket Request",
        "description": "Detects PowerShell scripts that have the capability of requesting kerberos tickets, which is a common step in Kerberoasting toolkits to crack service accounts.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating PowerShell Kerberos Ticket Request\n\nPowerShell is one of the main tools system administrators use for automation, report routines, and other tasks, making it available for use in various environments, creating an attractive way for attackers to execute code.\n\nAccounts associated with a service principal name (SPN) are viable targets for Kerberoasting attacks, which use brute force to crack the user password, which is used to encrypt a Kerberos TGS ticket.\n\nAttackers can use PowerShell to request these Kerberos tickets, with the intent of extracting them from memory to perform Kerberoasting.\n\n#### Possible investigation steps\n\n- Examine the script content that triggered the detection; look for suspicious DLL imports, collection or exfiltration capabilities, suspicious functions, encoded or compressed data, and other potentially malicious characteristics.\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate if the script was executed, and if so, which account was targeted.\n- Validate if the account has an SPN associated with it.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Check if the script has any other functionality that can be potentially malicious.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Review event ID [4769](https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4769) related to this account and service name for additional information.\n\n### False positive analysis\n\n- A possible false positive can be identified if the script content is not malicious/harmful or does not request Kerberos tickets for user accounts, as computer accounts are not vulnerable to Kerberoasting due to complex password requirements and policy.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services. Prioritize privileged accounts.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 213,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Resources: Investigation Guide",
          "Data Source: PowerShell Logs"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://cobalt.io/blog/kerberoast-attack-techniques",
          "https://github.com/EmpireProject/Empire/blob/master/data/module_source/credentials/Invoke-Kerberoast.ps1"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1003",
                "name": "OS Credential Dumping",
                "reference": "https://attack.mitre.org/techniques/T1003/"
              },
              {
                "id": "T1558",
                "name": "Steal or Forge Kerberos Tickets",
                "reference": "https://attack.mitre.org/techniques/T1558/",
                "subtechnique": [
                  {
                    "id": "T1558.003",
                    "name": "Kerberoasting",
                    "reference": "https://attack.mitre.org/techniques/T1558/003/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'PowerShell Script Block Logging' logging policy must be enabled.\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nAdministrative Templates >\nWindows PowerShell >\nTurn on PowerShell Script Block Logging (Enable)\n```\n\nSteps to implement the logging policy via registry:\n\n```\nreg add \"hklm\\SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\ScriptBlockLogging\" /v EnableScriptBlockLogging /t REG_DWORD /d 1\n```\n",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "powershell.file.script_block_text",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "71a0aa1e-4919-451c-9207-9f38799e48b1",
        "rule_id": "eb610e70-f9e6-4949-82b9-f1c5bcd37c39",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:19.535Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:07.030Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-windows.powershell*"
        ],
        "filters": [],
        "query": "event.category:process and host.os.type:windows and\n  powershell.file.script_block_text : (\n    KerberosRequestorSecurityToken\n  ) and not user.id : (\"S-1-5-18\" or \"S-1-5-20\") and\n  not powershell.file.script_block_text : (\n    (\"sentinelbreakpoints\" and (\"Set-PSBreakpoint\" or \"Set-HookFunctionTabs\")) or\n    (\"function global\" and \"\\\\windows\\\\sentinel\\\\4\")\n  )",
        "language": "kuery"
      },
      {
        "name": "Attempt to Deactivate an Okta Application",
        "description": "Detects attempts to deactivate an Okta application. An adversary may attempt to modify, deactivate, or delete an Okta application in order to weaken an organization's security controls or disrupt their business operations.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Attempt to Deactivate an Okta Application\n\nThis rule detects attempts to deactivate an Okta application. Unauthorized deactivation could lead to disruption of services and pose a significant risk to the organization.\n\n#### Possible investigation steps:\n- Identify the actor associated with the deactivation attempt by examining the `okta.actor.id`, `okta.actor.type`, `okta.actor.alternate_id`, and `okta.actor.display_name` fields.\n- Determine the client used by the actor. Review the `okta.client.ip`, `okta.client.user_agent.raw_user_agent`, `okta.client.zone`, `okta.client.device`, and `okta.client.id` fields.\n- If the client is a device, check the `okta.device.id`, `okta.device.name`, `okta.device.os_platform`, `okta.device.os_version`, and `okta.device.managed` fields.\n- Understand the context of the event from the `okta.debug_context.debug_data` and `okta.authentication_context` fields.\n- Check the `okta.outcome.result` and `okta.outcome.reason` fields to see if the attempt was successful or failed.\n- Review the past activities of the actor involved in this action by checking their previous actions logged in the `okta.target` field.\n- Analyze the `okta.transaction.id` and `okta.transaction.type` fields to understand the context of the transaction.\n- Evaluate the actions that happened just before and after this event in the `okta.event_type` field to help understand the full context of the activity.\n\n### False positive analysis:\n- It might be a false positive if the action was part of a planned activity, performed by an authorized person, or if the `okta.outcome.result` field shows a failure.\n- An unsuccessful attempt might also indicate an authorized user having trouble rather than a malicious activity.\n\n### Response and remediation:\n- If unauthorized deactivation attempts are confirmed, initiate the incident response process.\n- Block the IP address or device used in the attempts if they appear suspicious, using the data from the `okta.client.ip` and `okta.device.id` fields.\n- Reset the user's password and enforce MFA re-enrollment, if applicable.\n- Conduct a review of Okta policies and ensure they are in accordance with security best practices.\n- If the deactivated application was crucial for business operations, coordinate with the relevant team to reactivate it and minimize the impact.",
        "output_index": "",
        "version": 410,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Data Source: Okta",
          "Tactic: Impact"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Consider adding exceptions to this rule to filter false positives if your organization's Okta applications are regularly deactivated and the behavior is expected."
        ],
        "references": [
          "https://help.okta.com/en/prod/Content/Topics/Apps/Apps_Apps.htm",
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0040",
              "name": "Impact",
              "reference": "https://attack.mitre.org/tactics/TA0040/"
            },
            "technique": [
              {
                "id": "T1489",
                "name": "Service Stop",
                "reference": "https://attack.mitre.org/techniques/T1489/"
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "270a022f-0eed-4fe8-934f-b1ad8329f3ba",
        "rule_id": "edb91186-1c7e-4db8-b53e-bfa33a1a0a8a",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:19.540Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:07.034Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset:okta.system and event.action:application.lifecycle.deactivate",
        "language": "kuery"
      },
      {
        "name": "Linux User Account Creation",
        "description": "Identifies attempts to create new users. Attackers may add new users to establish persistence on a system.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Linux User Account Creation\n\nThe `useradd` and `adduser` commands are used to create new user accounts in Linux-based operating systems.\n\nAttackers may create new accounts (both local and domain) to maintain access to victim systems.\n\nThis rule identifies the usage of `useradd` and `adduser` to create new accounts.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n> This investigation guide uses [placeholder fields](https://www.elastic.co/guide/en/security/current/osquery-placeholder-fields.html) to dynamically pass alert data into Osquery queries. Placeholder fields were introduced in Elastic Stack version 8.7.0. If you're using Elastic Stack version 8.6.0 or earlier, you'll need to manually adjust this investigation guide's queries to ensure they properly run.\n\n#### Possible investigation steps\n\n- Investigate whether the user was created succesfully.\n  - !{osquery{\"label\":\"Osquery - Retrieve Information for a Specific User\",\"query\":\"SELECT * FROM users WHERE username = {{user.name}}\"}}\n- Investigate whether the user is currently logged in and active.\n  - !{osquery{\"label\":\"Osquery - Investigate the Account Authentication Status\",\"query\":\"SELECT * FROM logged_in_users WHERE user = {{user.name}}\"}}\n- Identify if the account was added to privileged groups or assigned special privileges after creation.\n  - !{osquery{\"label\":\"Osquery - Retrieve Information for a Specific Group\",\"query\":\"SELECT * FROM groups WHERE groupname = {{group.name}}\"}}\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence and whether they are located in expected locations.\n  - !{osquery{\"label\":\"Osquery - Retrieve Running Processes by User\",\"query\":\"SELECT pid, username, name FROM processes p JOIN users u ON u.uid = p.uid ORDER BY username\"}}\n- Investigate other alerts associated with the user/host during the past 48 hours.\n\n### False positive analysis\n\n- Account creation is a common administrative task, so there is a high chance of the activity being legitimate. Before investigating further, verify that this activity is not benign.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Review the privileges assigned to the involved users to ensure that the least privilege principle is being followed.\n- Delete the created account.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 6,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Resources: Investigation Guide"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/security-labs/primer-on-persistence-mechanisms"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1136",
                "name": "Create Account",
                "reference": "https://attack.mitre.org/techniques/T1136/",
                "subtechnique": [
                  {
                    "id": "T1136.001",
                    "name": "Local Account",
                    "reference": "https://attack.mitre.org/techniques/T1136/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Filebeat.\n\n### Filebeat Setup\nFilebeat is a lightweight shipper for forwarding and centralizing log data. Installed as an agent on your servers, Filebeat monitors the log files or locations that you specify, collects log events, and forwards them either to Elasticsearch or Logstash for indexing.\n\n#### The following steps should be executed in order to add the Filebeat on a Linux System:\n- Elastic provides repositories available for APT and YUM-based distributions. Note that we provide binary packages, but no source packages.\n- To install the APT and YUM repositories follow the setup instructions in this [helper guide](https://www.elastic.co/guide/en/beats/filebeat/current/setup-repositories.html).\n- To run Filebeat on Docker follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/filebeat/current/running-on-docker.html).\n- To run Filebeat on Kubernetes follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/filebeat/current/running-on-kubernetes.html).\n- For quick start information for Filebeat refer to the [helper guide](https://www.elastic.co/guide/en/beats/filebeat/8.11/filebeat-installation-configuration.html).\n- For complete â€œSetup and Run Filebeatâ€ information refer to the [helper guide](https://www.elastic.co/guide/en/beats/filebeat/current/setting-up-and-running.html).\n\n#### Rule Specific Setup Note\n- This rule requires the â€œFilebeat System Moduleâ€ to be enabled.\n- The system module collects and parses logs created by the system logging service of common Unix/Linux based distributions.\n- To run the system module of Filebeat on Linux follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-module-system.html).\n",
        "related_integrations": [
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "3b68377b-a485-4f57-96c7-de12f3f321da",
        "rule_id": "edfd5ca9-9d6c-44d9-b615-1e56b920219c",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:19.546Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:16.360Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "iam where host.os.type == \"linux\" and (event.type == \"user\" and event.type == \"creation\") and\nprocess.name in (\"useradd\", \"adduser\") and user.name != null",
        "language": "eql",
        "index": [
          "filebeat-*",
          "logs-system.auth-*"
        ],
        "filters": []
      },
      {
        "name": "Potential Remote Code Execution via Web Server",
        "description": "Identifies suspicious commands executed via a web server, which may suggest a vulnerability and remote shell access. Attackers may exploit a vulnerability in a web application to execute commands via a web server, or place a backdoor file that can be abused to gain code execution as a mechanism for persistence.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Potential Remote Code Execution via Web Server\n\nAdversaries may backdoor web servers with web shells to establish persistent access to systems. A web shell is a malicious script, often embedded into a compromised web server, that grants an attacker remote access and control over the server. This enables the execution of arbitrary commands, data exfiltration, and further exploitation of the target network.\n\nThis rule detects a web server process spawning script and command line interface programs, potentially indicating attackers executing commands using the web shell.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n> This investigation guide uses [placeholder fields](https://www.elastic.co/guide/en/security/current/osquery-placeholder-fields.html) to dynamically pass alert data into Osquery queries. Placeholder fields were introduced in Elastic Stack version 8.7.0. If you're using Elastic Stack version 8.6.0 or earlier, you'll need to manually adjust this investigation guide's queries to ensure they properly run.\n\n#### Possible investigation steps\n\n- Investigate abnormal behaviors by the subject process such as network connections, file modifications, and any other spawned child processes.\n  - Investigate listening ports and open sockets to look for potential reverse shells or data exfiltration.\n    - !{osquery{\"label\":\"Osquery - Retrieve Listening Ports\",\"query\":\"SELECT pid, address, port, socket, protocol, path FROM listening_ports\"}}\n    - !{osquery{\"label\":\"Osquery - Retrieve Open Sockets\",\"query\":\"SELECT pid, family, remote_address, remote_port, socket, state FROM process_open_sockets\"}}\n  - Investigate the process information for malicious or uncommon processes/process trees.\n    - !{osquery{\"label\":\"Osquery - Retrieve Process Info\",\"query\":\"SELECT name, cmdline, parent, path, uid FROM processes\"}}\n  - Investigate the process tree spawned from the user that is used to run the web application service. A user that is running a web application should not spawn other child processes.\n    - !{osquery{\"label\":\"Osquery - Retrieve Process Info for Webapp User\",\"query\":\"SELECT name, cmdline, parent, path, uid FROM processes WHERE uid = {{process.user.id}}\"}}\n- Examine the command line to determine which commands or scripts were executed.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- If scripts or executables were dropped, retrieve the files and determine if they are malicious:\n  - Use a private sandboxed malware analysis system to perform analysis.\n    - Observe and collect information about the following activities:\n      - Attempts to contact external domains and addresses.\n        - Check if the domain is newly registered or unexpected.\n        - Check the reputation of the domain or IP address.\n      - File access, modification, and creation activities.\n      - Cron jobs, services and other persistence mechanisms.\n        - !{osquery{\"label\":\"Osquery - Retrieve Crontab Information\",\"query\":\"SELECT * FROM crontab\"}}\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Any activity that triggered the alert and is not inherently malicious must be monitored by the security team.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Leverage the incident response data and logging to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 7,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Tactic: Initial Access",
          "Data Source: Elastic Endgame",
          "Use Case: Vulnerability",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Network monitoring or management products may have a web server component that runs shell commands as part of normal behavior."
        ],
        "references": [
          "https://pentestlab.blog/tag/web-shell/",
          "https://www.elastic.co/security-labs/elastic-response-to-the-the-spring4shell-vulnerability-cve-2022-22965"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1505",
                "name": "Server Software Component",
                "reference": "https://attack.mitre.org/techniques/T1505/",
                "subtechnique": [
                  {
                    "id": "T1505.003",
                    "name": "Web Shell",
                    "reference": "https://attack.mitre.org/techniques/T1505/003/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1190",
                "name": "Exploit Public-Facing Application",
                "reference": "https://attack.mitre.org/techniques/T1190/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "4c99ee14-c331-4bb6-8c44-4b33269ee85c",
        "rule_id": "f16fca20-4d6c-43f9-aec1-20b6de3b0aeb",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:19.548Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:07.037Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and\nevent.action in (\"exec\", \"exec_event\") and process.parent.executable : (\n  \"/usr/sbin/nginx\", \"/usr/local/sbin/nginx\",\n  \"/usr/sbin/apache\", \"/usr/local/sbin/apache\",\n  \"/usr/sbin/apache2\", \"/usr/local/sbin/apache2\",\n  \"/usr/sbin/php*\", \"/usr/local/sbin/php*\",\n  \"/usr/sbin/lighttpd\", \"/usr/local/sbin/lighttpd\",\n  \"/usr/sbin/hiawatha\", \"/usr/local/sbin/hiawatha\",\n  \"/usr/local/bin/caddy\", \n  \"/usr/local/lsws/bin/lswsctrl\",\n  \"*/bin/catalina.sh\"\n) and\nprocess.name : (\n  \"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\", \"python*\", \"php*\", \"perl\", \"ruby\", \"lua*\", \"openssl\", \"nc\",\n  \"netcat\", \"ncat\", \"telnet\", \"awk\", \"socat\"\n  ) and process.args : (\n  \"whoami\", \"id\", \"uname\", \"cat\", \"hostname\", \"ip\", \"curl\", \"wget\", \"pwd\", \"ls\", \"cd\", \"python*\", \"php*\", \"perl\",\n  \"ruby\", \"lua*\", \"openssl\", \"nc\", \"netcat\", \"ncat\", \"telnet\", \"awk\", \"socat\"\n  ) and not process.name == \"phpquery\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "Threat Intel URL Indicator Match",
        "description": "This rule is triggered when a URL indicator from the Threat Intel Filebeat module or integrations has a match against an event that contains URL data, like DNS events, network logs, etc.",
        "risk_score": 99,
        "severity": "critical",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "timeline_id": "495ad7a7-316e-4544-8a0f-9c098daee76e",
        "timeline_title": "Generic Threat Match Timeline",
        "license": "Elastic License v2",
        "note": "## Triage and Analysis\n\n### Investigating Threat Intel URL Indicator Match\n\nThreat Intel indicator match rules allow matching from a local observation, such as an endpoint event that records a file hash with an entry of a file hash stored within the Threat Intel integrations index.\n\nMatches are based on threat intelligence data that's been ingested during the last 30 days. Some integrations don't place expiration dates on their threat indicators, so we strongly recommend validating ingested threat indicators and reviewing match results. When reviewing match results, check associated activity to determine whether the event requires additional investigation.\n\nThis rule is triggered when a URL indicator from the Threat Intel Filebeat module or a threat intelligence integration matches against an event that contains URL data, like DNS events, network logs, etc.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the URL, which can be found in the `threat.indicator.matched.atomic` field:\n  - Identify the type of malicious activity related to the URL (phishing, malware, etc.).\n  - Check the reputation of the IP address in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n  - Execute a WHOIS lookup to retrieve information about the domain registration and contacts to report abuse.\n  - If dealing with a phishing incident:\n    - Contact the user to gain more information around the delivery method, information sent, etc.\n    - Analyze whether the URL is trying to impersonate a legitimate address. Look for typosquatting, extra or unusual subdomains, or other anomalies that could lure the user.\n    - Investigate the phishing page to identify which information may have been sent to the attacker by the user.\n- Identify the process responsible for the connection, and investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Retrieve the involved process executable and examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the process executable using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n- Using the data collected through the analysis, scope users targeted and other machines infected in the environment.\n\n### False Positive Analysis\n\n- False positives might occur after large and publicly written campaigns if curious employees interact with attacker infrastructure.\n- Some feeds may include internal or known benign addresses by mistake (e.g., 8.8.8.8, google.com, 127.0.0.1, etc.). Make sure you understand how blocking a specific domain or address might impact the organization or normal system functioning.\n\n### Response and Remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Consider reporting the address for abuse using the provided contact information.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 7,
        "tags": [
          "OS: Windows",
          "Data Source: Elastic Endgame",
          "Rule Type: Threat Match"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "1h",
        "from": "now-3900s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-module-threatintel.html",
          "https://www.elastic.co/guide/en/security/master/es-threat-intel-integrations.html",
          "https://www.elastic.co/security/tip"
        ],
        "max_signals": 100,
        "threat": [],
        "setup": "## Setup\n\nThis rule needs threat intelligence indicators to work.\nThreat intelligence indicators can be collected using an [Elastic Agent integration](https://www.elastic.co/guide/en/security/current/es-threat-intel-integrations.html#agent-ti-integration),\nthe [Threat Intel module](https://www.elastic.co/guide/en/security/current/es-threat-intel-integrations.html#ti-mod-integration),\nor a [custom integration](https://www.elastic.co/guide/en/security/current/es-threat-intel-integrations.html#custom-ti-integration).\n\nMore information can be found [here](https://www.elastic.co/guide/en/security/current/es-threat-intel-integrations.html).\n",
        "related_integrations": [],
        "required_fields": [
          {
            "name": "url.full",
            "type": "wildcard",
            "ecs": true
          }
        ],
        "id": "9bfbef37-535d-4198-8fb7-668e6e26e5bf",
        "rule_id": "f3e22c8b-ea47-45d1-b502-b57b6de950b3",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:19.553Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:16.367Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "threat_match",
        "query": "url.full:*",
        "threat_query": "@timestamp >= \"now-30d/d\" and event.module:(threatintel or ti_*) and threat.indicator.url.full:* and not labels.is_ioc_transform_source:\"true\"",
        "threat_mapping": [
          {
            "entries": [
              {
                "field": "url.full",
                "type": "mapping",
                "value": "threat.indicator.url.full"
              }
            ]
          },
          {
            "entries": [
              {
                "field": "url.original",
                "type": "mapping",
                "value": "threat.indicator.url.original"
              }
            ]
          }
        ],
        "threat_index": [
          "filebeat-*",
          "logs-ti_*"
        ],
        "index": [
          "auditbeat-*",
          "endgame-*",
          "filebeat-*",
          "logs-*",
          "packetbeat-*",
          "winlogbeat-*"
        ],
        "filters": [],
        "threat_filters": [
          {
            "$state": {
              "store": "appState"
            },
            "meta": {
              "disabled": false,
              "key": "event.category",
              "negate": false,
              "params": {
                "query": "threat"
              },
              "type": "phrase"
            },
            "query": {
              "match_phrase": {
                "event.category": "threat"
              }
            }
          },
          {
            "$state": {
              "store": "appState"
            },
            "meta": {
              "disabled": false,
              "key": "event.kind",
              "negate": false,
              "params": {
                "query": "enrichment"
              },
              "type": "phrase"
            },
            "query": {
              "match_phrase": {
                "event.kind": "enrichment"
              }
            }
          },
          {
            "$state": {
              "store": "appState"
            },
            "meta": {
              "disabled": false,
              "key": "event.type",
              "negate": false,
              "params": {
                "query": "indicator"
              },
              "type": "phrase"
            },
            "query": {
              "match_phrase": {
                "event.type": "indicator"
              }
            }
          }
        ],
        "threat_indicator_path": "threat.indicator",
        "threat_language": "kuery",
        "language": "kuery"
      },
      {
        "name": "File or Directory Deletion Command",
        "description": "This rule identifies the execution of commands that can be used to delete files and directories. Adversaries may delete files and directories on a host system, such as logs, browser history, or malware.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 3,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Rule Type: BBR",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1070",
                "name": "Indicator Removal",
                "reference": "https://attack.mitre.org/techniques/T1070/",
                "subtechnique": [
                  {
                    "id": "T1070.004",
                    "name": "File Deletion",
                    "reference": "https://attack.mitre.org/techniques/T1070/004/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "c5d69c59-5a41-400c-a39b-bcfd355a5f4f",
        "rule_id": "5919988c-29e1-4908-83aa-1f087a838f63",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:19.558Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:17.174Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and \n(\n  (process.name: \"rundll32.exe\" and process.args: \"*InetCpl.cpl,Clear*\") or \n  (process.name: \"reg.exe\" and process.args:\"delete\") or \n  (\n    process.name: \"cmd.exe\" and process.args: (\"*rmdir*\", \"*rm *\", \"rm\") and\n    not process.args : (\n          \"*\\\\AppData\\\\Local\\\\Microsoft\\\\OneDrive\\\\*\",\n          \"*\\\\AppData\\\\Local\\\\Temp\\\\DockerDesktop\\\\*\",\n          \"*\\\\AppData\\\\Local\\\\Temp\\\\Report.*\",\n          \"*\\\\AppData\\\\Local\\\\Temp\\\\*.PackageExtraction\"\n    )\n  ) or\n  (process.name: \"powershell.exe\" and process.args: (\"*rmdir\", \"rm\", \"rd\", \"*Remove-Item*\", \"del\", \"*]::Delete(*\"))\n) and not user.id : \"S-1-5-18\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*"
        ],
        "filters": []
      },
      {
        "name": "Potential Reverse Shell via Java",
        "description": "This detection rule identifies the execution of a Linux shell process from a Java JAR application post an incoming network connection. This behavior may indicate reverse shell activity via a Java application.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 8,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Reverse%20Shell%20Cheatsheet.md"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.004",
                    "name": "Unix Shell",
                    "reference": "https://attack.mitre.org/techniques/T1059/004/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            },
            "technique": [
              {
                "id": "T1071",
                "name": "Application Layer Protocol",
                "reference": "https://attack.mitre.org/techniques/T1071/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "9d1e2e84-0ffe-4e30-a7cb-83d0806cdc36",
        "rule_id": "5a3d5447-31c9-409a-aed1-72f9921594fd",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:19.560Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:10.094Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by host.id with maxspan=5s\n  [network where host.os.type == \"linux\" and event.action in (\"connection_accepted\", \"connection_attempted\") and \n   process.executable : (\"/usr/bin/java\", \"/bin/java\", \"/usr/lib/jvm/*\", \"/usr/java/*\") and \n   not (destination.ip == null or destination.ip == \"0.0.0.0\" or cidrmatch(\n     destination.ip, \"10.0.0.0/8\", \"127.0.0.0/8\", \"169.254.0.0/16\", \"172.16.0.0/12\", \"192.0.0.0/24\", \"192.0.0.0/29\",\n     \"192.0.0.8/32\", \"192.0.0.9/32\", \"192.0.0.10/32\", \"192.0.0.170/32\", \"192.0.0.171/32\", \"192.0.2.0/24\",\n     \"192.31.196.0/24\", \"192.52.193.0/24\", \"192.168.0.0/16\", \"192.88.99.0/24\", \"224.0.0.0/4\", \"100.64.0.0/10\",\n     \"192.175.48.0/24\",\"198.18.0.0/15\", \"198.51.100.0/24\", \"203.0.113.0/24\", \"240.0.0.0/4\", \"::1\", \"FE80::/10\",\n     \"FF00::/8\"\n    )\n  )] by process.entity_id\n  [process where host.os.type == \"linux\" and event.action == \"exec\" and \n   process.parent.executable : (\"/usr/bin/java\", \"/bin/java\", \"/usr/lib/jvm/*\", \"/usr/java/*\") and\n   process.parent.args : \"-jar\" and process.name in (\"bash\", \"dash\", \"ash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\")\n   and not process.parent.args in (\n     \"/usr/share/java/jenkins.war\", \"/etc/remote-iot/services/remoteiot.jar\",\n     \"/usr/lib64/NetExtender.jar\", \"/usr/lib/jenkins/jenkins.war\"\n   )] by process.parent.entity_id",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Potential Secure File Deletion via SDelete Utility",
        "description": "Detects file name patterns generated by the use of Sysinternals SDelete utility to securely delete a file via multiple file overwrite and rename operations.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Potential Secure File Deletion via SDelete Utility\n\nSDelete is a tool primarily used for securely deleting data from storage devices, making it unrecoverable. Microsoft develops it as part of the Sysinternals Suite. Although commonly used to delete data securely, attackers can abuse it to delete forensic indicators and remove files as a post-action to a destructive action such as ransomware or data theft to hinder recovery efforts.\n\nThis rule identifies file name patterns generated by the use of SDelete utility to securely delete a file via multiple file overwrite and rename operations.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Examine the command line and identify the files deleted, their importance and whether they could be the target of antiforensics activity.\n\n### False positive analysis\n\n- This is a dual-use tool, meaning its usage is not inherently malicious. Analysts can dismiss the alert if the administrator is aware of the activity, no other suspicious activity was identified, and there are justifications for the execution.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n  - Prioritize cases involving critical servers and users.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- If important data was encrypted, deleted, or modified, activate your data recovery plan.\n    - Perform data recovery locally or restore the backups from replicated copies (cloud, other servers, etc.).\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Review the privileges assigned to the user to ensure that the least privilege principle is being followed.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 309,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Tactic: Impact",
          "Data Source: Elastic Endgame",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: SentinelOne"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1070",
                "name": "Indicator Removal",
                "reference": "https://attack.mitre.org/techniques/T1070/",
                "subtechnique": [
                  {
                    "id": "T1070.004",
                    "name": "File Deletion",
                    "reference": "https://attack.mitre.org/techniques/T1070/004/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0040",
              "name": "Impact",
              "reference": "https://attack.mitre.org/tactics/TA0040/"
            },
            "technique": [
              {
                "id": "T1485",
                "name": "Data Destruction",
                "reference": "https://attack.mitre.org/techniques/T1485/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "7c33ea27-32e4-4bea-95ff-4d2a2e7cccfd",
        "rule_id": "5aee924b-6ceb-4633-980e-1bde8cdb40c5",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:19.566Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:05.939Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"windows\" and event.type == \"change\" and file.name : \"*AAA.AAA\"",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.file-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*"
        ],
        "filters": []
      },
      {
        "name": "PowerShell Suspicious Discovery Related Windows API Functions",
        "description": "This rule detects the use of discovery-related Windows API functions in PowerShell Scripts. Attackers can use these functions to perform various situational awareness related activities, like enumerating users, shares, sessions, domain trusts, groups, etc.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating PowerShell Suspicious Discovery Related Windows API Functions\n\nPowerShell is one of the main tools system administrators use for automation, report routines, and other tasks. This makes it available for use in various environments, and creates an attractive way for attackers to execute code.\n\nAttackers can use PowerShell to interact with the Win32 API to bypass command line based detections, using libraries like PSReflect or Get-ProcAddress Cmdlet.\n\n#### Possible investigation steps\n\n- Examine the script content that triggered the detection; look for suspicious DLL imports, collection or exfiltration capabilities, suspicious functions, encoded or compressed data, and other potentially malicious characteristics.\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Examine file or network events from the involved PowerShell process for suspicious behavior.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Evaluate whether the user needs to use PowerShell to complete tasks.\n- Check for additional PowerShell and command-line logs that indicate that imported functions were run.\n\n### False positive analysis\n\n- Discovery activities themselves are not inherently malicious if occurring in isolation, as long as the script does not contain other capabilities, and there are no other alerts related to the user or host; such alerts can be dismissed. However, analysts should keep in mind that this is not a common way of getting information, making it suspicious.\n\n### Related rules\n\n- PowerShell PSReflect Script - 56f2e9b5-4803-4e44-a0a4-a52dc79d57fe\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Restrict PowerShell usage outside of IT and engineering business units using GPOs, AppLocker, Intune, or similar software.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 316,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Tactic: Collection",
          "Tactic: Execution",
          "Resources: Investigation Guide",
          "Data Source: PowerShell Logs"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Legitimate PowerShell scripts that make use of these functions."
        ],
        "references": [
          "https://github.com/BC-SECURITY/Empire/blob/9259e5106986847d2bb770c4289c0c0f1adf2344/data/module_source/situational_awareness/network/powerview.ps1#L21413",
          "https://github.com/atc-project/atc-data/blob/master/docs/Logging_Policies/LP_0109_windows_powershell_script_block_log.md"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1069",
                "name": "Permission Groups Discovery",
                "reference": "https://attack.mitre.org/techniques/T1069/",
                "subtechnique": [
                  {
                    "id": "T1069.001",
                    "name": "Local Groups",
                    "reference": "https://attack.mitre.org/techniques/T1069/001/"
                  }
                ]
              },
              {
                "id": "T1087",
                "name": "Account Discovery",
                "reference": "https://attack.mitre.org/techniques/T1087/",
                "subtechnique": [
                  {
                    "id": "T1087.001",
                    "name": "Local Account",
                    "reference": "https://attack.mitre.org/techniques/T1087/001/"
                  }
                ]
              },
              {
                "id": "T1482",
                "name": "Domain Trust Discovery",
                "reference": "https://attack.mitre.org/techniques/T1482/"
              },
              {
                "id": "T1135",
                "name": "Network Share Discovery",
                "reference": "https://attack.mitre.org/techniques/T1135/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              },
              {
                "id": "T1106",
                "name": "Native API",
                "reference": "https://attack.mitre.org/techniques/T1106/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0009",
              "name": "Collection",
              "reference": "https://attack.mitre.org/tactics/TA0009/"
            },
            "technique": [
              {
                "id": "T1039",
                "name": "Data from Network Shared Drive",
                "reference": "https://attack.mitre.org/techniques/T1039/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'PowerShell Script Block Logging' logging policy must be enabled.\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nAdministrative Templates >\nWindows PowerShell >\nTurn on PowerShell Script Block Logging (Enable)\n```\n\nSteps to implement the logging policy via registry:\n\n```\nreg add \"hklm\\SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\ScriptBlockLogging\" /v EnableScriptBlockLogging /t REG_DWORD /d 1\n```\n",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "powershell.file.script_block_text",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "67d8e0df-e0f9-4369-bd45-5d153e12917e",
        "rule_id": "61ac3638-40a3-44b2-855a-985636ca985e",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:19.573Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:04.134Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-windows.powershell*"
        ],
        "filters": [
          {
            "meta": {
              "negate": true
            },
            "query": {
              "wildcard": {
                "file.path": {
                  "case_insensitive": true,
                  "value": "?:\\\\ProgramData\\\\Microsoft\\\\Windows Defender Advanced Threat Protection\\\\DataCollection\\\\*"
                }
              }
            }
          }
        ],
        "query": "event.category:process and host.os.type:windows and\n  powershell.file.script_block_text : (\n    NetShareEnum or\n    NetWkstaUserEnum or\n    NetSessionEnum or\n    NetLocalGroupEnum or\n    NetLocalGroupGetMembers or\n    DsGetSiteName or\n    DsEnumerateDomainTrusts or\n    WTSEnumerateSessionsEx or\n    WTSQuerySessionInformation or\n    LsaGetLogonSessionData or\n    QueryServiceObjectSecurity or\n    GetComputerNameEx or\n    NetWkstaGetInfo or\n    GetUserNameEx or\n    NetUserEnum or\n    NetUserGetInfo or\n    NetGroupEnum or\n    NetGroupGetInfo or\n    NetGroupGetUsers or\n    NetWkstaTransportEnum or\n    NetServerGetInfo or\n    LsaEnumerateTrustedDomains  or\n    NetScheduleJobEnum or\n    NetUserModalsGet\n  ) and\n  not powershell.file.script_block_text : (\n    (\"DsGetSiteName\" and (\"DiscoverWindowsComputerProperties.ps1\" and \"param($SourceType, $SourceId, $ManagedEntityId, $ComputerIdentity)\")) or\n    (\"# Copyright: (c) 2018, Ansible Project\" and \"#Requires -Module Ansible.ModuleUtils.AddType\" and \"#AnsibleRequires -CSharpUtil Ansible.Basic\") or\n    (\"Ansible.Windows.Setup\" and \"Ansible.Windows.Setup\" and \"NativeMethods.NetWkstaGetInfo(null, 100, out netBuffer);\")\n  )",
        "language": "kuery"
      },
      {
        "name": "Potential Non-Standard Port HTTP/HTTPS connection",
        "description": "Identifies potentially malicious processes communicating via a port paring typically not associated with HTTP/HTTPS. For example, HTTP over port 8443 or port 440 as opposed to the traditional port 80 , 443. Adversaries may make changes to the standard port a protocol uses to bypass filtering or muddle analysis/parsing of network data.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Potential Non-Standard Port HTTP/HTTPS connection\n\nAttackers may alter standard protocol ports, like using HTTP on port 8443 instead of 80, to bypass network filtering and complicate network data analysis. \n\nThis rule looks for HTTP/HTTPS processes where the destination port is not any of the default 80/443 HTTP/HTTPS ports. \n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n> This investigation guide uses [placeholder fields](https://www.elastic.co/guide/en/security/current/osquery-placeholder-fields.html) to dynamically pass alert data into Osquery queries. Placeholder fields were introduced in Elastic Stack version 8.7.0. If you're using Elastic Stack version 8.6.0 or earlier, you'll need to manually adjust this investigation guide's queries to ensure they properly run.\n\n#### Possible investigation steps\n\n- Identify any signs of suspicious network activity or anomalies that may indicate command and control activity or data exfiltration. This could include unexpected traffic patterns or unusual network behavior.\n  - Investigate listening ports and open sockets to look for potential suspicious network traffic, reverse shells or data exfiltration.\n    - !{osquery{\"label\":\"Osquery - Retrieve Listening Ports\",\"query\":\"SELECT pid, address, port, socket, protocol, path FROM listening_ports\"}}\n    - !{osquery{\"label\":\"Osquery - Retrieve Open Sockets\",\"query\":\"SELECT pid, family, remote_address, remote_port, socket, state FROM process_open_sockets\"}}\n- Identify the user account that performed the action, analyze it, and check whether it should perform this kind of action.\n  - !{osquery{\"label\":\"Osquery - Retrieve Information for a Specific User\",\"query\":\"SELECT * FROM users WHERE username = {{user.name}}\"}}\n- Investigate whether the user is currently logged in and active.\n  - !{osquery{\"label\":\"Osquery - Investigate the Account Authentication Status\",\"query\":\"SELECT * FROM logged_in_users WHERE user = {{user.name}}\"}}\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence and whether they are located in expected locations.\n  - !{osquery{\"label\":\"Osquery - Retrieve Running Processes by User\",\"query\":\"SELECT pid, username, name FROM processes p JOIN users u ON u.uid = p.uid ORDER BY username\"}}\n  - !{osquery{\"label\":\"Osquery - Retrieve Process Info\",\"query\":\"SELECT name, cmdline, parent, path, uid FROM processes\"}}\n- Investigate other alerts associated with the user/host during the past 48 hours.\n  - If scripts or executables were dropped, retrieve the files and determine if they are malicious:\n    - Use a private sandboxed malware analysis system to perform analysis.\n      - Observe and collect information about the following activities:\n        - Attempts to contact external domains and addresses.\n          - Check if the domain is newly registered or unexpected.\n          - Check the reputation of the domain or IP address.\n        - File access, modification, and creation activities.\n\n### Related rules\n\n- Suspicious Network Activity to the Internet by Previously Unknown Executable - 53617418-17b4-4e9c-8a2c-8deb8086ca4b\n\n### False positive analysis\n\n- If this activity is related to new benign software installation activity, consider adding exceptions â€” preferably with a combination of user and command line conditions.\n- Try to understand the context of the execution by thinking about the user, machine, or business purpose. A small number of endpoints, such as servers with unique software, might appear unusual but satisfy a specific business need.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors, such as reverse shells, reverse proxies, or droppers, that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Leverage the incident response data and logging to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "building_block_type": "default",
        "output_index": "",
        "version": 5,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "OS: macOS",
          "Use Case: Threat Detection",
          "Tactic: Command and Control",
          "Rule Type: BBR",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            },
            "technique": [
              {
                "id": "T1071",
                "name": "Application Layer Protocol",
                "reference": "https://attack.mitre.org/techniques/T1071/",
                "subtechnique": [
                  {
                    "id": "T1071.001",
                    "name": "Web Protocols",
                    "reference": "https://attack.mitre.org/techniques/T1071/001/"
                  }
                ]
              },
              {
                "id": "T1571",
                "name": "Non-Standard Port",
                "reference": "https://attack.mitre.org/techniques/T1571/"
              },
              {
                "id": "T1573",
                "name": "Encrypted Channel",
                "reference": "https://attack.mitre.org/techniques/T1573/",
                "subtechnique": [
                  {
                    "id": "T1573.001",
                    "name": "Symmetric Cryptography",
                    "reference": "https://attack.mitre.org/techniques/T1573/001/"
                  },
                  {
                    "id": "T1573.002",
                    "name": "Asymmetric Cryptography",
                    "reference": "https://attack.mitre.org/techniques/T1573/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "destination.port",
            "type": "long",
            "ecs": true
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "24334459-fba1-4e05-943e-c492831c0cd5",
        "rule_id": "62b68eb2-1e47-4da7-85b6-8f478db5b272",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:19.579Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:17.181Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "network where process.name : (\"http\", \"https\") and destination.port not in (80, 443) and event.action in (\n  \"connection_attempted\", \"ipv4_connection_attempt_event\", \"connection_accepted\", \"ipv4_connection_accept_event\"\n) and destination.ip != \"127.0.0.1\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "FirstTime Seen Account Performing DCSync",
        "description": "This rule identifies when a User Account starts the Active Directory Replication Process for the first time. Attackers can use the DCSync technique to get credential information of individual accounts or the entire domain, thus compromising the entire domain.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating FirstTime Seen Account Performing DCSync\n\nActive Directory replication is the process by which the changes that originate on one domain controller are automatically transferred to other domain controllers that store the same data.\n\nActive Directory data consists of objects that have properties, or attributes. Each object is an instance of an object class, and object classes and their respective attributes are defined in the Active Directory schema. Objects are defined by the values of their attributes, and changes to attribute values must be transferred from the domain controller on which they occur to every other domain controller that stores a replica of an affected object.\n\nAdversaries can use the DCSync technique that uses Windows Domain Controller's API to simulate the replication process from a remote domain controller, compromising major credential material such as the Kerberos krbtgt keys that are used legitimately for creating tickets, but also for forging tickets by attackers. This attack requires some extended privileges to succeed (DS-Replication-Get-Changes and DS-Replication-Get-Changes-All), which are granted by default to members of the Administrators, Domain Admins, Enterprise Admins, and Domain Controllers groups. Privileged accounts can be abused to grant controlled objects the right to DCsync/Replicate.\n\nMore details can be found on [Threat Hunter Playbook](https://threathunterplaybook.com/library/windows/active_directory_replication.html?highlight=dcsync#directory-replication-services-auditing) and [The Hacker Recipes](https://www.thehacker.recipes/ad/movement/credentials/dumping/dcsync).\n\nThis rule monitors for when a Windows Event ID 4662 (Operation was performed on an Active Directory object) with the access mask 0x100 (Control Access) and properties that contain at least one of the following or their equivalent Schema-Id-GUID (DS-Replication-Get-Changes, DS-Replication-Get-Changes-All, DS-Replication-Get-Changes-In-Filtered-Set) is seen in the environment for the first time in the last 15 days.\n\n#### Possible investigation steps\n\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account and system owners and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Correlate security events 4662 and 4624 (Logon Type 3) by their Logon ID (`winlog.logon.id`) on the Domain Controller (DC) that received the replication request. This will tell you where the AD replication request came from, and if it came from another DC or not.\n- Scope which credentials were compromised (for example, whether all accounts were replicated or specific ones).\n\n### False positive analysis\n\n- Administrators may use custom accounts on Azure AD Connect; investigate if this is part of a new Azure AD account setup, and ensure it is properly secured. If the activity was expected and there is no other suspicious activity involving the host or user, the analyst can dismiss the alert.\n- Although replicating Active Directory (AD) data to non-Domain Controllers is not a common practice and is generally not recommended from a security perspective, some software vendors may require it for their products to function correctly. Investigate if this is part of a new product setup, and ensure it is properly secured. If the activity was expected and there is no other suspicious activity involving the host or user, the analyst can dismiss the alert.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- If the entire domain or the `krbtgt` user was compromised:\n  - Activate your incident response plan for total Active Directory compromise which should include, but not be limited to, a password reset (twice) of the `krbtgt` user.\n- Investigate how the attacker escalated privileges and identify systems they used to conduct lateral movement. Use this information to determine ways the attacker could regain access to the environment.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 113,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Tactic: Privilege Escalation",
          "Use Case: Active Directory Monitoring",
          "Data Source: Active Directory",
          "Resources: Investigation Guide",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://threathunterplaybook.com/notebooks/windows/06_credential_access/WIN-180815210510.html",
          "https://threathunterplaybook.com/library/windows/active_directory_replication.html?highlight=dcsync#directory-replication-services-auditing",
          "https://github.com/SigmaHQ/sigma/blob/master/rules/windows/builtin/security/win_ad_replication_non_machine_account.yml",
          "https://github.com/atc-project/atomic-threat-coverage/blob/master/Atomic_Threat_Coverage/Logging_Policies/LP_0027_windows_audit_directory_service_access.md",
          "https://attack.stealthbits.com/privilege-escalation-using-mimikatz-dcsync",
          "https://www.thehacker.recipes/ad/movement/credentials/dumping/dcsync"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1003",
                "name": "OS Credential Dumping",
                "reference": "https://attack.mitre.org/techniques/T1003/",
                "subtechnique": [
                  {
                    "id": "T1003.006",
                    "name": "DCSync",
                    "reference": "https://attack.mitre.org/techniques/T1003/006/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1078",
                "name": "Valid Accounts",
                "reference": "https://attack.mitre.org/techniques/T1078/",
                "subtechnique": [
                  {
                    "id": "T1078.002",
                    "name": "Domain Accounts",
                    "reference": "https://attack.mitre.org/techniques/T1078/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'Audit Directory Service Access' logging policy must be configured for (Success, Failure).\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nPolicies >\nWindows Settings >\nSecurity Settings >\nAdvanced Audit Policies Configuration >\nAudit Policies >\nDS Access >\nAudit Directory Service Access (Success,Failure)\n```\n",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.code",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.event_data.Properties",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "winlog.event_data.SubjectUserName",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "ad2db03d-10cf-4ab3-82e4-717ec91fc6ba",
        "rule_id": "5c6f4c58-b381-452a-8976-f1b1c6aa0def",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:19.571Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:04.127Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "event.action:(\"Directory Service Access\" or \"object-operation-performed\") and event.code:\"4662\" and\n winlog.event_data.Properties:(*DS-Replication-Get-Changes* or *DS-Replication-Get-Changes-All* or\n                               *DS-Replication-Get-Changes-In-Filtered-Set* or *1131f6ad-9c07-11d1-f79f-00c04fc2dcd2* or\n                               *1131f6aa-9c07-11d1-f79f-00c04fc2dcd2* or *89e95b76-444d-4c62-991a-0facbeda640c*) and\n not winlog.event_data.SubjectUserName:(*$ or MSOL_*)",
        "new_terms_fields": [
          "winlog.event_data.SubjectUserName"
        ],
        "history_window_start": "now-15d",
        "index": [
          "winlogbeat-*",
          "logs-system.*",
          "logs-windows.*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Kubernetes Anonymous Request Authorized",
        "description": "This rule detects when an unauthenticated user request is authorized within the cluster. Attackers may attempt to use anonymous accounts to gain initial access to the cluster or to avoid attribution of their activities within the cluster. This rule excludes the /healthz, /livez and /readyz endpoints which are commonly accessed anonymously.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 6,
        "tags": [
          "Data Source: Kubernetes",
          "Tactic: Execution",
          "Tactic: Initial Access",
          "Tactic: Defense Evasion"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Anonymous access to the API server is a dangerous setting enabled by default. Common anonymous connections (e.g., health checks) have been excluded from this rule. All other instances of authorized anonymous requests should be investigated."
        ],
        "references": [
          "https://media.defense.gov/2022/Aug/29/2003066362/-1/-1/0/CTR_KUBERNETES_HARDENING_GUIDANCE_1.2_20220829.PDF"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1078",
                "name": "Valid Accounts",
                "reference": "https://attack.mitre.org/techniques/T1078/",
                "subtechnique": [
                  {
                    "id": "T1078.001",
                    "name": "Default Accounts",
                    "reference": "https://attack.mitre.org/techniques/T1078/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The Kubernetes Fleet integration with Audit Logs enabled or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "kubernetes",
            "version": "^1.4.1"
          }
        ],
        "required_fields": [
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "kubernetes.audit.annotations.authorization_k8s_io/decision",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "kubernetes.audit.requestURI",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "kubernetes.audit.user.username",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "b1855997-1b2c-4c06-bb00-14fe3e33da30",
        "rule_id": "63c057cc-339a-11ed-a261-0242ac120002",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:19.584Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:05.952Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "logs-kubernetes.*"
        ],
        "filters": [],
        "query": "event.dataset:kubernetes.audit_logs\n  and kubernetes.audit.annotations.authorization_k8s_io/decision:allow\n  and kubernetes.audit.user.username:(\"system:anonymous\" or \"system:unauthenticated\" or not *)\n  and not kubernetes.audit.requestURI:(/healthz* or /livez* or /readyz*)",
        "language": "kuery"
      },
      {
        "name": "Attempt to Modify an Okta Policy",
        "description": "Detects attempts to modify an Okta policy. An adversary may attempt to modify an Okta policy in order to weaken an organization's security controls. For example, an adversary may attempt to modify an Okta multi-factor authentication (MFA) policy in order to weaken the authentication requirements for user accounts.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Attempt to Modify an Okta Policy\n\nModifications to Okta policies may indicate attempts to weaken an organization's security controls. If such an attempt is detected, consider the following steps for investigation.\n\n#### Possible investigation steps:\n- Identify the actor associated with the event. Check the fields `okta.actor.id`, `okta.actor.type`, `okta.actor.alternate_id`, and `okta.actor.display_name`.\n- Determine the client used by the actor. You can look at `okta.client.device`, `okta.client.ip`, `okta.client.user_agent.raw_user_agent`, `okta.client.ip_chain.ip`, and `okta.client.geographical_context`.\n- Check the nature of the policy modification. You can review the `okta.target` field, especially `okta.target.display_name` and `okta.target.id`.\n- Examine the `okta.outcome.result` and `okta.outcome.reason` fields to understand the outcome of the modification attempt.\n- Check if there have been other similar modification attempts in a short time span from the same actor or IP address.\n\n### False positive analysis:\n- This alert might be a false positive if Okta policies are regularly updated in your organization as a part of normal operations.\n- Check if the actor associated with the event has legitimate rights to modify the Okta policies.\n- Verify the actor's geographical location and the time of the modification attempt. If these align with the actor's regular behavior, it could be a false positive.\n\n### Response and remediation:\n- If unauthorized modification is confirmed, initiate the incident response process.\n- Lock the actor's account and enforce password change as an immediate response.\n- Reset MFA tokens for the actor and enforce re-enrollment, if applicable.\n- Review any other actions taken by the actor to assess the overall impact.\n- If the attack was facilitated by a particular technique, ensure your systems are patched or configured to prevent such techniques.\n- Consider a security review of your Okta policies and rules to ensure they follow security best practices.",
        "output_index": "",
        "version": 410,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Data Source: Okta",
          "Tactic: Defense Evasion"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Consider adding exceptions to this rule to filter false positives if Okta policies are regularly modified in your organization."
        ],
        "references": [
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.007",
                    "name": "Disable or Modify Cloud Firewall",
                    "reference": "https://attack.mitre.org/techniques/T1562/007/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "7ba79536-6583-4ca7-8c58-991702b3fe02",
        "rule_id": "6731fbf2-8f28-49ed-9ab9-9a918ceb5a45",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:19.586Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:05.974Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset:okta.system and event.action:policy.lifecycle.update",
        "language": "kuery"
      },
      {
        "name": "Attempt to Revoke Okta API Token",
        "description": "Identifies attempts to revoke an Okta API token. An adversary may attempt to revoke or delete an Okta API token to disrupt an organization's business operations.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Attempt to Revoke Okta API Token\n\nThe rule alerts when attempts are made to revoke an Okta API token. The API tokens are critical for integration services, and revoking them may lead to disruption in services. Therefore, it's important to validate these activities.\n\n#### Possible investigation steps:\n- Identify the actor associated with the API token revocation attempt. You can use the `okta.actor.alternate_id` field for this purpose.\n- Determine the client used by the actor. Review the `okta.client.device`, `okta.client.ip`, `okta.client.user_agent.raw_user_agent`, `okta.client.ip_chain.ip`, and `okta.client.geographical_context` fields.\n- Verify if the API token revocation was authorized or part of some planned activity.\n- Check the `okta.outcome.result` and `okta.outcome.reason` fields to see if the attempt was successful or failed.\n- Analyze the past activities of the actor involved in this action. An actor who usually performs such activities may indicate a legitimate reason.\n- Evaluate the actions that happened just before and after this event. It can help understand the full context of the activity.\n\n### False positive analysis:\n- It might be a false positive if the action was part of a planned activity or was performed by an authorized person.\n\n### Response and remediation:\n- If unauthorized revocation attempts are confirmed, initiate the incident response process.\n- Block the IP address or device used in the attempts, if they appear suspicious.\n- Reset the user's password and enforce MFA re-enrollment, if applicable.\n- Conduct a review of Okta policies and ensure they are in accordance with security best practices.\n- If the revoked token was used for critical integrations, coordinate with the relevant team to minimize the impact.",
        "output_index": "",
        "version": 410,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Data Source: Okta",
          "Tactic: Impact"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "If the behavior of revoking Okta API tokens is expected, consider adding exceptions to this rule to filter false positives."
        ],
        "references": [
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0040",
              "name": "Impact",
              "reference": "https://attack.mitre.org/tactics/TA0040/"
            },
            "technique": [
              {
                "id": "T1531",
                "name": "Account Access Removal",
                "reference": "https://attack.mitre.org/techniques/T1531/"
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "58f3cfe5-45f7-4484-88b7-4a5d9aed00ff",
        "rule_id": "676cff2b-450b-4cf1-8ed2-c0c58a4a2dd7",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:19.592Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:05.977Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset:okta.system and event.action:system.api_token.revoke",
        "language": "kuery"
      },
      {
        "name": "First Time Seen Commonly Abused Remote Access Tool Execution",
        "description": "Adversaries may install legitimate remote access tools (RAT) to compromised endpoints for further command-and-control (C2). Adversaries can rely on installed RATs for persistence, execution of native commands and more. This rule detects when a process is started whose name or code signature resembles commonly abused RATs. This is a New Terms rule type indicating the host has not seen this RAT process started before within the last 30 days.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating First Time Seen Commonly Abused Remote Access Tool Execution\n\nRemote access software is a class of tools commonly used by IT departments to provide support by connecting securely to users' computers. Remote access is an ever-growing market where new companies constantly offer new ways of quickly accessing remote systems.\n\nAt the same pace as IT departments adopt these tools, the attackers also adopt them as part of their workflow to connect into an interactive session, maintain access with legitimate software as a persistence mechanism, drop malicious software, etc.\n\nThis rule detects when a remote access tool is seen in the environment for the first time in the last 15 days, enabling analysts to investigate and enforce the correct usage of such tools.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Check if the execution of the remote access tool is approved by the organization's IT department.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Contact the account owner and confirm whether they are aware of this activity.\n  - If the tool is not approved for use in the organization, the employee could have been tricked into installing it and providing access to a malicious third party. Investigate whether this third party could be attempting to scam the end-user or gain access to the environment through social engineering.\n- Investigate any abnormal behavior by the subject process, such as network connections, registry or file modifications, and any spawned child processes.\n\n### False positive analysis\n\n- If an authorized support person or administrator used the tool to conduct legitimate support or remote access, consider reinforcing that only tooling approved by the IT policy should be used. The analyst can dismiss the alert if no other suspicious behavior is observed involving the host or users.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Run a full scan using the antimalware tool in place. This scan can reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- If an unauthorized third party did the access via social engineering, consider improvements to the security awareness program.\n- Enforce that only tooling approved by the IT policy should be used for remote access purposes and only by authorized staff.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 108,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Command and Control",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://thedfirreport.com/2023/04/03/malicious-iso-file-leads-to-domain-wide-ransomware/",
          "https://attack.mitre.org/techniques/T1219/",
          "https://github.com/redcanaryco/surveyor/blob/master/definitions/remote-admin.json"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            },
            "technique": [
              {
                "id": "T1219",
                "name": "Remote Access Software",
                "reference": "https://attack.mitre.org/techniques/T1219/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.code_signature.subject_name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name.caseless",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "df4b5fd3-c211-48f9-ab5d-efa5f33bf94b",
        "rule_id": "6e1a2cc4-d260-11ed-8829-f661ea17fbcc",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:19.597Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:05.990Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "host.os.type: \"windows\" and\n\n   event.category: \"process\" and event.type : \"start\" and\n\n    (\n        process.code_signature.subject_name : (\n            \"Action1 Corporation\" or\n            \"AeroAdmin LLC\" or\n            \"Ammyy LLC\" or\n            \"Atera Networks Ltd\" or\n            \"AWERAY PTE. LTD.\" or\n            \"BeamYourScreen GmbH\" or\n            \"Bomgar Corporation\" or\n            \"DUC FABULOUS CO.,LTD\" or\n            \"DOMOTZ INC.\" or\n            \"DWSNET OÃœ\" or\n            \"FleetDeck Inc\" or\n            \"GlavSoft LLC\" or\n            \"GlavSoft LLC.\" or\n            \"Hefei Pingbo Network Technology Co. Ltd\" or\n            \"IDrive, Inc.\" or\n            \"IMPERO SOLUTIONS LIMITED\" or\n            \"Instant Housecall\" or\n            \"ISL Online Ltd.\" or\n            \"LogMeIn, Inc.\" or\n            \"Monitoring Client\" or\n            \"MMSOFT Design Ltd.\" or\n            \"Nanosystems S.r.l.\" or\n            \"NetSupport Ltd\" or\n            \"NinjaRMM, LLC\" or\n            \"Parallels International GmbH\" or\n            \"philandro Software GmbH\" or\n            \"Pro Softnet Corporation\" or\n            \"RealVNC\" or\n            \"RealVNC Limited\" or\n            \"BreakingSecurity.net\" or\n            \"Remote Utilities LLC\" or\n            \"Rocket Software, Inc.\" or\n            \"SAFIB\" or\n            \"Servably, Inc.\" or\n            \"ShowMyPC INC\" or\n            \"Splashtop Inc.\" or\n            \"Superops Inc.\" or\n            \"TeamViewer\" or\n            \"TeamViewer GmbH\" or\n            \"TeamViewer Germany GmbH\" or\n            \"Techinline Limited\" or\n            \"uvnc bvba\" or\n            \"Yakhnovets Denis Aleksandrovich IP\" or\n            \"Zhou Huabing\"\n        ) or\n\n        process.name.caseless : (\n            AA_v*.exe or\n            \"AeroAdmin.exe\" or\n            \"AnyDesk.exe\" or\n            \"apc_Admin.exe\" or\n            \"apc_host.exe\" or\n            \"AteraAgent.exe\" or\n            aweray_remote*.exe or\n            \"AweSun.exe\" or\n            \"B4-Service.exe\" or\n            \"BASupSrvc.exe\" or\n            \"bomgar-scc.exe\" or\n            \"domotzagent.exe\" or\n            \"domotz-windows-x64-10.exe\" or\n            \"dwagsvc.exe\" or\n            \"DWRCC.exe\" or\n            \"ImperoClientSVC.exe\" or\n            \"ImperoServerSVC.exe\" or\n            \"ISLLight.exe\" or\n            \"ISLLightClient.exe\" or\n            fleetdeck_commander*.exe or\n            \"getscreen.exe\" or\n            \"LMIIgnition.exe\" or\n            \"LogMeIn.exe\" or\n            \"ManageEngine_Remote_Access_Plus.exe\" or\n            \"Mikogo-Service.exe\" or\n            \"NinjaRMMAgent.exe\" or\n            \"NinjaRMMAgenPatcher.exe\" or\n            \"ninjarmm-cli.exe\" or\n            \"r_server.exe\" or\n            \"radmin.exe\" or\n            \"radmin3.exe\" or\n            \"RCClient.exe\" or\n            \"RCService.exe\" or\n            \"RemoteDesktopManager.exe\" or\n            \"RemotePC.exe\" or\n            \"RemotePCDesktop.exe\" or\n            \"RemotePCService.exe\" or\n            \"rfusclient.exe\" or\n            \"ROMServer.exe\" or\n            \"ROMViewer.exe\" or\n            \"RPCSuite.exe\" or\n            \"rserver3.exe\" or\n            \"rustdesk.exe\" or\n            \"rutserv.exe\" or\n            \"rutview.exe\" or\n            \"saazapsc.exe\" or\n            ScreenConnect*.exe or\n            \"smpcview.exe\" or\n            \"spclink.exe\" or\n            \"Splashtop-streamer.exe\" or\n            \"SRService.exe\" or\n            \"strwinclt.exe\" or\n            \"Supremo.exe\" or\n            \"SupremoService.exe\" or\n            \"teamviewer.exe\" or\n            \"TiClientCore.exe\" or\n            \"TSClient.exe\" or\n            \"tvn.exe\" or\n            \"tvnserver.exe\" or\n            \"tvnviewer.exe\" or\n            UltraVNC*.exe or\n            UltraViewer*.exe or\n            \"vncserver.exe\" or\n            \"vncviewer.exe\" or\n            \"winvnc.exe\" or\n            \"winwvc.exe\" or\n            \"Zaservice.exe\" or\n            \"ZohoURS.exe\"\n        ) or\n        process.name : (\n            AA_v*.exe or\n            \"AeroAdmin.exe\" or\n            \"AnyDesk.exe\" or\n            \"apc_Admin.exe\" or\n            \"apc_host.exe\" or\n            \"AteraAgent.exe\" or\n            aweray_remote*.exe or\n            \"AweSun.exe\" or\n            \"B4-Service.exe\" or\n            \"BASupSrvc.exe\" or\n            \"bomgar-scc.exe\" or\n            \"domotzagent.exe\" or\n            \"domotz-windows-x64-10.exe\" or\n            \"dwagsvc.exe\" or\n            \"DWRCC.exe\" or\n            \"ImperoClientSVC.exe\" or\n            \"ImperoServerSVC.exe\" or\n            \"ISLLight.exe\" or\n            \"ISLLightClient.exe\" or\n            fleetdeck_commander*.exe or\n            \"getscreen.exe\" or\n            \"LMIIgnition.exe\" or\n            \"LogMeIn.exe\" or\n            \"ManageEngine_Remote_Access_Plus.exe\" or\n            \"Mikogo-Service.exe\" or\n            \"NinjaRMMAgent.exe\" or\n            \"NinjaRMMAgenPatcher.exe\" or\n            \"ninjarmm-cli.exe\" or\n            \"r_server.exe\" or\n            \"radmin.exe\" or\n            \"radmin3.exe\" or\n            \"RCClient.exe\" or\n            \"RCService.exe\" or\n            \"RemoteDesktopManager.exe\" or\n            \"RemotePC.exe\" or\n            \"RemotePCDesktop.exe\" or\n            \"RemotePCService.exe\" or\n            \"rfusclient.exe\" or\n            \"ROMServer.exe\" or\n            \"ROMViewer.exe\" or\n            \"RPCSuite.exe\" or\n            \"rserver3.exe\" or\n            \"rustdesk.exe\" or\n            \"rutserv.exe\" or\n            \"rutview.exe\" or\n            \"saazapsc.exe\" or\n            ScreenConnect*.exe or\n            \"smpcview.exe\" or\n            \"spclink.exe\" or\n            \"Splashtop-streamer.exe\" or\n            \"SRService.exe\" or\n            \"strwinclt.exe\" or\n            \"Supremo.exe\" or\n            \"SupremoService.exe\" or\n            \"teamviewer.exe\" or\n            \"TiClientCore.exe\" or\n            \"TSClient.exe\" or\n            \"tvn.exe\" or\n            \"tvnserver.exe\" or\n            \"tvnviewer.exe\" or\n            UltraVNC*.exe or\n            UltraViewer*.exe or\n            \"vncserver.exe\" or\n            \"vncviewer.exe\" or\n            \"winvnc.exe\" or\n            \"winwvc.exe\" or\n            \"Zaservice.exe\" or\n            \"ZohoURS.exe\"\n        )\n\t) and\n\n\tnot (process.pe.original_file_name : (\"G2M.exe\" or \"Updater.exe\" or \"powershell.exe\") and process.code_signature.subject_name : \"LogMeIn, Inc.\")",
        "new_terms_fields": [
          "host.id"
        ],
        "history_window_start": "now-15d",
        "index": [
          "logs-endpoint.events.process-*",
          "endgame-*",
          "winlogbeat-*",
          "logs-windows.*",
          "logs-system.security*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Unusual File Creation - Alternate Data Stream",
        "description": "Identifies suspicious creation of Alternate Data Streams on highly targeted files. This is uncommon for legitimate files and sometimes done by adversaries to hide malware.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Unusual File Creation - Alternate Data Stream\n\nAlternate Data Streams (ADS) are file attributes only found on the NTFS file system. In this file system, files are built up from a couple of attributes; one of them is $Data, also known as the data attribute.\n\nThe regular data stream, also referred to as the unnamed data stream since the name string of this attribute is empty, contains the data inside the file. So any data stream that has a name is considered an alternate data stream.\n\nAttackers can abuse these alternate data streams to hide malicious files, string payloads, etc. This rule detects the creation of alternate data streams on highly targeted file types.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Retrieve the contents of the alternate data stream, and analyze it for potential maliciousness. Analysts can use the following PowerShell cmdlet to accomplish this:\n  - `Get-Content C:\\Path\\To\\file.exe -stream SampleAlternateDataStreamName`\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate any abnormal behavior by the subject process such as network connections, registry or file modifications, and any spawned child processes.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the process executable using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n\n### False positive analysis\n\n- If this activity is expected and noisy in your environment, consider adding exceptions â€” preferably with a combination of process executable and file conditions.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 315,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: SentinelOne",
          "Data Source: Elastic Endgame"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1564",
                "name": "Hide Artifacts",
                "reference": "https://attack.mitre.org/techniques/T1564/",
                "subtechnique": [
                  {
                    "id": "T1564.004",
                    "name": "NTFS File Attributes",
                    "reference": "https://attack.mitre.org/techniques/T1564/004/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "689416e8-36d8-48e4-9c36-6b227d936500",
        "rule_id": "71bccb61-e19b-452f-b104-79a60e546a95",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:19.599Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:04.032Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"windows\" and event.type == \"creation\" and\n\n  file.path : \"C:\\\\*:*\" and\n  not file.path : \n          (\"C:\\\\*:zone.identifier*\",\n           \"C:\\\\users\\\\*\\\\appdata\\\\roaming\\\\microsoft\\\\teams\\\\old_weblogs_*:$DATA\",\n           \"C:\\\\Windows\\\\CSC\\\\*:CscBitmapStream\") and\n\n  not process.executable : (\n          \"?:\\\\Program Files (x86)\\\\Dropbox\\\\Client\\\\Dropbox.exe\",\n          \"?:\\\\Program Files (x86)\\\\Google\\\\Chrome\\\\Application\\\\chrome.exe\",\n          \"?:\\\\Program Files (x86)\\\\Microsoft Office\\\\root\\\\*\\\\EXCEL.EXE\",\n          \"?:\\\\Program Files (x86)\\\\Microsoft Office\\\\root\\\\*\\\\OUTLOOK.EXE\",\n          \"?:\\\\Program Files (x86)\\\\Microsoft Office\\\\root\\\\*\\\\POWERPNT.EXE\",\n          \"?:\\\\Program Files (x86)\\\\Microsoft Office\\\\root\\\\*\\\\WINWORD.EXE\",\n          \"?:\\\\Program Files (x86)\\\\Microsoft\\\\Edge\\\\Application\\\\msedge.exe\",\n          \"?:\\\\Program Files\\\\ExpressConnect\\\\ExpressConnectNetworkService.exe\",\n          \"?:\\\\Program Files\\\\Google\\\\Chrome\\\\Application\\\\chrome.exe\",\n          \"?:\\\\Program Files\\\\Microsoft Office\\\\root\\\\*\\\\EXCEL.EXE\",\n          \"?:\\\\Program Files\\\\Microsoft Office\\\\root\\\\*\\\\OUTLOOK.EXE\",\n          \"?:\\\\Program Files\\\\Microsoft Office\\\\root\\\\*\\\\POWERPNT.EXE\",\n          \"?:\\\\Program Files\\\\Microsoft Office\\\\root\\\\*\\\\WINWORD.EXE\",\n          \"?:\\\\Program Files\\\\Mozilla Firefox\\\\firefox.exe\",\n          \"?:\\\\Program Files\\\\Rivet Networks\\\\SmartByte\\\\SmartByteNetworkService.exe\",\n          \"?:\\\\Windows\\\\explorer.exe\",\n          \"?:\\\\Windows\\\\System32\\\\DataExchangeHost.exe\",\n          \"?:\\\\Windows\\\\System32\\\\drivers\\\\Intel\\\\ICPS\\\\IntelConnectivityNetworkService.exe\",\n          \"?:\\\\Windows\\\\System32\\\\drivers\\\\RivetNetworks\\\\Killer\\\\KillerNetworkService.exe\",\n          \"?:\\\\Windows\\\\System32\\\\inetsrv\\\\w3wp.exe\",\n          \"?:\\\\Windows\\\\System32\\\\PickerHost.exe\",\n          \"?:\\\\Windows\\\\System32\\\\RuntimeBroker.exe\",\n          \"?:\\\\Windows\\\\System32\\\\SearchProtocolHost.exe\",\n          \"?:\\\\Windows\\\\System32\\\\sihost.exe\",\n          \"?:\\\\windows\\\\System32\\\\svchost.exe\"\n  ) and\n\n  file.extension :\n    (\n      \"pdf\", \"dll\", \"exe\", \"dat\", \"com\", \"bat\", \"cmd\", \"sys\", \"vbs\", \"ps1\", \"hta\", \"txt\", \"vbe\", \"js\",\n      \"wsh\", \"docx\", \"doc\", \"xlsx\", \"xls\", \"pptx\", \"ppt\", \"rtf\", \"gif\", \"jpg\", \"png\", \"bmp\", \"img\", \"iso\"\n    )",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.file-*",
          "logs-windows.sysmon_operational-*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "Potential Pspy Process Monitoring Detected",
        "description": "This rule leverages auditd to monitor for processes scanning different processes within the /proc directory using the openat syscall. This is a strong indication for the usage of the pspy utility. Attackers may leverage the pspy process monitoring utility to monitor system processes without requiring root permissions, in order to find potential privilege escalation vectors.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 8,
        "tags": [
          "Data Source: Auditd Manager",
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Discovery"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/DominicBreuker/pspy"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1057",
                "name": "Process Discovery",
                "reference": "https://attack.mitre.org/techniques/T1057/"
              },
              {
                "id": "T1082",
                "name": "System Information Discovery",
                "reference": "https://attack.mitre.org/techniques/T1082/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Auditd Manager.\n\n### Auditd Manager Integration Setup\nThe Auditd Manager Integration receives audit events from the Linux Audit Framework which is a part of the Linux kernel.\nAuditd Manager provides a user-friendly interface and automation capabilities for configuring and monitoring system auditing through the auditd daemon. With `auditd_manager`, administrators can easily define audit rules, track system events, and generate comprehensive audit reports, improving overall security and compliance in the system.\n\n#### The following steps should be executed in order to add the Elastic Agent System integration \"auditd_manager\" on a Linux System:\n- Go to the Kibana home page and click â€œAdd integrationsâ€.\n- In the query bar, search for â€œAuditd Managerâ€ and select the integration to see more details about it.\n- Click â€œAdd Auditd Managerâ€.\n- Configure the integration name and optionally add a description.\n- Review optional and advanced settings accordingly.\n- Add the newly installed â€œauditd managerâ€ to an existing or a new agent policy, and deploy the agent on a Linux system from which auditd log files are desirable.\n- Click â€œSave and Continueâ€.\n- For more details on the integration refer to the [helper guide](https://docs.elastic.co/integrations/auditd_manager).\n\n#### Rule Specific Setup Note\nAuditd Manager subscribes to the kernel and receives events as they occur without any additional configuration.\nHowever, if more advanced configuration is required to detect specific behavior, audit rules can be added to the integration in either the \"audit rules\" configuration box or the \"auditd rule files\" box by specifying a file to read the audit rules from.\n- For this detection rule the following additional audit rules are required to be added to the integration:\n  -- \"-w /proc/ -p r -k audit_proc\"\n",
        "related_integrations": [
          {
            "package": "auditd_manager",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "auditd.data.a0",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "auditd.data.a2",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "auditd.data.syscall",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pid",
            "type": "long",
            "ecs": true
          }
        ],
        "id": "76665e20-f570-4ff8-ad9c-13a5485731c6",
        "rule_id": "bdb04043-f0e3-4efa-bdee-7d9d13fa9edc",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:19.609Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:17.231Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by process.pid, host.id with maxspan=5s\n  [file where host.os.type == \"linux\" and auditd.data.syscall == \"openat\" and file.path == \"/proc\" and\n   auditd.data.a0 : (\"ffffffffffffff9c\", \"ffffff9c\") and auditd.data.a2 : (\"80000\", \"88000\") and\n   not process.name == \"agentbeat\"\n  ] with runs=10",
        "language": "eql",
        "index": [
          "logs-auditd_manager.auditd-*"
        ],
        "filters": []
      },
      {
        "name": "PowerShell Keylogging Script",
        "description": "Detects the use of Win32 API Functions that can be used to capture user keystrokes in PowerShell scripts. Attackers use this technique to capture user input, looking for credentials and/or other valuable data.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating PowerShell Keylogging Script\n\nPowerShell is one of the main tools system administrators use for automation, report routines, and other tasks. This makes it available for use in various environments, and creates an attractive way for attackers to execute code.\n\nAttackers can abuse PowerShell capabilities to capture user keystrokes with the goal of stealing credentials and other valuable information as credit card data and confidential conversations.\n\n#### Possible investigation steps\n\n- Examine the script content that triggered the detection; look for suspicious DLL imports, collection or exfiltration capabilities, suspicious functions, encoded or compressed data, and other potentially malicious characteristics.\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Examine file or network events from the involved PowerShell process for suspicious behavior.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Evaluate whether the user needs to use PowerShell to complete tasks.\n- Determine whether the script stores the captured data locally.\n- Investigate whether the script contains exfiltration capabilities and identify the exfiltration server.\n- Assess network data to determine if the host communicated with the exfiltration server.\n\n### False positive analysis\n\n- Regular users do not have a business justification for using scripting utilities to capture keystrokes, making false positives unlikely. In the case of authorized benign true positives (B-TPs), exceptions can be added.\n\n### Related rules\n\n- PowerShell PSReflect Script - 56f2e9b5-4803-4e44-a0a4-a52dc79d57fe\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Prioritize the response if this alert involves key executives or potentially valuable targets for espionage.\n- Restrict PowerShell usage outside of IT and engineering business units using GPOs, AppLocker, Intune, or similar software.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 215,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Collection",
          "Resources: Investigation Guide",
          "Data Source: PowerShell Logs"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/EmpireProject/Empire/blob/master/data/module_source/collection/Get-Keystrokes.ps1",
          "https://github.com/MojtabaTajik/FunnyKeylogger/blob/master/FunnyLogger.ps1"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0009",
              "name": "Collection",
              "reference": "https://attack.mitre.org/tactics/TA0009/"
            },
            "technique": [
              {
                "id": "T1056",
                "name": "Input Capture",
                "reference": "https://attack.mitre.org/techniques/T1056/",
                "subtechnique": [
                  {
                    "id": "T1056.001",
                    "name": "Keylogging",
                    "reference": "https://attack.mitre.org/techniques/T1056/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              },
              {
                "id": "T1106",
                "name": "Native API",
                "reference": "https://attack.mitre.org/techniques/T1106/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'PowerShell Script Block Logging' logging policy must be enabled.\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nAdministrative Templates >\nWindows PowerShell >\nTurn on PowerShell Script Block Logging (Enable)\n```\n\nSteps to implement the logging policy via registry:\n\n```\nreg add \"hklm\\SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\ScriptBlockLogging\" /v EnableScriptBlockLogging /t REG_DWORD /d 1\n```\n",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "powershell.file.script_block_text",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "173f795d-16c2-4d6f-b82a-60cfd995f578",
        "rule_id": "bd2c86a0-8b61-4457-ab38-96943984e889",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:19.604Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:04.176Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-windows.powershell*"
        ],
        "filters": [],
        "query": "event.category:process and host.os.type:windows and\n  (\n   powershell.file.script_block_text : (GetAsyncKeyState or NtUserGetAsyncKeyState or GetKeyboardState or \"Get-Keystrokes\") or\n   powershell.file.script_block_text : (\n        (SetWindowsHookA or SetWindowsHookW or SetWindowsHookEx or SetWindowsHookExA or NtUserSetWindowsHookEx) and\n        (GetForegroundWindow or GetWindowTextA or GetWindowTextW or \"WM_KEYBOARD_LL\" or \"WH_MOUSE_LL\")\n   )\n   ) and not user.id : \"S-1-5-18\"\n  and not powershell.file.script_block_text : (\n    \"sentinelbreakpoints\" and \"Set-PSBreakpoint\"\n  )",
        "language": "kuery"
      },
      {
        "name": "System Owner/User Discovery Linux",
        "description": "Identifies the use of built-in tools which adversaries may use to enumerate the system owner/user of a compromised system.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 3,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Rule Type: BBR",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame",
          "Data Source: Auditd Manager"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1033",
                "name": "System Owner/User Discovery",
                "reference": "https://attack.mitre.org/techniques/T1033/"
              },
              {
                "id": "T1069",
                "name": "Permission Groups Discovery",
                "reference": "https://attack.mitre.org/techniques/T1069/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "auditd_manager",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "f06da985-ee91-4999-a663-90ff77f5f8d8",
        "rule_id": "bf8c007c-7dee-4842-8e9a-ee534c09d205",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:19.611Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:17.235Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where event.type == \"start\" and event.action in (\"exec\", \"exec_event\", \"executed\", \"process_started\") and \nprocess.name : (\"whoami\", \"w\", \"who\", \"users\", \"id\")",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*",
          "auditbeat-*",
          "logs-auditd_manager.auditd-*"
        ],
        "filters": []
      },
      {
        "name": "Windows System Network Connections Discovery",
        "description": "This rule identifies the execution of commands that can be used to enumerate network connections. Adversaries may attempt to get a listing of network connections to or from a compromised system to identify targets within an environment.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 4,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Rule Type: BBR",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1049",
                "name": "System Network Connections Discovery",
                "reference": "https://attack.mitre.org/techniques/T1049/"
              },
              {
                "id": "T1082",
                "name": "System Information Discovery",
                "reference": "https://attack.mitre.org/techniques/T1082/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "725357b4-cac9-45e4-b5af-22ee217e2735",
        "rule_id": "c4e9ed3e-55a2-4309-a012-bc3c78dad10a",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:19.617Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:17.238Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where event.type == \"start\" and\n(\n  process.name : \"netstat.exe\" or\n  (\n   (\n    (process.name : \"net.exe\" or process.pe.original_file_name == \"net.exe\") or\n    (\n     (process.name : \"net1.exe\" or process.pe.original_file_name == \"net1.exe\") and\n     not process.parent.name : \"net.exe\"\n    )\n   ) and process.args : (\"use\", \"user\", \"session\", \"config\") and not process.args: (\"/persistent:*\", \"/delete\", \"\\\\\\\\*\")\n  ) or\n  (process.name : \"nbtstat.exe\" and process.args : \"-s*\")\n) and not user.id : \"S-1-5-18\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*"
        ],
        "filters": []
      },
      {
        "name": "Attempt to Deactivate an Okta Policy Rule",
        "description": "Detects attempts to deactivate a rule within an Okta policy. An adversary may attempt to deactivate a rule within an Okta policy in order to remove or weaken an organization's security controls.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Attempt to Deactivate an Okta Policy Rule\n\nIdentity and Access Management (IAM) systems like Okta serve as the first line of defense for an organization's network, and are often targeted by adversaries. By disabling security rules, adversaries can circumvent multi-factor authentication, access controls, or other protective measures enforced by these policies, enabling unauthorized access, privilege escalation, or other malicious activities.\n\nThis rule detects attempts to deactivate a rule within an Okta policy, which could be indicative of an adversary's attempt to weaken an organization's security controls. A threat actor may do this to remove barriers to their activities or enable future attacks.\n\n#### Possible investigation steps:\n\n- Identify the actor related to the alert by reviewing `okta.actor.id`, `okta.actor.type`, `okta.actor.alternate_id`, or `okta.actor.display_name` fields in the alert.\n- Review the `okta.client.user_agent.raw_user_agent` field to understand the device and software used by the actor.\n- Examine the `okta.outcome.reason` field for additional context around the deactivation attempt.\n- Check the `okta.outcome.result` field to confirm the policy rule deactivation attempt.\n- Check if there are multiple policy rule deactivation attempts from the same actor or IP address (`okta.client.ip`).\n- Check for successful logins immediately following the policy rule deactivation attempt.\n- Verify whether the actor's activity aligns with typical behavior or if any unusual activity took place around the time of the deactivation attempt.\n\n### False positive analysis:\n\n- Check if there were issues with the Okta system at the time of the deactivation attempt. This could indicate a system error rather than a genuine threat activity.\n- Check the geographical location (`okta.request.ip_chain.geographical_context`) and time of the deactivation attempt. If these match the actor's normal behavior, it might be a false positive.\n- Verify the actor's administrative rights to ensure they are correctly configured.\n\n### Response and remediation:\n\n- If unauthorized policy rule deactivation is confirmed, initiate the incident response process.\n- Immediately lock the affected actor account and require a password change.\n- Consider resetting MFA tokens for the actor and require re-enrollment.\n- Check if the compromised account was used to access or alter any sensitive data or systems.\n- If a specific deactivation technique was used, ensure your systems are patched or configured to prevent such techniques.\n- Assess the criticality of affected services and servers.\n- Work with your IT team to minimize the impact on users and maintain business continuity.\n- If multiple accounts are affected, consider a broader reset or audit of MFA tokens.\n- Implement security best practices [outlined](https://www.okta.com/blog/2019/10/9-admin-best-practices-to-keep-your-org-secure/) by Okta.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).",
        "output_index": "",
        "version": 411,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Data Source: Okta",
          "Tactic: Defense Evasion"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Consider adding exceptions to this rule to filter false positives if Okta MFA rules are regularly deactivated in your organization."
        ],
        "references": [
          "https://help.okta.com/en/prod/Content/Topics/Security/Security_Policies.htm",
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.007",
                    "name": "Disable or Modify Cloud Firewall",
                    "reference": "https://attack.mitre.org/techniques/T1562/007/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "d2866c22-f457-4085-9bc8-f1834186c80e",
        "rule_id": "cc92c835-da92-45c9-9f29-b4992ad621a0",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:19.622Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:06.991Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset:okta.system and event.action:policy.rule.deactivate",
        "language": "kuery"
      },
      {
        "name": "Okta User Session Impersonation",
        "description": "A user has initiated a session impersonation granting them access to the environment with the permissions of the user they are impersonating. This would likely indicate Okta administrative access and should only ever occur if requested and expected.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Okta User Session Impersonation\n\nThe detection of an Okta User Session Impersonation indicates that a user has initiated a session impersonation which grants them access with the permissions of the user they are impersonating. This type of activity typically indicates Okta administrative access and should only ever occur if requested and expected.\n\n#### Possible investigation steps\n\n- Identify the actor associated with the impersonation event by checking the `okta.actor.id`, `okta.actor.type`, `okta.actor.alternate_id`, or `okta.actor.display_name` fields.\n- Review the `event.action` field to confirm the initiation of the impersonation event.\n- Check the `event.time` field to understand the timing of the event.\n- Check the `okta.target.id`, `okta.target.type`, `okta.target.alternate_id`, or `okta.target.display_name` to identify the user who was impersonated.\n- Review any activities that occurred during the impersonation session. Look for any activities related to the impersonated user's account during and after the impersonation event.\n\n### False positive analysis\n\n- Verify if the session impersonation was part of an approved activity. Check if it was associated with any documented administrative tasks or troubleshooting efforts.\n- Ensure that the impersonation session was initiated by an authorized individual. You can check this by verifying the `okta.actor.id` or `okta.actor.display_name` against the list of approved administrators.\n\n### Response and remediation\n\n- If the impersonation was not authorized, consider it as a breach. Suspend the user account of the impersonator immediately.\n- Reset the user session and invalidate any active sessions related to the impersonated user.\n- If a specific impersonation technique was used, ensure that systems are patched or configured to prevent such techniques.\n- Conduct a thorough investigation to understand the extent of the breach and the potential impact on the systems and data.\n- Review and update your security policies to prevent such incidents in the future.\n- Implement additional monitoring and logging of Okta events to improve visibility of user actions.",
        "output_index": "",
        "version": 411,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Data Source: Okta",
          "Tactic: Credential Access"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "15m",
        "from": "now-1800s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://blog.cloudflare.com/cloudflare-investigation-of-the-january-2022-okta-compromise/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta",
          "https://www.elastic.co/security-labs/okta-and-lapsus-what-you-need-to-know"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            }
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "0bfd1c58-750c-450b-8528-6fe90f329989",
        "rule_id": "cdbebdc1-dc97-43c6-a538-f26a20c0a911",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:19.624Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:06.994Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset:okta.system and event.action:user.session.impersonation.initiate",
        "language": "kuery"
      },
      {
        "name": "Potential PowerShell HackTool Script by Function Names",
        "description": "Detects known PowerShell offensive tooling functions names in PowerShell scripts. Attackers commonly use out-of-the-box offensive tools without modifying the code. This rule aim is to take advantage of that.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Potential PowerShell HackTool Script by Function Names\n\nPowerShell is one of the main tools system administrators use for automation, report routines, and other tasks. This makes it available for use in various environments, and creates an attractive way for attackers to execute code.\n\nAdversaries often exploit PowerShell's capabilities to execute malicious scripts and perform various attacks. This rule identifies known offensive tooling function names in PowerShell scripts, as attackers commonly use out-of-the-box tools without modifying the code. By monitoring these specific function names, the rule aims to detect and alert potential malicious PowerShell activity.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n### Possible investigation steps\n\n- Examine the script content that triggered the detection; look for suspicious DLL imports, collection or exfiltration capabilities, suspicious functions, encoded or compressed data, and other potentially malicious characteristics.\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Examine the script's execution context, such as the user account, privileges, the role of the system on which it was executed, and any relevant timestamps.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Evaluate whether the user needs to use PowerShell to complete tasks.\n- Investigate the origin of the PowerShell script, including its source, download method, and any associated URLs or IP addresses.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the script using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process's `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n\n### False positive analysis\n\n- This rule may generate false positives if legitimate scripts or tools used by administrators contain any of the listed function names. These function names are commonly associated with offensive tooling, but they may also be present in benign scripts or tools.\n- To handle these false positives consider adding exceptions - preferably with a combination of full file path and users.\n\n### Related Rules\n\n- PowerShell Invoke-NinjaCopy script - b8386923-b02c-4b94-986a-d223d9b01f88\n- PowerShell Suspicious Discovery Related Windows API Functions - 61ac3638-40a3-44b2-855a-985636ca985e\n- Potential Process Injection via PowerShell - 2e29e96a-b67c-455a-afe4-de6183431d0d\n- PowerShell Keylogging Script - bd2c86a0-8b61-4457-ab38-96943984e889\n\n### Response and Remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n  - If malicious activity is confirmed, perform a broader investigation to identify the scope of the compromise and determine the appropriate remediation steps.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Reimage the host operating system or restore the compromised files to clean versions.\n- Restrict PowerShell usage outside of IT and engineering business units using GPOs, AppLocker, Intune, or similar software.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 213,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Data Source: PowerShell Logs"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/atc-project/atc-data/blob/master/docs/Logging_Policies/LP_0109_windows_powershell_script_block_log.md",
          "https://github.com/BC-SECURITY/Empire"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'PowerShell Script Block Logging' logging policy must be enabled.\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nAdministrative Templates >\nWindows PowerShell >\nTurn on PowerShell Script Block Logging (Enable)\n```\n\nSteps to implement the logging policy via registry:\n\n```\nreg add \"hklm\\SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\ScriptBlockLogging\" /v EnableScriptBlockLogging /t REG_DWORD /d 1\n```\n",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "powershell.file.script_block_text",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "1b7fee6d-8672-40fd-97cd-d1e1675a0d8f",
        "rule_id": "cde1bafa-9f01-4f43-a872-605b678968b0",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:19.629Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:04.188Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-windows.powershell*"
        ],
        "filters": [
          {
            "meta": {
              "negate": true
            },
            "query": {
              "wildcard": {
                "file.path": {
                  "case_insensitive": true,
                  "value": "?:\\\\ProgramData\\\\Microsoft\\\\Windows Defender Advanced Threat Protection\\\\DataCollection\\\\*"
                }
              }
            }
          }
        ],
        "query": "event.category:process and host.os.type:windows and\n  powershell.file.script_block_text : (\n    \"Add-DomainGroupMember\" or \"Add-DomainObjectAcl\" or\n    \"Add-RemoteConnection\" or \"Add-ServiceDacl\" or\n    \"Add-Win32Type\" or \"Convert-ADName\" or\n    \"Convert-LDAPProperty\" or \"ConvertFrom-LDAPLogonHours\" or\n    \"ConvertFrom-UACValue\" or \"Copy-ArrayOfMemAddresses\" or\n    \"Create-NamedPipe\" or \"Create-ProcessWithToken\" or\n    \"Create-RemoteThread\" or \"Create-SuspendedWinLogon\" or\n    \"Create-WinLogonProcess\" or \"Emit-CallThreadStub\" or\n    \"Enable-SeAssignPrimaryTokenPrivilege\" or \"Enable-SeDebugPrivilege\" or\n    \"Enum-AllTokens\" or \"Export-PowerViewCSV\" or\n    \"Find-AVSignature\" or \"Find-AppLockerLog\" or\n    \"Find-DomainLocalGroupMember\" or \"Find-DomainObjectPropertyOutlier\" or\n    \"Find-DomainProcess\" or \"Find-DomainShare\" or\n    \"Find-DomainUserEvent\" or \"Find-DomainUserLocation\" or\n    \"Find-InterestingDomainAcl\" or \"Find-InterestingDomainShareFile\" or\n    \"Find-InterestingFile\" or \"Find-LocalAdminAccess\" or\n    \"Find-PSScriptsInPSAppLog\" or \"Find-PathDLLHijack\" or\n    \"Find-ProcessDLLHijack\" or \"Find-RDPClientConnection\" or\n    \"Get-AllAttributesForClass\" or \"Get-CachedGPPPassword\" or\n    \"Get-DecryptedCpassword\" or \"Get-DecryptedSitelistPassword\" or\n    \"Get-DelegateType\" or \"New-RelayEnumObject\" or\n    \"Get-DomainDFSShare\" or \"Get-DomainDFSShareV1\" or\n    \"Get-DomainDFSShareV2\" or \"Get-DomainDNSRecord\" or\n    \"Get-DomainDNSZone\" or \"Get-DomainFileServer\" or\n    \"Get-DomainForeignGroupMember\" or \"Get-DomainForeignUser\" or\n    \"Get-DomainGPO\" or \"Get-DomainGPOComputerLocalGroupMapping\" or\n    \"Get-DomainGPOLocalGroup\" or \"Get-DomainGPOUserLocalGroupMapping\" or\n    \"Get-DomainGUIDMap\" or \"Get-DomainGroup\" or\n    \"Get-DomainGroupMember\" or \"Get-DomainGroupMemberDeleted\" or\n    \"Get-DomainManagedSecurityGroup\" or \"Get-DomainOU\" or\n    \"Get-DomainObject\" or \"Get-DomainObjectAcl\" or\n    \"Get-DomainObjectAttributeHistory\" or \"Get-DomainObjectLinkedAttributeHistory\" or\n    \"Get-DomainPolicyData\" or \"Get-DomainSID\" or\n    \"Get-DomainSPNTicket\" or \"Get-DomainSearcher\" or\n    \"Get-DomainSite\" or \"Get-DomainSubnet\" or\n    \"Get-DomainTrust\" or \"Get-DomainTrustMapping\" or\n    \"Get-DomainUser\" or \"Get-DomainUserEvent\" or\n    \"Get-Forest\" or \"Get-ForestDomain\" or\n    \"Get-ForestGlobalCatalog\" or \"Get-ForestSchemaClass\" or\n    \"Get-ForestTrust\" or \"Get-GPODelegation\" or\n    \"Get-GPPAutologon\" or \"Get-GPPInnerField\" or\n    \"Get-GPPInnerFields\" or \"Get-GPPPassword\" or\n    \"Get-GptTmpl\" or \"Get-GroupsXML\" or\n    \"Get-HttpStatus\" or \"Get-ImageNtHeaders\" or\n    \"Get-Keystrokes\" or \"New-SOASerialNumberArray\" or \n    \"Get-MemoryProcAddress\" or \"Get-MicrophoneAudio\" or\n    \"Get-ModifiablePath\" or \"Get-ModifiableRegistryAutoRun\" or\n    \"Get-ModifiableScheduledTaskFile\" or \"Get-ModifiableService\" or\n    \"Get-ModifiableServiceFile\" or \"Get-Name\" or\n    \"Get-NetComputerSiteName\" or \"Get-NetLocalGroup\" or\n    \"Get-NetLocalGroupMember\" or \"Get-NetLoggedon\" or\n    \"Get-NetRDPSession\" or \"Get-NetSession\" or\n    \"Get-NetShare\" or \"Get-PEArchitecture\" or\n    \"Get-PEBasicInfo\" or \"Get-PEDetailedInfo\" or\n    \"Get-PathAcl\" or \"Get-PrimaryToken\" or\n    \"Get-ProcAddress\" or \"Get-ProcessTokenGroup\" or\n    \"Get-ProcessTokenPrivilege\" or \"Get-ProcessTokenType\" or\n    \"Get-RegLoggedOn\" or \"Get-RegistryAlwaysInstallElevated\" or\n    \"Get-RegistryAutoLogon\" or \"Get-RemoteProcAddress\" or\n    \"Get-Screenshot\" or \"Get-ServiceDetail\" or\n    \"Get-SiteListPassword\" or \"Get-SitelistField\" or\n    \"Get-System\" or \"Get-SystemNamedPipe\" or\n    \"Get-SystemToken\" or \"Get-ThreadToken\" or\n    \"Get-TimedScreenshot\" or \"Get-TokenInformation\" or\n    \"Get-TopPort\" or \"Get-UnattendedInstallFile\" or\n    \"Get-UniqueTokens\" or \"Get-UnquotedService\" or\n    \"Get-VaultCredential\" or \"Get-VaultElementValue\" or\n    \"Get-VirtualProtectValue\" or \"Get-VolumeShadowCopy\" or\n    \"Get-WMIProcess\" or \"Get-WMIRegCachedRDPConnection\" or\n    \"Get-WMIRegLastLoggedOn\" or \"Get-WMIRegMountedDrive\" or\n    \"Get-WMIRegProxy\" or \"Get-WebConfig\" or\n    \"Get-Win32Constants\" or \"Get-Win32Functions\" or\n    \"Get-Win32Types\" or \"Import-DllImports\" or\n    \"Import-DllInRemoteProcess\" or \"Inject-LocalShellcode\" or\n    \"Inject-RemoteShellcode\" or \"Install-ServiceBinary\" or\n    \"Invoke-CompareAttributesForClass\" or \"Invoke-CreateRemoteThread\" or\n    \"Invoke-CredentialInjection\" or \"Invoke-DllInjection\" or\n    \"Invoke-EventVwrBypass\" or \"Invoke-ImpersonateUser\" or\n    \"Invoke-Kerberoast\" or \"Invoke-MemoryFreeLibrary\" or\n    \"Invoke-MemoryLoadLibrary\" or\n    \"Invoke-Mimikatz\" or \"Invoke-NinjaCopy\" or\n    \"Invoke-PatchDll\" or \"Invoke-Portscan\" or\n    \"Invoke-PrivescAudit\" or \"Invoke-ReflectivePEInjection\" or\n    \"Invoke-ReverseDnsLookup\" or \"Invoke-RevertToSelf\" or\n    \"Invoke-ServiceAbuse\" or \"Invoke-Shellcode\" or\n    \"Invoke-TokenManipulation\" or \"Invoke-UserImpersonation\" or\n    \"Invoke-WmiCommand\" or \"Mount-VolumeShadowCopy\" or\n    \"New-ADObjectAccessControlEntry\" or \"New-DomainGroup\" or\n    \"New-DomainUser\" or \"New-DynamicParameter\" or\n    \"New-InMemoryModule\" or\n    \"New-ThreadedFunction\" or \"New-VolumeShadowCopy\" or\n    \"Out-CompressedDll\" or \"Out-EncodedCommand\" or\n    \"Out-EncryptedScript\" or \"Out-Minidump\" or\n    \"PortScan-Alive\" or \"Portscan-Port\" or\n    \"Remove-DomainGroupMember\" or \"Remove-DomainObjectAcl\" or\n    \"Remove-RemoteConnection\" or \"Remove-VolumeShadowCopy\" or\n    \"Restore-ServiceBinary\" or \"Set-DesktopACLToAllowEveryone\" or\n    \"Set-DesktopACLs\" or \"Set-DomainObject\" or\n    \"Set-DomainObjectOwner\" or \"Set-DomainUserPassword\" or\n    \"Set-ServiceBinaryPath\" or \"Sub-SignedIntAsUnsigned\" or\n    \"Test-AdminAccess\" or \"Test-MemoryRangeValid\" or\n    \"Test-ServiceDaclPermission\" or \"Update-ExeFunctions\" or\n    \"Update-MemoryAddresses\" or \"Update-MemoryProtectionFlags\" or\n    \"Write-BytesToMemory\" or \"Write-HijackDll\" or\n    \"Write-PortscanOut\" or \"Write-ServiceBinary\" or\n    \"Write-UserAddMSI\" or \"Invoke-Privesc\" or\n    \"func_get_proc_address\" or \"Invoke-BloodHound\" or\n    \"Invoke-HostEnum\" or \"Get-BrowserInformation\" or\n    \"Get-DomainAccountPolicy\" or \"Get-DomainAdmins\" or\n    \"Get-AVProcesses\" or \"Get-AVInfo\" or\n    \"Get-RecycleBin\" or \"Invoke-BruteForce\" or\n    \"Get-PassHints\" or \"Invoke-SessionGopher\" or\n    \"Get-LSASecret\" or \"Get-PassHashes\" or\n    \"Invoke-WdigestDowngrade\" or \"Get-ChromeDump\" or\n    \"Invoke-DomainPasswordSpray\" or \"Get-FoxDump\" or\n    \"New-HoneyHash\" or \"Invoke-DCSync\" or\n    \"Invoke-PowerDump\" or \"Invoke-SSIDExfil\" or\n    \"Invoke-PowerShellTCP\" or \"Add-Exfiltration\" or\n    \"Do-Exfiltration\" or \"Invoke-DropboxUpload\" or\n    \"Invoke-ExfilDataToGitHub\" or \"Invoke-EgressCheck\" or\n    \"Invoke-PostExfil\" or \"Create-MultipleSessions\" or\n    \"Invoke-NetworkRelay\" or \"New-GPOImmediateTask\" or\n    \"Invoke-WMIDebugger\" or \"Invoke-SQLOSCMD\" or\n    \"Invoke-SMBExec\" or \"Invoke-PSRemoting\" or\n    \"Invoke-ExecuteMSBuild\" or \"Invoke-DCOM\" or\n    \"Invoke-InveighRelay\" or \"Invoke-PsExec\" or\n    \"Invoke-SSHCommand\" or \"Find-ActiveUsersWMI\" or\n    \"Get-SystemDrivesWMI\" or \"Get-ActiveNICSWMI\" or\n    \"Remove-Persistence\" or \"DNS_TXT_Pwnage\" or\n    \"Execute-OnTime\" or \"HTTP-Backdoor\" or\n    \"Add-ConstrainedDelegationBackdoor\" or \"Add-RegBackdoor\" or\n    \"Add-ScrnSaveBackdoor\" or \"Gupt-Backdoor\" or\n    \"Invoke-ADSBackdoor\" or \"Add-Persistence\" or\n    \"Invoke-ResolverBackdoor\" or \"Invoke-EventLogBackdoor\" or\n    \"Invoke-DeadUserBackdoor\" or \"Invoke-DisableMachineAcctChange\" or\n    \"Invoke-AccessBinary\" or \"Add-NetUser\" or\n    \"Invoke-Schtasks\" or \"Invoke-JSRatRegsvr\" or\n    \"Invoke-JSRatRundll\" or \"Invoke-PoshRatHttps\" or\n    \"Invoke-PsGcatAgent\" or \"Remove-PoshRat\" or\n    \"Install-SSP\" or \"Invoke-BackdoorLNK\" or\n    \"PowerBreach\" or \"InstallEXE-Persistence\" or\n    \"RemoveEXE-Persistence\" or \"Install-ServiceLevel-Persistence\" or\n    \"Remove-ServiceLevel-Persistence\" or \"Invoke-Prompt\" or\n    \"Invoke-PacketCapture\" or \"Start-WebcamRecorder\" or\n    \"Get-USBKeyStrokes\" or \"Invoke-KeeThief\" or\n    \"Get-Keystrokes\" or \"Invoke-NetRipper\" or\n    \"Get-EmailItems\" or \"Invoke-MailSearch\" or\n    \"Invoke-SearchGAL\" or \"Get-WebCredentials\" or\n    \"Start-CaptureServer\" or \"Invoke-PowerShellIcmp\" or\n    \"Invoke-PowerShellTcpOneLine\" or \"Invoke-PowerShellTcpOneLineBind\" or\n    \"Invoke-PowerShellUdp\" or \"Invoke-PowerShellUdpOneLine\" or\n    \"Run-EXEonRemote\" or \"Download-Execute-PS\" or\n    \"Out-RundllCommand\" or \"Set-RemoteWMI\" or\n    \"Set-DCShadowPermissions\" or \"Invoke-PowerShellWMI\" or\n    \"Invoke-Vnc\" or \"Invoke-LockWorkStation\" or\n    \"Invoke-EternalBlue\" or \"Invoke-ShellcodeMSIL\" or\n    \"Invoke-MetasploitPayload\" or \"Invoke-DowngradeAccount\" or\n    \"Invoke-RunAs\" or \"ExetoText\" or\n    \"Disable-SecuritySettings\" or \"Set-MacAttribute\" or\n    \"Invoke-MS16032\" or \"Invoke-BypassUACTokenManipulation\" or\n    \"Invoke-SDCLTBypass\" or \"Invoke-FodHelperBypass\" or\n    \"Invoke-EventVwrBypass\" or \"Invoke-EnvBypass\" or\n    \"Get-ServiceUnquoted\" or \"Get-ServiceFilePermission\" or\n    \"Get-ServicePermission\" or\n    \"Enable-DuplicateToken\" or \"Invoke-PsUaCme\" or\n    \"Invoke-Tater\" or \"Invoke-WScriptBypassUAC\" or\n    \"Invoke-AllChecks\" or \"Find-TrustedDocuments\" or\n    \"Invoke-Interceptor\" or \"Invoke-PoshRatHttp\" or\n    \"Invoke-ExecCommandWMI\" or \"Invoke-KillProcessWMI\" or\n    \"Invoke-CreateShareandExecute\" or \"Invoke-RemoteScriptWithOutput\" or\n    \"Invoke-SchedJobManipulation\" or \"Invoke-ServiceManipulation\" or\n    \"Invoke-PowerOptionsWMI\" or \"Invoke-DirectoryListing\" or\n    \"Invoke-FileTransferOverWMI\" or \"Invoke-WMImplant\" or\n    \"Invoke-WMIObfuscatedPSCommand\" or \"Invoke-WMIDuplicateClass\" or\n    \"Invoke-WMIUpload\" or \"Invoke-WMIRemoteExtract\" or \"Invoke-winPEAS\"\n  ) and\n  not powershell.file.script_block_text : (\n    \"sentinelbreakpoints\" and \"Set-PSBreakpoint\"\n  ) and\n  not user.id : (\"S-1-5-18\" or \"S-1-5-19\")",
        "language": "kuery"
      },
      {
        "name": "Expired or Revoked Driver Loaded",
        "description": "Identifies an attempt to load a revoked or expired driver. Adversaries may bring outdated drivers with vulnerabilities to gain code execution in kernel mode or abuse revoked certificates to sign their drivers.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 5,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://docs.microsoft.com/en-us/previous-versions/windows/hardware/design/dn653559(v=vs.85)?redirectedfrom=MSDN"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1068",
                "name": "Exploitation for Privilege Escalation",
                "reference": "https://attack.mitre.org/techniques/T1068/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1036",
                "name": "Masquerading",
                "reference": "https://attack.mitre.org/techniques/T1036/",
                "subtechnique": [
                  {
                    "id": "T1036.001",
                    "name": "Invalid Code Signature",
                    "reference": "https://attack.mitre.org/techniques/T1036/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "dll.code_signature.status",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pid",
            "type": "long",
            "ecs": true
          }
        ],
        "id": "75a11c13-ffcb-42ce-98c1-59a69da3c227",
        "rule_id": "d12bac54-ab2a-4159-933f-d7bcefa7b61d",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:19.635Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:17.252Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "driver where host.os.type == \"windows\" and process.pid == 4 and\n  dll.code_signature.status : (\"errorExpired\", \"errorRevoked\")",
        "language": "eql",
        "index": [
          "logs-endpoint.events.library-*"
        ],
        "filters": []
      },
      {
        "name": "Compression DLL Loaded by Unusual Process",
        "description": "Identifies the image load of a compression DLL. Adversaries will often compress and encrypt data in preparation for exfiltration.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 3,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Collection",
          "Data Source: Elastic Defend",
          "Rule Type: BBR"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0009",
              "name": "Collection",
              "reference": "https://attack.mitre.org/tactics/TA0009/"
            },
            "technique": [
              {
                "id": "T1560",
                "name": "Archive Collected Data",
                "reference": "https://attack.mitre.org/techniques/T1560/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "dll.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.code_signature.trusted",
            "type": "boolean",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "9f4a1c31-9993-4d09-a19d-9e678797e3e0",
        "rule_id": "d197478e-39f0-4347-a22f-ba654718b148",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:19.636Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:17.256Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "library where host.os.type == \"windows\" and event.action == \"load\" and\n  dll.name : (\"System.IO.Compression.FileSystem.ni.dll\", \"System.IO.Compression.ni.dll\") and\n  not \n  (\n    (\n      process.executable : (\n        \"?:\\\\Program Files\\\\*\",\n        \"?:\\\\Program Files (x86)\\\\*\",\n        \"?:\\\\Windows\\\\Microsoft.NET\\\\Framework*\\\\mscorsvw.exe\",\n        \"?:\\\\Windows\\\\System32\\\\sdiagnhost.exe\",\n        \"?:\\\\Windows\\\\System32\\\\inetsrv\\\\w3wp.exe\",\n        \"?:\\\\Windows\\\\SysWOW64\\\\inetsrv\\\\w3wp.exe\",\n        \"?:\\\\ProgramData\\\\Microsoft\\\\Windows Defender Advanced Threat Protection\\\\DataCollection\\\\*\\\\OpenHandleCollector.exe\"\n      ) and process.code_signature.trusted == true\n    ) or\n    (\n      process.name : \"NuGet.exe\" and process.code_signature.trusted == true and user.id : (\"S-1-5-18\", \"S-1-5-20\")\n    )\n  )",
        "language": "eql",
        "index": [
          "logs-endpoint.events.library-*"
        ],
        "filters": []
      },
      {
        "name": "Attempt to Delete an Okta Policy Rule",
        "description": "Detects attempts to delete a rule within an Okta policy. An adversary may attempt to delete an Okta policy rule in order to weaken an organization's security controls.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Attempt to Delete an Okta Policy Rule\n\nOkta policy rules are integral components of an organization's security controls, as they define how user access to resources is managed. Deletion of a rule within an Okta policy could potentially weaken the organization's security posture, allowing for unauthorized access or facilitating other malicious activities.\n\nThis rule detects attempts to delete an Okta policy rule, which could indicate an adversary's attempt to weaken an organization's security controls. Adversaries may do this to circumvent security measures and enable further malicious activities.\n\n#### Possible investigation steps:\n\n- Identify the actor related to the alert by reviewing `okta.actor.id`, `okta.actor.type`, `okta.actor.alternate_id`, or `okta.actor.display_name` fields in the alert.\n- Review the `okta.client.user_agent.raw_user_agent` field to understand the device and software used by the actor.\n- Examine the `okta.outcome.reason` field for additional context around the deletion attempt.\n- Check the `okta.outcome.result` field to confirm the policy rule deletion attempt.\n- Check if there are multiple policy rule deletion attempts from the same actor or IP address (`okta.client.ip`).\n- Check for successful logins immediately following the policy rule deletion attempt.\n- Verify whether the actor's activity aligns with typical behavior or if any unusual activity took place around the time of the deletion attempt.\n\n### False positive analysis:\n\n- Check if there were issues with the Okta system at the time of the deletion attempt. This could indicate a system error rather than a genuine threat activity.\n- Check the geographical location (`okta.request.ip_chain.geographical_context`) and time of the deletion attempt. If these match the actor's normal behavior, it might be a false positive.\n- Verify the actor's administrative rights to ensure they are correctly configured.\n\n### Response and remediation:\n\n- If unauthorized policy rule deletion is confirmed, initiate the incident response process.\n- Immediately lock the affected actor account and require a password change.\n- Consider resetting MFA tokens for the actor and require re-enrollment.\n- Check if the compromised account was used to access or alter any sensitive data or systems.\n- If a specific deletion technique was used, ensure your systems are patched or configured to prevent such techniques.\n- Assess the criticality of affected services and servers.\n- Work with your IT team to minimize the impact on users and maintain business continuity.\n- If multiple accounts are affected, consider a broader reset or audit of MFA tokens.\n- Implement security best practices [outlined](https://www.okta.com/blog/2019/10/9-admin-best-practices-to-keep-your-org-secure/) by Okta.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).",
        "output_index": "",
        "version": 410,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Data Source: Okta",
          "Tactic: Defense Evasion"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Consider adding exceptions to this rule to filter false positives if Okta MFA rules are regularly modified in your organization."
        ],
        "references": [
          "https://help.okta.com/en/prod/Content/Topics/Security/Security_Policies.htm",
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.007",
                    "name": "Disable or Modify Cloud Firewall",
                    "reference": "https://attack.mitre.org/techniques/T1562/007/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "01065d56-06e8-426a-bb59-b71a76044125",
        "rule_id": "d5d86bf5-cf0c-4c06-b688-53fdc072fdfd",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:19.642Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:07.009Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset:okta.system and event.action:policy.rule.delete",
        "language": "kuery"
      },
      {
        "name": "Attempt to Modify an Okta Policy Rule",
        "description": "Detects attempts to modify a rule within an Okta policy. An adversary may attempt to modify an Okta policy rule in order to weaken an organization's security controls.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Attempt to Modify an Okta Policy Rule\n\nThe modification of an Okta policy rule can be an indication of malicious activity as it may aim to weaken an organization's security controls.\n\n#### Possible investigation steps:\n\n- Identify the actor related to the alert by reviewing `okta.actor.id`, `okta.actor.type`, `okta.actor.alternate_id`, or `okta.actor.display_name` fields in the alert.\n- Review the `okta.client.user_agent.raw_user_agent` field to understand the device and software used by the actor.\n- Examine the `okta.outcome.reason` field for additional context around the modification attempt.\n- Check the `okta.outcome.result` field to confirm the rule modification attempt.\n- Check if there are multiple rule modification attempts from the same actor or IP address (`okta.client.ip`).\n- Check for successful logins immediately following the modification attempt.\n- Verify whether the actor's activity aligns with typical behavior or if any unusual activity took place around the time of the modification attempt.\n\n### False positive analysis:\n\n- Check if there were issues with the Okta system at the time of the modification attempt. This could indicate a system error rather than a genuine threat activity.\n- Check the geographical location (`okta.request.ip_chain.geographical_context`) and time of the modification attempt. If these match the actor's normal behavior, it might be a false positive.\n- Verify the actor's administrative rights to ensure they are correctly configured.\n\n### Response and remediation:\n\n- If unauthorized modification is confirmed, initiate the incident response process.\n- Immediately lock the affected actor account and require a password change.\n- Consider resetting MFA tokens for the actor and require re-enrollment.\n- Check if the compromised account was used to access or alter any sensitive data or systems.\n- If a specific modification technique was used, ensure your systems are patched or configured to prevent such techniques.\n- Assess the criticality of affected services and servers.\n- Work with your IT team to minimize the impact on users and maintain business continuity.\n- If multiple accounts are affected, consider a broader reset or audit of MFA tokens.\n- Implement security best practices [outlined](https://www.okta.com/blog/2019/10/9-admin-best-practices-to-keep-your-org-secure/) by Okta.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).",
        "output_index": "",
        "version": 411,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Data Source: Okta",
          "Tactic: Defense Evasion"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Consider adding exceptions to this rule to filter false positives if Okta MFA rules are regularly modified in your organization."
        ],
        "references": [
          "https://help.okta.com/en/prod/Content/Topics/Security/Security_Policies.htm",
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.007",
                    "name": "Disable or Modify Cloud Firewall",
                    "reference": "https://attack.mitre.org/techniques/T1562/007/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "c54a4cbb-8f10-4092-83c7-06d51d5a2106",
        "rule_id": "000047bb-b27a-47ec-8b62-ef1a5d2c9e19",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:19.647Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:04.216Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset:okta.system and event.action:policy.rule.update",
        "language": "kuery"
      },
      {
        "name": "Enumerating Domain Trusts via DSQUERY.EXE",
        "description": "Identifies the use of dsquery.exe for domain trust discovery purposes. Adversaries may use this command-line utility to enumerate trust relationships that may be used for Lateral Movement opportunities in Windows multi-domain forest environments.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Enumerating Domain Trusts via DSQUERY.EXE\n\nActive Directory (AD) domain trusts define relationships between domains within a Windows AD environment. In this setup, a \"trusting\" domain permits users from a \"trusted\" domain to access resources. These trust relationships can be configurable as one-way, two-way, transitive, or non-transitive, enabling controlled access and resource sharing across domains.\n\nThis rule identifies the usage of the `dsquery.exe` utility to enumerate domain trusts. Attackers can use this information to enable the next actions in a target environment, such as lateral movement.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n\n### False positive analysis\n\n- Discovery activities are not inherently malicious if they occur in isolation and are done within the user business context (e.g., an administrator in this context). As long as the analyst did not identify suspicious activity related to the user or host, such alerts can be dismissed.\n\n### Related rules\n\n- Enumerating Domain Trusts via NLTEST.EXE - 84da2554-e12a-11ec-b896-f661ea17fbcd\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Restrict PowerShell usage outside of IT and engineering business units using GPOs, AppLocker, Intune, or similar software.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 210,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Data Source: Elastic Endgame",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Domain administrators may use this command-line utility for legitimate information gathering purposes."
        ],
        "references": [
          "https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/cc732952(v=ws.11)",
          "https://posts.specterops.io/a-guide-to-attacking-domain-trusts-971e52cb2944"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1018",
                "name": "Remote System Discovery",
                "reference": "https://attack.mitre.org/techniques/T1018/"
              },
              {
                "id": "T1482",
                "name": "Domain Trust Discovery",
                "reference": "https://attack.mitre.org/techniques/T1482/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "4d790d4b-5ae8-405d-b91f-25ce189664a4",
        "rule_id": "06a7a03c-c735-47a6-a313-51c354aef6c3",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:19.649Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:04.220Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n    (process.name : \"dsquery.exe\" or ?process.pe.original_file_name: \"dsquery.exe\") and \n    process.args : \"*objectClass=trustedDomain*\"",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Windows Account or Group Discovery",
        "description": "This rule identifies the execution of commands that enumerates account or group information. Adversaries may use built-in applications to get a listing of local system or domain accounts and groups.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 5,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Rule Type: BBR",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1069",
                "name": "Permission Groups Discovery",
                "reference": "https://attack.mitre.org/techniques/T1069/",
                "subtechnique": [
                  {
                    "id": "T1069.001",
                    "name": "Local Groups",
                    "reference": "https://attack.mitre.org/techniques/T1069/001/"
                  },
                  {
                    "id": "T1069.002",
                    "name": "Domain Groups",
                    "reference": "https://attack.mitre.org/techniques/T1069/002/"
                  }
                ]
              },
              {
                "id": "T1087",
                "name": "Account Discovery",
                "reference": "https://attack.mitre.org/techniques/T1087/",
                "subtechnique": [
                  {
                    "id": "T1087.001",
                    "name": "Local Account",
                    "reference": "https://attack.mitre.org/techniques/T1087/001/"
                  },
                  {
                    "id": "T1087.002",
                    "name": "Domain Account",
                    "reference": "https://attack.mitre.org/techniques/T1087/002/"
                  }
                ]
              },
              {
                "id": "T1201",
                "name": "Password Policy Discovery",
                "reference": "https://attack.mitre.org/techniques/T1201/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "27b16b85-57d8-4e5f-b7f2-3f6bb33cadb1",
        "rule_id": "089db1af-740d-4d84-9a5b-babd6de143b0",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:19.655Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:16.389Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n(\n  (\n   (\n    (process.name : \"net.exe\" or process.pe.original_file_name == \"net.exe\") or\n    (\n     (process.name : \"net1.exe\" or process.pe.original_file_name == \"net1.exe\") and\n     not process.parent.name : \"net.exe\"\n    )\n   ) and process.args : (\"accounts\", \"group\", \"user\", \"localgroup\") and not process.args : \"/add\"\n  ) or\n  (process.name:(\"dsquery.exe\", \"dsget.exe\") and process.args:(\"*members*\", \"user\")) or\n  (process.name:\"dsquery.exe\" and process.args:\"*filter*\") or\n  process.name:(\"quser.exe\", \"qwinsta.exe\", \"PsGetSID.exe\", \"PsLoggedOn.exe\", \"LogonSessions.exe\", \"whoami.exe\") or\n  (\n    process.name: \"cmd.exe\" and\n    (\n      process.args : \"echo\" and process.args : (\n        \"%username%\", \"%userdomain%\", \"%userdnsdomain%\",\n        \"%userdomain_roamingprofile%\", \"%userprofile%\",\n        \"%homepath%\", \"%localappdata%\", \"%appdata%\"\n      ) or\n      process.args : \"set\"\n    )\n  )\n) and not process.parent.args: \"C:\\\\Program Files (x86)\\\\Microsoft Intune Management Extension\\\\Content\\\\DetectionScripts\\\\*.ps1\"\nand not process.parent.name : \"LTSVC.exe\" and not user.id : \"S-1-5-18\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*"
        ],
        "filters": []
      },
      {
        "name": "Process Termination followed by Deletion",
        "description": "Identifies a process termination event quickly followed by the deletion of its executable file. Malware tools and other non-native files dropped or created on a system by an adversary may leave traces to indicate to what occurred. Removal of these files can occur during an intrusion, or as part of a post-intrusion process to minimize the adversary's footprint.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Process Termination followed by Deletion\n\nThis rule identifies an unsigned process termination event quickly followed by the deletion of its executable file. Attackers can delete programs after their execution in an attempt to cover their tracks in a host.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate any abnormal behavior by the subject process such as network connections, registry or file modifications, command line and any spawned child processes.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the process executable using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately, as programs that exhibit this behavior, such as installers and similar utilities, should be signed. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 110,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Endgame",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1036",
                "name": "Masquerading",
                "reference": "https://attack.mitre.org/techniques/T1036/",
                "subtechnique": [
                  {
                    "id": "T1036.001",
                    "name": "Invalid Code Signature",
                    "reference": "https://attack.mitre.org/techniques/T1036/001/"
                  }
                ]
              },
              {
                "id": "T1070",
                "name": "Indicator Removal",
                "reference": "https://attack.mitre.org/techniques/T1070/",
                "subtechnique": [
                  {
                    "id": "T1070.004",
                    "name": "File Deletion",
                    "reference": "https://attack.mitre.org/techniques/T1070/004/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.code_signature.subject_name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.code_signature.trusted",
            "type": "boolean",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.code_signature.status",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.code_signature.subject_name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "77680c94-4d61-40c0-b413-6f8897d3deba",
        "rule_id": "09443c92-46b3-45a4-8f25-383b028b258d",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:19.660Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:04.224Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by host.id with maxspan=5s\n   [process where host.os.type == \"windows\" and event.type == \"end\" and\n    process.code_signature.trusted != true and\n    not process.executable like\n             (\"C:\\\\Windows\\\\SoftwareDistribution\\\\*.exe\",\n              \"C:\\\\Windows\\\\WinSxS\\\\*.exe\",\n              \"?:\\\\Windows\\\\Postillion\\\\Office\\\\*.exe\") and\n    not (\n      process.name : \"infinst.exe\" and process.parent.name: \"dxsetup.exe\" and\n      process.parent.code_signature.subject_name == \"NVIDIA Corporation\" and\n      process.parent.code_signature.status == \"trusted\"\n    )\n   ] by process.executable\n   [file where host.os.type == \"windows\" and event.type == \"deletion\" and file.extension in~ (\"exe\", \"scr\", \"com\") and\n    not process.executable like\n             (\"?:\\\\Program Files\\\\*.exe\",\n              \"?:\\\\Program Files (x86)\\\\*.exe\",\n              \"?:\\\\Windows\\\\System32\\\\svchost.exe\",\n              \"?:\\\\Windows\\\\System32\\\\drvinst.exe\",\n              \"?:\\\\Windows\\\\Postillion\\\\Office\\\\*.exe\") and\n    not file.path like (\n          \"?:\\\\Program Files\\\\*.exe\",\n          \"?:\\\\Program Files (x86)\\\\*.exe\",\n          \"?:\\\\Windows\\\\Temp\\\\*\\\\DismHost.exe\",\n          \"?:\\\\$WINDOWS.~BT\\\\Work\\\\*\\\\DismHost.exe\",\n          \"?:\\\\$WinREAgent\\\\Scratch\\\\*\\\\DismHost.exe\",\n          \"?:\\\\Windows\\\\tenable_mw_scan_*.exe\",\n          \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\LogiUI\\\\Pak\\\\uninstall.exe\",\n          \"?:\\\\ProgramData\\\\chocolatey\\\\*.exe\"\n    ) and\n    not (process.name : \"OktaVerifySetup-*.exe\" and process.code_signature.subject_name == \"Okta, Inc.\") and\n    not (\n      process.executable : \"?:\\\\Windows\\\\SysWOW64\\\\config\\\\systemprofile\\\\Citrix\\\\UpdaterBinaries\\\\CitrixReceiver\\\\*\" and\n      process.code_signature.subject_name == \"Citrix Systems, Inc.\" and\n      file.path : \"?:\\\\Windows\\\\SysWOW64\\\\config\\\\systemprofile\\\\Citrix\\\\UpdaterBinaries\\\\CitrixReceiver\\\\*\\\\bootstrapperhelper.exe\"\n    )\n   ] by file.path",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "logs-endpoint.events.file-*"
        ],
        "filters": []
      },
      {
        "name": "Threat Intel IP Address Indicator Match",
        "description": "This rule is triggered when an IP address indicator from the Threat Intel Filebeat module or integrations has a match against a network event.",
        "risk_score": 99,
        "severity": "critical",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "timeline_id": "495ad7a7-316e-4544-8a0f-9c098daee76e",
        "timeline_title": "Generic Threat Match Timeline",
        "license": "Elastic License v2",
        "note": "## Triage and Analysis\n\n### Investigating Threat Intel IP Address Indicator Match\n\nThreat Intel indicator match rules allow matching from a local observation, such as an endpoint event that records a file hash with an entry of a file hash stored within the Threat Intel integrations index.\n\nMatches are based on threat intelligence data that's been ingested during the last 30 days. Some integrations don't place expiration dates on their threat indicators, so we strongly recommend validating ingested threat indicators and reviewing match results. When reviewing match results, check associated activity to determine whether the event requires additional investigation.\n\nThis rule is triggered when an IP address indicator from the Threat Intel Filebeat module or a threat intelligence integration matches against a network event.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Gain context about the field that matched the local observation so you can understand the nature of the connection. This information can be found in the `threat.indicator.matched.field` field.\n- Investigate the IP address, which can be found in the `threat.indicator.matched.atomic` field:\n  - Check the reputation of the IP address in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n  - Execute a reverse DNS lookup to retrieve hostnames associated with the given IP address.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n- Identify the process responsible for the connection, and investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Retrieve the involved process executable and examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the process executable using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n- Using the data collected through the analysis, scope users targeted and other machines infected in the environment.\n\n### False Positive Analysis\n\n- When a match is found, it's important to consider the indicator's initial release date. Threat intelligence is useful for augmenting existing security processes but can quickly become outdated. In other words, some threat intelligence only represents a specific set of activity observed at a specific time. For example, an IP address may have hosted malware observed in a Dridex campaign months ago, but it's possible that IP has been remediated and no longer represents any threat.\n- False positives might occur after large and publicly written campaigns if curious employees interact with attacker infrastructure.\n- Some feeds may include internal or known benign addresses by mistake (e.g., 8.8.8.8, google.com, 127.0.0.1, etc.). Make sure you understand how blocking a specific domain or address might impact the organization or normal system functioning.\n\n### Response and Remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 7,
        "tags": [
          "OS: Windows",
          "Data Source: Elastic Endgame",
          "Rule Type: Threat Match"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "1h",
        "from": "now-3900s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-module-threatintel.html",
          "https://www.elastic.co/guide/en/security/master/es-threat-intel-integrations.html",
          "https://www.elastic.co/security/tip"
        ],
        "max_signals": 100,
        "threat": [],
        "setup": "## Setup\n\nThis rule needs threat intelligence indicators to work.\nThreat intelligence indicators can be collected using an [Elastic Agent integration](https://www.elastic.co/guide/en/security/current/es-threat-intel-integrations.html#agent-ti-integration),\nthe [Threat Intel module](https://www.elastic.co/guide/en/security/current/es-threat-intel-integrations.html#ti-mod-integration),\nor a [custom integration](https://www.elastic.co/guide/en/security/current/es-threat-intel-integrations.html#custom-ti-integration).\n\nMore information can be found [here](https://www.elastic.co/guide/en/security/current/es-threat-intel-integrations.html).\n",
        "related_integrations": [],
        "required_fields": [
          {
            "name": "destination.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "source.ip",
            "type": "ip",
            "ecs": true
          }
        ],
        "id": "e03904d2-52f2-4d23-a4be-03779618ac70",
        "rule_id": "0c41e478-5263-4c69-8f9e-7dfd2c22da64",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:19.662Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:07.075Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "threat_match",
        "query": "source.ip:* or destination.ip:*",
        "threat_query": "@timestamp >= \"now-30d/d\" and event.module:(threatintel or ti_*) and threat.indicator.ip:* and not labels.is_ioc_transform_source:\"true\"",
        "threat_mapping": [
          {
            "entries": [
              {
                "field": "source.ip",
                "type": "mapping",
                "value": "threat.indicator.ip"
              }
            ]
          },
          {
            "entries": [
              {
                "field": "destination.ip",
                "type": "mapping",
                "value": "threat.indicator.ip"
              }
            ]
          }
        ],
        "threat_index": [
          "filebeat-*",
          "logs-ti_*"
        ],
        "index": [
          "auditbeat-*",
          "endgame-*",
          "filebeat-*",
          "logs-*",
          "packetbeat-*",
          "winlogbeat-*"
        ],
        "filters": [],
        "threat_filters": [
          {
            "$state": {
              "store": "appState"
            },
            "meta": {
              "disabled": false,
              "key": "event.category",
              "negate": false,
              "params": {
                "query": "threat"
              },
              "type": "phrase"
            },
            "query": {
              "match_phrase": {
                "event.category": "threat"
              }
            }
          },
          {
            "$state": {
              "store": "appState"
            },
            "meta": {
              "disabled": false,
              "key": "event.kind",
              "negate": false,
              "params": {
                "query": "enrichment"
              },
              "type": "phrase"
            },
            "query": {
              "match_phrase": {
                "event.kind": "enrichment"
              }
            }
          },
          {
            "$state": {
              "store": "appState"
            },
            "meta": {
              "disabled": false,
              "key": "event.type",
              "negate": false,
              "params": {
                "query": "indicator"
              },
              "type": "phrase"
            },
            "query": {
              "match_phrase": {
                "event.type": "indicator"
              }
            }
          }
        ],
        "threat_indicator_path": "threat.indicator",
        "threat_language": "kuery",
        "language": "kuery"
      },
      {
        "name": "PowerShell Script with Token Impersonation Capabilities",
        "description": "Detects scripts that contain PowerShell functions, structures, or Windows API functions related to token impersonation/theft. Attackers may duplicate then impersonate another user's token to escalate privileges and bypass access controls.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating PowerShell Script with Token Impersonation Capabilities\n\nPowerShell is one of the main tools system administrators use for automation, report routines, and other tasks. This makes it available for use in various environments, and creates an attractive way for attackers to execute code.\n\nAdversaries can abuse PowerShell to perform token impersonation, which involves duplicating and impersonating another user's token to escalate privileges and bypass access controls. This rule identifies scripts containing PowerShell functions, structures, or Windows API functions related to token impersonation/theft.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n### Possible investigation steps\n\n- Examine the script content that triggered the detection; look for suspicious DLL imports, collection or exfiltration capabilities, suspicious functions, encoded or compressed data, and other potentially malicious characteristics.\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Examine PowerShell process creation and script block logs to identify command line arguments or hardcoded information that can indicate which user was the target of the impersonation.\n- Investigate any abnormal behavior by the subject process (PowerShell), such as network connections, registry or file modifications, and any spawned child processes.\n- Evaluate whether the user needs to use PowerShell to complete tasks.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the script using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n### False positive analysis\n\n- Regular users should not need to impersonate other users, which makes false positives unlikely. In the case of authorized benign true positives (B-TPs), exceptions can be added.\n\n### Related Rules\n\n- PowerShell PSReflect Script - 56f2e9b5-4803-4e44-a0a4-a52dc79d57fe\n- Potential Process Injection via PowerShell - 2e29e96a-b67c-455a-afe4-de6183431d0d\n\n### Response and Remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Restrict PowerShell usage outside of IT and engineering business units using GPOs, AppLocker, Intune, or similar software.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).",
        "output_index": "",
        "version": 114,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Data Source: PowerShell Logs"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/decoder-it/psgetsystem",
          "https://github.com/PowerShellMafia/PowerSploit/blob/master/Privesc/Get-System.ps1",
          "https://github.com/EmpireProject/Empire/blob/master/data/module_source/privesc/Invoke-MS16032.ps1",
          "https://github.com/atc-project/atc-data/blob/master/docs/Logging_Policies/LP_0109_windows_powershell_script_block_log.md"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1134",
                "name": "Access Token Manipulation",
                "reference": "https://attack.mitre.org/techniques/T1134/",
                "subtechnique": [
                  {
                    "id": "T1134.001",
                    "name": "Token Impersonation/Theft",
                    "reference": "https://attack.mitre.org/techniques/T1134/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              },
              {
                "id": "T1106",
                "name": "Native API",
                "reference": "https://attack.mitre.org/techniques/T1106/"
              }
            ]
          }
        ],
        "setup": "The 'PowerShell Script Block Logging' logging policy must be configured (Enable).\n\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nAdministrative Templates >\nWindows PowerShell >\nTurn on PowerShell Script Block Logging (Enable)\n```\n\nSteps to implement the logging policy via registry:\n\n```\nreg add \"hklm\\SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\ScriptBlockLogging\" /v EnableScriptBlockLogging /t REG_DWORD /d 1\n```",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.directory",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "powershell.file.script_block_text",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "ed518bc0-2749-4c3d-822f-8ca08b076245",
        "rule_id": "11dd9713-0ec6-4110-9707-32daae1ee68c",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:19.668Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:04.086Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-windows.powershell*"
        ],
        "filters": [],
        "query": "event.category:process and host.os.type:windows and\n  powershell.file.script_block_text:(\n    \"Invoke-TokenManipulation\" or\n    \"ImpersonateNamedPipeClient\" or\n    \"NtImpersonateThread\" or\n    (\n      \"STARTUPINFOEX\" and\n      \"UpdateProcThreadAttribute\"\n    ) or\n    (\n      \"AdjustTokenPrivileges\" and\n      \"SeDebugPrivilege\"\n    ) or\n    (\n      (\"DuplicateToken\" or\n      \"DuplicateTokenEx\") and\n      (\"SetThreadToken\" or\n      \"ImpersonateLoggedOnUser\" or\n      \"CreateProcessWithTokenW\" or\n      \"CreatePRocessAsUserW\" or\n      \"CreateProcessAsUserA\")\n    ) \n  ) and\n  not (\n    user.id:(\"S-1-5-18\" or \"S-1-5-19\" or \"S-1-5-20\") and\n    file.directory: \"C:\\\\ProgramData\\\\Microsoft\\\\Windows Defender Advanced Threat Protection\\\\Downloads\"\n  ) and\n  not powershell.file.script_block_text : (\n    \"sentinelbreakpoints\" and \"Set-PSBreakpoint\" and \"PowerSploitIndicators\"\n  ) and\n  not (\n    powershell.file.script_block_text : \"New-HPPrivateToastNotificationLogo\" and\n    file.path : \"C:\\Program Files\\HPConnect\\hp-cmsl-wl\\modules\\HP.Notifications\\HP.Notifications.psm1\"\n  )",
        "language": "kuery"
      },
      {
        "name": "Potential Exploitation of an Unquoted Service Path Vulnerability",
        "description": "Adversaries may leverage unquoted service path vulnerabilities to escalate privileges. By placing an executable in a higher-level directory within the path of an unquoted service executable, Windows will natively launch this executable from its defined path variable instead of the benign one in a deeper directory, thus leading to code execution.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 203,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Data Source: Elastic Defend",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: SentinelOne",
          "Data Source: Elastic Endgame",
          "Data Source: Sysmon",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1574",
                "name": "Hijack Execution Flow",
                "reference": "https://attack.mitre.org/techniques/T1574/",
                "subtechnique": [
                  {
                    "id": "T1574.009",
                    "name": "Path Interception by Unquoted Path",
                    "reference": "https://attack.mitre.org/techniques/T1574/009/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "164e5c56-8758-4b76-bedd-0ccf1a56f4c5",
        "rule_id": "12de29d4-bbb0-4eef-b687-857e8a163870",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:19.673Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:16.395Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and \n  (\n    process.executable : \"?:\\\\Program.exe\" or \n    process.executable regex \"\"\"(C:\\\\Program Files \\(x86\\)\\\\|C:\\\\Program Files\\\\)\\w+.exe\"\"\"\n  )",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "endgame-*",
          "logs-windows.sysmon_operational-*",
          "logs-system.security-*"
        ],
        "filters": []
      },
      {
        "name": "Renamed Utility Executed with Short Program Name",
        "description": "Identifies the execution of a process with a single character process name, differing from the original file name. This is often done by adversaries while staging, executing temporary utilities, or trying to bypass security detections based on the process name.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Renamed Utility Executed with Short Program Name\n\nIdentifies the execution of a process with a single character process name, differing from the original file name. This is often done by adversaries while staging, executing temporary utilities, or trying to bypass security detections based on the process name.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate any abnormal behavior by the subject process such as network connections, registry or file modifications, command line and any spawned child processes.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the process executable using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 210,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Endgame",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: Microsoft Defender for Endpoint"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1036",
                "name": "Masquerading",
                "reference": "https://attack.mitre.org/techniques/T1036/",
                "subtechnique": [
                  {
                    "id": "T1036.003",
                    "name": "Rename System Utilities",
                    "reference": "https://attack.mitre.org/techniques/T1036/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "ab1eac4b-29f4-42c2-97e8-b83a5236dbc9",
        "rule_id": "17c7f6a5-5bc9-4e1f-92bf-13632d24384d",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:19.675Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:04.267Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and length(process.name) > 0 and\n length(process.name) == 5 and length(process.pe.original_file_name) > 5",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-m365_defender.event-*"
        ],
        "filters": []
      },
      {
        "name": "PowerShell Suspicious Payload Encoded and Compressed",
        "description": "Identifies the use of .NET functionality for decompression and base64 decoding combined in PowerShell scripts, which malware and security tools heavily use to deobfuscate payloads and load them directly in memory to bypass defenses.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating PowerShell Suspicious Payload Encoded and Compressed\n\nPowerShell is one of the main tools system administrators use for automation, report routines, and other tasks. This makes it available for use in various environments, and creates an attractive way for attackers to execute code.\n\nAttackers can embed compressed and encoded payloads in scripts to load directly into the memory without touching the disk. This strategy can circumvent string and file-based security protections.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Examine the script content that triggered the detection; look for suspicious DLL imports, collection or exfiltration capabilities, suspicious functions, encoded or compressed data, and other potentially malicious characteristics.\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Examine file or network events from the involved PowerShell process for suspicious behavior.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Evaluate whether the user needs to use PowerShell to complete tasks.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the script using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately outside engineering or IT business units. As long as the analyst did not identify malware or suspicious activity related to the user or host, this alert can be dismissed.\n\n### Related rules\n\n- PowerShell PSReflect Script - 56f2e9b5-4803-4e44-a0a4-a52dc79d57fe\n- Potential Process Injection via PowerShell - 2e29e96a-b67c-455a-afe4-de6183431d0d\n- Suspicious .NET Reflection via PowerShell - e26f042e-c590-4e82-8e05-41e81bd822ad\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Restrict PowerShell usage outside of IT and engineering business units using GPOs, AppLocker, Intune, or similar software.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 314,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Resources: Investigation Guide",
          "Data Source: PowerShell Logs"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Legitimate PowerShell Scripts which makes use of compression and encoding."
        ],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1027",
                "name": "Obfuscated Files or Information",
                "reference": "https://attack.mitre.org/techniques/T1027/"
              },
              {
                "id": "T1140",
                "name": "Deobfuscate/Decode Files or Information",
                "reference": "https://attack.mitre.org/techniques/T1140/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'PowerShell Script Block Logging' logging policy must be enabled.\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nAdministrative Templates >\nWindows PowerShell >\nTurn on PowerShell Script Block Logging (Enable)\n```\n\nSteps to implement the logging policy via registry:\n\n```\nreg add \"hklm\\SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\ScriptBlockLogging\" /v EnableScriptBlockLogging /t REG_DWORD /d 1\n```\n",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "powershell.file.script_block_text",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "eeac4605-bb59-4940-806a-4a0f35e102f8",
        "rule_id": "81fe9dc6-a2d7-4192-a2d8-eed98afc766a",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:19.680Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:04.142Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-windows.powershell*"
        ],
        "filters": [
          {
            "meta": {
              "negate": true
            },
            "query": {
              "wildcard": {
                "file.path": {
                  "case_insensitive": true,
                  "value": "?:\\\\ProgramData\\\\Microsoft\\\\Windows Defender Advanced Threat Protection\\\\Downloads\\\\*"
                }
              }
            }
          }
        ],
        "query": "event.category:process and host.os.type:windows and\n  powershell.file.script_block_text : (\n    (\n      \"System.IO.Compression.DeflateStream\" or\n      \"System.IO.Compression.GzipStream\" or\n      \"IO.Compression.DeflateStream\" or\n      \"IO.Compression.GzipStream\"\n    ) and\n    FromBase64String\n  ) and\n  not user.id : \"S-1-5-18\"",
        "language": "kuery"
      },
      {
        "name": "Potential Linux Local Account Brute Force Detected",
        "description": "Identifies multiple consecutive login attempts executed by one process targeting a local linux user account within a short time interval. Adversaries might brute force login attempts across different users with a default wordlist or a set of customly crafted passwords in an attempt to gain access to these accounts.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 7,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1110",
                "name": "Brute Force",
                "reference": "https://attack.mitre.org/techniques/T1110/",
                "subtechnique": [
                  {
                    "id": "T1110.001",
                    "name": "Password Guessing",
                    "reference": "https://attack.mitre.org/techniques/T1110/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "42b418e7-f751-4c38-beee-4bd470d1e45c",
        "rule_id": "835c0622-114e-40b5-a346-f843ea5d01f1",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:19.685Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:17.198Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by host.id, process.parent.executable, user.id with maxspan=1s\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and process.name == \"su\" and \n   not process.parent.name in (\n     \"bash\", \"dash\", \"ash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\", \"clickhouse-server\", \"ma\", \"gitlab-runner\",\n     \"updatedb.findutils\", \"cron\", \"perl\", \"sudo\", \"java\", \"cloud-app-identify\", \"ambari-sudo.sh\"\n   )\n  ] with runs=10",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Microsoft Exchange Transport Agent Install Script",
        "description": "Identifies the use of Cmdlets and methods related to Microsoft Exchange Transport Agents install. Adversaries may leverage malicious Microsoft Exchange Transport Agents to execute tasks in response to adversary-defined criteria, establishing persistence.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 107,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Data Source: PowerShell Logs",
          "Rule Type: BBR"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1505",
                "name": "Server Software Component",
                "reference": "https://attack.mitre.org/techniques/T1505/",
                "subtechnique": [
                  {
                    "id": "T1505.002",
                    "name": "Transport Agent",
                    "reference": "https://attack.mitre.org/techniques/T1505/002/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'PowerShell Script Block Logging' logging policy must be enabled.\nSteps to implement the logging policy with Advanced Audit Configuration:\n```\nComputer Configuration >\nAdministrative Templates >\nWindows PowerShell >\nTurn on PowerShell Script Block Logging (Enable)\n```\nSteps to implement the logging policy via registry:\n```\nreg add \"hklm\\SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\ScriptBlockLogging\" /v EnableScriptBlockLogging /t REG_DWORD /d 1\n```\n",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "powershell.file.script_block_text",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "c5708eb9-2fec-45b2-82d8-9acaee339ca8",
        "rule_id": "846fe13f-6772-4c83-bd39-9d16d4ad1a81",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:19.687Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:17.202Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-windows.powershell*"
        ],
        "filters": [
          {
            "meta": {
              "negate": true
            },
            "query": {
              "wildcard": {
                "file.path": {
                  "case_insensitive": true,
                  "value": "?:\\\\Users\\\\*\\\\AppData\\\\Roaming\\\\Microsoft\\\\Exchange\\\\RemotePowerShell\\\\*"
                }
              }
            }
          },
          {
            "meta": {
              "negate": true
            },
            "query": {
              "wildcard": {
                "file.path": {
                  "case_insensitive": true,
                  "value": "?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\tmp_????????.???\\\\tmp_????????.???.ps?1"
                }
              }
            }
          },
          {
            "meta": {
              "negate": true
            },
            "query": {
              "wildcard": {
                "file.path": {
                  "case_insensitive": true,
                  "value": "?:\\\\Windows\\\\TEMP\\\\tmp_????????.???\\\\tmp_????????.???.ps?1"
                }
              }
            }
          },
          {
            "meta": {
              "negate": true
            },
            "query": {
              "wildcard": {
                "file.path": {
                  "case_insensitive": true,
                  "value": "?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\*\\\\tmp_????????.???\\\\tmp_????????.???.ps?1"
                }
              }
            }
          }
        ],
        "query": "event.category: \"process\" and host.os.type:windows and\n  powershell.file.script_block_text : (\n    (\n    \"Install-TransportAgent\" or\n    \"Enable-TransportAgent\"\n    )\n  ) and\n  not user.id : \"S-1-5-18\" and\n  not powershell.file.script_block_text : (\n    \"'Install-TransportAgent', 'Invoke-MonitoringProbe', 'Mount-Database', 'Move-ActiveMailboxDatabase',\" or\n    \"'Enable-TransportAgent', 'Enable-TransportRule', 'Export-ActiveSyncLog', 'Export-AutoDiscoverConfig',\" or\n    (\"scriptCmd.GetSteppablePipeline\" and \"ForwardHelpTargetName Install-TransportAgent\")\n  )",
        "language": "kuery"
      },
      {
        "name": "Enumerating Domain Trusts via NLTEST.EXE",
        "description": "Identifies the use of nltest.exe for domain trust discovery purposes. Adversaries may use this command-line utility to enumerate domain trusts and gain insight into trust relationships, as well as the state of Domain Controller (DC) replication in a Microsoft Windows NT Domain.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Enumerating Domain Trusts via NLTEST.EXE\n\nActive Directory (AD) domain trusts define relationships between domains within a Windows AD environment. In this setup, a \"trusting\" domain permits users from a \"trusted\" domain to access resources. These trust relationships can be configurable as one-way, two-way, transitive, or non-transitive, enabling controlled access and resource sharing across domains.\n\nThis rule identifies the usage of the `nltest.exe` utility to enumerate domain trusts. Attackers can use this information to enable the next actions in a target environment, such as lateral movement.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n\n### False positive analysis\n\n- Discovery activities are not inherently malicious if they occur in isolation and are done within the user business context (e.g., an administrator in this context). As long as the analyst did not identify suspicious activity related to the user or host, such alerts can be dismissed.\n\n### Related rules\n\n- Enumerating Domain Trusts via DSQUERY.EXE - 06a7a03c-c735-47a6-a313-51c354aef6c3\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Restrict PowerShell usage outside of IT and engineering business units using GPOs, AppLocker, Intune, or similar software.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 214,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Data Source: Elastic Endgame",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Domain administrators may use this command-line utility for legitimate information gathering purposes, but it is not common for environments with Windows Server 2012 and newer."
        ],
        "references": [
          "https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/cc731935(v=ws.11)",
          "https://redcanary.com/blog/how-one-hospital-thwarted-a-ryuk-ransomware-outbreak/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1018",
                "name": "Remote System Discovery",
                "reference": "https://attack.mitre.org/techniques/T1018/"
              },
              {
                "id": "T1482",
                "name": "Domain Trust Discovery",
                "reference": "https://attack.mitre.org/techniques/T1482/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "84f6329a-5e15-4869-a803-398c1d9497a4",
        "rule_id": "84da2554-e12a-11ec-b896-f661ea17fbcd",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:19.693Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:06.004Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n    process.name : \"nltest.exe\" and process.args : (\n        \"/DCLIST:*\", \"/DCNAME:*\", \"/DSGET*\",\n        \"/LSAQUERYFTI:*\", \"/PARENTDOMAIN\",\n        \"/DOMAIN_TRUSTS\", \"/BDC_QUERY:*\"\n        ) and \nnot process.parent.name : \"PDQInventoryScanner.exe\" and \nnot user.id in (\"S-1-5-18\", \"S-1-5-19\", \"S-1-5-20\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Attempt to Deactivate an Okta Network Zone",
        "description": "Detects attempts to deactivate an Okta network zone. Okta network zones can be configured to limit or restrict access to a network based on IP addresses or geolocations. An adversary may attempt to modify, delete, or deactivate an Okta network zone in order to remove or weaken an organization's security controls.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Attempt to Deactivate an Okta Network Zone\n\nThe Okta network zones can be configured to restrict or limit access to a network based on IP addresses or geolocations. Deactivating a network zone in Okta may remove or weaken the security controls of an organization, which might be an indicator of an adversary's attempt to evade defenses.\n\n#### Possible investigation steps\n\n- Identify the actor related to the alert by reviewing the `okta.actor.id`, `okta.actor.type`, `okta.actor.alternate_id`, or `okta.actor.display_name` fields.\n- Examine the `event.action` field to confirm the deactivation of a network zone.\n- Check the `okta.target.id`, `okta.target.type`, `okta.target.alternate_id`, or `okta.target.display_name` to identify the network zone that was deactivated.\n- Investigate the `event.time` field to understand when the event happened.\n- Review the actor's activities before and after the event to understand the context of this event.\n\n### False positive analysis\n\n- Check the `okta.client.user_agent.raw_user_agent` field to understand the device and software used by the actor. If these match the actor's normal behavior, it might be a false positive.\n- Check if the actor is a known administrator or part of the IT team who might have a legitimate reason to deactivate a network zone.\n- Verify the actor's actions with any known planned changes or maintenance activities.\n\n### Response and remediation\n\n- If unauthorized access or actions are confirmed, immediately lock the affected actor account and require a password change.\n- Re-enable the deactivated network zone if it was deactivated without authorization.\n- Review and update the privileges of the actor who initiated the deactivation.\n- Check the security policies and procedures to identify any gaps and update them as necessary.\n- Implement additional monitoring and logging of Okta events to improve visibility of user actions.\n- Communicate and train the employees about the importance of following proper procedures for modifying network zone settings.",
        "output_index": "",
        "version": 410,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Data Source: Okta",
          "Use Case: Network Security Monitoring",
          "Tactic: Defense Evasion"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Consider adding exceptions to this rule to filter false positives if your organization's Okta network zones are regularly modified."
        ],
        "references": [
          "https://help.okta.com/en/prod/Content/Topics/Security/network/network-zones.htm",
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.007",
                    "name": "Disable or Modify Cloud Firewall",
                    "reference": "https://attack.mitre.org/techniques/T1562/007/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "bdad3bfe-0616-4f5a-8d20-2714ae6d2629",
        "rule_id": "8a5c1e5f-ad63-481e-b53a-ef959230f7f1",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:19.723Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:06.007Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset:okta.system and event.action:zone.deactivate",
        "language": "kuery"
      },
      {
        "name": "PowerShell Suspicious Script with Clipboard Retrieval Capabilities",
        "description": "Detects PowerShell scripts that can get the contents of the clipboard, which attackers can abuse to retrieve sensitive information like credentials, messages, etc.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating PowerShell Suspicious Script with Clipboard Retrieval Capabilities\n\nPowerShell is one of the main tools system administrators use for automation, report routines, and other tasks. This makes it available for use in various environments, and creates an attractive way for attackers to execute code.\n\nAttackers can abuse PowerShell capabilities to get the contents of the clipboard with the goal of stealing credentials and other valuable information, such as credit card data and confidential conversations.\n\n#### Possible investigation steps\n\n- Examine the script content that triggered the detection; look for suspicious DLL imports, collection or exfiltration capabilities, suspicious functions, encoded or compressed data, and other potentially malicious characteristics.\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Examine file or network events from the involved PowerShell process for suspicious behavior.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Evaluate whether the user needs to use PowerShell to complete tasks.\n- Determine whether the script stores the captured data locally.\n- Investigate whether the script contains exfiltration capabilities and identify the exfiltration server.\n- Assess network data to determine if the host communicated with the exfiltration server.\n\n### False positive analysis\n\n- Regular users are unlikely to use scripting utilities to capture contents of the clipboard, making false positives unlikely. In the case of authorized benign true positives (B-TPs), exceptions can be added.\n\n### Related rules\n\n- PowerShell Keylogging Script - bd2c86a0-8b61-4457-ab38-96943984e889\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Prioritize the response if this alert involves key executives or potentially valuable targets for espionage.\n- Restrict PowerShell usage outside of IT and engineering business units using GPOs, AppLocker, Intune, or similar software.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 210,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Collection",
          "Data Source: PowerShell Logs",
          "Resources: Investigation Guide"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.management/get-clipboard",
          "https://github.com/EmpireProject/Empire/blob/master/data/module_source/collection/Get-ClipboardContents.ps1"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0009",
              "name": "Collection",
              "reference": "https://attack.mitre.org/tactics/TA0009/"
            },
            "technique": [
              {
                "id": "T1115",
                "name": "Clipboard Data",
                "reference": "https://attack.mitre.org/techniques/T1115/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'PowerShell Script Block Logging' logging policy must be enabled.\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nAdministrative Templates >\nWindows PowerShell >\nTurn on PowerShell Script Block Logging (Enable)\n```\n\nSteps to implement the logging policy via registry:\n\n```\nreg add \"hklm\\SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\ScriptBlockLogging\" /v EnableScriptBlockLogging /t REG_DWORD /d 1\n```\n",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "powershell.file.script_block_text",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "e067ff7e-4b12-4481-8f36-ea18c3640e4e",
        "rule_id": "92984446-aefb-4d5e-ad12-598042ca80ba",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:20.069Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:04.146Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-windows.powershell*"
        ],
        "filters": [
          {
            "meta": {
              "negate": true
            },
            "query": {
              "wildcard": {
                "file.path": {
                  "case_insensitive": true,
                  "value": "?:\\\\program?files\\\\powershell\\\\?\\\\Modules\\\\*.psd1"
                }
              }
            }
          },
          {
            "meta": {
              "negate": true
            },
            "query": {
              "wildcard": {
                "file.path": {
                  "case_insensitive": true,
                  "value": "?:\\\\Windows\\\\system32\\\\WindowsPowerShell\\\\v1.0\\\\Modules\\\\*.psd1"
                }
              }
            }
          },
          {
            "meta": {
              "negate": true
            },
            "query": {
              "wildcard": {
                "file.path": {
                  "case_insensitive": true,
                  "value": "?:\\\\Program?Files\\\\WindowsPowerShell\\\\Modules\\\\*.ps?1"
                }
              }
            }
          }
        ],
        "query": "event.category:process and host.os.type:windows and\n  (powershell.file.script_block_text : (\n    \"Windows.Clipboard\" or\n    \"Windows.Forms.Clipboard\" or\n    \"Windows.Forms.TextBox\"\n   ) and\n   powershell.file.script_block_text : (\n    \"]::GetText\" or\n    \".Paste()\"\n  )) or powershell.file.script_block_text : \"Get-Clipboard\" and\n  not powershell.file.script_block_text : (\n    \"sentinelbreakpoints\" and \"Set-PSBreakpoint\" and \"PowerSploitIndicators\"\n  ) and\n  not user.id : \"S-1-5-18\" and\n  not (\n    file.path : C\\:\\\\Program?Files\\\\WindowsPowerShell\\\\*Modules*.ps1 and\n    file.name : (\"Convert-ExcelRangeToImage.ps1\" or \"Read-Clipboard.ps1\")\n  )",
        "language": "kuery"
      },
      {
        "name": "Potentially Successful MFA Bombing via Push Notifications",
        "description": "Detects when an attacker abuses the Multi-Factor authentication mechanism by repeatedly issuing login requests until the user eventually accepts the Okta push notification. An adversary may attempt to bypass the Okta MFA policies configured for an organization to obtain unauthorized access.",
        "risk_score": 73,
        "severity": "high",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Potential Abuse of Repeated MFA Push Notifications\n\nMulti-Factor Authentication (MFA) is an effective method to prevent unauthorized access. However, some adversaries may abuse the system by repeatedly sending MFA push notifications until the user unwittingly approves the access.\n\nThis rule detects when a user denies MFA Okta Verify push notifications twice, followed by a successful authentication event within a 10-minute window. This sequence could indicate an adversary's attempt to bypass the Okta MFA policy.\n\n#### Possible investigation steps:\n\n- Identify the user who received the MFA notifications by reviewing the `user.email` field.\n- Identify the time, source IP, and geographical location of the MFA requests and the subsequent successful login.\n- Review the `event.action` field to understand the nature of the events. It should include two `user.mfa.okta_verify.deny_push` actions and one `user.authentication.sso` action.\n- Ask the user if they remember receiving the MFA notifications and subsequently logging into their account.\n- Check if the MFA requests and the successful login occurred during the user's regular activity hours.\n- Look for any other suspicious activity on the account around the same time.\n- Identify whether the same pattern is repeated for other users in your organization. Multiple users receiving push notifications simultaneously might indicate a larger attack.\n\n### False positive analysis:\n\n- Determine if the MFA push notifications were legitimate. Sometimes, users accidentally trigger MFA requests or deny them unintentionally and later approve them.\n- Check if there are known issues with the MFA system causing false denials.\n\n### Response and remediation:\n\n- If unauthorized access is confirmed, initiate your incident response process.\n- Alert the user and your IT department immediately.\n- If possible, isolate the user's account until the issue is resolved.\n- Investigate the source of the unauthorized access.\n- If the account was accessed by an unauthorized party, determine the actions they took after logging in.\n- Consider enhancing your MFA policy to prevent such incidents in the future.\n- Encourage users to report any unexpected MFA notifications immediately.\n- Review and update your incident response plans and security policies based on the findings from the incident.",
        "output_index": "",
        "version": 413,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Data Source: Okta",
          "Tactic: Credential Access"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.mandiant.com/resources/russian-targeting-gov-business",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://sec.okta.com/articles/2023/08/cross-tenant-impersonation-prevention-and-detection",
          "https://www.rezonate.io/blog/okta-logs-decoded-unveiling-identity-threats-through-threat-hunting/",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1621",
                "name": "Multi-Factor Authentication Request Generation",
                "reference": "https://attack.mitre.org/techniques/T1621/"
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.module",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "okta.actor.id",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "okta.outcome.result",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "03b9747e-0260-4b62-972a-f543cf36a0cc",
        "rule_id": "97a8e584-fd3b-421f-9b9d-9c9d9e57e9d7",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:20.132Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:06.025Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by okta.actor.id with maxspan=10m\n  [authentication where event.dataset == \"okta.system\" and event.module == \"okta\"\n    and event.action == \"user.mfa.okta_verify.deny_push\"] with runs=3\n  [authentication where event.dataset == \"okta.system\" and event.module == \"okta\"\n    and (event.action : (\n      \"user.authentication.sso\",\n      \"user.authentication.auth_via_mfa\",\n      \"user.authentication.verify\",\n      \"user.session.start\") and okta.outcome.result == \"SUCCESS\")]",
        "language": "eql",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "event_category_override": "event.category"
      },
      {
        "name": "Suspicious Zoom Child Process",
        "description": "A suspicious Zoom child process was detected, which may indicate an attempt to run unnoticed. Verify process details such as command line, network connections, file writes and associated file signature details as well.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Suspicious Zoom Child Process\n\nBy examining the specific traits of Windows binaries -- such as process trees, command lines, network connections, registry modifications, and so on -- it's possible to establish a baseline of normal activity. Deviations from this baseline can indicate malicious activity, such as masquerading, and deserve further investigation.\n\nThis rule identifies a potential malicious process masquerading as `Zoom.exe` or exploiting a vulnerability in the application causing it to execute code.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate any abnormal behavior by the subject process such as network connections, registry or file modifications, and any spawned child processes.\n- Examine the command line of the child process to determine which commands or scripts were executed.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the process executable using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 416,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Tactic: Execution",
          "Data Source: Elastic Endgame",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend",
          "Data Source: SentinelOne",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: System",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1036",
                "name": "Masquerading",
                "reference": "https://attack.mitre.org/techniques/T1036/"
              },
              {
                "id": "T1055",
                "name": "Process Injection",
                "reference": "https://attack.mitre.org/techniques/T1055/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1203",
                "name": "Exploitation for Client Execution",
                "reference": "https://attack.mitre.org/techniques/T1203/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "bca59700-fd00-4b64-811b-9642eed23ec3",
        "rule_id": "97aba1ef-6034-4bd3-8c1a-1e0996b27afa",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:20.158Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:06.028Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n process.parent.name : \"Zoom.exe\" and process.name : (\"cmd.exe\", \"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.*",
          "endgame-*",
          "logs-system.security*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-m365_defender.event-*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Potential Privilege Escalation through Writable Docker Socket",
        "description": "This rule monitors for the usage of Docker runtime sockets to escalate privileges on Linux systems. Docker sockets by default are only be writable by the root user and docker group. Attackers that have permissions to write to these sockets may be able to create and run a container that allows them to escalate privileges and gain further access onto the host file system.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 5,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Domain: Container",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://book.hacktricks.xyz/linux-hardening/privilege-escalation/docker-security/docker-breakout-privilege-escalation#automatic-enumeration-and-escape"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1611",
                "name": "Escape to Host",
                "reference": "https://attack.mitre.org/techniques/T1611/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "group.Ext.real.id",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.Ext.real.id",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "c8665bb6-d648-4e19-93b0-57d6527e7cc8",
        "rule_id": "7acb2de3-8465-472a-8d9c-ccd7b73d0ed8",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:24.774Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:17.187Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and \n(\n  (process.name == \"docker\" and process.args : \"run\" and process.args : \"-it\"  and \n   process.args : (\"unix://*/docker.sock\", \"unix://*/dockershim.sock\")) or \n  (process.name == \"socat\" and process.args : (\"UNIX-CONNECT:*/docker.sock\", \"UNIX-CONNECT:*/dockershim.sock\"))\n) and not user.Ext.real.id : \"0\" and not group.Ext.real.id : \"0\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "WMI Incoming Lateral Movement",
        "description": "Identifies processes executed via Windows Management Instrumentation (WMI) on a remote host. This could be indicative of adversary lateral movement, but could be noisy if administrators use WMI to remotely manage hosts.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 210,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Lateral Movement",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1021",
                "name": "Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1021/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1047",
                "name": "Windows Management Instrumentation",
                "reference": "https://attack.mitre.org/techniques/T1047/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.port",
            "type": "long",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "network.direction",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.Ext.token.integrity_level_name",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "source.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "source.port",
            "type": "long",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.event_data.IntegrityLevel",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "44f7f956-872e-42d7-bc09-d2e62cb31f10",
        "rule_id": "f3475224-b179-4f78-8877-c2bd64c26b88",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:24.776Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:04.200Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by host.id with maxspan = 2s\n\n /* Accepted Incoming RPC connection by Winmgmt service */\n\n  [network where host.os.type == \"windows\" and process.name : \"svchost.exe\" and network.direction : (\"incoming\", \"ingress\") and\n   source.ip != \"127.0.0.1\" and source.ip != \"::1\" and source.port >= 49152 and destination.port >= 49152\n  ]\n\n  /* Excluding Common FPs Nessus and SCCM */\n\n  [process where host.os.type == \"windows\" and event.type == \"start\" and process.parent.name : \"WmiPrvSE.exe\" and\n   not (?process.Ext.token.integrity_level_name : \"System\" or ?winlog.event_data.IntegrityLevel : \"System\") and\n   not user.id : (\"S-1-5-18\", \"S-1-5-19\", \"S-1-5-20\") and\n   not process.executable :\n               (\"?:\\\\Program Files\\\\HPWBEM\\\\Tools\\\\hpsum_swdiscovery.exe\",\n                \"?:\\\\Windows\\\\CCM\\\\Ccm32BitLauncher.exe\",\n                \"?:\\\\Windows\\\\System32\\\\wbem\\\\mofcomp.exe\",\n                \"?:\\\\Windows\\\\Microsoft.NET\\\\Framework*\\\\csc.exe\",\n                \"?:\\\\Windows\\\\System32\\\\powercfg.exe\") and\n   not (process.executable : \"?:\\\\Windows\\\\System32\\\\msiexec.exe\" and process.args : \"REBOOT=ReallySuppress\") and\n   not (process.executable : \"?:\\\\Windows\\\\System32\\\\inetsrv\\\\appcmd.exe\" and process.args : \"uninstall\")\n   ]",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "logs-endpoint.events.network-*",
          "winlogbeat-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "Potential External Linux SSH Brute Force Detected",
        "description": "Identifies multiple external consecutive login failures targeting a user account from the same source address within a short time interval. Adversaries will often brute force login attempts across multiple users with a common or known password, in an attempt to gain access to these accounts.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Potential External Linux SSH Brute Force Detected\n\nThe rule identifies consecutive SSH login failures targeting a user account from the same source IP address to the same target host indicating brute force login attempts.\n\nThis rule will generate a lot of noise for systems with a front-facing SSH service, as adversaries scan the internet for remotely accessible SSH services and try to brute force them to gain unauthorized access. \n\nIn case this rule generates too much noise and external brute forcing is of not much interest, consider turning this rule off and enabling \"Potential Internal Linux SSH Brute Force Detected\" to detect internal brute force attempts.\n\n#### Possible investigation steps\n\n- Investigate the login failure user name(s).\n- Investigate the source IP address of the failed ssh login attempt(s).\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Identify the source and the target computer and their roles in the IT environment.\n\n### False positive analysis\n\n- Authentication misconfiguration or obsolete credentials.\n- Service account password expired.\n- Infrastructure or availability issue.\n\n### Related Rules\n\n- Potential Internal Linux SSH Brute Force Detected - 1c27fa22-7727-4dd3-81c0-de6da5555feb\n- Potential SSH Password Guessing - 8cb84371-d053-4f4f-bce0-c74990e28f28\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 7,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Credential Access"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 5,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1110",
                "name": "Brute Force",
                "reference": "https://attack.mitre.org/techniques/T1110/",
                "subtechnique": [
                  {
                    "id": "T1110.001",
                    "name": "Password Guessing",
                    "reference": "https://attack.mitre.org/techniques/T1110/001/"
                  },
                  {
                    "id": "T1110.003",
                    "name": "Password Spraying",
                    "reference": "https://attack.mitre.org/techniques/T1110/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Filebeat.\n\n### Filebeat Setup\nFilebeat is a lightweight shipper for forwarding and centralizing log data. Installed as an agent on your servers, Filebeat monitors the log files or locations that you specify, collects log events, and forwards them either to Elasticsearch or Logstash for indexing.\n\n#### The following steps should be executed in order to add the Filebeat on a Linux System:\n- Elastic provides repositories available for APT and YUM-based distributions. Note that we provide binary packages, but no source packages.\n- To install the APT and YUM repositories follow the setup instructions in this [helper guide](https://www.elastic.co/guide/en/beats/filebeat/current/setup-repositories.html).\n- To run Filebeat on Docker follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/filebeat/current/running-on-docker.html).\n- To run Filebeat on Kubernetes follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/filebeat/current/running-on-kubernetes.html).\n- For quick start information for Filebeat refer to the [helper guide](https://www.elastic.co/guide/en/beats/filebeat/8.11/filebeat-installation-configuration.html).\n- For complete â€œSetup and Run Filebeatâ€ information refer to the [helper guide](https://www.elastic.co/guide/en/beats/filebeat/current/setting-up-and-running.html).\n\n#### Rule Specific Setup Note\n- This rule requires the â€œFilebeat System Moduleâ€ to be enabled.\n- The system module collects and parses logs created by the system logging service of common Unix/Linux based distributions.\n- To run the system module of Filebeat on Linux follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-module-system.html).\n",
        "related_integrations": [
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "source.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "user.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "2461bf8d-cffd-4158-9b49-61ba846b86f1",
        "rule_id": "fa210b61-b627-4e5e-86f4-17e8270656ab",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:24.804Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:07.041Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by host.id, source.ip, user.name with maxspan=15s\n  [ authentication where host.os.type == \"linux\" and \n   event.action in (\"ssh_login\", \"user_login\") and event.outcome == \"failure\" and\n   not cidrmatch(source.ip, \"10.0.0.0/8\", \"127.0.0.0/8\", \"169.254.0.0/16\", \"172.16.0.0/12\", \"192.0.0.0/24\",\n       \"192.0.0.0/29\", \"192.0.0.8/32\", \"192.0.0.9/32\", \"192.0.0.10/32\", \"192.0.0.170/32\", \"192.0.0.171/32\",\n       \"192.0.2.0/24\", \"192.31.196.0/24\", \"192.52.193.0/24\", \"192.168.0.0/16\", \"192.88.99.0/24\", \"224.0.0.0/4\",\n       \"100.64.0.0/10\", \"192.175.48.0/24\",\"198.18.0.0/15\", \"198.51.100.0/24\", \"203.0.113.0/24\", \"240.0.0.0/4\", \n       \"::1\", \"FE80::/10\", \"FF00::/8\") ] with runs = 10",
        "language": "eql",
        "index": [
          "filebeat-*",
          "logs-system.auth-*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious Data Encryption via OpenSSL Utility",
        "description": "Identifies when the openssl command-line utility is used to encrypt multiple files on a host within a short time window. Adversaries may encrypt data on a single or multiple systems in order to disrupt the availability of their target's data and may attempt to hold the organization's data to ransom for the purposes of extortion.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 6,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Impact",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.welivesecurity.com/2017/06/30/telebots-back-supply-chain-attacks-against-ukraine/",
          "https://www.trendmicro.com/en_us/research/21/f/bash-ransomware-darkradiation-targets-red-hat--and-debian-based-linux-distributions.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0040",
              "name": "Impact",
              "reference": "https://attack.mitre.org/tactics/TA0040/"
            },
            "technique": [
              {
                "id": "T1486",
                "name": "Data Encrypted for Impact",
                "reference": "https://attack.mitre.org/techniques/T1486/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "29db19bf-a202-4425-bd59-9dd1a99b825f",
        "rule_id": "f530ca17-153b-4a7a-8cd3-98dd4b4ddf73",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:24.802Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:17.278Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by host.id, user.name, process.parent.entity_id with maxspan=5s\n  [ process where host.os.type == \"linux\" and event.action == \"exec\" and \n    process.name == \"openssl\" and process.parent.name : (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\", \"perl*\", \"php*\", \"python*\", \"xargs\") and\n    process.args == \"-in\" and process.args == \"-out\" and\n    process.args in (\"-k\", \"-K\", \"-kfile\", \"-pass\", \"-iv\", \"-md\") and\n    /* excluding base64 encoding options and including encryption password or key params */\n    not process.args in (\"-d\", \"-a\", \"-A\", \"-base64\", \"-none\", \"-nosalt\") ] with runs=10",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious Antimalware Scan Interface DLL",
        "description": "Identifies the creation of the Antimalware Scan Interface (AMSI) DLL in an unusual location. This may indicate an attempt to bypass AMSI by loading a rogue AMSI module instead of the legit one.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Suspicious Antimalware Scan Interface DLL\n\nThe Windows Antimalware Scan Interface (AMSI) is a versatile interface standard that allows your applications and services to integrate with any antimalware product on a machine. AMSI integrates with multiple Windows components, ranging from User Account Control (UAC) to VBA macros and PowerShell.\n\nAttackers might copy a rogue AMSI DLL to an unusual location to prevent the process from loading the legitimate module, achieving a bypass to execute malicious code.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Identify the process that created the DLL and which account was used.\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate the execution of scripts and macros after the registry modification.\n- Investigate other processes launched from the directory that the DLL was created.\n- Inspect the host for suspicious or abnormal behavior in the alert timeframe:\n  - Observe and collect information about the following activities in the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n\n### False positive analysis\n\n- This modification should not happen legitimately. Any potential benign true positive (B-TP) should be mapped and monitored by the security team as these modifications expose the host to malware infections.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 313,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Endgame",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Microsoft Defender for Endpoint"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/S3cur3Th1sSh1t/Amsi-Bypass-Powershell"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.001",
                    "name": "Disable or Modify Tools",
                    "reference": "https://attack.mitre.org/techniques/T1562/001/"
                  }
                ]
              },
              {
                "id": "T1574",
                "name": "Hijack Execution Flow",
                "reference": "https://attack.mitre.org/techniques/T1574/",
                "subtechnique": [
                  {
                    "id": "T1574.001",
                    "name": "DLL Search Order Hijacking",
                    "reference": "https://attack.mitre.org/techniques/T1574/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "b6331a44-cb7b-4ed5-985e-d129ce3f5fa9",
        "rule_id": "fa488440-04cc-41d7-9279-539387bf2a17",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:24.809Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:04.212Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"windows\" and event.type != \"deletion\" and file.path != null and\n  file.name : (\"amsi.dll\", \"amsi\") and\n  not file.path : (\n    \"?:\\\\Windows\\\\system32\\\\amsi.dll\",\n    \"?:\\\\Windows\\\\Syswow64\\\\amsi.dll\",\n    \"?:\\\\$WINDOWS.~BT\\\\DUImageSandbox\\\\*\",\n    \"?:\\\\$WINDOWS.~BT\\\\NewOS\\\\Windows\\\\WinSXS\\\\*\",\n    \"?:\\\\$WINDOWS.~BT\\\\NewOS\\\\Windows\\\\servicing\\\\LCU\\\\*\",\n    \"?:\\\\$WINDOWS.~BT\\\\Work\\\\*\\\\*\",\n    \"?:\\\\Windows\\\\SoftwareDistribution\\\\Download\\\\*\",\n    \"?:\\\\Windows\\\\WinSxS\\\\amd64_microsoft-antimalware-scan-interface_*\\\\amsi.dll\"\n  ) and\n  not\n  (\n    process.executable : \"C:\\\\Windows\\\\System32\\\\wbengine.exe\" and\n    file.path : (\n      \"\\\\Device\\\\HarddiskVolume??\\\\Windows\\\\system32\\\\amsi.dll\",\n      \"\\\\Device\\\\HarddiskVolume??\\\\Windows\\\\syswow64\\\\amsi.dll\",\n      \"\\\\Device\\\\HarddiskVolume??\\\\Windows\\\\WinSxS\\\\*\\\\amsi.dll\"\n    )\n  )",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.file-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-m365_defender.event-*"
        ],
        "filters": []
      },
      {
        "name": "Interactive Terminal Spawned via Python",
        "description": "Identifies when a terminal (tty) is spawned via Python. Attackers may upgrade a simple reverse shell to a fully interactive tty after obtaining initial access to a host.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 110,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.006",
                    "name": "Python",
                    "reference": "https://attack.mitre.org/techniques/T1059/006/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args_count",
            "type": "long",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.args_count",
            "type": "long",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "d8a2a06c-100e-499d-9013-0bd2b0143e3d",
        "rule_id": "d76b02ef-fc95-4001-9297-01cb7412232f",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:24.814Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:04.192Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\") and\n(\n  (process.parent.name : \"python*\" and process.name in (\"bash\", \"dash\", \"ash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\",\n   \"fish\") and process.parent.args_count >= 3 and process.parent.args : \"*pty.spawn*\" and process.parent.args : \"-c\") or\n  (process.parent.name : \"python*\" and process.name in (\"bash\", \"dash\", \"ash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\",\n   \"fish\") and process.args : \"*sh\" and process.args_count == 1 and process.parent.args_count == 1)\n)",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious Content Extracted or Decompressed via Funzip",
        "description": "Identifies when suspicious content is extracted from a file and subsequently decompressed using the funzip utility. Malware may execute the tail utility using the \"-c\" option to read a sequence of bytes from the end of a file. The output from tail can be piped to funzip in order to decompress malicious code before it is executed. This behavior is consistent with malware families such as Bundlore.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 5,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://attack.mitre.org/software/S0482/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.004",
                    "name": "Unix Shell",
                    "reference": "https://attack.mitre.org/techniques/T1059/004/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1027",
                "name": "Obfuscated Files or Information",
                "reference": "https://attack.mitre.org/techniques/T1027/"
              },
              {
                "id": "T1140",
                "name": "Deobfuscate/Decode Files or Information",
                "reference": "https://attack.mitre.org/techniques/T1140/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "bb54c904-cd05-4e0a-81aa-ce33c0de9afd",
        "rule_id": "dc0b7782-0df0-47ff-8337-db0d678bdb66",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:24.816Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:17.262Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.action in (\"exec\", \"exec_event\") and\n((process.args == \"tail\" and process.args == \"-c\" and process.args == \"funzip\")) and\nnot process.args : \"/var/log/messages\" and \nnot process.parent.executable : (\"/usr/bin/dracut\", \"/sbin/dracut\", \"/usr/bin/xargs\") and\nnot (process.parent.name in (\"sh\", \"sudo\") and process.parent.command_line : \"*nessus_su*\")",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious System Commands Executed by Previously Unknown Executable",
        "description": "This rule monitors for the execution of several commonly used system commands executed by a previously unknown executable located in commonly abused directories. An alert from this rule can indicate the presence of potentially malicious activity, such as the execution of unauthorized or suspicious processes attempting to run malicious code. Detecting and investigating such behavior can help identify and mitigate potential security threats, protecting the system and its data from potential compromise.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 107,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.004",
                    "name": "Unix Shell",
                    "reference": "https://attack.mitre.org/techniques/T1059/004/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "8670c130-3e39-44bd-9db1-e86bd46ad90d",
        "rule_id": "e9001ee6-2d00-4d2f-849e-b8b1fb05234c",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:24.822Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:17.272Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "host.os.type:linux and event.category:process and event.action:(exec or exec_event or fork or fork_event) and\nprocess.executable:(* and (\n  /etc/crontab or /bin/* or /boot/* or /dev/shm/* or /etc/cron.*/* or /etc/init.d/* or /etc/rc*.d/* or /etc/update-motd.d/* or\n  /home/*/.* or /tmp/* or /usr/bin/* or /usr/lib/update-notifier/* or /usr/share/* or /var/tmp/*\n) and not /tmp/go-build*) and\nprocess.args:(hostname or id or ifconfig or ls or netstat or ps or pwd or route or top or uptime or whoami) and\nnot (process.name:\n  (apt or dnf or docker or dockerd or dpkg or hostname or id or ls or netstat or ps or pwd or rpm or snap or\n  snapd or sudo or top or uptime or which or whoami or yum) or\nprocess.parent.executable:(\n  /opt/cassandra/bin/cassandra or /opt/nessus/sbin/nessusd or /opt/nessus_agent/sbin/nessus-agent-module or /opt/puppetlabs/puppet/bin/puppet or\n  /opt/puppetlabs/puppet/bin/ruby or /usr/libexec/platform-python or /usr/local/cloudamize/bin/CCAgent or /usr/sbin/sshd or /bin/* or\n  /etc/network/* or /opt/Elastic/* or /opt/TrendMicro* or /opt/aws/* or /opt/eset/* or /opt/rapid7/* or /run/containerd/* or /run/k3s/* or\n  /snap/* or /tmp/dpkg-licenses* or /tmp/newroot/* or /usr/bin/* or /var/lib/amagent/* or /var/lib/docker/* or /vz/*\n  ) or\n  process.executable:(/run/containerd/* or /srv/snp/docker/* or /tmp/.criu*)\n)",
        "new_terms_fields": [
          "process.parent.executable"
        ],
        "history_window_start": "now-14d",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Attempt to Disable Syslog Service",
        "description": "Adversaries may attempt to disable the syslog service in an attempt to an attempt to disrupt event logging and evade detection by security controls.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 110,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/security-labs/detecting-log4j2-with-elastic-security"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.001",
                    "name": "Disable or Modify Tools",
                    "reference": "https://attack.mitre.org/techniques/T1562/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from one of the following integrations:\n- Elastic Defend\n- Auditbeat\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n### Auditbeat Setup\nAuditbeat is a lightweight shipper that you can install on your servers to audit the activities of users and processes on your systems. For example, you can use Auditbeat to collect and centralize audit events from the Linux Audit Framework. You can also use Auditbeat to detect changes to critical files, like binaries and configuration files, and identify potential security policy violations.\n\n#### The following steps should be executed in order to add the Auditbeat on a Linux System:\n- Elastic provides repositories available for APT and YUM-based distributions. Note that we provide binary packages, but no source packages.\n- To install the APT and YUM repositories follow the setup instructions in this [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/setup-repositories.html).\n- To run Auditbeat on Docker follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/running-on-docker.html).\n- To run Auditbeat on Kubernetes follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/running-on-kubernetes.html).\n- For complete â€œSetup and Run Auditbeatâ€ information refer to the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/setting-up-and-running.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "7ee9f2c6-85d1-4bdd-927a-0659a7789f0e",
        "rule_id": "2f8a1226-5720-437d-9c20-e0029deb6194",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:24.828Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:05.884Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.action in (\"exec\", \"exec_event\") and\n ( (process.name == \"service\" and process.args == \"stop\") or\n   (process.name == \"chkconfig\" and process.args == \"off\") or\n   (process.name == \"systemctl\" and process.args in (\"disable\", \"stop\", \"kill\"))\n ) and process.args in (\"syslog\", \"rsyslog\", \"syslog-ng\")",
        "language": "eql",
        "index": [
          "auditbeat-*",
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious Process Creation CallTrace",
        "description": "Identifies when a process is created and immediately accessed from an unknown memory code region and by the same parent process. This may indicate a code injection attempt.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Suspicious Process Creation CallTrace\n\nAttackers may inject code into child processes' memory to hide their actual activity, evade detection mechanisms, and decrease discoverability during forensics. This rule looks for a spawned process by Microsoft Office, scripting, and command line applications, followed by a process access event for an unknown memory region by the parent process, which can indicate a code injection attempt.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate any abnormal behavior by the subject process such as network connections, registry or file modifications, and any spawned child processes.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Inspect the host for suspicious or abnormal behavior in the alert timeframe.\n- Create a memory dump of the child process for analysis.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 308,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Resources: Investigation Guide",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1055",
                "name": "Process Injection",
                "reference": "https://attack.mitre.org/techniques/T1055/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.code",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.event_data.CallTrace",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "winlog.event_data.TargetProcessGUID",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "214473b1-6e0b-4f6d-955e-27a2dce7cd30",
        "rule_id": "3ed032b2-45d8-4406-bc79-7ad1eabb2c72",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:24.830Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:04.102Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by host.id with maxspan=1m\n  [process where host.os.type == \"windows\" and event.code == \"1\" and\n   /* sysmon process creation */\n   process.parent.name : (\"winword.exe\", \"excel.exe\", \"outlook.exe\", \"powerpnt.exe\", \"eqnedt32.exe\", \"fltldr.exe\",\n                          \"mspub.exe\", \"msaccess.exe\",\"cscript.exe\", \"wscript.exe\", \"rundll32.exe\", \"regsvr32.exe\",\n                          \"mshta.exe\", \"wmic.exe\", \"cmstp.exe\", \"msxsl.exe\") and\n\n   /* noisy FP patterns */\n   not (process.parent.name : \"EXCEL.EXE\" and process.executable : \"?:\\\\Program Files\\\\Microsoft Office\\\\root\\\\Office*\\\\ADDINS\\\\*.exe\") and\n   not (process.executable : \"?:\\\\Windows\\\\splwow64.exe\" and process.args in (\"8192\", \"12288\") and process.parent.name : (\"winword.exe\", \"excel.exe\", \"outlook.exe\", \"powerpnt.exe\")) and\n   not (process.parent.name : \"rundll32.exe\" and process.parent.args : (\"?:\\\\WINDOWS\\\\Installer\\\\MSI*.tmp,zzzzInvokeManagedCustomActionOutOfProc\", \"--no-sandbox\")) and\n   not (process.executable :\n            (\"?:\\\\Program Files (x86)\\\\Microsoft\\\\EdgeWebView\\\\Application\\\\*\\\\msedgewebview2.exe\",\n             \"?:\\\\Program Files\\\\Adobe\\\\Acrobat DC\\\\Acrobat\\\\Acrobat.exe\",\n             \"?:\\\\Windows\\\\SysWOW64\\\\DWWIN.EXE\") and\n        process.parent.name : (\"winword.exe\", \"excel.exe\", \"outlook.exe\", \"powerpnt.exe\")) and\n   not (process.parent.name : \"regsvr32.exe\" and process.parent.args : (\"?:\\\\Program Files\\\\*\", \"?:\\\\Program Files (x86)\\\\*\"))\n   ] by process.parent.entity_id, process.entity_id\n  [process where host.os.type == \"windows\" and event.code == \"10\" and\n   /* Sysmon process access event from unknown module */\n   winlog.event_data.CallTrace : \"*UNKNOWN*\"] by process.entity_id, winlog.event_data.TargetProcessGUID",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "Multiple Vault Web Credentials Read",
        "description": "Windows Credential Manager allows you to create, view, or delete saved credentials for signing into websites, connected applications, and networks. An adversary may abuse this to list or dump credentials stored in the Credential Manager for saved usernames and passwords. This may also be performed in preparation of lateral movement.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 111,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventid=5382",
          "https://www.elastic.co/security-labs/detect-credential-access"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1003",
                "name": "OS Credential Dumping",
                "reference": "https://attack.mitre.org/techniques/T1003/"
              },
              {
                "id": "T1555",
                "name": "Credentials from Password Stores",
                "reference": "https://attack.mitre.org/techniques/T1555/",
                "subtechnique": [
                  {
                    "id": "T1555.004",
                    "name": "Windows Credential Manager",
                    "reference": "https://attack.mitre.org/techniques/T1555/004/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.code",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.computer_name",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "winlog.event_data.Resource",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "winlog.event_data.SchemaFriendlyName",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "winlog.event_data.SubjectLogonId",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "winlog.process.pid",
            "type": "long",
            "ecs": false
          }
        ],
        "id": "82477bd9-34e9-4132-81e7-f435fb5b70ee",
        "rule_id": "44fc462c-1159-4fa8-b1b7-9b6296ab4f96",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:24.835Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:04.119Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by winlog.computer_name, winlog.process.pid with maxspan=1s\n\n /* 2 consecutive vault reads from same pid for web creds */\n\n [any where event.code : \"5382\" and\n  (winlog.event_data.SchemaFriendlyName : \"Windows Web Password Credential\" and winlog.event_data.Resource : \"http*\") and\n  not winlog.event_data.SubjectLogonId : \"0x3e7\" and \n  not winlog.event_data.Resource : \"http://localhost/\"]\n\n [any where event.code : \"5382\" and\n  (winlog.event_data.SchemaFriendlyName : \"Windows Web Password Credential\" and winlog.event_data.Resource : \"http*\") and\n  not winlog.event_data.SubjectLogonId : \"0x3e7\" and \n  not winlog.event_data.Resource : \"http://localhost/\"]",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-system.*",
          "logs-windows.*"
        ],
        "filters": []
      },
      {
        "name": "Potential Successful Linux RDP Brute Force Attack Detected",
        "description": "An RDP (Remote Desktop Protocol) brute force attack involves an attacker repeatedly attempting various username and password combinations to gain unauthorized access to a remote computer via RDP, and if successful, the potential impact can include unauthorized control over the compromised system, data theft, or the ability to launch further attacks within the network, jeopardizing the security and confidentiality of the targeted system and potentially compromising the entire network infrastructure. This rule identifies multiple consecutive authentication failures targeting a specific user account within a short time interval, followed by a successful authentication.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 7,
        "tags": [
          "Data Source: Auditd Manager",
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Credential Access"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1110",
                "name": "Brute Force",
                "reference": "https://attack.mitre.org/techniques/T1110/",
                "subtechnique": [
                  {
                    "id": "T1110.001",
                    "name": "Password Guessing",
                    "reference": "https://attack.mitre.org/techniques/T1110/001/"
                  },
                  {
                    "id": "T1110.003",
                    "name": "Password Spraying",
                    "reference": "https://attack.mitre.org/techniques/T1110/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from one of the following integrations:\n- Auditbeat\n- Auditd Manager\n\n### Auditbeat Setup\nAuditbeat is a lightweight shipper that you can install on your servers to audit the activities of users and processes on your systems. For example, you can use Auditbeat to collect and centralize audit events from the Linux Audit Framework. You can also use Auditbeat to detect changes to critical files, like binaries and configuration files, and identify potential security policy violations.\n\n#### The following steps should be executed in order to add the Auditbeat on a Linux System:\n- Elastic provides repositories available for APT and YUM-based distributions. Note that we provide binary packages, but no source packages.\n- To install the APT and YUM repositories follow the setup instructions in this [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/setup-repositories.html).\n- To run Auditbeat on Docker follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/running-on-docker.html).\n- To run Auditbeat on Kubernetes follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/running-on-kubernetes.html).\n- For complete â€œSetup and Run Auditbeatâ€ information refer to the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/setting-up-and-running.html).\n\n### Auditd Manager Integration Setup\nThe Auditd Manager Integration receives audit events from the Linux Audit Framework which is a part of the Linux kernel.\nAuditd Manager provides a user-friendly interface and automation capabilities for configuring and monitoring system auditing through the auditd daemon. With `auditd_manager`, administrators can easily define audit rules, track system events, and generate comprehensive audit reports, improving overall security and compliance in the system.\n\n#### The following steps should be executed in order to add the Elastic Agent System integration \"auditd_manager\" on a Linux System:\n- Go to the Kibana home page and click â€œAdd integrationsâ€.\n- In the query bar, search for â€œAuditd Managerâ€ and select the integration to see more details about it.\n- Click â€œAdd Auditd Managerâ€.\n- Configure the integration name and optionally add a description.\n- Review optional and advanced settings accordingly.\n- Add the newly installed â€œauditd managerâ€ to an existing or a new agent policy, and deploy the agent on a Linux system from which auditd log files are desirable.\n- Click â€œSave and Continueâ€.\n- For more details on the integration refer to the [helper guide](https://docs.elastic.co/integrations/auditd_manager).\n\n#### Rule Specific Setup Note\nAuditd Manager subscribes to the kernel and receives events as they occur without any additional configuration.\nHowever, if more advanced configuration is required to detect specific behavior, audit rules can be added to the integration in either the \"audit rules\" configuration box or the \"auditd rule files\" box by specifying a file to read the audit rules from.\n- For this detection rule no additional audit rules are required to be added to the integration.\n",
        "related_integrations": [
          {
            "package": "auditd_manager",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "auditd.data.terminal",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "related.user",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "ed28ec8c-5518-42f4-96b8-ea66d8640aab",
        "rule_id": "521fbe5c-a78d-4b6b-a323-f978b0e4c4c0",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:24.841Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:17.167Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by host.id, related.user with maxspan=5s\n  [authentication where host.os.type == \"linux\" and event.action == \"authenticated\" and\n   auditd.data.terminal : \"*rdp*\" and event.outcome == \"failure\"] with runs=10\n  [authentication where host.os.type == \"linux\" and event.action  == \"authenticated\" and\n   auditd.data.terminal : \"*rdp*\" and event.outcome == \"success\"] | tail 1",
        "language": "eql",
        "index": [
          "auditbeat-*",
          "logs-auditd_manager.auditd-*"
        ],
        "filters": []
      },
      {
        "name": "RDP Enabled via Registry",
        "description": "Identifies registry write modifications to enable Remote Desktop Protocol (RDP) access. This could be indicative of adversary lateral movement preparation.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating RDP Enabled via Registry\n\nMicrosoft Remote Desktop Protocol (RDP) is a proprietary Microsoft protocol that enables remote connections to other computers, typically over TCP port 3389.\n\nAttackers can use RDP to conduct their actions interactively. Ransomware operators frequently use RDP to access victim servers, often using privileged accounts.\n\nThis rule detects modification of the fDenyTSConnections registry key to the value `0`, which specifies that remote desktop connections are enabled. Attackers can abuse remote registry, use psexec, etc., to enable RDP and move laterally.\n\n#### Possible investigation steps\n\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the user to check if they are aware of the operation.\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Check whether it makes sense to enable RDP to this host, given its role in the environment.\n- Check if the host is directly exposed to the internet.\n- Check whether privileged accounts accessed the host shortly after the modification.\n- Review network events within a short timespan of this alert for incoming RDP connection attempts.\n\n### False positive analysis\n\n- This mechanism can be used legitimately. Check whether the user should be performing this kind of activity, whether they are aware of it, whether RDP should be open, and whether the action exposes the environment to unnecessary risks.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- If RDP is needed, make sure to secure it using firewall rules:\n  - Allowlist RDP traffic to specific trusted hosts.\n  - Restrict RDP logins to authorized non-administrator accounts, where possible.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Review the privileges assigned to the involved users to ensure that the least privilege principle is being followed.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 312,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Lateral Movement",
          "Tactic: Defense Evasion",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: SentinelOne"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1021",
                "name": "Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1021/",
                "subtechnique": [
                  {
                    "id": "T1021.001",
                    "name": "Remote Desktop Protocol",
                    "reference": "https://attack.mitre.org/techniques/T1021/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1112",
                "name": "Modify Registry",
                "reference": "https://attack.mitre.org/techniques/T1112/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.data.strings",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "registry.path",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "1f04ee22-1e4d-4330-9c03-cfe90e9d5c67",
        "rule_id": "58aa72ca-d968-4f34-b9f7-bea51d75eb50",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:24.843Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:05.933Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n  registry.path : (\n    \"HKLM\\\\SYSTEM\\\\*ControlSet*\\\\Control\\\\Terminal Server\\\\fDenyTSConnections\",\n    \"\\\\REGISTRY\\\\MACHINE\\\\SYSTEM\\\\*ControlSet*\\\\Control\\\\Terminal Server\\\\fDenyTSConnections\",\n    \"MACHINE\\\\*ControlSet*\\\\Control\\\\Terminal Server\\\\fDenyTSConnections\"\n  ) and\n  registry.data.strings : (\"0\", \"0x00000000\") and\n  not process.executable : (\"?:\\\\Windows\\\\System32\\\\SystemPropertiesRemote.exe\", \n                            \"?:\\\\Windows\\\\System32\\\\SystemPropertiesComputerName.exe\", \n                            \"?:\\\\Windows\\\\System32\\\\SystemPropertiesAdvanced.exe\", \n                            \"?:\\\\Windows\\\\System32\\\\SystemSettingsAdminFlows.exe\", \n                            \"?:\\\\Windows\\\\WinSxS\\\\*\\\\TiWorker.exe\", \n                            \"?:\\\\Windows\\\\system32\\\\svchost.exe\")",
        "language": "eql",
        "index": [
          "logs-endpoint.events.registry-*",
          "winlogbeat-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*"
        ],
        "filters": []
      },
      {
        "name": "Potential Successful Linux FTP Brute Force Attack Detected",
        "description": "An FTP (file transfer protocol) brute force attack is a method where an attacker systematically tries different combinations of usernames and passwords to gain unauthorized access to an FTP server, and if successful, the impact can include unauthorized data access, manipulation, or theft, compromising the security and integrity of the server and potentially exposing sensitive information. This rule identifies multiple consecutive authentication failures targeting a specific user account from the same source address and within a short time interval, followed by a successful authentication.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 7,
        "tags": [
          "Data Source: Auditd Manager",
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Credential Access"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1110",
                "name": "Brute Force",
                "reference": "https://attack.mitre.org/techniques/T1110/",
                "subtechnique": [
                  {
                    "id": "T1110.001",
                    "name": "Password Guessing",
                    "reference": "https://attack.mitre.org/techniques/T1110/001/"
                  },
                  {
                    "id": "T1110.003",
                    "name": "Password Spraying",
                    "reference": "https://attack.mitre.org/techniques/T1110/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from one of the following integrations:\n- Auditbeat\n- Auditd Manager\n\n### Auditbeat Setup\nAuditbeat is a lightweight shipper that you can install on your servers to audit the activities of users and processes on your systems. For example, you can use Auditbeat to collect and centralize audit events from the Linux Audit Framework. You can also use Auditbeat to detect changes to critical files, like binaries and configuration files, and identify potential security policy violations.\n\n#### The following steps should be executed in order to add the Auditbeat on a Linux System:\n- Elastic provides repositories available for APT and YUM-based distributions. Note that we provide binary packages, but no source packages.\n- To install the APT and YUM repositories follow the setup instructions in this [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/setup-repositories.html).\n- To run Auditbeat on Docker follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/running-on-docker.html).\n- To run Auditbeat on Kubernetes follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/running-on-kubernetes.html).\n- For complete â€œSetup and Run Auditbeatâ€ information refer to the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/setting-up-and-running.html).\n\n### Auditd Manager Integration Setup\nThe Auditd Manager Integration receives audit events from the Linux Audit Framework which is a part of the Linux kernel.\nAuditd Manager provides a user-friendly interface and automation capabilities for configuring and monitoring system auditing through the auditd daemon. With `auditd_manager`, administrators can easily define audit rules, track system events, and generate comprehensive audit reports, improving overall security and compliance in the system.\n\n#### The following steps should be executed in order to add the Elastic Agent System integration \"auditd_manager\" on a Linux System:\n- Go to the Kibana home page and click â€œAdd integrationsâ€.\n- In the query bar, search for â€œAuditd Managerâ€ and select the integration to see more details about it.\n- Click â€œAdd Auditd Managerâ€.\n- Configure the integration name and optionally add a description.\n- Review optional and advanced settings accordingly.\n- Add the newly installed â€œauditd managerâ€ to an existing or a new agent policy, and deploy the agent on a Linux system from which auditd log files are desirable.\n- Click â€œSave and Continueâ€.\n- For more details on the integration refer to the [helper guide](https://docs.elastic.co/integrations/auditd_manager).\n\n#### Rule Specific Setup Note\nAuditd Manager subscribes to the kernel and receives events as they occur without any additional configuration.\nHowever, if more advanced configuration is required to detect specific behavior, audit rules can be added to the integration in either the \"audit rules\" configuration box or the \"auditd rule files\" box by specifying a file to read the audit rules from.\n- For this detection rule no additional audit rules are required to be added to the integration.\n",
        "related_integrations": [
          {
            "package": "auditd_manager",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "auditd.data.addr",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "auditd.data.terminal",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "related.user",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "909a3c85-c47f-4488-ab13-06ee31072ec5",
        "rule_id": "66712812-e7f2-4a1d-bbda-dd0b5cf20c5d",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:24.848Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:17.184Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by host.id, auditd.data.addr, related.user with maxspan=5s\n  [authentication where host.os.type == \"linux\" and event.action == \"authenticated\" and\n   auditd.data.terminal == \"ftp\" and event.outcome == \"failure\" and auditd.data.addr != null and\n   auditd.data.addr != \"0.0.0.0\" and auditd.data.addr != \"::\"] with runs=10\n  [authentication where host.os.type == \"linux\" and event.action  == \"authenticated\" and\n   auditd.data.terminal == \"ftp\" and event.outcome == \"success\" and auditd.data.addr != null and\n   auditd.data.addr != \"0.0.0.0\" and auditd.data.addr != \"::\"] | tail 1",
        "language": "eql",
        "index": [
          "auditbeat-*",
          "logs-auditd_manager.auditd-*"
        ],
        "filters": []
      },
      {
        "name": "High Number of Process Terminations",
        "description": "This rule identifies a high number (10) of process terminations via pkill from the same host within a short time period.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating High Number of Process Terminations\n\nAttackers can kill processes for a variety of purposes. For example, they can kill process associated with business applications and databases to release the lock on files used by these applications so they may be encrypted,or stop security and backup solutions, etc.\n\nThis rule identifies a high number (10) of process terminations via pkill from the same host within a short time period.\n\n#### Possible investigation steps\n\n- Examine the entry point to the host and user in action via the Analyse View.\n  - Identify the session entry leader and session user.\n- Examine the contents of session leading to the process termination(s) via the Session View.\n  - Examine the command execution pattern in the session, which may lead to suspricous activities.\n- Examine the process killed during the malicious execution\n  - Identify imment threat to the system from the process killed.\n  - Take necessary incident response actions to respawn necessary process.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further destructive behavior, which is commonly associated with this activity.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Reimage the host operating system or restore it to the operational state.\n- If any other destructive action was identified on the host, it is recommended to prioritize the investigation and look for ransomware preparation and execution activities.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 112,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Impact",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Auditd Manager"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0040",
              "name": "Impact",
              "reference": "https://attack.mitre.org/tactics/TA0040/"
            },
            "technique": [
              {
                "id": "T1489",
                "name": "Service Stop",
                "reference": "https://attack.mitre.org/techniques/T1489/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "auditd_manager",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "62523e14-c5fc-4a9d-ad4a-cfd1e831cb93",
        "rule_id": "67f8443a-4ff3-4a70-916d-3cfa3ae9f02b",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:24.855Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:05.980Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "threshold",
        "query": "event.category:process and host.os.type:linux and event.type:start and process.name:\"pkill\" and process.args:\"-f\"",
        "threshold": {
          "field": [
            "host.id",
            "process.executable",
            "user.name"
          ],
          "value": 10
        },
        "index": [
          "logs-endpoint.events.*",
          "endgame-*",
          "auditbeat-*",
          "logs-auditd_manager.auditd-*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Elastic Agent Service Terminated",
        "description": "Identifies the Elastic endpoint agent has stopped and is no longer running on the host. Adversaries may attempt to disable security monitoring tools in an attempt to evade detection or prevention capabilities during an intrusion. This may also indicate an issue with the agent itself and should be addressed to ensure defensive measures are back in a stable state.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 107,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "OS: Windows",
          "OS: macOS",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.001",
                    "name": "Disable or Modify Tools",
                    "reference": "https://attack.mitre.org/techniques/T1562/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "f31e7e1c-3ae8-4083-833f-531fbee7c3df",
        "rule_id": "b627cd12-dac4-11ec-9582-f661ea17fbcd",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:24.856Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:06.969Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where\n/* net, sc or wmic stopping or deleting Elastic Agent on Windows */\n(event.type == \"start\" and\n  process.name : (\"net.exe\", \"sc.exe\", \"wmic.exe\",\"powershell.exe\",\"taskkill.exe\",\"PsKill.exe\",\"ProcessHacker.exe\") and\n  process.args : (\"stopservice\",\"uninstall\", \"stop\", \"disabled\",\"Stop-Process\",\"terminate\",\"suspend\") and\n  process.args : (\"elasticendpoint\", \"Elastic Agent\",\"elastic-agent\",\"elastic-endpoint\"))\nor\n/* service or systemctl used to stop Elastic Agent on Linux */\n(event.type == \"end\" and\n  (process.name : (\"systemctl\", \"service\") and\n    process.args : \"elastic-agent\" and\n    process.args : (\"stop\", \"disable\"))\n  or\n  /* pkill , killall used to stop Elastic Agent on Linux */\n  ( event.type == \"end\" and process.name : (\"pkill\", \"killall\") and process.args: \"elastic-agent\")\n  or\n  /* Unload Elastic Agent extension on MacOS */\n  (process.name : \"kextunload\" and\n    process.args : \"com.apple.iokit.EndpointSecurity\" and\n    event.action : \"end\"))",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Chkconfig Service Add",
        "description": "Detects the use of the chkconfig binary to manually add a service for management by chkconfig. Threat actors may utilize this technique to maintain persistence on a system. When a new service is added, chkconfig ensures that the service has either a start or a kill entry in every runlevel and when the system is rebooted the service file added will run providing long-term persistence.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Chkconfig Service Add\nService files are configuration files in Linux systems used to define and manage system services. The `Chkconfig` binary can be used to manually add, delete or modify a service. \n\nMalicious actors can leverage services to achieve persistence by creating or modifying service files to execute malicious commands or payloads during system startup. This allows them to maintain unauthorized access, execute additional malicious activities, or evade detection.\n\nThis rule monitors the usage of the `chkconfig` binary to manually add a service for management by `chkconfig`, potentially indicating the creation of a persistence mechanism.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n> This investigation guide uses [placeholder fields](https://www.elastic.co/guide/en/security/current/osquery-placeholder-fields.html) to dynamically pass alert data into Osquery queries. Placeholder fields were introduced in Elastic Stack version 8.7.0. If you're using Elastic Stack version 8.6.0 or earlier, you'll need to manually adjust this investigation guide's queries to ensure they properly run.\n\n#### Possible Investigation Steps\n\n- Investigate the service that was created or modified.\n- Investigate the currently enabled system services through the following commands `sudo chkconfig --list | grep on` and `sudo systemctl list-unit-files`.\n- Investigate the status of potentially suspicious services through the `chkconfig --list service_name` command. \n- Search for the `rc.d` or `init.d` service files that were created or modified, and analyze their contents.\n- Investigate whether any other files in any of the available `rc.d` or `init.d` directories have been altered through OSQuery.\n  - !{osquery{\"label\":\"Osquery - Retrieve File Listing Information\",\"query\":\"SELECT * FROM file WHERE (path LIKE '/etc/init.d/%' OR path LIKE '/etc/rc%.d/%')\"}}\n  - !{osquery{\"label\":\"Osquery - Retrieve Additional File Listing Information\",\"query\":\"SELECT f.path, u.username AS file_owner, g.groupname AS group_owner, datetime(f.atime, 'unixepoch') AS\\nfile_last_access_time, datetime(f.mtime, 'unixepoch') AS file_last_modified_time, datetime(f.ctime, 'unixepoch') AS\\nfile_last_status_change_time, datetime(f.btime, 'unixepoch') AS file_created_time, f.size AS size_bytes FROM file f LEFT\\nJOIN users u ON f.uid = u.uid LEFT JOIN groups g ON f.gid = g.gid WHERE (path LIKE '/etc/init.d/%' OR path LIKE\\n'/etc/rc%.d/%')\\n\"}}\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence and whether they are located in expected locations.\n  - !{osquery{\"label\":\"Osquery - Retrieve Running Processes by User\",\"query\":\"SELECT pid, username, name FROM processes p JOIN users u ON u.uid = p.uid ORDER BY username\"}}\n- Investigate syslog through the `sudo cat /var/log/syslog | grep 'LSB'` command to find traces of the LSB header of the script (if present). If syslog is being ingested into Elasticsearch, the same can be accomplished through Kibana.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Validate the activity is not related to planned patches, updates, network administrator activity, or legitimate software installations.\n- Investigate whether the altered scripts call other malicious scripts elsewhere on the file system. \n  - If scripts or executables were dropped, retrieve the files and determine if they are malicious:\n    - Use a private sandboxed malware analysis system to perform analysis.\n      - Observe and collect information about the following activities:\n        - Attempts to contact external domains and addresses.\n          - Check if the domain is newly registered or unexpected.\n          - Check the reputation of the domain or IP address.\n        - File access, modification, and creation activities.\n        - Cron jobs, services and other persistence mechanisms.\n            - !{osquery{\"label\":\"Osquery - Retrieve Crontab Information\",\"query\":\"SELECT * FROM crontab\"}}\n- Investigate abnormal behaviors by the subject process/user such as network connections, file modifications, and any other spawned child processes.\n  - Investigate listening ports and open sockets to look for potential command and control traffic or data exfiltration.\n    - !{osquery{\"label\":\"Osquery - Retrieve Listening Ports\",\"query\":\"SELECT pid, address, port, socket, protocol, path FROM listening_ports\"}}\n    - !{osquery{\"label\":\"Osquery - Retrieve Open Sockets\",\"query\":\"SELECT pid, family, remote_address, remote_port, socket, state FROM process_open_sockets\"}}\n  - Identify the user account that performed the action, analyze it, and check whether it should perform this kind of action.\n    - !{osquery{\"label\":\"Osquery - Retrieve Information for a Specific User\",\"query\":\"SELECT * FROM users WHERE username = {{user.name}}\"}}\n- Investigate whether the user is currently logged in and active.\n    - !{osquery{\"label\":\"Osquery - Investigate the Account Authentication Status\",\"query\":\"SELECT * FROM logged_in_users WHERE user = {{user.name}}\"}}\n\n### False Positive Analysis\n\n- If this activity is related to new benign software installation activity, consider adding exceptions â€” preferably with a combination of user and command line conditions.\n- If this activity is related to a system administrator who uses the `chkconfig` binary for administrative purposes, consider adding exceptions for this specific administrator user account. \n- Try to understand the context of the execution by thinking about the user, machine, or business purpose. A small number of endpoints, such as servers with unique software, might appear unusual but satisfy a specific business need.\n\n### Related Rules\n\n- Suspicious File Creation in /etc for Persistence - 1c84dd64-7e6c-4bad-ac73-a5014ee37042\n- Potential Persistence Through Run Control Detected - 0f4d35e4-925e-4959-ab24-911be207ee6f\n- Potential Persistence Through init.d Detected - 474fd20e-14cc-49c5-8160-d9ab4ba16c8b\n- New Systemd Timer Created - 7fb500fa-8e24-4bd1-9480-2a819352602c\n- New Systemd Service Created by Previously Unknown Process - 17b0a495-4d9f-414c-8ad0-92f018b8e001\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Delete the service/timer or restore its original configuration.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Leverage the incident response data and logging to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 113,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Threat: Lightning Framework",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.intezer.com/blog/research/lightning-framework-new-linux-threat/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1037",
                "name": "Boot or Logon Initialization Scripts",
                "reference": "https://attack.mitre.org/techniques/T1037/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "27704fed-f9fd-449a-ada3-2bd553386f98",
        "rule_id": "b910f25a-2d44-47f2-a873-aabdc0d355e6",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:24.862Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:06.980Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.action in (\"exec\", \"exec_event\") and\n( \n  (process.executable : \"/usr/sbin/chkconfig\" and process.args : \"--add\") or\n  (process.args : \"*chkconfig\" and process.args : \"--add\")\n) and not (\n  process.parent.name in (\"rpm\", \"qualys-scan-util\", \"qualys-cloud-agent\", \"update-alternatives\") or\n  process.parent.args : (\"/var/tmp/rpm*\", \"/var/lib/waagent/*\") or\n  process.args in (\"jexec\", \"sapinit\", \"httpd\", \"dbora\")\n)",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious DLL Loaded for Persistence or Privilege Escalation",
        "description": "Identifies the loading of a non Microsoft signed DLL that is missing on a default Windows install (phantom DLL) or one that can be loaded from a different location by a native Windows process. This may be abused to persist or elevate privileges via privileged file write vulnerabilities.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Suspicious DLL Loaded for Persistence or Privilege Escalation\n\nAttackers can execute malicious code by abusing missing modules that processes try to load, enabling them to escalate privileges or gain persistence. This rule identifies the loading of a non-Microsoft-signed DLL that is missing on a default Windows installation or one that can be loaded from a different location by a native Windows process.\n\n#### Possible investigation steps\n\n- Examine the DLL signature and identify the process that created it.\n  - Investigate any abnormal behaviors by the process such as network connections, registry or file modifications, and any spawned child processes.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Retrieve the DLL and determine if it is malicious:\n  - Use a private sandboxed malware analysis system to perform analysis.\n    - Observe and collect information about the following activities:\n      - Attempts to contact external domains and addresses.\n      - File and registry access, modification, and creation activities.\n      - Service creation and launch activities.\n      - Scheduled task creation.\n  - Use the PowerShell Get-FileHash cmdlet to get the files' SHA-256 hash values.\n    - Search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Any activity that triggered the alert and is not inherently malicious must be monitored by the security team.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 213,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Tactic: Privilege Escalation",
          "Tactic: Defense Evasion",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://itm4n.github.io/windows-dll-hijacking-clarified/",
          "http://remoteawesomethoughts.blogspot.com/2019/05/windows-10-task-schedulerservice.html",
          "https://googleprojectzero.blogspot.com/2018/04/windows-exploitation-tricks-exploiting.html",
          "https://shellz.club/2020/10/16/edgegdi-dll-for-persistence-and-lateral-movement.html",
          "https://windows-internals.com/faxing-your-way-to-system/",
          "http://waleedassar.blogspot.com/2013/01/wow64logdll.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1574",
                "name": "Hijack Execution Flow",
                "reference": "https://attack.mitre.org/techniques/T1574/",
                "subtechnique": [
                  {
                    "id": "T1574.002",
                    "name": "DLL Side-Loading",
                    "reference": "https://attack.mitre.org/techniques/T1574/002/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1574",
                "name": "Hijack Execution Flow",
                "reference": "https://attack.mitre.org/techniques/T1574/",
                "subtechnique": [
                  {
                    "id": "T1574.001",
                    "name": "DLL Search Order Hijacking",
                    "reference": "https://attack.mitre.org/techniques/T1574/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1036",
                "name": "Masquerading",
                "reference": "https://attack.mitre.org/techniques/T1036/",
                "subtechnique": [
                  {
                    "id": "T1036.001",
                    "name": "Invalid Code Signature",
                    "reference": "https://attack.mitre.org/techniques/T1036/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "dll.code_signature.exists",
            "type": "boolean",
            "ecs": true
          },
          {
            "name": "dll.code_signature.subject_name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "dll.code_signature.trusted",
            "type": "boolean",
            "ecs": true
          },
          {
            "name": "dll.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "dll.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.code_signature.status",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.hash.sha256",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "37b0f13c-2e97-4dda-99da-a0a8660b6235",
        "rule_id": "bfeaf89b-a2a7-48a3-817f-e41829dc61ee",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:24.867Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:06.987Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "any where host.os.type == \"windows\" and\n(event.category : (\"driver\", \"library\") or (event.category == \"process\" and event.action : \"Image loaded*\")) and\n(\n  /* compatible with Elastic Endpoint Library Events */\n  (\n    ?dll.name : (\n        \"wlbsctrl.dll\", \"wbemcomn.dll\", \"WptsExtensions.dll\", \"Tsmsisrv.dll\", \"TSVIPSrv.dll\", \"Msfte.dll\",\n        \"wow64log.dll\", \"WindowsCoreDeviceInfo.dll\", \"Ualapi.dll\", \"wlanhlp.dll\", \"phoneinfo.dll\", \"EdgeGdi.dll\",\n        \"cdpsgshims.dll\", \"windowsperformancerecordercontrol.dll\", \"diagtrack_win.dll\", \"TPPCOIPW32.dll\", \n        \"tpgenlic.dll\", \"thinmon.dll\", \"fxsst.dll\", \"msTracer.dll\"\n    )\n    and (\n      ?dll.code_signature.trusted != true or\n      ?dll.code_signature.exists != true or\n      (\n        dll.code_signature.trusted == true and\n          not dll.code_signature.subject_name : (\"Microsoft Windows\", \"Microsoft Corporation\", \"Microsoft Windows Publisher\")\n      )\n  ) or\n   /* oci.dll is too noisy due to unsigned Oracle related DLL loaded from random dirs */\n  (\n   (?dll.path : \"?:\\\\Windows\\\\*\\\\oci.dll\" and process.executable : \"?:\\\\Windows\\\\*.exe\" and \n    (?dll.code_signature.trusted != true or ?dll.code_signature.exists != true)) or \n    \n   (file.path : \"?:\\\\Windows\\\\*\\\\oci.dll\" and not file.code_signature.status == \"Valid\" and process.executable : \"?:\\\\Windows\\\\*.exe\")\n   ) or \n\n  /* compatible with Sysmon EventID 7 - Image Load */\n  (file.name : (\"wlbsctrl.dll\", \"wbemcomn.dll\", \"WptsExtensions.dll\", \"Tsmsisrv.dll\", \"TSVIPSrv.dll\", \"Msfte.dll\",\n               \"wow64log.dll\", \"WindowsCoreDeviceInfo.dll\", \"Ualapi.dll\", \"wlanhlp.dll\", \"phoneinfo.dll\", \"EdgeGdi.dll\",\n               \"cdpsgshims.dll\", \"windowsperformancerecordercontrol.dll\", \"diagtrack_win.dll\", \"TPPCOIPW32.dll\", \n               \"tpgenlic.dll\", \"thinmon.dll\", \"fxsst.dll\", \"msTracer.dll\") and \n   not file.hash.sha256 : \n            (\"6e837794fc282446906c36d681958f2f6212043fc117c716936920be166a700f\", \n             \"b14e4954e8cca060ffeb57f2458b6a3a39c7d2f27e94391cbcea5387652f21a4\", \n             \"c258d90acd006fa109dc6b748008edbb196d6168bc75ace0de0de54a4db46662\") and \n   not file.code_signature.status == \"Valid\")\n  ) and\n  not\n  (\n    ?dll.path : (\n      \"?:\\\\Windows\\\\System32\\\\wbemcomn.dll\",\n      \"?:\\\\Windows\\\\SysWOW64\\\\wbemcomn.dll\",\n      \"?:\\\\Windows\\\\System32\\\\windowsperformancerecordercontrol.dll\",\n      \"?:\\\\Windows\\\\System32\\\\wlanhlp.dll\", \n      \"\\\\Device\\\\HarddiskVolume?\\\\Windows\\\\SysWOW64\\\\wbemcomn.dll\", \n      \"\\\\Device\\\\HarddiskVolume?\\\\Windows\\\\System32\\\\wbemcomn.dll\", \n      \"\\\\Device\\\\HarddiskVolume?\\\\Windows\\\\SysWOW64\\\\wlanhlp.dll\", \n      \"\\\\Device\\\\HarddiskVolume?\\\\Windows\\\\System32\\\\wlanhlp.dll\", \n      \"\\\\Device\\\\HarddiskVolume?\\\\Windows\\\\SysWOW64\\\\windowsperformancerecordercontrol.dll\", \n      \"\\\\Device\\\\HarddiskVolume?\\\\Windows\\\\System32\\\\windowsperformancerecordercontrol.dll\", \n      \"C:\\\\ProgramData\\\\docker\\\\windowsfilter\\\\*\\\\Files\\\\Windows\\\\System32\\\\windowsperformancerecordercontrol.dll\", \n      \"C:\\\\ProgramData\\\\docker\\\\windowsfilter\\\\*\\\\Files\\\\Windows\\\\System32\\\\windowsperformancerecordercontrol.dll\", \n      \"\\\\Device\\\\vmsmb\\\\VSMB-{*}\\\\os\\\\windows\\\\system32\\\\*.dll\"\n    ) or\n    file.path : (\n      \"?:\\\\Windows\\\\System32\\\\wbemcomn.dll\",\n      \"?:\\\\Windows\\\\SysWOW64\\\\wbemcomn.dll\",\n      \"?:\\\\Windows\\\\System32\\\\windowsperformancerecordercontrol.dll\",\n      \"?:\\\\Windows\\\\System32\\\\wlanhlp.dll\", \n      \"C:\\\\ProgramData\\\\docker\\\\windowsfilter\\\\*\\\\Files\\\\Windows\\\\System32\\\\windowsperformancerecordercontrol.dll\", \n      \"C:\\\\ProgramData\\\\docker\\\\windowsfilter\\\\*\\\\Files\\\\Windows\\\\System32\\\\wbemcomn.dll\", \n      \"\\\\Device\\\\vmsmb\\\\VSMB-{*}\\\\os\\\\windows\\\\system32\\\\*.dll\"\n    )\n  )\n)",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.library*",
          "logs-windows.sysmon_operational-*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "Potential Credential Access via LSASS Memory Dump",
        "description": "Identifies suspicious access to LSASS handle from a call trace pointing to DBGHelp.dll or DBGCore.dll, which both export the MiniDumpWriteDump method that can be used to dump LSASS memory content in preparation for credential access.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 310,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Tactic:Execution",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.ired.team/offensive-security/credential-access-and-credential-dumping/dump-credentials-from-lsass-process-without-mimikatz",
          "https://www.elastic.co/security-labs/detect-credential-access",
          "https://www.elastic.co/security-labs/elastic-protects-against-data-wiper-malware-targeting-ukraine-hermeticwiper"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1003",
                "name": "OS Credential Dumping",
                "reference": "https://attack.mitre.org/techniques/T1003/",
                "subtechnique": [
                  {
                    "id": "T1003.001",
                    "name": "LSASS Memory",
                    "reference": "https://attack.mitre.org/techniques/T1003/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1106",
                "name": "Native API",
                "reference": "https://attack.mitre.org/techniques/T1106/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.code",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.event_data.CallTrace",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "winlog.event_data.TargetImage",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "99ffd9e7-a437-46d4-8326-be5ae6fd3a99",
        "rule_id": "9960432d-9b26-409f-972b-839a959e79e2",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:24.869Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:04.165Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.code == \"10\" and\n  winlog.event_data.TargetImage : \"?:\\\\WINDOWS\\\\system32\\\\lsass.exe\" and\n\n   /* DLLs exporting MiniDumpWriteDump API to create an lsass mdmp*/\n  winlog.event_data.CallTrace : (\"*dbghelp*\", \"*dbgcore*\") and\n\n   /* case of lsass crashing */\n  not process.executable : (\n        \"?:\\\\Windows\\\\System32\\\\WerFault.exe\",\n        \"?:\\\\Windows\\\\SysWOW64\\\\WerFault.exe\",\n        \"?:\\\\Windows\\\\System32\\\\WerFaultSecure.exe\"\n      )",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "Potential Shadow File Read via Command Line Utilities",
        "description": "Identifies access to the /etc/shadow file via the commandline using standard system utilities. After elevating privileges to root, threat actors may attempt to read or dump this file in order to gain valid credentials. They may utilize these to move laterally undetected and access additional resources.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 209,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Tactic: Credential Access",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.cyberciti.biz/faq/unix-linux-password-cracking-john-the-ripper/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1068",
                "name": "Exploitation for Privilege Escalation",
                "reference": "https://attack.mitre.org/techniques/T1068/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1003",
                "name": "OS Credential Dumping",
                "reference": "https://attack.mitre.org/techniques/T1003/",
                "subtechnique": [
                  {
                    "id": "T1003.008",
                    "name": "/etc/passwd and /etc/shadow",
                    "reference": "https://attack.mitre.org/techniques/T1003/008/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.working_directory",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "f541dc39-a191-4042-a026-d43bcd89236b",
        "rule_id": "9a3a3689-8ed1-4cdb-83fb-9506db54c61f",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:24.875Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:06.031Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "host.os.type : \"linux\" and event.category : \"process\" and event.action : (\"exec\" or \"exec_event\") and\n(process.args : \"/etc/shadow\" or (process.working_directory: \"/etc\" and process.args: \"shadow\")) and not (\n  (process.executable : (\"/bin/chown\" or \"/usr/bin/chown\") and process.args : \"root:shadow\") or\n  (process.executable : (\"/bin/chmod\" or \"/usr/bin/chmod\") and process.args : \"640\") or\n  process.executable:(/vz/* or /var/lib/docker/* or /run/containerd/* or /tmp/.criu* or /tmp/newroot/*) or\n  process.parent.name:(gen_passwd_sets or scc_* or wazuh-modulesd)\n)",
        "new_terms_fields": [
          "process.executable"
        ],
        "history_window_start": "now-10d",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "A scheduled task was updated",
        "description": "Indicates the update of a scheduled task using Windows event logs. Adversaries can use these to establish persistence, by changing the configuration of a legit scheduled task. Some changes such as disabling or enabling a scheduled task are common and may may generate noise.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 109,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Legitimate scheduled tasks may be created during installation of new software."
        ],
        "references": [
          "https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4698"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1053",
                "name": "Scheduled Task/Job",
                "reference": "https://attack.mitre.org/techniques/T1053/",
                "subtechnique": [
                  {
                    "id": "T1053.005",
                    "name": "Scheduled Task",
                    "reference": "https://attack.mitre.org/techniques/T1053/005/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.event_data.SubjectUserSid",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "winlog.event_data.TaskName",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "1043e777-b0da-4b75-9bca-e18b63dee978",
        "rule_id": "a02cb68e-7c93-48d1-93b2-2c39023308eb",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:24.880Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:04.172Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "iam where event.action == \"scheduled-task-updated\" and\n\n /* excluding tasks created by the computer account */\n not user.name : \"*$\" and \n not winlog.event_data.TaskName : \"*Microsoft*\" and \n not winlog.event_data.TaskName :\n          (\"\\\\User_Feed_Synchronization-*\",\n           \"\\\\OneDrive Reporting Task-S-1-5-21*\",\n           \"\\\\OneDrive Reporting Task-S-1-12-1-*\",\n           \"\\\\Hewlett-Packard\\\\HP Web Products Detection\",\n           \"\\\\Hewlett-Packard\\\\HPDeviceCheck\", \n           \"\\\\Microsoft\\\\Windows\\\\UpdateOrchestrator\\\\UpdateAssistant\", \n           \"\\\\IpamDnsProvisioning\",  \n           \"\\\\Microsoft\\\\Windows\\\\UpdateOrchestrator\\\\UpdateAssistantAllUsersRun\", \n           \"\\\\Microsoft\\\\Windows\\\\UpdateOrchestrator\\\\UpdateAssistantCalendarRun\", \n           \"\\\\Microsoft\\\\Windows\\\\UpdateOrchestrator\\\\UpdateAssistantWakeupRun\", \n           \"\\\\Microsoft\\\\Windows\\\\.NET Framework\\\\.NET Framework NGEN v*\", \n           \"\\\\Microsoft\\\\VisualStudio\\\\Updates\\\\BackgroundDownload\") and \n  not winlog.event_data.SubjectUserSid :  (\"S-1-5-18\", \"S-1-5-19\", \"S-1-5-20\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-system.*",
          "logs-windows.*"
        ],
        "filters": []
      },
      {
        "name": "Remotely Started Services via RPC",
        "description": "Identifies remote execution of Windows services over remote procedure call (RPC). This could be indicative of lateral movement, but will be noisy if commonly done by administrators.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Remotely Started Services via RPC\n\nThe Service Control Manager Remote Protocol is a client/server protocol used for configuring and controlling service programs running on a remote computer. A remote service management session begins with the client initiating the connection request to the server. If the server grants the request, the connection is established. The client can then make multiple requests to modify, query the configuration, or start and stop services on the server by using the same session until the session is terminated.\n\nThis rule detects the remote creation or start of a service by correlating a `services.exe` network connection and the spawn of a child process.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Review login events (e.g., 4624) in the alert timeframe to identify the account used to perform this action. Use the `source.address` field to help identify the source system.\n- Review network events from the source system using the source port identified on the alert and try to identify the program used to initiate the action.\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate any abnormal behavior by the subject process such as network connections, registry or file modifications, and any spawned child processes.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Validate if the activity is not related to planned patches, updates, network administrator activity, or legitimate software installations.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the process executable using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n\n### False positive analysis\n\n- Remote management software like SCCM may trigger this rule. If noisy on your environment, consider adding exceptions.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 213,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Lateral Movement",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-scmr/705b624a-13de-43cc-b8a2-99573da3635f",
          "https://www.elastic.co/security-labs/elastic-protects-against-data-wiper-malware-targeting-ukraine-hermeticwiper"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1021",
                "name": "Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1021/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.port",
            "type": "long",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "network.direction",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "network.transport",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "source.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "source.port",
            "type": "long",
            "ecs": true
          }
        ],
        "id": "757f9ba0-b894-42f7-af99-548ed781f6cd",
        "rule_id": "aa9a274d-6b53-424d-ac5e-cb8ca4251650",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:24.882Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:04.180Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence with maxspan=1s\n   [network where host.os.type == \"windows\" and process.name : \"services.exe\" and\n      network.direction : (\"incoming\", \"ingress\") and network.transport == \"tcp\" and\n      source.port >= 49152 and destination.port >= 49152 and source.ip != \"127.0.0.1\" and source.ip != \"::1\"\n   ] by host.id, process.entity_id\n   [process where host.os.type == \"windows\" and \n       event.type == \"start\" and process.parent.name : \"services.exe\" and\n       not (process.executable : \"?:\\\\Windows\\\\System32\\\\msiexec.exe\" and process.args : \"/V\") and\n       not process.executable : (\n                \"?:\\\\Pella Corporation\\\\OSCToGPAutoService\\\\OSCToGPAutoSvc.exe\",\n                \"?:\\\\Pella Corporation\\\\Pella Order Management\\\\GPAutoSvc.exe\",\n                \"?:\\\\Pella Corporation\\\\Pella Order Management\\\\GPAutoSvc.exe\",\n                \"?:\\\\Program Files (x86)\\\\*.exe\",\n                \"?:\\\\Program Files\\\\*.exe\",\n                \"?:\\\\Windows\\\\ADCR_Agent\\\\adcrsvc.exe\",\n                \"?:\\\\Windows\\\\AdminArsenal\\\\PDQ*.exe\",\n                \"?:\\\\Windows\\\\CAInvokerService.exe\",\n                \"?:\\\\Windows\\\\ccmsetup\\\\ccmsetup.exe\",\n                \"?:\\\\Windows\\\\eset-remote-install-service.exe\",\n                \"?:\\\\Windows\\\\ProPatches\\\\Scheduler\\\\STSchedEx.exe\",\n                \"?:\\\\Windows\\\\PSEXESVC.EXE\",\n                \"?:\\\\Windows\\\\RemoteAuditService.exe\",\n                \"?:\\\\Windows\\\\servicing\\\\TrustedInstaller.exe\",\n                \"?:\\\\Windows\\\\System32\\\\certsrv.exe\",\n                \"?:\\\\Windows\\\\System32\\\\sppsvc.exe\",\n                \"?:\\\\Windows\\\\System32\\\\srmhost.exe\",\n                \"?:\\\\Windows\\\\System32\\\\svchost.exe\",\n                \"?:\\\\Windows\\\\System32\\\\taskhostex.exe\",\n                \"?:\\\\Windows\\\\System32\\\\upfc.exe\",\n                \"?:\\\\Windows\\\\System32\\\\vds.exe\",\n                \"?:\\\\Windows\\\\System32\\\\VSSVC.exe\",\n                \"?:\\\\Windows\\\\System32\\\\wbem\\\\WmiApSrv.exe\",\n                \"?:\\\\Windows\\\\SysWOW64\\\\NwxExeSvc\\\\NwxExeSvc.exe\",\n                \"?:\\\\Windows\\\\Veeam\\\\Backup\\\\VeeamDeploymentSvc.exe\",\n                \"?:\\\\Windows\\\\VeeamLogShipper\\\\VeeamLogShipper.exe\",\n                \"?:\\\\Windows\\\\VeeamVssSupport\\\\VeeamGuestHelper.exe\"\n       )] by host.id, process.parent.entity_id",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "logs-endpoint.events.network-*",
          "winlogbeat-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious LSASS Access via MalSecLogon",
        "description": "Identifies suspicious access to LSASS handle from a call trace pointing to seclogon.dll and with a suspicious access rights value. This may indicate an attempt to leak an LSASS handle via abusing the Secondary Logon service in preparation for credential access.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 308,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://splintercod3.blogspot.com/p/the-hidden-side-of-seclogon-part-3.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1003",
                "name": "OS Credential Dumping",
                "reference": "https://attack.mitre.org/techniques/T1003/",
                "subtechnique": [
                  {
                    "id": "T1003.001",
                    "name": "LSASS Memory",
                    "reference": "https://attack.mitre.org/techniques/T1003/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.code",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.event_data.CallTrace",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "winlog.event_data.GrantedAccess",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "winlog.event_data.TargetImage",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "d4540e3c-890b-43fc-80cd-0240cd149716",
        "rule_id": "7ba58110-ae13-439b-8192-357b0fcfa9d7",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:24.888Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:04.131Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.code == \"10\" and\n  winlog.event_data.TargetImage : \"?:\\\\WINDOWS\\\\system32\\\\lsass.exe\" and\n\n   /* seclogon service accessing lsass */\n  winlog.event_data.CallTrace : \"*seclogon.dll*\" and process.name : \"svchost.exe\" and\n\n   /* PROCESS_CREATE_PROCESS & PROCESS_DUP_HANDLE & PROCESS_QUERY_INFORMATION */\n  winlog.event_data.GrantedAccess == \"0x14c0\"",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "Potential Successful SSH Brute Force Attack",
        "description": "Identifies multiple SSH login failures followed by a successful one from the same source address. Adversaries can attempt to login into multiple users with a common or known password to gain access to accounts.",
        "risk_score": 73,
        "severity": "high",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Potential Successful SSH Brute Force Attack\n\nThe rule identifies consecutive SSH login failures followed by a successful login from the same source IP address to the same target host indicating a successful attempt of brute force password guessing.\n\n#### Possible investigation steps\n\n- Investigate the login failure user name(s).\n- Investigate the source IP address of the failed ssh login attempt(s).\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Identify the source and the target computer and their roles in the IT environment.\n\n### False positive analysis\n\n- Authentication misconfiguration or obsolete credentials.\n- Service account password expired.\n- Infrastructure or availability issue.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Ensure active session(s) on the host(s) are terminated as the attacker could have gained initial access to the system(s).\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 11,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Credential Access"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1110",
                "name": "Brute Force",
                "reference": "https://attack.mitre.org/techniques/T1110/",
                "subtechnique": [
                  {
                    "id": "T1110.001",
                    "name": "Password Guessing",
                    "reference": "https://attack.mitre.org/techniques/T1110/001/"
                  },
                  {
                    "id": "T1110.003",
                    "name": "Password Spraying",
                    "reference": "https://attack.mitre.org/techniques/T1110/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from one of the following integrations:\n- Auditbeat\n- Filebeat\n\n### Auditbeat Setup\nAuditbeat is a lightweight shipper that you can install on your servers to audit the activities of users and processes on your systems. For example, you can use Auditbeat to collect and centralize audit events from the Linux Audit Framework. You can also use Auditbeat to detect changes to critical files, like binaries and configuration files, and identify potential security policy violations.\n\n#### The following steps should be executed in order to add the Auditbeat on a Linux System:\n- Elastic provides repositories available for APT and YUM-based distributions. Note that we provide binary packages, but no source packages.\n- To install the APT and YUM repositories follow the setup instructions in this [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/setup-repositories.html).\n- To run Auditbeat on Docker follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/running-on-docker.html).\n- To run Auditbeat on Kubernetes follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/running-on-kubernetes.html).\n- For complete â€œSetup and Run Auditbeatâ€ information refer to the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/setting-up-and-running.html).\n\n### Filebeat Setup\nFilebeat is a lightweight shipper for forwarding and centralizing log data. Installed as an agent on your servers, Filebeat monitors the log files or locations that you specify, collects log events, and forwards them either to Elasticsearch or Logstash for indexing.\n\n#### The following steps should be executed in order to add the Filebeat on a Linux System:\n- Elastic provides repositories available for APT and YUM-based distributions. Note that we provide binary packages, but no source packages.\n- To install the APT and YUM repositories follow the setup instructions in this [helper guide](https://www.elastic.co/guide/en/beats/filebeat/current/setup-repositories.html).\n- To run Filebeat on Docker follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/filebeat/current/running-on-docker.html).\n- To run Filebeat on Kubernetes follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/filebeat/current/running-on-kubernetes.html).\n- For quick start information for Filebeat refer to the [helper guide](https://www.elastic.co/guide/en/beats/filebeat/8.11/filebeat-installation-configuration.html).\n- For complete â€œSetup and Run Filebeatâ€ information refer to the [helper guide](https://www.elastic.co/guide/en/beats/filebeat/current/setting-up-and-running.html).\n\n#### Rule Specific Setup Note\n- This rule requires the â€œFilebeat System Moduleâ€ to be enabled.\n- The system module collects and parses logs created by the system logging service of common Unix/Linux based distributions.\n- To run the system module of Filebeat on Linux follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-module-system.html).\n",
        "related_integrations": [
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "source.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "user.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "5cb3a09d-df72-492e-a0d7-0af64bdcc7ef",
        "rule_id": "8cb84371-d053-4f4f-bce0-c74990e28f28",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:24.893Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:06.011Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by host.id, source.ip, user.name with maxspan=15s\n  [authentication where host.os.type == \"linux\" and event.action  in (\"ssh_login\", \"user_login\") and\n   event.outcome == \"failure\" and source.ip != null and source.ip != \"0.0.0.0\" and source.ip != \"::\" ] with runs=10\n\n  [authentication where host.os.type == \"linux\" and event.action  in (\"ssh_login\", \"user_login\") and\n   event.outcome == \"success\" and source.ip != null and source.ip != \"0.0.0.0\" and source.ip != \"::\" ]",
        "language": "eql",
        "index": [
          "auditbeat-*",
          "filebeat-*",
          "logs-system.auth-*"
        ],
        "filters": []
      },
      {
        "name": "Potential Internal Linux SSH Brute Force Detected",
        "description": "Identifies multiple internal consecutive login failures targeting a user account from the same source address within a short time interval. Adversaries will often brute force login attempts across multiple users with a common or known password, in an attempt to gain access to these accounts.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Potential Internal Linux SSH Brute Force Detected\n\nThe rule identifies consecutive internal SSH login failures targeting a user account from the same source IP address to the same target host indicating brute force login attempts.\n\n#### Possible investigation steps\n\n- Investigate the login failure user name(s).\n- Investigate the source IP address of the failed ssh login attempt(s).\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Identify the source and the target computer and their roles in the IT environment.\n\n### False positive analysis\n\n- Authentication misconfiguration or obsolete credentials.\n- Service account password expired.\n- Infrastructure or availability issue.\n\n### Related Rules\n\n- Potential External Linux SSH Brute Force Detected - fa210b61-b627-4e5e-86f4-17e8270656ab\n- Potential SSH Password Guessing - 8cb84371-d053-4f4f-bce0-c74990e28f28\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 11,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Credential Access"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 5,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1110",
                "name": "Brute Force",
                "reference": "https://attack.mitre.org/techniques/T1110/",
                "subtechnique": [
                  {
                    "id": "T1110.001",
                    "name": "Password Guessing",
                    "reference": "https://attack.mitre.org/techniques/T1110/001/"
                  },
                  {
                    "id": "T1110.003",
                    "name": "Password Spraying",
                    "reference": "https://attack.mitre.org/techniques/T1110/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Filebeat.\n\n### Filebeat Setup\nFilebeat is a lightweight shipper for forwarding and centralizing log data. Installed as an agent on your servers, Filebeat monitors the log files or locations that you specify, collects log events, and forwards them either to Elasticsearch or Logstash for indexing.\n\n#### The following steps should be executed in order to add the Filebeat on a Linux System:\n- Elastic provides repositories available for APT and YUM-based distributions. Note that we provide binary packages, but no source packages.\n- To install the APT and YUM repositories follow the setup instructions in this [helper guide](https://www.elastic.co/guide/en/beats/filebeat/current/setup-repositories.html).\n- To run Filebeat on Docker follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/filebeat/current/running-on-docker.html).\n- To run Filebeat on Kubernetes follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/filebeat/current/running-on-kubernetes.html).\n- For quick start information for Filebeat refer to the [helper guide](https://www.elastic.co/guide/en/beats/filebeat/8.11/filebeat-installation-configuration.html).\n- For complete â€œSetup and Run Filebeatâ€ information refer to the [helper guide](https://www.elastic.co/guide/en/beats/filebeat/current/setting-up-and-running.html).\n\n#### Rule Specific Setup Note\n- This rule requires the â€œFilebeat System Moduleâ€ to be enabled.\n- The system module collects and parses logs created by the system logging service of common Unix/Linux based distributions.\n- To run the system module of Filebeat on Linux follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-module-system.html).\n",
        "related_integrations": [
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "source.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "user.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "1764f9ff-a0f0-42bb-abe5-df84cdf5a2fb",
        "rule_id": "1c27fa22-7727-4dd3-81c0-de6da5555feb",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:24.895Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:04.069Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by host.id, source.ip, user.name with maxspan=15s\n  [ authentication where host.os.type == \"linux\" and \n   event.action in (\"ssh_login\", \"user_login\") and event.outcome == \"failure\" and\n   cidrmatch(source.ip, \"10.0.0.0/8\", \"127.0.0.0/8\", \"169.254.0.0/16\", \"172.16.0.0/12\", \"192.0.0.0/24\",\n       \"192.0.0.0/29\", \"192.0.0.8/32\", \"192.0.0.9/32\", \"192.0.0.10/32\", \"192.0.0.170/32\", \"192.0.0.171/32\",\n       \"192.0.2.0/24\", \"192.31.196.0/24\", \"192.52.193.0/24\", \"192.168.0.0/16\", \"192.88.99.0/24\", \"224.0.0.0/4\",\n       \"100.64.0.0/10\", \"192.175.48.0/24\",\"198.18.0.0/15\", \"198.51.100.0/24\", \"203.0.113.0/24\", \"240.0.0.0/4\", \n       \"::1\", \"FE80::/10\", \"FF00::/8\") ] with runs = 10",
        "language": "eql",
        "index": [
          "filebeat-*",
          "logs-system.auth-*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious File Creation in /etc for Persistence",
        "description": "Detects the manual creation of files in specific etc directories, via user root, used by Linux malware to persist and elevate privileges on compromised systems. File creation in these directories should not be entirely common and could indicate a malicious binary or script installing persistence mechanisms for long term access.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Suspicious File Creation in /etc for Persistence\n\nThe /etc/ directory in Linux is used to store system-wide configuration files and scripts.\n\nBy creating or modifying specific system-wide configuration files, attackers can leverage system services to execute malicious commands or scripts at predefined intervals, ensuring their continued presence and enabling unauthorized activities.\n\nThis rule monitors for the creation of the most common system-wide configuration files and scripts abused by attackers for persistence. \n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n> This investigation guide uses [placeholder fields](https://www.elastic.co/guide/en/security/current/osquery-placeholder-fields.html) to dynamically pass alert data into Osquery queries. Placeholder fields were introduced in Elastic Stack version 8.7.0. If you're using Elastic Stack version 8.6.0 or earlier, you'll need to manually adjust this investigation guide's queries to ensure they properly run.\n\n#### Possible Investigation Steps\n\n- Investigate the file that was created or modified.\n- Investigate whether any other files in any of the commonly abused directories have been altered through OSQuery.\n  - !{osquery{\"label\":\"Osquery - Retrieve File Listing Information\",\"query\":\"SELECT * FROM file WHERE ( path LIKE '/etc/ld.so.conf.d/%' OR path LIKE '/etc/cron.d/%' OR path LIKE '/etc/sudoers.d/%'\\nOR path LIKE '/etc/rc%.d/%' OR path LIKE '/etc/init.d/%' OR path LIKE '/etc/systemd/system/%' OR path LIKE\\n'/usr/lib/systemd/system/%' )\\n\"}}\n  - !{osquery{\"label\":\"Osquery - Retrieve Additional File Listing Information\",\"query\":\"SELECT f.path, u.username AS file_owner, g.groupname AS group_owner, datetime(f.atime, 'unixepoch') AS\\nfile_last_access_time, datetime(f.mtime, 'unixepoch') AS file_last_modified_time, datetime(f.ctime, 'unixepoch') AS\\nfile_last_status_change_time, datetime(f.btime, 'unixepoch') AS file_created_time, f.size AS size_bytes FROM file f LEFT\\nJOIN users u ON f.uid = u.uid LEFT JOIN groups g ON f.gid = g.gid WHERE ( path LIKE '/etc/ld.so.conf.d/%' OR path LIKE\\n'/etc/cron.d/%' OR path LIKE '/etc/sudoers.d/%' OR path LIKE '/etc/rc%.d/%' OR path LIKE '/etc/init.d/%' OR path LIKE\\n'/etc/systemd/system/%' OR path LIKE '/usr/lib/systemd/system/%' )\\n\"}}\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence and whether they are located in expected locations.\n  - !{osquery{\"label\":\"Osquery - Retrieve Running Processes by User\",\"query\":\"SELECT pid, username, name FROM processes p JOIN users u ON u.uid = p.uid ORDER BY username\"}}\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Validate the activity is not related to planned patches, updates, network administrator activity, or legitimate software installations.\n- Investigate whether the altered scripts call other malicious scripts elsewhere on the file system. \n  - If scripts or executables were dropped, retrieve the files and determine if they are malicious:\n    - Use a private sandboxed malware analysis system to perform analysis.\n      - Observe and collect information about the following activities:\n        - Attempts to contact external domains and addresses.\n          - Check if the domain is newly registered or unexpected.\n          - Check the reputation of the domain or IP address.\n        - File access, modification, and creation activities.\n        - Cron jobs, services and other persistence mechanisms.\n            - !{osquery{\"label\":\"Osquery - Retrieve Crontab Information\",\"query\":\"SELECT * FROM crontab\"}}\n- Investigate abnormal behaviors by the subject process/user such as network connections, file modifications, and any other spawned child processes.\n  - Investigate listening ports and open sockets to look for potential command and control traffic or data exfiltration.\n    - !{osquery{\"label\":\"Osquery - Retrieve Listening Ports\",\"query\":\"SELECT pid, address, port, socket, protocol, path FROM listening_ports\"}}\n    - !{osquery{\"label\":\"Osquery - Retrieve Open Sockets\",\"query\":\"SELECT pid, family, remote_address, remote_port, socket, state FROM process_open_sockets\"}}\n  - Identify the user account that performed the action, analyze it, and check whether it should perform this kind of action.\n    - !{osquery{\"label\":\"Osquery - Retrieve Information for a Specific User\",\"query\":\"SELECT * FROM users WHERE username = {{user.name}}\"}}\n- Investigate whether the user is currently logged in and active.\n    - !{osquery{\"label\":\"Osquery - Investigate the Account Authentication Status\",\"query\":\"SELECT * FROM logged_in_users WHERE user = {{user.name}}\"}}\n\n### False Positive Analysis\n\n- If this activity is related to new benign software installation activity, consider adding exceptions â€” preferably with a combination of user and command line conditions.\n- If this activity is related to a system administrator that performed these actions for administrative purposes, consider adding exceptions for this specific administrator user account. \n- Try to understand the context of the execution by thinking about the user, machine, or business purpose. A small number of endpoints, such as servers with unique software, might appear unusual but satisfy a specific business need.\n\n### Related Rules\n\n- Cron Job Created or Changed by Previously Unknown Process - ff10d4d8-fea7-422d-afb1-e5a2702369a9\n- Potential Persistence Through Run Control Detected - 0f4d35e4-925e-4959-ab24-911be207ee6f\n- Potential Persistence Through init.d Detected - 474fd20e-14cc-49c5-8160-d9ab4ba16c8b\n- New Systemd Timer Created - 7fb500fa-8e24-4bd1-9480-2a819352602c\n- New Systemd Service Created by Previously Unknown Process - 17b0a495-4d9f-414c-8ad0-92f018b8e001\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Delete the service/timer or restore its original configuration.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Leverage the incident response data and logging to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 116,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Threat: Orbit",
          "Threat: Lightning Framework",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.intezer.com/blog/incident-response/orbit-new-undetected-linux-threat/",
          "https://www.intezer.com/blog/research/lightning-framework-new-linux-threat/",
          "https://www.elastic.co/security-labs/primer-on-persistence-mechanisms",
          "https://www.elastic.co/security-labs/sequel-on-persistence-mechanisms"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1037",
                "name": "Boot or Logon Initialization Scripts",
                "reference": "https://attack.mitre.org/techniques/T1037/",
                "subtechnique": [
                  {
                    "id": "T1037.004",
                    "name": "RC Scripts",
                    "reference": "https://attack.mitre.org/techniques/T1037/004/"
                  }
                ]
              },
              {
                "id": "T1543",
                "name": "Create or Modify System Process",
                "reference": "https://attack.mitre.org/techniques/T1543/",
                "subtechnique": [
                  {
                    "id": "T1543.002",
                    "name": "Systemd Service",
                    "reference": "https://attack.mitre.org/techniques/T1543/002/"
                  }
                ]
              },
              {
                "id": "T1574",
                "name": "Hijack Execution Flow",
                "reference": "https://attack.mitre.org/techniques/T1574/",
                "subtechnique": [
                  {
                    "id": "T1574.006",
                    "name": "Dynamic Linker Hijacking",
                    "reference": "https://attack.mitre.org/techniques/T1574/006/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1053",
                "name": "Scheduled Task/Job",
                "reference": "https://attack.mitre.org/techniques/T1053/",
                "subtechnique": [
                  {
                    "id": "T1053.003",
                    "name": "Cron",
                    "reference": "https://attack.mitre.org/techniques/T1053/003/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1548",
                "name": "Abuse Elevation Control Mechanism",
                "reference": "https://attack.mitre.org/techniques/T1548/",
                "subtechnique": [
                  {
                    "id": "T1548.003",
                    "name": "Sudo and Sudo Caching",
                    "reference": "https://attack.mitre.org/techniques/T1548/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "78aa3949-0436-4c9c-b112-c04563fa9e43",
        "rule_id": "1c84dd64-7e6c-4bad-ac73-a5014ee37042",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:24.901Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:04.074Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"linux\" and event.type in (\"creation\", \"file_create_event\") and user.id == \"0\" and\nfile.path : (\"/etc/ld.so.conf.d/*\", \"/etc/cron.d/*\", \"/etc/sudoers.d/*\", \"/etc/init.d/*\", \"/etc/systemd/system/*\",\n\"/usr/lib/systemd/system/*\") and not (\n  (process.name : (\n    \"chef-client\", \"ruby\", \"pacman\", \"packagekitd\", \"python*\", \"platform-python\", \"dpkg\", \"yum\", \"apt\", \"dnf\", \"rpm\",\n    \"systemd\", \"snapd\", \"dnf-automatic\", \"yum-cron\", \"elastic-agent\", \"dnfdaemon-system\", \"dockerd\", \"executor\",\n    \"rhn_check\"\n    )\n  ) or \n  (file.extension in (\"swp\", \"swpx\", \"tmp\"))\n)",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "Incoming Execution via WinRM Remote Shell",
        "description": "Identifies remote execution via Windows Remote Management (WinRM) remote shell on a target host. This could be an indication of lateral movement.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 208,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Lateral Movement",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "WinRM is a dual-use protocol that can be used for benign or malicious activity. It's important to baseline your environment to determine the amount of noise to expect from this tool."
        ],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1021",
                "name": "Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1021/",
                "subtechnique": [
                  {
                    "id": "T1021.006",
                    "name": "Windows Remote Management",
                    "reference": "https://attack.mitre.org/techniques/T1021/006/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.port",
            "type": "long",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "network.direction",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "network.protocol",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pid",
            "type": "long",
            "ecs": true
          },
          {
            "name": "source.ip",
            "type": "ip",
            "ecs": true
          }
        ],
        "id": "efddbd0a-a6ad-4fbb-a76a-85677d6edb44",
        "rule_id": "1cd01db9-be24-4bef-8e7c-e923f0ff78ab",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:24.906Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:04.263Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by host.id with maxspan=30s\n   [network where host.os.type == \"windows\" and process.pid == 4 and network.direction : (\"incoming\", \"ingress\") and\n    destination.port in (5985, 5986) and network.protocol == \"http\" and source.ip != \"127.0.0.1\" and source.ip != \"::1\"]\n   [process where host.os.type == \"windows\" and \n    event.type == \"start\" and process.parent.name : \"winrshost.exe\" and not process.executable : \"?:\\\\Windows\\\\System32\\\\conhost.exe\"]",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-endpoint.events.network-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "Incoming Execution via PowerShell Remoting",
        "description": "Identifies remote execution via Windows PowerShell remoting. Windows PowerShell remoting allows a user to run any Windows PowerShell command on one or more remote computers. This could be an indication of lateral movement.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 209,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Lateral Movement",
          "Tactic: Execution",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "PowerShell remoting is a dual-use protocol that can be used for benign or malicious activity. It's important to baseline your environment to determine the amount of noise to expect from this tool."
        ],
        "references": [
          "https://docs.microsoft.com/en-us/powershell/scripting/learn/remoting/running-remote-commands?view=powershell-7.1"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1021",
                "name": "Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1021/",
                "subtechnique": [
                  {
                    "id": "T1021.006",
                    "name": "Windows Remote Management",
                    "reference": "https://attack.mitre.org/techniques/T1021/006/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.port",
            "type": "long",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "network.direction",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "network.protocol",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "source.ip",
            "type": "ip",
            "ecs": true
          }
        ],
        "id": "f8b8b3ff-0ca1-487b-9a9a-ec498415b8a9",
        "rule_id": "2772264c-6fb9-4d9d-9014-b416eed21254",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:24.908Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:05.864Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by host.id with maxspan = 30s\n   [network where host.os.type == \"windows\" and network.direction : (\"incoming\", \"ingress\") and destination.port in (5985, 5986) and\n    network.protocol == \"http\" and source.ip != \"127.0.0.1\" and source.ip != \"::1\"]\n   [process where host.os.type == \"windows\" and \n    event.type == \"start\" and process.parent.name : \"wsmprovhost.exe\" and not process.executable : \"?:\\\\Windows\\\\System32\\\\conhost.exe\"]",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-endpoint.events.network-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious Process Access via Direct System Call",
        "description": "Identifies suspicious process access events from an unknown memory region. Endpoint security solutions usually hook userland Windows APIs in order to decide if the code that is being executed is malicious or not. It's possible to bypass hooked functions by writing malicious functions that call syscalls directly.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Suspicious Process Access via Direct System Call\n\nEndpoint security solutions usually hook userland Windows APIs in order to decide if the code that is being executed is malicious or not. It's possible to bypass hooked functions by writing malicious functions that call syscalls directly.\n\nMore context and technical details can be found in this [research blog](https://outflank.nl/blog/2019/06/19/red-team-tactics-combining-direct-system-calls-and-srdi-to-bypass-av-edr/).\n\nThis rule identifies suspicious process access events from an unknown memory region. Attackers can use direct system calls to bypass security solutions that rely on hooks.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate any abnormal behavior by the subject process such as network connections, registry or file modifications, and any spawned child processes.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the process executable using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n\n### False positive analysis\n\n- This detection may be triggered by certain applications that install root certificates for the purpose of inspecting SSL traffic. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove the malicious certificate from the root certificate store.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 311,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Tactic: Execution",
          "Resources: Investigation Guide",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://twitter.com/SBousseaden/status/1278013896440324096",
          "https://www.ired.team/offensive-security/defense-evasion/using-syscalls-directly-from-visual-studio-to-bypass-avs-edrs"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1055",
                "name": "Process Injection",
                "reference": "https://attack.mitre.org/techniques/T1055/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1106",
                "name": "Native API",
                "reference": "https://attack.mitre.org/techniques/T1106/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.code",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.event_data.CallTrace",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "winlog.event_data.TargetImage",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "cee2ce0e-7fed-44be-b026-701a5a92eb2f",
        "rule_id": "2dd480be-1263-4d9c-8672-172928f6789a",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:24.914Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:04.036Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.code == \"10\" and\n length(winlog.event_data.CallTrace) > 0 and\n\n /* Sysmon CallTrace starting with unknown memory module instead of ntdll which host Windows NT Syscalls */\n not winlog.event_data.CallTrace :\n            (\"?:\\\\WINDOWS\\\\SYSTEM32\\\\ntdll.dll*\",\n             \"?:\\\\WINDOWS\\\\SysWOW64\\\\ntdll.dll*\",\n             \"?:\\\\Windows\\\\System32\\\\wow64cpu.dll*\",\n             \"?:\\\\WINDOWS\\\\System32\\\\wow64win.dll*\",\n             \"?:\\\\Windows\\\\System32\\\\win32u.dll*\") and\n\n not winlog.event_data.TargetImage :\n            (\"?:\\\\Program Files (x86)\\\\Malwarebytes Anti-Exploit\\\\mbae-svc.exe\",\n             \"?:\\\\Program Files\\\\Cisco\\\\AMP\\\\*\\\\sfc.exe\",\n             \"?:\\\\Program Files (x86)\\\\Microsoft\\\\EdgeWebView\\\\Application\\\\*\\\\msedgewebview2.exe\",\n             \"?:\\\\Program Files\\\\Adobe\\\\Acrobat DC\\\\Acrobat\\\\*\\\\AcroCEF.exe\") and\n\n not (process.executable : (\"?:\\\\Program Files\\\\Adobe\\\\Acrobat DC\\\\Acrobat\\\\Acrobat.exe\",\n                            \"?:\\\\Program Files (x86)\\\\World of Warcraft\\\\_classic_\\\\WowClassic.exe\") and\n      not winlog.event_data.TargetImage : \"?:\\\\WINDOWS\\\\system32\\\\lsass.exe\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "PowerShell Mailbox Collection Script",
        "description": "Detects PowerShell scripts that can be used to collect data from mailboxes. Adversaries may target user email to collect sensitive information.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating PowerShell Mailbox Collection Script\n\nPowerShell is one of the main tools system administrators use for automation, report routines, and other tasks. This makes it available for use in various environments, and creates an attractive way for attackers to execute code.\n\nEmail mailboxes and their information can be valuable assets for attackers. Company mailboxes often contain sensitive information such as login credentials, intellectual property, financial data, and personal information, making them high-value targets for malicious actors.\n\nThis rule identifies scripts that contains methods and classes that can be abused to collect emails from local and remote mailboxes.\n\n#### Possible investigation steps\n\n- Examine the script content that triggered the detection; look for suspicious DLL imports, collection or exfiltration capabilities, suspicious functions, encoded or compressed data, and other potentially malicious characteristics.\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Determine whether the script was executed and capture relevant information, such as arguments that reveal intent or are indicators of compromise (IoCs).\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Evaluate whether the user needs to use PowerShell to complete tasks.\n- Determine whether the script stores the captured data locally.\n- Investigate whether the script contains exfiltration capabilities and identify the exfiltration server.\n  - Assess network data to determine if the host communicated with the exfiltration server.\n\n### False positive analysis\n\n- This mechanism can be used legitimately. Analysts can dismiss the alert if the administrator is aware of the activity and it is done with proper approval.\n\n### Related rules\n\n- Exporting Exchange Mailbox via PowerShell - 6aace640-e631-4870-ba8e-5fdda09325db\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- If the involved host is not the Exchange server, isolate the host to prevent further post-compromise behavior.\n- Prioritize cases that involve personally identifiable information (PII) or other classified data.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 109,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Collection",
          "Data Source: PowerShell Logs",
          "Resources: Investigation Guide"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/dafthack/MailSniper/blob/master/MailSniper.ps1",
          "https://github.com/center-for-threat-informed-defense/adversary_emulation_library/blob/master/apt29/Archive/CALDERA_DIY/evals/payloads/stepSeventeen_email.ps1"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0009",
              "name": "Collection",
              "reference": "https://attack.mitre.org/tactics/TA0009/"
            },
            "technique": [
              {
                "id": "T1114",
                "name": "Email Collection",
                "reference": "https://attack.mitre.org/techniques/T1114/",
                "subtechnique": [
                  {
                    "id": "T1114.001",
                    "name": "Local Email Collection",
                    "reference": "https://attack.mitre.org/techniques/T1114/001/"
                  },
                  {
                    "id": "T1114.002",
                    "name": "Remote Email Collection",
                    "reference": "https://attack.mitre.org/techniques/T1114/002/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'PowerShell Script Block Logging' logging policy must be enabled.\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nAdministrative Templates >\nWindows PowerShell >\nTurn on PowerShell Script Block Logging (Enable)\n```\n\nSteps to implement the logging policy via registry:\n\n```\nreg add \"hklm\\SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\ScriptBlockLogging\" /v EnableScriptBlockLogging /t REG_DWORD /d 1\n```\n",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "powershell.file.script_block_text",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "8ce11bb5-d63a-4126-b459-96c0c3c54cd0",
        "rule_id": "a2d04374-187c-4fd9-b513-3ad4e7fdd67a",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:24.919Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:06.930Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-windows.powershell*"
        ],
        "filters": [],
        "query": "event.category:process and host.os.type:windows and\n  (\n   powershell.file.script_block_text : (\n      \"Microsoft.Office.Interop.Outlook\" or\n      \"Interop.Outlook.olDefaultFolders\" or\n      \"::olFolderInBox\"\n   ) or\n   powershell.file.script_block_text : (\n      \"Microsoft.Exchange.WebServices.Data.Folder\" or\n      \"Microsoft.Exchange.WebServices.Data.FileAttachment\"\n   )\n  ) and not user.id : \"S-1-5-18\"",
        "language": "kuery"
      },
      {
        "name": "Privilege Escalation via Root Crontab File Modification",
        "description": "Identifies modifications to the root crontab file. Adversaries may overwrite this file to gain code execution with root privileges by exploiting privileged file write or move related vulnerabilities.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 106,
        "tags": [
          "Domain: Endpoint",
          "OS: macOS",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://phoenhex.re/2017-06-09/pwn2own-diskarbitrationd-privesc",
          "https://www.exploit-db.com/exploits/42146"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1053",
                "name": "Scheduled Task/Job",
                "reference": "https://attack.mitre.org/techniques/T1053/",
                "subtechnique": [
                  {
                    "id": "T1053.003",
                    "name": "Cron",
                    "reference": "https://attack.mitre.org/techniques/T1053/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a macOS System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, for MacOS it is recommended to select \"Traditional Endpoints\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "f5f450aa-8a05-460e-b09e-e78d8e48a5d8",
        "rule_id": "0ff84c42-873d-41a2-a4ed-08d74d352d01",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:24.921Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:07.088Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": [],
        "query": "event.category:file and host.os.type:macos and not event.type:deletion and\n file.path:/private/var/at/tabs/root and not process.executable:/usr/bin/crontab",
        "language": "kuery"
      },
      {
        "name": "WebProxy Settings Modification",
        "description": "Identifies the use of the built-in networksetup command to configure webproxy settings. This may indicate an attempt to hijack web browser traffic for credential access via traffic sniffing or redirection.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Endpoint",
          "OS: macOS",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Legitimate WebProxy Settings Modification"
        ],
        "references": [
          "https://unit42.paloaltonetworks.com/mac-malware-steals-cryptocurrency-exchanges-cookies/",
          "https://objectivebythesea.com/v2/talks/OBTS_v2_Zohar.pdf"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1539",
                "name": "Steal Web Session Cookie",
                "reference": "https://attack.mitre.org/techniques/T1539/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a macOS System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, for MacOS it is recommended to select \"Traditional Endpoints\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.Ext.effective_parent.executable",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "97191368-a326-441f-9bfa-cad45d0711a1",
        "rule_id": "10a500bb-a28f-418e-ba29-ca4c8d1a9f2f",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:24.927Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:07.091Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": [],
        "query": "event.category:process and host.os.type:macos and event.type:start and\n process.name : networksetup and process.args : ((\"-setwebproxy\" or \"-setsecurewebproxy\" or \"-setautoproxyurl\") and not (Bluetooth or off)) and\n not process.parent.executable : (\"/Library/PrivilegedHelperTools/com.80pct.FreedomHelper\" or\n                                  \"/Applications/Fiddler Everywhere.app/Contents/Resources/app/out/WebServer/Fiddler.WebUi\" or\n                                  \"/usr/libexec/xpcproxy\") and\n not process.Ext.effective_parent.executable : (\"/Applications/Proxyman.app/Contents/MacOS/Proxyman\" or \"/Applications/Incoggo.app/Contents/MacOS/Incoggo.app\")",
        "language": "kuery"
      },
      {
        "name": "Abnormally Large DNS Response",
        "description": "Specially crafted DNS requests can manipulate a known overflow vulnerability in some Windows DNS servers, resulting in Remote Code Execution (RCE) or a Denial of Service (DoS) from crashing the service.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Abnormally Large DNS Response\n\nDetection alerts from this rule indicate possible anomalous activity around large byte DNS responses from a Windows DNS server. This detection rule was created based on activity represented in exploitation of vulnerability (CVE-2020-1350) also known as [SigRed](https://www.elastic.co/blog/detection-rules-for-sigred-vulnerability) during July 2020.\n\n#### Possible investigation steps\n\n- This specific rule is sourced from network log activity such as DNS or network level data. It's important to validate the source of the incoming traffic and determine if this activity has been observed previously within an environment.\n- Activity can be further investigated and validated by reviewing any associated Intrusion Detection Signatures (IDS) alerts.\n- Further examination can include a review of the `dns.question_type` network fieldset with a protocol analyzer, such as Zeek, Packetbeat, or Suricata, for `SIG` or `RRSIG` data.\n- Validate the patch level and OS of the targeted DNS server to validate the observed activity was not large-scale internet vulnerability scanning.\n- Validate that the source of the network activity was not from an authorized vulnerability scan or compromise assessment.\n\n#### False positive analysis\n\n- Based on this rule, which looks for a threshold of 60k bytes, it is possible for activity to be generated under 65k bytes and related to legitimate behavior. In packet capture files received by the [SANS Internet Storm Center](https://isc.sans.edu/forums/diary/PATCH+NOW+SIGRed+CVE20201350+Microsoft+DNS+Server+Vulnerability/26356/), byte responses were all observed as greater than 65k bytes.\n- This activity can be triggered by compliance/vulnerability scanning or compromise assessment; it's important to determine the source of the activity and potentially allowlist the source host.\n\n### Related rules\n\n- Unusual Child Process of dns.exe - 8c37dc0e-e3ac-4c97-8aa0-cf6a9122de45\n- Unusual File Modification by dns.exe - c7ce36c0-32ff-4f9a-bfc2-dcb242bf99f9\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Ensure that you have deployed the latest Microsoft [Security Update](https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2020-1350) (Monthly Rollup or Security Only) and restarted the patched machines. If unable to patch immediately, Microsoft [released](https://support.microsoft.com/en-us/help/4569509/windows-dns-server-remote-code-execution-vulnerability) a registry-based workaround that doesnâ€™t require a restart. This can be used as a temporary solution before the patch is applied.\n- Maintain backups of your critical systems to aid in quick recovery.\n- Perform routine vulnerability scans of your systems, monitor [CISA advisories](https://us-cert.cisa.gov/ncas/current-activity) and patch identified vulnerabilities.\n- If you observe a true positive, implement a remediation plan and monitor host-based artifacts for additional post-exploitation behavior.\n",
        "output_index": "",
        "version": 105,
        "tags": [
          "Use Case: Threat Detection",
          "Tactic: Lateral Movement",
          "Resources: Investigation Guide",
          "Use Case: Vulnerability"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Environments that leverage DNS responses over 60k bytes will result in false positives - if this traffic is predictable and expected, it should be filtered out. Additionally, this detection rule could be triggered by an authorized vulnerability scan or compromise assessment."
        ],
        "references": [
          "https://research.checkpoint.com/2020/resolving-your-way-into-domain-admin-exploiting-a-17-year-old-bug-in-windows-dns-servers/",
          "https://msrc-blog.microsoft.com/2020/07/14/july-2020-security-update-cve-2020-1350-vulnerability-in-windows-domain-name-system-dns-server/",
          "https://github.com/maxpl0it/CVE-2020-1350-DoS",
          "https://www.elastic.co/security-labs/detection-rules-for-sigred-vulnerability"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1210",
                "name": "Exploitation of Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1210/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "network_traffic",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.port",
            "type": "long",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "network.bytes",
            "type": "long",
            "ecs": true
          },
          {
            "name": "type",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "487a9497-848a-4c97-bf63-2c26f49511f1",
        "rule_id": "11013227-0301-4a8c-b150-4db924484475",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:24.932Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:07.095Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "packetbeat-*",
          "filebeat-*",
          "logs-network_traffic.*"
        ],
        "filters": [],
        "query": "(event.dataset: network_traffic.dns or (event.category: (network or network_traffic) and destination.port: 53)) and\n  (event.dataset:zeek.dns or type:dns or event.type:connection) and network.bytes > 60000",
        "language": "kuery"
      },
      {
        "name": "Potential DLL Side-Loading via Trusted Microsoft Programs",
        "description": "Identifies an instance of a Windows trusted program that is known to be vulnerable to DLL Search Order Hijacking starting after being renamed or from a non-standard path. This is uncommon behavior and may indicate an attempt to evade defenses via side loading a malicious DLL within the memory space of one of those processes.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 211,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Tactic: Execution",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: Microsoft Defender for Endpoint"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1036",
                "name": "Masquerading",
                "reference": "https://attack.mitre.org/techniques/T1036/"
              },
              {
                "id": "T1574",
                "name": "Hijack Execution Flow",
                "reference": "https://attack.mitre.org/techniques/T1574/",
                "subtechnique": [
                  {
                    "id": "T1574.002",
                    "name": "DLL Side-Loading",
                    "reference": "https://attack.mitre.org/techniques/T1574/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "9576b137-573c-4fec-b158-78b736f7d903",
        "rule_id": "1160dcdb-0a0a-4a79-91d8-9b84616edebd",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:24.934Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:07.098Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.pe.original_file_name in (\"WinWord.exe\", \"EXPLORER.EXE\", \"w3wp.exe\", \"DISM.EXE\") and\n  not (process.name : (\"winword.exe\", \"explorer.exe\", \"w3wp.exe\", \"Dism.exe\") or\n         process.executable : (\"?:\\\\Windows\\\\explorer.exe\",\n                               \"?:\\\\Program Files\\\\Microsoft Office\\\\root\\\\Office*\\\\WINWORD.EXE\",\n                               \"?:\\\\Program Files?(x86)\\\\Microsoft Office\\\\root\\\\Office*\\\\WINWORD.EXE\",\n                               \"?:\\\\Windows\\\\System32\\\\Dism.exe\",\n                               \"?:\\\\Windows\\\\SysWOW64\\\\Dism.exe\",\n                               \"?:\\\\Windows\\\\System32\\\\inetsrv\\\\w3wp.exe\")\n         )",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-m365_defender.event-*"
        ],
        "filters": []
      },
      {
        "name": "UAC Bypass via Windows Firewall Snap-In Hijack",
        "description": "Identifies attempts to bypass User Account Control (UAC) by hijacking the Microsoft Management Console (MMC) Windows Firewall snap-in. Attackers bypass UAC to stealthily execute code with elevated permissions.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating UAC Bypass via Windows Firewall Snap-In Hijack\n\nWindows User Account Control (UAC) allows a program to elevate its privileges (tracked as low to high integrity levels) to perform a task under administrator-level permissions, possibly by prompting the user for confirmation. UAC can deny an operation under high-integrity enforcement, or allow the user to perform the action if they are in the local administrators group and enter an administrator password when prompted.\n\nFor more information about the UAC and how it works, check the [official Microsoft docs page](https://docs.microsoft.com/en-us/windows/security/identity-protection/user-account-control/how-user-account-control-works).\n\nThis rule identifies attempts to bypass User Account Control (UAC) by hijacking the Microsoft Management Console (MMC) Windows Firewall snap-in. Attackers bypass UAC to stealthily execute code with elevated permissions.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Inspect the host for suspicious or abnormal behavior in the alert timeframe.\n- Investigate any abnormal behavior by the subject process such as network connections, registry or file modifications, and any spawned child processes.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze any suspicious spawned processes using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 312,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Tactic: Defense Evasion",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: SentinelOne"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/AzAgarampur/byeintegrity-uac"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1548",
                "name": "Abuse Elevation Control Mechanism",
                "reference": "https://attack.mitre.org/techniques/T1548/",
                "subtechnique": [
                  {
                    "id": "T1548.002",
                    "name": "Bypass User Account Control",
                    "reference": "https://attack.mitre.org/techniques/T1548/002/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1218",
                "name": "System Binary Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1218/",
                "subtechnique": [
                  {
                    "id": "T1218.014",
                    "name": "MMC",
                    "reference": "https://attack.mitre.org/techniques/T1218/014/"
                  }
                ]
              },
              {
                "id": "T1548",
                "name": "Abuse Elevation Control Mechanism",
                "reference": "https://attack.mitre.org/techniques/T1548/",
                "subtechnique": [
                  {
                    "id": "T1548.002",
                    "name": "Bypass User Account Control",
                    "reference": "https://attack.mitre.org/techniques/T1548/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "4e27625d-efcd-445d-a3f4-f787442c1d65",
        "rule_id": "1178ae09-5aff-460a-9f2f-455cd0ac4d8e",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:24.940Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:04.235Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n process.parent.name == \"mmc.exe\" and\n /* process.Ext.token.integrity_level_name == \"high\" can be added in future for tuning */\n /* args of the Windows Firewall SnapIn */\n  process.parent.args == \"WF.msc\" and process.name != \"WerFault.exe\"",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*"
        ],
        "filters": []
      },
      {
        "name": "AWS RDS Snapshot Export",
        "description": "Identifies the export of an Amazon Relational Database Service (RDS) Aurora database snapshot.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Cloud",
          "Data Source: AWS",
          "Data Source: Amazon Web Services",
          "Use Case: Asset Visibility",
          "Tactic: Exfiltration"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-3600s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic",
          "Austin Songer"
        ],
        "false_positives": [
          "Exporting snapshots may be done by a system or network administrator. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. Snapshot exports from unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule."
        ],
        "references": [
          "https://docs.aws.amazon.com/AmazonRDS/latest/APIReference/API_StartExportTask.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0010",
              "name": "Exfiltration",
              "reference": "https://attack.mitre.org/tactics/TA0010/"
            }
          }
        ],
        "setup": "The AWS Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "aws",
            "version": "^2.0.0",
            "integration": "cloudtrail"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "d093e4c2-267c-4a94-8e67-d7088a0fc38d",
        "rule_id": "119c8877-8613-416d-a98a-96b6664ee73a",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:24.946Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:07.101Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-aws.cloudtrail-*"
        ],
        "filters": [],
        "query": "event.dataset:aws.cloudtrail and event.provider:rds.amazonaws.com and event.action:StartExportTask and event.outcome:success",
        "language": "kuery"
      },
      {
        "name": "Third-party Backup Files Deleted via Unexpected Process",
        "description": "Identifies the deletion of backup files, saved using third-party software, by a process outside of the backup suite. Adversaries may delete Backup files to ensure that recovery from a ransomware attack is less likely.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Third-party Backup Files Deleted via Unexpected Process\n\nBackups are a significant obstacle for any ransomware operation. They allow the victim to resume business by performing data recovery, making them a valuable target.\n\nAttackers can delete backups from the host and gain access to backup servers to remove centralized backups for the environment, ensuring that victims have no alternatives to paying the ransom.\n\nThis rule identifies file deletions performed by a process that does not belong to the backup suite and aims to delete Veritas or Veeam backups.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Check if any files on the host machine have been encrypted.\n\n### False positive analysis\n\n- This rule can be triggered by the manual removal of backup files and by removal using other third-party tools that are not from the backup suite. Exceptions can be added for specific accounts and executables, preferably tied together.\n\n### Related rules\n\n- Deleting Backup Catalogs with Wbadmin - 581add16-df76-42bb-af8e-c979bfb39a59\n- Volume Shadow Copy Deleted or Resized via VssAdmin - b5ea4bfe-a1b2-421f-9d47-22a75a6f2921\n- Volume Shadow Copy Deletion via PowerShell - d99a037b-c8e2-47a5-97b9-170d076827c4\n- Volume Shadow Copy Deletion via WMIC - dc9c1f74-dac3-48e3-b47f-eb79db358f57\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Consider isolating the involved host to prevent destructive behavior, which is commonly associated with this activity.\n- Perform data recovery locally or restore the backups from replicated copies (Cloud, other servers, etc.).\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 213,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Impact",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: SentinelOne"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Certain utilities that delete files for disk cleanup or Administrators manually removing backup files."
        ],
        "references": [
          "https://www.advintel.io/post/backup-removal-solutions-from-conti-ransomware-with-love"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0040",
              "name": "Impact",
              "reference": "https://attack.mitre.org/tactics/TA0040/"
            },
            "technique": [
              {
                "id": "T1485",
                "name": "Data Destruction",
                "reference": "https://attack.mitre.org/techniques/T1485/"
              },
              {
                "id": "T1490",
                "name": "Inhibit System Recovery",
                "reference": "https://attack.mitre.org/techniques/T1490/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.code_signature.subject_name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.code_signature.trusted",
            "type": "boolean",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "7e972ec9-0f4b-438c-936d-5bec40b79cfb",
        "rule_id": "11ea6bec-ebde-4d71-a8e9-784948f8e3e9",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:24.948Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:04.228Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"windows\" and event.type == \"deletion\" and\n  (\n    /* Veeam Related Backup Files */\n    (\n      file.extension : (\"VBK\", \"VIB\", \"VBM\") and\n      not (\n        process.executable : (\"?:\\\\Windows\\\\*\", \"?:\\\\Program Files\\\\*\", \"?:\\\\Program Files (x86)\\\\*\") and\n        (process.code_signature.trusted == true and process.code_signature.subject_name : (\"Veeam Software Group GmbH\", \"Veeam Software AG\"))\n      )\n    ) or\n    /* Veritas Backup Exec Related Backup File */\n    (\n      file.extension : \"BKF\" and\n        not process.executable : (\n          \"?:\\\\Program Files\\\\Veritas\\\\Backup Exec\\\\*\",\n          \"?:\\\\Program Files (x86)\\\\Veritas\\\\Backup Exec\\\\*\"\n        )\n    )\n  ) and\n  not (\n    process.name : (\"MSExchangeMailboxAssistants.exe\", \"Microsoft.PowerBI.EnterpriseGateway.exe\") and\n      (process.code_signature.subject_name : \"Microsoft Corporation\" and process.code_signature.trusted == true)\n  ) and\n  not file.path : (\n    \"?:\\\\ProgramData\\\\Trend Micro\\\\*\",\n    \"?:\\\\Program Files (x86)\\\\Trend Micro\\\\*\",\n    \"?:\\\\$RECYCLE.BIN\\\\*\"\n  )",
        "language": "eql",
        "index": [
          "logs-endpoint.events.file-*",
          "endgame-*",
          "logs-sentinel_one_cloud_funnel.*"
        ],
        "filters": []
      },
      {
        "name": "AWS Route 53 Domain Transfer Lock Disabled",
        "description": "Identifies when a transfer lock was removed from a Route 53 domain. It is recommended to refrain from performing this action unless intending to transfer the domain to a different registrar.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Cloud",
          "Data Source: AWS",
          "Data Source: Amazon Web Services",
          "Data Source: AWS Route53",
          "Use Case: Asset Visibility",
          "Tactic: Persistence"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-3600s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic",
          "Austin Songer"
        ],
        "false_positives": [
          "A domain transfer lock may be disabled by a system or network administrator. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. Activity from unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule."
        ],
        "references": [
          "https://docs.aws.amazon.com/Route53/latest/APIReference/API_Operations_Amazon_Route_53.html",
          "https://docs.aws.amazon.com/Route53/latest/APIReference/API_domains_DisableDomainTransferLock.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1098",
                "name": "Account Manipulation",
                "reference": "https://attack.mitre.org/techniques/T1098/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            }
          }
        ],
        "setup": "The AWS Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "aws",
            "version": "^2.0.0",
            "integration": "cloudtrail"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "75ab8e75-ee5b-4dd0-905f-81461d93893a",
        "rule_id": "12051077-0124-4394-9522-8f4f4db1d674",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:24.953Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:07.104Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-aws.cloudtrail-*"
        ],
        "filters": [],
        "query": "event.dataset:aws.cloudtrail and event.provider:route53.amazonaws.com and event.action:DisableDomainTransferLock and event.outcome:success",
        "language": "kuery"
      },
      {
        "name": "Kubernetes Suspicious Self-Subject Review",
        "description": "This rule detects when a service account or node attempts to enumerate their own permissions via the selfsubjectaccessreview or selfsubjectrulesreview APIs. This is highly unusual behavior for non-human identities like service accounts and nodes. An adversary may have gained access to credentials/tokens and this could be an attempt to determine what privileges they have to facilitate further movement or execution within the cluster.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 203,
        "tags": [
          "Data Source: Kubernetes",
          "Tactic: Discovery"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "An administrator may submit this request as an \"impersonatedUser\" to determine what privileges a particular service account has been granted. However, an adversary may utilize the same technique as a means to determine the privileges of another token other than that of the compromised account."
        ],
        "references": [
          "https://www.paloaltonetworks.com/apps/pan/public/downloadResource?pagePath=/content/pan/en_US/resources/whitepapers/kubernetes-privilege-escalation-excessive-permissions-in-popular-platforms",
          "https://kubernetes.io/docs/reference/access-authn-authz/authorization/#checking-api-access",
          "https://techcommunity.microsoft.com/t5/microsoft-defender-for-cloud/detecting-identity-attacks-in-kubernetes/ba-p/3232340"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1613",
                "name": "Container and Resource Discovery",
                "reference": "https://attack.mitre.org/techniques/T1613/"
              }
            ]
          }
        ],
        "setup": "The Kubernetes Fleet integration with Audit Logs enabled or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "kubernetes",
            "version": "^1.4.1"
          }
        ],
        "required_fields": [
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "kubernetes.audit.annotations.authorization_k8s_io/decision",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "kubernetes.audit.impersonatedUser.username",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "kubernetes.audit.objectRef.resource",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "kubernetes.audit.user.username",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "kubernetes.audit.verb",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "5f0eb447-b2d3-46e8-af81-8a72db5a85a2",
        "rule_id": "12a2f15d-597e-4334-88ff-38a02cb1330b",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:24.959Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:07.108Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "logs-kubernetes.*"
        ],
        "filters": [],
        "query": "event.dataset : \"kubernetes.audit_logs\"\n  and kubernetes.audit.annotations.authorization_k8s_io/decision:\"allow\"\n  and kubernetes.audit.verb:\"create\"\n  and kubernetes.audit.objectRef.resource:(\"selfsubjectaccessreviews\" or \"selfsubjectrulesreviews\")\n  and (kubernetes.audit.user.username:(system\\:serviceaccount\\:* or system\\:node\\:*)\n  or kubernetes.audit.impersonatedUser.username:(system\\:serviceaccount\\:* or system\\:node\\:*))",
        "language": "kuery"
      },
      {
        "name": "Kubernetes Pod Created With HostNetwork",
        "description": "This rules detects an attempt to create or modify a pod attached to the host network. HostNetwork allows a pod to use the node network namespace. Doing so gives the pod access to any service running on localhost of the host. An attacker could use this access to snoop on network activity of other pods on the same node or bypass restrictive network policies applied to its given namespace.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 204,
        "tags": [
          "Data Source: Kubernetes",
          "Tactic: Execution",
          "Tactic: Privilege Escalation"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "An administrator or developer may want to use a pod that runs as root and shares the hosts IPC, Network, and PID namespaces for debugging purposes. If something is going wrong in the cluster and there is no easy way to SSH onto the host nodes directly, a privileged pod of this nature can be useful for viewing things like iptable rules and network namespaces from the host's perspective. Add exceptions for trusted container images using the query field \"kubernetes.audit.requestObject.spec.container.image\""
        ],
        "references": [
          "https://research.nccgroup.com/2021/11/10/detection-engineering-for-kubernetes-clusters/#part3-kubernetes-detections",
          "https://kubernetes.io/docs/concepts/security/pod-security-policy/#host-namespaces",
          "https://bishopfox.com/blog/kubernetes-pod-privilege-escalation"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1611",
                "name": "Escape to Host",
                "reference": "https://attack.mitre.org/techniques/T1611/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1610",
                "name": "Deploy Container",
                "reference": "https://attack.mitre.org/techniques/T1610/"
              }
            ]
          }
        ],
        "setup": "The Kubernetes Fleet integration with Audit Logs enabled or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "kubernetes",
            "version": "^1.4.1"
          }
        ],
        "required_fields": [
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "kubernetes.audit.annotations.authorization_k8s_io/decision",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "kubernetes.audit.objectRef.resource",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "kubernetes.audit.requestObject.spec.containers.image",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "kubernetes.audit.requestObject.spec.hostNetwork",
            "type": "boolean",
            "ecs": false
          },
          {
            "name": "kubernetes.audit.verb",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "faf0463e-72ec-48de-b2c1-a4a538f5e11f",
        "rule_id": "12cbf709-69e8-4055-94f9-24314385c27e",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:24.961Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:07.120Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "logs-kubernetes.*"
        ],
        "filters": [],
        "query": "event.dataset : \"kubernetes.audit_logs\"\n  and kubernetes.audit.annotations.authorization_k8s_io/decision:\"allow\"\n  and kubernetes.audit.objectRef.resource:\"pods\"\n  and kubernetes.audit.verb:(\"create\" or \"update\" or \"patch\")\n  and kubernetes.audit.requestObject.spec.hostNetwork:true\n  and not kubernetes.audit.requestObject.spec.containers.image: (\"docker.elastic.co/beats/elastic-agent:8.4.0\")",
        "language": "kuery"
      },
      {
        "name": "Suspicious Cmd Execution via WMI",
        "description": "Identifies suspicious command execution (cmd) via Windows Management Instrumentation (WMI) on a remote host. This could be indicative of adversary lateral movement.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 314,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/security-labs/elastic-protects-against-data-wiper-malware-targeting-ukraine-hermeticwiper",
          "https://www.elastic.co/security-labs/operation-bleeding-bear"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1047",
                "name": "Windows Management Instrumentation",
                "reference": "https://attack.mitre.org/techniques/T1047/"
              },
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.003",
                    "name": "Windows Command Shell",
                    "reference": "https://attack.mitre.org/techniques/T1059/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "30dffbdf-7ba1-4d16-a023-0a31ba011c31",
        "rule_id": "12f07955-1674-44f7-86b5-c35da0a6f41a",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:24.966Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:07.123Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n process.parent.name : \"WmiPrvSE.exe\" and process.name : \"cmd.exe\" and\n process.args : \"\\\\\\\\127.0.0.1\\\\*\" and process.args : (\"2>&1\", \"1>\")",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "winlogbeat-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Persistence via Scheduled Job Creation",
        "description": "A job can be used to schedule programs or scripts to be executed at a specified date and time. Adversaries may abuse task scheduling functionality to facilitate initial or recurring execution of malicious code.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 411,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Microsoft Defender for Endpoint"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Legitimate scheduled jobs may be created during installation of new software."
        ],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1053",
                "name": "Scheduled Task/Job",
                "reference": "https://attack.mitre.org/techniques/T1053/",
                "subtechnique": [
                  {
                    "id": "T1053.005",
                    "name": "Scheduled Task",
                    "reference": "https://attack.mitre.org/techniques/T1053/005/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "4a0cecc6-e0b7-4ad0-9500-1efbbefee641",
        "rule_id": "1327384f-00f3-44d5-9a8c-2373ba071e92",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:24.972Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:07.127Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"windows\" and event.type != \"deletion\" and\n  file.path : \"?:\\\\Windows\\\\Tasks\\\\*\" and file.extension : \"job\" and\n  not (\n    (\n      process.executable : \"?:\\\\Program Files\\\\CCleaner\\\\CCleaner64.exe\" and\n      file.path : \"?:\\\\Windows\\\\Tasks\\\\CCleanerCrashReporting.job\"\n    ) or\n    (\n      process.executable : (\n        \"?:\\\\Program Files (x86)\\\\ManageEngine\\\\UEMS_Agent\\\\bin\\\\dcagentregister.exe\",\n        \"?:\\\\Program Files (x86)\\\\DesktopCentral_Agent\\\\bin\\\\dcagentregister.exe\"\n      ) and\n      file.path : \"?:\\\\Windows\\\\Tasks\\\\DCAgentUpdater.job\"\n    )\n  )",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.file-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-m365_defender.event-*"
        ],
        "filters": []
      },
      {
        "name": "RPC (Remote Procedure Call) from the Internet",
        "description": "This rule detects network events that may indicate the use of RPC traffic from the Internet. RPC is commonly used by system administrators to remotely control a system for maintenance or to use shared resources. It should almost never be directly exposed to the Internet, as it is frequently targeted and exploited by threat actors as an initial access or backdoor vector.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 104,
        "tags": [
          "Tactic: Initial Access",
          "Domain: Endpoint",
          "Use Case: Threat Detection",
          "Data Source: PAN-OS"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.iana.org/assignments/iana-ipv4-special-registry/iana-ipv4-special-registry.xhtml"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1190",
                "name": "Exploit Public-Facing Application",
                "reference": "https://attack.mitre.org/techniques/T1190/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "network_traffic",
            "version": "^1.1.0"
          },
          {
            "package": "panw",
            "version": "^4.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "destination.port",
            "type": "long",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "network.transport",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "source.ip",
            "type": "ip",
            "ecs": true
          }
        ],
        "id": "50cc034f-7012-4caa-a75e-9e5ce4bc5a67",
        "rule_id": "143cb236-0956-4f42-a706-814bcaa0cf5a",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:24.974Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:08.194Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "packetbeat-*",
          "auditbeat-*",
          "filebeat-*",
          "logs-network_traffic.*",
          "logs-panw.panos*"
        ],
        "filters": [],
        "query": "(event.dataset: network_traffic.flow or (event.category: (network or network_traffic))) and\n  network.transport:tcp and (destination.port:135 or event.dataset:zeek.dce_rpc) and\n  not source.ip:(\n    10.0.0.0/8 or\n    127.0.0.0/8 or\n    169.254.0.0/16 or\n    172.16.0.0/12 or\n    192.0.0.0/24 or\n    192.0.0.0/29 or\n    192.0.0.8/32 or\n    192.0.0.9/32 or\n    192.0.0.10/32 or\n    192.0.0.170/32 or\n    192.0.0.171/32 or\n    192.0.2.0/24 or\n    192.31.196.0/24 or\n    192.52.193.0/24 or\n    192.168.0.0/16 or\n    192.88.99.0/24 or\n    224.0.0.0/4 or\n    100.64.0.0/10 or\n    192.175.48.0/24 or\n    198.18.0.0/15 or\n    198.51.100.0/24 or\n    203.0.113.0/24 or\n    240.0.0.0/4 or\n    \"::1\" or\n    \"FE80::/10\" or\n    \"FF00::/8\"\n  ) and\n  destination.ip:(\n    10.0.0.0/8 or\n    172.16.0.0/12 or\n    192.168.0.0/16\n  )",
        "language": "kuery"
      },
      {
        "name": "Kubernetes User Exec into Pod",
        "description": "This rule detects a user attempt to establish a shell session into a pod using the 'exec' command. Using the 'exec' command in a pod allows a user to establish a temporary shell session and execute any process/commands in the pod. An adversary may call bash to gain a persistent interactive shell which will allow access to any data the pod has permissions to, including secrets.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 203,
        "tags": [
          "Data Source: Kubernetes",
          "Tactic: Execution"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "An administrator may need to exec into a pod for a legitimate reason like debugging purposes. Containers built from Linux and Windows OS images, tend to include debugging utilities. In this case, an admin may choose to run commands inside a specific container with kubectl exec ${POD_NAME} -c ${CONTAINER_NAME} -- ${CMD} ${ARG1} ${ARG2} ... ${ARGN}. For example, the following command can be used to look at logs from a running Cassandra pod: kubectl exec cassandra --cat /var/log/cassandra/system.log . Additionally, the -i and -t arguments might be used to run a shell connected to the terminal: kubectl exec -i -t cassandra -- sh"
        ],
        "references": [
          "https://kubernetes.io/docs/tasks/debug/debug-application/debug-running-pod/",
          "https://kubernetes.io/docs/tasks/debug/debug-application/get-shell-running-container/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1609",
                "name": "Container Administration Command",
                "reference": "https://attack.mitre.org/techniques/T1609/"
              }
            ]
          }
        ],
        "setup": "The Kubernetes Fleet integration with Audit Logs enabled or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "kubernetes",
            "version": "^1.4.1"
          }
        ],
        "required_fields": [
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "kubernetes.audit.annotations.authorization_k8s_io/decision",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "kubernetes.audit.objectRef.resource",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "kubernetes.audit.objectRef.subresource",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "kubernetes.audit.verb",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "c6e46c00-a6bd-4e5f-928f-5a6752f59933",
        "rule_id": "14de811c-d60f-11ec-9fd7-f661ea17fbce",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:24.980Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:07.996Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "logs-kubernetes.*"
        ],
        "filters": [],
        "query": "event.dataset : \"kubernetes.audit_logs\"\n  and kubernetes.audit.annotations.authorization_k8s_io/decision:\"allow\"\n  and kubernetes.audit.verb:\"create\"\n  and kubernetes.audit.objectRef.resource:\"pods\"\n  and kubernetes.audit.objectRef.subresource:\"exec\"",
        "language": "kuery"
      },
      {
        "name": "Potential Persistence via Time Provider Modification",
        "description": "Identifies modification of the Time Provider. Adversaries may establish persistence by registering and enabling a malicious DLL as a time provider. Windows uses the time provider architecture to obtain accurate time stamps from other network devices or clients in the network. Time providers are implemented in the form of a DLL file which resides in the System32 folder. The service W32Time initiates during the startup of Windows and loads w32time.dll.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Potential Persistence via Time Provider Modification\n\nThe Time Provider architecture in Windows is responsible for obtaining accurate timestamps from network devices or clients. It is implemented as a DLL file in the System32 folder and is initiated by the W32Time service during Windows startup. Adversaries may exploit this by registering and enabling a malicious DLL as a time provider to establish persistence. \n\nThis rule identifies changes in the registry paths associated with Time Providers, specifically targeting the addition of new DLL files.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Examine whether the DLL is signed.\n- Retrieve the DLL and determine if it is malicious:\n  - Analyze the file using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and Remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Restore Time Provider settings to the desired state.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 311,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Tactic: Privilege Escalation",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: SentinelOne"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://pentestlab.blog/2019/10/22/persistence-time-providers/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1547",
                "name": "Boot or Logon Autostart Execution",
                "reference": "https://attack.mitre.org/techniques/T1547/",
                "subtechnique": [
                  {
                    "id": "T1547.003",
                    "name": "Time Providers",
                    "reference": "https://attack.mitre.org/techniques/T1547/003/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1547",
                "name": "Boot or Logon Autostart Execution",
                "reference": "https://attack.mitre.org/techniques/T1547/",
                "subtechnique": [
                  {
                    "id": "T1547.003",
                    "name": "Time Providers",
                    "reference": "https://attack.mitre.org/techniques/T1547/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.data.strings",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "registry.path",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "a323ef05-8149-420a-985a-68d11c380c51",
        "rule_id": "14ed1aa9-ebfd-4cf9-a463-0ac59ec55204",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:24.985Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:08.000Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n  registry.path: (\n    \"HKLM\\\\SYSTEM\\\\*ControlSet*\\\\Services\\\\W32Time\\\\TimeProviders\\\\*\",\n    \"\\\\REGISTRY\\\\MACHINE\\\\SYSTEM\\\\*ControlSet*\\\\Services\\\\W32Time\\\\TimeProviders\\\\*\",\n    \"MACHINE\\\\SYSTEM\\\\*ControlSet*\\\\Services\\\\W32Time\\\\TimeProviders\\\\*\"\n  ) and\n  registry.data.strings:\"*.dll\" and\n  not\n  (\n    process.executable : \"?:\\\\Windows\\\\System32\\\\msiexec.exe\" and\n    registry.data.strings : \"?:\\\\Program Files\\\\VMware\\\\VMware Tools\\\\vmwTimeProvider\\\\vmwTimeProvider.dll\"\n  ) and\n  not registry.data.strings : \"C:\\\\Windows\\\\SYSTEM32\\\\w32time.DLL\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.registry-*",
          "endgame-*",
          "logs-windows.sysmon_operational-*",
          "winlogbeat-*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*"
        ],
        "filters": []
      },
      {
        "name": "Remote File Download via Desktopimgdownldr Utility",
        "description": "Identifies the desktopimgdownldr utility being used to download a remote file. An adversary may use desktopimgdownldr to download arbitrary files as an alternative to certutil.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Remote File Download via Desktopimgdownldr Utility\n\nAttackers commonly transfer tooling or malware from external systems into a compromised environment using the command and control channel. However, they can also abuse signed utilities to drop these files.\n\nThe `Desktopimgdownldr.exe` utility is used to to configure lockscreen/desktop image, and can be abused with the `lockscreenurl` argument to download remote files and tools, this rule looks for this behavior.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n> This investigation guide uses the [Investigate Markdown Plugin](https://www.elastic.co/guide/en/security/master/interactive-investigation-guides.html) introduced in Elastic Stack version 8.8.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n  - !{investigate{\"label\":\"Alerts associated with the user in the last 48h\",\"providers\":[[{\"excluded\":false,\"field\":\"event.kind\",\"queryType\":\"phrase\",\"value\":\"signal\",\"valueType\":\"string\"},{\"excluded\":false,\"field\":\"user.id\",\"queryType\":\"phrase\",\"value\":\"{{user.id}}\",\"valueType\":\"string\"}]],\"relativeFrom\":\"now-48h/h\",\"relativeTo\":\"now\"}}\n  - !{investigate{\"label\":\"Alerts associated with the host in the last 48h\",\"providers\":[[{\"excluded\":false,\"field\":\"event.kind\",\"queryType\":\"phrase\",\"value\":\"signal\",\"valueType\":\"string\"},{\"excluded\":false,\"field\":\"host.name\",\"queryType\":\"phrase\",\"value\":\"{{host.name}}\",\"valueType\":\"string\"}]],\"relativeFrom\":\"now-48h/h\",\"relativeTo\":\"now\"}}\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n- Check the reputation of the domain or IP address used to host the downloaded file or if the user downloaded the file from an internal system.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the file using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n        - !{investigate{\"label\":\"Investigate the Subject Process Network Events\",\"providers\":[[{\"excluded\":false,\"field\":\"process.entity_id\",\"queryType\":\"phrase\",\"value\":\"{{process.entity_id}}\",\"valueType\":\"string\"},{\"excluded\":false,\"field\":\"event.category\",\"queryType\":\"phrase\",\"value\":\"network\",\"valueType\":\"string\"}]]}}\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n### False positive analysis\n\n- This activity is unusual but can be done by administrators. Benign true positives (B-TPs) can be added as exceptions if necessary.\n- Analysts can dismiss the alert if the downloaded file is a legitimate image.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 314,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Command and Control",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: SentinelOne",
          "Data Source: Sysmon",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://labs.sentinelone.com/living-off-windows-land-a-new-native-file-downldr/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            },
            "technique": [
              {
                "id": "T1105",
                "name": "Ingress Tool Transfer",
                "reference": "https://attack.mitre.org/techniques/T1105/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "c8e3bc10-11f7-4976-885d-38f582b87471",
        "rule_id": "15c0b7a7-9c34-4869-b25b-fa6518414899",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:24.987Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:04.244Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (process.name : \"desktopimgdownldr.exe\" or ?process.pe.original_file_name == \"desktopimgdownldr.exe\") and\n  process.args : \"/lockscreenurl:http*\"",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Potential Kerberos Attack via Bifrost",
        "description": "Identifies use of Bifrost, a known macOS Kerberos pentesting tool, which can be used to dump cached Kerberos tickets or attempt unauthorized authentication techniques such as pass-the-ticket/hash and kerberoasting.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 106,
        "tags": [
          "Domain: Endpoint",
          "OS: macOS",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Tactic: Lateral Movement",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/its-a-feature/bifrost"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1550",
                "name": "Use Alternate Authentication Material",
                "reference": "https://attack.mitre.org/techniques/T1550/",
                "subtechnique": [
                  {
                    "id": "T1550.003",
                    "name": "Pass the Ticket",
                    "reference": "https://attack.mitre.org/techniques/T1550/003/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1558",
                "name": "Steal or Forge Kerberos Tickets",
                "reference": "https://attack.mitre.org/techniques/T1558/",
                "subtechnique": [
                  {
                    "id": "T1558.003",
                    "name": "Kerberoasting",
                    "reference": "https://attack.mitre.org/techniques/T1558/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a macOS System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, for MacOS it is recommended to select \"Traditional Endpoints\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "fb5b3247-4416-4b55-8b8c-b7b863970eca",
        "rule_id": "16904215-2c95-4ac8-bf5c-12354e047192",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:25.010Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:08.014Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": [],
        "query": "event.category:process and host.os.type:macos and event.type:start and\n process.args:(\"-action\" and (\"-kerberoast\" or askhash or asktgs or asktgt or s4u or (\"-ticket\" and ptt) or (dump and (tickets or keytab))))",
        "language": "kuery"
      },
      {
        "name": "Virtual Private Network Connection Attempt",
        "description": "Identifies the execution of macOS built-in commands to connect to an existing Virtual Private Network (VPN). Adversaries may use VPN connections to laterally move and control remote systems on a network.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 107,
        "tags": [
          "Domain: Endpoint",
          "OS: macOS",
          "Use Case: Threat Detection",
          "Tactic: Lateral Movement",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/rapid7/metasploit-framework/blob/master/modules/post/osx/manage/vpn.rb",
          "https://www.unix.com/man-page/osx/8/networksetup/",
          "https://superuser.com/questions/358513/start-configured-vpn-from-command-line-osx"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1021",
                "name": "Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1021/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a macOS System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, for MacOS it is recommended to select \"Traditional Endpoints\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "678a8886-bbc6-46c1-ab40-3647f04181c5",
        "rule_id": "15dacaa0-5b90-466b-acab-63435a59701a",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:25.370Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:08.004Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and\n  (\n    (process.name : \"networksetup\" and process.args : \"-connectpppoeservice\") or\n    (process.name : \"scutil\" and process.args : \"--nc\" and process.args : \"start\") or\n    (process.name : \"osascript\" and process.command_line : \"osascript*set VPN to service*\")\n  )",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "File Creation Time Changed",
        "description": "Identifies modification of a file creation time. Adversaries may modify file time attributes to blend malicious content with existing files. Timestomping is a technique that modifies the timestamps of a file often to mimic files that are in trusted directories.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 105,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1070",
                "name": "Indicator Removal",
                "reference": "https://attack.mitre.org/techniques/T1070/",
                "subtechnique": [
                  {
                    "id": "T1070.006",
                    "name": "Timestomp",
                    "reference": "https://attack.mitre.org/techniques/T1070/006/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.code",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "d14d33fa-d05e-44fc-b34f-f712e302d096",
        "rule_id": "166727ab-6768-4e26-b80c-948b228ffc06",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:25.376Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:08.011Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"windows\" and event.code : \"2\" and\n\n /* Requires Sysmon EventID 2 - File creation time change */\n event.action : \"File creation time changed*\" and \n \n not process.executable : \n          (\"?:\\\\Program Files\\\\*\", \n           \"?:\\\\Program Files (x86)\\\\*\", \n           \"?:\\\\Windows\\\\system32\\\\cleanmgr.exe\",\n           \"?:\\\\Windows\\\\system32\\\\msiexec.exe\", \n           \"?:\\\\Windows\\\\syswow64\\\\msiexec.exe\", \n           \"?:\\\\Windows\\\\system32\\\\svchost.exe\", \n           \"?:\\\\WINDOWS\\\\system32\\\\backgroundTaskHost.exe\",\n           \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Google\\\\Chrome\\\\Application\\\\chrome.exe\", \n           \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Mozilla Firefox\\\\firefox.exe\",\n           \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\slack\\\\app-*\\\\slack.exe\", \n           \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\GitHubDesktop\\\\app-*\\\\GitHubDesktop.exe\",\n           \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Microsoft\\\\Teams\\\\current\\\\Teams.exe\", \n           \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Microsoft\\\\OneDrive\\\\OneDrive.exe\") and \n not file.extension : (\"temp\", \"tmp\", \"~tmp\", \"xml\", \"newcfg\") and not user.name : (\"SYSTEM\", \"Local Service\", \"Network Service\") and\n not file.name : (\"LOG\", \"temp-index\", \"license.rtf\", \"iconcache_*.db\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "Rare User Logon",
        "description": "A machine learning job found an unusual user name in the authentication logs. An unusual user name is one way of detecting credentialed access by means of a new or dormant user account. An inactive user account (because the user has left the organization) that becomes active may be due to credentialed access using a compromised account password. Threat actors will sometimes also create new users as a means of persisting in a compromised web application.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Rare User Logon\n\nThis rule uses a machine learning job to detect an unusual user name in authentication logs, which could detect new accounts created for persistence.\n\n#### Possible investigation steps\n\n- Check if the user was newly created and if the company policies were followed.\n  - Identify the user account that performed the action and whether it should perform this kind of action.\n- Investigate other alerts associated with the involved users during the past 48 hours.\n- Investigate any abnormal account behavior, such as command executions, file creations or modifications, and network connections.\n\n### False positive analysis\n\n- Accounts that are used for specific purposes â€” and therefore not normally active â€” may trigger the alert.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 105,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Use Case: Threat Detection",
          "Rule Type: ML",
          "Rule Type: Machine Learning",
          "Tactic: Initial Access",
          "Resources: Investigation Guide"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "15m",
        "from": "now-1800s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "User accounts that are rarely active, such as a site reliability engineer (SRE) or developer logging into a production server for troubleshooting, may trigger this alert. Under some conditions, a newly created user account may briefly trigger this alert while the model is learning."
        ],
        "references": [
          "https://www.elastic.co/guide/en/security/current/prebuilt-ml-jobs.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1078",
                "name": "Valid Accounts",
                "reference": "https://attack.mitre.org/techniques/T1078/",
                "subtechnique": [
                  {
                    "id": "T1078.002",
                    "name": "Domain Accounts",
                    "reference": "https://attack.mitre.org/techniques/T1078/002/"
                  },
                  {
                    "id": "T1078.003",
                    "name": "Local Accounts",
                    "reference": "https://attack.mitre.org/techniques/T1078/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires the installation of associated Machine Learning jobs, as well as data coming in from one of the following integrations:\n- Elastic Defend\n- Auditd Manager\n- System\n\n### Anomaly Detection Setup\n\nOnce the rule is enabled, the associated Machine Learning job will start automatically. You can view the Machine Learning job linked under the \"Definition\" panel of the detection rule. If the job does not start due to an error, the issue must be resolved for the job to commence successfully. For more details on setting up anomaly detection jobs, refer to the [helper guide](https://www.elastic.co/guide/en/kibana/current/xpack-ml-anomalies.html).\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration to your system:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n### Auditd Manager Integration Setup\nThe Auditd Manager Integration receives audit events from the Linux Audit Framework which is a part of the Linux kernel.\nAuditd Manager provides a user-friendly interface and automation capabilities for configuring and monitoring system auditing through the auditd daemon. With `auditd_manager`, administrators can easily define audit rules, track system events, and generate comprehensive audit reports, improving overall security and compliance in the system.\n\n#### The following steps should be executed in order to add the Elastic Agent System integration \"auditd_manager\" to your system:\n- Go to the Kibana home page and click â€œAdd integrationsâ€.\n- In the query bar, search for â€œAuditd Managerâ€ and select the integration to see more details about it.\n- Click â€œAdd Auditd Managerâ€.\n- Configure the integration name and optionally add a description.\n- Review optional and advanced settings accordingly.\n- Add the newly installed â€œauditd managerâ€ to an existing or a new agent policy, and deploy the agent on a Linux system from which auditd log files are desirable.\n- Click â€œSave and Continueâ€.\n- For more details on the integration refer to the [helper guide](https://docs.elastic.co/integrations/auditd_manager).\n\n#### Rule Specific Setup Note\nAuditd Manager subscribes to the kernel and receives events as they occur without any additional configuration.\nHowever, if more advanced configuration is required to detect specific behavior, audit rules can be added to the integration in either the \"audit rules\" configuration box or the \"auditd rule files\" box by specifying a file to read the audit rules from.\n- For this detection rule no additional audit rules are required.\n\n### System Integration Setup\nThe System integration allows you to collect system logs and metrics from your servers with Elastic Agent.\n\n#### The following steps should be executed in order to add the Elastic Agent System integration \"system\" to your system:\n- Go to the Kibana home page and click â€œAdd integrationsâ€.\n- In the query bar, search for â€œSystemâ€ and select the integration to see more details about it.\n- Click â€œAdd Systemâ€.\n- Configure the integration name and optionally add a description.\n- Review optional and advanced settings accordingly.\n- Add the newly installed â€œsystemâ€ to an existing or a new agent policy, and deploy the agent on your system from which system log files are desirable.\n- Click â€œSave and Continueâ€.\n- For more details on the integration refer to the [helper guide](https://docs.elastic.co/integrations/system).\n",
        "related_integrations": [
          {
            "package": "auditd_manager",
            "version": "^1.0.0"
          },
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [],
        "id": "886d56ce-3c82-40f0-ba6f-f331aa4a466c",
        "rule_id": "138c5dd5-838b-446e-b1ac-c995c7f8108a",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:25.461Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:07.130Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "machine_learning",
        "anomaly_threshold": 75,
        "machine_learning_job_id": [
          "auth_rare_user"
        ]
      },
      {
        "name": "Unusual Windows Username",
        "description": "A machine learning job detected activity for a username that is not normally active, which can indicate unauthorized changes, activity by unauthorized users, lateral movement, or compromised credentials. In many organizations, new usernames are not often created apart from specific types of system activities, such as creating new accounts for new employees. These user accounts quickly become active and routine. Events from rarely used usernames can point to suspicious activity. Additionally, automated Linux fleets tend to see activity from rarely used usernames only when personnel log in to make authorized or unauthorized changes, or threat actors have acquired credentials and log in for malicious purposes. Unusual usernames can also indicate pivoting, where compromised credentials are used to try and move laterally from one host to another.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating an Unusual Windows User\nDetection alerts from this rule indicate activity for a Windows user name that is rare and unusual. Here are some possible avenues of investigation:\n- Consider the user as identified by the username field. Is this program part of an expected workflow for the user who ran this program on this host? Could this be related to occasional troubleshooting or support activity?\n- Examine the history of user activity. If this user only manifested recently, it might be a service account for a new software package. If it has a consistent cadence (for example if it runs monthly or quarterly), it might be part of a monthly or quarterly business process.\n- Examine the process arguments, title and working directory. These may provide indications as to the source of the program or the nature of the tasks that the user is performing.\n- Consider the same for the parent process. If the parent process is a legitimate system utility or service, this could be related to software updates or system management. If the parent process is something user-facing like an Office application, this process could be more suspicious.",
        "output_index": "",
        "version": 207,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Rule Type: ML",
          "Rule Type: Machine Learning",
          "Tactic: Initial Access"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "15m",
        "from": "now-2700s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Uncommon user activity can be due to an administrator or help desk technician logging onto a workstation or server in order to perform manual troubleshooting or reconfiguration."
        ],
        "references": [
          "https://www.elastic.co/guide/en/security/current/prebuilt-ml-jobs.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1078",
                "name": "Valid Accounts",
                "reference": "https://attack.mitre.org/techniques/T1078/",
                "subtechnique": [
                  {
                    "id": "T1078.002",
                    "name": "Domain Accounts",
                    "reference": "https://attack.mitre.org/techniques/T1078/002/"
                  },
                  {
                    "id": "T1078.003",
                    "name": "Local Accounts",
                    "reference": "https://attack.mitre.org/techniques/T1078/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires the installation of associated Machine Learning jobs, as well as data coming in from one of the following integrations:\n- Elastic Defend\n- Windows\n\n### Anomaly Detection Setup\n\nOnce the rule is enabled, the associated Machine Learning job will start automatically. You can view the Machine Learning job linked under the \"Definition\" panel of the detection rule. If the job does not start due to an error, the issue must be resolved for the job to commence successfully. For more details on setting up anomaly detection jobs, refer to the [helper guide](https://www.elastic.co/guide/en/kibana/current/xpack-ml-anomalies.html).\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration to your system:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n### Windows Integration Setup\nThe Windows integration allows you to monitor the Windows OS, services, applications, and more.\n\n#### The following steps should be executed in order to add the Elastic Agent System integration \"windows\" to your system:\n- Go to the Kibana home page and click â€œAdd integrationsâ€.\n- In the query bar, search for â€œWindowsâ€ and select the integration to see more details about it.\n- Click â€œAdd Windowsâ€.\n- Configure the integration name and optionally add a description.\n- Review optional and advanced settings accordingly.\n- Add the newly installed â€œwindowsâ€ to an existing or a new agent policy, and deploy the agent on your system from which windows log files are desirable.\n- Click â€œSave and Continueâ€.\n- For more details on the integration refer to the [helper guide](https://docs.elastic.co/integrations/windows).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [],
        "id": "22e2a7f0-cf18-46f8-876a-e76c064cbb25",
        "rule_id": "1781d055-5c66-4adf-9c59-fc0fa58336a5",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:30.946Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:08.021Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "machine_learning",
        "anomaly_threshold": 50,
        "machine_learning_job_id": [
          "v3_windows_anomalous_user_name"
        ]
      },
      {
        "name": "Component Object Model Hijacking",
        "description": "Identifies Component Object Model (COM) hijacking via registry modification. Adversaries may establish persistence by executing malicious content triggered by hijacked references to COM objects.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Component Object Model Hijacking\n\nAdversaries can insert malicious code that can be executed in place of legitimate software through hijacking the COM references and relationships as a means of persistence.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n- Retrieve the file referenced in the registry and determine if it is malicious:\n  - Use a private sandboxed malware analysis system to perform analysis.\n    - Observe and collect information about the following activities:\n      - Attempts to contact external domains and addresses.\n      - File and registry access, modification, and creation activities.\n      - Service creation and launch activities.\n      - Scheduled task creation.\n  - Use the PowerShell Get-FileHash cmdlet to get the files' SHA-256 hash values.\n    - Search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n\n### False positive analysis\n\n- Some Microsoft executables will reference the LocalServer32 registry key value for the location of external COM objects.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 114,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Tactic: Defense Evasion",
          "Tactic: Privilege Escalation",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://bohops.com/2018/08/18/abusing-the-com-registry-structure-part-2-loading-techniques-for-evasion-and-persistence/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1546",
                "name": "Event Triggered Execution",
                "reference": "https://attack.mitre.org/techniques/T1546/",
                "subtechnique": [
                  {
                    "id": "T1546.015",
                    "name": "Component Object Model Hijacking",
                    "reference": "https://attack.mitre.org/techniques/T1546/015/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1546",
                "name": "Event Triggered Execution",
                "reference": "https://attack.mitre.org/techniques/T1546/",
                "subtechnique": [
                  {
                    "id": "T1546.015",
                    "name": "Component Object Model Hijacking",
                    "reference": "https://attack.mitre.org/techniques/T1546/015/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1112",
                "name": "Modify Registry",
                "reference": "https://attack.mitre.org/techniques/T1112/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.code_signature.subject_name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.code_signature.trusted",
            "type": "boolean",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.data.strings",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "registry.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.domain",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "5e68ca06-5abf-4467-83a5-bc57e1e43965",
        "rule_id": "16a52c14-7883-47af-8745-9357803f0d4c",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:30.948Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:04.240Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n  /* not necessary but good for filtering privileged installations */\n  user.domain != \"NT AUTHORITY\" and process.executable != null and \n  (\n    (\n      registry.path : \"HK*\\\\InprocServer32\\\\\" and\n      registry.data.strings: (\"scrobj.dll\", \"?:\\\\*\\\\scrobj.dll\") and\n      not registry.path : \"*\\\\{06290BD*-48AA-11D2-8432-006008C3FBFC}\\\\*\"\n    ) or\n\n    (\n      registry.path : \"HKLM\\\\*\\\\InProcServer32\\\\*\" and\n        registry.data.strings : (\"*\\\\Users\\\\*\", \"*\\\\ProgramData\\\\*\")\n    ) or\n\n    /* in general COM Registry changes on Users Hive is less noisy and worth alerting */\n    (\n      registry.path : (\n        \"HKEY_USERS\\\\*\\\\InprocServer32\\\\\",\n        \"HKEY_USERS\\\\*\\\\LocalServer32\\\\\",\n        \"HKEY_USERS\\\\*\\\\DelegateExecute\",\n        \"HKEY_USERS\\\\*\\\\TreatAs\\\\\",\n        \"HKEY_USERS\\\\*\\\\ScriptletURL*\"\n      )  \n    )\n  ) and \n\n      not  (\n            process.code_signature.trusted == true and\n            process.code_signature.subject_name in \n                         (\"Island Technology Inc.\", \"Google LLC\", \"Grammarly, Inc.\", \"Dropbox, Inc\", \"REFINITIV US LLC\", \"HP Inc.\",\n                          \"Citrix Systems, Inc.\", \"Adobe Inc.\", \"Veeam Software Group GmbH\", \"Zhuhai Kingsoft Office Software Co., Ltd.\",\n                          \"Oracle America, Inc.\")\n        ) and \n\n  /* excludes Microsoft signed noisy processes */\n  not\n  (\n    process.name : (\"OneDrive.exe\", \"OneDriveSetup.exe\", \"FileSyncConfig.exe\", \"Teams.exe\", \"MicrosoftEdgeUpdate.exe\", \"msrdcw.exe\", \"MicrosoftEdgeUpdateComRegisterShell64.exe\") and\n    process.code_signature.trusted == true and process.code_signature.subject_name in (\"Microsoft Windows\", \"Microsoft Corporation\")\n  ) and\n  \n  not process.executable : \n                  (\"?:\\\\Program Files (x86)\\\\*.exe\", \n                   \"?:\\\\Program Files\\\\*.exe\",\n                   \"?:\\\\Windows\\\\System32\\\\svchost.exe\", \n                   \"?:\\\\Windows\\\\System32\\\\msiexec.exe\", \n                   \"?:\\\\Windows\\\\SysWOW64\\\\regsvr32.exe\",\n                   \"?:\\\\Windows\\\\System32\\\\regsvr32.exe\",\n                   \"?:\\\\Windows\\\\System32\\\\DriverStore\\\\FileRepository\\\\*.exe\", \n                   \"?:\\\\ProgramData\\\\Microsoft\\\\Windows Defender\\\\Platform\\\\*\\\\MsMpEng.exe\")",
        "language": "eql",
        "index": [
          "logs-endpoint.events.registry-*"
        ],
        "filters": []
      },
      {
        "name": "AWS IAM Group Creation",
        "description": "Identifies the creation of a group in AWS Identity and Access Management (IAM). Groups specify permissions for multiple users. Any user in a group automatically has the permissions that are assigned to the group.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Cloud",
          "Data Source: AWS",
          "Data Source: Amazon Web Services",
          "Data Source: AWS IAM",
          "Use Case: Identity and Access Audit",
          "Tactic: Persistence"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-3600s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "A group may be created by a system or network administrator. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. Group creations by unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule."
        ],
        "references": [
          "https://awscli.amazonaws.com/v2/documentation/api/latest/reference/iam/create-group.html",
          "https://docs.aws.amazon.com/IAM/latest/APIReference/API_CreateGroup.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1136",
                "name": "Create Account",
                "reference": "https://attack.mitre.org/techniques/T1136/",
                "subtechnique": [
                  {
                    "id": "T1136.003",
                    "name": "Cloud Account",
                    "reference": "https://attack.mitre.org/techniques/T1136/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The AWS Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "aws",
            "version": "^2.0.0",
            "integration": "cloudtrail"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "0554ffb3-381f-4f88-bdf1-093ae8972a4c",
        "rule_id": "169f3a93-efc7-4df2-94d6-0d9438c310d1",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:30.950Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:08.018Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-aws.cloudtrail-*"
        ],
        "filters": [],
        "query": "event.dataset:aws.cloudtrail and event.provider:iam.amazonaws.com and event.action:CreateGroup and event.outcome:success",
        "language": "kuery"
      },
      {
        "name": "Unusual Windows Service",
        "description": "A machine learning job detected an unusual Windows service, This can indicate execution of unauthorized services, malware, or persistence mechanisms. In corporate Windows environments, hosts do not generally run many rare or unique services. This job helps detect malware and persistence mechanisms that have been installed and run as a service.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Rule Type: ML",
          "Rule Type: Machine Learning",
          "Tactic: Persistence"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "15m",
        "from": "now-2700s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "A newly installed program or one that runs rarely as part of a monthly or quarterly workflow could trigger this alert."
        ],
        "references": [
          "https://www.elastic.co/guide/en/security/current/prebuilt-ml-jobs.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1543",
                "name": "Create or Modify System Process",
                "reference": "https://attack.mitre.org/techniques/T1543/",
                "subtechnique": [
                  {
                    "id": "T1543.003",
                    "name": "Windows Service",
                    "reference": "https://attack.mitre.org/techniques/T1543/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires the installation of associated Machine Learning jobs, as well as data coming in from one of the following integrations:\n- Elastic Defend\n- Windows\n\n### Anomaly Detection Setup\n\nOnce the rule is enabled, the associated Machine Learning job will start automatically. You can view the Machine Learning job linked under the \"Definition\" panel of the detection rule. If the job does not start due to an error, the issue must be resolved for the job to commence successfully. For more details on setting up anomaly detection jobs, refer to the [helper guide](https://www.elastic.co/guide/en/kibana/current/xpack-ml-anomalies.html).\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration to your system:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n### Windows Integration Setup\nThe Windows integration allows you to monitor the Windows OS, services, applications, and more.\n\n#### The following steps should be executed in order to add the Elastic Agent System integration \"windows\" to your system:\n- Go to the Kibana home page and click â€œAdd integrationsâ€.\n- In the query bar, search for â€œWindowsâ€ and select the integration to see more details about it.\n- Click â€œAdd Windowsâ€.\n- Configure the integration name and optionally add a description.\n- Review optional and advanced settings accordingly.\n- Add the newly installed â€œwindowsâ€ to an existing or a new agent policy, and deploy the agent on your system from which windows log files are desirable.\n- Click â€œSave and Continueâ€.\n- For more details on the integration refer to the [helper guide](https://docs.elastic.co/integrations/windows).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [],
        "id": "56c3819c-ba70-48cf-ba53-ab19aa408d34",
        "rule_id": "1781d055-5c66-4adf-9c71-fc0fa58338c7",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:30.956Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:08.025Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "machine_learning",
        "anomaly_threshold": 50,
        "machine_learning_job_id": [
          "v3_windows_anomalous_service"
        ]
      },
      {
        "name": "Suspicious Powershell Script",
        "description": "A machine learning job detected a PowerShell script with unusual data characteristics, such as obfuscation, that may be a characteristic of malicious PowerShell script text blocks.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 207,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Rule Type: ML",
          "Rule Type: Machine Learning",
          "Tactic: Execution"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "15m",
        "from": "now-2700s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Certain kinds of security testing may trigger this alert. PowerShell scripts that use high levels of obfuscation or have unusual script block payloads may trigger this alert."
        ],
        "references": [
          "https://www.elastic.co/guide/en/security/current/prebuilt-ml-jobs.html",
          "https://www.elastic.co/security-labs/detecting-living-off-the-land-attacks-with-new-elastic-integration"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires the installation of associated Machine Learning jobs, as well as data coming in from one of the following integrations:\n- Elastic Defend\n- Windows\n\n### Anomaly Detection Setup\n\nOnce the rule is enabled, the associated Machine Learning job will start automatically. You can view the Machine Learning job linked under the \"Definition\" panel of the detection rule. If the job does not start due to an error, the issue must be resolved for the job to commence successfully. For more details on setting up anomaly detection jobs, refer to the [helper guide](https://www.elastic.co/guide/en/kibana/current/xpack-ml-anomalies.html).\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration to your system:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n### Windows Integration Setup\nThe Windows integration allows you to monitor the Windows OS, services, applications, and more.\n\n#### The following steps should be executed in order to add the Elastic Agent System integration \"windows\" to your system:\n- Go to the Kibana home page and click â€œAdd integrationsâ€.\n- In the query bar, search for â€œWindowsâ€ and select the integration to see more details about it.\n- Click â€œAdd Windowsâ€.\n- Configure the integration name and optionally add a description.\n- Review optional and advanced settings accordingly.\n- Add the newly installed â€œwindowsâ€ to an existing or a new agent policy, and deploy the agent on your system from which windows log files are desirable.\n- Click â€œSave and Continueâ€.\n- For more details on the integration refer to the [helper guide](https://docs.elastic.co/integrations/windows).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [],
        "id": "13c918d0-6ba5-4ff8-95a8-ae69fca64302",
        "rule_id": "1781d055-5c66-4adf-9d60-fc0fa58337b6",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:30.957Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:08.028Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "machine_learning",
        "anomaly_threshold": 50,
        "machine_learning_job_id": [
          "v3_windows_anomalous_script"
        ]
      },
      {
        "name": "Unusual Windows User Privilege Elevation Activity",
        "description": "A machine learning job detected an unusual user context switch, using the runas command or similar techniques, which can indicate account takeover or privilege escalation using compromised accounts. Privilege elevation using tools like runas are more commonly used by domain and network administrators than by regular Windows users.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Rule Type: ML",
          "Rule Type: Machine Learning",
          "Tactic: Privilege Escalation"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "15m",
        "from": "now-2700s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Uncommon user privilege elevation activity can be due to an administrator, help desk technician, or a user performing manual troubleshooting or reconfiguration."
        ],
        "references": [
          "https://www.elastic.co/guide/en/security/current/prebuilt-ml-jobs.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            }
          }
        ],
        "setup": "## Setup\n\nThis rule requires the installation of associated Machine Learning jobs, as well as data coming in from one of the following integrations:\n- Elastic Defend\n- Windows\n\n### Anomaly Detection Setup\n\nOnce the rule is enabled, the associated Machine Learning job will start automatically. You can view the Machine Learning job linked under the \"Definition\" panel of the detection rule. If the job does not start due to an error, the issue must be resolved for the job to commence successfully. For more details on setting up anomaly detection jobs, refer to the [helper guide](https://www.elastic.co/guide/en/kibana/current/xpack-ml-anomalies.html).\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration to your system:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n### Windows Integration Setup\nThe Windows integration allows you to monitor the Windows OS, services, applications, and more.\n\n#### The following steps should be executed in order to add the Elastic Agent System integration \"windows\" to your system:\n- Go to the Kibana home page and click â€œAdd integrationsâ€.\n- In the query bar, search for â€œWindowsâ€ and select the integration to see more details about it.\n- Click â€œAdd Windowsâ€.\n- Configure the integration name and optionally add a description.\n- Review optional and advanced settings accordingly.\n- Add the newly installed â€œwindowsâ€ to an existing or a new agent policy, and deploy the agent on your system from which windows log files are desirable.\n- Click â€œSave and Continueâ€.\n- For more details on the integration refer to the [helper guide](https://docs.elastic.co/integrations/windows).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [],
        "id": "f23922b7-c00c-49c0-8ea2-fae3f024be18",
        "rule_id": "1781d055-5c66-4adf-9d82-fc0fa58449c8",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:30.959Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:08.044Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "machine_learning",
        "anomaly_threshold": 50,
        "machine_learning_job_id": [
          "v3_windows_rare_user_runas_event"
        ]
      },
      {
        "name": "Unusual Windows Remote User",
        "description": "A machine learning job detected an unusual remote desktop protocol (RDP) username, which can indicate account takeover or credentialed persistence using compromised accounts. RDP attacks, such as BlueKeep, also tend to use unusual usernames.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating an Unusual Windows User\nDetection alerts from this rule indicate activity for a rare and unusual Windows RDP (remote desktop) user. Here are some possible avenues of investigation:\n- Consider the user as identified by the username field. Is the user part of a group who normally logs into Windows hosts using RDP (remote desktop protocol)? Is this logon activity part of an expected workflow for the user?\n- Consider the source of the login. If the source is remote, could this be related to occasional troubleshooting or support activity by a vendor or an employee working remotely?",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Rule Type: ML",
          "Rule Type: Machine Learning",
          "Tactic: Initial Access"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "15m",
        "from": "now-2700s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Uncommon username activity can be due to an engineer logging onto a server instance in order to perform manual troubleshooting or reconfiguration."
        ],
        "references": [
          "https://www.elastic.co/guide/en/security/current/prebuilt-ml-jobs.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1078",
                "name": "Valid Accounts",
                "reference": "https://attack.mitre.org/techniques/T1078/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires the installation of associated Machine Learning jobs, as well as data coming in from one of the following integrations:\n- Elastic Defend\n- Windows\n\n### Anomaly Detection Setup\n\nOnce the rule is enabled, the associated Machine Learning job will start automatically. You can view the Machine Learning job linked under the \"Definition\" panel of the detection rule. If the job does not start due to an error, the issue must be resolved for the job to commence successfully. For more details on setting up anomaly detection jobs, refer to the [helper guide](https://www.elastic.co/guide/en/kibana/current/xpack-ml-anomalies.html).\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration to your system:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n### Windows Integration Setup\nThe Windows integration allows you to monitor the Windows OS, services, applications, and more.\n\n#### The following steps should be executed in order to add the Elastic Agent System integration \"windows\" to your system:\n- Go to the Kibana home page and click â€œAdd integrationsâ€.\n- In the query bar, search for â€œWindowsâ€ and select the integration to see more details about it.\n- Click â€œAdd Windowsâ€.\n- Configure the integration name and optionally add a description.\n- Review optional and advanced settings accordingly.\n- Add the newly installed â€œwindowsâ€ to an existing or a new agent policy, and deploy the agent on your system from which windows log files are desirable.\n- Click â€œSave and Continueâ€.\n- For more details on the integration refer to the [helper guide](https://docs.elastic.co/integrations/windows).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [],
        "id": "f750b73b-148a-466e-b539-a64abf56cc25",
        "rule_id": "1781d055-5c66-4adf-9e93-fc0fa69550c9",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:30.961Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:08.048Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "machine_learning",
        "anomaly_threshold": 50,
        "machine_learning_job_id": [
          "v3_windows_rare_user_type10_remote_login"
        ]
      },
      {
        "name": "Unusual Network Destination Domain Name",
        "description": "A machine learning job detected an unusual network destination domain name. This can be due to initial access, persistence, command-and-control, or exfiltration activity. For example, when a user clicks on a link in a phishing email or opens a malicious document, a request may be sent to download and run a payload from an uncommon web server name. When malware is already running, it may send requests to an uncommon DNS domain the malware uses for command-and-control communication.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 104,
        "tags": [
          "Use Case: Threat Detection",
          "Rule Type: ML",
          "Rule Type: Machine Learning"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "15m",
        "from": "now-2700s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Web activity that occurs rarely in small quantities can trigger this alert. Possible examples are browsing technical support or vendor URLs that are used very sparsely. A user who visits a new and unique web destination may trigger this alert when the activity is sparse. Web applications that generate URLs unique to a transaction may trigger this when they are used sparsely. Web domains can be excluded in cases such as these."
        ],
        "references": [
          "https://www.elastic.co/guide/en/security/current/prebuilt-ml-jobs.html"
        ],
        "max_signals": 100,
        "threat": [],
        "setup": "## Setup\n\nThis rule requires the installation of associated Machine Learning jobs, as well as data coming in from one of the following integrations:\n- Elastic Defend\n- Auditd Manager\n\n### Anomaly Detection Setup\n\nOnce the rule is enabled, the associated Machine Learning job will start automatically. You can view the Machine Learning job linked under the \"Definition\" panel of the detection rule. If the job does not start due to an error, the issue must be resolved for the job to commence successfully. For more details on setting up anomaly detection jobs, refer to the [helper guide](https://www.elastic.co/guide/en/kibana/current/xpack-ml-anomalies.html).\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration to your system:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n### Auditd Manager Integration Setup\nThe Auditd Manager Integration receives audit events from the Linux Audit Framework which is a part of the Linux kernel.\nAuditd Manager provides a user-friendly interface and automation capabilities for configuring and monitoring system auditing through the auditd daemon. With `auditd_manager`, administrators can easily define audit rules, track system events, and generate comprehensive audit reports, improving overall security and compliance in the system.\n\n#### The following steps should be executed in order to add the Elastic Agent System integration \"auditd_manager\" to your system:\n- Go to the Kibana home page and click â€œAdd integrationsâ€.\n- In the query bar, search for â€œAuditd Managerâ€ and select the integration to see more details about it.\n- Click â€œAdd Auditd Managerâ€.\n- Configure the integration name and optionally add a description.\n- Review optional and advanced settings accordingly.\n- Add the newly installed â€œauditd managerâ€ to an existing or a new agent policy, and deploy the agent on a Linux system from which auditd log files are desirable.\n- Click â€œSave and Continueâ€.\n- For more details on the integration refer to the [helper guide](https://docs.elastic.co/integrations/auditd_manager).\n\n#### Rule Specific Setup Note\nAuditd Manager subscribes to the kernel and receives events as they occur without any additional configuration.\nHowever, if more advanced configuration is required to detect specific behavior, audit rules can be added to the integration in either the \"audit rules\" configuration box or the \"auditd rule files\" box by specifying a file to read the audit rules from.\n- For this detection rule no additional audit rules are required.\n",
        "related_integrations": [
          {
            "package": "auditd_manager",
            "version": "^1.0.0"
          },
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [],
        "id": "beec8040-44a6-4931-bbd7-328001d59745",
        "rule_id": "17e68559-b274-4948-ad0b-f8415bb31126",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:30.963Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:08.052Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "machine_learning",
        "anomaly_threshold": 50,
        "machine_learning_job_id": [
          "packetbeat_rare_server_domain"
        ]
      },
      {
        "name": "Rare AWS Error Code",
        "description": "A machine learning job detected an unusual error in a CloudTrail message. These can be byproducts of attempted or successful persistence, privilege escalation, defense evasion, discovery, lateral movement, or collection.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Rare AWS Error Code\n\nCloudTrail logging provides visibility on actions taken within an AWS environment. By monitoring these events and understanding what is considered normal behavior within an organization, you can spot suspicious or malicious activity when deviations occur.\n\nThis rule uses a machine learning job to detect an unusual error in a CloudTrail message. This can be byproducts of attempted or successful persistence, privilege escalation, defense evasion, discovery, lateral movement, or collection.\n\nDetection alerts from this rule indicate a rare and unusual error code that was associated with the response to an AWS API command or method call.\n\n#### Possible investigation steps\n\n- Examine the history of the error. If the error only manifested recently, it might be related to recent changes in an automation module or script. You can find the error in the `aws.cloudtrail.error_code field` field.\n- Investigate other alerts associated with the user account during the past 48 hours.\n- Validate the activity is not related to planned patches, updates, or network administrator activity.\n- Examine the request parameters. These may indicate the source of the program or the nature of the task being performed when the error occurred.\n    - Check whether the error is related to unsuccessful attempts to enumerate or access objects, data, or secrets.\n- Considering the source IP address and geolocation of the user who issued the command:\n    - Do they look normal for the calling user?\n    - If the source is an EC2 IP address, is it associated with an EC2 instance in one of your accounts or is the source IP from an EC2 instance that's not under your control?\n    - If it is an authorized EC2 instance, is the activity associated with normal behavior for the instance role or roles? Are there any other alerts or signs of suspicious activity involving this instance?\n- Consider the time of day. If the user is a human (not a program or script), did the activity take place during a normal time of day?\n- Contact the account owner and confirm whether they are aware of this activity if suspicious.\n- If you suspect the account has been compromised, scope potentially compromised assets by tracking servers, services, and data accessed by the account in the last 24 hours.\n\n### False positive analysis\n\n- Examine the history of the command. If the command only manifested recently, it might be part of a new automation module or script. If it has a consistent cadence (for example, it appears in small numbers on a weekly or monthly cadence), it might be part of a housekeeping or maintenance process. You can find the command in the `event.action field` field.\n- The adoption of new services or the addition of new functionality to scripts may generate false positives.\n\n### Related Rules\n\n- Unusual City For an AWS Command - 809b70d3-e2c3-455e-af1b-2626a5a1a276\n- Unusual Country For an AWS Command - dca28dee-c999-400f-b640-50a081cc0fd1\n- Unusual AWS Command for a User - ac706eae-d5ec-4b14-b4fd-e8ba8086f0e1\n- Spike in AWS Error Messages - 78d3d8d9-b476-451d-a9e0-7a5addd70670\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Disable or limit the account during the investigation and response.\n- Identify the possible impact of the incident and prioritize accordingly; the following actions can help you gain context:\n    - Identify the account role in the cloud environment.\n    - Assess the criticality of affected services and servers.\n    - Work with your IT team to identify and minimize the impact on users.\n    - Identify if the attacker is moving laterally and compromising other accounts, servers, or services.\n    - Identify any regulatory or legal ramifications related to this activity.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords or delete API keys as needed to revoke the attacker's access to the environment. Work with your IT teams to minimize the impact on business operations during these actions.\n- Check if unauthorized new users were created, remove unauthorized new accounts, and request password resets for other IAM users.\n- Consider enabling multi-factor authentication for users.\n- Review the permissions assigned to the implicated user to ensure that the least privilege principle is being followed.\n- Implement security best practices [outlined](https://aws.amazon.com/premiumsupport/knowledge-center/security-best-practices/) by AWS.\n- Take the actions needed to return affected systems, data, or services to their normal operational levels.\n- Identify the initial vector abused by the attacker and take action to prevent reinfection via the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 209,
        "tags": [
          "Domain: Cloud",
          "Data Source: AWS",
          "Data Source: Amazon Web Services",
          "Rule Type: ML",
          "Rule Type: Machine Learning",
          "Resources: Investigation Guide"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "15m",
        "from": "now-7200s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Rare and unusual errors may indicate an impending service failure state. Rare and unusual user error activity can also be due to manual troubleshooting or reconfiguration attempts by insufficiently privileged users, bugs in cloud automation scripts or workflows, or changes to IAM privileges."
        ],
        "references": [
          "https://www.elastic.co/guide/en/security/current/prebuilt-ml-jobs.html"
        ],
        "max_signals": 100,
        "threat": [],
        "setup": "## Setup\n\nThis rule requires the installation of associated Machine Learning jobs, as well as data coming in from AWS.\n\n### Anomaly Detection Setup\n\nOnce the rule is enabled, the associated Machine Learning job will start automatically. You can view the Machine Learning job linked under the \"Definition\" panel of the detection rule. If the job does not start due to an error, the issue must be resolved for the job to commence successfully. For more details on setting up anomaly detection jobs, refer to the [helper guide](https://www.elastic.co/guide/en/kibana/current/xpack-ml-anomalies.html).\n\n### AWS Integration Setup\nThe AWS integration allows you to collect logs and metrics from Amazon Web Services (AWS) with Elastic Agent.\n\n#### The following steps should be executed in order to add the Elastic Agent System integration \"aws\" to your system:\n- Go to the Kibana home page and click â€œAdd integrationsâ€.\n- In the query bar, search for â€œAWSâ€ and select the integration to see more details about it.\n- Click â€œAdd AWSâ€.\n- Configure the integration name and optionally add a description.\n- Review optional and advanced settings accordingly.\n- Add the newly installed â€œawsâ€ to an existing or a new agent policy, and deploy the agent on your system from which aws log files are desirable.\n- Click â€œSave and Continueâ€.\n- For more details on the integration refer to the [helper guide](https://www.elastic.co/docs/current/integrations/aws).\n",
        "related_integrations": [
          {
            "package": "aws",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [],
        "id": "141f4482-3118-4c1a-9c51-2240daee0be8",
        "rule_id": "19de8096-e2b0-4bd8-80c9-34a820813fff",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:30.965Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:08.059Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "machine_learning",
        "anomaly_threshold": 50,
        "machine_learning_job_id": [
          "rare_error_code"
        ]
      },
      {
        "name": "Execution of COM object via Xwizard",
        "description": "Windows Component Object Model (COM) is an inter-process communication (IPC) component of the native Windows application programming interface (API) that enables interaction between software objects or executable code. Xwizard can be used to run a COM object created in registry to evade defensive counter measures.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 312,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://lolbas-project.github.io/lolbas/Binaries/Xwizard/",
          "http://www.hexacorn.com/blog/2017/07/31/the-wizard-of-x-oppa-plugx-style/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1559",
                "name": "Inter-Process Communication",
                "reference": "https://attack.mitre.org/techniques/T1559/",
                "subtechnique": [
                  {
                    "id": "T1559.001",
                    "name": "Component Object Model",
                    "reference": "https://attack.mitre.org/techniques/T1559/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "4a9f2d65-9989-4199-abe7-e92beb4d7113",
        "rule_id": "1a6075b0-7479-450e-8fe7-b8b8438ac570",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:30.967Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:08.069Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n (process.name : \"xwizard.exe\" or ?process.pe.original_file_name : \"xwizard.exe\") and\n (\n   (process.args : \"RunWizard\" and process.args : \"{*}\") or\n   (process.executable != null and\n     not process.executable : (\n        \"C:\\\\Windows\\\\SysWOW64\\\\xwizard.exe\",\n        \"C:\\\\Windows\\\\System32\\\\xwizard.exe\",\n        \"\\\\Device\\\\HarddiskVolume?\\\\Windows\\\\SysWOW64\\\\xwizard.exe\",\n        \"\\\\Device\\\\HarddiskVolume?\\\\Windows\\\\System32\\\\xwizard.exe\"\n     )\n   )\n )",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "AWS CloudTrail Log Suspended",
        "description": "Identifies suspending the recording of AWS API calls and log file delivery for the specified trail. An adversary may suspend trails in an attempt to evade defenses.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating AWS CloudTrail Log Suspended\n\nAmazon CloudTrail is a service that enables governance, compliance, operational auditing, and risk auditing of your Amazon Web Services account. With CloudTrail, you can log, continuously monitor, and retain account activity related to actions across your Amazon Web Services infrastructure. CloudTrail provides event history of your Amazon Web Services account activity, including actions taken through the Amazon Management Console, Amazon SDKs, command line tools, and other Amazon Web Services services. This event history simplifies security analysis, resource change tracking, and troubleshooting.\n\nThis rule identifies the suspension of an AWS log trail using the API `StopLogging` action. Attackers can do this to cover their tracks and impact security monitoring that relies on this source.\n\n#### Possible investigation steps\n\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Investigate other alerts associated with the user account during the past 48 hours.\n- Contact the account and resource owners and confirm whether they are aware of this activity.\n- Check if this operation was approved and performed according to the organization's change management policy.\n- Considering the source IP address and geolocation of the user who issued the command:\n    - Do they look normal for the user?\n    - If the source is an EC2 IP address, is it associated with an EC2 instance in one of your accounts or is the source IP from an EC2 instance that's not under your control?\n    - If it is an authorized EC2 instance, is the activity associated with normal behavior for the instance role or roles? Are there any other alerts or signs of suspicious activity involving this instance?\n- Investigate the deleted log trail's criticality and whether the responsible team is aware of the deletion.\n- If you suspect the account has been compromised, scope potentially compromised assets by tracking servers, services, and data accessed by the account in the last 24 hours.\n\n### False positive analysis\n\n- If this rule is noisy in your environment due to expected activity, consider adding exceptions â€” preferably with a combination of user and IP address conditions.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Disable or limit the account during the investigation and response.\n- Identify the possible impact of the incident and prioritize accordingly; the following actions can help you gain context:\n    - Identify the account role in the cloud environment.\n    - Assess the criticality of affected services and servers.\n    - Work with your IT team to identify and minimize the impact on users.\n    - Identify if the attacker is moving laterally and compromising other accounts, servers, or services.\n    - Identify any regulatory or legal ramifications related to this activity.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords or delete API keys as needed to revoke the attacker's access to the environment. Work with your IT teams to minimize the impact on business operations during these actions.\n- Check if unauthorized new users were created, remove unauthorized new accounts, and request password resets for other IAM users.\n- Consider enabling multi-factor authentication for users.\n- Review the permissions assigned to the implicated user to ensure that the least privilege principle is being followed.\n- Implement security best practices [outlined](https://aws.amazon.com/premiumsupport/knowledge-center/security-best-practices/) by AWS.\n- Take the actions needed to return affected systems, data, or services to their normal operational levels.\n- Identify the initial vector abused by the attacker and take action to prevent reinfection via the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).",
        "output_index": "",
        "version": 209,
        "tags": [
          "Domain: Cloud",
          "Data Source: AWS",
          "Data Source: Amazon Web Services",
          "Use Case: Log Auditing",
          "Resources: Investigation Guide",
          "Tactic: Defense Evasion"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-3600s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Suspending the recording of a trail may be done by a system or network administrator. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. Trail suspensions from unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule."
        ],
        "references": [
          "https://docs.aws.amazon.com/awscloudtrail/latest/APIReference/API_StopLogging.html",
          "https://awscli.amazonaws.com/v2/documentation/api/latest/reference/cloudtrail/stop-logging.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.001",
                    "name": "Disable or Modify Tools",
                    "reference": "https://attack.mitre.org/techniques/T1562/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The AWS Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "aws",
            "version": "^2.0.0",
            "integration": "cloudtrail"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "b1ba4119-b5da-468a-bec1-3b50275102ba",
        "rule_id": "1aa8fa52-44a7-4dae-b058-f3333b91c8d7",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:30.969Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:08.072Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-aws.cloudtrail-*"
        ],
        "filters": [],
        "query": "event.dataset:aws.cloudtrail and event.provider:cloudtrail.amazonaws.com and event.action:StopLogging and event.outcome:success",
        "language": "kuery"
      },
      {
        "name": "User Account Creation",
        "description": "Identifies attempts to create new users. This is sometimes done by attackers to increase access or establish persistence on a system or domain.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating User Account Creation\n\nAttackers may create new accounts (both local and domain) to maintain access to victim systems.\n\nThis rule identifies the usage of `net.exe` to create new accounts.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Identify if the account was added to privileged groups or assigned special privileges after creation.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n\n### False positive analysis\n\n- Account creation is a common administrative task, so there is a high chance of the activity being legitimate. Before investigating further, verify that this activity is not benign.\n\n### Related rules\n\n- Creation of a Hidden Local User Account - 2edc8076-291e-41e9-81e4-e3fcbc97ae5e\n- Windows User Account Creation - 38e17753-f581-4644-84da-0d60a8318694\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Delete the created account.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 311,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1136",
                "name": "Create Account",
                "reference": "https://attack.mitre.org/techniques/T1136/",
                "subtechnique": [
                  {
                    "id": "T1136.001",
                    "name": "Local Account",
                    "reference": "https://attack.mitre.org/techniques/T1136/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "c697b61f-a1cc-4905-90bb-f737a65ef037",
        "rule_id": "1aa9181a-492b-4c01-8b16-fa0735786b2b",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:30.971Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:08.075Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (process.name : (\"net.exe\", \"net1.exe\") and not process.parent.name : \"net.exe\") and\n  (process.args : \"user\" and process.args : (\"/ad\", \"/add\"))",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Connection to Internal Network via Telnet",
        "description": "Telnet provides a command line interface for communication with a remote device or server. This rule identifies Telnet network connections to non-publicly routable IP addresses.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 107,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Lateral Movement",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Telnet can be used for both benign or malicious purposes. Telnet is included by default in some Linux distributions, so its presence is not inherently suspicious. The use of Telnet to manage devices remotely has declined in recent years in favor of more secure protocols such as SSH. Telnet usage by non-automated tools or frameworks may be suspicious."
        ],
        "references": [
          "https://www.iana.org/assignments/iana-ipv4-special-registry/iana-ipv4-special-registry.xhtml"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1021",
                "name": "Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1021/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from one of the following integrations:\n- Elastic Defend\n- Auditbeat\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n### Auditbeat Setup\nAuditbeat is a lightweight shipper that you can install on your servers to audit the activities of users and processes on your systems. For example, you can use Auditbeat to collect and centralize audit events from the Linux Audit Framework. You can also use Auditbeat to detect changes to critical files, like binaries and configuration files, and identify potential security policy violations.\n\n#### The following steps should be executed in order to add the Auditbeat on a Linux System:\n- Elastic provides repositories available for APT and YUM-based distributions. Note that we provide binary packages, but no source packages.\n- To install the APT and YUM repositories follow the setup instructions in this [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/setup-repositories.html).\n- To run Auditbeat on Docker follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/running-on-docker.html).\n- To run Auditbeat on Kubernetes follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/running-on-kubernetes.html).\n- For complete â€œSetup and Run Auditbeatâ€ information refer to the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/setting-up-and-running.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "90cacab4-6e2a-4c42-81f6-afb0175f6d0f",
        "rule_id": "1b21abcc-4d9f-4b08-a7f5-316f5f94b973",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:30.972Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:08.078Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by process.entity_id\n  [process where host.os.type == \"linux\" and process.name == \"telnet\" and event.type == \"start\"]\n  [network where host.os.type == \"linux\" and process.name == \"telnet\" and cidrmatch(\n     destination.ip, \"10.0.0.0/8\", \"127.0.0.0/8\", \"169.254.0.0/16\", \"172.16.0.0/12\", \"192.0.0.0/24\", \"192.0.0.0/29\",\n     \"192.0.0.8/32\", \"192.0.0.9/32\", \"192.0.0.10/32\", \"192.0.0.170/32\", \"192.0.0.171/32\", \"192.0.2.0/24\",\n     \"192.31.196.0/24\", \"192.52.193.0/24\", \"192.168.0.0/16\", \"192.88.99.0/24\", \"224.0.0.0/4\", \"100.64.0.0/10\",\n     \"192.175.48.0/24\", \"198.18.0.0/15\", \"198.51.100.0/24\", \"203.0.113.0/24\", \"240.0.0.0/4\", \"::1\", \"FE80::/10\",\n     \"FF00::/8\"\n    )\n  ]",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "AWS ElastiCache Security Group Modified or Deleted",
        "description": "Identifies when an ElastiCache security group has been modified or deleted.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Cloud",
          "Data Source: AWS",
          "Data Source: Amazon Web Services",
          "Tactic: Defense Evasion"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-3600s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Austin Songer"
        ],
        "false_positives": [
          "A ElastiCache security group deletion may be done by a system or network administrator. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. Security Group deletions by unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule."
        ],
        "references": [
          "https://docs.aws.amazon.com/AmazonElastiCache/latest/APIReference/Welcome.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.007",
                    "name": "Disable or Modify Cloud Firewall",
                    "reference": "https://attack.mitre.org/techniques/T1562/007/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The AWS Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "aws",
            "version": "^2.0.0",
            "integration": "cloudtrail"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "6740580a-8436-4fdd-9e7b-fc46e5f1c701",
        "rule_id": "1ba5160d-f5a2-4624-b0ff-6a1dc55d2516",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:30.974Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:08.082Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-aws.cloudtrail-*"
        ],
        "filters": [],
        "query": "event.dataset:aws.cloudtrail and event.provider:elasticache.amazonaws.com and event.action:(\"Delete Cache Security Group\" or\n\"Authorize Cache Security Group Ingress\" or  \"Revoke Cache Security Group Ingress\" or \"AuthorizeCacheSecurityGroupEgress\" or\n\"RevokeCacheSecurityGroupEgress\") and event.outcome:success",
        "language": "kuery"
      },
      {
        "name": "Possible Consent Grant Attack via Azure-Registered Application",
        "description": "Detects when a user grants permissions to an Azure-registered application or when an administrator grants tenant-wide permissions to an application. An adversary may create an Azure-registered application that requests access to data such as contact information, email, or documents.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Possible Consent Grant Attack via Azure-Registered Application\n\nIn an illicit consent grant attack, the attacker creates an Azure-registered application that requests access to data such as contact information, email, or documents. The attacker then tricks an end user into granting that application consent to access their data either through a phishing attack, or by injecting illicit code into a trusted website. After the illicit application has been granted consent, it has account-level access to data without the need for an organizational account. Normal remediation steps like resetting passwords for breached accounts or requiring multi-factor authentication (MFA) on accounts are not effective against this type of attack, since these are third-party applications and are external to the organization.\n\nOfficial Microsoft guidance for detecting and remediating this attack can be found [here](https://docs.microsoft.com/en-us/microsoft-365/security/office-365-security/detect-and-remediate-illicit-consent-grants).\n\n#### Possible investigation steps\n\n- From the Azure AD portal, Review the application that was granted permissions:\n  - Click on the `Review permissions` button on the `Permissions` blade of the application.\n  - An app should require only permissions related to the app's purpose. If that's not the case, the app might be risky.\n  - Apps that require high privileges or admin consent are more likely to be risky.\n- Investigate the app and the publisher. The following characteristics can indicate suspicious apps:\n  -  A low number of downloads.\n  -  Low rating or score or bad comments.\n  -  Apps with a suspicious publisher or website.\n  -  Apps whose last update is not recent. This might indicate an app that is no longer supported.\n- Export and examine the [Oauth app auditing](https://docs.microsoft.com/en-us/defender-cloud-apps/manage-app-permissions#oauth-app-auditing) to identify users affected.\n\n### False positive analysis\n\n- This mechanism can be used legitimately. Malicious applications abuse the same workflow used by legitimate apps. Thus, analysts must review each app consent to ensure that only desired apps are granted access.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Identify the possible impact of the incident and prioritize accordingly; the following actions can help you gain context:\n    - Identify the account role in the cloud environment.\n    - Assess the criticality of affected services and servers.\n    - Work with your IT team to identify and minimize the impact on users.\n    - Identify if the attacker is moving laterally and compromising other accounts, servers, or services.\n    - Identify any regulatory or legal ramifications related to this activity.\n- Disable the malicious application to stop user access and the application access to your data.\n- Revoke the application Oauth consent grant. The `Remove-AzureADOAuth2PermissionGrant` cmdlet can be used to complete this task.\n- Remove the service principal application role assignment. The `Remove-AzureADServiceAppRoleAssignment` cmdlet can be used to complete this task.\n- Revoke the refresh token for all users assigned to the application. Azure provides a [playbook](https://github.com/Azure/Azure-Sentinel/tree/master/Playbooks/Revoke-AADSignInSessions) for this task.\n- [Report](https://docs.microsoft.com/en-us/defender-cloud-apps/manage-app-permissions#send-feedback) the application as malicious to Microsoft.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords or delete API keys as needed to revoke the attacker's access to the environment. Work with your IT teams to minimize the impact on business operations during these actions.\n- Investigate the potential for data compromise from the user's email and file sharing services. Activate your Data Loss incident response playbook.\n- Disable the permission for a user to set consent permission on their behalf.\n  - Enable the [Admin consent request](https://docs.microsoft.com/en-us/azure/active-directory/manage-apps/configure-admin-consent-workflow) feature.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).",
        "output_index": "",
        "version": 213,
        "tags": [
          "Domain: Cloud",
          "Data Source: Azure",
          "Data Source: Microsoft 365",
          "Use Case: Identity and Access Audit",
          "Resources: Investigation Guide",
          "Tactic: Initial Access"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-1500s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://docs.microsoft.com/en-us/microsoft-365/security/office-365-security/detect-and-remediate-illicit-consent-grants?view=o365-worldwide",
          "https://www.cloud-architekt.net/detection-and-mitigation-consent-grant-attacks-azuread/",
          "https://docs.microsoft.com/en-us/defender-cloud-apps/investigate-risky-oauth#how-to-detect-risky-oauth-apps"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1566",
                "name": "Phishing",
                "reference": "https://attack.mitre.org/techniques/T1566/",
                "subtechnique": [
                  {
                    "id": "T1566.002",
                    "name": "Spearphishing Link",
                    "reference": "https://attack.mitre.org/techniques/T1566/002/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1528",
                "name": "Steal Application Access Token",
                "reference": "https://attack.mitre.org/techniques/T1528/"
              }
            ]
          }
        ],
        "setup": "The Azure Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "azure",
            "version": "^1.0.0",
            "integration": "activitylogs"
          },
          {
            "package": "azure",
            "version": "^1.0.0"
          },
          {
            "package": "o365",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "azure.activitylogs.operation_name",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "azure.auditlogs.operation_name",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "4bf344da-0fa2-4aae-bab1-9b862610793f",
        "rule_id": "1c6a8c7a-5cb6-4a82-ba27-d5a5b8a40a38",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:30.976Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:08.085Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-azure*",
          "logs-o365*"
        ],
        "filters": [],
        "query": "event.dataset:(azure.activitylogs or azure.auditlogs or o365.audit) and\n  (\n    azure.activitylogs.operation_name:\"Consent to application\" or\n    azure.auditlogs.operation_name:\"Consent to application\" or \n    event.action:\"Consent to application.\"\n  ) and\n  event.outcome:(Success or success)",
        "language": "kuery"
      },
      {
        "name": "Remote File Download via Script Interpreter",
        "description": "Identifies built-in Windows script interpreters (cscript.exe or wscript.exe) being used to download an executable file from a remote destination.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Remote File Download via Script Interpreter\n\nThe Windows Script Host (WSH) is a Windows automation technology, which is ideal for non-interactive scripting needs, such as logon scripting, administrative scripting, and machine automation.\n\nAttackers commonly use WSH scripts as their initial access method, acting like droppers for second stage payloads, but can also use them to download tools and utilities needed to accomplish their goals.\n\nThis rule looks for DLLs and executables downloaded using `cscript.exe` or `wscript.exe`.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze both the script and the executable involved using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n### False positive analysis\n\n- The usage of these script engines by regular users is unlikely. In the case of authorized benign true positives (B-TPs), exceptions can be added.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 210,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Command and Control",
          "Tactic: Execution",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            },
            "technique": [
              {
                "id": "T1105",
                "name": "Ingress Tool Transfer",
                "reference": "https://attack.mitre.org/techniques/T1105/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.005",
                    "name": "Visual Basic",
                    "reference": "https://attack.mitre.org/techniques/T1059/005/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "network.direction",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "network.protocol",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "network.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "307eb302-c1f5-4a0a-a986-0ad2ed1478aa",
        "rule_id": "1d276579-3380-4095-ad38-e596a01bc64f",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:30.986Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:04.275Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by host.id, process.entity_id\n  [network where host.os.type == \"windows\" and process.name : (\"wscript.exe\", \"cscript.exe\") and network.protocol != \"dns\" and\n   network.direction : (\"outgoing\", \"egress\") and network.type == \"ipv4\" and destination.ip != \"127.0.0.1\"\n  ]\n  [file where host.os.type == \"windows\" and event.type == \"creation\" and file.extension : (\"exe\", \"dll\")]",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.network-*",
          "logs-endpoint.events.file-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "External IP Lookup from Non-Browser Process",
        "description": "Identifies domains commonly used by adversaries for post-exploitation IP lookups. It is common for adversaries to test for Internet access and acquire their external IP address after they have gained access to a system. Among others, this has been observed in campaigns leveraging the information stealer, Trickbot.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating External IP Lookup from Non-Browser Process\n\nAfter successfully compromising an environment, attackers may try to gain situational awareness to plan their next steps. This can happen by running commands to enumerate network resources, users, connections, files, and installed security software.\n\nThis rule looks for connections to known IP lookup services through non-browser processes or non-installed programs. Using only the IP address of the compromised system, attackers can obtain valuable information such as the system's geographic location, the company that owns the IP, whether the system is cloud-hosted, and more.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate abnormal behaviors observed by the subject process, such as network connections, registry or file modifications, and any spawned child processes.\n\n### False positive analysis\n\n- Discovery activities are not inherently malicious if they occur in isolation. As long as the analyst did not identify suspicious activity related to the user or host, such alerts can be dismissed.\n- If this rule is noisy in your environment due to expected activity, consider adding exceptions â€” preferably with a combination of user and command line conditions.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Use the data collected through the analysis to investigate other machines affected in the environment.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection via the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "building_block_type": "default",
        "output_index": "",
        "version": 108,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend",
          "Rule Type: BBR"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "If the domains listed in this rule are used as part of an authorized workflow, this rule will be triggered by those events. Validate that this is expected activity and tune the rule to fit your environment variables."
        ],
        "references": [
          "https://community.jisc.ac.uk/blogs/csirt/article/trickbot-analysis-and-mitigation",
          "https://www.cybereason.com/blog/dropping-anchor-from-a-trickbot-infection-to-the-discovery-of-the-anchor-malware"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1016",
                "name": "System Network Configuration Discovery",
                "reference": "https://attack.mitre.org/techniques/T1016/",
                "subtechnique": [
                  {
                    "id": "T1016.001",
                    "name": "Internet Connection Discovery",
                    "reference": "https://attack.mitre.org/techniques/T1016/001/"
                  }
                ]
              },
              {
                "id": "T1614",
                "name": "System Location Discovery",
                "reference": "https://attack.mitre.org/techniques/T1614/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "dns.question.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "network.protocol",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.code_signature.subject_name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.code_signature.trusted",
            "type": "boolean",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "bc0d6430-a1f0-4647-b950-9ef00de58e13",
        "rule_id": "1d72d014-e2ab-4707-b056-9b96abe7b511",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:30.988Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:08.101Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "network where host.os.type == \"windows\" and network.protocol == \"dns\" and\n    process.name != null and user.id not in (\"S-1-5-19\", \"S-1-5-20\") and\n    event.action == \"lookup_requested\" and\n    /* Add new external IP lookup services here */\n    dns.question.name :\n    (\n        \"*api.ipify.org\",\n        \"*freegeoip.app\",\n        \"*checkip.amazonaws.com\",\n        \"*checkip.dyndns.org\",\n        \"*freegeoip.app\",\n        \"*icanhazip.com\",\n        \"*ifconfig.*\",\n        \"*ipecho.net\",\n        \"*ipgeoapi.com\",\n        \"*ipinfo.io\",\n        \"*ip.anysrc.net\",\n        \"*myexternalip.com\",\n        \"*myipaddress.com\",\n        \"*showipaddress.com\",\n        \"*whatismyipaddress.com\",\n        \"*wtfismyip.com\",\n        \"*ipapi.co\",\n        \"*ip-lookup.net\",\n        \"*ipstack.com\"\n    ) and\n    /* Insert noisy false positives here */\n    not\n    (\n      (\n        process.executable : (\n            \"?:\\\\Program Files\\\\*.exe\",\n            \"?:\\\\Program Files (x86)\\\\*.exe\",\n            \"?:\\\\Windows\\\\Prey\\\\versions\\\\*\\\\bin\\\\node.exe\",\n            \"?:\\\\Windows\\\\System32\\\\WWAHost.exe\",\n            \"?:\\\\Windows\\\\System32\\\\smartscreen.exe\",\n            \"?:\\\\Windows\\\\System32\\\\MicrosoftEdgeCP.exe\",\n            \"?:\\\\ProgramData\\\\Microsoft\\\\Windows Defender\\\\Platform\\\\*\\\\MsMpEng.exe\",\n            \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Google\\\\Chrome\\\\Application\\\\chrome.exe\",\n            \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Programs\\\\Fiddler\\\\Fiddler.exe\",\n            \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Programs\\\\Microsoft VS Code\\\\Code.exe\",\n            \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Microsoft\\\\OneDrive\\\\OneDrive.exe\"\n        ) and process.code_signature.trusted == true\n      ) or\n      (\n        (process.name : \"Evernote.exe\" and process.code_signature.subject_name : \"Evernote Corporation\" and process.code_signature.trusted == true) or\n        (process.name : \"firefox.exe\" and process.code_signature.subject_name : \"Mozilla Corporation\" and process.code_signature.trusted == true) or\n        (process.name : \"Loom.exe\" and process.code_signature.subject_name : \"Loom, Inc.\" and process.code_signature.trusted == true) or\n        (process.name : \"opera.exe\" and process.code_signature.subject_name : \"Opera Norway AS\" and process.code_signature.trusted == true) or\n        (process.name : \"brave.exe\" and process.code_signature.subject_name : \"Brave Software, Inc.\" and process.code_signature.trusted == true) or\n        (process.name : \"vivaldi.exe\" and process.code_signature.subject_name : \"Vivaldi Technologies AS\" and process.code_signature.trusted == true)\n      )\n    )",
        "language": "eql",
        "index": [
          "logs-endpoint.events.network-*"
        ],
        "filters": []
      },
      {
        "name": "UAC Bypass via DiskCleanup Scheduled Task Hijack",
        "description": "Identifies User Account Control (UAC) bypass via hijacking DiskCleanup Scheduled Task. Attackers bypass UAC to stealthily execute code with elevated permissions.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 311,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Tactic: Defense Evasion",
          "Tactic: Execution",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1548",
                "name": "Abuse Elevation Control Mechanism",
                "reference": "https://attack.mitre.org/techniques/T1548/",
                "subtechnique": [
                  {
                    "id": "T1548.002",
                    "name": "Bypass User Account Control",
                    "reference": "https://attack.mitre.org/techniques/T1548/002/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1548",
                "name": "Abuse Elevation Control Mechanism",
                "reference": "https://attack.mitre.org/techniques/T1548/",
                "subtechnique": [
                  {
                    "id": "T1548.002",
                    "name": "Bypass User Account Control",
                    "reference": "https://attack.mitre.org/techniques/T1548/002/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1053",
                "name": "Scheduled Task/Job",
                "reference": "https://attack.mitre.org/techniques/T1053/",
                "subtechnique": [
                  {
                    "id": "T1053.005",
                    "name": "Scheduled Task",
                    "reference": "https://attack.mitre.org/techniques/T1053/005/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "f056d3a7-d3c4-45db-935f-d9f89652f76a",
        "rule_id": "1dcc51f6-ba26-49e7-9ef4-2655abb2361e",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:30.990Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:08.104Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n process.args : \"/autoclean\" and process.args : \"/d\" and process.executable != null and \n not process.executable : (\n        \"C:\\\\Windows\\\\System32\\\\cleanmgr.exe\",\n        \"C:\\\\Windows\\\\SysWOW64\\\\cleanmgr.exe\",\n        \"C:\\\\Windows\\\\System32\\\\taskhostw.exe\",\n        \"\\\\Device\\\\HarddiskVolume?\\\\Windows\\\\System32\\\\cleanmgr.exe\",\n        \"\\\\Device\\\\HarddiskVolume?\\\\Windows\\\\SysWOW64\\\\cleanmgr.exe\",\n        \"\\\\Device\\\\HarddiskVolume?\\\\Windows\\\\System32\\\\taskhostw.exe\"\n)",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious Inter-Process Communication via Outlook",
        "description": "Detects Inter-Process Communication with Outlook via Component Object Model from an unusual process. Adversaries may target user email to collect sensitive information or send email on their behalf via API.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 7,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Collection",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/center-for-threat-informed-defense/adversary_emulation_library/blob/master/apt29/Archive/CALDERA_DIY/evals/payloads/stepSeventeen_email.ps1"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0009",
              "name": "Collection",
              "reference": "https://attack.mitre.org/tactics/TA0009/"
            },
            "technique": [
              {
                "id": "T1114",
                "name": "Email Collection",
                "reference": "https://attack.mitre.org/techniques/T1114/",
                "subtechnique": [
                  {
                    "id": "T1114.001",
                    "name": "Local Email Collection",
                    "reference": "https://attack.mitre.org/techniques/T1114/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1559",
                "name": "Inter-Process Communication",
                "reference": "https://attack.mitre.org/techniques/T1559/",
                "subtechnique": [
                  {
                    "id": "T1559.001",
                    "name": "Component Object Model",
                    "reference": "https://attack.mitre.org/techniques/T1559/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.Ext.effective_parent.entity_id",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "process.Ext.effective_parent.name",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "process.Ext.relative_file_creation_time",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "process.Ext.relative_file_name_modify_time",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "process.code_signature.exists",
            "type": "boolean",
            "ecs": true
          },
          {
            "name": "process.code_signature.trusted",
            "type": "boolean",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "20651c27-b685-4b11-a66d-fd62c20da25e",
        "rule_id": "1dee0500-4aeb-44ca-b24b-4a285d7b6ba1",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:30.992Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:08.107Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence with maxspan=1m\n[process where host.os.type == \"windows\" and event.action == \"start\" and\n  (\n    process.name : (\n      \"rundll32.exe\", \"mshta.exe\", \"powershell.exe\", \"pwsh.exe\",\n      \"cmd.exe\", \"regsvr32.exe\", \"cscript.exe\", \"wscript.exe\"\n    ) or\n    (\n      (process.code_signature.trusted == false or process.code_signature.exists == false) and \n      (process.Ext.relative_file_creation_time <= 500 or process.Ext.relative_file_name_modify_time <= 500)\n    )\n  )\n] by process.entity_id\n[process where host.os.type == \"windows\" and event.action == \"start\" and process.name : \"OUTLOOK.EXE\" and\n  process.Ext.effective_parent.name != null] by process.Ext.effective_parent.entity_id",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process*"
        ],
        "filters": []
      },
      {
        "name": "Execution of File Written or Modified by PDF Reader",
        "description": "Identifies a suspicious file that was written by a PDF reader application and subsequently executed. These processes are often launched via exploitation of PDF applications.",
        "risk_score": 73,
        "severity": "high",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Execution of File Written or Modified by PDF Reader\n\nPDF is a common file type used in corporate environments and most machines have software to handle these files. This creates a vector where attackers can exploit the engines and technology behind this class of software for initial access or privilege escalation.\n\nThis rule searches for executable files written by PDF reader software and executed in sequence. This is most likely the result of exploitation for privilege escalation or initial access. This rule can also detect suspicious processes masquerading as PDF readers.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Retrieve the PDF documents received and opened by the user that could cause this behavior. Common locations include, but are not limited to, the Downloads and Document folders and the folder configured at the email client.\n- Determine if the collected files are malicious:\n  - Use a private sandboxed malware analysis system to perform analysis.\n    - Observe and collect information about the following activities:\n      - Attempts to contact external domains and addresses.\n      - File and registry access, modification, and creation activities.\n      - Service creation and launch activities.\n      - Scheduled task creation.\n  - Use the PowerShell `Get-FileHash` cmdlet to get the files' SHA-256 hash values.\n    - Search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n  - If the malicious file was delivered via phishing:\n    - Block the email sender from sending future emails.\n    - Block the malicious web pages.\n    - Remove emails from the sender from mailboxes.\n    - Consider improvements to the security awareness program.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 208,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7200s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            }
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1566",
                "name": "Phishing",
                "reference": "https://attack.mitre.org/techniques/T1566/",
                "subtechnique": [
                  {
                    "id": "T1566.001",
                    "name": "Spearphishing Attachment",
                    "reference": "https://attack.mitre.org/techniques/T1566/001/"
                  },
                  {
                    "id": "T1566.002",
                    "name": "Spearphishing Link",
                    "reference": "https://attack.mitre.org/techniques/T1566/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "dc7e7d89-25c0-4637-a4d3-4116bed785b4",
        "rule_id": "1defdd62-cd8d-426e-a246-81a37751bb2b",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:30.994Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:08.111Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence with maxspan=2h\n  [file where host.os.type == \"windows\" and event.type != \"deletion\" and file.extension : \"exe\" and\n     (process.name : \"AcroRd32.exe\" or\n      process.name : \"rdrcef.exe\" or\n      process.name : \"FoxitPhantomPDF.exe\" or\n      process.name : \"FoxitReader.exe\") and\n     not (file.name : \"FoxitPhantomPDF.exe\" or\n          file.name : \"FoxitPhantomPDFUpdater.exe\" or\n          file.name : \"FoxitReader.exe\" or\n          file.name : \"FoxitReaderUpdater.exe\" or\n          file.name : \"AcroRd32.exe\" or\n          file.name : \"rdrcef.exe\")\n  ] by host.id, file.path\n  [process where host.os.type == \"windows\" and event.type == \"start\"] by host.id, process.executable",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "logs-endpoint.events.file-*",
          "winlogbeat-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "Unusual Sudo Activity",
        "description": "Looks for sudo activity from an unusual user context. An unusual sudo user could be due to troubleshooting activity or it could be a sign of credentialed access via compromised accounts.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 104,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Rule Type: ML",
          "Rule Type: Machine Learning",
          "Tactic: Privilege Escalation"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "15m",
        "from": "now-2700s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Uncommon sudo activity can be due to an engineer logging onto a server instance in order to perform manual troubleshooting or reconfiguration."
        ],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1548",
                "name": "Abuse Elevation Control Mechanism",
                "reference": "https://attack.mitre.org/techniques/T1548/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1548",
                "name": "Abuse Elevation Control Mechanism",
                "reference": "https://attack.mitre.org/techniques/T1548/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires the installation of associated Machine Learning jobs, as well as data coming in from one of the following integrations:\n- Elastic Defend\n- Auditd Manager\n\n### Anomaly Detection Setup\n\nOnce the rule is enabled, the associated Machine Learning job will start automatically. You can view the Machine Learning job linked under the \"Definition\" panel of the detection rule. If the job does not start due to an error, the issue must be resolved for the job to commence successfully. For more details on setting up anomaly detection jobs, refer to the [helper guide](https://www.elastic.co/guide/en/kibana/current/xpack-ml-anomalies.html).\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration to your system:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n### Auditd Manager Integration Setup\nThe Auditd Manager Integration receives audit events from the Linux Audit Framework which is a part of the Linux kernel.\nAuditd Manager provides a user-friendly interface and automation capabilities for configuring and monitoring system auditing through the auditd daemon. With `auditd_manager`, administrators can easily define audit rules, track system events, and generate comprehensive audit reports, improving overall security and compliance in the system.\n\n#### The following steps should be executed in order to add the Elastic Agent System integration \"auditd_manager\" to your system:\n- Go to the Kibana home page and click â€œAdd integrationsâ€.\n- In the query bar, search for â€œAuditd Managerâ€ and select the integration to see more details about it.\n- Click â€œAdd Auditd Managerâ€.\n- Configure the integration name and optionally add a description.\n- Review optional and advanced settings accordingly.\n- Add the newly installed â€œauditd managerâ€ to an existing or a new agent policy, and deploy the agent on a Linux system from which auditd log files are desirable.\n- Click â€œSave and Continueâ€.\n- For more details on the integration refer to the [helper guide](https://docs.elastic.co/integrations/auditd_manager).\n\n#### Rule Specific Setup Note\nAuditd Manager subscribes to the kernel and receives events as they occur without any additional configuration.\nHowever, if more advanced configuration is required to detect specific behavior, audit rules can be added to the integration in either the \"audit rules\" configuration box or the \"auditd rule files\" box by specifying a file to read the audit rules from.\n- For this detection rule no additional audit rules are required.\n",
        "related_integrations": [
          {
            "package": "auditd_manager",
            "version": "^1.0.0"
          },
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [],
        "id": "d5ef0fc0-fa4a-4ff1-bf2c-80dc05bf1ecc",
        "rule_id": "1e9fc667-9ff1-4b33-9f40-fefca8537eb0",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:30.996Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:08.117Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "machine_learning",
        "anomaly_threshold": 75,
        "machine_learning_job_id": [
          "v3_linux_rare_sudo_user"
        ]
      },
      {
        "name": "Unusual Linux User Calling the Metadata Service",
        "description": "Looks for anomalous access to the cloud platform metadata service by an unusual user. The metadata service may be targeted in order to harvest credentials or user data scripts containing secrets.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 104,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Rule Type: ML",
          "Rule Type: Machine Learning",
          "Tactic: Credential Access"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "15m",
        "from": "now-2700s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "A newly installed program, or one that runs under a new or rarely used user context, could trigger this detection rule. Manual interrogation of the metadata service during debugging or troubleshooting could trigger this rule."
        ],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1552",
                "name": "Unsecured Credentials",
                "reference": "https://attack.mitre.org/techniques/T1552/",
                "subtechnique": [
                  {
                    "id": "T1552.005",
                    "name": "Cloud Instance Metadata API",
                    "reference": "https://attack.mitre.org/techniques/T1552/005/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires the installation of associated Machine Learning jobs, as well as data coming in from one of the following integrations:\n- Elastic Defend\n- Auditd Manager\n\n### Anomaly Detection Setup\n\nOnce the rule is enabled, the associated Machine Learning job will start automatically. You can view the Machine Learning job linked under the \"Definition\" panel of the detection rule. If the job does not start due to an error, the issue must be resolved for the job to commence successfully. For more details on setting up anomaly detection jobs, refer to the [helper guide](https://www.elastic.co/guide/en/kibana/current/xpack-ml-anomalies.html).\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration to your system:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n### Auditd Manager Integration Setup\nThe Auditd Manager Integration receives audit events from the Linux Audit Framework which is a part of the Linux kernel.\nAuditd Manager provides a user-friendly interface and automation capabilities for configuring and monitoring system auditing through the auditd daemon. With `auditd_manager`, administrators can easily define audit rules, track system events, and generate comprehensive audit reports, improving overall security and compliance in the system.\n\n#### The following steps should be executed in order to add the Elastic Agent System integration \"auditd_manager\" to your system:\n- Go to the Kibana home page and click â€œAdd integrationsâ€.\n- In the query bar, search for â€œAuditd Managerâ€ and select the integration to see more details about it.\n- Click â€œAdd Auditd Managerâ€.\n- Configure the integration name and optionally add a description.\n- Review optional and advanced settings accordingly.\n- Add the newly installed â€œauditd managerâ€ to an existing or a new agent policy, and deploy the agent on a Linux system from which auditd log files are desirable.\n- Click â€œSave and Continueâ€.\n- For more details on the integration refer to the [helper guide](https://docs.elastic.co/integrations/auditd_manager).\n\n#### Rule Specific Setup Note\nAuditd Manager subscribes to the kernel and receives events as they occur without any additional configuration.\nHowever, if more advanced configuration is required to detect specific behavior, audit rules can be added to the integration in either the \"audit rules\" configuration box or the \"auditd rule files\" box by specifying a file to read the audit rules from.\n- For this detection rule no additional audit rules are required.\n",
        "related_integrations": [
          {
            "package": "auditd_manager",
            "version": "^1.0.0"
          },
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [],
        "id": "dfb00235-91c1-4aed-899a-76ae80b8f9e0",
        "rule_id": "1faec04b-d902-4f89-8aff-92cd9043c16f",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:30.998Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:08.120Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "machine_learning",
        "anomaly_threshold": 75,
        "machine_learning_job_id": [
          "v3_linux_rare_metadata_user"
        ]
      },
      {
        "name": "Unusual Network Activity from a Windows System Binary",
        "description": "Identifies network activity from unexpected system applications. This may indicate adversarial activity as these applications are often leveraged by adversaries to execute code and evade detection.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Unusual Network Activity from a Windows System Binary\n\nAttackers can abuse certain trusted developer utilities to proxy the execution of malicious payloads. Since these utilities are usually signed, they can bypass the security controls that were put in place to prevent or detect direct execution.\n\nThis rule identifies network connections established by trusted developer utilities, which can indicate abuse to execute payloads or process masquerading.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate abnormal behaviors observed by the subject process, such as registry or file modifications, and any spawned child processes.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the process executable using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n\n### False positive analysis\n\n- As trusted developer utilities have dual-use purposes, alerts derived from this rule are not essentially malicious. If these utilities are contacting internal or known trusted domains, review their security and consider creating exceptions if the domain is safe.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n  - If the malicious file was delivered via phishing:\n    - Block the email sender from sending future emails.\n    - Block the malicious web pages.\n    - Remove emails from the sender from mailboxes.\n    - Consider improvements to the security awareness program.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 213,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1036",
                "name": "Masquerading",
                "reference": "https://attack.mitre.org/techniques/T1036/",
                "subtechnique": [
                  {
                    "id": "T1036.005",
                    "name": "Match Legitimate Name or Location",
                    "reference": "https://attack.mitre.org/techniques/T1036/005/"
                  }
                ]
              },
              {
                "id": "T1127",
                "name": "Trusted Developer Utilities Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1127/",
                "subtechnique": [
                  {
                    "id": "T1127.001",
                    "name": "MSBuild",
                    "reference": "https://attack.mitre.org/techniques/T1127/001/"
                  },
                  {
                    "id": "T1218.005",
                    "name": "Mshta",
                    "reference": "https://attack.mitre.org/techniques/T1218/005/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "dns.question.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "f6448003-c91f-4bf4-a6f0-86473f350eff",
        "rule_id": "1fe3b299-fbb5-4657-a937-1d746f2c711a",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:30.999Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:04.271Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by process.entity_id with maxspan=5m\n  [process where host.os.type == \"windows\" and event.type == \"start\" and\n\n     /* known applocker bypasses */\n     (process.name : \"bginfo.exe\" or\n      process.name : \"cdb.exe\" or\n      process.name : \"control.exe\" or\n      process.name : \"cmstp.exe\" or\n      process.name : \"csi.exe\" or\n      process.name : \"dnx.exe\" or\n      process.name : \"fsi.exe\" or\n      process.name : \"ieexec.exe\" or\n      process.name : \"iexpress.exe\" or\n      process.name : \"installutil.exe\" or\n      process.name : \"Microsoft.Workflow.Compiler.exe\" or\n      process.name : \"MSBuild.exe\" or\n      process.name : \"msdt.exe\" or\n      process.name : \"mshta.exe\" or\n      process.name : \"msiexec.exe\" or\n      process.name : \"msxsl.exe\" or\n      process.name : \"odbcconf.exe\" or\n      process.name : \"rcsi.exe\" or\n      process.name : \"regsvr32.exe\" or\n      process.name : \"xwizard.exe\")]\n  [network where\n     (process.name : \"bginfo.exe\" or\n      process.name : \"cdb.exe\" or\n      process.name : \"control.exe\" or\n      process.name : \"cmstp.exe\" or\n      process.name : \"csi.exe\" or\n      process.name : \"dnx.exe\" or\n      process.name : \"fsi.exe\" or\n      process.name : \"ieexec.exe\" or\n      process.name : \"iexpress.exe\" or\n      process.name : \"installutil.exe\" or\n      process.name : \"Microsoft.Workflow.Compiler.exe\" or\n      (\n        process.name : \"msbuild.exe\" and\n          destination.ip != \"127.0.0.1\"\n      ) or\n      process.name : \"msdt.exe\" or\n      process.name : \"mshta.exe\" or\n      (\n        process.name : \"msiexec.exe\" and not\n        dns.question.name : (\n           \"ocsp.digicert.com\", \"ocsp.verisign.com\", \"ocsp.comodoca.com\", \"ocsp.entrust.net\", \"ocsp.usertrust.com\",\n           \"ocsp.godaddy.com\", \"ocsp.camerfirma.com\", \"ocsp.globalsign.com\", \"ocsp.sectigo.com\", \"*.local\"\n        ) and\n        /* Localhost, DigiCert and Comodo CA IP addresses */\n        not cidrmatch(destination.ip, \"127.0.0.1\", \"192.229.211.108/32\", \"192.229.221.95/32\",\n                      \"152.195.38.76/32\", \"104.18.14.101/32\")\n      ) or\n      process.name : \"msxsl.exe\" or\n      process.name : \"odbcconf.exe\" or\n      process.name : \"rcsi.exe\" or\n      process.name : \"regsvr32.exe\" or\n      process.name : \"xwizard.exe\") and \n      \n      not dns.question.name : (\"localhost\", \"setup.officetimeline.com\", \"us.deployment.endpoint.ingress.rapid7.com\", \n        \"ctldl.windowsupdate.com\", \"crl?.digicert.com\", \"ocsp.digicert.com\", \"addon-cms-asl.eu.goskope.com\", \"crls.ssl.com\", \n        \"evcs-ocsp.ws.symantec.com\", \"s.symcd.com\", \"s?.symcb.com\", \"crl.verisign.com\", \"oneocsp.microsoft.com\", \"crl.verisign.com\", \n        \"aka.ms\", \"crl.comodoca.com\", \"acroipm2.adobe.com\", \"sv.symcd.com\") and \n\n      /* host query itself */\n      not startswith~(dns.question.name, host.name)\n      ]",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "logs-endpoint.events.network-*",
          "winlogbeat-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious .NET Code Compilation",
        "description": "Identifies executions of .NET compilers with suspicious parent processes, which can indicate an attacker's attempt to compile code after delivery in order to bypass security mechanisms.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 312,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Tactic: Execution",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1027",
                "name": "Obfuscated Files or Information",
                "reference": "https://attack.mitre.org/techniques/T1027/",
                "subtechnique": [
                  {
                    "id": "T1027.004",
                    "name": "Compile After Delivery",
                    "reference": "https://attack.mitre.org/techniques/T1027/004/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.005",
                    "name": "Visual Basic",
                    "reference": "https://attack.mitre.org/techniques/T1059/005/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "1c9d0d8c-057e-41f8-972d-d2b418970c2f",
        "rule_id": "201200f1-a99b-43fb-88ed-f65a45c4972c",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:31.003Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:08.127Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.name : (\"csc.exe\", \"vbc.exe\") and\n  process.parent.name : (\"wscript.exe\", \"mshta.exe\", \"cscript.exe\", \"wmic.exe\", \"svchost.exe\", \"rundll32.exe\", \"cmstp.exe\", \"regsvr32.exe\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Exploit - Detected - Elastic Endgame",
        "description": "Elastic Endgame detected an Exploit. Click the Elastic Endgame icon in the event.module column or the link in the rule.reference column for additional information.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 103,
        "tags": [
          "Data Source: Elastic Endgame",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Tactic: Privilege Escalation"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-900s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 10000,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            }
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1068",
                "name": "Exploitation for Privilege Escalation",
                "reference": "https://attack.mitre.org/techniques/T1068/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule is configured to generate more **Max alerts per run** than the default 1000 alerts per run set for all rules. This is to ensure that it captures as many alerts as possible.\n\n**IMPORTANT:** The rule's **Max alerts per run** setting can be superseded by the `xpack.alerting.rules.run.alerts.max` Kibana config setting, which determines the maximum alerts generated by _any_ rule in the Kibana alerting framework. For example, if `xpack.alerting.rules.run.alerts.max` is set to 1000, this rule will still generate no more than 1000 alerts even if its own **Max alerts per run** is set higher.\n\nTo make sure this rule can generate as many alerts as it's configured in its own **Max alerts per run** setting, increase the `xpack.alerting.rules.run.alerts.max` system setting accordingly.\n\n**NOTE:** Changing `xpack.alerting.rules.run.alerts.max` is not possible in Serverless projects.",
        "related_integrations": [],
        "required_fields": [
          {
            "name": "endgame.event_subtype_full",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "endgame.metadata.type",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.kind",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.module",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "96ee94a5-dfd3-4422-87e4-c1adb380cec1",
        "rule_id": "2003cdc8-8d83-4aa5-b132-1f9a8eb48514",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:31.001Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:08.123Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "endgame-*"
        ],
        "filters": [],
        "query": "event.kind:alert and event.module:endgame and endgame.metadata.type:detection and (event.action:exploit_event or endgame.event_subtype_full:exploit_event)",
        "language": "kuery"
      },
      {
        "name": "Creation or Modification of Root Certificate",
        "description": "Identifies the creation or modification of a local trusted root certificate in Windows. The install of a malicious root certificate would allow an attacker the ability to masquerade malicious files as valid signed components from any entity (for example, Microsoft). It could also allow an attacker to decrypt SSL traffic.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Creation or Modification of Root Certificate\n\nRoot certificates are the primary level of certifications that tell a browser that the communication is trusted and legitimate. This verification is based upon the identification of a certification authority. Windows adds several trusted root certificates so browsers can use them to communicate with websites.\n\n[Check out this post](https://www.thewindowsclub.com/what-are-root-certificates-windows) for more details on root certificates and the involved cryptography.\n\nThis rule identifies the creation or modification of a root certificate by monitoring registry modifications. The installation of a malicious root certificate would allow an attacker the ability to masquerade malicious files as valid signed components from any entity (for example, Microsoft). It could also allow an attacker to decrypt SSL traffic.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate abnormal behaviors observed by the subject process such as network connections, other registry or file modifications, and any spawned child processes.\n- If one of the processes is suspicious, retrieve it and determine if it is malicious:\n  - Use a private sandboxed malware analysis system to perform analysis.\n    - Observe and collect information about the following activities:\n      - Attempts to contact external domains and addresses.\n      - File and registry access, modification, and creation activities.\n      - Service creation and launch activities.\n      - Scheduled task creation.\n  - Use the PowerShell `Get-FileHash` cmdlet to get the files' SHA-256 hash values.\n    - Search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n\n### False positive analysis\n\n- This detection may be triggered by certain applications that install root certificates for the purpose of inspecting SSL traffic. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove the malicious certificate from the root certificate store.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 311,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: SentinelOne"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Certain applications may install root certificates for the purpose of inspecting SSL traffic."
        ],
        "references": [
          "https://posts.specterops.io/code-signing-certificate-cloning-attacks-and-defenses-6f98657fc6ec",
          "https://www.ired.team/offensive-security/persistence/t1130-install-root-certificate"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1553",
                "name": "Subvert Trust Controls",
                "reference": "https://attack.mitre.org/techniques/T1553/",
                "subtechnique": [
                  {
                    "id": "T1553.004",
                    "name": "Install Root Certificate",
                    "reference": "https://attack.mitre.org/techniques/T1553/004/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.value",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "0b9dcee2-f5fe-454a-9fcc-5f545736c951",
        "rule_id": "203ab79b-239b-4aa5-8e54-fc50623ee8e4",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:31.005Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:08.130Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "registry where host.os.type == \"windows\" and event.type == \"change\" and registry.value : \"Blob\" and\n  registry.path :\n    (\n      \"HKLM\\\\Software\\\\Microsoft\\\\SystemCertificates\\\\Root\\\\Certificates\\\\*\\\\Blob\",\n      \"HKLM\\\\Software\\\\Microsoft\\\\SystemCertificates\\\\AuthRoot\\\\Certificates\\\\*\\\\Blob\",\n      \"HKLM\\\\Software\\\\Policies\\\\Microsoft\\\\SystemCertificates\\\\Root\\\\Certificates\\\\*\\\\Blob\",\n      \"HKLM\\\\Software\\\\Policies\\\\Microsoft\\\\SystemCertificates\\\\AuthRoot\\\\Certificates\\\\*\\\\Blob\",\n      \"\\\\REGISTRY\\\\MACHINE\\\\Software\\\\Microsoft\\\\SystemCertificates\\\\Root\\\\Certificates\\\\*\\\\Blob\",\n      \"\\\\REGISTRY\\\\MACHINE\\\\Software\\\\Microsoft\\\\SystemCertificates\\\\AuthRoot\\\\Certificates\\\\*\\\\Blob\",\n      \"\\\\REGISTRY\\\\MACHINE\\\\Software\\\\Policies\\\\Microsoft\\\\SystemCertificates\\\\Root\\\\Certificates\\\\*\\\\Blob\",\n      \"\\\\REGISTRY\\\\MACHINE\\\\Software\\\\Policies\\\\Microsoft\\\\SystemCertificates\\\\AuthRoot\\\\Certificates\\\\*\\\\Blob\",\n      \"MACHINE\\\\Software\\\\Microsoft\\\\SystemCertificates\\\\Root\\\\Certificates\\\\*\\\\Blob\",\n      \"MACHINE\\\\Software\\\\Microsoft\\\\SystemCertificates\\\\AuthRoot\\\\Certificates\\\\*\\\\Blob\",\n      \"MACHINE\\\\Software\\\\Policies\\\\Microsoft\\\\SystemCertificates\\\\Root\\\\Certificates\\\\*\\\\Blob\",\n      \"MACHINE\\\\Software\\\\Policies\\\\Microsoft\\\\SystemCertificates\\\\AuthRoot\\\\Certificates\\\\*\\\\Blob\"\n    ) and\n  not process.executable : (\n          \"?:\\\\ProgramData\\\\Lenovo\\\\Vantage\\\\Addins\\\\LenovoHardwareScanAddin\\\\*\\\\LdeApi.Server.exe\",\n          \"?:\\\\ProgramData\\\\Logishrd\\\\LogiOptionsPlus\\\\Plugins\\\\64\\\\certmgr.exe\",\n          \"?:\\\\ProgramData\\\\Microsoft\\\\Windows Defender\\\\Platform\\\\*\\\\MpDefenderCoreService.exe\",\n          \"?:\\\\ProgramData\\\\Microsoft\\\\Windows Defender\\\\Platform\\\\*\\\\MsMpEng.exe\",\n          \"?:\\\\ProgramData\\\\Quest\\\\KACE\\\\modules\\\\clientidentifier\\\\clientidentifier.exe\",\n          \"?:\\\\ProgramData\\\\Sophos\\\\AutoUpdate\\\\Cache\\\\sophos_autoupdate1.dir\\\\SophosUpdate.exe\",\n          \"?:\\\\Program Files (x86)\\\\*.exe\",\n          \"?:\\\\Program Files\\\\*.exe\",\n          \"?:\\\\Windows\\\\CCM\\\\CcmExec.exe\",\n          \"?:\\\\Windows\\\\ccmsetup\\\\cache\\\\ccmsetup.exe\",\n          \"?:\\\\Windows\\\\Cluster\\\\clussvc.exe\",\n          \"?:\\\\Windows\\\\ImmersiveControlPanel\\\\SystemSettings.exe\",\n          \"?:\\\\Windows\\\\Lenovo\\\\ImController\\\\PluginHost86\\\\Lenovo.Modern.ImController.PluginHost.Device.exe\",\n          \"?:\\\\Windows\\\\Lenovo\\\\ImController\\\\Service\\\\Lenovo.Modern.ImController.exe\",\n          \"?:\\\\Windows\\\\Sysmon.exe\",\n          \"?:\\\\Windows\\\\Sysmon64.exe\",\n          \"?:\\\\Windows\\\\System32\\\\*.exe\",\n          \"?:\\\\Windows\\\\SysWOW64\\\\*.exe\",\n          \"?:\\\\Windows\\\\UUS\\\\amd64\\\\MoUsoCoreWorker.exe\",\n          \"?:\\\\Windows\\\\WinSxS\\\\*.exe\"\n  )",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.registry-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*"
        ],
        "filters": []
      },
      {
        "name": "AWS Route 53 Domain Transferred to Another Account",
        "description": "Identifies when a request has been made to transfer a Route 53 domain to another AWS account.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Cloud",
          "Data Source: AWS",
          "Data Source: Amazon Web Services",
          "Data Source: AWS Route53",
          "Use Case: Asset Visibility",
          "Tactic: Persistence"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-3600s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic",
          "Austin Songer"
        ],
        "false_positives": [
          "A domain may be transferred to another AWS account by a system or network administrator. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. Domain transfers from unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule."
        ],
        "references": [
          "https://docs.aws.amazon.com/Route53/latest/APIReference/API_Operations_Amazon_Route_53.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1098",
                "name": "Account Manipulation",
                "reference": "https://attack.mitre.org/techniques/T1098/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            }
          }
        ],
        "setup": "The AWS Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "aws",
            "version": "^2.0.0",
            "integration": "cloudtrail"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "30aff468-76d9-4a1c-b315-700fcff7a89c",
        "rule_id": "2045567e-b0af-444a-8c0b-0b6e2dae9e13",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:31.007Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:08.134Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-aws.cloudtrail-*"
        ],
        "filters": [],
        "query": "event.dataset:aws.cloudtrail and event.provider:route53.amazonaws.com and event.action:TransferDomainToAnotherAwsAccount and event.outcome:success",
        "language": "kuery"
      },
      {
        "name": "Suspicious Web Browser Sensitive File Access",
        "description": "Identifies the access or file open of web browser sensitive files by an untrusted/unsigned process or osascript. Adversaries may acquire credentials from web browsers by reading files specific to the target browser.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 209,
        "tags": [
          "Domain: Endpoint",
          "OS: macOS",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://securelist.com/calisto-trojan-for-macos/86543/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1539",
                "name": "Steal Web Session Cookie",
                "reference": "https://attack.mitre.org/techniques/T1539/"
              },
              {
                "id": "T1555",
                "name": "Credentials from Password Stores",
                "reference": "https://attack.mitre.org/techniques/T1555/",
                "subtechnique": [
                  {
                    "id": "T1555.003",
                    "name": "Credentials from Web Browsers",
                    "reference": "https://attack.mitre.org/techniques/T1555/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a macOS System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, for MacOS it is recommended to select \"Traditional Endpoints\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "Effective_process.executable",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.code_signature.exists",
            "type": "boolean",
            "ecs": true
          },
          {
            "name": "process.code_signature.signing_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.code_signature.trusted",
            "type": "boolean",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "46b69087-cdfc-458a-8624-cae19ed0cca5",
        "rule_id": "20457e4f-d1de-4b92-ae69-142e27a4342a",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:31.009Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:08.137Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where event.action == \"open\" and host.os.type == \"macos\" and process.executable != null and\n file.name : (\"cookies.sqlite\", \n              \"key?.db\", \n              \"logins.json\", \n              \"Cookies\", \n              \"Cookies.binarycookies\", \n              \"Login Data\") and \n ((process.code_signature.trusted == false or process.code_signature.exists == false) or process.name : \"osascript\") and \n not process.code_signature.signing_id : \"org.mozilla.firefox\" and\n not Effective_process.executable : \"/Library/Elastic/Endpoint/elastic-endpoint.app/Contents/MacOS/elastic-endpoint\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.file-*"
        ],
        "filters": []
      },
      {
        "name": "LSASS Memory Dump Handle Access",
        "description": "Identifies handle requests for the Local Security Authority Subsystem Service (LSASS) object access with specific access masks that many tools with a capability to dump memory to disk use (0x1fffff, 0x1010, 0x120089). This rule is tool agnostic as it has been validated against a host of various LSASS dump tools such as SharpDump, Procdump, Mimikatz, Comsvcs etc. It detects this behavior at a low level and does not depend on a specific tool or dump file name.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating LSASS Memory Dump Handle Access\n\nLocal Security Authority Server Service (LSASS) is a process in Microsoft Windows operating systems that is responsible for enforcing security policy on the system. It verifies users logging on to a Windows computer or server, handles password changes, and creates access tokens.\n\nAdversaries may attempt to access credential material stored in LSASS process memory. After a user logs on, the system generates and stores a variety of credential materials in LSASS process memory. This is meant to facilitate single sign-on (SSO) ensuring a user isnâ€™t prompted each time resource access is requested. These credential materials can be harvested by an adversary using administrative user or SYSTEM privileges to conduct lateral movement using [alternate authentication material](https://attack.mitre.org/techniques/T1550/).\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the process executable using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n\n### False positive analysis\n\n- There should be very few or no false positives for this rule. If this activity is expected or noisy in your environment, consider adding exceptions â€” preferably with a combination of user and command line conditions.\n- If the process is related to antivirus or endpoint detection and response solutions, validate that it is installed on the correct path and signed with the company's valid digital signature.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Scope compromised credentials and disable the accounts.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 211,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Resources: Investigation Guide",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4656",
          "https://twitter.com/jsecurity101/status/1227987828534956033?s=20",
          "https://attack.mitre.org/techniques/T1003/001/",
          "https://threathunterplaybook.com/notebooks/windows/06_credential_access/WIN-170105221010.html",
          "http://findingbad.blogspot.com/2017/",
          "https://www.elastic.co/security-labs/detect-credential-access"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1003",
                "name": "OS Credential Dumping",
                "reference": "https://attack.mitre.org/techniques/T1003/",
                "subtechnique": [
                  {
                    "id": "T1003.001",
                    "name": "LSASS Memory",
                    "reference": "https://attack.mitre.org/techniques/T1003/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nEnsure advanced audit policies for Windows are enabled, specifically:\nObject Access policies [Event ID 4656](https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4656) (Handle to an Object was Requested)\n\n```\nComputer Configuration >\nPolicies >\nWindows Settings >\nSecurity Settings >\nAdvanced Audit Policies Configuration >\nSystem Audit Policies >\nObject Access >\nAudit File System (Success,Failure)\nAudit Handle Manipulation (Success,Failure)\n```\n\nAlso, this event generates only if the objectâ€™s [SACL](https://docs.microsoft.com/en-us/windows/win32/secauthz/access-control-lists) has the required access control entry (ACE) to handle the use of specific access rights.\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.code",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.event_data.AccessMask",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "winlog.event_data.AccessMaskDescription",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "winlog.event_data.ObjectName",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "winlog.event_data.ProcessName",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "6321b46a-0298-4149-9b7d-b3b652442582",
        "rule_id": "208dbe77-01ed-4954-8d44-1e5751cb20de",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:31.010Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:04.090Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "any where event.action == \"File System\" and event.code == \"4656\" and\n\n    winlog.event_data.ObjectName : (\n        \"?:\\\\Windows\\\\System32\\\\lsass.exe\",\n        \"\\\\Device\\\\HarddiskVolume?\\\\Windows\\\\System32\\\\lsass.exe\",\n        \"\\\\Device\\\\HarddiskVolume??\\\\Windows\\\\System32\\\\lsass.exe\") and\n\n    /* The right to perform an operation controlled by an extended access right. */\n\n    (winlog.event_data.AccessMask : (\"0x1fffff\" , \"0x1010\", \"0x120089\", \"0x1F3FFF\") or\n     winlog.event_data.AccessMaskDescription : (\"READ_CONTROL\", \"Read from process memory\"))\n\n     /* Common Noisy False Positives */\n\n    and not winlog.event_data.ProcessName : (\n        \"?:\\\\Program Files\\\\*.exe\",\n        \"?:\\\\Program Files (x86)\\\\*.exe\",\n        \"?:\\\\Windows\\\\system32\\\\wbem\\\\WmiPrvSE.exe\",\n        \"?:\\\\Windows\\\\System32\\\\dllhost.exe\",\n        \"?:\\\\Windows\\\\System32\\\\svchost.exe\",\n        \"?:\\\\Windows\\\\System32\\\\msiexec.exe\",\n        \"?:\\\\ProgramData\\\\Microsoft\\\\Windows Defender\\\\*.exe\",\n        \"?:\\\\Windows\\\\explorer.exe\",\n        \"?:\\\\Windows\\\\System32\\\\poqexec.exe\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-system.*",
          "logs-windows.*"
        ],
        "filters": []
      },
      {
        "name": "First Time Seen Google Workspace OAuth Login from Third-Party Application",
        "description": "Detects the first time a third-party application logs in and authenticated with OAuth. OAuth is used to grant permissions to specific resources and services in Google Workspace. Compromised credentials or service accounts could allow an adversary to authenticate to Google Workspace as a valid user and inherit their privileges.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Setup\n\n### Important Information Regarding Google Workspace Event Lag Times\n- As per Google's documentation, Google Workspace administrators may observe lag times ranging from minutes up to 3 days between the time of an event's occurrence and the event being visible in the Google Workspace admin/audit logs.\n- This rule is configured to run every 10 minutes with a lookback time of 130 minutes.\n- To reduce the risk of false negatives, consider reducing the interval that the Google Workspace (formerly G Suite) Filebeat module polls Google's reporting API for new events.\n- By default, `var.interval` is set to 2 hours (2h). Consider changing this interval to a lower value, such as 10 minutes (10m).\n- See the following references for further information:\n  - https://support.google.com/a/answer/7061566\n  - https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-module-google_workspace.html",
        "output_index": "",
        "version": 5,
        "tags": [
          "Domain: Cloud",
          "Data Source: Google Workspace",
          "Tactic: Defense Evasion",
          "Tactic: Initial Access"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-7800s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Developers may leverage third-party applications for legitimate purposes in Google Workspace such as for administrative tasks."
        ],
        "references": [
          "https://www.elastic.co/security-labs/google-workspace-attack-surface-part-one",
          "https://www.elastic.co/security-labs/google-workspace-attack-surface-part-two",
          "https://developers.google.com/apps-script/guides/bound",
          "https://developers.google.com/identity/protocols/oauth2"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1550",
                "name": "Use Alternate Authentication Material",
                "reference": "https://attack.mitre.org/techniques/T1550/",
                "subtechnique": [
                  {
                    "id": "T1550.001",
                    "name": "Application Access Token",
                    "reference": "https://attack.mitre.org/techniques/T1550/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1078",
                "name": "Valid Accounts",
                "reference": "https://attack.mitre.org/techniques/T1078/",
                "subtechnique": [
                  {
                    "id": "T1078.004",
                    "name": "Cloud Accounts",
                    "reference": "https://attack.mitre.org/techniques/T1078/004/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The Google Workspace Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "google_workspace",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "google_workspace.token.client.id",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "google_workspace.token.scope.data",
            "type": "flattened",
            "ecs": false
          }
        ],
        "id": "b2b4f2b9-fabd-4bc6-9994-b36951499dc7",
        "rule_id": "21bafdf0-cf17-11ed-bd57-f661ea17fbcc",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:31.012Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:08.140Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "event.dataset: \"google_workspace.token\" and event.action: \"authorize\" and\ngoogle_workspace.token.scope.data: *Login and google_workspace.token.client.id: *apps.googleusercontent.com",
        "new_terms_fields": [
          "google_workspace.token.client.id"
        ],
        "history_window_start": "now-15d",
        "index": [
          "filebeat-*",
          "logs-google_workspace*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Full User-Mode Dumps Enabled System-Wide",
        "description": "Identifies the enable of the full user-mode dumps feature system-wide. This feature allows Windows Error Reporting (WER) to collect data after an application crashes. This setting is a requirement for the LSASS Shtinkering attack, which fakes the communication of a crash on LSASS, generating a dump of the process memory, which gives the attacker access to the credentials present on the system without having to bring malware to the system. This setting is not enabled by default, and applications must create their registry subkeys to hold settings that enable them to collect dumps.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 108,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame",
          "Data Source: Sysmon",
          "Data Source: Microsoft Defender for Endpoint"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://docs.microsoft.com/en-us/windows/win32/wer/collecting-user-mode-dumps",
          "https://github.com/deepinstinct/Lsass-Shtinkering",
          "https://media.defcon.org/DEF%20CON%2030/DEF%20CON%2030%20presentations/Asaf%20Gilboa%20-%20LSASS%20Shtinkering%20Abusing%20Windows%20Error%20Reporting%20to%20Dump%20LSASS.pdf"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1003",
                "name": "OS Credential Dumping",
                "reference": "https://attack.mitre.org/techniques/T1003/",
                "subtechnique": [
                  {
                    "id": "T1003.001",
                    "name": "LSASS Memory",
                    "reference": "https://attack.mitre.org/techniques/T1003/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1112",
                "name": "Modify Registry",
                "reference": "https://attack.mitre.org/techniques/T1112/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.data.strings",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "registry.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "46d2746c-1dbd-4edc-af4b-881b4b935521",
        "rule_id": "220be143-5c67-4fdb-b6ce-dd6826d024fd",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:31.014Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:08.144Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "registry where host.os.type == \"windows\" and\n    registry.path : (\n        \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\Windows Error Reporting\\\\LocalDumps\\\\DumpType\",\n        \"\\\\REGISTRY\\\\MACHINE\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\Windows Error Reporting\\\\LocalDumps\\\\DumpType\"\n    ) and\n    registry.data.strings : (\"2\", \"0x00000002\") and\n    not (process.executable : \"?:\\\\Windows\\\\system32\\\\svchost.exe\" and user.id : (\"S-1-5-18\", \"S-1-5-19\", \"S-1-5-20\"))",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.registry-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-m365_defender.event-*"
        ],
        "filters": []
      },
      {
        "name": "AWS S3 Bucket Configuration Deletion",
        "description": "Identifies the deletion of various Amazon Simple Storage Service (S3) bucket configuration components.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 207,
        "tags": [
          "Domain: Cloud",
          "Data Source: AWS",
          "Data Source: Amazon Web Services",
          "Use Case: Asset Visibility",
          "Tactic: Defense Evasion"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-3600s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Bucket components may be deleted by a system or network administrator. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. Bucket component deletions by unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule."
        ],
        "references": [
          "https://docs.aws.amazon.com/AmazonS3/latest/API/API_DeleteBucketPolicy.html",
          "https://docs.aws.amazon.com/AmazonS3/latest/API/API_DeleteBucketReplication.html",
          "https://docs.aws.amazon.com/AmazonS3/latest/API/API_DeleteBucketCors.html",
          "https://docs.aws.amazon.com/AmazonS3/latest/API/API_DeleteBucketEncryption.html",
          "https://docs.aws.amazon.com/AmazonS3/latest/API/API_DeleteBucketLifecycle.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1070",
                "name": "Indicator Removal",
                "reference": "https://attack.mitre.org/techniques/T1070/"
              }
            ]
          }
        ],
        "setup": "The AWS Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "aws",
            "version": "^2.0.0",
            "integration": "cloudtrail"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "81196028-611c-4320-97e8-b1bfce3fa349",
        "rule_id": "227dc608-e558-43d9-b521-150772250bae",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:31.017Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:08.159Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-aws.cloudtrail-*"
        ],
        "filters": [],
        "query": "event.dataset:aws.cloudtrail and event.provider:s3.amazonaws.com and\n  event.action:(DeleteBucketPolicy or DeleteBucketReplication or DeleteBucketCors or\n                DeleteBucketEncryption or DeleteBucketLifecycle)\n  and event.outcome:success",
        "language": "kuery"
      },
      {
        "name": "SUNBURST Command and Control Activity",
        "description": "The malware known as SUNBURST targets the SolarWind's Orion business software for command and control. This rule detects post-exploitation command and control activity of the SUNBURST backdoor.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating SUNBURST Command and Control Activity\n\nSUNBURST is a trojanized version of a digitally signed SolarWinds Orion plugin called SolarWinds.Orion.Core.BusinessLayer.dll. The plugin contains a backdoor that communicates via HTTP to third-party servers. After an initial dormant period of up to two weeks, SUNBURST may retrieve and execute commands that instruct the backdoor to transfer files, execute files, profile the system, reboot the system, and disable system services. The malware's network traffic attempts to blend in with legitimate SolarWinds activity by imitating the Orion Improvement Program (OIP) protocol, and the malware stores persistent state data within legitimate plugin configuration files. The backdoor uses multiple obfuscated blocklists to identify processes, services, and drivers associated with forensic and anti-virus tools.\n\nMore details on SUNBURST can be found on the [Mandiant Report](https://www.mandiant.com/resources/sunburst-additional-technical-details).\n\nThis rule identifies suspicious network connections that attempt to blend in with legitimate SolarWinds activity by imitating the Orion Improvement Program (OIP) protocol behavior.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the executable involved using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n### False positive analysis\n\n- This activity should not happen legitimately. The security team should address any potential benign true positive (B-TP), as this configuration can put the environment at risk.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Reimage the host operating system and restore compromised files to clean versions.\n- Upgrade SolarWinds systems to the latest version to eradicate the chance of reinfection by abusing the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 108,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Command and Control",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.fireeye.com/blog/threat-research/2020/12/evasive-attacker-leverages-solarwinds-supply-chain-compromises-with-sunburst-backdoor.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            },
            "technique": [
              {
                "id": "T1071",
                "name": "Application Layer Protocol",
                "reference": "https://attack.mitre.org/techniques/T1071/",
                "subtechnique": [
                  {
                    "id": "T1071.001",
                    "name": "Web Protocols",
                    "reference": "https://attack.mitre.org/techniques/T1071/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1195",
                "name": "Supply Chain Compromise",
                "reference": "https://attack.mitre.org/techniques/T1195/",
                "subtechnique": [
                  {
                    "id": "T1195.002",
                    "name": "Compromise Software Supply Chain",
                    "reference": "https://attack.mitre.org/techniques/T1195/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "http.request.body.content",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "network.protocol",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "99795c4f-5f81-410c-abc4-d4b0758e7904",
        "rule_id": "22599847-5d13-48cb-8872-5796fee8692b",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:31.016Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:06.045Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "network where host.os.type == \"windows\" and event.type == \"protocol\" and network.protocol == \"http\" and\n  process.name : (\"ConfigurationWizard.exe\",\n                  \"NetFlowService.exe\",\n                  \"NetflowDatabaseMaintenance.exe\",\n                  \"SolarWinds.Administration.exe\",\n                  \"SolarWinds.BusinessLayerHost.exe\",\n                  \"SolarWinds.BusinessLayerHostx64.exe\",\n                  \"SolarWinds.Collector.Service.exe\",\n                  \"SolarwindsDiagnostics.exe\") and\n  (\n    (\n      (http.request.body.content : \"*/swip/Upload.ashx*\" and http.request.body.content : (\"POST*\", \"PUT*\")) or\n      (http.request.body.content : (\"*/swip/SystemDescription*\", \"*/swip/Events*\") and http.request.body.content : (\"GET*\", \"HEAD*\"))\n    ) and\n    not http.request.body.content : \"*solarwinds.com*\"\n  )",
        "language": "eql",
        "index": [
          "logs-endpoint.events.network-*"
        ],
        "filters": []
      },
      {
        "name": "Kernel Module Load via insmod",
        "description": "Detects the use of the insmod binary to load a Linux kernel object file. Threat actors can use this binary, given they have root privileges, to load a rootkit on a system providing them with complete control and the ability to hide from security products. Manually loading a kernel module in this manner should not be at all common and can indicate suspcious or malicious behavior.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Kernel module load via insmod\n\nThe insmod binary is a Linux utility that allows users with root privileges to load kernel modules, which are object files that extend the functionality of the kernel. \n\nThreat actors can abuse this utility to load rootkits, granting them full control over the system and the ability to evade security products.\n\nThe detection rule 'Kernel module load via insmod' is designed to identify instances where the insmod binary is used to load a kernel object file (with a .ko extension) on a Linux system. This activity is uncommon and may indicate suspicious or malicious behavior.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n> This investigation guide uses [placeholder fields](https://www.elastic.co/guide/en/security/current/osquery-placeholder-fields.html) to dynamically pass alert data into Osquery queries. Placeholder fields were introduced in Elastic Stack version 8.7.0. If you're using Elastic Stack version 8.6.0 or earlier, you'll need to manually adjust this investigation guide's queries to ensure they properly run.\n\n### Possible investigation steps\n\n- Investigate the kernel object file that was loaded via insmod.\n  - !{osquery{\"label\":\"Osquery - Retrieve Running Processes by User\",\"query\":\"SELECT pid, username, name FROM processes p JOIN users u ON u.uid = p.uid ORDER BY username\"}}\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence and whether they are located in expected locations.\n  - !{osquery{\"label\":\"Osquery - Retrieve Listening Ports\",\"query\":\"SELECT pid, address, port, socket, protocol, path FROM listening_ports\"}}\n- Investigate the kernel ring buffer for any warnings or messages, such as tainted or out-of-tree kernel module loads through `dmesg`.\n- Investigate syslog for any unusual segfaults or other messages. Rootkits may be installed on targets with different architecture as expected, and could potentially cause segmentation faults. \n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Validate the activity is not related to planned patches, updates, network administrator activity, or legitimate software installations.\n- Investigate whether the altered scripts call other malicious scripts elsewhere on the file system. \n  - If scripts or executables were dropped, retrieve the files and determine if they are malicious:\n    - Use a private sandboxed malware analysis system to perform analysis.\n      - Observe and collect information about the following activities:\n        - Attempts to contact external domains and addresses.\n          - Check if the domain is newly registered or unexpected.\n          - Check the reputation of the domain or IP address.\n        - File access, modification, and creation activities.\n- Investigate abnormal behaviors by the subject process/user such as network connections, file modifications, and any other spawned child processes.\n  - Investigate listening ports and open sockets to look for potential command and control traffic or data exfiltration.\n    - !{osquery{\"label\":\"Osquery - Retrieve Open Sockets\",\"query\":\"SELECT pid, family, remote_address, remote_port, socket, state FROM process_open_sockets\"}}\n    - !{osquery{\"label\":\"Osquery - Retrieve Information for a Specific User\",\"query\":\"SELECT * FROM users WHERE username = {{user.name}}\"}}\n  - Identify the user account that performed the action, analyze it, and check whether it should perform this kind of action.\n    - !{osquery{\"label\":\"Osquery - Investigate the Account Authentication Status\",\"query\":\"SELECT * FROM logged_in_users WHERE user = {{user.name}}\"}}\n- Investigate whether the user is currently logged in and active.\n    - $osquery_6\n\n### False positive analysis\n\n- If this activity is related to new benign software installation activity, consider adding exceptions â€” preferably with a combination of user and command line conditions.\n- If this activity is related to a system administrator who uses cron jobs for administrative purposes, consider adding exceptions for this specific administrator user account. \n- Try to understand the context of the execution by thinking about the user, machine, or business purpose. A small number of endpoints, such as servers with unique software, might appear unusual but satisfy a specific business need.\n\n### Related Rules\n\n- Kernel Driver Load - 3e12a439-d002-4944-bc42-171c0dcb9b96\n- Tainted Out-Of-Tree Kernel Module Load - 51a09737-80f7-4551-a3be-dac8ef5d181a\n- Tainted Kernel Module Load - 05cad2fb-200c-407f-b472-02ea8c9e5e4a\n- Attempt to Clear Kernel Ring Buffer - 2724808c-ba5d-48b2-86d2-0002103df753\n- Enumeration of Kernel Modules via Proc - 80084fa9-8677-4453-8680-b891d3c0c778\n- Suspicious Modprobe File Event - 40ddbcc8-6561-44d9-afc8-eefdbfe0cccd\n- Kernel Module Removal - cd66a5af-e34b-4bb0-8931-57d0a043f2ef\n- Enumeration of Kernel Modules - 2d8043ed-5bda-4caf-801c-c1feb7410504\n\n### Response and Remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Leverage the incident response data and logging to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 110,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Threat: Rootkit",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Auditd Manager"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://decoded.avast.io/davidalvarez/linux-threat-hunting-syslogk-a-kernel-rootkit-found-under-development-in-the-wild/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1547",
                "name": "Boot or Logon Autostart Execution",
                "reference": "https://attack.mitre.org/techniques/T1547/",
                "subtechnique": [
                  {
                    "id": "T1547.006",
                    "name": "Kernel Modules and Extensions",
                    "reference": "https://attack.mitre.org/techniques/T1547/006/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "auditd_manager",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "9c28c4e2-a4ca-434e-b042-4678204fb022",
        "rule_id": "2339f03c-f53f-40fa-834b-40c5983fc41f",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:31.019Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:08.166Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and process.name == \"insmod\" and process.args : \"*.ko\" and\nnot process.parent.executable like (\n  \"/opt/ds_agent/*\", \"/usr/sbin/veeamsnap-loader\", \"/opt/TrendMicro/vls_agent/*\", \"/opt/intel/oneapi/*\",\n  \"/opt/commvault/Base/linux_drv\", \"/bin/falcoctl\"\n)",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*",
          "auditbeat-*",
          "logs-auditd_manager.auditd-*"
        ],
        "filters": []
      },
      {
        "name": "Lateral Movement via Startup Folder",
        "description": "Identifies suspicious file creations in the startup folder of a remote system. An adversary could abuse this to move laterally by dropping a malicious script or executable that will be executed after a reboot or user logon.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 309,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Lateral Movement",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: SentinelOne"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.mdsec.co.uk/2017/06/rdpinception/",
          "https://www.elastic.co/security-labs/hunting-for-lateral-movement-using-event-query-language"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1021",
                "name": "Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1021/",
                "subtechnique": [
                  {
                    "id": "T1021.001",
                    "name": "Remote Desktop Protocol",
                    "reference": "https://attack.mitre.org/techniques/T1021/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1547",
                "name": "Boot or Logon Autostart Execution",
                "reference": "https://attack.mitre.org/techniques/T1547/",
                "subtechnique": [
                  {
                    "id": "T1547.001",
                    "name": "Registry Run Keys / Startup Folder",
                    "reference": "https://attack.mitre.org/techniques/T1547/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pid",
            "type": "long",
            "ecs": true
          }
        ],
        "id": "d84ab3f3-8000-4d35-b3d8-1d1b136bf77e",
        "rule_id": "25224a80-5a4a-4b8a-991e-6ab390465c4f",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:31.021Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:08.170Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"windows\" and event.type in (\"creation\", \"change\") and\n\n /* via RDP TSClient mounted share or SMB */\n  (process.name : \"mstsc.exe\" or process.pid == 4) and\n\n   file.path : (\"?:\\\\Users\\\\*\\\\AppData\\\\Roaming\\\\Microsoft\\\\Windows\\\\Start Menu\\\\Programs\\\\Startup\\\\*\",\n                \"?:\\\\ProgramData\\\\Microsoft\\\\Windows\\\\Start Menu\\\\Programs\\\\Startup\\\\*\")",
        "language": "eql",
        "index": [
          "logs-endpoint.events.file-*",
          "winlogbeat-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*"
        ],
        "filters": []
      },
      {
        "name": "Persistence via Update Orchestrator Service Hijack",
        "description": "Identifies potential hijacking of the Microsoft Update Orchestrator Service to establish persistence with an integrity level of SYSTEM.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Persistence via Update Orchestrator Service Hijack\n\nWindows Update Orchestrator Service is a DCOM service used by other components to install Windows updates that are already downloaded. Windows Update Orchestrator Service was vulnerable to elevation of privileges (any user to local system) due to an improper authorization of the callers. The vulnerability affected the Windows 10 and Windows Server Core products. Fixed by Microsoft on Patch Tuesday June 2020.\n\nThis rule will detect uncommon processes spawned by `svchost.exe` with `UsoSvc` as the command line parameters. Attackers can leverage this technique to elevate privileges or maintain persistence.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate any abnormal behavior by the subject process such as network connections, registry or file modifications, and any spawned child processes.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the process executable using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 312,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Tactic: Privilege Escalation",
          "Use Case: Vulnerability",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/irsl/CVE-2020-1313"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1543",
                "name": "Create or Modify System Process",
                "reference": "https://attack.mitre.org/techniques/T1543/",
                "subtechnique": [
                  {
                    "id": "T1543.003",
                    "name": "Windows Service",
                    "reference": "https://attack.mitre.org/techniques/T1543/003/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1068",
                "name": "Exploitation for Privilege Escalation",
                "reference": "https://attack.mitre.org/techniques/T1068/"
              },
              {
                "id": "T1574",
                "name": "Hijack Execution Flow",
                "reference": "https://attack.mitre.org/techniques/T1574/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "e6afaeff-0b56-435a-bc61-beac0b1220c7",
        "rule_id": "265db8f5-fc73-4d0d-b434-6483b56372e2",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:31.023Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:05.861Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.parent.executable : \"C:\\\\Windows\\\\System32\\\\svchost.exe\" and\n  process.parent.args : \"UsoSvc\" and\n  not process.executable :\n          (\"?:\\\\ProgramData\\\\Microsoft\\\\Windows\\\\UUS\\\\Packages\\\\*\\\\amd64\\\\MoUsoCoreWorker.exe\",\n          \"?:\\\\Windows\\\\System32\\\\UsoClient.exe\",\n          \"?:\\\\Windows\\\\System32\\\\MusNotification.exe\",\n          \"?:\\\\Windows\\\\System32\\\\MusNotificationUx.exe\",\n          \"?:\\\\Windows\\\\System32\\\\MusNotifyIcon.exe\",\n          \"?:\\\\Windows\\\\System32\\\\WerFault.exe\",\n          \"?:\\\\Windows\\\\System32\\\\WerMgr.exe\",\n          \"?:\\\\Windows\\\\UUS\\\\amd64\\\\MoUsoCoreWorker.exe\",\n          \"?:\\\\Windows\\\\System32\\\\MoUsoCoreWorker.exe\",\n          \"?:\\\\Windows\\\\UUS\\\\amd64\\\\UsoCoreWorker.exe\",\n          \"?:\\\\Windows\\\\System32\\\\UsoCoreWorker.exe\",\n          \"?:\\\\Program Files\\\\Common Files\\\\microsoft shared\\\\ClickToRun\\\\OfficeC2RClient.exe\") and\n  not process.name : (\"MoUsoCoreWorker.exe\", \"OfficeC2RClient.exe\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*"
        ],
        "filters": []
      },
      {
        "name": "Privileges Elevation via Parent Process PID Spoofing",
        "description": "Identifies parent process spoofing used to create an elevated child process. Adversaries may spoof the parent process identifier (PPID) of a new process to evade process-monitoring defenses or to elevate privileges.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 7,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://gist.github.com/xpn/a057a26ec81e736518ee50848b9c2cd6",
          "https://blog.didierstevens.com/2017/03/20/",
          "https://learn.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-updateprocthreadattribute",
          "https://github.com/redcanaryco/atomic-red-team/blob/master/atomics/T1134.002/T1134.002.md"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1134",
                "name": "Access Token Manipulation",
                "reference": "https://attack.mitre.org/techniques/T1134/",
                "subtechnique": [
                  {
                    "id": "T1134.002",
                    "name": "Create Process with Token",
                    "reference": "https://attack.mitre.org/techniques/T1134/002/"
                  },
                  {
                    "id": "T1134.004",
                    "name": "Parent PID Spoofing",
                    "reference": "https://attack.mitre.org/techniques/T1134/004/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.code_signature.subject_name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.code_signature.trusted",
            "type": "boolean",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.Ext.real.pid",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "612b12c6-fff6-455a-b5e8-41098fdce4b6",
        "rule_id": "26b01043-4f04-4d2f-882a-5a1d2e95751b",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:31.025Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:08.177Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "/* This rule is compatible with Elastic Endpoint only */\n\nprocess where host.os.type == \"windows\" and event.action == \"start\" and\n\n /* process creation via seclogon */\n process.parent.Ext.real.pid > 0 and\n\n /* PrivEsc to SYSTEM */\n user.id : \"S-1-5-18\"  and\n\n /* Common FPs - evasion via hollowing is possible, should be covered by code injection */\n not process.executable : (\"?:\\\\Windows\\\\System32\\\\WerFault.exe\",\n                           \"?:\\\\Windows\\\\SysWOW64\\\\WerFault.exe\",\n                           \"?:\\\\Windows\\\\System32\\\\WerFaultSecure.exe\",\n                           \"?:\\\\Windows\\\\SysWOW64\\\\WerFaultSecure.exe\",\n                           \"?:\\\\Windows\\\\System32\\\\Wermgr.exe\",\n                           \"?:\\\\Windows\\\\SysWOW64\\\\Wermgr.exe\",\n                           \"?:\\\\Windows\\\\SoftwareDistribution\\\\Download\\\\Install\\\\securityhealthsetup.exe\") and\n /* Logon Utilities */\n not (process.parent.executable : \"?:\\\\Windows\\\\System32\\\\Utilman.exe\" and\n     process.executable : (\"?:\\\\Windows\\\\System32\\\\osk.exe\",\n                           \"?:\\\\Windows\\\\System32\\\\Narrator.exe\",\n                           \"?:\\\\Windows\\\\System32\\\\Magnify.exe\")) and\n\n not process.parent.executable : \"?:\\\\Windows\\\\System32\\\\AtBroker.exe\" and\n\n not (process.code_signature.subject_name in\n           (\"philandro Software GmbH\", \"Freedom Scientific Inc.\", \"TeamViewer Germany GmbH\", \"Projector.is, Inc.\",\n            \"TeamViewer GmbH\", \"Cisco WebEx LLC\", \"Dell Inc\") and process.code_signature.trusted == true) and \n\n /* AM_Delta_Patch Windows Update */\n not (process.executable : (\"?:\\\\Windows\\\\System32\\\\MpSigStub.exe\", \"?:\\\\Windows\\\\SysWOW64\\\\MpSigStub.exe\") and\n      process.parent.executable : (\"?:\\\\Windows\\\\System32\\\\wuauclt.exe\", \n                                   \"?:\\\\Windows\\\\SysWOW64\\\\wuauclt.exe\", \n                                   \"?:\\\\Windows\\\\UUS\\\\Packages\\\\Preview\\\\*\\\\wuaucltcore.exe\", \n                                   \"?:\\\\Windows\\\\UUS\\\\amd64\\\\wuauclt.exe\", \n                                   \"?:\\\\Windows\\\\UUS\\\\amd64\\\\wuaucltcore.exe\", \n                                   \"?:\\\\ProgramData\\\\Microsoft\\\\Windows\\\\UUS\\\\*\\\\wuaucltcore.exe\")) and\n not (process.executable : (\"?:\\\\Windows\\\\System32\\\\MpSigStub.exe\", \"?:\\\\Windows\\\\SysWOW64\\\\MpSigStub.exe\") and process.parent.executable == null) and\n\n /* Other third party SW */\n not process.parent.executable :\n                   (\"?:\\\\Program Files (x86)\\\\HEAT Software\\\\HEAT Remote\\\\HEATRemoteServer.exe\",\n                    \"?:\\\\Program Files (x86)\\\\VisualCron\\\\VisualCronService.exe\",\n                    \"?:\\\\Program Files\\\\BinaryDefense\\\\Vision\\\\Agent\\\\bds-vision-agent-app.exe\",\n                    \"?:\\\\Program Files\\\\Tablet\\\\Wacom\\\\WacomHost.exe\",\n                    \"?:\\\\Program Files (x86)\\\\LogMeIn\\\\x64\\\\LogMeIn.exe\",\n                    \"?:\\\\Program Files (x86)\\\\EMC Captiva\\\\Captiva Cloud Runtime\\\\Emc.Captiva.WebCaptureRunner.exe\",\n                    \"?:\\\\Program Files\\\\Freedom Scientific\\\\*.exe\",\n                    \"?:\\\\Program Files (x86)\\\\Google\\\\Chrome Remote Desktop\\\\*\\\\remoting_host.exe\",\n                    \"?:\\\\Program Files (x86)\\\\GoToAssist Remote Support Customer\\\\*\\\\g2ax_comm_customer.exe\") and\n not (\n    process.code_signature.trusted == true and process.code_signature.subject_name == \"Netwrix Corporation\" and\n    process.name : \"adcrcpy.exe\" and process.parent.executable : (\n      \"?:\\\\Program Files (x86)\\\\Netwrix Auditor\\\\Active Directory Auditing\\\\Netwrix.ADA.EventCollector.exe\",\n      \"?:\\\\Program Files (x86)\\\\Netwrix Auditor\\\\Active Directory Auditing\\\\Netwrix.ADA.Analyzer.exe\",\n      \"?:\\\\Netwrix Auditor\\\\Active Directory Auditing\\\\Netwrix.ADA.EventCollector.exe\"\n    )\n )",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*"
        ],
        "filters": []
      },
      {
        "name": "Microsoft 365 Exchange Transport Rule Modification",
        "description": "Identifies when a transport rule has been disabled or deleted in Microsoft 365. Mail flow rules (also known as transport rules) are used to identify and take action on messages that flow through your organization. An adversary or insider threat may modify a transport rule to exfiltrate data or evade defenses.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Cloud",
          "Data Source: Microsoft 365",
          "Use Case: Configuration Audit",
          "Tactic: Exfiltration"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-1800s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "A transport rule may be modified by a system or network administrator. Verify that the configuration change was expected. Exceptions can be added to this rule to filter expected behavior."
        ],
        "references": [
          "https://docs.microsoft.com/en-us/powershell/module/exchange/remove-transportrule?view=exchange-ps",
          "https://docs.microsoft.com/en-us/powershell/module/exchange/disable-transportrule?view=exchange-ps",
          "https://docs.microsoft.com/en-us/exchange/security-and-compliance/mail-flow-rules/mail-flow-rules"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0010",
              "name": "Exfiltration",
              "reference": "https://attack.mitre.org/tactics/TA0010/"
            },
            "technique": [
              {
                "id": "T1537",
                "name": "Transfer Data to Cloud Account",
                "reference": "https://attack.mitre.org/techniques/T1537/"
              }
            ]
          }
        ],
        "setup": "The Office 365 Logs Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "o365",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "d153ca33-046e-4c47-ab6c-3ab22b2e36a3",
        "rule_id": "272a6484-2663-46db-a532-ef734bf9a796",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:31.026Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:08.187Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-o365*"
        ],
        "filters": [],
        "query": "event.dataset:o365.audit and event.provider:Exchange and event.category:web and event.action:(\"Remove-TransportRule\" or \"Disable-TransportRule\") and event.outcome:success",
        "language": "kuery"
      },
      {
        "name": "Microsoft 365 Teams External Access Enabled",
        "description": "Identifies when external access is enabled in Microsoft Teams. External access lets Teams and Skype for Business users communicate with other users that are outside their organization. An adversary may enable external access or add an allowed domain to exfiltrate data or maintain persistence in an environment.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Cloud",
          "Data Source: Microsoft 365",
          "Use Case: Configuration Audit",
          "Tactic: Persistence"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-1800s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Teams external access may be enabled by a system or network administrator. Verify that the configuration change was expected. Exceptions can be added to this rule to filter expected behavior."
        ],
        "references": [
          "https://docs.microsoft.com/en-us/microsoftteams/manage-external-access"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1098",
                "name": "Account Manipulation",
                "reference": "https://attack.mitre.org/techniques/T1098/"
              }
            ]
          }
        ],
        "setup": "The Office 365 Logs Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "o365",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "o365.audit.Parameters.AllowFederatedUsers",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "e56927a2-124d-46d7-a963-5f287ada1bb9",
        "rule_id": "27f7c15a-91f8-4c3d-8b9e-1f99cc030a51",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:31.028Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:09.193Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-o365*"
        ],
        "filters": [],
        "query": "event.dataset:o365.audit and event.provider:(SkypeForBusiness or MicrosoftTeams) and\nevent.category:web and event.action:\"Set-CsTenantFederationConfiguration\" and\no365.audit.Parameters.AllowFederatedUsers:True and event.outcome:success",
        "language": "kuery"
      },
      {
        "name": "Account Password Reset Remotely",
        "description": "Identifies an attempt to reset a potentially privileged account password remotely. Adversaries may manipulate account passwords to maintain access or evade password duration policies and preserve compromised credentials.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "## Performance\nThis rule may cause medium to high performance impact due to logic scoping all remote Windows logon activity.\n",
        "output_index": "",
        "version": 216,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Tactic: Impact",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Legitimate remote account administration."
        ],
        "references": [
          "https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4724",
          "https://stealthbits.com/blog/manipulating-user-passwords-with-mimikatz/",
          "https://github.com/sbousseaden/EVTX-ATTACK-SAMPLES/blob/master/Credential%20Access/remote_pwd_reset_rpc_mimikatz_postzerologon_target_DC.evtx",
          "https://www.elastic.co/security-labs/detect-credential-access"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1098",
                "name": "Account Manipulation",
                "reference": "https://attack.mitre.org/techniques/T1098/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0040",
              "name": "Impact",
              "reference": "https://attack.mitre.org/tactics/TA0040/"
            },
            "technique": [
              {
                "id": "T1531",
                "name": "Account Access Removal",
                "reference": "https://attack.mitre.org/techniques/T1531/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "source.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "winlog.computer_name",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "winlog.event_data.SubjectLogonId",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "winlog.event_data.TargetLogonId",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "winlog.event_data.TargetSid",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "winlog.event_data.TargetUserName",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "winlog.logon.type",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "c8f90f0f-43fe-4879-8520-aae44184fab1",
        "rule_id": "2820c9c2-bcd7-4d6e-9eba-faf3891ba450",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:31.030Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:05.868Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by winlog.computer_name with maxspan=1m\n  [authentication where event.action == \"logged-in\" and\n    /* event 4624 need to be logged */\n    winlog.logon.type : \"Network\" and event.outcome == \"success\" and source.ip != null and\n    source.ip != \"127.0.0.1\" and source.ip != \"::1\" and\n    not winlog.event_data.TargetUserName : (\"svc*\", \"PIM_*\", \"_*_\", \"*-*-*\", \"*$\")] by winlog.event_data.TargetLogonId\n   /* event 4724 need to be logged */\n  [iam where event.action == \"reset-password\" and\n   (\n    /*\n       This rule is very noisy if not scoped to privileged accounts, duplicate the\n       rule and add your own naming convention and accounts of interest here.\n     */\n    winlog.event_data.TargetUserName: (\"*Admin*\", \"*super*\", \"*SVC*\", \"*DC0*\", \"*service*\", \"*DMZ*\", \"*ADM*\") or\n    winlog.event_data.TargetSid : (\"S-1-5-21-*-500\", \"S-1-12-1-*-500\")\n    )\n  ] by winlog.event_data.SubjectLogonId",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-system.security*",
          "logs-windows.forwarded*"
        ],
        "filters": []
      },
      {
        "name": "Account Discovery Command via SYSTEM Account",
        "description": "Identifies when the SYSTEM account uses an account discovery utility. This could be a sign of discovery activity after an adversary has achieved privilege escalation.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Account Discovery Command via SYSTEM Account\n\nAfter successfully compromising an environment, attackers may try to gain situational awareness to plan their next steps. This can happen by running commands to enumerate network resources, users, connections, files, and installed security software.\n\nThis rule looks for the execution of account discovery utilities using the SYSTEM account, which is commonly observed after attackers successfully perform privilege escalation or exploit web applications.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n  - If the process tree includes a web-application server process such as w3wp, httpd.exe, nginx.exe and alike, investigate any suspicious file creation or modification in the last 48 hours to assess the presence of any potential webshell backdoor.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Determine how the SYSTEM account is being used. For example, users with administrator privileges can spawn a system shell using Windows services, scheduled tasks or other third party utilities.\n\n### False positive analysis\n\n- Discovery activities are not inherently malicious if they occur in isolation. As long as the analyst did not identify suspicious activity related to the user or host, such alerts can be dismissed.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection via the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n- Use the data collected through the analysis to investigate other machines affected in the environment.\n",
        "output_index": "",
        "version": 211,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Tactic: Privilege Escalation",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1033",
                "name": "System Owner/User Discovery",
                "reference": "https://attack.mitre.org/techniques/T1033/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1078",
                "name": "Valid Accounts",
                "reference": "https://attack.mitre.org/techniques/T1078/",
                "subtechnique": [
                  {
                    "id": "T1078.003",
                    "name": "Local Accounts",
                    "reference": "https://attack.mitre.org/techniques/T1078/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.Ext.token.integrity_level_name",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.event_data.IntegrityLevel",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "18a54fca-26f2-4bfc-a772-e527674a605c",
        "rule_id": "2856446a-34e6-435b-9fb5-f8f040bfa7ed",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:31.040Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:09.005Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (?process.Ext.token.integrity_level_name : \"System\" or\n  ?winlog.event_data.IntegrityLevel : \"System\") and\n  (\n    process.name : \"whoami.exe\" or\n    (\n      process.name : \"net1.exe\" and not process.parent.name : \"net.exe\" and not process.args : (\"start\", \"stop\", \"/active:*\")\n    )\n  )",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "AWS EC2 Security Group Configuration Change",
        "description": "Identifies a change to an AWS Security Group Configuration. A security group is like a virtual firewall, and modifying configurations may allow unauthorized access. Threat actors may abuse this to establish persistence, exfiltrate data, or pivot in an AWS environment.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "### Investigating AWS EC2 Security Group Configuration Change\n\nThis rule identifies any changes to an AWS Security Group, which functions as a virtual firewall controlling inbound and outbound traffic for resources like EC2 instances. Modifications to a security group configuration could expose critical assets to unauthorized access. Threat actors may exploit such changes to establish persistence, exfiltrate data, or pivot within an AWS environment.\n\n#### Possible Investigation Steps\n\n1. **Identify the Modified Security Group**:\n   - **Security Group ID**: Check the `aws.cloudtrail.flattened.request_parameters.groupId` field to identify the specific security group affected.\n   - **Rule Changes**: Review `aws.cloudtrail.flattened.response_elements.securityGroupRuleSet` to determine the new rules or configurations, including any added or removed IP ranges, protocol changes, and port specifications.\n\n2. **Review User Context**:\n   - **User Identity**: Inspect the `aws.cloudtrail.user_identity.arn` field to determine which user or role made the modification. Verify if this is an authorized administrator or a potentially compromised account.\n   - **Access Patterns**: Analyze whether this user regularly interacts with security group configurations or if this event is out of the ordinary for their account.\n\n3. **Analyze the Configuration Change**:\n   - **Egress vs. Ingress**: Determine if the change affected inbound (ingress) or outbound (egress) traffic by reviewing fields like `isEgress` in the `securityGroupRuleSet`. Unauthorized changes to outbound traffic can indicate data exfiltration attempts.\n   - **IP Ranges and Ports**: Assess any added IP ranges, especially `0.0.0.0/0`, which exposes resources to the internet. Port changes should also be evaluated to ensure only necessary ports are open.\n\n4. **Check User Agent and Source IP**:\n   - **User Agent Analysis**: Examine the `user_agent.original` field to identify the tool or application used, such as `AWS Console` or `Terraform`, which may reveal if the action was automated or manual.\n   - **Source IP and Geolocation**: Use `source.address` and `source.geo` fields to verify if the IP address and geolocation match expected locations for your organization. Unexpected IPs or regions may indicate unauthorized access.\n\n5. **Evaluate for Persistence Indicators**:\n   - **Repeated Changes**: Investigate if similar changes were recently made across multiple security groups, which may suggest an attempt to maintain or expand access.\n   - **Permissions Review**: Confirm that the userâ€™s IAM policies are configured to limit changes to security groups only as necessary.\n\n6. **Correlate with Other CloudTrail Events**:\n   - **Cross-Reference Other Security Events**: Look for related actions like `AuthorizeSecurityGroupIngress`, `CreateSecurityGroup`, or `RevokeSecurityGroupIngress` that may indicate additional or preparatory steps for unauthorized access.\n   - **Monitor for IAM or Network Changes**: Check for IAM modifications, network interface changes, or other configuration updates in the same timeframe to detect broader malicious activities.\n\n### False Positive Analysis\n\n- **Routine Security Changes**: Security group modifications may be part of regular infrastructure maintenance. Verify if this action aligns with known, scheduled administrative activities.\n- **Automated Configuration Management**: If you are using automated tools like `Terraform` or `CloudFormation`, confirm if the change matches expected configuration drift corrections or deployments.\n\n### Response and Remediation\n\n- **Revert Unauthorized Changes**: If unauthorized, revert the security group configuration to its previous state to secure the environment.\n- **Restrict Security Group Permissions**: Remove permissions to modify security groups from any compromised or unnecessary accounts to limit future access.\n- **Quarantine Affected Resources**: If necessary, isolate any affected instances or resources to prevent further unauthorized activity.\n- **Audit IAM and Security Group Policies**: Regularly review permissions related to security groups to ensure least privilege access and prevent excessive access.\n\n### Additional Information\n\nFor more details on managing AWS Security Groups and best practices, refer to the [AWS EC2 Security Groups Documentation](https://docs.aws.amazon.com/AWSEC2/latest/WindowsGuide/ec2-security-groups.html) and AWS security best practices.\n",
        "output_index": "",
        "investigation_fields": {
          "field_names": [
            "@timestamp",
            "user.name",
            "aws.cloudtrail.user_identity.arn",
            "aws.cloudtrail.user_identity.type",
            "user_agent.original",
            "aws.cloudtrail.flattened.request_parameters.instanceId",
            "event.action",
            "event.outcome",
            "cloud.region",
            "event.provider",
            "aws.cloudtrail.request_parameters",
            "aws.cloudtrail.response_elements"
          ]
        },
        "version": 207,
        "tags": [
          "Domain: Cloud",
          "Data Source: AWS",
          "Data Source: Amazon Web Services",
          "Data Source: AWS EC2",
          "Use Case: Network Security Monitoring",
          "Resources: Investigation Guide",
          "Tactic: Persistence",
          "Tactic: Defense Evasion"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic",
          "Austin Songer"
        ],
        "false_positives": [
          "A security group may be created by a system or network administrator. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. Security group creations by unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule."
        ],
        "references": [
          "https://docs.aws.amazon.com/AWSEC2/latest/WindowsGuide/ec2-security-groups.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            }
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.007",
                    "name": "Disable or Modify Cloud Firewall",
                    "reference": "https://attack.mitre.org/techniques/T1562/007/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "aws",
            "version": "^2.0.0",
            "integration": "cloudtrail"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "5c3fb6bd-e630-4fd1-92f9-636f88075693",
        "rule_id": "29052c19-ff3e-42fd-8363-7be14d7c5469",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:31.044Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:09.012Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-aws.cloudtrail-*"
        ],
        "filters": [],
        "query": "event.dataset: \"aws.cloudtrail\"\n    and event.provider: \"ec2.amazonaws.com\"\n    and event.action:(\n            \"AuthorizeSecurityGroupEgress\" or\n            \"CreateSecurityGroup\" or\n            \"ModifyInstanceAttribute\" or\n            \"ModifySecurityGroupRules\" or\n            \"RevokeSecurityGroupEgress\" or\n            \"RevokeSecurityGroupIngress\")\n    and event.outcome: \"success\"",
        "language": "kuery"
      },
      {
        "name": "Exploit - Prevented - Elastic Endgame",
        "description": "Elastic Endgame prevented an Exploit. Click the Elastic Endgame icon in the event.module column or the link in the rule.reference column for additional information.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 103,
        "tags": [
          "Data Source: Elastic Endgame",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Tactic: Privilege Escalation"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-900s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 10000,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            }
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1068",
                "name": "Exploitation for Privilege Escalation",
                "reference": "https://attack.mitre.org/techniques/T1068/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule is configured to generate more **Max alerts per run** than the default 1000 alerts per run set for all rules. This is to ensure that it captures as many alerts as possible.\n\n**IMPORTANT:** The rule's **Max alerts per run** setting can be superseded by the `xpack.alerting.rules.run.alerts.max` Kibana config setting, which determines the maximum alerts generated by _any_ rule in the Kibana alerting framework. For example, if `xpack.alerting.rules.run.alerts.max` is set to 1000, this rule will still generate no more than 1000 alerts even if its own **Max alerts per run** is set higher.\n\nTo make sure this rule can generate as many alerts as it's configured in its own **Max alerts per run** setting, increase the `xpack.alerting.rules.run.alerts.max` system setting accordingly.\n\n**NOTE:** Changing `xpack.alerting.rules.run.alerts.max` is not possible in Serverless projects.",
        "related_integrations": [],
        "required_fields": [
          {
            "name": "endgame.event_subtype_full",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "endgame.metadata.type",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.kind",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.module",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "0db6d9be-ca6b-4f46-930b-d0ddf847381d",
        "rule_id": "2863ffeb-bf77-44dd-b7a5-93ef94b72036",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:31.042Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:09.009Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "endgame-*"
        ],
        "filters": [],
        "query": "event.kind:alert and event.module:endgame and endgame.metadata.type:prevention and (event.action:exploit_event or endgame.event_subtype_full:exploit_event)",
        "language": "kuery"
      },
      {
        "name": "UAC Bypass Attempt via Windows Directory Masquerading",
        "description": "Identifies an attempt to bypass User Account Control (UAC) by masquerading as a Microsoft trusted Windows directory. Attackers may bypass UAC to stealthily execute code with elevated permissions.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating UAC Bypass Attempt via Windows Directory Masquerading\n\nWindows User Account Control (UAC) allows a program to elevate its privileges (tracked as low to high integrity levels) to perform a task under administrator-level permissions, possibly by prompting the user for confirmation. UAC can deny an operation under high-integrity enforcement, or allow the user to perform the action if they are in the local administrators group and enter an administrator password when prompted.\n\nFor more information about the UAC and how it works, check the [official Microsoft docs page](https://docs.microsoft.com/en-us/windows/security/identity-protection/user-account-control/how-user-account-control-works).\n\nThis rule identifies an attempt to bypass User Account Control (UAC) by masquerading as a Microsoft trusted Windows directory. Attackers may bypass UAC to stealthily execute code with elevated permissions.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Inspect the host for suspicious or abnormal behavior in the alert timeframe.\n- Investigate any abnormal behavior by the subject process such as network connections, registry or file modifications, and any spawned child processes.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze any suspicious spawned processes using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 315,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Tactic: Defense Evasion",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://medium.com/tenable-techblog/uac-bypass-by-mocking-trusted-directories-24a96675f6e"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1548",
                "name": "Abuse Elevation Control Mechanism",
                "reference": "https://attack.mitre.org/techniques/T1548/",
                "subtechnique": [
                  {
                    "id": "T1548.002",
                    "name": "Bypass User Account Control",
                    "reference": "https://attack.mitre.org/techniques/T1548/002/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1036",
                "name": "Masquerading",
                "reference": "https://attack.mitre.org/techniques/T1036/",
                "subtechnique": [
                  {
                    "id": "T1036.005",
                    "name": "Match Legitimate Name or Location",
                    "reference": "https://attack.mitre.org/techniques/T1036/005/"
                  }
                ]
              },
              {
                "id": "T1548",
                "name": "Abuse Elevation Control Mechanism",
                "reference": "https://attack.mitre.org/techniques/T1548/",
                "subtechnique": [
                  {
                    "id": "T1548.002",
                    "name": "Bypass User Account Control",
                    "reference": "https://attack.mitre.org/techniques/T1548/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "57e91913-3316-4341-9f4c-b0b5390bd01f",
        "rule_id": "290aca65-e94d-403b-ba0f-62f320e63f51",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:31.046Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:05.871Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.args : (\"C:\\\\Windows \\\\system32\\\\*.exe\", \"C:\\\\Windows \\\\SysWOW64\\\\*.exe\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Web Shell Detection: Script Process Child of Common Web Processes",
        "description": "Identifies suspicious commands executed via a web server, which may suggest a vulnerability and remote shell access.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Web Shell Detection: Script Process Child of Common Web Processes\n\nAdversaries may backdoor web servers with web shells to establish persistent access to systems. A web shell is a web script that is placed on an openly accessible web server to allow an adversary to use the web server as a gateway into a network. A web shell may provide a set of functions to execute or a command-line interface on the system that hosts the web server.\n\nThis rule detects a web server process spawning script and command-line interface programs, potentially indicating attackers executing commands using the web shell.\n\n#### Possible investigation steps\n\n- Investigate abnormal behaviors observed by the subject process such as network connections, registry or file modifications, and any other spawned child processes.\n- Examine the command line to determine which commands or scripts were executed.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n- If scripts or executables were dropped, retrieve the files and determine if they are malicious:\n  - Use a private sandboxed malware analysis system to perform analysis.\n    - Observe and collect information about the following activities:\n      - Attempts to contact external domains and addresses.\n      - File and registry access, modification, and creation activities.\n      - Service creation and launch activities.\n      - Scheduled task creation.\n  - Use the PowerShell Get-FileHash cmdlet to get the files' SHA-256 hash values.\n    - Search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Any activity that triggered the alert and is not inherently malicious must be monitored by the security team.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 416,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Tactic: Initial Access",
          "Tactic: Execution",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: SentinelOne",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Security audits, maintenance, and network administrative scripts may trigger this alert when run under web processes."
        ],
        "references": [
          "https://www.microsoft.com/security/blog/2020/02/04/ghost-in-the-shell-investigating-web-shell-attacks/",
          "https://www.elastic.co/security-labs/elastic-response-to-the-the-spring4shell-vulnerability-cve-2022-22965",
          "https://www.elastic.co/security-labs/hunting-for-persistence-using-elastic-security-part-1"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1505",
                "name": "Server Software Component",
                "reference": "https://attack.mitre.org/techniques/T1505/",
                "subtechnique": [
                  {
                    "id": "T1505.003",
                    "name": "Web Shell",
                    "reference": "https://attack.mitre.org/techniques/T1505/003/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1190",
                "name": "Exploit Public-Facing Application",
                "reference": "https://attack.mitre.org/techniques/T1190/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  },
                  {
                    "id": "T1059.003",
                    "name": "Windows Command Shell",
                    "reference": "https://attack.mitre.org/techniques/T1059/003/"
                  },
                  {
                    "id": "T1059.005",
                    "name": "Visual Basic",
                    "reference": "https://attack.mitre.org/techniques/T1059/005/"
                  }
                ]
              },
              {
                "id": "T1047",
                "name": "Windows Management Instrumentation",
                "reference": "https://attack.mitre.org/techniques/T1047/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "1769b5f0-a35d-48f8-8ae2-124be6ec4b4e",
        "rule_id": "2917d495-59bd-4250-b395-c29409b76086",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:31.048Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:09.015Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.parent.name : (\"w3wp.exe\", \"httpd.exe\", \"nginx.exe\", \"php.exe\", \"php-cgi.exe\", \"tomcat.exe\") and\n  process.name : (\"cmd.exe\", \"cscript.exe\", \"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\", \"wmic.exe\", \"wscript.exe\") and\n  not\n  (\n    process.parent.name : (\"php.exe\", \"httpd.exe\") and process.name : \"cmd.exe\" and\n    process.command_line : (\n      \"cmd.exe /c mode CON\",\n      \"cmd.exe /s /c \\\"mode CON\\\"\",\n      \"cmd.exe /c \\\"mode\\\"\",\n      \"cmd.exe /s /c \\\"tput colors 2>&1\\\"\"\n    )\n  )",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-m365_defender.event-*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Kubernetes Pod created with a Sensitive hostPath Volume",
        "description": "This rule detects when a pod is created with a sensitive volume of type hostPath. A hostPath volume type mounts a sensitive file or folder from the node to the container. If the container gets compromised, the attacker can use this mount for gaining access to the node. There are many ways a container with unrestricted access to the host filesystem can escalate privileges, including reading data from other containers, and accessing tokens of more privileged pods.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 204,
        "tags": [
          "Data Source: Kubernetes",
          "Tactic: Execution",
          "Tactic: Privilege Escalation"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "An administrator may need to attach a hostPath volume for a legitimate reason. This alert should be investigated for legitimacy by determining if the kuberenetes.audit.requestObject.spec.volumes.hostPath.path triggered is one needed by its target container/pod. For example, when the fleet managed elastic agent is deployed as a daemonset it creates several hostPath volume mounts, some of which are sensitive host directories like /proc, /etc/kubernetes, and /var/log. Add exceptions for trusted container images using the query field \"kubernetes.audit.requestObject.spec.container.image\""
        ],
        "references": [
          "https://blog.appsecco.com/kubernetes-namespace-breakout-using-insecure-host-path-volume-part-1-b382f2a6e216",
          "https://kubernetes.io/docs/concepts/storage/volumes/#hostpath"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1611",
                "name": "Escape to Host",
                "reference": "https://attack.mitre.org/techniques/T1611/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1610",
                "name": "Deploy Container",
                "reference": "https://attack.mitre.org/techniques/T1610/"
              }
            ]
          }
        ],
        "setup": "The Kubernetes Fleet integration with Audit Logs enabled or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "kubernetes",
            "version": "^1.4.1"
          }
        ],
        "required_fields": [
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "kubernetes.audit.annotations.authorization_k8s_io/decision",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "kubernetes.audit.objectRef.resource",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "kubernetes.audit.requestObject.spec.containers.image",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "kubernetes.audit.requestObject.spec.volumes.hostPath.path",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "kubernetes.audit.verb",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "59c7da5a-3fe9-4ff1-ad31-2b63e61ae2fc",
        "rule_id": "2abda169-416b-4bb3-9a6b-f8d239fd78ba",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:31.049Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:09.031Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "logs-kubernetes.*"
        ],
        "filters": [],
        "query": "event.dataset : \"kubernetes.audit_logs\"\n  and kubernetes.audit.annotations.authorization_k8s_io/decision:\"allow\"\n  and kubernetes.audit.objectRef.resource:\"pods\"\n  and kubernetes.audit.verb:(\"create\" or \"update\" or \"patch\")\n  and kubernetes.audit.requestObject.spec.volumes.hostPath.path:\n  (\"/\" or\n  \"/proc\" or\n  \"/root\" or\n  \"/var\" or\n  \"/var/run\" or\n  \"/var/run/docker.sock\" or\n  \"/var/run/crio/crio.sock\" or\n  \"/var/run/cri-dockerd.sock\" or\n  \"/var/lib/kubelet\" or\n  \"/var/lib/kubelet/pki\" or\n  \"/var/lib/docker/overlay2\" or\n  \"/etc\" or\n  \"/etc/kubernetes\" or\n  \"/etc/kubernetes/manifests\" or\n  \"/etc/kubernetes/pki\" or\n  \"/home/admin\")\n  and not kubernetes.audit.requestObject.spec.containers.image: (\"docker.elastic.co/beats/elastic-agent:8.4.0\")",
        "language": "kuery"
      },
      {
        "name": "ESXI Discovery via Grep",
        "description": "Identifies instances where a process named 'grep', 'egrep', or 'pgrep' is started on a Linux system with arguments related to virtual machine (VM) files, such as \"vmdk\", \"vmx\", \"vmxf\", \"vmsd\", \"vmsn\", \"vswp\", \"vmss\", \"nvram\", or \"vmem\". These file extensions are associated with VM-related file formats, and their presence in grep command arguments may indicate that a threat actor is attempting to search for, analyze, or manipulate VM files on the system.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 7,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame",
          "Data Source: Auditd Manager"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.bleepingcomputer.com/news/security/massive-esxiargs-ransomware-attack-targets-vmware-esxi-servers-worldwide/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1518",
                "name": "Software Discovery",
                "reference": "https://attack.mitre.org/techniques/T1518/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "auditd_manager",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "92d953dc-bd49-41ea-b4f6-2430002aab63",
        "rule_id": "2b662e21-dc6e-461e-b5cf-a6eb9b235ec4",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:31.051Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:09.035Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and\nevent.action in (\"exec\", \"exec_event\", \"executed\", \"process_started\") and\nprocess.name in (\"grep\", \"egrep\", \"pgrep\") and\nprocess.args in (\"vmdk\", \"vmx\", \"vmxf\", \"vmsd\", \"vmsn\", \"vswp\", \"vmss\", \"nvram\", \"vmem\") and\nnot process.parent.executable == \"/usr/share/qemu/init/qemu-kvm-init\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*",
          "auditbeat-*",
          "logs-auditd_manager.auditd-*"
        ],
        "filters": []
      },
      {
        "name": "Adobe Hijack Persistence",
        "description": "Detects writing executable files that will be automatically launched by Adobe on launch.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Adobe Hijack Persistence\n\nAttackers can replace the `RdrCEF.exe` executable with their own to maintain their access, which will be launched whenever Adobe Acrobat Reader is executed.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the file using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 414,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Microsoft Defender for Endpoint"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://twitter.com/pabraeken/status/997997818362155008"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1574",
                "name": "Hijack Execution Flow",
                "reference": "https://attack.mitre.org/techniques/T1574/",
                "subtechnique": [
                  {
                    "id": "T1574.010",
                    "name": "Services File Permissions Weakness",
                    "reference": "https://attack.mitre.org/techniques/T1574/010/"
                  }
                ]
              },
              {
                "id": "T1554",
                "name": "Compromise Host Software Binary",
                "reference": "https://attack.mitre.org/techniques/T1554/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "277ea781-397d-47fd-8d5c-9ccf7652b34a",
        "rule_id": "2bf78aa2-9c56-48de-b139-f169bf99cf86",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:31.053Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:05.874Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"windows\" and event.type == \"creation\" and\n  file.path : (\"?:\\\\Program Files (x86)\\\\Adobe\\\\Acrobat Reader DC\\\\Reader\\\\AcroCEF\\\\RdrCEF.exe\",\n               \"?:\\\\Program Files\\\\Adobe\\\\Acrobat Reader DC\\\\Reader\\\\AcroCEF\\\\RdrCEF.exe\") and\n  not process.name : \"msiexec.exe\"",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.file-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-m365_defender.event-*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious Microsoft Diagnostics Wizard Execution",
        "description": "Identifies potential abuse of the Microsoft Diagnostics Troubleshooting Wizard (MSDT) to proxy malicious command or binary execution via malicious process arguments.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 210,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://twitter.com/nao_sec/status/1530196847679401984",
          "https://lolbas-project.github.io/lolbas/Binaries/Msdt/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1218",
                "name": "System Binary Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1218/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "ac2755da-987b-4c6c-aa3c-85a81388c10b",
        "rule_id": "2c3c29a4-f170-42f8-a3d8-2ceebc18eb6a",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:31.065Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:09.042Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n   (process.pe.original_file_name == \"msdt.exe\" or process.name : \"msdt.exe\") and\n   (\n    process.args : (\"IT_RebrowseForFile=*\", \"ms-msdt:/id\", \"ms-msdt:-id\", \"*FromBase64*\") or\n\n    (process.args : \"-af\" and process.args : \"/skip\" and\n     process.parent.name : (\"explorer.exe\", \"cmd.exe\", \"powershell.exe\", \"cscript.exe\", \"wscript.exe\", \"mshta.exe\", \"rundll32.exe\", \"regsvr32.exe\") and\n     process.args : (\"?:\\\\WINDOWS\\\\diagnostics\\\\index\\\\PCWDiagnostic.xml\", \"PCWDiagnostic.xml\", \"?:\\\\Users\\\\Public\\\\*\", \"?:\\\\Windows\\\\Temp\\\\*\")) or\n\n    (process.pe.original_file_name == \"msdt.exe\" and not process.name : \"msdt.exe\" and process.name != null) or\n\n    (process.pe.original_file_name == \"msdt.exe\" and not process.executable : (\"?:\\\\Windows\\\\system32\\\\msdt.exe\", \"?:\\\\Windows\\\\SysWOW64\\\\msdt.exe\"))\n    )",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "winlogbeat-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-m365_defender.event-*"
        ],
        "filters": []
      },
      {
        "name": "Windows Defender Exclusions Added via PowerShell",
        "description": "Identifies modifications to the Windows Defender configuration settings using PowerShell to add exclusions at the folder directory or process level.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Windows Defender Exclusions Added via PowerShell\n\nMicrosoft Windows Defender is an antivirus product built into Microsoft Windows. Since this software product is used to prevent and stop malware, it's important to monitor what specific exclusions are made to the product's configuration settings. These can often be signs of an adversary or malware trying to bypass Windows Defender's capabilities. One of the more notable [examples](https://www.cyberbit.com/blog/endpoint-security/latest-trickbot-variant-has-new-tricks-up-its-sleeve/) was observed in 2018 where Trickbot incorporated mechanisms to disable Windows Defender to avoid detection.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Examine the exclusion in order to determine the intent behind it.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n- If the exclusion specifies a suspicious file or path, retrieve the file(s) and determine if malicious:\n  - Use a private sandboxed malware analysis system to perform analysis.\n    - Observe and collect information about the following activities:\n      - Attempts to contact external domains and addresses.\n      - File and registry access, modification, and creation activities.\n      - Service creation and launch activities.\n      - Scheduled task creation.\n  - Use the PowerShell Get-FileHash cmdlet to get the files' SHA-256 hash values.\n    - Search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n\n### False positive analysis\n\n- This rule has a high chance to produce false positives due to how often network administrators legitimately configure exclusions. In order to validate the activity further, review the specific exclusion and its intent. There are many legitimate reasons for exclusions, so it's important to gain context.\n\n### Related rules\n\n- Windows Defender Disabled via Registry Modification - 2ffa1f1e-b6db-47fa-994b-1512743847eb\n- Disabling Windows Defender Security Settings via PowerShell - c8cccb06-faf2-4cd5-886e-2c9636cfcb87\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Exclusion lists for antimalware capabilities should always be routinely monitored for review.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 313,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.bitdefender.com/files/News/CaseStudies/study/400/Bitdefender-PR-Whitepaper-MosaicLoader-creat5540-en-EN.pdf",
          "https://www.elastic.co/security-labs/elastic-security-uncovers-blister-malware-campaign",
          "https://www.elastic.co/security-labs/operation-bleeding-bear",
          "https://www.elastic.co/security-labs/invisible-miners-unveiling-ghostengine"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.001",
                    "name": "Disable or Modify Tools",
                    "reference": "https://attack.mitre.org/techniques/T1562/001/"
                  },
                  {
                    "id": "T1562.006",
                    "name": "Indicator Blocking",
                    "reference": "https://attack.mitre.org/techniques/T1562/006/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "18a283fb-4c0b-45c6-80e0-27e038986bc9",
        "rule_id": "2c17e5d7-08b9-43b2-b58a-0270d65ac85b",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:31.236Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:09.038Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n (process.name : (\"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\") or ?process.pe.original_file_name in (\"powershell.exe\", \"pwsh.dll\", \"powershell_ise.exe\")) and\n  process.args : (\"*Add-MpPreference*\", \"*Set-MpPreference*\") and\n  process.args : (\"*-Exclusion*\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Microsoft Build Engine Started by a System Process",
        "description": "An instance of MSBuild, the Microsoft Build Engine, was started by Explorer or the WMI (Windows Management Instrumentation) subsystem. This behavior is unusual and is sometimes used by malicious payloads.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 312,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Tactic: Execution",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "The Build Engine is commonly used by Windows developers but use by non-engineers is unusual."
        ],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1127",
                "name": "Trusted Developer Utilities Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1127/",
                "subtechnique": [
                  {
                    "id": "T1127.001",
                    "name": "MSBuild",
                    "reference": "https://attack.mitre.org/techniques/T1127/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            }
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "e5f57c83-5341-4ff5-b3cf-345cad61207a",
        "rule_id": "9d110cb3-5f4b-4c9a-b9f5-53f0a1707ae3",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:33.508Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:14.231Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.name : \"MSBuild.exe\" and\n  process.parent.name : (\"explorer.exe\", \"wmiprvse.exe\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Command Shell Activity Started via RunDLL32",
        "description": "Identifies command shell activity started via RunDLL32, which is commonly abused by attackers to host malicious code.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 310,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Tactic: Credential Access",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: SentinelOne"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Microsoft Windows installers leveraging RunDLL32 for installation."
        ],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  },
                  {
                    "id": "T1059.003",
                    "name": "Windows Command Shell",
                    "reference": "https://attack.mitre.org/techniques/T1059/003/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1552",
                "name": "Unsecured Credentials",
                "reference": "https://attack.mitre.org/techniques/T1552/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1218",
                "name": "System Binary Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1218/",
                "subtechnique": [
                  {
                    "id": "T1218.011",
                    "name": "Rundll32",
                    "reference": "https://attack.mitre.org/techniques/T1218/011/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "a5e25251-3eb9-4a38-a5e0-67fe8204b71b",
        "rule_id": "9ccf3ce0-0057-440a-91f5-870c6ad39093",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:33.510Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:14.223Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n process.name : (\"cmd.exe\", \"powershell.exe\") and\n  process.parent.name : \"rundll32.exe\" and process.parent.command_line != null and\n  /* common FPs can be added here */\n  not process.parent.args : (\"C:\\\\Windows\\\\System32\\\\SHELL32.dll,RunAsNewUser_RunDLL\",\n                             \"C:\\\\WINDOWS\\\\*.tmp,zzzzInvokeManagedCustomActionOutOfProc\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*"
        ],
        "filters": []
      },
      {
        "name": "Microsoft Build Engine Using an Alternate Name",
        "description": "An instance of MSBuild, the Microsoft Build Engine, was started after being renamed. This is uncommon behavior and may indicate an attempt to run unnoticed or undetected.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Microsoft Build Engine Using an Alternate Name\n\nThe OriginalFileName attribute of a PE (Portable Executable) file is a metadata field that contains the original name of the executable file when compiled or linked. By using this attribute, analysts can identify renamed instances that attackers can use with the intent of evading detections, application allowlists, and other security protections.\n\nThe Microsoft Build Engine is a platform for building applications. This engine, also known as MSBuild, provides an XML schema for a project file that controls how the build platform processes and builds software, and can be abused to proxy execution of code.\n\nThis rule checks for renamed instances of MSBuild, which can indicate an attempt of evading detections, application allowlists, and other security protections.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate any abnormal behavior by the subject process such as network connections, registry or file modifications, and any spawned child processes.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the process executable using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 213,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Tactic: Execution",
          "Data Source: Elastic Endgame",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: Microsoft Defender for Endpoint"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "The Build Engine is commonly used by Windows developers but use by non-engineers is unusual."
        ],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1036",
                "name": "Masquerading",
                "reference": "https://attack.mitre.org/techniques/T1036/",
                "subtechnique": [
                  {
                    "id": "T1036.003",
                    "name": "Rename System Utilities",
                    "reference": "https://attack.mitre.org/techniques/T1036/003/"
                  }
                ]
              },
              {
                "id": "T1127",
                "name": "Trusted Developer Utilities Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1127/",
                "subtechnique": [
                  {
                    "id": "T1127.001",
                    "name": "MSBuild",
                    "reference": "https://attack.mitre.org/techniques/T1127/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "4bfae7fc-7e9a-4f21-b55a-75c28a7e84cf",
        "rule_id": "9d110cb3-5f4b-4c9a-b9f5-53f0a1707ae4",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:33.526Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:06.034Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.pe.original_file_name == \"MSBuild.exe\" and\n  not process.name : \"MSBuild.exe\"",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-m365_defender.event-*"
        ],
        "filters": []
      },
      {
        "name": "Potential Credential Access via Trusted Developer Utility",
        "description": "An instance of MSBuild, the Microsoft Build Engine, loaded DLLs (dynamically linked libraries) responsible for Windows credential management. This technique is sometimes used for credential dumping.",
        "risk_score": 73,
        "severity": "high",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Potential Credential Access via Trusted Developer Utility\n\nThe Microsoft Build Engine is a platform for building applications. This engine, also known as MSBuild, provides an XML schema for a project file that controls how the build platform processes and builds software.\n\nAdversaries can abuse MSBuild to proxy the execution of malicious code. The inline task capability of MSBuild that was introduced in .NET version 4 allows for C# or Visual Basic code to be inserted into an XML project file. MSBuild will compile and execute the inline task. `MSBuild.exe` is a signed Microsoft binary, and the execution of code using it can bypass application control defenses that are configured to allow `MSBuild.exe` execution.\n\nThis rule looks for the MSBuild process loading `vaultcli.dll` or `SAMLib.DLL`, which indicates the execution of credential access activities.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate abnormal behaviors observed by the subject process, such as network connections, registry or file modifications, and any spawned child processes.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Examine the command line to identify the `.csproj` file location.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the file using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 210,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Tactic: Defense Evasion",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "The Build Engine is commonly used by Windows developers but use by non-engineers is unusual."
        ],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1003",
                "name": "OS Credential Dumping",
                "reference": "https://attack.mitre.org/techniques/T1003/",
                "subtechnique": [
                  {
                    "id": "T1003.002",
                    "name": "Security Account Manager",
                    "reference": "https://attack.mitre.org/techniques/T1003/002/"
                  }
                ]
              },
              {
                "id": "T1555",
                "name": "Credentials from Password Stores",
                "reference": "https://attack.mitre.org/techniques/T1555/",
                "subtechnique": [
                  {
                    "id": "T1555.004",
                    "name": "Windows Credential Manager",
                    "reference": "https://attack.mitre.org/techniques/T1555/004/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1127",
                "name": "Trusted Developer Utilities Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1127/",
                "subtechnique": [
                  {
                    "id": "T1127.001",
                    "name": "MSBuild",
                    "reference": "https://attack.mitre.org/techniques/T1127/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "dll.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "569033c7-b913-433c-ae29-81d28a38c4da",
        "rule_id": "9d110cb3-5f4b-4c9a-b9f5-53f0a1707ae5",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:33.528Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:06.038Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by process.entity_id\n [process where host.os.type == \"windows\" and event.type == \"start\" and (process.name : \"MSBuild.exe\" or process.pe.original_file_name == \"MSBuild.exe\")]\n [any where host.os.type == \"windows\" and (event.category == \"library\" or (event.category == \"process\" and event.action : \"Image loaded*\")) and\n  (?dll.name : (\"vaultcli.dll\", \"SAMLib.DLL\") or file.name : (\"vaultcli.dll\", \"SAMLib.DLL\"))]",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-endpoint.events.library-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "LaunchDaemon Creation or Modification and Immediate Loading",
        "description": "Indicates the creation or modification of a launch daemon, which adversaries may use to repeatedly execute malicious payloads as part of persistence.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 106,
        "tags": [
          "Domain: Endpoint",
          "OS: macOS",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Trusted applications persisting via LaunchDaemons"
        ],
        "references": [
          "https://developer.apple.com/library/archive/documentation/MacOSX/Conceptual/BPSystemStartup/Chapters/CreatingLaunchdJobs.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1543",
                "name": "Create or Modify System Process",
                "reference": "https://attack.mitre.org/techniques/T1543/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a macOS System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, for MacOS it is recommended to select \"Traditional Endpoints\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "0d6f8c2b-c341-4a59-8d10-4b3e65df91a2",
        "rule_id": "9d19ece6-c20e-481a-90c5-ccca596537de",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:33.530Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:14.254Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by host.id with maxspan=1m\n [file where host.os.type == \"macos\" and event.type != \"deletion\" and file.path : (\"/System/Library/LaunchDaemons/*\", \"/Library/LaunchDaemons/*\")]\n [process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and process.name == \"launchctl\" and process.args == \"load\"]",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Unusual Linux Process Calling the Metadata Service",
        "description": "Looks for anomalous access to the metadata service by an unusual process. The metadata service may be targeted in order to harvest credentials or user data scripts containing secrets.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 104,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Rule Type: ML",
          "Rule Type: Machine Learning",
          "Tactic: Credential Access"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "15m",
        "from": "now-2700s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "A newly installed program or one that runs very rarely as part of a monthly or quarterly workflow could trigger this detection rule."
        ],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1552",
                "name": "Unsecured Credentials",
                "reference": "https://attack.mitre.org/techniques/T1552/",
                "subtechnique": [
                  {
                    "id": "T1552.005",
                    "name": "Cloud Instance Metadata API",
                    "reference": "https://attack.mitre.org/techniques/T1552/005/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires the installation of associated Machine Learning jobs, as well as data coming in from one of the following integrations:\n- Elastic Defend\n- Auditd Manager\n\n### Anomaly Detection Setup\n\nOnce the rule is enabled, the associated Machine Learning job will start automatically. You can view the Machine Learning job linked under the \"Definition\" panel of the detection rule. If the job does not start due to an error, the issue must be resolved for the job to commence successfully. For more details on setting up anomaly detection jobs, refer to the [helper guide](https://www.elastic.co/guide/en/kibana/current/xpack-ml-anomalies.html).\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration to your system:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n### Auditd Manager Integration Setup\nThe Auditd Manager Integration receives audit events from the Linux Audit Framework which is a part of the Linux kernel.\nAuditd Manager provides a user-friendly interface and automation capabilities for configuring and monitoring system auditing through the auditd daemon. With `auditd_manager`, administrators can easily define audit rules, track system events, and generate comprehensive audit reports, improving overall security and compliance in the system.\n\n#### The following steps should be executed in order to add the Elastic Agent System integration \"auditd_manager\" to your system:\n- Go to the Kibana home page and click â€œAdd integrationsâ€.\n- In the query bar, search for â€œAuditd Managerâ€ and select the integration to see more details about it.\n- Click â€œAdd Auditd Managerâ€.\n- Configure the integration name and optionally add a description.\n- Review optional and advanced settings accordingly.\n- Add the newly installed â€œauditd managerâ€ to an existing or a new agent policy, and deploy the agent on a Linux system from which auditd log files are desirable.\n- Click â€œSave and Continueâ€.\n- For more details on the integration refer to the [helper guide](https://docs.elastic.co/integrations/auditd_manager).\n\n#### Rule Specific Setup Note\nAuditd Manager subscribes to the kernel and receives events as they occur without any additional configuration.\nHowever, if more advanced configuration is required to detect specific behavior, audit rules can be added to the integration in either the \"audit rules\" configuration box or the \"auditd rule files\" box by specifying a file to read the audit rules from.\n- For this detection rule no additional audit rules are required.\n",
        "related_integrations": [
          {
            "package": "auditd_manager",
            "version": "^1.0.0"
          },
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [],
        "id": "6d8215bb-e0ed-4545-a80b-d9e6188ba188",
        "rule_id": "9d302377-d226-4e12-b54c-1906b5aec4f6",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:33.532Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:14.258Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "machine_learning",
        "anomaly_threshold": 50,
        "machine_learning_job_id": [
          "v3_linux_rare_metadata_process"
        ]
      },
      {
        "name": "Potential Protocol Tunneling via EarthWorm",
        "description": "Identifies the execution of the EarthWorm tunneler. Adversaries may tunnel network communications to and from a victim system within a separate protocol to avoid detection and network filtering, or to enable access to otherwise unreachable systems.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Potential Protocol Tunneling via EarthWorm\n\nAttackers can leverage `earthworm` to clandestinely tunnel network communications and evade security measures, potentially gaining unauthorized access to sensitive systems.\n\nThis rule looks for several command line arguments that are consistent with `earthworm` tunneling behavior. \n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n> This investigation guide uses [placeholder fields](https://www.elastic.co/guide/en/security/current/osquery-placeholder-fields.html) to dynamically pass alert data into Osquery queries. Placeholder fields were introduced in Elastic Stack version 8.7.0. If you're using Elastic Stack version 8.6.0 or earlier, you'll need to manually adjust this investigation guide's queries to ensure they properly run.\n\n#### Possible investigation steps\n\n- Identify any signs of suspicious network activity or anomalies that may indicate protocol tunneling. This could include unexpected traffic patterns or unusual network behavior.\n  - Investigate listening ports and open sockets to look for potential protocol tunneling, reverse shells, or data exfiltration.\n    - !{osquery{\"label\":\"Osquery - Retrieve Listening Ports\",\"query\":\"SELECT pid, address, port, socket, protocol, path FROM listening_ports\"}}\n    - !{osquery{\"label\":\"Osquery - Retrieve Open Sockets\",\"query\":\"SELECT pid, family, remote_address, remote_port, socket, state FROM process_open_sockets\"}}\n- Identify the user account that performed the action, analyze it, and check whether it should perform this kind of action.\n  - !{osquery{\"label\":\"Osquery - Retrieve Information for a Specific User\",\"query\":\"SELECT * FROM users WHERE username = {{user.name}}\"}}\n- Investigate whether the user is currently logged in and active.\n  - !{osquery{\"label\":\"Osquery - Investigate the Account Authentication Status\",\"query\":\"SELECT * FROM logged_in_users WHERE user = {{user.name}}\"}}\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence and whether they are located in expected locations.\n  - !{osquery{\"label\":\"Osquery - Retrieve Running Processes by User\",\"query\":\"SELECT pid, username, name FROM processes p JOIN users u ON u.uid = p.uid ORDER BY username\"}}\n  - !{osquery{\"label\":\"Osquery - Retrieve Process Info\",\"query\":\"SELECT name, cmdline, parent, path, uid FROM processes\"}}\n- Investigate other alerts associated with the user/host during the past 48 hours.\n  - If scripts or executables were dropped, retrieve the files and determine if they are malicious:\n    - Use a private sandboxed malware analysis system to perform analysis.\n      - Observe and collect information about the following activities:\n        - Attempts to contact external domains and addresses.\n          - Check if the domain is newly registered or unexpected.\n          - Check the reputation of the domain or IP address.\n        - File access, modification, and creation activities.\n\n### Related rules\n\n- Potential Protocol Tunneling via Chisel Client - 3f12325a-4cc6-410b-8d4c-9fbbeb744cfd\n- Potential Protocol Tunneling via Chisel Server - ac8805f6-1e08-406c-962e-3937057fa86f\n- Potential Linux Tunneling and/or Port Forwarding - 6ee947e9-de7e-4281-a55d-09289bdf947e\n\n### False positive analysis\n\n- If this activity is related to new benign software installation activity, consider adding exceptions â€” preferably with a combination of user and command line conditions.\n- If this activity is related to a system administrator or developer who uses port tunneling for benign purposes, consider adding exceptions for specific user accounts or hosts. \n- Try to understand the context of the execution by thinking about the user, machine, or business purpose. A small number of endpoints, such as servers with unique software, might appear unusual but satisfy a specific business need.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors, such as reverse shells, reverse proxies, or droppers, that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Leverage the incident response data and logging to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 110,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Command and Control",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "http://rootkiter.com/EarthWorm/",
          "https://decoded.avast.io/luigicamastra/apt-group-targeting-governmental-agencies-in-east-asia/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            },
            "technique": [
              {
                "id": "T1572",
                "name": "Protocol Tunneling",
                "reference": "https://attack.mitre.org/techniques/T1572/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in either from Elastic Defend, or Auditbeat integration.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n### Auditbeat Setup\nAuditbeat is a lightweight shipper that you can install on your servers to audit the activities of users and processes on your systems. For example, you can use Auditbeat to collect and centralize audit events from the Linux Audit Framework. You can also use Auditbeat to detect changes to critical files, like binaries and configuration files, and identify potential security policy violations.\n\n#### The following steps should be executed in order to add the Auditbeat on a Linux System:\n- Elastic provides repositories available for APT and YUM-based distributions. Note that we provide binary packages, but no source packages.\n- To install the APT and YUM repositories follow the setup instructions in this [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/setup-repositories.html).\n- To run Auditbeat on Docker follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/running-on-docker.html).\n- To run Auditbeat on Kubernetes follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/running-on-kubernetes.html).\n- For complete â€œSetup and Run Auditbeatâ€ information refer to the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/setting-up-and-running.html).\n\n#### Custom Ingest Pipeline\nFor versions <8.2, you need to add a custom ingest pipeline to populate `event.ingested` with @timestamp for non-elastic-agent indexes, like auditbeats/filebeat/winlogbeat etc. For more details to add a custom ingest pipeline refer to the [guide](https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "2d58838d-d935-476e-9dcd-bf0dd087c558",
        "rule_id": "9f1c4ca3-44b5-481d-ba42-32dc215a2769",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:33.534Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:14.262Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and\n process.args : \"-s\" and process.args : \"-d\" and process.args : \"rssocks\"",
        "language": "eql",
        "index": [
          "auditbeat-*",
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "First Time Seen AWS Secret Value Accessed in Secrets Manager",
        "description": "An adversary with access to a compromised AWS service such as an EC2 instance, Lambda function, or other service may attempt to leverage the compromised service to access secrets in AWS Secrets Manager. This rule looks for the first time a specific user identity has programmatically retrieved a secret value from Secrets Manager using the `GetSecretValue` or `BatchGetSecretValue` actions. This rule assumes that AWS services such as Lambda functions and EC2 instances are setup with IAM role's assigned that have the necessary permissions to access the secrets in Secrets Manager. An adversary with access to a compromised AWS service such as an EC2 instance, Lambda function, or other service would rely on the compromised service's IAM role to access the secrets in Secrets Manager.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating First Time Seen AWS Secret Value Accessed in Secrets Manager\n\nAWS Secrets Manager is a service that enables the replacement of hardcoded credentials in code, including passwords, with an API call to Secrets Manager to retrieve the secret programmatically.\n\nThis rule looks for the retrieval of credentials using `GetSecretValue` action in Secrets Manager programmatically. This is a [New Terms](https://www.elastic.co/guide/en/security/master/rules-ui-create.html#create-new-terms-rule) rule indicating this is the first time a specific user identity has successfuly retrieved a specific secret value from Secrets Manager within the last 15 days.\n\n#### Possible investigation steps\n\n- Identify the account and its role in the environment, and inspect the related policy.\n- Identify the applications that should use this account.\n- Investigate other alerts associated with the user account during the past 48 hours.\n- Investigate abnormal values in the `user_agent.original` field by comparing them with the intended and authorized usage and historical data. Suspicious user agent values include non-SDK, AWS CLI, custom user agents, etc.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences involving other users.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Considering the source IP address and geolocation of the user who issued the command:\n    - Do they look normal for the calling user?\n    - If the source is an EC2 IP address, is it associated with an EC2 instance in one of your accounts or is the source IP from an EC2 instance that's not under your control?\n    - If it is an authorized EC2 instance, is the activity associated with normal behavior for the instance role or roles? Are there any other alerts or signs of suspicious activity involving this instance?\n- Review IAM permission policies for the user identity and specific secrets accessed.\n- Examine the request parameters. These might indicate the source of the program or the nature of its tasks.\n- If you suspect the account has been compromised, scope potentially compromised assets by tracking servers, services, and data accessed by the account in the last 24 hours.\n\n### False positive analysis\n\n- False positives may occur due to the intended usage of the service. Tuning is needed in order to have higher confidence. Consider adding exceptions â€” preferably with a combination of user agent and IP address conditions.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Disable or limit the account during the investigation and response.\n- Identify the possible impact of the incident and prioritize accordingly; the following actions can help you gain context:\n    - Identify the account role in the cloud environment.\n    - Assess the criticality of affected services and servers.\n    - Work with your IT team to identify and minimize the impact on users.\n    - Identify if the attacker is moving laterally and compromising other accounts, servers, or services.\n    - Identify any regulatory or legal ramifications related to this activity.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Rotate secrets or delete API keys as needed to revoke the attacker's access to the environment. Work with your IT teams to minimize the impact on business operations during these actions.\n- Check if unauthorized new users were created, remove unauthorized new accounts, and request password resets for other IAM users.\n- Consider enabling multi-factor authentication for users.\n- Review the permissions assigned to the implicated user to ensure that the least privilege principle is being followed.\n- Implement security best practices [outlined](https://aws.amazon.com/premiumsupport/knowledge-center/security-best-practices/) by AWS.\n- Take the actions needed to return affected systems, data, or services to their normal operational levels.\n- Identify the initial vector abused by the attacker and take action to prevent reinfection via the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 312,
        "tags": [
          "Domain: Cloud",
          "Data Source: AWS",
          "Data Source: Amazon Web Services",
          "Data Source: AWS Secrets Manager",
          "Tactic: Credential Access",
          "Resources: Investigation Guide"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-3600s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Nick Jones",
          "Elastic"
        ],
        "false_positives": [
          "Verify whether the user identity, user agent, and/or hostname should be using GetSecretString API for the specified SecretId. If known behavior is causing false positives, it can be exempted from the rule."
        ],
        "references": [
          "https://docs.aws.amazon.com/secretsmanager/latest/apireference/API_GetSecretValue.html",
          "https://detectioninthe.cloud/ttps/credential_access/access_secret_in_secrets_manager/",
          "https://docs.aws.amazon.com/secretsmanager/latest/apireference/API_BatchGetSecretValue.html",
          "https://cloud.hacktricks.xyz/pentesting-cloud/aws-security/aws-services/aws-secrets-manager-enum"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1555",
                "name": "Credentials from Password Stores",
                "reference": "https://attack.mitre.org/techniques/T1555/",
                "subtechnique": [
                  {
                    "id": "T1555.006",
                    "name": "Cloud Secrets Management Stores",
                    "reference": "https://attack.mitre.org/techniques/T1555/006/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "aws",
            "version": "^2.0.0",
            "integration": "cloudtrail"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user_agent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "55653910-0a63-4bf7-adcf-ecdb9a3dd84a",
        "rule_id": "a00681e3-9ed6-447c-ab2c-be648821c622",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:33.536Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:07.137Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "event.dataset:aws.cloudtrail and event.provider:secretsmanager.amazonaws.com and\n    event.action: (GetSecretValue or BatchGetSecretValue) and event.outcome:success and\n    not user_agent.name: (\"Chrome\" or \"Firefox\" or \"Safari\" or \"Edge\" or \"Brave\" or \"Opera\")",
        "new_terms_fields": [
          "user.id"
        ],
        "history_window_start": "now-10d",
        "index": [
          "filebeat-*",
          "logs-aws.cloudtrail-*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "InstallUtil Process Making Network Connections",
        "description": "Identifies InstallUtil.exe making outbound network connections. This may indicate adversarial activity as InstallUtil is often leveraged by adversaries to execute code and evade detection.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 207,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1218",
                "name": "System Binary Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1218/",
                "subtechnique": [
                  {
                    "id": "T1218.004",
                    "name": "InstallUtil",
                    "reference": "https://attack.mitre.org/techniques/T1218/004/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "network.direction",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "03a0db54-395d-4513-8c87-c5990013c493",
        "rule_id": "a13167f1-eec2-4015-9631-1fee60406dcf",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:33.537Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:14.270Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "/* the benefit of doing this as an eql sequence vs kql is this will limit to alerting only on the first network connection */\n\nsequence by process.entity_id\n  [process where host.os.type == \"windows\" and event.type == \"start\" and process.name : \"installutil.exe\"]\n  [network where host.os.type == \"windows\" and process.name : \"installutil.exe\" and network.direction : (\"outgoing\", \"egress\")]",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "logs-endpoint.events.network-*",
          "winlogbeat-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "Potential LSASS Clone Creation via PssCaptureSnapShot",
        "description": "Identifies the creation of an LSASS process clone via PssCaptureSnapShot where the parent process is the initial LSASS process instance. This may indicate an attempt to evade detection and dump LSASS memory for credential access.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 208,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Data Source: Sysmon",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.matteomalvica.com/blog/2019/12/02/win-defender-atp-cred-bypass/",
          "https://medium.com/@Achilles8284/the-birth-of-a-process-part-2-97c6fb9c42a2"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1003",
                "name": "OS Credential Dumping",
                "reference": "https://attack.mitre.org/techniques/T1003/",
                "subtechnique": [
                  {
                    "id": "T1003.001",
                    "name": "LSASS Memory",
                    "reference": "https://attack.mitre.org/techniques/T1003/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis is meant to run only on datasources using Windows security event 4688 that captures the process clone creation.\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.code",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "ae01fa11-1fe8-46fd-b39c-13bbe755d5c3",
        "rule_id": "a16612dd-b30e-4d41-86a0-ebe70974ec00",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:33.539Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:14.285Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.code:\"4688\" and\n  process.executable : \"?:\\\\Windows\\\\System32\\\\lsass.exe\" and\n  process.parent.executable : \"?:\\\\Windows\\\\System32\\\\lsass.exe\"",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-system.*",
          "logs-windows.*"
        ],
        "filters": []
      },
      {
        "name": "Windows Subsystem for Linux Distribution Installed",
        "description": "Detects changes to the registry that indicates the install of a new Windows Subsystem for Linux distribution by name. Adversaries may enable and use WSL for Linux to avoid detection.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "timeline_id": "3e47ef71-ebfc-4520-975c-cb27fc090799",
        "timeline_title": "Comprehensive Registry Timeline",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Windows Subsystem for Linux Distribution Installed\n\nThe Windows Subsystem for Linux (WSL) lets developers install a Linux distribution (such as Ubuntu, OpenSUSE, Kali, Debian, Arch Linux, etc) and use Linux applications, utilities, and Bash command-line tools directly on Windows, unmodified, without the overhead of a traditional virtual machine or dualboot setup. Attackers may abuse WSL to avoid security protections on a Windows host and perform a wide range of attacks.\n\nThis rule identifies the installation of a new Windows Subsystem for Linux distribution via registry events.\n\n### Possible investigation steps\n\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Examine which distribution was installed. Some distributions such as Kali Linux can facilitate the compromise of the environment.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Validate that the activity is not related to planned patches, updates, network administrator activity, or legitimate software installations.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n\n### False positive analysis\n\n- This is a dual-use tool, meaning its usage is not inherently malicious. Analysts can dismiss the alert if the administrator is aware of the activity, no other suspicious activity was identified, and the WSL distribution is homologated and approved in the environment.\n\n### Related Rules\n\n- Host Files System Changes via Windows Subsystem for Linux - e88d1fe9-b2f4-48d4-bace-a026dc745d4b\n- Execution via Windows Subsystem for Linux - db7dbad5-08d2-4d25-b9b1-d3a1e4a15efd\n- Suspicious Execution via Windows Subsystem for Linux - 3e0eeb75-16e8-4f2f-9826-62461ca128b7\n- Windows Subsystem for Linux Enabled via Dism Utility - e2e0537d-7d8f-4910-a11d-559bcf61295a\n\n### Response and Remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 208,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: SentinelOne"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://learn.microsoft.com/en-us/windows/wsl/wsl-config"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1112",
                "name": "Modify Registry",
                "reference": "https://attack.mitre.org/techniques/T1112/"
              },
              {
                "id": "T1202",
                "name": "Indirect Command Execution",
                "reference": "https://attack.mitre.org/techniques/T1202/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.value",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "ece723cf-1c99-403f-8977-6947d117c6f5",
        "rule_id": "a1699af0-8e1e-4ed0-8ec1-89783538a061",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:33.541Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:14.289Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "registry where host.os.type == \"windows\" and event.type == \"change\" and registry.value : \"PackageFamilyName\" and\n registry.path : \"*\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Lxss\\\\*\\\\PackageFamilyName\"",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.registry-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*"
        ],
        "filters": []
      },
      {
        "name": "My First Rule",
        "description": "This rule helps you test and practice using alerts with Elastic Security as you get set up. Itâ€™s not a sign of threat activity.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "This is a test alert.\n\nThis alert does not show threat activity. Elastic created this alert to help you understand how alerts work.\n\nFor normal rules, the Investigation Guide will help analysts investigate alerts.\n\nThis alert will show once every 24 hours for each host. It is safe to disable this rule.\n",
        "output_index": "",
        "version": 3,
        "tags": [
          "Use Case: Guided Onboarding"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "24h",
        "from": "now-86400s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "This rule is not looking for threat activity. Disable the rule if you're already familiar with alerts."
        ],
        "references": [
          "https://www.elastic.co/guide/en/security/current/prebuilt-rules.html"
        ],
        "max_signals": 1,
        "threat": [],
        "setup": "",
        "related_integrations": [],
        "required_fields": [
          {
            "name": "event.kind",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "645111ae-b6c9-4168-907f-aacf39432936",
        "rule_id": "a198fbbd-9413-45ec-a269-47ae4ccf59ce",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": true
        },
        "updated_at": "2024-12-13T19:42:33.543Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:14.297Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "threshold",
        "query": "event.kind:event",
        "threshold": {
          "field": [
            "host.name"
          ],
          "value": 1
        },
        "index": [
          "auditbeat-*",
          "filebeat-*",
          "logs-*",
          "winlogbeat-*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Potential Reverse Shell Activity via Terminal",
        "description": "Identifies the execution of a shell process with suspicious arguments which may be indicative of reverse shell activity.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Potential Reverse Shell Activity via Terminal\n\nA reverse shell is a mechanism that's abused to connect back to an attacker-controlled system. It effectively redirects the system's input and output and delivers a fully functional remote shell to the attacker. Even private systems are vulnerable since the connection is outgoing. This activity is typically the result of vulnerability exploitation, malware infection, or penetration testing.\n\nThis rule identifies commands that are potentially related to reverse shell activities using shell applications.\n\n#### Possible investigation steps\n\n- Examine the command line and extract the target domain or IP address information.\n  - Check if the domain is newly registered or unexpected.\n  - Check the reputation of the domain or IP address.\n  - Scope other potentially compromised hosts in your environment by mapping hosts that also communicated with the domain or IP address.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate any abnormal account behavior, such as command executions, file creations or modifications, and network connections.\n- Investigate any abnormal behavior by the subject process such as network connections, file modifications, and any spawned child processes.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Any activity that triggered the alert and is not inherently malicious must be monitored by the security team.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Take actions to terminate processes and connections used by the attacker.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 109,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "OS: macOS",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Reverse%20Shell%20Cheatsheet.md",
          "https://github.com/WangYihang/Reverse-Shell-Manager",
          "https://www.netsparker.com/blog/web-security/understanding-reverse-shells/",
          "https://www.elastic.co/security-labs/detecting-log4j2-with-elastic-security"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "b6eaa878-a82b-40b5-9ce4-a2feb01b015a",
        "rule_id": "a1a0375f-22c2-48c0-81a4-7c2d11cc6856",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:33.544Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:14.301Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where event.type in (\"start\", \"process_started\") and\n  process.name in (\"sh\", \"bash\", \"zsh\", \"dash\", \"zmodload\") and\n  process.args : (\"*/dev/tcp/*\", \"*/dev/udp/*\", \"*zsh/net/tcp*\", \"*zsh/net/udp*\") and\n\n  /* noisy FPs */\n  not (process.parent.name : \"timeout\" and process.executable : \"/var/lib/docker/overlay*\") and\n  not process.command_line : (\n    \"*/dev/tcp/sirh_db/*\", \"*/dev/tcp/remoteiot.com/*\", \"*dev/tcp/elk.stag.one/*\", \"*dev/tcp/kafka/*\",\n    \"*/dev/tcp/$0/$1*\", \"*/dev/tcp/127.*\", \"*/dev/udp/127.*\", \"*/dev/tcp/localhost/*\", \"*/dev/tcp/itom-vault/*\") and\n  not process.parent.command_line : \"runc init\"",
        "language": "eql",
        "index": [
          "auditbeat-*",
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "DNS-over-HTTPS Enabled via Registry",
        "description": "Identifies when a user enables DNS-over-HTTPS. This can be used to hide internet activity or the process of exfiltrating data. With this enabled, an organization will lose visibility into data such as query type, response, and originating IP, which are used to determine bad actors.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 311,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: SentinelOne"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Austin Songer"
        ],
        "false_positives": [],
        "references": [
          "https://www.tenforums.com/tutorials/151318-how-enable-disable-dns-over-https-doh-microsoft-edge.html",
          "https://chromeenterprise.google/policies/?policy=DnsOverHttpsMode"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1112",
                "name": "Modify Registry",
                "reference": "https://attack.mitre.org/techniques/T1112/"
              },
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.data.strings",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "registry.path",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "502e0825-a444-475f-b94d-7639af5af4ae",
        "rule_id": "a22a09c2-2162-4df0-a356-9aacbeb56a04",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:33.546Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:14.309Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n  (registry.path : \"*\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Edge\\\\BuiltInDnsClientEnabled\" and\n  registry.data.strings : (\"1\", \"0x00000001\")) or\n  (registry.path : \"*\\\\SOFTWARE\\\\Google\\\\Chrome\\\\DnsOverHttpsMode\" and\n  registry.data.strings : \"secure\") or\n  (registry.path : \"*\\\\SOFTWARE\\\\Policies\\\\Mozilla\\\\Firefox\\\\DNSOverHTTPS\" and\n  registry.data.strings : (\"1\", \"0x00000001\"))",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.registry-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*"
        ],
        "filters": []
      },
      {
        "name": "Google Workspace Restrictions for Marketplace Modified to Allow Any App",
        "description": "Detects when the Google Marketplace restrictions are changed to allow any application for users in Google Workspace. Malicious APKs created by adversaries may be uploaded to the Google marketplace but not installed on devices managed within Google Workspace. Administrators should set restrictions to not allow any application from the marketplace for security reasons. Adversaries may enable any app to be installed and executed on mobile devices within a Google Workspace environment prior to distributing the malicious APK to the end user.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Google Workspace Restrictions for Marketplace Modified to Allow Any App\n\nGoogle Workspace Marketplace is an online store for free and paid web applications that work with Google Workspace services and third-party software. Listed applications are based on Google APIs or Google Apps Script and created by both Google and third-party developers.\n\nMarketplace applications require access to specific Google Workspace resources. Applications can be installed by individual users, if they have permission, or can be installed for an entire Google Workspace domain by administrators. Consent screens typically display what permissions and privileges the application requires during installation. As a result, malicious Marketplace applications may require more permissions than necessary or have malicious intent.\n\nGoogle clearly states that they are not responsible for any product on the Marketplace that originates from a source other than Google.\n\nThis rule identifies when the global allow-all setting is enabled for Google Workspace Marketplace applications.\n\n#### Possible investigation steps\n\n- Identify the associated user accounts by reviewing `user.name` or `user.email` fields in the alert.\n- This rule relies on data from `google_workspace.admin`, thus indicating the associated user has administrative privileges to the Marketplace.\n- Search for `event.action` is `ADD_APPLICATION` to identify applications installed after these changes were made.\n    - The `google_workspace.admin.application.name` field will help identify what applications were added.\n- With the user account, review other potentially related events within the last 48 hours.\n- Re-assess the permissions and reviews of the Marketplace applications to determine if they violate organizational policies or introduce unexpected risks.\n- With access to the Google Workspace admin console, determine if the application was installed domain-wide or individually by visiting `Apps > Google Workspace Marketplace Apps`.\n\n### False positive analysis\n\n- Identify the user account associated with this action and assess their administrative privileges with Google Workspace Marketplace.\n- Google Workspace administrators may intentionally add an application from the marketplace based on organizational needs.\n    - Follow up with the user who added the application to ensure this was intended.\n- Verify the application identified has been assessed thoroughly by an administrator.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Disable or limit the account during the investigation and response.\n- Identify the possible impact of the incident and prioritize accordingly; the following actions can help you gain context:\n    - Identify the account role in the cloud environment.\n    - Assess the criticality of affected services and servers.\n    - Work with your IT team to identify and minimize the impact on users.\n    - Identify if the attacker is moving laterally and compromising other accounts, servers, or services.\n    - Identify any regulatory or legal ramifications related to this activity.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords or delete API keys as needed to revoke the attacker's access to the environment. Work with your IT teams to minimize the impact on business operations during these actions.\n- Review the permissions assigned to the implicated user to ensure that the least privilege principle is being followed.\n- Implement security best practices [outlined](https://support.google.com/a/answer/7587183) by Google.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection via the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n\n\n\n### Important Information Regarding Google Workspace Event Lag Times\n- As per Google's documentation, Google Workspace administrators may observe lag times ranging from minutes up to 3 days between the time of an event's occurrence and the event being visible in the Google Workspace admin/audit logs.\n- To reduce the risk of false negatives, consider reducing the interval that the Google Workspace (formerly G Suite) Filebeat module polls Google's reporting API for new events.\n- By default, `var.interval` is set to 2 hours (2h). Consider changing this interval to a lower value, such as 10 minutes (10m).\n- See the following references for further information:\n  - https://support.google.com/a/answer/7061566\n  - https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-module-google_workspace.html",
        "output_index": "",
        "version": 108,
        "tags": [
          "Domain: Cloud",
          "Data Source: Google Workspace",
          "Use Case: Configuration Audit",
          "Tactic: Defense Evasion",
          "Resources: Investigation Guide"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Applications can be added and removed from blocklists by Google Workspace administrators, but they can all be explicitly allowed for users. Verify that the configuration change was expected. Exceptions can be added to this rule to filter expected behavior."
        ],
        "references": [
          "https://support.google.com/a/answer/6089179?hl=en",
          "https://www.elastic.co/security-labs/google-workspace-attack-surface-part-one",
          "https://www.elastic.co/security-labs/google-workspace-attack-surface-part-two"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.001",
                    "name": "Disable or Modify Tools",
                    "reference": "https://attack.mitre.org/techniques/T1562/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The Google Workspace Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "google_workspace",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "google_workspace.admin.application.name",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "google_workspace.admin.new_value",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "google_workspace.admin.setting.name",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "google_workspace.event.type",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "4d116e93-99c9-4752-8dfc-0b840ff71624",
        "rule_id": "a2795334-2499-11ed-9e1a-f661ea17fbce",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:33.548Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:06.926Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-google_workspace*"
        ],
        "filters": [],
        "query": "event.dataset:\"google_workspace.admin\" and event.action:\"CHANGE_APPLICATION_SETTING\" and event.category:(iam or configuration)\n    and google_workspace.event.type:\"APPLICATION_SETTINGS\" and google_workspace.admin.application.name:\"Google Workspace Marketplace\"\n        and google_workspace.admin.setting.name:\"Apps Access Setting Allowlist access\"  and google_workspace.admin.new_value:\"ALLOW_ALL\"",
        "language": "kuery"
      },
      {
        "name": "Execution via local SxS Shared Module",
        "description": "Identifies the creation, change, or deletion of a DLL module within a Windows SxS local folder. Adversaries may abuse shared modules to execute malicious payloads by instructing the Windows module loader to load DLLs from arbitrary local paths.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\nThe SxS DotLocal folder is a legitimate feature that can be abused to hijack standard modules loading order by forcing an executable on the same application.exe.local folder to load a malicious DLL module from the same directory.\n",
        "output_index": "",
        "version": 308,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: SentinelOne"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://docs.microsoft.com/en-us/windows/win32/dlls/dynamic-link-library-redirection"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1129",
                "name": "Shared Modules",
                "reference": "https://attack.mitre.org/techniques/T1129/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "8ff21a4f-2527-4dd2-95b9-828a66dfa47d",
        "rule_id": "a3ea12f3-0d4e-4667-8b44-4230c63f3c75",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:33.550Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:14.322Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"windows\" and file.extension : \"dll\" and file.path : \"C:\\\\*\\\\*.exe.local\\\\*.dll\"",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.file-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*"
        ],
        "filters": []
      },
      {
        "name": "Windows Registry File Creation in SMB Share",
        "description": "Identifies the creation or modification of a medium-size registry hive file on a Server Message Block (SMB) share, which may indicate an exfiltration attempt of a previously dumped Security Account Manager (SAM) registry hive for credential extraction on an attacker-controlled system.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Windows Registry File Creation in SMB Share\n\nDumping registry hives is a common way to access credential information. Some hives store credential material, as is the case for the SAM hive, which stores locally cached credentials (SAM secrets), and the SECURITY hive, which stores domain cached credentials (LSA secrets). Dumping these hives in combination with the SYSTEM hive enables the attacker to decrypt these secrets.\n\nAttackers can try to evade detection on the host by transferring this data to a system that is not monitored to be parsed and decrypted. This rule identifies the creation or modification of a medium-size registry hive file on an SMB share, which may indicate this kind of exfiltration attempt.\n\n#### Possible investigation steps\n\n- Investigate other alerts associated with the user/source host during the past 48 hours.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Inspect the source host for suspicious or abnormal behaviors in the alert timeframe.\n- Capture the registry file(s) to determine the extent of the credential compromise in an eventual incident response.\n\n### False positive analysis\n\n- Administrators can export registry hives for backup purposes. Check whether the user should be performing this kind of activity and is aware of it.\n\n### Related rules\n\n- Credential Acquisition via Registry Hive Dumping - a7e7bfa3-088e-4f13-b29e-3986e0e756b8\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Reimage the host operating system and restore compromised files to clean versions.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 109,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Lateral Movement",
          "Tactic: Credential Access",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/security-labs/detect-credential-access"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1003",
                "name": "OS Credential Dumping",
                "reference": "https://attack.mitre.org/techniques/T1003/",
                "subtechnique": [
                  {
                    "id": "T1003.002",
                    "name": "Security Account Manager",
                    "reference": "https://attack.mitre.org/techniques/T1003/002/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1021",
                "name": "Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1021/",
                "subtechnique": [
                  {
                    "id": "T1021.002",
                    "name": "SMB/Windows Admin Shares",
                    "reference": "https://attack.mitre.org/techniques/T1021/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.Ext.header_bytes",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.size",
            "type": "long",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pid",
            "type": "long",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "108ff8ef-3915-4559-9822-fe64c8594e31",
        "rule_id": "a4c7473a-5cb4-4bc1-9d06-e4a75adbc494",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:33.551Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:14.326Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"windows\" and event.type == \"creation\" and\n /* regf file header */\n file.Ext.header_bytes : \"72656766*\" and file.size >= 30000 and\n process.pid == 4 and user.id : (\"S-1-5-21*\", \"S-1-12-1-*\") and\n not file.path : (\n    \"?:\\\\*\\\\UPM_Profile\\\\NTUSER.DAT\",\n    \"?:\\\\*\\\\UPM_Profile\\\\NTUSER.DAT.LASTGOOD.LOAD\",\n    \"?:\\\\*\\\\UPM_Profile\\\\AppData\\\\Local\\\\Microsoft\\\\Windows\\\\UsrClass.dat*\",\n    \"?:\\\\Windows\\\\Netwrix\\\\Temp\\\\????????.???.offreg\",\n    \"?:\\\\*\\\\AppData\\\\Local\\\\Packages\\\\Microsoft.*\\\\Settings\\\\settings.dat*\"\n )",
        "language": "eql",
        "index": [
          "logs-endpoint.events.file-*"
        ],
        "filters": []
      },
      {
        "name": "AWS IAM Assume Role Policy Update",
        "description": "Identifies attempts to modify an AWS IAM Assume Role Policy. An adversary may attempt to modify the AssumeRolePolicy of a misconfigured role in order to gain the privileges of that role.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating AWS IAM Assume Role Policy Update\n\nAn IAM role is an IAM identity that you can create in your account that has specific permissions. An IAM role is similar to an IAM user, in that it is an AWS identity with permission policies that determine what the identity can and cannot do in AWS. However, instead of being uniquely associated with one person, a role is intended to be assumable by anyone who needs it. Also, a role does not have standard long-term credentials such as a password or access keys associated with it. Instead, when you assume a role, it provides you with temporary security credentials for your role session.\n\nThe role trust policy is a JSON document in which you define the principals you trust to assume the role. This policy is a required resource-based policy that is attached to a role in IAM. An attacker may attempt to modify this policy by using the `UpdateAssumeRolePolicy` API action to gain the privileges of that role.\n\n#### Possible investigation steps\n\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Investigate other alerts associated with the user account during the past 48 hours.\n- Contact the account and resource owners and confirm whether they are aware of this activity.\n- Check if this operation was approved and performed according to the organization's change management policy.\n- If you suspect the account has been compromised, scope potentially compromised assets by tracking servers, services, and data accessed by the account in the last 24 hours.\n\n### False positive analysis\n\n- False positives may occur due to the intended usage of the service. Tuning is needed in order to have higher confidence. Consider adding exceptions â€” preferably with a combination of the user agent and user ID conditions â€” to cover administrator activities and infrastructure as code tooling.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Disable or limit the account during the investigation and response.\n- Identify the possible impact of the incident and prioritize accordingly; the following actions can help you gain context:\n    - Identify the account role in the cloud environment.\n    - Assess the criticality of affected services and servers.\n    - Work with your IT team to identify and minimize the impact on users.\n    - Identify if the attacker is moving laterally and compromising other accounts, servers, or services.\n    - Identify any regulatory or legal ramifications related to this activity.\n- Use AWS [policy versioning](https://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies_managed-versioning.html) to restore the trust policy to the desired state.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords or delete API keys as needed to revoke the attacker's access to the environment. Work with your IT teams to minimize the impact on business operations during these actions.\n- Check if unauthorized new users were created, remove unauthorized new accounts, and request password resets for other IAM users.\n- Consider enabling multi-factor authentication for users.\n- Review the permissions assigned to the implicated user to ensure that the least privilege principle is being followed.\n- Implement security best practices [outlined](https://aws.amazon.com/premiumsupport/knowledge-center/security-best-practices/) by AWS.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection via the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).",
        "output_index": "",
        "version": 209,
        "tags": [
          "Domain: Cloud",
          "Data Source: AWS",
          "Data Source: Amazon Web Services",
          "Data Source: AWS STS",
          "Use Case: Identity and Access Audit",
          "Resources: Investigation Guide",
          "Tactic: Privilege Escalation"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-3600s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. Policy updates from unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule."
        ],
        "references": [
          "https://labs.bishopfox.com/tech-blog/5-privesc-attack-vectors-in-aws"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1078",
                "name": "Valid Accounts",
                "reference": "https://attack.mitre.org/techniques/T1078/"
              }
            ]
          }
        ],
        "setup": "The AWS Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "aws",
            "version": "^2.0.0",
            "integration": "cloudtrail"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "30a1b75a-fdae-4bd6-81c1-d559f37e8912",
        "rule_id": "a60326d7-dca7-4fb7-93eb-1ca03a1febbd",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:33.553Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:14.334Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-aws.cloudtrail-*"
        ],
        "filters": [],
        "query": "event.dataset:aws.cloudtrail and event.provider:iam.amazonaws.com and event.action:UpdateAssumeRolePolicy and event.outcome:success",
        "language": "kuery"
      },
      {
        "name": "Suspicious MS Office Child Process",
        "description": "Identifies suspicious child processes of frequently targeted Microsoft Office applications (Word, PowerPoint, Excel). These child processes are often launched during exploitation of Office applications or from documents with malicious macros.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Suspicious MS Office Child Process\n\nMicrosoft Office (MS Office) is a suite of applications designed to help with productivity and completing common tasks on a computer. You can create and edit documents containing text and images, work with data in spreadsheets and databases, and create presentations and posters. As it is some of the most-used software across companies, MS Office is frequently targeted for initial access. It also has a wide variety of capabilities that attackers can take advantage of.\n\nThis rule looks for suspicious processes spawned by MS Office programs. This is generally the result of the execution of malicious documents.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Retrieve MS Office documents received and opened by the user that could cause this behavior. Common locations include, but are not limited to, the Downloads and Document folders and the folder configured at the email client.\n- Determine if the collected files are malicious:\n  - Use a private sandboxed malware analysis system to perform analysis.\n    - Observe and collect information about the following activities:\n      - Attempts to contact external domains and addresses.\n      - File and registry access, modification, and creation activities.\n      - Service creation and launch activities.\n      - Scheduled task creation.\n  - Use the PowerShell Get-FileHash cmdlet to get the files' SHA-256 hash values.\n    - Search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n  - If the malicious file was delivered via phishing:\n    - Block the email sender from sending future emails.\n    - Block the malicious web pages.\n    - Remove emails from the sender from mailboxes.\n    - Consider improvements to the security awareness program.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 314,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Initial Access",
          "Tactic: Defense Evasion",
          "Tactic: Execution",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/blog/vulnerability-summary-follina"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1566",
                "name": "Phishing",
                "reference": "https://attack.mitre.org/techniques/T1566/",
                "subtechnique": [
                  {
                    "id": "T1566.001",
                    "name": "Spearphishing Attachment",
                    "reference": "https://attack.mitre.org/techniques/T1566/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  },
                  {
                    "id": "T1059.003",
                    "name": "Windows Command Shell",
                    "reference": "https://attack.mitre.org/techniques/T1059/003/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1218",
                "name": "System Binary Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1218/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "8865199e-aece-45c2-b56a-6a60a07de133",
        "rule_id": "a624863f-a70d-417f-a7d2-7a404638d47f",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:33.555Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:14.345Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.parent.name : (\n      \"eqnedt32.exe\", \"excel.exe\", \"fltldr.exe\", \"msaccess.exe\",\n      \"mspub.exe\", \"powerpnt.exe\", \"winword.exe\", \"outlook.exe\"\n  ) and\n  process.name : (\n      \"Microsoft.Workflow.Compiler.exe\", \"arp.exe\", \"atbroker.exe\", \"bginfo.exe\", \"bitsadmin.exe\", \"cdb.exe\",\n      \"certutil.exe\", \"cmd.exe\", \"cmstp.exe\", \"control.exe\", \"cscript.exe\", \"csi.exe\", \"dnx.exe\", \"dsget.exe\",\n      \"dsquery.exe\", \"forfiles.exe\", \"fsi.exe\", \"ftp.exe\", \"gpresult.exe\", \"hostname.exe\", \"ieexec.exe\", \"iexpress.exe\",\n      \"installutil.exe\", \"ipconfig.exe\", \"mshta.exe\", \"msxsl.exe\", \"nbtstat.exe\", \"net.exe\", \"net1.exe\", \"netsh.exe\",\n      \"netstat.exe\", \"nltest.exe\", \"odbcconf.exe\", \"ping.exe\", \"powershell.exe\", \"pwsh.exe\", \"qprocess.exe\",\n      \"quser.exe\", \"qwinsta.exe\", \"rcsi.exe\", \"reg.exe\", \"regasm.exe\", \"regsvcs.exe\", \"regsvr32.exe\", \"sc.exe\",\n      \"schtasks.exe\", \"systeminfo.exe\", \"tasklist.exe\", \"tracert.exe\", \"whoami.exe\", \"wmic.exe\", \"wscript.exe\",\n      \"xwizard.exe\", \"explorer.exe\", \"rundll32.exe\", \"hh.exe\", \"msdt.exe\"\n  ) and\n  not (\n    process.parent.name : \"outlook.exe\" and\n    process.name : \"rundll32.exe\" and\n    process.args : \"shell32.dll,Control_RunDLL\" and\n    process.args : \"srchadmin.dll\"\n  )",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Emond Rules Creation or Modification",
        "description": "Identifies the creation or modification of the Event Monitor Daemon (emond) rules. Adversaries may abuse this service by writing a rule to execute commands when a defined event occurs, such as system start up or user authentication.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 107,
        "tags": [
          "Domain: Endpoint",
          "OS: macOS",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.xorrior.com/emond-persistence/",
          "https://www.sentinelone.com/blog/how-malware-persists-on-macos/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1546",
                "name": "Event Triggered Execution",
                "reference": "https://attack.mitre.org/techniques/T1546/",
                "subtechnique": [
                  {
                    "id": "T1546.014",
                    "name": "Emond",
                    "reference": "https://attack.mitre.org/techniques/T1546/014/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a macOS System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, for MacOS it is recommended to select \"Traditional Endpoints\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "f2cc24be-79d3-43a6-8fbf-6bc865fd4e55",
        "rule_id": "a6bf4dd4-743e-4da8-8c03-3ebd753a6c90",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:33.557Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:14.360Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"macos\" and event.type != \"deletion\" and\n file.path : (\"/private/etc/emond.d/rules/*.plist\", \"/etc/emon.d/rules/*.plist\", \"/private/var/db/emondClients/*\")",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious Print Spooler SPL File Created",
        "description": "Detects attempts to exploit privilege escalation vulnerabilities related to the Print Spooler service including CVE-2020-1048 and CVE-2020-1337.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Suspicious Print Spooler SPL File Created\n\nPrint Spooler is a Windows service enabled by default in all Windows clients and servers. The service manages print jobs by loading printer drivers, receiving files to be printed, queuing them, scheduling, etc.\n\nThe Print Spooler service has some known vulnerabilities that attackers can abuse to escalate privileges to SYSTEM, like CVE-2020-1048 and CVE-2020-1337. This rule looks for unusual processes writing SPL files to the location `?:\\Windows\\System32\\spool\\PRINTERS\\`, which is an essential step in exploiting these vulnerabilities.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate any abnormal behavior by the subject process such as network connections, registry or file modifications, and any spawned child processes.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Inspect the host for suspicious or abnormal behavior in the alert timeframe.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the process executable using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n\n### False positive analysis\n\n- If this activity is expected and noisy in your environment, consider adding exceptions â€” preferably with a combination of process executable and file conditions.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Ensure that the machine has the latest security updates and is not running legacy Windows versions.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 113,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Use Case: Vulnerability",
          "Data Source: Elastic Defend",
          "Data Source: Microsoft Defender for Endpoint"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://safebreach.com/Post/How-we-bypassed-CVE-2020-1048-Patch-and-got-CVE-2020-1337"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1068",
                "name": "Exploitation for Privilege Escalation",
                "reference": "https://attack.mitre.org/techniques/T1068/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "9aa26e75-5b7b-4b12-b100-8a3ba6c83f8a",
        "rule_id": "a7ccae7b-9d2c-44b2-a061-98e5946971fa",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:33.558Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:06.933Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"windows\" and event.type != \"deletion\" and\n  file.extension : \"spl\" and\n  file.path : \"?:\\\\Windows\\\\System32\\\\spool\\\\PRINTERS\\\\*\" and\n  not process.name : (\"spoolsv.exe\",\n                      \"printfilterpipelinesvc.exe\",\n                      \"PrintIsolationHost.exe\",\n                      \"splwow64.exe\",\n                      \"msiexec.exe\",\n                      \"poqexec.exe\",\n                      \"System\") and\n  not user.id : \"S-1-5-18\" and\n  not process.executable :\n            (\"?:\\\\Windows\\\\System32\\\\mmc.exe\",\n             \"\\\\Device\\\\Mup\\\\*.exe\",\n             \"?:\\\\Windows\\\\System32\\\\svchost.exe\",\n             \"?:\\\\Windows\\\\System32\\\\mmc.exe\",\n             \"?:\\\\Windows\\\\System32\\\\printui.exe\",\n             \"?:\\\\Windows\\\\System32\\\\mstsc.exe\",\n             \"?:\\\\Windows\\\\System32\\\\spool\\\\*.exe\",\n             \"?:\\\\Program Files\\\\*.exe\",\n             \"?:\\\\Program Files (x86)\\\\*.exe\",\n             \"?:\\\\PROGRA~1\\\\*.exe\",\n             \"?:\\\\PROGRA~2\\\\*.exe\",\n             \"?:\\\\Windows\\\\System32\\\\rundll32.exe\")",
        "language": "eql",
        "index": [
          "logs-endpoint.events.file-*",
          "endgame-*",
          "logs-m365_defender.event-*"
        ],
        "filters": []
      },
      {
        "name": "Credential Acquisition via Registry Hive Dumping",
        "description": "Identifies attempts to export a registry hive which may contain credentials using the Windows reg.exe tool.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Credential Acquisition via Registry Hive Dumping\n\nDumping registry hives is a common way to access credential information as some hives store credential material.\n\nFor example, the SAM hive stores locally cached credentials (SAM Secrets), and the SECURITY hive stores domain cached credentials (LSA secrets).\n\nDumping these hives in combination with the SYSTEM hive enables the attacker to decrypt these secrets.\n\nThis rule identifies the usage of `reg.exe` to dump SECURITY and/or SAM hives, which potentially indicates the compromise of the credentials stored in the host.\n\n#### Possible investigation steps\n\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate if the credential material was exfiltrated or processed locally by other tools.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (e.g., 4624) to the target host.\n\n### False positive analysis\n\n- Administrators can export registry hives for backup purposes using command line tools like `reg.exe`. Check whether the user is legitamitely performing this kind of activity.\n\n### Related rules\n\n- Registry Hive File Creation via SMB - a4c7473a-5cb4-4bc1-9d06-e4a75adbc494\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Reimage the host operating system and restore compromised files to clean versions.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 312,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: SentinelOne",
          "Data Source: Sysmon",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://medium.com/threatpunter/detecting-attempts-to-steal-passwords-from-the-registry-7512674487f8",
          "https://www.elastic.co/security-labs/detect-credential-access"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1003",
                "name": "OS Credential Dumping",
                "reference": "https://attack.mitre.org/techniques/T1003/",
                "subtechnique": [
                  {
                    "id": "T1003.002",
                    "name": "Security Account Manager",
                    "reference": "https://attack.mitre.org/techniques/T1003/002/"
                  },
                  {
                    "id": "T1003.004",
                    "name": "LSA Secrets",
                    "reference": "https://attack.mitre.org/techniques/T1003/004/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "65d2c31a-729d-4290-aeb1-38c6f9520762",
        "rule_id": "a7e7bfa3-088e-4f13-b29e-3986e0e756b8",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:33.560Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:14.363Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n (?process.pe.original_file_name == \"reg.exe\" or process.name : \"reg.exe\") and\n process.args : (\"save\", \"export\") and\n process.args : (\"hklm\\\\sam\", \"hklm\\\\security\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious File Downloaded from Google Drive",
        "description": "Identifies suspicious file download activity from a Google Drive URL. This could indicate an attempt to deliver phishing payloads via a trusted webservice.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 4,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "OS: Windows",
          "OS: macOS",
          "Use Case: Threat Detection",
          "Tactic: Command and Control",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Approved third-party applications that use Google Drive download URLs.",
          "Legitimate publicly shared files from Google Drive."
        ],
        "references": [
          "https://intelligence.abnormalsecurity.com/blog/google-drive-matanbuchus-malware"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            },
            "technique": [
              {
                "id": "T1105",
                "name": "Ingress Tool Transfer",
                "reference": "https://attack.mitre.org/techniques/T1105/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "1210dc3d-6c1c-4ff6-a6fa-f0ef7bee5c28",
        "rule_id": "a8afdce2-0ec1-11ee-b843-f661ea17fbcd",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:33.562Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:17.215Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where\n\n    /* common browser processes  */\n    event.action in (\"exec\", \"fork\", \"start\") and \n\n    process.name : (\"Microsoft Edge\", \"chrome.exe\", \"Google Chrome\", \"google-chrome-stable\", \n                    \"google-chrome-beta\", \"google-chrome\", \"msedge.exe\", \"firefox.exe\", \"brave.exe\", \n                    \"whale.exe\", \"browser.exe\", \"dragon.exe\", \"vivaldi.exe\", \"opera.exe\", \"firefox\", \n                    \"powershell.exe\", \"curl\", \"curl.exe\", \"wget\", \"wget.exe\") and \n\n    /* Look for Google Drive download URL with AV flag skipping */\n    (process.command_line : \"*drive.google.com*\" and process.command_line : \"*export=download*\" and process.command_line : \"*confirm=no_antivirus*\")",
        "language": "eql",
        "index": [
          "auditbeat-*",
          "logs-endpoint*",
          "logs-system.security*",
          "winlogbeat-*"
        ],
        "filters": []
      },
      {
        "name": "Persistence via Hidden Run Key Detected",
        "description": "Identifies a persistence mechanism that utilizes the NtSetValueKey native API to create a hidden (null terminated) registry key. An adversary may use this method to hide from system utilities such as the Registry Editor (regedit).",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 209,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Tactic: Defense Evasion",
          "Tactic: Execution",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/outflanknl/SharpHide",
          "https://github.com/ewhitehats/InvisiblePersistence/blob/master/InvisibleRegValues_Whitepaper.pdf"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1547",
                "name": "Boot or Logon Autostart Execution",
                "reference": "https://attack.mitre.org/techniques/T1547/",
                "subtechnique": [
                  {
                    "id": "T1547.001",
                    "name": "Registry Run Keys / Startup Folder",
                    "reference": "https://attack.mitre.org/techniques/T1547/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1106",
                "name": "Native API",
                "reference": "https://attack.mitre.org/techniques/T1106/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1112",
                "name": "Modify Registry",
                "reference": "https://attack.mitre.org/techniques/T1112/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.data.strings",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "registry.path",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "622f7b63-18d6-4bf6-9f90-5990aec9619b",
        "rule_id": "a9b05c3b-b304-4bf9-970d-acdfaef2944c",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:33.567Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:14.375Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "/* Registry Path ends with backslash */\nregistry where host.os.type == \"windows\" and event.type == \"change\" and length(registry.data.strings) > 0 and\n registry.path : (\"HKEY_USERS\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\\\\\",\n                  \"HKU\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\\\\\",\n                  \"HKLM\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\\\\\",\n                  \"HKLM\\\\Software\\\\WOW6432Node\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\\\\\",\n                  \"HKEY_USERS\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\Explorer\\\\Run\\\\\",\n                  \"HKU\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\Explorer\\\\Run\\\\\",\n                  \"\\\\REGISTRY\\\\MACHINE\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\Explorer\\\\Run\\\\\",\n                  \"\\\\REGISTRY\\\\USER\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\\\\\",\n                  \"\\\\REGISTRY\\\\MACHINE\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\\\\\",\n                  \"\\\\REGISTRY\\\\MACHINE\\\\Software\\\\WOW6432Node\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\\\\\",\n                  \"\\\\REGISTRY\\\\USER\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\Explorer\\\\Run\\\\\",\n                  \"\\\\REGISTRY\\\\MACHINE\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\Explorer\\\\Run\\\\\")",
        "language": "eql",
        "index": [
          "logs-endpoint.events.registry-*",
          "winlogbeat-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "Google Workspace Password Policy Modified",
        "description": "Detects when a Google Workspace password policy is modified. An adversary may attempt to modify a password policy in order to weaken an organizationâ€™s security controls.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Google Workspace Password Policy Modified\n\nGoogle Workspace administrators manage password policies to enforce password requirements for an organization's compliance needs. Administrators have the capability to set restrictions on password length, reset frequency, reuse capability, expiration, and much more. Google Workspace also allows multi-factor authentication (MFA) and 2-step verification (2SV) for authentication.\n\nThreat actors might rely on weak password policies or restrictions to attempt credential access by using password stuffing or spraying techniques for cloud-based user accounts. Administrators might introduce increased risk to credential access from a third-party by weakening the password restrictions for an organization.\n\nThis rule detects when a Google Workspace password policy is modified to decrease password complexity or to adjust the reuse and reset frequency.\n\n#### Possible investigation steps\n\n- Identify associated user account(s) by reviewing the `user.name` or `source.user.email` fields in the alert.\n- Identify the password setting that was created or adjusted by reviewing `google_workspace.admin.setting.name` field.\n- Check if a password setting was enabled or disabled by reviewing the `google_workspace.admin.new_value` and `google_workspace.admin.old_value` fields.\n- After identifying the involved user, verify administrative privileges are scoped properly to change.\n- Filter `event.dataset` for `google_workspace.login` and aggregate by `user.name`, `event.action`.\n  - The `google_workspace.login.challenge_method` field can be used to identify the challenge method used for failed and successful logins.\n\n### False positive analysis\n\n- After identifying the user account that updated the password policy, verify whether the action was intentional.\n- Verify whether the user should have administrative privileges in Google Workspace to modify password policies.\n- Review organizational units or groups the role may have been added to and ensure the new privileges align properly.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Consider resetting passwords for potentially affected users.\n- Disable or limit the account during the investigation and response.\n- Identify the possible impact of the incident and prioritize accordingly; the following actions can help you gain context:\n    - Identify the account role in the cloud environment.\n    - Assess the criticality of affected services and servers.\n    - Work with your IT team to identify and minimize the impact on users.\n    - Identify if the attacker is moving laterally and compromising other accounts, servers, or services.\n    - Identify any regulatory or legal ramifications related to this activity.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords or delete API keys as needed to revoke the attacker's access to the environment. Work with your IT teams to minimize the impact on business operations during these actions.\n- Reactivate multi-factor authentication for the user.\n- Review the permissions assigned to the implicated user to ensure that the least privilege principle is being followed.\n- Implement security best practices [outlined](https://support.google.com/a/answer/7587183) by Google.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection via the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n\n\n\n### Important Information Regarding Google Workspace Event Lag Times\n- As per Google's documentation, Google Workspace administrators might observe lag times ranging from several minutes to 3 days between the event occurrence time and the event being visible in the Google Workspace admin/audit logs.\n- This rule is configured to run every 10 minutes with a lookback time of 130 minutes.\n- To reduce the risk of false negatives, consider reducing the interval that the Google Workspace (formerly G Suite) Filebeat module polls Google's reporting API for new events.\n- By default, `var.interval` is set to 2 hours (2h). Consider changing this interval to a lower value, such as 10 minutes (10m).\n- See the following references for further information:\n  - https://support.google.com/a/answer/7061566\n  - https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-module-google_workspace.html",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Cloud",
          "Data Source: Google Workspace",
          "Use Case: Identity and Access Audit",
          "Tactic: Persistence",
          "Resources: Investigation Guide"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-7800s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Password policies may be modified by system administrators. Verify that the configuration change was expected. Exceptions can be added to this rule to filter expected behavior."
        ],
        "references": [
          "https://support.google.com/a/answer/7061566",
          "https://www.elastic.co/security-labs/google-workspace-attack-surface-part-one",
          "https://www.elastic.co/security-labs/google-workspace-attack-surface-part-two"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1098",
                "name": "Account Manipulation",
                "reference": "https://attack.mitre.org/techniques/T1098/"
              }
            ]
          }
        ],
        "setup": "The Google Workspace Fleet integration, the Filebeat module, or data that's similarly structured is required for this rule.",
        "related_integrations": [
          {
            "package": "google_workspace",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "google_workspace.admin.setting.name",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "93f9ce65-6dd4-4e10-a7d7-7578ab5f6bda",
        "rule_id": "a99f82f5-8e77-4f8b-b3ce-10c0f6afbc73",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:33.565Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:06.936Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-google_workspace*"
        ],
        "filters": [],
        "query": "event.dataset:google_workspace.admin and event.provider:admin and event.category:iam and\n  event.action:(CHANGE_APPLICATION_SETTING or CREATE_APPLICATION_SETTING) and\n  google_workspace.admin.setting.name:(\n    \"Password Management - Enforce strong password\" or\n    \"Password Management - Password reset frequency\" or\n    \"Password Management - Enable password reuse\" or\n    \"Password Management - Enforce password policy at next login\" or\n    \"Password Management - Minimum password length\" or\n    \"Password Management - Maximum password length\"\n  )",
        "language": "kuery"
      },
      {
        "name": "IPSEC NAT Traversal Port Activity",
        "description": "This rule detects events that could be describing IPSEC NAT Traversal traffic. IPSEC is a VPN technology that allows one system to talk to another using encrypted tunnels. NAT Traversal enables these tunnels to communicate over the Internet where one of the sides is behind a NAT router gateway. This may be common on your network, but this technique is also used by threat actors to avoid detection.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 105,
        "tags": [
          "Tactic: Command and Control",
          "Domain: Endpoint",
          "Use Case: Threat Detection",
          "Data Source: PAN-OS"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Some networks may utilize these protocols but usage that is unfamiliar to local network administrators can be unexpected and suspicious. Because this port is in the ephemeral range, this rule may false under certain conditions, such as when an application server with a public IP address replies to a client which has used a UDP port in the range by coincidence. This is uncommon but such servers can be excluded."
        ],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            }
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "network_traffic",
            "version": "^1.1.0"
          },
          {
            "package": "panw",
            "version": "^4.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.port",
            "type": "long",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "network.transport",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "d7399180-4249-482a-9e84-cb86c888ec05",
        "rule_id": "a9cb3641-ff4b-4cdc-a063-b4b8d02a67c7",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:33.569Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:15.025Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "packetbeat-*",
          "auditbeat-*",
          "filebeat-*",
          "logs-network_traffic.*",
          "logs-panw.*"
        ],
        "filters": [],
        "query": "(event.dataset: network_traffic.flow or (event.category: (network or network_traffic))) and network.transport:udp and destination.port:4500",
        "language": "kuery"
      },
      {
        "name": "Remote Execution via File Shares",
        "description": "Identifies the execution of a file that was created by the virtual system process. This may indicate lateral movement via network file shares.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Remote Execution via File Shares\n\nAdversaries can use network shares to host tooling to support the compromise of other hosts in the environment. These tools can include discovery utilities, credential dumpers, malware, etc.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Review adjacent login events (e.g., 4624) in the alert timeframe to identify the account used to perform this action.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the process executable using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n### False positive analysis\n\n- This activity can happen legitimately. Consider adding exceptions if it is expected and noisy in your environment.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Review the privileges needed to write to the network share and restrict write access as needed.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 114,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Lateral Movement",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "http://web.archive.org/web/20230329172636/https://blog.menasec.net/2020/08/new-trick-to-detect-lateral-movement.html",
          "https://www.elastic.co/security-labs/hunting-for-lateral-movement-using-event-query-language"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1021",
                "name": "Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1021/",
                "subtechnique": [
                  {
                    "id": "T1021.002",
                    "name": "SMB/Windows Admin Shares",
                    "reference": "https://attack.mitre.org/techniques/T1021/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.Ext.header_bytes",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.code_signature.subject_name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.code_signature.trusted",
            "type": "boolean",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pid",
            "type": "long",
            "ecs": true
          }
        ],
        "id": "47077ad3-cd86-4489-8619-31b4b70e89e8",
        "rule_id": "ab75c24b-2502-43a0-bf7c-e60e662c811e",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:33.571Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:06.949Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence with maxspan=1m\n  [file where host.os.type == \"windows\" and event.type in (\"creation\", \"change\") and \n   process.pid == 4 and (file.extension : \"exe\" or file.Ext.header_bytes : \"4d5a*\")] by host.id, file.path\n  [process where host.os.type == \"windows\" and event.type == \"start\" and\n    not (\n      /* Veeam related processes */\n      (\n        process.name : (\n          \"VeeamGuestHelper.exe\", \"VeeamGuestIndexer.exe\", \"VeeamAgent.exe\", \"VeeamLogShipper.exe\", \"Veeam.VSS.Sharepoint20??.exe\"\n        ) and process.code_signature.trusted == true and process.code_signature.subject_name : \"Veeam Software Group GmbH\"\n      ) or\n      /* PDQ related processes */\n      (\n        process.name : (\n          \"PDQInventoryScanner.exe\", \"PDQInventoryMonitor.exe\", \"PDQInventory-Scanner-?.exe\",\n          \"PDQInventoryWakeCommand-?.exe\", \"PDQDeployRunner-?.exe\"\n        ) and process.code_signature.trusted == true and process.code_signature.subject_name : \"PDQ.com Corporation\"\n      ) or\n      /* CrowdStrike related processes */\n      (\n        (process.executable : \"?:\\\\Windows\\\\System32\\\\drivers\\\\CrowdStrike\\\\*-WindowsSensor.*.exe\" and \n         process.code_signature.trusted == true and process.code_signature.subject_name : \"CrowdStrike, Inc.\") or\n        (process.executable : \"?:\\\\Windows\\\\System32\\\\drivers\\\\CrowdStrike\\\\*-CsInstallerService.exe\" and \n         process.code_signature.trusted == true and process.code_signature.subject_name : \"Microsoft Windows Hardware Compatibility Publisher\")\n      ) or\n      /* MS related processes */\n      (\n        process.executable == \"System\" or\n        (process.executable : \"?:\\\\Windows\\\\ccmsetup\\\\ccmsetup.exe\" and \n         process.code_signature.trusted == true and process.code_signature.subject_name : \"Microsoft Corporation\")\n      ) or\n      /* CyberArk processes */\n      (\n        process.executable : \"?:\\\\Windows\\\\CAInvokerService.exe\" and \n        process.code_signature.trusted == true and process.code_signature.subject_name : \"CyberArk Software Ltd.\"\n      )  or\n      /* Sophos processes */\n      (\n        process.executable : \"?:\\\\ProgramData\\\\Sophos\\\\AutoUpdate\\\\Cache\\\\sophos_autoupdate1.dir\\\\SophosUpdate.exe\" and \n        process.code_signature.trusted == true and process.code_signature.subject_name : \"Sophos Ltd\"\n      ) \n    )\n  ] by host.id, process.executable",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "logs-endpoint.events.file-*"
        ],
        "filters": []
      },
      {
        "name": "Unusual Windows Process Calling the Metadata Service",
        "description": "Looks for anomalous access to the metadata service by an unusual process. The metadata service may be targeted in order to harvest credentials or user data scripts containing secrets.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Rule Type: ML",
          "Rule Type: Machine Learning",
          "Tactic: Credential Access"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "15m",
        "from": "now-2700s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "A newly installed program or one that runs very rarely as part of a monthly or quarterly workflow could trigger this detection rule."
        ],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1552",
                "name": "Unsecured Credentials",
                "reference": "https://attack.mitre.org/techniques/T1552/",
                "subtechnique": [
                  {
                    "id": "T1552.005",
                    "name": "Cloud Instance Metadata API",
                    "reference": "https://attack.mitre.org/techniques/T1552/005/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires the installation of associated Machine Learning jobs, as well as data coming in from one of the following integrations:\n- Elastic Defend\n- Windows\n\n### Anomaly Detection Setup\n\nOnce the rule is enabled, the associated Machine Learning job will start automatically. You can view the Machine Learning job linked under the \"Definition\" panel of the detection rule. If the job does not start due to an error, the issue must be resolved for the job to commence successfully. For more details on setting up anomaly detection jobs, refer to the [helper guide](https://www.elastic.co/guide/en/kibana/current/xpack-ml-anomalies.html).\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration to your system:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n### Windows Integration Setup\nThe Windows integration allows you to monitor the Windows OS, services, applications, and more.\n\n#### The following steps should be executed in order to add the Elastic Agent System integration \"windows\" to your system:\n- Go to the Kibana home page and click â€œAdd integrationsâ€.\n- In the query bar, search for â€œWindowsâ€ and select the integration to see more details about it.\n- Click â€œAdd Windowsâ€.\n- Configure the integration name and optionally add a description.\n- Review optional and advanced settings accordingly.\n- Add the newly installed â€œwindowsâ€ to an existing or a new agent policy, and deploy the agent on your system from which windows log files are desirable.\n- Click â€œSave and Continueâ€.\n- For more details on the integration refer to the [helper guide](https://docs.elastic.co/integrations/windows).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [],
        "id": "66137b4a-0811-4d43-8881-473166b2ce38",
        "rule_id": "abae61a8-c560-4dbd-acca-1e1438bff36b",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:33.572Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:14.930Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "machine_learning",
        "anomaly_threshold": 50,
        "machine_learning_job_id": [
          "v3_windows_rare_metadata_process"
        ]
      },
      {
        "name": "Suspicious WerFault Child Process",
        "description": "A suspicious WerFault child process was detected, which may indicate an attempt to run via the SilentProcessExit registry key manipulation. Verify process details such as command line, network connections and file writes.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 415,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Tactic: Persistence",
          "Tactic: Privilege Escalation",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Custom Windows error reporting debugger or applications restarted by WerFault after a crash."
        ],
        "references": [
          "https://www.hexacorn.com/blog/2019/09/19/silentprocessexit-quick-look-under-the-hood/",
          "https://www.hexacorn.com/blog/2019/09/20/werfault-command-line-switches-v0-1/",
          "https://github.com/sbousseaden/EVTX-ATTACK-SAMPLES/blob/master/Persistence/persistence_SilentProcessExit_ImageHijack_sysmon_13_1.evtx",
          "http://web.archive.org/web/20230530011556/https://blog.menasec.net/2021/01/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1036",
                "name": "Masquerading",
                "reference": "https://attack.mitre.org/techniques/T1036/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1546",
                "name": "Event Triggered Execution",
                "reference": "https://attack.mitre.org/techniques/T1546/",
                "subtechnique": [
                  {
                    "id": "T1546.012",
                    "name": "Image File Execution Options Injection",
                    "reference": "https://attack.mitre.org/techniques/T1546/012/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1546",
                "name": "Event Triggered Execution",
                "reference": "https://attack.mitre.org/techniques/T1546/",
                "subtechnique": [
                  {
                    "id": "T1546.012",
                    "name": "Image File Execution Options Injection",
                    "reference": "https://attack.mitre.org/techniques/T1546/012/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "385344f8-e9f7-457b-91a0-1f3d29281bf4",
        "rule_id": "ac5012b8-8da8-440b-aaaf-aedafdea2dff",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:33.582Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:14.933Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n\n  process.parent.name : \"WerFault.exe\" and\n\n  /* args -s and -t used to execute a process via SilentProcessExit mechanism */\n  (process.parent.args : \"-s\" and process.parent.args : \"-t\" and process.parent.args : \"-c\") and\n\n  not process.executable : (\"?:\\\\Windows\\\\SysWOW64\\\\Initcrypt.exe\", \"?:\\\\Program Files (x86)\\\\Heimdal\\\\Heimdal.Guard.exe\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-m365_defender.event-*"
        ],
        "filters": []
      },
      {
        "name": "Unusual AWS Command for a User",
        "description": "A machine learning job detected an AWS API command that, while not inherently suspicious or abnormal, is being made by a user context that does not normally use the command. This can be the result of compromised credentials or keys as someone uses a valid account to persist, move laterally, or exfiltrate data.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Unusual AWS Command for a User\n\nCloudTrail logging provides visibility on actions taken within an AWS environment. By monitoring these events and understanding what is considered normal behavior within an organization, you can spot suspicious or malicious activity when deviations occur.\n\nThis rule uses a machine learning job to detect an AWS API command that while not inherently suspicious or abnormal, is being made by a user context that does not normally use the command. This can be the result of compromised credentials or keys as someone uses a valid account to persist, move laterally, or exfiltrate data.\n\nDetection alerts from this rule indicate an AWS API command or method call that is rare and unusual for the calling IAM user.\n\n#### Possible investigation steps\n\n- Identify the user account involved and the action performed. Verify whether it should perform this kind of action.\n    - Examine the user identity in the `aws.cloudtrail.user_identity.arn` field and the access key ID in the `aws.cloudtrail.user_identity.access_key_id` field, which can help identify the precise user context.\n    - The user agent details in the `user_agent.original` field may also indicate what kind of a client made the request.\n- Investigate other alerts associated with the user account during the past 48 hours.\n- Validate the activity is not related to planned patches, updates, or network administrator activity.\n- Examine the request parameters. These might indicate the source of the program or the nature of its tasks.\n- Considering the source IP address and geolocation of the user who issued the command:\n    - Do they look normal for the calling user?\n    - If the source is an EC2 IP address, is it associated with an EC2 instance in one of your accounts or is the source IP from an EC2 instance that's not under your control?\n    - If it is an authorized EC2 instance, is the activity associated with normal behavior for the instance role or roles? Are there any other alerts or signs of suspicious activity involving this instance?\n- Consider the time of day. If the user is a human (not a program or script), did the activity take place during a normal time of day?\n- Contact the account owner and confirm whether they are aware of this activity if suspicious.\n- If you suspect the account has been compromised, scope potentially compromised assets by tracking servers, services, and data accessed by the account in the last 24 hours.\n\n### False positive analysis\n\n- Examine the history of the command. If the command only manifested recently, it might be part of a new automation module or script. If it has a consistent cadence (for example, it appears in small numbers on a weekly or monthly cadence), it might be part of a housekeeping or maintenance process. You can find the command in the `event.action field` field.\n\n### Related Rules\n\n- Unusual City For an AWS Command - 809b70d3-e2c3-455e-af1b-2626a5a1a276\n- Unusual Country For an AWS Command - dca28dee-c999-400f-b640-50a081cc0fd1\n- Rare AWS Error Code - 19de8096-e2b0-4bd8-80c9-34a820813fff\n- Spike in AWS Error Messages - 78d3d8d9-b476-451d-a9e0-7a5addd70670\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Disable or limit the account during the investigation and response.\n- Identify the possible impact of the incident and prioritize accordingly; the following actions can help you gain context:\n    - Identify the account role in the cloud environment.\n    - Assess the criticality of affected services and servers.\n    - Work with your IT team to identify and minimize the impact on users.\n    - Identify if the attacker is moving laterally and compromising other accounts, servers, or services.\n    - Identify any regulatory or legal ramifications related to this activity.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords or delete API keys as needed to revoke the attacker's access to the environment. Work with your IT teams to minimize the impact on business operations during these actions.\n- Check if unauthorized new users were created, remove unauthorized new accounts, and request password resets for other IAM users.\n- Consider enabling multi-factor authentication for users.\n- Review the permissions assigned to the implicated user to ensure that the least privilege principle is being followed.\n- Implement security best practices [outlined](https://aws.amazon.com/premiumsupport/knowledge-center/security-best-practices/) by AWS.\n- Take the actions needed to return affected systems, data, or services to their normal operational levels.\n- Identify the initial vector abused by the attacker and take action to prevent reinfection via the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 209,
        "tags": [
          "Domain: Cloud",
          "Data Source: AWS",
          "Data Source: Amazon Web Services",
          "Rule Type: ML",
          "Rule Type: Machine Learning",
          "Resources: Investigation Guide"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "15m",
        "from": "now-7200s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "New or unusual user command activity can be due to manual troubleshooting or reconfiguration; changes in cloud automation scripts or workflows; adoption of new services; or changes in the way services are used."
        ],
        "references": [
          "https://www.elastic.co/guide/en/security/current/prebuilt-ml-jobs.html"
        ],
        "max_signals": 100,
        "threat": [],
        "setup": "## Setup\n\nThis rule requires the installation of associated Machine Learning jobs, as well as data coming in from AWS.\n\n### Anomaly Detection Setup\n\nOnce the rule is enabled, the associated Machine Learning job will start automatically. You can view the Machine Learning job linked under the \"Definition\" panel of the detection rule. If the job does not start due to an error, the issue must be resolved for the job to commence successfully. For more details on setting up anomaly detection jobs, refer to the [helper guide](https://www.elastic.co/guide/en/kibana/current/xpack-ml-anomalies.html).\n\n### AWS Integration Setup\nThe AWS integration allows you to collect logs and metrics from Amazon Web Services (AWS) with Elastic Agent.\n\n#### The following steps should be executed in order to add the Elastic Agent System integration \"aws\" to your system:\n- Go to the Kibana home page and click â€œAdd integrationsâ€.\n- In the query bar, search for â€œAWSâ€ and select the integration to see more details about it.\n- Click â€œAdd AWSâ€.\n- Configure the integration name and optionally add a description.\n- Review optional and advanced settings accordingly.\n- Add the newly installed â€œawsâ€ to an existing or a new agent policy, and deploy the agent on your system from which aws log files are desirable.\n- Click â€œSave and Continueâ€.\n- For more details on the integration refer to the [helper guide](https://www.elastic.co/docs/current/integrations/aws).\n",
        "related_integrations": [
          {
            "package": "aws",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [],
        "id": "c8691c18-87aa-430f-b2fa-a9feb565f5c9",
        "rule_id": "ac706eae-d5ec-4b14-b4fd-e8ba8086f0e1",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:33.584Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:14.944Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "machine_learning",
        "anomaly_threshold": 75,
        "machine_learning_job_id": [
          "rare_method_for_a_username"
        ]
      },
      {
        "name": "Potential Invoke-Mimikatz PowerShell Script",
        "description": "Mimikatz is a credential dumper capable of obtaining plaintext Windows account logins and passwords, along with many other features that make it useful for testing the security of networks. This rule detects Invoke-Mimikatz PowerShell script and alike.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Mimikatz PowerShell Activity\n\n[Mimikatz](https://github.com/gentilkiwi/mimikatz) is an open-source tool used to collect, decrypt, and/or use cached credentials. This tool is commonly abused by adversaries during the post-compromise stage where adversaries have gained an initial foothold on an endpoint and are looking to elevate privileges and seek out additional authentication objects such as tokens/hashes/credentials that can then be used to move laterally and pivot across a network.\n\nThis rule looks for PowerShell scripts that load mimikatz in memory, like Invoke-Mimikataz, which are used to dump credentials from the Local Security Authority Subsystem Service (LSASS). Any activity triggered from this rule should be treated with high priority as it typically represents an active adversary.\n\nMore information about Mimikatz components and how to detect/prevent them can be found on [ADSecurity](https://adsecurity.org/?page_id=1821).\n\n#### Possible investigation steps\n\n- Examine the script content that triggered the detection; look for suspicious DLL imports, collection or exfiltration capabilities, suspicious functions, encoded or compressed data, and other potentially malicious characteristics.\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Examine file or network events from the involved PowerShell process for suspicious behavior.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n  - Invoke-Mimitakz and alike scripts heavily use other capabilities covered by other detections described in the \"Related Rules\" section.\n- Evaluate whether the user needs to use PowerShell to complete tasks.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host.\n  - Examine network and security events in the environment to identify potential lateral movement using compromised credentials.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Related rules\n\n- PowerShell PSReflect Script - 56f2e9b5-4803-4e44-a0a4-a52dc79d57fe\n- Suspicious .NET Reflection via PowerShell - e26f042e-c590-4e82-8e05-41e81bd822ad\n- PowerShell Suspicious Payload Encoded and Compressed - 81fe9dc6-a2d7-4192-a2d8-eed98afc766a\n- Potential Process Injection via PowerShell - 2e29e96a-b67c-455a-afe4-de6183431d0d\n- Mimikatz Memssp Log File Detected - ebb200e8-adf0-43f8-a0bb-4ee5b5d852c6\n- Modification of WDigest Security Provider - d703a5af-d5b0-43bd-8ddb-7a5d500b7da5\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Restrict PowerShell usage outside of IT and engineering business units using GPOs, AppLocker, Intune, or similar software.\n- Validate that cleartext passwords are disabled in memory for use with `WDigest`.\n- Look into preventing access to `LSASS` using capabilities such as LSA protection or antivirus/EDR tools that provide this capability.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 210,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Resources: Investigation Guide",
          "Data Source: PowerShell Logs"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://attack.mitre.org/software/S0002/",
          "https://raw.githubusercontent.com/EmpireProject/Empire/master/data/module_source/credentials/Invoke-Mimikatz.ps1",
          "https://www.elastic.co/security-labs/detect-credential-access"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1003",
                "name": "OS Credential Dumping",
                "reference": "https://attack.mitre.org/techniques/T1003/",
                "subtechnique": [
                  {
                    "id": "T1003.001",
                    "name": "LSASS Memory",
                    "reference": "https://attack.mitre.org/techniques/T1003/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'PowerShell Script Block Logging' logging policy must be configured (Enable).\n\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nAdministrative Templates >\nWindows PowerShell >\nTurn on PowerShell Script Block Logging (Enable)\n```\n\nSteps to implement the logging policy via registry:\n\n```\nreg add \"hklm\\SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\ScriptBlockLogging\" /v EnableScriptBlockLogging /t REG_DWORD /d 1\n```\n",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "powershell.file.script_block_text",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "01af1683-52f6-41f0-9c90-e8dfa74a5fbf",
        "rule_id": "ac96ceb8-4399-4191-af1d-4feeac1f1f46",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:33.586Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:14.948Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-windows.powershell*"
        ],
        "filters": [],
        "query": "event.category:process and host.os.type:windows and\npowershell.file.script_block_text:(\n  (DumpCreds and\n  DumpCerts) or\n  \"sekurlsa::logonpasswords\" or\n  (\"crypto::certificates\" and\n  \"CERT_SYSTEM_STORE_LOCAL_MACHINE\")\n)",
        "language": "kuery"
      },
      {
        "name": "Google Workspace API Access Granted via Domain-Wide Delegation",
        "description": "Detects when a domain-wide delegation of authority is granted to a service account. Domain-wide delegation can be configured to grant third-party and internal applications to access the data of Google Workspace users. An adversary may configure domain-wide delegation to maintain access to their targetâ€™s data.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Google Workspace API Access Granted via Domain-Wide Delegation\n\nDomain-wide delegation is a feature that allows apps to access users' data across an organization's Google Workspace environment. Only super admins can manage domain-wide delegation, and they must specify each API scope that the application can access. Google Workspace services all have APIs that can be interacted with after domain-wide delegation is established with an OAuth2 client ID of the application. Typically, GCP service accounts and applications are created where the Google Workspace APIs are enabled, thus allowing the application to access resources and services in Google Workspace.\n\nApplications authorized to interact with Google Workspace resources and services through APIs have a wide range of capabilities depending on the scopes applied. If the principle of least privilege (PoLP) is not practiced when setting API scopes, threat actors could abuse additional privileges if the application is compromised. New applications created and given API access could indicate an attempt by a threat actor to register their malicious application with the Google Workspace domain in an attempt to establish a command and control foothold.\n\nThis rule identifies when an application is authorized API client access.\n\n#### Possible investigation steps\n\n- Identify the associated user accounts by reviewing `user.name` or `user.email` fields in the alert.\n  - Only users with super admin privileges can authorize API client access.\n- Identify the API client name by reviewing the `google_workspace.admin.api.client.name` field in the alert.\n  - If GCP audit logs are ingested, pivot to reviewing the last 48 hours of activity related to the service account ID.\n  - Search for the `google_workspace.admin.api.client.name` value with wildcards in the `gcp.audit.resource_name` field.\n  - Search for API client name and aggregated results on `event.action` to determine what the service account is being used for in GWS.\n- After identifying the involved user, verify super administrative privileges to access domain-wide delegation settings.\n\n### False positive analysis\n\n- Changes to domain-wide delegation require super admin privileges. Check with the user to ensure these changes were expected.\n- Review scheduled maintenance notes related to expected API access changes.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Review the scope of the authorized API client access in Google Workspace.\n- Disable or limit the account during the investigation and response.\n- Identify the possible impact of the incident and prioritize accordingly; the following actions can help you gain context:\n    - Identify the account role in the cloud environment.\n    - Assess the criticality of affected services and servers.\n    - Work with your IT team to identify and minimize the impact on users.\n    - Identify if the attacker is moving laterally and compromising other accounts, servers, or services.\n    - Identify any regulatory or legal ramifications related to this activity.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords or delete API keys as needed to revoke the attacker's access to the environment. Work with your IT teams to minimize the impact on business operations during these actions.\n- Review the permissions assigned to the implicated user to ensure that the least privilege principle is being followed.\n- Implement security best practices [outlined](https://support.google.com/a/answer/7587183) by Google.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection via the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n\n\n\n### Important Information Regarding Google Workspace Event Lag Times\n- As per Google's documentation, Google Workspace administrators may observe lag times ranging from minutes up to 3 days between the time of an event's occurrence and the event being visible in the Google Workspace admin/audit logs.\n- To reduce the risk of false negatives, consider reducing the interval that the Google Workspace (formerly G Suite) Filebeat module polls Google's reporting API for new events.\n- By default, `var.interval` is set to 2 hours (2h). Consider changing this interval to a lower value, such as 10 minutes (10m).\n- See the following references for further information:\n  - https://support.google.com/a/answer/7061566\n  - https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-module-google_workspace.html",
        "output_index": "",
        "version": 207,
        "tags": [
          "Domain: Cloud",
          "Data Source: Google Workspace",
          "Use Case: Identity and Access Audit",
          "Resources: Investigation Guide",
          "Tactic: Persistence"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Domain-wide delegation of authority may be granted to service accounts by system administrators. Verify that the configuration change was expected. Exceptions can be added to this rule to filter expected behavior."
        ],
        "references": [
          "https://developers.google.com/admin-sdk/directory/v1/guides/delegation",
          "https://www.elastic.co/security-labs/google-workspace-attack-surface-part-one",
          "https://www.elastic.co/security-labs/google-workspace-attack-surface-part-two"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1098",
                "name": "Account Manipulation",
                "reference": "https://attack.mitre.org/techniques/T1098/"
              }
            ]
          }
        ],
        "setup": "The Google Workspace Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "google_workspace",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "392836d8-3e8f-44dd-b540-e701cba7552e",
        "rule_id": "acbc8bb9-2486-49a8-8779-45fb5f9a93ee",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:33.588Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:06.952Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-google_workspace*"
        ],
        "filters": [],
        "query": "event.dataset:google_workspace.admin\n  and event.provider:admin\n  and event.category:iam\n  and event.action:AUTHORIZE_API_CLIENT_ACCESS\n  and event.outcome:success",
        "language": "kuery"
      },
      {
        "name": "Potential Command and Control via Internet Explorer",
        "description": "Identifies instances of Internet Explorer (iexplore.exe) being started via the Component Object Model (COM) making unusual network connections. Adversaries could abuse Internet Explorer via COM to avoid suspicious processes making network connections and bypass host-based firewall restrictions.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 106,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Command and Control",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Processes such as MS Office using IEproxy to render HTML content."
        ],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            },
            "technique": [
              {
                "id": "T1071",
                "name": "Application Layer Protocol",
                "reference": "https://attack.mitre.org/techniques/T1071/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1559",
                "name": "Inter-Process Communication",
                "reference": "https://attack.mitre.org/techniques/T1559/",
                "subtechnique": [
                  {
                    "id": "T1559.001",
                    "name": "Component Object Model",
                    "reference": "https://attack.mitre.org/techniques/T1559/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "dll.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "dns.question.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "network.protocol",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "4c288561-ab6b-40c2-a191-2d38cd917072",
        "rule_id": "acd611f3-2b93-47b3-a0a3-7723bcc46f6d",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:33.590Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:14.951Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by host.id, user.name with maxspan = 5s\n  [library where host.os.type == \"windows\" and dll.name : \"IEProxy.dll\" and process.name : (\"rundll32.exe\", \"regsvr32.exe\")]\n  [process where host.os.type == \"windows\" and event.type == \"start\" and process.parent.name : \"iexplore.exe\" and process.parent.args : \"-Embedding\"]\n  /* IE started via COM in normal conditions makes few connections, mainly to Microsoft and OCSP related domains, add FPs here */\n  [network where host.os.type == \"windows\" and network.protocol == \"dns\" and process.name : \"iexplore.exe\" and\n   not dns.question.name :\n   (\n    \"*.microsoft.com\",\n    \"*.digicert.com\",\n    \"*.msocsp.com\",\n    \"*.windowsupdate.com\",\n    \"*.bing.com\",\n    \"*.identrust.com\",\n    \"*.sharepoint.com\",\n    \"*.office365.com\",\n    \"*.office.com\"\n    )\n  ] /* with runs=5 */",
        "language": "eql",
        "index": [
          "logs-endpoint.events.library-*",
          "logs-endpoint.events.process-*",
          "logs-endpoint.events.network-*"
        ],
        "filters": []
      },
      {
        "name": "Potential macOS SSH Brute Force Detected",
        "description": "Identifies a high number (20) of macOS SSH KeyGen process executions from the same host. An adversary may attempt a brute force attack to obtain unauthorized access to user accounts.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 108,
        "tags": [
          "Domain: Endpoint",
          "OS: macOS",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://themittenmac.com/detecting-ssh-activity-via-process-monitoring/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1110",
                "name": "Brute Force",
                "reference": "https://attack.mitre.org/techniques/T1110/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a macOS System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, for MacOS it is recommended to select \"Traditional Endpoints\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "acacea67-8e4f-44a5-a897-3a45038e1c83",
        "rule_id": "ace1e989-a541-44df-93a8-a8b0591b63c0",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:33.591Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:14.954Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "threshold",
        "query": "event.category:process and host.os.type:macos and event.type:start and process.name:\"sshd-keygen-wrapper\" and process.parent.name:launchd",
        "threshold": {
          "field": [
            "host.id"
          ],
          "value": 20
        },
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Suspicious Managed Code Hosting Process",
        "description": "Identifies a suspicious managed code hosting process which could indicate code injection or other form of suspicious code execution.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 309,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: SentinelOne",
          "Data Source: Elastic Endgame",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "http://web.archive.org/web/20230329154538/https://blog.menasec.net/2019/07/interesting-difr-traces-of-net-clr.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1055",
                "name": "Process Injection",
                "reference": "https://attack.mitre.org/techniques/T1055/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "83c5b572-337b-4f93-aa95-6a1690fa2ea3",
        "rule_id": "acf738b5-b5b2-4acc-bad9-1e18ee234f40",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:33.593Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:14.958Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"windows\" and event.type != \"deletion\" and\n  file.name : (\"wscript.exe.log\",\n               \"cscript.exe.log\",\n               \"mshta.exe.log\",\n               \"wmic.exe.log\",\n               \"svchost.exe.log\",\n               \"dllhost.exe.log\",\n               \"cmstp.exe.log\",\n               \"regsvr32.exe.log\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.file-*",
          "logs-windows.sysmon_operational-*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "endgame-*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Signed Proxy Execution via MS Work Folders",
        "description": "Identifies the use of Windows Work Folders to execute a potentially masqueraded control.exe file in the current working directory. Misuse of Windows Work Folders could indicate malicious activity.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Signed Proxy Execution via MS Work Folders\n\nWork Folders is a role service for file servers running Windows Server that provides a consistent way for users to access their work files from their PCs and devices. This allows users to store work files and access them from anywhere. When called, Work Folders will automatically execute any Portable Executable (PE) named control.exe as an argument before accessing the synced share.\n\nUsing Work Folders to execute a masqueraded control.exe could allow an adversary to bypass application controls and increase privileges.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n    - Examine the location of the WorkFolders.exe binary to determine if it was copied to the location of the control.exe binary. It resides in the System32 directory by default.\n- Trace the activity related to the control.exe binary to identify any continuing intrusion activity on the host.\n- Review the control.exe binary executed with Work Folders to determine maliciousness such as additional host activity or network traffic.\n- Determine if control.exe was synced to sync share, indicating potential lateral movement.\n- Review how control.exe was originally delivered on the host, such as emailed, downloaded from the web, or written to\ndisk from a separate binary.\n\n### False positive analysis\n\n- Windows Work Folders are used legitimately by end users and administrators for file sharing and syncing but not in the instance where a suspicious control.exe is passed as an argument.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Review the Work Folders synced share to determine if the control.exe was shared and if so remove it.\n- If no lateral movement was identified during investigation, take the affected host offline if possible and remove the control.exe binary as well as any additional artifacts identified during investigation.\n- Review integrating Windows Information Protection (WIP) to enforce data protection by encrypting the data on PCs using Work Folders.\n- Confirm with the user whether this was expected or not, and reset their password.\n",
        "output_index": "",
        "version": 310,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic",
          "Austin Songer"
        ],
        "false_positives": [],
        "references": [
          "https://docs.microsoft.com/en-us/windows-server/storage/work-folders/work-folders-overview",
          "https://twitter.com/ElliotKillick/status/1449812843772227588",
          "https://lolbas-project.github.io/lolbas/Binaries/WorkFolders/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1218",
                "name": "System Binary Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1218/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "e25b78a3-4240-4187-a124-31f32adba1b9",
        "rule_id": "ad0d2742-9a49-11ec-8d6b-acde48001122",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:33.595Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:14.961Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.name : \"control.exe\" and process.parent.name : \"WorkFolders.exe\" and\n  not process.executable : (\n    \"?:\\\\Windows\\\\System32\\\\control.exe\",\n    \"?:\\\\Windows\\\\SysWOW64\\\\control.exe\",\n    \"\\\\Device\\\\HarddiskVolume?\\\\Windows\\\\System32\\\\control.exe\",\n    \"\\\\Device\\\\HarddiskVolume?\\\\Windows\\\\SysWOW64\\\\control.exe\"\n  )",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Google Workspace Custom Admin Role Created",
        "description": "Detects when a custom admin role is created in Google Workspace. An adversary may create a custom admin role in order to elevate the permissions of other user accounts and persist in their targetâ€™s environment.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Google Workspace Custom Admin Role Created\n\nGoogle Workspace roles allow administrators to assign specific permissions to users or groups where the principle of least privilege (PoLP) is recommended. Admin roles in Google Workspace grant users access to the Google Admin console, where more domain-wide settings are accessible. Google Workspace contains prebuilt administrator roles for performing business functions related to users, groups, and services. Custom administrator roles can be created where prebuilt roles are not preferred.\n\nRoles assigned to users will grant them additional permissions and privileges within the Google Workspace domain. Threat actors might create new admin roles with privileges to advance their intrusion efforts and laterally move throughout the organization if existing roles or users do not have privileges aligned with their modus operandi. Users with unexpected privileges from new admin roles may also cause operational dysfunction if unfamiliar settings are adjusted without warning. Instead of modifying existing roles, administrators might create new roles to accomplish short-term goals and unintentionally introduce additional risk exposure.\n\nThis rule identifies when a Google Workspace administrative role is added within the Google Workspace admin console.\n\n#### Possible investigation steps\n\n- Identify the associated user accounts by reviewing `user.name` or `user.email` fields in the alert.\n- Identify the role added by reviewing the `google_workspace.admin.role.name` field in the alert.\n- After identifying the involved user, verify if they should have administrative privileges to add administrative roles.\n- To identify if users have been assigned this role, search for `event.action: ASSIGN_ROLE`.\n    - Add `google_workspace.admin.role.name` with the role added as an additional filter.\n    - Adjust the relative time accordingly to identify all users that were possibly assigned this admin role.\n- Monitor users assigned the admin role for the next 24 hours and look for attempts to use related privileges.\n  - The `event.provider` field will help filter for specific services in Google Workspace such as Drive or Admin.\n  - The `event.action` field will help trace what actions are being taken by users.\n\n### False positive analysis\n\n- After identifying the user account that created the role, verify whether the action was intentional.\n- Verify that the user who created the role should have administrative privileges in Google Workspace to create custom roles.\n- Review organizational units or groups the role may have been added to and ensure the new privileges align properly.\n- Create a filter with the user's `user.name` and filter for `event.action`. In the results, check if there are multiple `CREATE_ROLE` actions and note whether they are new or historical.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Disable or limit the account during the investigation and response.\n- Identify the possible impact of the incident and prioritize accordingly; the following actions can help you gain context:\n    - Identify the account role in the cloud environment.\n    - Assess the criticality of affected services and servers.\n    - Work with your IT team to identify and minimize the impact on users.\n    - Identify if the attacker is moving laterally and compromising other accounts, servers, or services.\n    - Identify any regulatory or legal ramifications related to this activity.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords or delete API keys as needed to revoke the attacker's access to the environment. Work with your IT teams to minimize the impact on business operations during these actions.\n- Review the permissions assigned to the implicated user to ensure that the least privilege principle is being followed.\n- Implement security best practices [outlined](https://support.google.com/a/answer/7587183) by Google.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection via the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n\n\n\n### Important Information Regarding Google Workspace Event Lag Times\n- As per Google's documentation, Google Workspace administrators may observe lag times ranging from minutes up to 3 days between the time of an event's occurrence and the event being visible in the Google Workspace admin/audit logs.\n- This rule is configured to run every 10 minutes with a lookback time of 130 minutes.\n- To reduce the risk of false negatives, consider reducing the interval that the Google Workspace (formerly G Suite) Filebeat module polls Google's reporting API for new events.\n- By default, `var.interval` is set to 2 hours (2h). Consider changing this interval to a lower value, such as 10 minutes (10m).\n- See the following references for further information:\n  - https://support.google.com/a/answer/7061566\n  - https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-module-google_workspace.html",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Cloud",
          "Data Source: Google Workspace",
          "Use Case: Identity and Access Audit",
          "Resources: Investigation Guide",
          "Tactic: Persistence"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-7800s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Custom Google Workspace admin roles may be created by system administrators. Verify that the configuration change was expected. Exceptions can be added to this rule to filter expected behavior."
        ],
        "references": [
          "https://support.google.com/a/answer/2406043?hl=en",
          "https://www.elastic.co/security-labs/google-workspace-attack-surface-part-one",
          "https://www.elastic.co/security-labs/google-workspace-attack-surface-part-two"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1098",
                "name": "Account Manipulation",
                "reference": "https://attack.mitre.org/techniques/T1098/"
              }
            ]
          }
        ],
        "setup": "The Google Workspace Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "google_workspace",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "d2192c8e-8473-4ddf-b895-1d6b71e07bfa",
        "rule_id": "ad3f2807-2b3e-47d7-b282-f84acbbe14be",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:33.597Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:06.956Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-google_workspace*"
        ],
        "filters": [],
        "query": "event.dataset:google_workspace.admin and event.provider:admin and event.category:iam and event.action:CREATE_ROLE",
        "language": "kuery"
      },
      {
        "name": "Suspicious Portable Executable Encoded in Powershell Script",
        "description": "Detects the presence of a portable executable (PE) in a PowerShell script by looking for its encoded header. Attackers embed PEs into PowerShell scripts to inject them into memory, avoiding defences by not writing to disk.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Suspicious Portable Executable Encoded in Powershell Script\n\nPowerShell is one of the main tools system administrators use for automation, report routines, and other tasks. This makes it available for use in various environments, and creates an attractive way for attackers to execute code.\n\nAttackers can abuse PowerShell in-memory capabilities to inject executables into memory without touching the disk, bypassing file-based security protections. These executables are generally base64 encoded.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Examine the script content that triggered the detection; look for suspicious DLL imports, collection or exfiltration capabilities, suspicious functions, encoded or compressed data, and other potentially malicious characteristics.\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Evaluate whether the user needs to use PowerShell to complete tasks.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the script using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Related rules\n\n- Suspicious .NET Reflection via PowerShell - e26f042e-c590-4e82-8e05-41e81bd822ad\n- PowerShell Suspicious Payload Encoded and Compressed - 81fe9dc6-a2d7-4192-a2d8-eed98afc766a\n- PowerShell PSReflect Script - 56f2e9b5-4803-4e44-a0a4-a52dc79d57fe\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Reimage the host operating system or restore the compromised files to clean versions.\n- Restrict PowerShell usage outside of IT and engineering business units using GPOs, AppLocker, Intune, or similar software.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 212,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Tactic: Defense Evasion",
          "Resources: Investigation Guide",
          "Data Source: PowerShell Logs"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/atc-project/atc-data/blob/master/docs/Logging_Policies/LP_0109_windows_powershell_script_block_log.md"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1055",
                "name": "Process Injection",
                "reference": "https://attack.mitre.org/techniques/T1055/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'PowerShell Script Block Logging' logging policy must be enabled.\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nAdministrative Templates >\nWindows PowerShell >\nTurn on PowerShell Script Block Logging (Enable)\n```\n\nSteps to implement the logging policy via registry:\n\n```\nreg add \"hklm\\SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\ScriptBlockLogging\" /v EnableScriptBlockLogging /t REG_DWORD /d 1\n```\n",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "powershell.file.script_block_text",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "bf0e5bec-5e5b-4784-addd-3ff62bf7a4e1",
        "rule_id": "ad84d445-b1ce-4377-82d9-7c633f28bf9a",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:33.598Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:06.959Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-windows.powershell*"
        ],
        "filters": [],
        "query": "event.category:process and host.os.type:windows and\n  powershell.file.script_block_text : (\n    TVqQAAMAAAAEAAAA\n  ) and not user.id : \"S-1-5-18\"",
        "language": "kuery"
      },
      {
        "name": "Kerberos Cached Credentials Dumping",
        "description": "Identifies the use of the Kerberos credential cache (kcc) utility to dump locally cached Kerberos tickets. Adversaries may attempt to dump credential material in the form of tickets that can be leveraged for lateral movement.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 106,
        "tags": [
          "Domain: Endpoint",
          "OS: macOS",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/EmpireProject/EmPyre/blob/master/lib/modules/collection/osx/kerberosdump.py",
          "https://opensource.apple.com/source/Heimdal/Heimdal-323.12/kuser/kcc-commands.in.auto.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1003",
                "name": "OS Credential Dumping",
                "reference": "https://attack.mitre.org/techniques/T1003/"
              },
              {
                "id": "T1558",
                "name": "Steal or Forge Kerberos Tickets",
                "reference": "https://attack.mitre.org/techniques/T1558/",
                "subtechnique": [
                  {
                    "id": "T1558.003",
                    "name": "Kerberoasting",
                    "reference": "https://attack.mitre.org/techniques/T1558/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a macOS System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, for MacOS it is recommended to select \"Traditional Endpoints\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "83bd96e1-b0a3-4e27-ba13-2804a4f26cc5",
        "rule_id": "ad88231f-e2ab-491c-8fc6-64746da26cfe",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:33.600Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:14.964Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": [],
        "query": "event.category:process and host.os.type:macos and event.type:(start or process_started) and\n  process.name:kcc and\n  process.args:copy_cred_cache",
        "language": "kuery"
      },
      {
        "name": "File Transfer or Listener Established via Netcat",
        "description": "A netcat process is engaging in network activity on a Linux host. Netcat is often used as a persistence mechanism by exporting a reverse shell or by serving a shell on a listening port. Netcat is also sometimes used for data exfiltration.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Netcat Network Activity\n\nNetcat is a dual-use command line tool that can be used for various purposes, such as port scanning, file transfers, and connection tests. Attackers can abuse its functionality for malicious purposes such creating bind shells or reverse shells to gain access to the target system.\n\nA reverse shell is a mechanism that's abused to connect back to an attacker-controlled system. It effectively redirects the system's input and output and delivers a fully functional remote shell to the attacker. Even private systems are vulnerable since the connection is outgoing.\n\nA bind shell is a type of backdoor that attackers set up on the target host and binds to a specific port to listen for an incoming connection from the attacker.\n\nThis rule identifies potential reverse shell or bind shell activity using Netcat by checking for the execution of Netcat followed by a network connection.\n\n#### Possible investigation steps\n\n- Examine the command line to identify if the command is suspicious.\n- Extract and examine the target domain or IP address.\n  - Check if the domain is newly registered or unexpected.\n  - Check the reputation of the domain or IP address.\n  - Scope other potentially compromised hosts in your environment by mapping hosts that also communicated with the domain or IP address.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate any abnormal account behavior, such as command executions, file creations or modifications, and network connections.\n- Investigate any abnormal behavior by the subject process such as network connections, file modifications, and any spawned child processes.\n\n### False positive analysis\n\n- Netcat is a dual-use tool that can be used for benign or malicious activity. It is included in some Linux distributions, so its presence is not necessarily suspicious. Some normal use of this program, while uncommon, may originate from scripts, automation tools, and frameworks.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Block the identified indicators of compromise (IoCs).\n- Take actions to terminate processes and connections used by the attacker.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 110,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Netcat is a dual-use tool that can be used for benign or malicious activity. Netcat is included in some Linux distributions so its presence is not necessarily suspicious. Some normal use of this program, while uncommon, may originate from scripts, automation tools, and frameworks."
        ],
        "references": [
          "http://pentestmonkey.net/cheat-sheet/shells/reverse-shell-cheat-sheet",
          "https://www.sans.org/security-resources/sec560/netcat_cheat_sheet_v1.pdf",
          "https://en.wikipedia.org/wiki/Netcat",
          "https://www.hackers-arise.com/hacking-fundamentals",
          "https://null-byte.wonderhowto.com/how-to/hack-like-pro-use-netcat-swiss-army-knife-hacking-tools-0148657/",
          "https://levelup.gitconnected.com/ethical-hacking-part-15-netcat-nc-and-netcat-f6a8f7df43fd"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.004",
                    "name": "Unix Shell",
                    "reference": "https://attack.mitre.org/techniques/T1059/004/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from one of the following integrations:\n- Elastic Defend\n- Auditbeat\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n### Auditbeat Setup\nAuditbeat is a lightweight shipper that you can install on your servers to audit the activities of users and processes on your systems. For example, you can use Auditbeat to collect and centralize audit events from the Linux Audit Framework. You can also use Auditbeat to detect changes to critical files, like binaries and configuration files, and identify potential security policy violations.\n\n#### The following steps should be executed in order to add the Auditbeat on a Linux System:\n- Elastic provides repositories available for APT and YUM-based distributions. Note that we provide binary packages, but no source packages.\n- To install the APT and YUM repositories follow the setup instructions in this [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/setup-repositories.html).\n- To run Auditbeat on Docker follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/running-on-docker.html).\n- To run Auditbeat on Kubernetes follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/running-on-kubernetes.html).\n- For complete â€œSetup and Run Auditbeatâ€ information refer to the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/setting-up-and-running.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "fbec9213-272b-4687-b337-f992c11f1098",
        "rule_id": "adb961e0-cb74-42a0-af9e-29fc41f88f5f",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:33.602Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:14.967Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by process.entity_id\n  [process where host.os.type == \"linux\" and event.type == \"start\" and\n      process.name:(\"nc\",\"ncat\",\"netcat\",\"netcat.openbsd\",\"netcat.traditional\") and (\n          /* bind shell to echo for command execution */\n          (process.args:(\"-l\",\"-p\") and process.args:(\"-c\",\"echo\",\"$*\"))\n          /* bind shell to specific port */\n          or process.args:(\"-l\",\"-p\",\"-lp\")\n          /* reverse shell to command-line interpreter used for command execution */\n          or (process.args:(\"-e\") and process.args:(\"/bin/bash\",\"/bin/sh\"))\n          /* file transfer via stdout */\n          or process.args:(\">\",\"<\")\n          /* file transfer via pipe */\n          or (process.args:(\"|\") and process.args:(\"nc\",\"ncat\"))\n      )]\n  [network where host.os.type == \"linux\" and (process.name == \"nc\" or process.name == \"ncat\" or process.name == \"netcat\" or\n                  process.name == \"netcat.openbsd\" or process.name == \"netcat.traditional\")]",
        "language": "eql",
        "index": [
          "auditbeat-*",
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious Execution via Microsoft Office Add-Ins",
        "description": "Identifies execution of common Microsoft Office applications to launch an Office Add-In from a suspicious path or with an unusual parent process. This may indicate an attempt to get initial access via a malicious phishing MS Office Add-In.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 205,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Initial Access",
          "Tactic: Persistence",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: SentinelOne"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/Octoberfest7/XLL_Phishing",
          "https://labs.f-secure.com/archive/add-in-opportunities-for-office-persistence/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1566",
                "name": "Phishing",
                "reference": "https://attack.mitre.org/techniques/T1566/",
                "subtechnique": [
                  {
                    "id": "T1566.001",
                    "name": "Spearphishing Attachment",
                    "reference": "https://attack.mitre.org/techniques/T1566/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1137",
                "name": "Office Application Startup",
                "reference": "https://attack.mitre.org/techniques/T1137/",
                "subtechnique": [
                  {
                    "id": "T1137.006",
                    "name": "Add-ins",
                    "reference": "https://attack.mitre.org/techniques/T1137/006/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "add91827-5e1a-406d-825a-762087e56f12",
        "rule_id": "ae8a142c-6a1d-4918-bea7-0b617e99ecfa",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:33.604Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:14.971Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where \n    \n    host.os.type == \"windows\" and event.type == \"start\" and  \n    \n    process.name : (\"WINWORD.EXE\", \"EXCEL.EXE\", \"POWERPNT.EXE\", \"MSACCESS.EXE\", \"VSTOInstaller.exe\") and \n    \n    process.args regex~ \"\"\".+\\.(wll|xll|ppa|ppam|xla|xlam|vsto)\"\"\" and \n    \n    /* Office Add-In from suspicious paths */\n    (process.args :\n             (\"?:\\\\Users\\\\*\\\\Temp\\\\7z*\",\n              \"?:\\\\Users\\\\*\\\\Temp\\\\Rar$*\",\n              \"?:\\\\Users\\\\*\\\\Temp\\\\Temp?_*\",\n              \"?:\\\\Users\\\\*\\\\Temp\\\\BNZ.*\",\n              \"?:\\\\Users\\\\*\\\\Downloads\\\\*\",\n              \"?:\\\\Users\\\\*\\\\AppData\\\\Roaming\\\\*\",\n              \"?:\\\\Users\\\\Public\\\\*\",\n              \"?:\\\\ProgramData\\\\*\",\n              \"?:\\\\Windows\\\\Temp\\\\*\",\n              \"\\\\Device\\\\*\",\n              \"http*\") or\n\t      \n    process.parent.name : (\"explorer.exe\", \"OpenWith.exe\") or \n    \n    /* Office Add-In from suspicious parent */\n    process.parent.name : (\"cmd.exe\", \"powershell.exe\")) and\n\t  \n    /* False Positives */\n    not (process.args : \"*.vsto\" and\n         process.parent.executable :\n                   (\"?:\\\\Program Files\\\\Logitech\\\\LogiOptions\\\\PlugInInstallerUtility*.exe\",\n                    \"?:\\\\ProgramData\\\\Logishrd\\\\LogiOptions\\\\Plugins\\\\VSTO\\\\*\\\\VSTOInstaller.exe\",\n                    \"?:\\\\Program Files\\\\Logitech\\\\LogiOptions\\\\PlugInInstallerUtility.exe\",\n                    \"?:\\\\Program Files\\\\LogiOptionsPlus\\\\PlugInInstallerUtility*.exe\",\n                    \"?:\\\\ProgramData\\\\Logishrd\\\\LogiOptionsPlus\\\\Plugins\\\\VSTO\\\\*\\\\VSTOInstaller.exe\",\n                    \"?:\\\\Program Files\\\\Common Files\\\\microsoft shared\\\\VSTO\\\\*\\\\VSTOInstaller.exe\")) and\n    not (process.args : \"/Uninstall\" and process.name : \"VSTOInstaller.exe\") and\n    not (process.parent.name : \"rundll32.exe\" and\n         process.parent.args : \"?:\\\\WINDOWS\\\\Installer\\\\MSI*.tmp,zzzzInvokeManagedCustomActionOutOfProc\") and\n    not (process.name : \"VSTOInstaller.exe\" and process.args : \"https://dl.getsidekick.com/outlook/vsto/Sidekick.vsto\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*"
        ],
        "filters": []
      },
      {
        "name": "Local Scheduled Task Creation",
        "description": "Indicates the creation of a scheduled task. Adversaries can use these to establish persistence, move laterally, and/or escalate privileges.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 208,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Legitimate scheduled tasks may be created during installation of new software."
        ],
        "references": [
          "https://www.elastic.co/security-labs/hunting-for-persistence-using-elastic-security-part-1",
          "https://www.elastic.co/security-labs/hunting-for-persistence-using-elastic-security-part-2",
          "https://www.elastic.co/security-labs/invisible-miners-unveiling-ghostengine",
          "https://www.elastic.co/security-labs/elastic-protects-against-data-wiper-malware-targeting-ukraine-hermeticwiper"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1053",
                "name": "Scheduled Task/Job",
                "reference": "https://attack.mitre.org/techniques/T1053/",
                "subtechnique": [
                  {
                    "id": "T1053.005",
                    "name": "Scheduled Task",
                    "reference": "https://attack.mitre.org/techniques/T1053/005/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.Ext.token.integrity_level_name",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.code_signature.trusted",
            "type": "boolean",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.event_data.IntegrityLevel",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "95dff7ef-91fb-42e9-aa6c-be637c2c35a7",
        "rule_id": "afcce5ad-65de-4ed2-8516-5e093d3ac99a",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:33.605Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:14.977Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence with maxspan=1m\n  [process where host.os.type == \"windows\" and event.type != \"end\" and\n    ((process.name : (\"cmd.exe\", \"wscript.exe\", \"rundll32.exe\", \"regsvr32.exe\", \"wmic.exe\", \"mshta.exe\",\n                      \"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\", \"WmiPrvSe.exe\", \"wsmprovhost.exe\", \"winrshost.exe\") or\n    process.pe.original_file_name : (\"cmd.exe\", \"wscript.exe\", \"rundll32.exe\", \"regsvr32.exe\", \"wmic.exe\", \"mshta.exe\",\n                                     \"powershell.exe\", \"pwsh.dll\", \"powershell_ise.exe\", \"WmiPrvSe.exe\", \"wsmprovhost.exe\",\n                                     \"winrshost.exe\")) or\n    ?process.code_signature.trusted == false)] by process.entity_id\n  [process where host.os.type == \"windows\" and event.type == \"start\" and\n    (process.name : \"schtasks.exe\" or process.pe.original_file_name == \"schtasks.exe\") and\n    process.args : (\"/create\", \"-create\") and process.args : (\"/RU\", \"/SC\", \"/TN\", \"/TR\", \"/F\", \"/XML\") and\n    /* exclude SYSTEM Integrity Level - look for task creations by non-SYSTEM user */\n    not (?process.Ext.token.integrity_level_name : \"System\" or ?winlog.event_data.IntegrityLevel : \"System\")\n  ] by process.parent.entity_id",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "Microsoft 365 Exchange Safe Link Policy Disabled",
        "description": "Identifies when a Safe Link policy is disabled in Microsoft 365. Safe Link policies for Office applications extend phishing protection to documents that contain hyperlinks, even after they have been delivered to a user.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Cloud",
          "Data Source: Microsoft 365",
          "Use Case: Identity and Access Audit",
          "Tactic: Initial Access"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-1800s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Disabling safe links may be done by a system or network administrator. Verify that the configuration change was expected. Exceptions can be added to this rule to filter expected behavior."
        ],
        "references": [
          "https://docs.microsoft.com/en-us/powershell/module/exchange/disable-safelinksrule?view=exchange-ps",
          "https://docs.microsoft.com/en-us/microsoft-365/security/office-365-security/atp-safe-links?view=o365-worldwide"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1566",
                "name": "Phishing",
                "reference": "https://attack.mitre.org/techniques/T1566/"
              }
            ]
          }
        ],
        "setup": "The Office 365 Logs Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "o365",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "9bd9163a-45d3-4bc1-b10b-6bbf575ba061",
        "rule_id": "a989fa1b-9a11-4dd8-a3e9-f0de9c6eb5f2",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:33.564Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:14.371Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-o365*"
        ],
        "filters": [],
        "query": "event.dataset:o365.audit and event.provider:Exchange and event.category:web and event.action:\"Disable-SafeLinksRule\" and event.outcome:success",
        "language": "kuery"
      },
      {
        "name": "Potential Persistence via Atom Init Script Modification",
        "description": "Identifies modifications to the Atom desktop text editor Init File. Adversaries may add malicious JavaScript code to the init.coffee file that will be executed upon the Atom application opening.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 106,
        "tags": [
          "Domain: Endpoint",
          "OS: macOS",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/D00MFist/PersistentJXA/blob/master/AtomPersist.js",
          "https://flight-manual.atom.io/hacking-atom/sections/the-init-file/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1037",
                "name": "Boot or Logon Initialization Scripts",
                "reference": "https://attack.mitre.org/techniques/T1037/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a macOS System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, for MacOS it is recommended to select \"Traditional Endpoints\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "df0a997d-51a5-4379-8a41-629225017e76",
        "rule_id": "b4449455-f986-4b5a-82ed-e36b129331f7",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:33.607Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:14.980Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": [],
        "query": "event.category:file and host.os.type:macos and not event.type:\"deletion\" and\n file.path:/Users/*/.atom/init.coffee and not process.name:(Atom or xpcproxy) and not user.name:root",
        "language": "kuery"
      },
      {
        "name": "AWS STS GetSessionToken Abuse",
        "description": "Identifies the suspicious use of GetSessionToken. Tokens could be created and used by attackers to move laterally and escalate privileges.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Cloud",
          "Data Source: AWS",
          "Data Source: Amazon Web Services",
          "Data Source: AWS STS",
          "Use Case: Identity and Access Audit",
          "Tactic: Privilege Escalation"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Austin Songer"
        ],
        "false_positives": [
          "GetSessionToken may be done by a system or network administrator. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. GetSessionToken from unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule."
        ],
        "references": [
          "https://docs.aws.amazon.com/STS/latest/APIReference/API_GetSessionToken.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1548",
                "name": "Abuse Elevation Control Mechanism",
                "reference": "https://attack.mitre.org/techniques/T1548/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1550",
                "name": "Use Alternate Authentication Material",
                "reference": "https://attack.mitre.org/techniques/T1550/",
                "subtechnique": [
                  {
                    "id": "T1550.001",
                    "name": "Application Access Token",
                    "reference": "https://attack.mitre.org/techniques/T1550/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The AWS Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "aws",
            "version": "^2.0.0",
            "integration": "cloudtrail"
          }
        ],
        "required_fields": [
          {
            "name": "aws.cloudtrail.user_identity.type",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "8394c59a-3e12-4e96-9f3f-4df4d84b2338",
        "rule_id": "b45ab1d2-712f-4f01-a751-df3826969807",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:33.609Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:14.991Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-aws.cloudtrail-*"
        ],
        "filters": [],
        "query": "event.dataset:aws.cloudtrail and event.provider:sts.amazonaws.com and event.action:GetSessionToken and\naws.cloudtrail.user_identity.type:IAMUser and event.outcome:success",
        "language": "kuery"
      },
      {
        "name": "Clearing Windows Console History",
        "description": "Identifies when a user attempts to clear console history. An adversary may clear the command history of a compromised account to conceal the actions undertaken during an intrusion.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Clearing Windows Console History\n\nPowerShell is one of the main tools system administrators use for automation, report routines, and other tasks. This makes it available for use in various environments, and creates an attractive way for attackers to execute code.\n\nAttackers can try to cover their tracks by clearing PowerShell console history. PowerShell has two different ways of logging commands: the built-in history and the command history managed by the PSReadLine module. This rule looks for the execution of commands that can clear the built-in PowerShell logs or delete the `ConsoleHost_history.txt` file.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n  - Verify if any other anti-forensics behaviors were observed.\n- Investigate the PowerShell logs on the SIEM to determine if there was suspicious behavior that an attacker may be trying to cover up.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n  - Ensure that PowerShell auditing policies and log collection are in place to grant future visibility.\n",
        "output_index": "",
        "version": 313,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Tactic: Execution",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Austin Songer"
        ],
        "false_positives": [],
        "references": [
          "https://stefanos.cloud/kb/how-to-clear-the-powershell-command-history/",
          "https://www.shellhacks.com/clear-history-powershell/",
          "https://community.sophos.com/sophos-labs/b/blog/posts/powershell-command-history-forensics"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1070",
                "name": "Indicator Removal",
                "reference": "https://attack.mitre.org/techniques/T1070/",
                "subtechnique": [
                  {
                    "id": "T1070.003",
                    "name": "Clear Command History",
                    "reference": "https://attack.mitre.org/techniques/T1070/003/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "da67ba56-e6dc-4135-8e66-0e979115a48c",
        "rule_id": "b5877334-677f-4fb9-86d5-a9721274223b",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:33.611Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:14.995Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (\n    process.name : (\"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\") or\n    ?process.pe.original_file_name in (\"powershell.exe\", \"pwsh.dll\", \"powershell_ise.exe\")\n  ) and\n  (\n    process.args : \"*Clear-History*\" or\n    (process.args : (\"*Remove-Item*\", \"rm\") and process.args : (\"*ConsoleHost_history.txt*\", \"*(Get-PSReadlineOption).HistorySavePath*\")) or\n    (process.args : \"*Set-PSReadlineOption*\" and process.args : \"*SaveNothing*\")\n  )",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Windows Script Interpreter Executing Process via WMI",
        "description": "Identifies use of the built-in Windows script interpreters (cscript.exe or wscript.exe) being used to execute a process via Windows Management Instrumentation (WMI). This may be indicative of malicious activity.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 210,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Initial Access",
          "Tactic: Execution",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1566",
                "name": "Phishing",
                "reference": "https://attack.mitre.org/techniques/T1566/",
                "subtechnique": [
                  {
                    "id": "T1566.001",
                    "name": "Spearphishing Attachment",
                    "reference": "https://attack.mitre.org/techniques/T1566/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1047",
                "name": "Windows Management Instrumentation",
                "reference": "https://attack.mitre.org/techniques/T1047/"
              },
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.005",
                    "name": "Visual Basic",
                    "reference": "https://attack.mitre.org/techniques/T1059/005/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "dll.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.domain",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "c6b5ced5-db32-4d20-92e7-8c4e1d0c0868",
        "rule_id": "b64b183e-1a76-422d-9179-7b389513e74d",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:33.614Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:15.002Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by host.id with maxspan = 5s\n    [any where host.os.type == \"windows\" and \n     (event.category : (\"library\", \"driver\") or (event.category == \"process\" and event.action : \"Image loaded*\")) and\n     (?dll.name : \"wmiutils.dll\" or file.name : \"wmiutils.dll\") and process.name : (\"wscript.exe\", \"cscript.exe\")]\n    [process where host.os.type == \"windows\" and event.type == \"start\" and\n     process.parent.name : \"wmiprvse.exe\" and\n     user.domain != \"NT AUTHORITY\" and\n     (process.pe.original_file_name :\n        (\n          \"cscript.exe\",\n          \"wscript.exe\",\n          \"PowerShell.EXE\",\n          \"Cmd.Exe\",\n          \"MSHTA.EXE\",\n          \"RUNDLL32.EXE\",\n          \"REGSVR32.EXE\",\n          \"MSBuild.exe\",\n          \"InstallUtil.exe\",\n          \"RegAsm.exe\",\n          \"RegSvcs.exe\",\n          \"msxsl.exe\",\n          \"CONTROL.EXE\",\n          \"EXPLORER.EXE\",\n          \"Microsoft.Workflow.Compiler.exe\",\n          \"msiexec.exe\"\n        ) or\n      process.executable : (\"C:\\\\Users\\\\*.exe\", \"C:\\\\ProgramData\\\\*.exe\")\n     )\n    ]",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-endpoint.events.library-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "Volume Shadow Copy Deleted or Resized via VssAdmin",
        "description": "Identifies use of vssadmin.exe for shadow copy deletion or resizing on endpoints. This commonly occurs in tandem with ransomware or other destructive attacks.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Volume Shadow Copy Deleted or Resized via VssAdmin\n\nThe Volume Shadow Copy Service (VSS) is a Windows feature that enables system administrators to take snapshots of volumes that can later be restored or mounted to recover specific files or folders.\n\nA typical step in the playbook of an attacker attempting to deploy ransomware is to delete Volume Shadow Copies to ensure that victims have no alternative to paying the ransom, making any action that deletes shadow copies worth monitoring.\n\nThis rule monitors the execution of Vssadmin.exe to either delete or resize shadow copies.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- In the case of a resize operation, check if the resize value is equal to suspicious values, like 401MB.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- If unsigned files are found on the process tree, retrieve them and determine if they are malicious:\n  - Use a private sandboxed malware analysis system to perform analysis.\n    - Observe and collect information about the following activities:\n      - Attempts to contact external domains and addresses.\n      - File and registry access, modification, and creation activities.\n      - Service creation and launch activities.\n      - Scheduled task creation.\n  - Use the PowerShell Get-FileHash cmdlet to get the files' SHA-256 hash values.\n    - Search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Use process name, command line, and file hash to search for occurrences in other hosts.\n- Check if any files on the host machine have been encrypted.\n\n\n### False positive analysis\n\n- This rule may produce benign true positives (B-TPs). If this activity is expected and noisy in your environment, consider adding exceptions â€” preferably with a combination of user and command line conditions.\n\n### Related rules\n\n- Volume Shadow Copy Deleted or Resized via VssAdmin - b5ea4bfe-a1b2-421f-9d47-22a75a6f2921\n- Volume Shadow Copy Deletion via PowerShell - d99a037b-c8e2-47a5-97b9-170d076827c4\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Consider isolating the involved host to prevent destructive behavior, which is commonly associated with this activity.\n- Priority should be given due to the advanced stage of this activity on the attack.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- If data was encrypted, deleted, or modified, activate your data recovery plan.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Perform data recovery locally or restore the backups from replicated copies (cloud, other servers, etc.).\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 313,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Impact",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0040",
              "name": "Impact",
              "reference": "https://attack.mitre.org/tactics/TA0040/"
            },
            "technique": [
              {
                "id": "T1490",
                "name": "Inhibit System Recovery",
                "reference": "https://attack.mitre.org/techniques/T1490/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "43001a4e-bd72-4bc1-9af7-527abbb40645",
        "rule_id": "b5ea4bfe-a1b2-421f-9d47-22a75a6f2921",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:33.612Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:14.998Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (process.name : \"vssadmin.exe\" or ?process.pe.original_file_name == \"VSSADMIN.EXE\") and\n  process.args : (\"delete\", \"resize\") and process.args : \"shadows*\"",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Creation or Modification of Domain Backup DPAPI private key",
        "description": "Identifies the creation or modification of Domain Backup private keys. Adversaries may extract the Data Protection API (DPAPI) domain backup key from a Domain Controller (DC) to be able to decrypt any domain user master key file.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\nDomain DPAPI Backup keys are stored on domain controllers and can be dumped remotely with tools such as Mimikatz. The resulting .pvk private key can be used to decrypt ANY domain user masterkeys, which then can be used to decrypt any secrets protected by those keys.\n",
        "output_index": "",
        "version": 412,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.dsinternals.com/en/retrieving-dpapi-backup-keys-from-active-directory/",
          "https://posts.specterops.io/operational-guidance-for-offensive-user-dpapi-abuse-1fb7fac8b107"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1552",
                "name": "Unsecured Credentials",
                "reference": "https://attack.mitre.org/techniques/T1552/",
                "subtechnique": [
                  {
                    "id": "T1552.004",
                    "name": "Private Keys",
                    "reference": "https://attack.mitre.org/techniques/T1552/004/"
                  }
                ]
              },
              {
                "id": "T1555",
                "name": "Credentials from Password Stores",
                "reference": "https://attack.mitre.org/techniques/T1555/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "f0d54120-b46a-47b3-ae86-d3af86b63975",
        "rule_id": "b83a7e96-2eb3-4edf-8346-427b6858d3bd",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:33.633Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:15.012Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"windows\" and event.type != \"deletion\" and file.name : (\"ntds_capi_*.pfx\", \"ntds_capi_*.pvk\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.file-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-m365_defender.event-*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Administrator Privileges Assigned to an Okta Group",
        "description": "Detects when an administrator role is assigned to an Okta group. An adversary may attempt to assign administrator privileges to an Okta group in order to assign additional permissions to compromised user accounts and maintain access to their target organization.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 409,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Data Source: Okta",
          "Tactic: Persistence"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Administrator roles may be assigned to Okta users by a Super Admin user. Verify that the behavior was expected. Exceptions can be added to this rule to filter expected behavior."
        ],
        "references": [
          "https://help.okta.com/en/prod/Content/Topics/Security/administrators-admin-comparison.htm",
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1098",
                "name": "Account Manipulation",
                "reference": "https://attack.mitre.org/techniques/T1098/"
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "54a2bfc8-f79e-4283-a6f8-c826fa06ae21",
        "rule_id": "b8075894-0b62-46e5-977c-31275da34419",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:33.792Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:15.008Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset:okta.system and event.action:group.privilege.grant",
        "language": "kuery"
      },
      {
        "name": "UAC Bypass Attempt with IEditionUpgradeManager Elevated COM Interface",
        "description": "Identifies attempts to bypass User Account Control (UAC) by abusing an elevated COM Interface to launch a rogue Windows ClipUp program. Attackers may attempt to bypass UAC to stealthily execute code with elevated permissions.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 309,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Tactic: Defense Evasion",
          "Tactic: Execution",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: SentinelOne"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/hfiref0x/UACME"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1548",
                "name": "Abuse Elevation Control Mechanism",
                "reference": "https://attack.mitre.org/techniques/T1548/",
                "subtechnique": [
                  {
                    "id": "T1548.002",
                    "name": "Bypass User Account Control",
                    "reference": "https://attack.mitre.org/techniques/T1548/002/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1548",
                "name": "Abuse Elevation Control Mechanism",
                "reference": "https://attack.mitre.org/techniques/T1548/",
                "subtechnique": [
                  {
                    "id": "T1548.002",
                    "name": "Bypass User Account Control",
                    "reference": "https://attack.mitre.org/techniques/T1548/002/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1559",
                "name": "Inter-Process Communication",
                "reference": "https://attack.mitre.org/techniques/T1559/",
                "subtechnique": [
                  {
                    "id": "T1559.001",
                    "name": "Component Object Model",
                    "reference": "https://attack.mitre.org/techniques/T1559/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "3a26f809-8316-413c-ba05-bf5863f184b9",
        "rule_id": "b90cdde7-7e0d-4359-8bf0-2c112ce2008a",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:34.628Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:15.018Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and process.name : \"Clipup.exe\" and\n  not process.executable : \"C:\\\\Windows\\\\System32\\\\ClipUp.exe\" and process.parent.name : \"dllhost.exe\" and\n  /* CLSID of the Elevated COM Interface IEditionUpgradeManager */\n  process.parent.args : \"/Processid:{BD54C901-076B-434E-B6C7-17C531F4AB41}\"",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*"
        ],
        "filters": []
      },
      {
        "name": "Creation of Hidden Files and Directories via CommandLine",
        "description": "Users can mark specific files as hidden simply by putting a \".\" as the first character in the file or folder name. Adversaries can use this to their advantage to hide files and folders on the system for persistence and defense evasion. This rule looks for hidden files or folders in common writable directories.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 111,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Certain tools may create hidden temporary files or directories upon installation or as part of their normal behavior. These events can be filtered by the process arguments, username, or process name values."
        ],
        "references": [],
        "max_signals": 33,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1564",
                "name": "Hide Artifacts",
                "reference": "https://attack.mitre.org/techniques/T1564/",
                "subtechnique": [
                  {
                    "id": "T1564.001",
                    "name": "Hidden Files and Directories",
                    "reference": "https://attack.mitre.org/techniques/T1564/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            }
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from one of the following integrations:\n- Elastic Defend\n- Auditbeat\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n### Auditbeat Setup\nAuditbeat is a lightweight shipper that you can install on your servers to audit the activities of users and processes on your systems. For example, you can use Auditbeat to collect and centralize audit events from the Linux Audit Framework. You can also use Auditbeat to detect changes to critical files, like binaries and configuration files, and identify potential security policy violations.\n\n#### The following steps should be executed in order to add the Auditbeat on a Linux System:\n- Elastic provides repositories available for APT and YUM-based distributions. Note that we provide binary packages, but no source packages.\n- To install the APT and YUM repositories follow the setup instructions in this [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/setup-repositories.html).\n- To run Auditbeat on Docker follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/running-on-docker.html).\n- To run Auditbeat on Kubernetes follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/running-on-kubernetes.html).\n- For complete â€œSetup and Run Auditbeatâ€ information refer to the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/setting-up-and-running.html).\n\n#### Custom Ingest Pipeline\nFor versions <8.2, you need to add a custom ingest pipeline to populate `event.ingested` with @timestamp for non-elastic-agent indexes, like auditbeats/filebeat/winlogbeat etc. For more details to add a custom ingest pipeline refer to the [guide](https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.working_directory",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "e501d4cd-a3e2-4067-a39f-853667b5c9d7",
        "rule_id": "b9666521-4742-49ce-9ddc-b8e84c35acae",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:34.630Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:16.424Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\nprocess.working_directory in (\"/tmp\", \"/var/tmp\", \"/dev/shm\") and\nprocess.args regex~ \"\"\"\\.[a-z0-9_\\-][a-z0-9_\\-\\.]{1,254}\"\"\" and\nnot process.name in (\n  \"ls\", \"find\", \"grep\", \"git\", \"jq\", \"basename\", \"check_snmp\", \"snmpget\", \"snmpwalk\", \"cc1plus\", \"snap\",\n  \"command-not-found\"\n)",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Network Connection via MsXsl",
        "description": "Identifies msxsl.exe making a network connection. This may indicate adversarial activity as msxsl.exe is often leveraged by adversaries to execute malicious scripts and evade detection.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.iana.org/assignments/iana-ipv4-special-registry/iana-ipv4-special-registry.xhtml"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1220",
                "name": "XSL Script Processing",
                "reference": "https://attack.mitre.org/techniques/T1220/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "c2369e5b-f6bf-43dd-b92e-18e346fa9d4e",
        "rule_id": "b86afe07-0d98-4738-b15d-8d7465f95ff5",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:34.645Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:15.015Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by process.entity_id\n  [process where host.os.type == \"windows\" and process.name : \"msxsl.exe\" and event.type == \"start\"]\n  [network where host.os.type == \"windows\" and process.name : \"msxsl.exe\" and\n     not cidrmatch(destination.ip, \"10.0.0.0/8\", \"127.0.0.0/8\", \"169.254.0.0/16\", \"172.16.0.0/12\", \"192.0.0.0/24\",\n       \"192.0.0.0/29\", \"192.0.0.8/32\", \"192.0.0.9/32\", \"192.0.0.10/32\", \"192.0.0.170/32\", \"192.0.0.171/32\",\n       \"192.0.2.0/24\", \"192.31.196.0/24\", \"192.52.193.0/24\", \"192.168.0.0/16\", \"192.88.99.0/24\", \"224.0.0.0/4\",\n       \"100.64.0.0/10\", \"192.175.48.0/24\",\"198.18.0.0/15\", \"198.51.100.0/24\", \"203.0.113.0/24\", \"240.0.0.0/4\", \"::1\",\n       \"FE80::/10\", \"FF00::/8\")]",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-endpoint.events.network-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "SolarWinds Process Disabling Services via Registry",
        "description": "Identifies a SolarWinds binary modifying the start type of a service to be disabled. An adversary may abuse this technique to manipulate relevant security services.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 311,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Tactic: Initial Access",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: SentinelOne"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.fireeye.com/blog/threat-research/2020/12/evasive-attacker-leverages-solarwinds-supply-chain-compromises-with-sunburst-backdoor.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1112",
                "name": "Modify Registry",
                "reference": "https://attack.mitre.org/techniques/T1112/"
              },
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.001",
                    "name": "Disable or Modify Tools",
                    "reference": "https://attack.mitre.org/techniques/T1562/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1195",
                "name": "Supply Chain Compromise",
                "reference": "https://attack.mitre.org/techniques/T1195/",
                "subtechnique": [
                  {
                    "id": "T1195.002",
                    "name": "Compromise Software Supply Chain",
                    "reference": "https://attack.mitre.org/techniques/T1195/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.data.strings",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "registry.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.value",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "18968f6c-49a4-48b5-a997-4c772c68eada",
        "rule_id": "b9960fef-82c6-4816-befa-44745030e917",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:34.647Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:16.240Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "registry where host.os.type == \"windows\" and event.type == \"change\" and registry.value : \"Start\" and\n  process.name : (\n      \"SolarWinds.BusinessLayerHost*.exe\",\n      \"ConfigurationWizard*.exe\",\n      \"NetflowDatabaseMaintenance*.exe\",\n      \"NetFlowService*.exe\",\n      \"SolarWinds.Administration*.exe\",\n      \"SolarWinds.Collector.Service*.exe\",\n      \"SolarwindsDiagnostics*.exe\"\n  ) and\n  registry.path : (\n    \"HKLM\\\\SYSTEM\\\\*ControlSet*\\\\Services\\\\*\\\\Start\",\n    \"\\\\REGISTRY\\\\MACHINE\\\\SYSTEM\\\\*ControlSet*\\\\Services\\\\*\\\\Start\",\n    \"MACHINE\\\\SYSTEM\\\\*ControlSet*\\\\Services\\\\*\\\\Start\"\n  ) and\n  registry.data.strings : (\"4\", \"0x00000004\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.registry-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*"
        ],
        "filters": []
      },
      {
        "name": "Unusual Windows Network Activity",
        "description": "Identifies Windows processes that do not usually use the network but have unexpected network activity, which can indicate command-and-control, lateral movement, persistence, or data exfiltration activity. A process with unusual network activity can denote process exploitation or injection, where the process is used to run persistence mechanisms that allow a malicious actor remote access or control of the host, data exfiltration, and execution of unauthorized network applications.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Unusual Network Activity\nDetection alerts from this rule indicate the presence of network activity from a Windows process for which network activity is very unusual.  Here are some possible avenues of investigation:\n- Consider the IP addresses, protocol and ports. Are these used by normal but infrequent network workflows? Are they expected or unexpected?\n- If the destination IP address is remote or external, does it associate with an expected domain, organization or geography? Note: avoid interacting directly with suspected malicious IP addresses.\n- Consider the user as identified by the username field. Is this network activity part of an expected workflow for the user who ran the program?\n- Examine the history of execution. If this process only manifested recently, it might be part of a new software package. If it has a consistent cadence (for example if it runs monthly or quarterly), it might be part of a monthly or quarterly business process.\n- Examine the process arguments, title and working directory. These may provide indications as to the source of the program or the nature of the tasks it is performing.\n- Consider the same for the parent process. If the parent process is a legitimate system utility or service, this could be related to software updates or system management. If the parent process is something user-facing like an Office application, this process could be more suspicious.\n- If you have file hash values in the event data, and you suspect malware, you can optionally run a search for the file hash to see if the file is identified as malware by anti-malware tools.",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Rule Type: ML",
          "Rule Type: Machine Learning"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "15m",
        "from": "now-2700s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "A newly installed program or one that rarely uses the network could trigger this alert."
        ],
        "references": [
          "https://www.elastic.co/guide/en/security/current/prebuilt-ml-jobs.html"
        ],
        "max_signals": 100,
        "threat": [],
        "setup": "## Setup\n\nThis rule requires the installation of associated Machine Learning jobs, as well as data coming in from one of the following integrations:\n- Elastic Defend\n- Windows\n\n### Anomaly Detection Setup\n\nOnce the rule is enabled, the associated Machine Learning job will start automatically. You can view the Machine Learning job linked under the \"Definition\" panel of the detection rule. If the job does not start due to an error, the issue must be resolved for the job to commence successfully. For more details on setting up anomaly detection jobs, refer to the [helper guide](https://www.elastic.co/guide/en/kibana/current/xpack-ml-anomalies.html).\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration to your system:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n### Windows Integration Setup\nThe Windows integration allows you to monitor the Windows OS, services, applications, and more.\n\n#### The following steps should be executed in order to add the Elastic Agent System integration \"windows\" to your system:\n- Go to the Kibana home page and click â€œAdd integrationsâ€.\n- In the query bar, search for â€œWindowsâ€ and select the integration to see more details about it.\n- Click â€œAdd Windowsâ€.\n- Configure the integration name and optionally add a description.\n- Review optional and advanced settings accordingly.\n- Add the newly installed â€œwindowsâ€ to an existing or a new agent policy, and deploy the agent on your system from which windows log files are desirable.\n- Click â€œSave and Continueâ€.\n- For more details on the integration refer to the [helper guide](https://docs.elastic.co/integrations/windows).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [],
        "id": "170bdbf2-3663-4c4a-8015-df31bdf8c507",
        "rule_id": "ba342eb2-583c-439f-b04d-1fdd7c1417cc",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:34.657Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:16.243Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "machine_learning",
        "anomaly_threshold": 50,
        "machine_learning_job_id": [
          "v3_windows_anomalous_network_activity"
        ]
      },
      {
        "name": "AWS EC2 Encryption Disabled",
        "description": "Identifies disabling of Amazon Elastic Block Store (EBS) encryption by default in the current region. Disabling encryption by default does not change the encryption status of your existing volumes.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Cloud",
          "Data Source: AWS",
          "Data Source: Amazon Web Services",
          "Data Source: AWS EC2",
          "Tactic: Impact"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-3600s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Disabling encryption may be done by a system or network administrator. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. Disabling encryption by unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule."
        ],
        "references": [
          "https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/EBSEncryption.html",
          "https://awscli.amazonaws.com/v2/documentation/api/latest/reference/ec2/disable-ebs-encryption-by-default.html",
          "https://docs.aws.amazon.com/AWSEC2/latest/APIReference/API_DisableEbsEncryptionByDefault.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0040",
              "name": "Impact",
              "reference": "https://attack.mitre.org/tactics/TA0040/"
            },
            "technique": [
              {
                "id": "T1565",
                "name": "Data Manipulation",
                "reference": "https://attack.mitre.org/techniques/T1565/",
                "subtechnique": [
                  {
                    "id": "T1565.001",
                    "name": "Stored Data Manipulation",
                    "reference": "https://attack.mitre.org/techniques/T1565/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The AWS Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "aws",
            "version": "^2.0.0",
            "integration": "cloudtrail"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "52eb0ac8-cd9d-42cf-8e77-ea20654fcff3",
        "rule_id": "bb9b13b2-1700-48a8-a750-b43b0a72ab69",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:34.661Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:16.253Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-aws.cloudtrail-*"
        ],
        "filters": [],
        "query": "event.dataset:aws.cloudtrail and event.provider:ec2.amazonaws.com and event.action:DisableEbsEncryptionByDefault and event.outcome:success",
        "language": "kuery"
      },
      {
        "name": "OneDrive Malware File Upload",
        "description": "Identifies the occurence of files uploaded to OneDrive being detected as Malware by the file scanning engine. Attackers can use File Sharing and Organization Repositories to spread laterally within the company and amplify their access. Users can inadvertently share these files without knowing their maliciousness, giving adversaries opportunity to gain initial access to other endpoints in the environment.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Cloud",
          "Data Source: Microsoft 365",
          "Tactic: Lateral Movement"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-1800s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Benign files can trigger signatures in the built-in virus protection"
        ],
        "references": [
          "https://docs.microsoft.com/en-us/microsoft-365/security/office-365-security/virus-detection-in-spo?view=o365-worldwide"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1080",
                "name": "Taint Shared Content",
                "reference": "https://attack.mitre.org/techniques/T1080/"
              }
            ]
          }
        ],
        "setup": "The Office 365 Logs Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "o365",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.code",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "2e02ed01-c256-423d-9380-7cc494c6262b",
        "rule_id": "bba1b212-b85c-41c6-9b28-be0e5cdfc9b1",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:34.663Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:16.256Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-o365*"
        ],
        "filters": [],
        "query": "event.dataset:o365.audit and event.provider:OneDrive and event.code:SharePointFileOperation and event.action:FileMalwareDetected",
        "language": "kuery"
      },
      {
        "name": "Suspicious Image Load (taskschd.dll) from MS Office",
        "description": "Identifies a suspicious image load (taskschd.dll) from Microsoft Office processes. This behavior may indicate adversarial activity where a scheduled task is configured via Windows Component Object Model (COM). This technique can be used to configure persistence and evade monitoring by avoiding the usage of the traditional Windows binary (schtasks.exe) used to manage scheduled tasks.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Suspicious Image Load (taskschd.dll) from MS Office\n\nMicrosoft Office, a widely used suite of productivity applications, is frequently targeted by attackers due to its popularity in corporate environments. These attackers exploit its extensive capabilities, like macro scripts in Word and Excel, to gain initial access to systems. They often use Office documents as delivery mechanisms for malware or phishing attempts, taking advantage of their trusted status in professional settings.\n\n`taskschd.dll` provides Command Object Model (COM) interfaces for the Windows Task Scheduler service, allowing developers to programmatically manage scheduled tasks.\n\nThis rule looks for an MS Office process loading `taskschd.dll`, which may indicate an adversary abusing COM to configure a scheduled task. This can happen as part of a phishing attack, when a malicious office document registers the scheduled task to download the malware \"stage 2\" or to establish persistent access.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n### Possible investigation steps\n\n- Analyze the host's scheduled tasks and explore the related Windows events to determine if tasks were created or deleted (Event IDs 4698 and 4699).\n- Investigate any abnormal behavior by the subject process, such as network connections, registry or file modifications, and spawned child processes.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Inspect the host for suspicious or abnormal behavior in the alert timeframe.\n- Examine the files downloaded during the past 24 hours.\n  - Identify files that are related or can be executed in MS Office.\n  - Identify and analyze macros that these documents contain.\n    - Identify suspicious traits in the office macros, such as encoded or encrypted sections.\n- Retrieve the suspicious files identified in the previous step and determine if they are malicious:\n  - Analyze the file using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Any activity that triggered the alert and is not inherently malicious must be monitored by the security team.\n\n### Related Rules\n\n- Suspicious WMI Image Load from MS Office - 891cb88e-441a-4c3e-be2d-120d99fe7b0d\n\n### Response and Remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n  - If the malicious file was delivered via phishing:\n    - Block the email sender from sending future emails.\n    - Block the malicious web pages.\n    - Remove emails from the sender from mailboxes.\n    - Consider improvements to the security awareness program.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 209,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Tactic: Execution",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://medium.com/threatpunter/detecting-adversary-tradecraft-with-image-load-event-logging-and-eql-8de93338c16",
          "https://www.clearskysec.com/wp-content/uploads/2020/10/Operation-Quicksand.pdf"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1053",
                "name": "Scheduled Task/Job",
                "reference": "https://attack.mitre.org/techniques/T1053/",
                "subtechnique": [
                  {
                    "id": "T1053.005",
                    "name": "Scheduled Task",
                    "reference": "https://attack.mitre.org/techniques/T1053/005/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1053",
                "name": "Scheduled Task/Job",
                "reference": "https://attack.mitre.org/techniques/T1053/",
                "subtechnique": [
                  {
                    "id": "T1053.005",
                    "name": "Scheduled Task",
                    "reference": "https://attack.mitre.org/techniques/T1053/005/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "dll.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "ded26ee1-9e20-466e-82bc-4f300676d7f1",
        "rule_id": "baa5d22c-5e1c-4f33-bfc9-efa73bb53022",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:34.659Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:16.247Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "any where host.os.type == \"windows\" and\n (event.category : (\"library\", \"driver\") or (event.category == \"process\" and event.action : \"Image loaded*\")) and\n  process.name : (\"WINWORD.EXE\", \"EXCEL.EXE\", \"POWERPNT.EXE\", \"MSPUB.EXE\", \"MSACCESS.EXE\") and\n  (?dll.name : \"taskschd.dll\" or file.name : \"taskschd.dll\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.library-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "AWS Root Login Without MFA",
        "description": "Identifies attempts to login to AWS as the root user without using multi-factor authentication (MFA). Amazon AWS best practices indicate that the root user should be protected by MFA.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating AWS Root Login Without MFA\n\nMulti-factor authentication (MFA) in AWS is a simple best practice that adds an extra layer of protection on top of your user name and password. With MFA enabled, when a user signs in to an AWS Management Console, they will be prompted for their user name and password, as well as for an authentication code from their AWS MFA device. Taken together, these multiple factors provide increased security for your AWS account settings and resources.\n\nFor more information about using MFA in AWS, access the [official documentation](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_mfa.html).\n\nThe AWS root account is the one identity that has complete access to all AWS services and resources in the account, which is created when the AWS account is created. AWS strongly recommends that you do not use the root user for your everyday tasks, even the administrative ones. Instead, adhere to the best practice of using the root user only to create your first IAM user. Then securely lock away the root user credentials and use them to perform only a few account and service management tasks. Amazon provides a [list of the tasks that require root user](https://docs.aws.amazon.com/general/latest/gr/root-vs-iam.html#aws_tasks-that-require-root).\n\nThis rule looks for attempts to log in to AWS as the root user without using multi-factor authentication (MFA), meaning the account is not secured properly.\n\n#### Possible investigation steps\n\n- Investigate other alerts associated with the user account during the past 48 hours.\n- Examine whether this activity is common in the environment by looking for past occurrences on your logs.\n- Consider the source IP address and geolocation for the calling user who issued the command. Do they look normal for the calling user?\n- Examine the commands, API calls, and data management actions performed by the account in the last 24 hours.\n- Contact the account owner and confirm whether they are aware of this activity.\n- If you suspect the account has been compromised, scope potentially compromised assets by tracking access to servers,\nservices, and data accessed by the account in the last 24 hours.\n\n### False positive analysis\n\n- While this activity is not inherently malicious, the root account must use MFA. The security team should address any potential benign true positive (B-TP), as this configuration can risk the entire cloud environment.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Identify the possible impact of the incident and prioritize accordingly; the following actions can help you gain context:\n    - Identify the account role in the cloud environment.\n    - Identify the services or servers involved criticality.\n    - Work with your IT team to identify and minimize the impact on users.\n    - Identify if the attacker is moving laterally and compromising other accounts, servers, or services.\n    - Identify if there are any regulatory or legal ramifications related to this activity.\n- Configure multi-factor authentication for the user.\n- Follow security best practices [outlined](https://aws.amazon.com/premiumsupport/knowledge-center/security-best-practices/) by AWS.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).",
        "output_index": "",
        "version": 209,
        "tags": [
          "Domain: Cloud",
          "Data Source: AWS",
          "Data Source: Amazon Web Services",
          "Data Source: AWS Route53",
          "Use Case: Identity and Access Audit",
          "Resources: Investigation Guide",
          "Tactic: Privilege Escalation"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-3600s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Some organizations allow login with the root user without MFA, however, this is not considered best practice by AWS and increases the risk of compromised credentials."
        ],
        "references": [
          "https://docs.aws.amazon.com/IAM/latest/UserGuide/id_root-user.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1078",
                "name": "Valid Accounts",
                "reference": "https://attack.mitre.org/techniques/T1078/"
              }
            ]
          }
        ],
        "setup": "The AWS Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "aws",
            "version": "^2.0.0",
            "integration": "cloudtrail"
          }
        ],
        "required_fields": [
          {
            "name": "aws.cloudtrail.console_login.additional_eventdata.mfa_used",
            "type": "boolean",
            "ecs": false
          },
          {
            "name": "aws.cloudtrail.user_identity.type",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "d31a49df-0a4d-41f9-a7c8-41f1cdff9d3b",
        "rule_id": "bc0c6f0d-dab0-47a3-b135-0925f0a333bc",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:34.664Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:16.263Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-aws.cloudtrail-*"
        ],
        "filters": [],
        "query": "event.dataset:aws.cloudtrail and event.provider:signin.amazonaws.com and event.action:ConsoleLogin and\n  aws.cloudtrail.user_identity.type:Root and\n  aws.cloudtrail.console_login.additional_eventdata.mfa_used:false and\n  event.outcome:success",
        "language": "kuery"
      },
      {
        "name": "Potential Non-Standard Port SSH connection",
        "description": "Identifies potentially malicious processes communicating via a port paring typically not associated with SSH. For example, SSH over port 2200 or port 2222 as opposed to the traditional port 22. Adversaries may make changes to the standard port a protocol uses to bypass filtering or muddle analysis/parsing of network data.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 6,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Command and Control",
          "OS: macOS",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "SSH over ports apart from the traditional port 22 is highly uncommon. This rule alerts the usage of the such uncommon ports by the ssh service. Tuning is needed to have higher confidence. If this activity is expected and noisy in your environment, consider adding exceptions â€” preferably with a combination whitelisted ports for such legitimate ssh activities."
        ],
        "references": [
          "https://attack.mitre.org/techniques/T1571/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            },
            "technique": [
              {
                "id": "T1571",
                "name": "Non-Standard Port",
                "reference": "https://attack.mitre.org/techniques/T1571/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "destination.port",
            "type": "long",
            "ecs": true
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "network.transport",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "42815008-e153-47e2-9d2d-30aa95b08d7f",
        "rule_id": "bc8ca7e0-92fd-4b7c-b11e-ee0266b8d9c9",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:34.666Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:16.280Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by process.entity_id with maxspan=1m\n  [process where event.action == \"exec\" and process.name in (\"ssh\", \"sshd\") and not process.parent.name in (\n   \"rsync\", \"pyznap\", \"git\", \"ansible-playbook\", \"scp\", \"pgbackrest\", \"git-lfs\", \"expect\", \"Sourcetree\", \"ssh-copy-id\",\n   \"run\"\n   )\n  ]\n  [network where process.name:\"ssh\" and event.action in (\"connection_attempted\", \"connection_accepted\") and \n   destination.port != 22 and network.transport == \"tcp\" and not (\n     destination.ip == null or destination.ip == \"0.0.0.0\" or cidrmatch(\n       destination.ip, \"10.0.0.0/8\", \"127.0.0.0/8\", \"169.254.0.0/16\", \"172.16.0.0/12\", \"192.0.0.0/24\", \"192.0.0.0/29\",\n       \"192.0.0.8/32\", \"192.0.0.9/32\", \"192.0.0.10/32\", \"192.0.0.170/32\", \"192.0.0.171/32\", \"192.0.2.0/24\",\n       \"192.31.196.0/24\", \"192.52.193.0/24\", \"192.168.0.0/16\", \"192.88.99.0/24\", \"224.0.0.0/4\", \"100.64.0.0/10\",\n       \"192.175.48.0/24\",\"198.18.0.0/15\", \"198.51.100.0/24\", \"203.0.113.0/24\", \"240.0.0.0/4\", \"::1\", \"FE80::/10\",\n       \"FF00::/8\"\n     )\n   )\n  ]",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Searching for Saved Credentials via VaultCmd",
        "description": "Windows Credential Manager allows you to create, view, or delete saved credentials for signing into websites, connected applications, and networks. An adversary may abuse this to list or dump credentials stored in the Credential Manager for saved usernames and passwords. This may also be performed in preparation of lateral movement.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 312,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://medium.com/threatpunter/detecting-adversary-tradecraft-with-image-load-event-logging-and-eql-8de93338c16",
          "https://web.archive.org/web/20201004080456/https://rastamouse.me/blog/rdp-jump-boxes/",
          "https://www.elastic.co/security-labs/detect-credential-access"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1003",
                "name": "OS Credential Dumping",
                "reference": "https://attack.mitre.org/techniques/T1003/"
              },
              {
                "id": "T1555",
                "name": "Credentials from Password Stores",
                "reference": "https://attack.mitre.org/techniques/T1555/",
                "subtechnique": [
                  {
                    "id": "T1555.004",
                    "name": "Windows Credential Manager",
                    "reference": "https://attack.mitre.org/techniques/T1555/004/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "0aa8a2a0-1d8c-4c84-9126-7c62285771cd",
        "rule_id": "be8afaed-4bcd-4e0a-b5f9-5562003dde81",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:34.668Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:16.286Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (?process.pe.original_file_name:\"vaultcmd.exe\" or process.name:\"vaultcmd.exe\") and\n  process.args:\"/list*\"",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Unusual Network Connection via RunDLL32",
        "description": "Identifies unusual instances of rundll32.exe making outbound network connections. This may indicate adversarial Command and Control activity.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Unusual Network Connection via RunDLL32\n\nRunDLL32 is a built-in Windows utility and also a vital component used by the operating system itself. The functionality provided by RunDLL32 to execute Dynamic Link Libraries (DLLs) is widely abused by attackers, because it makes it hard to differentiate malicious activity from normal operations.\n\nThis rule looks for external network connections established using RunDLL32 when the utility is being executed with no arguments, which can potentially indicate command and control activity.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate the target host that RunDLL32 is communicating with.\n  - Check if the domain is newly registered or unexpected.\n  - Check the reputation of the domain or IP address.\n- Identify the target computer and its role in the IT environment.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Review the privileges assigned to the user to ensure that the least privilege principle is being followed.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 209,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Tactic: Command and Control",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.iana.org/assignments/iana-ipv4-special-registry/iana-ipv4-special-registry.xhtml",
          "https://redcanary.com/threat-detection-report/techniques/rundll32/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1218",
                "name": "System Binary Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1218/",
                "subtechnique": [
                  {
                    "id": "T1218.011",
                    "name": "Rundll32",
                    "reference": "https://attack.mitre.org/techniques/T1218/011/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            },
            "technique": [
              {
                "id": "T1071",
                "name": "Application Layer Protocol",
                "reference": "https://attack.mitre.org/techniques/T1071/",
                "subtechnique": [
                  {
                    "id": "T1071.001",
                    "name": "Web Protocols",
                    "reference": "https://attack.mitre.org/techniques/T1071/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args_count",
            "type": "long",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "40723f8b-a8f8-430a-9ae2-d79826480b0f",
        "rule_id": "52aaab7b-b51c-441a-89ce-4387b3aea886",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:34.670Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:09.127Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by host.id, process.entity_id with maxspan=1m\n  [process where host.os.type == \"windows\" and event.type == \"start\" and process.name : \"rundll32.exe\" and process.args_count == 1]\n  [network where host.os.type == \"windows\" and process.name : \"rundll32.exe\" and\n   not cidrmatch(destination.ip, \"10.0.0.0/8\", \"127.0.0.0/8\", \"169.254.0.0/16\", \"172.16.0.0/12\", \"192.0.0.0/24\",\n       \"192.0.0.0/29\", \"192.0.0.8/32\", \"192.0.0.9/32\", \"192.0.0.10/32\", \"192.0.0.170/32\", \"192.0.0.171/32\",\n       \"192.0.2.0/24\", \"192.31.196.0/24\", \"192.52.193.0/24\", \"192.168.0.0/16\", \"192.88.99.0/24\", \"224.0.0.0/4\",\n       \"100.64.0.0/10\", \"192.175.48.0/24\",\"198.18.0.0/15\", \"198.51.100.0/24\", \"203.0.113.0/24\", \"240.0.0.0/4\", \"::1\",\n       \"FE80::/10\", \"FF00::/8\")]",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-endpoint.events.network-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "AWS EFS File System or Mount Deleted",
        "description": "Detects when an EFS File System or Mount is deleted. An adversary could break any file system using the mount target that is being deleted, which might disrupt instances or applications using those mounts. The mount must be deleted prior to deleting the File System, or the adversary will be unable to delete the File System.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Cloud",
          "Data Source: AWS",
          "Data Source: Amazon Web Services",
          "Tactic: Impact"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-3600s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Austin Songer"
        ],
        "false_positives": [
          "File System or Mount being deleted may be performed by a system administrator. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. File System Mount deletion by unfamiliar users should be investigated. If known behavior is causing false positives, it can be exempted from the rule."
        ],
        "references": [
          "https://docs.aws.amazon.com/efs/latest/ug/API_DeleteFileSystem.html",
          "https://docs.aws.amazon.com/efs/latest/ug/API_DeleteMountTarget.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0040",
              "name": "Impact",
              "reference": "https://attack.mitre.org/tactics/TA0040/"
            },
            "technique": [
              {
                "id": "T1485",
                "name": "Data Destruction",
                "reference": "https://attack.mitre.org/techniques/T1485/"
              }
            ]
          }
        ],
        "setup": "The AWS Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "aws",
            "version": "^2.0.0",
            "integration": "cloudtrail"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "cc80aad7-146d-4072-b06d-977411596678",
        "rule_id": "536997f7-ae73-447d-a12d-bff1e8f5f0a0",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:34.673Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:09.145Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-aws.cloudtrail-*"
        ],
        "filters": [],
        "query": "event.dataset:aws.cloudtrail and event.provider:elasticfilesystem.amazonaws.com and\nevent.action:(DeleteMountTarget or DeleteFileSystem) and event.outcome:success",
        "language": "kuery"
      },
      {
        "name": "Suspicious CronTab Creation or Modification",
        "description": "Identifies attempts to create or modify a crontab via a process that is not crontab (i.e python, osascript, etc.). This activity should not be highly prevalent and could indicate the use of cron as a persistence mechanism by a threat actor.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 106,
        "tags": [
          "Domain: Endpoint",
          "OS: macOS",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://taomm.org/PDFs/vol1/CH%200x02%20Persistence.pdf",
          "https://theevilbit.github.io/beyond/beyond_0004/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1053",
                "name": "Scheduled Task/Job",
                "reference": "https://attack.mitre.org/techniques/T1053/",
                "subtechnique": [
                  {
                    "id": "T1053.003",
                    "name": "Cron",
                    "reference": "https://attack.mitre.org/techniques/T1053/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a macOS System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, for MacOS it is recommended to select \"Traditional Endpoints\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "ae826b56-dbd2-41e7-aee2-8d68dee029f5",
        "rule_id": "530178da-92ea-43ce-94c2-8877a826783d",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:34.671Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:09.138Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"macos\" and event.type != \"deletion\" and process.name != null and\n  file.path : \"/private/var/at/tabs/*\" and not process.executable == \"/usr/bin/crontab\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious PDF Reader Child Process",
        "description": "Identifies suspicious child processes of PDF reader applications. These child processes are often launched via exploitation of PDF applications or social engineering.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Suspicious PDF Reader Child Process\n\nPDF is a common file type used in corporate environments and most machines have software to handle these files. This creates a vector where attackers can exploit the engines and technology behind this class of software for initial access or privilege escalation.\n\nThis rule looks for commonly abused built-in utilities spawned by a PDF reader process, which is likely a malicious behavior.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Retrieve PDF documents received and opened by the user that could cause this behavior. Common locations include, but are not limited to, the Downloads and Document folders and the folder configured at the email client.\n- Determine if the collected files are malicious:\n  - Use a private sandboxed malware analysis system to perform analysis.\n    - Observe and collect information about the following activities:\n      - Attempts to contact external domains and addresses.\n      - File and registry access, modification, and creation activities.\n      - Service creation and launch activities.\n      - Scheduled task creation.\n  - Use the PowerShell `Get-FileHash` cmdlet to get the files' SHA-256 hash values.\n    - Search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n  - If the malicious file was delivered via phishing:\n    - Block the email sender from sending future emails.\n    - Block the malicious web pages.\n    - Remove emails from the sender from mailboxes.\n    - Consider improvements to the security awareness program.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 313,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Tactic: Initial Access",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1203",
                "name": "Exploitation for Client Execution",
                "reference": "https://attack.mitre.org/techniques/T1203/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1566",
                "name": "Phishing",
                "reference": "https://attack.mitre.org/techniques/T1566/",
                "subtechnique": [
                  {
                    "id": "T1566.001",
                    "name": "Spearphishing Attachment",
                    "reference": "https://attack.mitre.org/techniques/T1566/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "0c950d65-a94e-415e-aef8-270c54ffff87",
        "rule_id": "53a26770-9cbd-40c5-8b57-61d01a325e14",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:34.675Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:09.152Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.parent.name : (\"AcroRd32.exe\",\n                         \"Acrobat.exe\",\n                         \"FoxitPhantomPDF.exe\",\n                         \"FoxitReader.exe\") and\n  process.name : (\"arp.exe\", \"dsquery.exe\", \"dsget.exe\", \"gpresult.exe\", \"hostname.exe\", \"ipconfig.exe\", \"nbtstat.exe\",\n                  \"net.exe\", \"net1.exe\", \"netsh.exe\", \"netstat.exe\", \"nltest.exe\", \"ping.exe\", \"qprocess.exe\",\n                  \"quser.exe\", \"qwinsta.exe\", \"reg.exe\", \"sc.exe\", \"systeminfo.exe\", \"tasklist.exe\", \"tracert.exe\",\n                  \"whoami.exe\", \"bginfo.exe\", \"cdb.exe\", \"cmstp.exe\", \"csi.exe\", \"dnx.exe\", \"fsi.exe\", \"ieexec.exe\",\n                  \"iexpress.exe\", \"installutil.exe\", \"Microsoft.Workflow.Compiler.exe\", \"msbuild.exe\", \"mshta.exe\",\n                  \"msxsl.exe\", \"odbcconf.exe\", \"rcsi.exe\", \"regsvr32.exe\", \"xwizard.exe\", \"atbroker.exe\",\n                  \"forfiles.exe\", \"schtasks.exe\", \"regasm.exe\", \"regsvcs.exe\", \"cmd.exe\", \"cscript.exe\",\n                  \"powershell.exe\", \"pwsh.exe\", \"wmic.exe\", \"wscript.exe\", \"bitsadmin.exe\", \"certutil.exe\", \"ftp.exe\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Uncommon Registry Persistence Change",
        "description": "Detects changes to registry persistence keys that are not commonly used or modified by legitimate programs. This could be an indication of an adversary's attempt to persist in a stealthy manner.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "timeline_id": "3e47ef71-ebfc-4520-975c-cb27fc090799",
        "timeline_title": "Comprehensive Registry Timeline",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 211,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.microsoftpressstore.com/articles/article.aspx?p=2762082&seqNum=2"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1546",
                "name": "Event Triggered Execution",
                "reference": "https://attack.mitre.org/techniques/T1546/",
                "subtechnique": [
                  {
                    "id": "T1546.002",
                    "name": "Screensaver",
                    "reference": "https://attack.mitre.org/techniques/T1546/002/"
                  }
                ]
              },
              {
                "id": "T1547",
                "name": "Boot or Logon Autostart Execution",
                "reference": "https://attack.mitre.org/techniques/T1547/",
                "subtechnique": [
                  {
                    "id": "T1547.001",
                    "name": "Registry Run Keys / Startup Folder",
                    "reference": "https://attack.mitre.org/techniques/T1547/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1112",
                "name": "Modify Registry",
                "reference": "https://attack.mitre.org/techniques/T1112/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.data.strings",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "registry.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.value",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "ca2b182f-b457-4a79-8b66-519d0ada0aed",
        "rule_id": "54902e45-3467-49a4-8abc-529f2c8cfb80",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:34.677Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:09.155Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n length(registry.data.strings) > 0 and\n registry.path : (\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Terminal Server\\\\Install\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\\\\*\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Terminal Server\\\\Install\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Runonce\\\\*\",\n      \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Windows\\\\Load\",\n      \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Windows\\\\Run\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Windows\\\\IconServiceLib\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Winlogon\\\\Shell\",\n      \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Winlogon\\\\Shell\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Winlogon\\\\AppSetup\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Winlogon\\\\Taskman\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Winlogon\\\\Userinit\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Winlogon\\\\VmApplet\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\Explorer\\\\Run\\\\*\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\System\\\\Shell\",\n      \"HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\\\System\\\\Scripts\\\\Logoff\\\\Script\",\n      \"HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\\\System\\\\Scripts\\\\Logon\\\\Script\",\n      \"HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\\\System\\\\Scripts\\\\Shutdown\\\\Script\",\n      \"HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\\\System\\\\Scripts\\\\Startup\\\\Script\",\n      \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\Explorer\\\\Run\\\\*\",\n      \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\System\\\\Shell\",\n      \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\\\System\\\\Scripts\\\\Logoff\\\\Script\",\n      \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\\\System\\\\Scripts\\\\Logon\\\\Script\",\n      \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\\\System\\\\Scripts\\\\Shutdown\\\\Script\",\n      \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\\\System\\\\Scripts\\\\Startup\\\\Script\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Active Setup\\\\Installed Components\\\\*\\\\ShellComponent\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows CE Services\\\\AutoStartOnConnect\\\\MicrosoftActiveSync\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows CE Services\\\\AutoStartOnDisconnect\\\\MicrosoftActiveSync\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Ctf\\\\LangBarAddin\\\\*\\\\FilePath\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Internet Explorer\\\\Extensions\\\\*\\\\Exec\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Internet Explorer\\\\Extensions\\\\*\\\\Script\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Command Processor\\\\Autorun\",\n      \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Ctf\\\\LangBarAddin\\\\*\\\\FilePath\",\n      \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Internet Explorer\\\\Extensions\\\\*\\\\Exec\",\n      \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Internet Explorer\\\\Extensions\\\\*\\\\Script\",\n      \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Command Processor\\\\Autorun\",\n      \"HKEY_USERS\\\\*\\\\Control Panel\\\\Desktop\\\\scrnsave.exe\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Image File Execution Options\\\\*\\\\VerifierDlls\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Winlogon\\\\GpExtensions\\\\*\\\\DllName\",\n      \"HKLM\\\\SYSTEM\\\\ControlSet*\\\\Control\\\\SafeBoot\\\\AlternateShell\",\n      \"HKLM\\\\SYSTEM\\\\ControlSet*\\\\Control\\\\Terminal Server\\\\Wds\\\\rdpwd\\\\StartupPrograms\",\n      \"HKLM\\\\SYSTEM\\\\ControlSet*\\\\Control\\\\Terminal Server\\\\WinStations\\\\RDP-Tcp\\\\InitialProgram\",\n      \"HKLM\\\\SYSTEM\\\\ControlSet*\\\\Control\\\\Session Manager\\\\BootExecute\",\n      \"HKLM\\\\SYSTEM\\\\ControlSet*\\\\Control\\\\Session Manager\\\\SetupExecute\",\n      \"HKLM\\\\SYSTEM\\\\ControlSet*\\\\Control\\\\Session Manager\\\\Execute\",\n      \"HKLM\\\\SYSTEM\\\\ControlSet*\\\\Control\\\\Session Manager\\\\S0InitialCommand\",\n      \"HKLM\\\\SYSTEM\\\\ControlSet*\\\\Control\\\\ServiceControlManagerExtension\",\n      \"HKLM\\\\SYSTEM\\\\ControlSet*\\\\Control\\\\BootVerificationProgram\\\\ImagePath\",\n      \"HKLM\\\\SYSTEM\\\\Setup\\\\CmdLine\",\n      \"HKEY_USERS\\\\*\\\\Environment\\\\UserInitMprLogonScript\") and\n\n not registry.data.strings : (\"C:\\\\Windows\\\\system32\\\\userinit.exe\", \"cmd.exe\", \"C:\\\\Program Files (x86)\\\\*.exe\",\n                              \"C:\\\\Program Files\\\\*.exe\") and\n not (process.name : \"rundll32.exe\" and registry.path : \"*\\\\Software\\\\Microsoft\\\\Internet Explorer\\\\Extensions\\\\*\\\\Script\") and\n not process.executable : (\"C:\\\\Windows\\\\System32\\\\msiexec.exe\",\n                           \"C:\\\\Windows\\\\SysWOW64\\\\msiexec.exe\",\n                           \"C:\\\\ProgramData\\\\Microsoft\\\\Windows Defender\\\\Platform\\\\*\\\\MsMpEng.exe\",\n                           \"C:\\\\Program Files\\\\*.exe\",\n                           \"C:\\\\Program Files (x86)\\\\*.exe\") and\n not (process.name : (\"TiWorker.exe\", \"poqexec.exe\") and registry.value : \"SetupExecute\" and\n      registry.data.strings : (\n        \"C:\\\\windows\\\\System32\\\\poqexec.exe /display_progress \\\\SystemRoot\\\\WinSxS\\\\pending.xml\",\n        \"C:\\\\Windows\\\\System32\\\\poqexec.exe /skip_critical_poq /display_progress \\\\SystemRoot\\\\WinSxS\\\\pending.xml\"\n      )\n     ) and\n not (process.name : \"svchost.exe\" and registry.value : \"SCRNSAVE.EXE\" and\n      registry.data.strings : (\n        \"%windir%\\\\system32\\\\rundll32.exe user32.dll,LockWorkStation\",\n        \"scrnsave.scr\",\n        \"%windir%\\\\system32\\\\Ribbons.scr\"\n      )\n     )",
        "language": "eql",
        "index": [
          "logs-endpoint.events.registry-*",
          "logs-windows.sysmon_operational-*",
          "winlogbeat-*"
        ],
        "filters": []
      },
      {
        "name": "Network Logon Provider Registry Modification",
        "description": "Identifies the modification of the network logon provider registry. Adversaries may register a rogue network logon provider module for persistence and/or credential access via intercepting the authentication credentials in clear text during user logon.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Network Logon Provider Registry Modification\n\nNetwork logon providers are components in Windows responsible for handling the authentication process during a network logon.\n\nThis rule identifies the modification of the network logon provider registry. Adversaries may register a rogue network logon provider module for persistence and/or credential access via intercepting the authentication credentials in plain text during user logon.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n### Possible investigation steps\n\n- Examine the `registry.data.strings` field to identify the DLL registered.\n- Identify the process responsible for the registry operation and the file creation and investigate their process execution chains (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n  - Validate the activity is not related to planned patches, updates, network administrator activity, or legitimate software installations.\n  - Investigate any abnormal behavior by the subject process, such as network connections, DLLs loaded, registry or file modifications, and any spawned child processes.\n- Retrieve the file and examine if it is signed with valid digital signatures from vendors that are supposed to implement this kind of software and approved to use in the environment. Check for prevalence in the environment and whether they are located in expected locations.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the executables of the processes using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process's `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n\n\n### False positive analysis\n\n- False Positives can include legitimate software installations or updates that modify the network logon provider registry. These modifications may be necessary for the proper functioning of the software and are not indicative of malicious activity.\n\n### Response and Remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n  - If malicious activity is confirmed, perform a broader investigation to identify the scope of the compromise and determine the appropriate remediation steps.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Reimage the host operating system or restore the compromised files to clean versions.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 213,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Tactic: Credential Access",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: Microsoft Defender for Endpoint"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Authorized third party network logon providers."
        ],
        "references": [
          "https://github.com/gtworek/PSBits/tree/master/PasswordStealing/NPPSpy",
          "https://docs.microsoft.com/en-us/windows/win32/api/npapi/nf-npapi-nplogonnotify"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1556",
                "name": "Modify Authentication Process",
                "reference": "https://attack.mitre.org/techniques/T1556/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1543",
                "name": "Create or Modify System Process",
                "reference": "https://attack.mitre.org/techniques/T1543/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.data.strings",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "registry.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.value",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "bd37286a-042b-4091-a016-0651b0a1d1dc",
        "rule_id": "54c3d186-0461-4dc3-9b33-2dc5c7473936",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:34.678Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:09.158Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n  registry.data.strings : \"?*\" and registry.value : \"ProviderPath\" and\n  registry.path : (\n    \"HKLM\\\\SYSTEM\\\\*ControlSet*\\\\Services\\\\*\\\\NetworkProvider\\\\ProviderPath\",\n    \"\\\\REGISTRY\\\\MACHINE\\\\SYSTEM\\\\*ControlSet*\\\\Services\\\\*\\\\NetworkProvider\\\\ProviderPath\"\n  ) and\n  /* Excluding default NetworkProviders RDPNP, LanmanWorkstation and webclient. */\n  not (\n    user.id : \"S-1-5-18\" and\n    registry.data.strings : (\n        \"%SystemRoot%\\\\System32\\\\ntlanman.dll\",\n        \"%SystemRoot%\\\\System32\\\\drprov.dll\",\n        \"%SystemRoot%\\\\System32\\\\davclnt.dll\",\n        \"%SystemRoot%\\\\System32\\\\vmhgfs.dll\",\n        \"?:\\\\Program Files (x86)\\\\Citrix\\\\ICA Client\\\\x64\\\\pnsson.dll\",\n        \"?:\\\\Program Files\\\\Dell\\\\SARemediation\\\\agent\\\\DellMgmtNP.dll\",\n        \"?:\\\\Program Files (x86)\\\\CheckPoint\\\\Endpoint Connect\\\\\\\\epcgina.dll\"\n    )\n  )",
        "language": "eql",
        "index": [
          "logs-endpoint.events.registry-*",
          "endgame-*",
          "logs-windows.sysmon_operational-*",
          "winlogbeat-*",
          "logs-m365_defender.event-*"
        ],
        "filters": []
      },
      {
        "name": "PsExec Network Connection",
        "description": "Identifies use of the SysInternals tool PsExec.exe making a network connection. This could be an indication of lateral movement.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating PsExec Network Connection\n\nPsExec is a remote administration tool that enables the execution of commands with both regular and SYSTEM privileges on Windows systems. Microsoft develops it as part of the Sysinternals Suite. Although commonly used by administrators, PsExec is frequently used by attackers to enable lateral movement and execute commands as SYSTEM to disable defenses and bypass security protections.\n\nThis rule identifies PsExec execution by looking for the creation of `PsExec.exe`, the default name for the utility, followed by a network connection done by the process.\n\n#### Possible investigation steps\n\n- Check if the usage of this tool complies with the organization's administration policy.\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Identify the target computer and its role in the IT environment.\n- Investigate what commands were run, and assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n\n### False positive analysis\n\n- This mechanism can be used legitimately. As long as the analyst did not identify suspicious activity related to the user or involved hosts, and the tool is allowed by the organization's policy, such alerts can be dismissed.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n  - Prioritize cases involving critical servers and users.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Review the privileges assigned to the user to ensure that the least privilege principle is being followed.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 209,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Tactic: Lateral Movement",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "PsExec is a dual-use tool that can be used for benign or malicious activity. It's important to baseline your environment to determine the amount of noise to expect from this tool."
        ],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1569",
                "name": "System Services",
                "reference": "https://attack.mitre.org/techniques/T1569/",
                "subtechnique": [
                  {
                    "id": "T1569.002",
                    "name": "Service Execution",
                    "reference": "https://attack.mitre.org/techniques/T1569/002/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1021",
                "name": "Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1021/",
                "subtechnique": [
                  {
                    "id": "T1021.002",
                    "name": "SMB/Windows Admin Shares",
                    "reference": "https://attack.mitre.org/techniques/T1021/002/"
                  }
                ]
              },
              {
                "id": "T1570",
                "name": "Lateral Tool Transfer",
                "reference": "https://attack.mitre.org/techniques/T1570/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "d869a7bf-165a-4640-97e8-4671528c0c83",
        "rule_id": "55d551c6-333b-4665-ab7e-5d14a59715ce",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:34.680Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:09.161Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by process.entity_id\n  [process where host.os.type == \"windows\" and process.name : \"PsExec.exe\" and event.type == \"start\" and\n\n   /* This flag suppresses the display of the license dialog and may\n      indicate that psexec executed for the first time in the machine */\n   process.args : \"-accepteula\" and\n\n   not process.executable : (\"?:\\\\ProgramData\\\\Docusnap\\\\Discovery\\\\discovery\\\\plugins\\\\17\\\\Bin\\\\psexec.exe\",\n                             \"?:\\\\Docusnap 11\\\\Bin\\\\psexec.exe\",\n                             \"?:\\\\Program Files\\\\Docusnap X\\\\Bin\\\\psexec.exe\",\n                             \"?:\\\\Program Files\\\\Docusnap X\\\\Tools\\\\dsDNS.exe\") and\n   not process.parent.executable : \"?:\\\\Program Files (x86)\\\\Cynet\\\\Cynet Scanner\\\\CynetScanner.exe\"]\n  [network where host.os.type == \"windows\" and process.name : \"PsExec.exe\"]",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-endpoint.events.network-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "Windows CryptoAPI Spoofing Vulnerability (CVE-2020-0601 - CurveBall)",
        "description": "A spoofing vulnerability exists in the way Windows CryptoAPI (Crypt32.dll) validates Elliptic Curve Cryptography (ECC) certificates. An attacker could exploit the vulnerability by using a spoofed code-signing certificate to sign a malicious executable, making it appear the file was from a trusted, legitimate source.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 207,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Use Case: Vulnerability",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1553",
                "name": "Subvert Trust Controls",
                "reference": "https://attack.mitre.org/techniques/T1553/",
                "subtechnique": [
                  {
                    "id": "T1553.002",
                    "name": "Code Signing",
                    "reference": "https://attack.mitre.org/techniques/T1553/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "message",
            "type": "match_only_text",
            "ecs": true
          }
        ],
        "id": "02449d02-7829-426c-a553-218745be4ac5",
        "rule_id": "56557cde-d923-4b88-adee-c61b3f3b5dc3",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:34.682Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:09.164Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-windows.*",
          "logs-system.security*"
        ],
        "filters": [],
        "query": "event.provider:\"Microsoft-Windows-Audit-CVE\" and message:\"[CVE-2020-0601]\" and host.os.type:windows",
        "language": "kuery"
      },
      {
        "name": "VNC (Virtual Network Computing) from the Internet",
        "description": "This rule detects network events that may indicate the use of VNC traffic from the Internet. VNC is commonly used by system administrators to remotely control a system for maintenance or to use shared resources. It should almost never be directly exposed to the Internet, as it is frequently targeted and exploited by threat actors as an initial access or backdoor vector.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 105,
        "tags": [
          "Tactic: Command and Control",
          "Domain: Endpoint",
          "Use Case: Threat Detection",
          "Data Source: PAN-OS"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "VNC connections may be received directly to Linux cloud server instances but such connections are usually made only by engineers. VNC is less common than SSH or RDP but may be required by some work-flows such as remote access and support for specialized software products or servers. Such work-flows are usually known and not unexpected. Usage that is unfamiliar to server or network owners can be unexpected and suspicious."
        ],
        "references": [
          "https://www.iana.org/assignments/iana-ipv4-special-registry/iana-ipv4-special-registry.xhtml"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            },
            "technique": [
              {
                "id": "T1219",
                "name": "Remote Access Software",
                "reference": "https://attack.mitre.org/techniques/T1219/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1190",
                "name": "Exploit Public-Facing Application",
                "reference": "https://attack.mitre.org/techniques/T1190/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "network_traffic",
            "version": "^1.1.0"
          },
          {
            "package": "panw",
            "version": "^4.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "destination.port",
            "type": "long",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "network.transport",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "source.ip",
            "type": "ip",
            "ecs": true
          }
        ],
        "id": "3673b538-f3c7-4a52-9da9-b6c0c1a9c0c5",
        "rule_id": "5700cb81-df44-46aa-a5d7-337798f53eb8",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:34.694Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:09.177Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "packetbeat-*",
          "auditbeat-*",
          "filebeat-*",
          "logs-network_traffic.*",
          "logs-panw.panos*"
        ],
        "filters": [],
        "query": "(event.dataset: network_traffic.flow or (event.category: (network or network_traffic))) and\n  network.transport:tcp and destination.port >= 5800 and destination.port <= 5810 and\n  not source.ip:(\n    10.0.0.0/8 or\n    127.0.0.0/8 or\n    169.254.0.0/16 or\n    172.16.0.0/12 or\n    192.0.0.0/24 or\n    192.0.0.0/29 or\n    192.0.0.8/32 or\n    192.0.0.9/32 or\n    192.0.0.10/32 or\n    192.0.0.170/32 or\n    192.0.0.171/32 or\n    192.0.2.0/24 or\n    192.31.196.0/24 or\n    192.52.193.0/24 or\n    192.168.0.0/16 or\n    192.88.99.0/24 or\n    224.0.0.0/4 or\n    100.64.0.0/10 or\n    192.175.48.0/24 or\n    198.18.0.0/15 or\n    198.51.100.0/24 or\n    203.0.113.0/24 or\n    240.0.0.0/4 or\n    \"::1\" or\n    \"FE80::/10\" or\n    \"FF00::/8\"\n  ) and\n  destination.ip:(\n    10.0.0.0/8 or\n    172.16.0.0/12 or\n    192.168.0.0/16\n  )",
        "language": "kuery"
      },
      {
        "name": "Potential Admin Group Account Addition",
        "description": "Identifies attempts to add an account to the admin group via the command line. This could be an indication of privilege escalation activity.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Endpoint",
          "OS: macOS",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://managingosx.wordpress.com/2010/01/14/add-a-user-to-the-admin-group-via-command-line-3-0/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1078",
                "name": "Valid Accounts",
                "reference": "https://attack.mitre.org/techniques/T1078/",
                "subtechnique": [
                  {
                    "id": "T1078.003",
                    "name": "Local Accounts",
                    "reference": "https://attack.mitre.org/techniques/T1078/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a macOS System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, for MacOS it is recommended to select \"Traditional Endpoints\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.Ext.effective_parent.executable",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "0f71084e-d147-4b99-a255-0709fd2d553b",
        "rule_id": "565c2b44-7a21-4818-955f-8d4737967d2e",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:34.705Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:09.168Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": [],
        "query": "event.category:process and host.os.type:macos and event.type:(start or process_started) and\n process.name:(dscl or dseditgroup) and process.args:((\"/Groups/admin\" or admin) and (\"-a\" or \"-append\")) and\n not process.Ext.effective_parent.executable : (\"/Library/Application Support/JAMF/Jamf.app/Contents/MacOS/JamfDaemon.app/Contents/MacOS/JamfDaemon\" or\n                                                \"/Library/Application Support/JAMF/Jamf.app/Contents/MacOS/JamfManagementService.app/Contents/MacOS/JamfManagementService\" or\n                                                \"/opt/jc/bin/jumpcloud-agent\" or\n                                                \"/Library/Addigy/go-agent\")",
        "language": "kuery"
      },
      {
        "name": "Dumping of Keychain Content via Security Command",
        "description": "Adversaries may dump the content of the keychain storage data from a system to acquire credentials. Keychains are the built-in way for macOS to keep track of users' passwords and credentials for many services and features, including Wi-Fi and website passwords, secure notes, certificates, and Kerberos.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 107,
        "tags": [
          "Domain: Endpoint",
          "OS: macOS",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://ss64.com/osx/security.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1555",
                "name": "Credentials from Password Stores",
                "reference": "https://attack.mitre.org/techniques/T1555/",
                "subtechnique": [
                  {
                    "id": "T1555.001",
                    "name": "Keychain",
                    "reference": "https://attack.mitre.org/techniques/T1555/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a macOS System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, for MacOS it is recommended to select \"Traditional Endpoints\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "08c40bd8-03d8-477e-a0e8-d2406220e855",
        "rule_id": "565d6ca5-75ba-4c82-9b13-add25353471c",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:34.773Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:09.171Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and process.args : \"dump-keychain\" and process.args : \"-d\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "PowerShell PSReflect Script",
        "description": "Detects the use of PSReflect in PowerShell scripts. Attackers leverage PSReflect as a library that enables PowerShell to access win32 API functions.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating PowerShell PSReflect Script\n\nPowerShell is one of the main tools system administrators use for automation, report routines, and other tasks. This makes it available for use in various environments, and creates an attractive way for attackers to execute code.\n\nPSReflect is a library that enables PowerShell to access win32 API functions in an uncomplicated way. It also helps to create enums and structs easilyâ€”all without touching the disk.\n\nAlthough this is an interesting project for every developer and admin out there, it is mainly used in the red team and malware tooling for its capabilities.\n\nDetecting the core implementation of PSReflect means detecting most of the tooling that uses Windows API through PowerShell, enabling defenders to discover tools being dropped in the environment.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Examine the script content that triggered the detection; look for suspicious DLL imports, collection or exfiltration capabilities, suspicious functions, encoded or compressed data, and other potentially malicious characteristics. The script content that may be split into multiple script blocks (you can use the field `powershell.file.script_block_id` for filtering).\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Check for additional PowerShell and command-line logs that indicate that imported functions were run.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Evaluate whether the user needs to use PowerShell to complete tasks.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the script using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Related rules\n\n- PowerShell Suspicious Discovery Related Windows API Functions - 61ac3638-40a3-44b2-855a-985636ca985e\n- PowerShell Keylogging Script - bd2c86a0-8b61-4457-ab38-96943984e889\n- PowerShell Suspicious Script with Audio Capture Capabilities - 2f2f4939-0b34-40c2-a0a3-844eb7889f43\n- Potential Process Injection via PowerShell - 2e29e96a-b67c-455a-afe4-de6183431d0d\n- Suspicious .NET Reflection via PowerShell - e26f042e-c590-4e82-8e05-41e81bd822ad\n- PowerShell Suspicious Payload Encoded and Compressed - 81fe9dc6-a2d7-4192-a2d8-eed98afc766a\n- PowerShell Suspicious Script with Screenshot Capabilities - 959a7353-1129-4aa7-9084-30746b256a70\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Restrict PowerShell usage outside of IT and engineering business units using GPOs, AppLocker, Intune, or similar software.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 313,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Resources: Investigation Guide",
          "Data Source: PowerShell Logs"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Legitimate PowerShell scripts that make use of PSReflect to access the win32 API"
        ],
        "references": [
          "https://github.com/mattifestation/PSReflect/blob/master/PSReflect.psm1",
          "https://github.com/atc-project/atc-data/blob/master/docs/Logging_Policies/LP_0109_windows_powershell_script_block_log.md"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              },
              {
                "id": "T1106",
                "name": "Native API",
                "reference": "https://attack.mitre.org/techniques/T1106/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'PowerShell Script Block Logging' logging policy must be configured (Enable).\n\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nAdministrative Templates >\nWindows PowerShell >\nTurn on PowerShell Script Block Logging (Enable)\n```\n\nSteps to implement the logging policy via registry:\n\n```\nreg add \"hklm\\SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\ScriptBlockLogging\" /v EnableScriptBlockLogging /t REG_DWORD /d 1\n```\n",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "powershell.file.script_block_text",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "84f629b9-cee7-4a78-bae3-f075a63d6061",
        "rule_id": "56f2e9b5-4803-4e44-a0a4-a52dc79d57fe",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:34.775Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:05.929Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-windows.powershell*"
        ],
        "filters": [
          {
            "meta": {
              "negate": true
            },
            "query": {
              "wildcard": {
                "file.path": {
                  "case_insensitive": true,
                  "value": "?:\\\\ProgramData\\\\MaaS360\\\\Cloud Extender\\\\AR\\\\Scripts\\\\ASModuleCommon.ps1"
                }
              }
            }
          }
        ],
        "query": "event.category:process and host.os.type:windows and\n  powershell.file.script_block_text:(\n    \"New-InMemoryModule\" or\n    \"Add-Win32Type\" or\n    psenum or\n    DefineDynamicAssembly or\n    DefineDynamicModule or\n    \"Reflection.TypeAttributes\" or\n    \"Reflection.Emit.OpCodes\" or\n    \"Reflection.Emit.CustomAttributeBuilder\" or\n    \"Runtime.InteropServices.DllImportAttribute\"\n  ) and\n  not user.id : \"S-1-5-18\"",
        "language": "kuery"
      },
      {
        "name": "PowerShell MiniDump Script",
        "description": "This rule detects PowerShell scripts capable of dumping process memory using WindowsErrorReporting or Dbghelp.dll MiniDumpWriteDump. Attackers can use this tooling to dump LSASS and get access to credentials.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating PowerShell MiniDump Script\n\nPowerShell is one of the main tools system administrators use for automation, report routines, and other tasks. This makes it available for use in various environments, and creates an attractive way for attackers to execute code.\n\nAttackers can abuse Process Memory Dump capabilities to extract credentials from LSASS or to obtain other privileged information stored in the process memory.\n\n#### Possible investigation steps\n\n- Examine the script content that triggered the detection; look for suspicious DLL imports, collection or exfiltration capabilities, suspicious functions, encoded or compressed data, and other potentially malicious characteristics.\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Examine file or network events from the involved PowerShell process for suspicious behavior.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Evaluate whether the user needs to use PowerShell to complete tasks.\n- Check if the imported function was executed and which process it targeted.\n\n### False positive analysis\n\n- Regular users do not have a business justification for using scripting utilities to dump process memory, making false positives unlikely.\n\n### Related rules\n\n- PowerShell PSReflect Script - 56f2e9b5-4803-4e44-a0a4-a52dc79d57fe\n- Potential Process Injection via PowerShell - 2e29e96a-b67c-455a-afe4-de6183431d0d\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Restrict PowerShell usage outside of IT and engineering business units using GPOs, AppLocker, Intune, or similar software.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 210,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Resources: Investigation Guide",
          "Data Source: PowerShell Logs"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "PowerShell scripts that use this capability for troubleshooting."
        ],
        "references": [
          "https://github.com/PowerShellMafia/PowerSploit/blob/master/Exfiltration/Out-Minidump.ps1",
          "https://github.com/FuzzySecurity/PowerShell-Suite/blob/master/Get-ProcessMiniDump.ps1",
          "https://github.com/atc-project/atc-data/blob/master/docs/Logging_Policies/LP_0109_windows_powershell_script_block_log.md"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1003",
                "name": "OS Credential Dumping",
                "reference": "https://attack.mitre.org/techniques/T1003/",
                "subtechnique": [
                  {
                    "id": "T1003.001",
                    "name": "LSASS Memory",
                    "reference": "https://attack.mitre.org/techniques/T1003/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'PowerShell Script Block Logging' logging policy must be enabled.\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nAdministrative Templates >\nWindows PowerShell >\nTurn on PowerShell Script Block Logging (Enable)\n```\n\nSteps to implement the logging policy via registry:\n\n```\nreg add \"hklm\\SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\ScriptBlockLogging\" /v EnableScriptBlockLogging /t REG_DWORD /d 1\n```\n",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "powershell.file.script_block_text",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "d3b96bfc-d59f-46ad-8fb4-a6853f11cb30",
        "rule_id": "577ec21e-56fe-4065-91d8-45eb8224fe77",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:36.713Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:10.061Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-windows.powershell*"
        ],
        "filters": [],
        "query": "event.category:process and host.os.type:windows and powershell.file.script_block_text:(MiniDumpWriteDump or MiniDumpWithFullMemory or pmuDetirWpmuDiniM) and not user.id : \"S-1-5-18\"",
        "language": "kuery"
      },
      {
        "name": "Credential Dumping - Detected - Elastic Endgame",
        "description": "Elastic Endgame detected Credential Dumping. Click the Elastic Endgame icon in the event.module column or the link in the rule.reference column for additional information.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 103,
        "tags": [
          "Data Source: Elastic Endgame",
          "Use Case: Threat Detection",
          "Tactic: Credential Access"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-900s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 10000,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1003",
                "name": "OS Credential Dumping",
                "reference": "https://attack.mitre.org/techniques/T1003/",
                "subtechnique": [
                  {
                    "id": "T1003.001",
                    "name": "LSASS Memory",
                    "reference": "https://attack.mitre.org/techniques/T1003/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule is configured to generate more **Max alerts per run** than the default 1000 alerts per run set for all rules. This is to ensure that it captures as many alerts as possible.\n\n**IMPORTANT:** The rule's **Max alerts per run** setting can be superseded by the `xpack.alerting.rules.run.alerts.max` Kibana config setting, which determines the maximum alerts generated by _any_ rule in the Kibana alerting framework. For example, if `xpack.alerting.rules.run.alerts.max` is set to 1000, this rule will still generate no more than 1000 alerts even if its own **Max alerts per run** is set higher.\n\nTo make sure this rule can generate as many alerts as it's configured in its own **Max alerts per run** setting, increase the `xpack.alerting.rules.run.alerts.max` system setting accordingly.\n\n**NOTE:** Changing `xpack.alerting.rules.run.alerts.max` is not possible in Serverless projects.",
        "related_integrations": [],
        "required_fields": [
          {
            "name": "endgame.event_subtype_full",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "endgame.metadata.type",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.kind",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.module",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "73f9ec7a-e7d8-437a-8e29-e254b3890002",
        "rule_id": "571afc56-5ed9-465d-a2a9-045f099f6e7e",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:36.715Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:09.181Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "endgame-*"
        ],
        "filters": [],
        "query": "event.kind:alert and event.module:endgame and endgame.metadata.type:detection and (event.action:cred_theft_event or endgame.event_subtype_full:cred_theft_event)",
        "language": "kuery"
      },
      {
        "name": "Deleting Backup Catalogs with Wbadmin",
        "description": "Identifies use of the wbadmin.exe to delete the backup catalog. Ransomware and other malware may do this to prevent system recovery.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Deleting Backup Catalogs with Wbadmin\n\nWindows Server Backup stores the details about your backups (what volumes are backed up and where the backups are located) in a file called a backup catalog, which ransomware victims can use to recover corrupted backup files. Deleting these files is a common step in threat actor playbooks.\n\nThis rule identifies the deletion of the backup catalog using the `wbadmin.exe` utility.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n- Check if any files on the host machine have been encrypted.\n\n### False positive analysis\n\n- Administrators can use this command to delete corrupted catalogs, but overall the activity is unlikely to be legitimate.\n\n### Related rules\n\n- Third-party Backup Files Deleted via Unexpected Process - 11ea6bec-ebde-4d71-a8e9-784948f8e3e9\n- Volume Shadow Copy Deleted or Resized via VssAdmin - b5ea4bfe-a1b2-421f-9d47-22a75a6f2921\n- Volume Shadow Copy Deletion via PowerShell - d99a037b-c8e2-47a5-97b9-170d076827c4\n- Volume Shadow Copy Deletion via WMIC - dc9c1f74-dac3-48e3-b47f-eb79db358f57\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Consider isolating the involved host to prevent destructive behavior, which is commonly associated with this activity.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- If any other destructive action was identified on the host, it is recommended to prioritize the investigation and look for ransomware preparation and execution activities.\n- If any backups were affected:\n  - Perform data recovery locally or restore the backups from replicated copies (cloud, other servers, etc.).\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 314,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Impact",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0040",
              "name": "Impact",
              "reference": "https://attack.mitre.org/tactics/TA0040/"
            },
            "technique": [
              {
                "id": "T1485",
                "name": "Data Destruction",
                "reference": "https://attack.mitre.org/techniques/T1485/"
              },
              {
                "id": "T1490",
                "name": "Inhibit System Recovery",
                "reference": "https://attack.mitre.org/techniques/T1490/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "da27178c-de21-4aad-a636-a2ecc199d0a6",
        "rule_id": "581add16-df76-42bb-af8e-c979bfb39a59",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:36.724Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:10.065Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (process.name : \"wbadmin.exe\" or ?process.pe.original_file_name == \"WBADMIN.EXE\") and\n  process.args : \"catalog\" and process.args : \"delete\"",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Zoom Meeting with no Passcode",
        "description": "This rule identifies Zoom meetings that are created without a passcode. Meetings without a passcode are susceptible to Zoombombing. Zoombombing is carried out by taking advantage of Zoom sessions that are not protected with a passcode. Zoombombing refers to the unwanted, disruptive intrusion, generally by Internet trolls and hackers, into a video conference call. In a typical Zoombombing incident, a teleconferencing session is hijacked by the insertion of material that is lewd, obscene, racist, or antisemitic in nature, typically resulting of the shutdown of the session.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 103,
        "tags": [
          "Data Source: Zoom",
          "Use Case: Configuration Audit",
          "Tactic: Initial Access"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://blog.zoom.us/a-message-to-our-users/",
          "https://www.fbi.gov/contact-us/field-offices/boston/news/press-releases/fbi-warns-of-teleconferencing-and-online-classroom-hijacking-during-covid-19-pandemic"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1190",
                "name": "Exploit Public-Facing Application",
                "reference": "https://attack.mitre.org/techniques/T1190/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe Zoom Filebeat module or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.module",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "zoom.meeting.password",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "64e15db8-24e9-431b-97bf-cfa0bce2c332",
        "rule_id": "58ac2aa5-6718-427c-a845-5f3ac5af00ba",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:36.726Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:10.068Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*"
        ],
        "filters": [],
        "query": "event.type:creation and event.module:zoom and event.dataset:zoom.webhook and\n  event.action:meeting.created and not zoom.meeting.password:*",
        "language": "kuery"
      },
      {
        "name": "Potential Lateral Tool Transfer via SMB Share",
        "description": "Identifies the creation or change of a Windows executable file over network shares. Adversaries may transfer tools or other files between systems in a compromised environment.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Potential Lateral Tool Transfer via SMB Share\n\nAdversaries can use network shares to host tooling to support the compromise of other hosts in the environment. These tools can include discovery utilities, credential dumpers, malware, etc. Attackers can also leverage file shares that employees frequently access to host malicious files to gain a foothold in other machines.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Retrieve the created file and determine if it is malicious:\n  - Use a private sandboxed malware analysis system to perform analysis.\n    - Observe and collect information about the following activities:\n      - Attempts to contact external domains and addresses.\n      - File and registry access, modification, and creation activities.\n      - Service creation and launch activities.\n      - Scheduled task creation.\n  - Use the PowerShell `Get-FileHash` cmdlet to get the files' SHA-256 hash values.\n    - Search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n\n### False positive analysis\n\n- This activity can happen legitimately. Consider adding exceptions if it is expected and noisy in your environment.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Review the privileges needed to write to the network share and restrict write access as needed.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 109,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Lateral Movement",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/security-labs/elastic-protects-against-data-wiper-malware-targeting-ukraine-hermeticwiper",
          "https://www.elastic.co/security-labs/hunting-for-lateral-movement-using-event-query-language"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1021",
                "name": "Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1021/",
                "subtechnique": [
                  {
                    "id": "T1021.002",
                    "name": "SMB/Windows Admin Shares",
                    "reference": "https://attack.mitre.org/techniques/T1021/002/"
                  }
                ]
              },
              {
                "id": "T1570",
                "name": "Lateral Tool Transfer",
                "reference": "https://attack.mitre.org/techniques/T1570/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.port",
            "type": "long",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.Ext.header_bytes",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "network.direction",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "network.transport",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pid",
            "type": "long",
            "ecs": true
          },
          {
            "name": "source.ip",
            "type": "ip",
            "ecs": true
          }
        ],
        "id": "13a83f86-4f27-4c41-9c0e-407b1f98c2dc",
        "rule_id": "58bc134c-e8d2-4291-a552-b4b3e537c60b",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:36.728Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:10.071Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by host.id with maxspan=30s\n  [network where host.os.type == \"windows\" and event.type == \"start\" and process.pid == 4 and destination.port == 445 and\n   network.direction : (\"incoming\", \"ingress\") and\n   network.transport == \"tcp\" and source.ip != \"127.0.0.1\" and source.ip != \"::1\"\n  ] by process.entity_id\n  /* add more executable extensions here if they are not noisy in your environment */\n  [file where host.os.type == \"windows\" and event.type in (\"creation\", \"change\") and process.pid == 4 and \n   (file.Ext.header_bytes : \"4d5a*\" or file.extension : (\"exe\", \"scr\", \"pif\", \"com\", \"dll\"))] by process.entity_id",
        "language": "eql",
        "index": [
          "logs-endpoint.events.file-*",
          "logs-endpoint.events.network-*"
        ],
        "filters": []
      },
      {
        "name": "Potential Privilege Escalation via InstallerFileTakeOver",
        "description": "Identifies a potential exploitation of InstallerTakeOver (CVE-2021-41379) default PoC execution. Successful exploitation allows an unprivileged user to escalate privileges to SYSTEM.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Potential Privilege Escalation via InstallerFileTakeOver\n\nInstallerFileTakeOver is a weaponized escalation of privilege proof of concept (EoP PoC) to the CVE-2021-41379 vulnerability. Upon successful exploitation, an unprivileged user will escalate privileges to SYSTEM/NT AUTHORITY.\n\nThis rule detects the default execution of the PoC, which overwrites the `elevation_service.exe` DACL and copies itself to the location to escalate privileges. An attacker is able to still take over any file that is not in use (locked), which is outside the scope of this rule.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Look for additional processes spawned by the process, command lines, and network communications.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the file using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n### False positive analysis\n\n- Verify whether a digital signature exists in the executable, and if it is valid.\n\n### Related rules\n\n- Suspicious DLL Loaded for Persistence or Privilege Escalation - bfeaf89b-a2a7-48a3-817f-e41829dc61ee\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 111,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Resources: Investigation Guide",
          "Use Case: Vulnerability",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/klinix5/InstallerFileTakeOver"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1068",
                "name": "Exploitation for Privilege Escalation",
                "reference": "https://attack.mitre.org/techniques/T1068/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.Ext.token.integrity_level_name",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "process.code_signature.trusted",
            "type": "boolean",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "ec546787-126d-4a1a-9b86-96baa7de1d8f",
        "rule_id": "58c6d58b-a0d3-412d-b3b8-0981a9400607",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:36.730Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:05.936Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n    process.Ext.token.integrity_level_name : \"System\" and\n    (\n      (process.name : \"elevation_service.exe\" and\n       not process.pe.original_file_name == \"elevation_service.exe\") or\n      \n      (process.name : \"elevation_service.exe\" and\n       not process.code_signature.trusted == true) or\n\n      (process.parent.name : \"elevation_service.exe\" and\n       process.name : (\"rundll32.exe\", \"cmd.exe\", \"powershell.exe\"))\n    ) and\n    not\n    (\n      process.name : \"elevation_service.exe\" and process.code_signature.trusted == true and\n      process.pe.original_file_name == null\n    )",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*"
        ],
        "filters": []
      },
      {
        "name": "O365 Email Reported by User as Malware or Phish",
        "description": "Detects the occurrence of emails reported as Phishing or Malware by Users. Security Awareness training is essential to stay ahead of scammers and threat actors, as security products can be bypassed, and the user can still receive a malicious message. Educating users to report suspicious messages can help identify gaps in security controls and prevent malware infections and Business Email Compromise attacks.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Cloud",
          "Data Source: Microsoft 365",
          "Tactic: Initial Access"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-1800s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Legitimate files reported by the users"
        ],
        "references": [
          "https://support.microsoft.com/en-us/office/use-the-report-message-add-in-b5caa9f1-cdf3-4443-af8c-ff724ea719d2?ui=en-us&rs=en-us&ad=us"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1566",
                "name": "Phishing",
                "reference": "https://attack.mitre.org/techniques/T1566/",
                "subtechnique": [
                  {
                    "id": "T1566.001",
                    "name": "Spearphishing Attachment",
                    "reference": "https://attack.mitre.org/techniques/T1566/001/"
                  },
                  {
                    "id": "T1566.002",
                    "name": "Spearphishing Link",
                    "reference": "https://attack.mitre.org/techniques/T1566/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The Office 365 Logs Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "o365",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "rule.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "f67b00af-5915-4dea-85cf-faae329e0cb2",
        "rule_id": "5930658c-2107-4afc-91af-e0e55b7f7184",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:36.731Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:10.084Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-o365*"
        ],
        "filters": [],
        "query": "event.dataset:o365.audit and event.provider:SecurityComplianceCenter and event.action:AlertTriggered and rule.name:\"Email reported by user as malware or phish\"",
        "language": "kuery"
      },
      {
        "name": "AWS CloudTrail Log Created",
        "description": "Identifies the creation of an AWS log trail that specifies the settings for delivery of log data.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 207,
        "tags": [
          "Domain: Cloud",
          "Data Source: AWS",
          "Data Source: Amazon Web Services",
          "Use Case: Log Auditing",
          "Tactic: Collection"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-3600s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Trail creations may be made by a system or network administrator. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. Trail creations by unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule."
        ],
        "references": [
          "https://docs.aws.amazon.com/awscloudtrail/latest/APIReference/API_CreateTrail.html",
          "https://awscli.amazonaws.com/v2/documentation/api/latest/reference/cloudtrail/create-trail.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0009",
              "name": "Collection",
              "reference": "https://attack.mitre.org/tactics/TA0009/"
            },
            "technique": [
              {
                "id": "T1530",
                "name": "Data from Cloud Storage",
                "reference": "https://attack.mitre.org/techniques/T1530/"
              }
            ]
          }
        ],
        "setup": "The AWS Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "aws",
            "version": "^2.0.0",
            "integration": "cloudtrail"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "0aefb30c-a24f-4f32-90e9-54d09e078ca1",
        "rule_id": "594e0cbf-86cc-45aa-9ff7-ff27db27d3ed",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:36.733Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:10.088Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-aws.cloudtrail-*"
        ],
        "filters": [],
        "query": "event.dataset:aws.cloudtrail and event.provider:cloudtrail.amazonaws.com and event.action:CreateTrail and event.outcome:success",
        "language": "kuery"
      },
      {
        "name": "UAC Bypass Attempt via Privileged IFileOperation COM Interface",
        "description": "Identifies attempts to bypass User Account Control (UAC) via DLL side-loading. Attackers may attempt to bypass UAC to stealthily execute code with elevated permissions.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 309,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: SentinelOne"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/hfiref0x/UACME",
          "https://www.elastic.co/security-labs/exploring-windows-uac-bypasses-techniques-and-detection-strategies"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1548",
                "name": "Abuse Elevation Control Mechanism",
                "reference": "https://attack.mitre.org/techniques/T1548/",
                "subtechnique": [
                  {
                    "id": "T1548.002",
                    "name": "Bypass User Account Control",
                    "reference": "https://attack.mitre.org/techniques/T1548/002/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1548",
                "name": "Abuse Elevation Control Mechanism",
                "reference": "https://attack.mitre.org/techniques/T1548/",
                "subtechnique": [
                  {
                    "id": "T1548.002",
                    "name": "Bypass User Account Control",
                    "reference": "https://attack.mitre.org/techniques/T1548/002/"
                  }
                ]
              },
              {
                "id": "T1574",
                "name": "Hijack Execution Flow",
                "reference": "https://attack.mitre.org/techniques/T1574/",
                "subtechnique": [
                  {
                    "id": "T1574.002",
                    "name": "DLL Side-Loading",
                    "reference": "https://attack.mitre.org/techniques/T1574/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "591072da-8b9e-4fd2-8382-0c19a95d3043",
        "rule_id": "5a14d01d-7ac8-4545-914c-b687c2cf66b3",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:36.737Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:10.091Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"windows\" and event.type : \"change\" and process.name : \"dllhost.exe\" and\n  /* Known modules names side loaded into process running with high or system integrity level for UAC Bypass, update here for new modules */\n  file.name : (\"wow64log.dll\", \"comctl32.dll\", \"DismCore.dll\", \"OskSupport.dll\", \"duser.dll\", \"Accessibility.ni.dll\") and\n  /* has no impact on rule logic just to avoid OS install related FPs */\n  not file.path : (\"C:\\\\Windows\\\\SoftwareDistribution\\\\*\", \"C:\\\\Windows\\\\WinSxS\\\\*\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.file-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*"
        ],
        "filters": []
      },
      {
        "name": "Unusual Linux User Discovery Activity",
        "description": "Looks for commands related to system user or owner discovery from an unusual user context. This can be due to uncommon troubleshooting activity or due to a compromised account. A compromised account may be used to engage in system owner or user discovery in order to identify currently active or primary users of a system. This may be a precursor to additional discovery, credential dumping or privilege elevation activity.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 105,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Rule Type: ML",
          "Rule Type: Machine Learning",
          "Tactic: Discovery"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "15m",
        "from": "now-2700s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Uncommon user command activity can be due to an engineer logging onto a server instance in order to perform manual troubleshooting or reconfiguration."
        ],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1033",
                "name": "System Owner/User Discovery",
                "reference": "https://attack.mitre.org/techniques/T1033/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires the installation of associated Machine Learning jobs, as well as data coming in from one of the following integrations:\n- Elastic Defend\n- Auditd Manager\n\n### Anomaly Detection Setup\n\nOnce the rule is enabled, the associated Machine Learning job will start automatically. You can view the Machine Learning job linked under the \"Definition\" panel of the detection rule. If the job does not start due to an error, the issue must be resolved for the job to commence successfully. For more details on setting up anomaly detection jobs, refer to the [helper guide](https://www.elastic.co/guide/en/kibana/current/xpack-ml-anomalies.html).\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration to your system:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n### Auditd Manager Integration Setup\nThe Auditd Manager Integration receives audit events from the Linux Audit Framework which is a part of the Linux kernel.\nAuditd Manager provides a user-friendly interface and automation capabilities for configuring and monitoring system auditing through the auditd daemon. With `auditd_manager`, administrators can easily define audit rules, track system events, and generate comprehensive audit reports, improving overall security and compliance in the system.\n\n#### The following steps should be executed in order to add the Elastic Agent System integration \"auditd_manager\" to your system:\n- Go to the Kibana home page and click â€œAdd integrationsâ€.\n- In the query bar, search for â€œAuditd Managerâ€ and select the integration to see more details about it.\n- Click â€œAdd Auditd Managerâ€.\n- Configure the integration name and optionally add a description.\n- Review optional and advanced settings accordingly.\n- Add the newly installed â€œauditd managerâ€ to an existing or a new agent policy, and deploy the agent on a Linux system from which auditd log files are desirable.\n- Click â€œSave and Continueâ€.\n- For more details on the integration refer to the [helper guide](https://docs.elastic.co/integrations/auditd_manager).\n\n#### Rule Specific Setup Note\nAuditd Manager subscribes to the kernel and receives events as they occur without any additional configuration.\nHowever, if more advanced configuration is required to detect specific behavior, audit rules can be added to the integration in either the \"audit rules\" configuration box or the \"auditd rule files\" box by specifying a file to read the audit rules from.\n- For this detection rule no additional audit rules are required.\n",
        "related_integrations": [
          {
            "package": "auditd_manager",
            "version": "^1.0.0"
          },
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [],
        "id": "7996d0db-0d64-46db-8711-53914b550bd7",
        "rule_id": "59756272-1998-4b8c-be14-e287035c4d10",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:36.735Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:06.252Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "machine_learning",
        "anomaly_threshold": 75,
        "machine_learning_job_id": [
          "v3_linux_system_user_discovery"
        ]
      },
      {
        "name": "Remote SSH Login Enabled via systemsetup Command",
        "description": "Detects use of the systemsetup command to enable remote SSH Login.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 106,
        "tags": [
          "Domain: Endpoint",
          "OS: macOS",
          "Use Case: Threat Detection",
          "Tactic: Lateral Movement",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://documents.trendmicro.com/assets/pdf/XCSSET_Technical_Brief.pdf",
          "https://ss64.com/osx/systemsetup.html",
          "https://support.apple.com/guide/remote-desktop/about-systemsetup-apd95406b8d/mac"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1021",
                "name": "Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1021/",
                "subtechnique": [
                  {
                    "id": "T1021.004",
                    "name": "SSH",
                    "reference": "https://attack.mitre.org/techniques/T1021/004/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a macOS System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, for MacOS it is recommended to select \"Traditional Endpoints\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "03b192ec-3502-4f81-9f27-395c19c8f193",
        "rule_id": "5ae4e6f8-d1bf-40fa-96ba-e29645e1e4dc",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:36.738Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:10.097Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": [],
        "query": "event.category:process and host.os.type:macos and event.type:(start or process_started) and\n process.name:systemsetup and\n process.args:(\"-setremotelogin\" and on) and\n not process.parent.executable : /usr/local/jamf/bin/jamf",
        "language": "kuery"
      },
      {
        "name": "Virtual Machine Fingerprinting",
        "description": "An adversary may attempt to get detailed information about the operating system and hardware. This rule identifies common locations used to discover virtual machine hardware by a non-root user. This technique has been used by the Pupy RAT and other malware.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 108,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Certain tools or automated software may enumerate hardware information. These tools can be exempted via user name or process arguments to eliminate potential noise."
        ],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1082",
                "name": "System Information Discovery",
                "reference": "https://attack.mitre.org/techniques/T1082/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from one of the following integrations:\n- Elastic Defend\n- Auditbeat\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n### Auditbeat Setup\nAuditbeat is a lightweight shipper that you can install on your servers to audit the activities of users and processes on your systems. For example, you can use Auditbeat to collect and centralize audit events from the Linux Audit Framework. You can also use Auditbeat to detect changes to critical files, like binaries and configuration files, and identify potential security policy violations.\n\n#### The following steps should be executed in order to add the Auditbeat on a Linux System:\n- Elastic provides repositories available for APT and YUM-based distributions. Note that we provide binary packages, but no source packages.\n- To install the APT and YUM repositories follow the setup instructions in this [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/setup-repositories.html).\n- To run Auditbeat on Docker follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/running-on-docker.html).\n- To run Auditbeat on Kubernetes follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/running-on-kubernetes.html).\n- For complete â€œSetup and Run Auditbeatâ€ information refer to the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/setting-up-and-running.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "a325b270-293a-4823-baea-5f4dfd28494e",
        "rule_id": "5b03c9fb-9945-4d2f-9568-fd690fee3fba",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:36.740Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:10.101Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "auditbeat-*",
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": [],
        "query": "event.category:process and host.os.type:linux and event.type:(start or process_started) and\n  process.args:(\"/sys/class/dmi/id/bios_version\" or\n                \"/sys/class/dmi/id/product_name\" or\n                \"/sys/class/dmi/id/chassis_vendor\" or\n                \"/proc/scsi/scsi\" or\n                \"/proc/ide/hd0/model\") and\n  not user.name:root",
        "language": "kuery"
      },
      {
        "name": "AWS WAF Rule or Rule Group Deletion",
        "description": "Identifies the deletion of a specified AWS Web Application Firewall (WAF) rule or rule group.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Cloud",
          "Data Source: AWS",
          "Data Source: Amazon Web Services",
          "Use Case: Network Security Monitoring",
          "Tactic: Defense Evasion"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-3600s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "WAF rules or rule groups may be deleted by a system or network administrator. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. Rule deletions by unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule."
        ],
        "references": [
          "https://awscli.amazonaws.com/v2/documentation/api/latest/reference/waf/delete-rule-group.html",
          "https://docs.aws.amazon.com/waf/latest/APIReference/API_waf_DeleteRuleGroup.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.001",
                    "name": "Disable or Modify Tools",
                    "reference": "https://attack.mitre.org/techniques/T1562/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The AWS Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "aws",
            "version": "^2.0.0",
            "integration": "cloudtrail"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "12d92aa3-356c-4dc7-a86c-d36e22a85c21",
        "rule_id": "5beaebc1-cc13-4bfc-9949-776f9e0dc318",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:36.742Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:10.107Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-aws.cloudtrail-*"
        ],
        "filters": [],
        "query": "event.dataset:aws.cloudtrail and event.provider:(waf.amazonaws.com or waf-regional.amazonaws.com or wafv2.amazonaws.com) and event.action:(DeleteRule or DeleteRuleGroup) and event.outcome:success",
        "language": "kuery"
      },
      {
        "name": "Potential Defense Evasion via PRoot",
        "description": "Identifies the execution of the PRoot utility, an open-source tool for user-space implementation of chroot, mount --bind, and binfmt_misc. Adversaries can leverage an open-source tool PRoot to expand the scope of their operations to multiple Linux distributions and simplify their necessary efforts. In a normal threat scenario, the scope of an attack is limited by the varying configurations of each Linux distribution. With PRoot, it provides an attacker with a consistent operational environment across different Linux distributions, such as Ubuntu, Fedora, and Alpine. PRoot also provides emulation capabilities that allow for malware built on other architectures, such as ARM, to be run.The post-exploitation technique called bring your own filesystem (BYOF), can be used by the threat actors to execute malicious payload or elevate privileges or perform network scans or orchestrate another attack on the environment. Although PRoot was originally not developed with malicious intent it can be easily tuned to work for one.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 7,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://proot-me.github.io/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1211",
                "name": "Exploitation for Defense Evasion",
                "reference": "https://attack.mitre.org/techniques/T1211/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "12cd96e7-bd52-423c-a87f-0a69022fd5bd",
        "rule_id": "5c9ec990-37fa-4d5c-abfc-8d432f3dedd0",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:36.744Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:10.110Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\") and\nprocess.parent.name == \"proot\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "Outbound Scheduled Task Activity via PowerShell",
        "description": "Identifies the PowerShell process loading the Task Scheduler COM DLL followed by an outbound RPC network connection within a short time period. This may indicate lateral movement or remote discovery via scheduled tasks.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 209,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Legitimate scheduled tasks may be created during installation of new software."
        ],
        "references": [
          "https://www.volexity.com/blog/2020/12/14/dark-halo-leverages-solarwinds-compromise-to-breach-organizations/",
          "https://www.elastic.co/security-labs/hunting-for-lateral-movement-using-event-query-language"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1053",
                "name": "Scheduled Task/Job",
                "reference": "https://attack.mitre.org/techniques/T1053/",
                "subtechnique": [
                  {
                    "id": "T1053.005",
                    "name": "Scheduled Task",
                    "reference": "https://attack.mitre.org/techniques/T1053/005/"
                  }
                ]
              },
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.address",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "destination.port",
            "type": "long",
            "ecs": true
          },
          {
            "name": "dll.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "33e437a1-73d8-4d85-a24b-431351fb30d1",
        "rule_id": "5cd55388-a19c-47c7-8ec4-f41656c2fded",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:36.746Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:10.113Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by host.id, process.entity_id with maxspan = 5s\n [any where host.os.type == \"windows\" and (event.category == \"library\" or (event.category == \"process\" and event.action : \"Image loaded*\")) and\n  (?dll.name : \"taskschd.dll\" or file.name : \"taskschd.dll\") and process.name : (\"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\")]\n [network where host.os.type == \"windows\" and process.name : (\"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\") and destination.port == 135 and not destination.address in (\"127.0.0.1\", \"::1\")]",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.library-*",
          "logs-endpoint.events.network-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "Persistence via PowerShell profile",
        "description": "Identifies the creation or modification of a PowerShell profile. PowerShell profile is a script that is executed when PowerShell starts to customize the user environment, which can be abused by attackers to persist in a environment where PowerShell is common.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Persistence via PowerShell profile\n\nPowerShell profiles are scripts executed when PowerShell starts, customizing the user environment. They are commonly used in Windows environments for legitimate purposes, such as setting variables or loading modules. However, adversaries can abuse PowerShell profiles to establish persistence by inserting malicious code that executes each time PowerShell is launched.\n\nThis rule identifies the creation or modification of a PowerShell profile. It does this by monitoring file events on Windows systems, specifically targeting profile-related file paths and names, such as `profile.ps1` and `Microsoft.Powershell_profile.ps1`. By detecting these activities, security analysts can investigate potential abuse of PowerShell profiles for malicious persistence.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n### Possible investigation steps\n\n- Retrive and inspect the PowerShell profile content; look for suspicious DLL imports, collection or persistence capabilities, suspicious functions, encoded or compressed data, suspicious commands, and other potentially malicious characteristics.\n- Identify the process responsible for the PowerShell profile creation/modification. Use the Elastic Defend events to examine all the activity of the subject process by filtering by the process's `process.entity_id`.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Evaluate whether the user needs to use PowerShell to complete tasks.\n- Check for additional PowerShell and command-line logs that indicate that any suspicious command or function were run.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Observe and collect information about the following activities in the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process's `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n\n### False positive analysis\n\n- This is a dual-use mechanism, meaning its usage is not inherently malicious. Analysts can dismiss the alert if the script doesn't contain malicious functions or potential for abuse, no other suspicious activity was identified, and the user has business justifications to use PowerShell.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n  - If malicious activity is confirmed, perform a broader investigation to identify the scope of the compromise and determine the appropriate remediation steps.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Reimage the host operating system or restore the compromised files to clean versions.\n- Restrict PowerShell usage outside of IT and engineering business units using GPOs, AppLocker, Intune, or similar software.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n  - Consider enabling and collecting PowerShell logs such as transcription, module, and script block logging, to improve visibility into PowerShell activities.\n",
        "output_index": "",
        "version": 209,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Tactic: Privilege Escalation",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: SentinelOne"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_profiles",
          "https://www.welivesecurity.com/2019/05/29/turla-powershell-usage/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1546",
                "name": "Event Triggered Execution",
                "reference": "https://attack.mitre.org/techniques/T1546/",
                "subtechnique": [
                  {
                    "id": "T1546.013",
                    "name": "PowerShell Profile",
                    "reference": "https://attack.mitre.org/techniques/T1546/013/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1546",
                "name": "Event Triggered Execution",
                "reference": "https://attack.mitre.org/techniques/T1546/",
                "subtechnique": [
                  {
                    "id": "T1546.013",
                    "name": "PowerShell Profile",
                    "reference": "https://attack.mitre.org/techniques/T1546/013/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "7e345efa-d3b9-4a2d-b3a7-bcce2ad1338a",
        "rule_id": "5cf6397e-eb91-4f31-8951-9f0eaa755a31",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:36.748Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:10.117Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"windows\" and event.type != \"deletion\" and\n  file.path : (\"?:\\\\Users\\\\*\\\\Documents\\\\WindowsPowerShell\\\\*\",\n               \"?:\\\\Users\\\\*\\\\Documents\\\\PowerShell\\\\*\",\n               \"?:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\*\") and\n  file.name : (\"profile.ps1\", \"Microsoft.Powershell_profile.ps1\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.file-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*"
        ],
        "filters": []
      },
      {
        "name": "Persistence via Login or Logout Hook",
        "description": "Identifies use of the Defaults command to install a login or logoff hook in MacOS. An adversary may abuse this capability to establish persistence in an environment by inserting code to be executed at login or logout.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 107,
        "tags": [
          "Domain: Endpoint",
          "OS: macOS",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.virusbulletin.com/uploads/pdf/conference_slides/2014/Wardle-VB2014.pdf",
          "https://www.manpagez.com/man/1/defaults/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1037",
                "name": "Boot or Logon Initialization Scripts",
                "reference": "https://attack.mitre.org/techniques/T1037/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a macOS System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, for MacOS it is recommended to select \"Traditional Endpoints\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "7e992894-3680-439b-b824-268d366da684",
        "rule_id": "5d0265bf-dea9-41a9-92ad-48a8dcd05080",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:36.749Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:10.120Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"macos\" and event.type == \"start\" and\n process.name == \"defaults\" and process.args == \"write\" and process.args : (\"LoginHook\", \"LogoutHook\") and\n not process.args :\n       (\n         \"Support/JAMF/ManagementFrameworkScripts/logouthook.sh\",\n         \"Support/JAMF/ManagementFrameworkScripts/loginhook.sh\",\n         \"/Library/Application Support/JAMF/ManagementFrameworkScripts/logouthook.sh\",\n         \"/Library/Application Support/JAMF/ManagementFrameworkScripts/loginhook.sh\"\n       )",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious Automator Workflows Execution",
        "description": "Identifies the execution of the Automator Workflows process followed by a network connection from it's XPC service. Adversaries may drop a custom workflow template that hosts malicious JavaScript for Automation (JXA) code as an alternative to using osascript.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 106,
        "tags": [
          "Domain: Endpoint",
          "OS: macOS",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://posts.specterops.io/persistent-jxa-66e1c3cd1cf5"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a macOS System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, for MacOS it is recommended to select \"Traditional Endpoints\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "66318d5e-1500-493a-aea0-5cf6930ed366",
        "rule_id": "5d9f8cfc-0d03-443e-a167-2b0597ce0965",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:36.751Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:10.123Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by host.id with maxspan=30s\n [process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and process.name == \"automator\"]\n [network where host.os.type == \"macos\" and process.name:\"com.apple.automator.runner\"]",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Microsoft 365 Teams Guest Access Enabled",
        "description": "Identifies when guest access is enabled in Microsoft Teams. Guest access in Teams allows people outside the organization to access teams and channels. An adversary may enable guest access to maintain persistence in an environment.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Cloud",
          "Data Source: Microsoft 365",
          "Use Case: Configuration Audit",
          "Tactic: Persistence"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-1800s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Teams guest access may be enabled by a system or network administrator. Verify that the configuration change was expected. Exceptions can be added to this rule to filter expected behavior."
        ],
        "references": [
          "https://docs.microsoft.com/en-us/powershell/module/skype/get-csteamsclientconfiguration?view=skype-ps"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1098",
                "name": "Account Manipulation",
                "reference": "https://attack.mitre.org/techniques/T1098/"
              }
            ]
          }
        ],
        "setup": "The Office 365 Logs Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "o365",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "o365.audit.Parameters.AllowGuestUser",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "7ca12127-4c92-4488-9091-d652170cb3b6",
        "rule_id": "5e552599-ddec-4e14-bad1-28aa42404388",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:36.753Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:10.136Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-o365*"
        ],
        "filters": [],
        "query": "event.dataset:o365.audit and event.provider:(SkypeForBusiness or MicrosoftTeams) and\nevent.category:web and event.action:\"Set-CsTeamsClientConfiguration\" and\no365.audit.Parameters.AllowGuestUser:True and event.outcome:success",
        "language": "kuery"
      },
      {
        "name": "Microsoft 365 Exchange DLP Policy Removed",
        "description": "Identifies when a Data Loss Prevention (DLP) policy is removed in Microsoft 365. An adversary may remove a DLP policy to evade existing DLP monitoring.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Cloud",
          "Data Source: Microsoft 365",
          "Use Case: Configuration Audit",
          "Tactic: Defense Evasion"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-1800s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "A DLP policy may be removed by a system or network administrator. Verify that the configuration change was expected. Exceptions can be added to this rule to filter expected behavior."
        ],
        "references": [
          "https://docs.microsoft.com/en-us/powershell/module/exchange/remove-dlppolicy?view=exchange-ps",
          "https://docs.microsoft.com/en-us/microsoft-365/compliance/data-loss-prevention-policies?view=o365-worldwide"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/"
              }
            ]
          }
        ],
        "setup": "The Office 365 Logs Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "o365",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "06418536-57b3-49b4-9709-4f2ee1111c9d",
        "rule_id": "60f3adec-1df9-4104-9c75-b97d9f078b25",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:36.755Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:10.147Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-o365*"
        ],
        "filters": [],
        "query": "event.dataset:o365.audit and event.provider:Exchange and event.category:web and event.action:\"Remove-DlpPolicy\" and event.outcome:success",
        "language": "kuery"
      },
      {
        "name": "Unusual Process Network Connection",
        "description": "Identifies network activity from unexpected system applications. This may indicate adversarial activity as these applications are often leveraged by adversaries to execute code and evade detection.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Unusual Process Network Connection\n\nThis rule identifies network activity from unexpected system utilities and applications. These applications are commonly abused by attackers to execute code, evade detections, and bypass security protections.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate the target host that the process is communicating with.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Review the privileges assigned to the user to ensure that the least privilege principle is being followed.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 208,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1127",
                "name": "Trusted Developer Utilities Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1127/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "83935ce6-45ba-4a94-ad25-883a7d2c978c",
        "rule_id": "610949a1-312f-4e04-bb55-3a79b8c95267",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:36.769Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:10.150Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by process.entity_id\n  [process where host.os.type == \"windows\" and (process.name : \"Microsoft.Workflow.Compiler.exe\" or\n                  process.name : \"bginfo.exe\" or\n                  process.name : \"cdb.exe\" or\n                  process.name : \"cmstp.exe\" or\n                  process.name : \"csi.exe\" or\n                  process.name : \"dnx.exe\" or\n                  process.name : \"fsi.exe\" or\n                  process.name : \"ieexec.exe\" or\n                  process.name : \"iexpress.exe\" or\n                  process.name : \"odbcconf.exe\" or\n                  process.name : \"rcsi.exe\" or\n                  process.name : \"xwizard.exe\") and\n     event.type == \"start\"]\n  [network where host.os.type == \"windows\" and (process.name : \"Microsoft.Workflow.Compiler.exe\" or\n                  process.name : \"bginfo.exe\" or\n                  process.name : \"cdb.exe\" or\n                  process.name : \"cmstp.exe\" or\n                  process.name : \"csi.exe\" or\n                  process.name : \"dnx.exe\" or\n                  process.name : \"fsi.exe\" or\n                  process.name : \"ieexec.exe\" or\n                  process.name : \"iexpress.exe\" or\n                  process.name : \"odbcconf.exe\" or\n                  process.name : \"rcsi.exe\" or\n                  process.name : \"xwizard.exe\")]",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-endpoint.events.network-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "AdminSDHolder SDProp Exclusion Added",
        "description": "Identifies a modification on the dsHeuristics attribute on the bit that holds the configuration of groups excluded from the SDProp process. The SDProp compares the permissions on protected objects with those defined on the AdminSDHolder object. If the permissions on any of the protected accounts and groups do not match, the permissions on the protected accounts and groups are reset to match those of the domain's AdminSDHolder object, meaning that groups excluded will remain unchanged. Attackers can abuse this misconfiguration to maintain long-term access to privileged accounts in these groups.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating AdminSDHolder SDProp Exclusion Added\n\nThe SDProp process compares the permissions on protected objects with those defined on the AdminSDHolder object. If the permissions on any of the protected accounts and groups do not match, it resets the permissions on the protected accounts and groups to match those defined in the domain AdminSDHolder object.\n\nThe dSHeuristics is a Unicode string attribute, in which each character in the string represents a heuristic that is used to determine the behavior of Active Directory.\n\nAdministrators can use the dSHeuristics attribute to exclude privilege groups from the SDProp process by setting the 16th bit (dwAdminSDExMask) of the string to a certain value, which represents the group(s):\n\n- For example, to exclude the Account Operators group, an administrator would modify the string, so the 16th character is set to 1 (i.e., 0000000001000001).\n\nThe usage of this exclusion can leave the accounts unprotected and facilitate the misconfiguration of privileges for the excluded groups, enabling attackers to add accounts to these groups to maintain long-term persistence with high privileges.\n\nThis rule matches changes of the dsHeuristics object where the 16th bit is set to a value other than zero.\n\n#### Possible investigation steps\n\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account and system owners and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Check the value assigned to the 16th bit of the string on the `winlog.event_data.AttributeValue` field:\n    - Account Operators eq 1\n    - Server Operators eq 2\n    - Print Operators eq 4\n    - Backup Operators eq 8\n    The field value can range from 0 to f (15). If more than one group is specified, the values will be summed together; for example, Backup Operators and Print Operators will set the `c` value on the bit.\n\n### False positive analysis\n\n- While this modification can be done legitimately, it is not a best practice. Any potential benign true positive (B-TP) should be mapped and reviewed by the security team for alternatives as this weakens the security of the privileged group.\n\n### Response and remediation\n\n- The change can be reverted by setting the dwAdminSDExMask (16th bit) to 0 in dSHeuristics.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 212,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Data Source: Active Directory",
          "Resources: Investigation Guide",
          "Use Case: Active Directory Monitoring",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.cert.ssi.gouv.fr/uploads/guide-ad.html#dsheuristics_bad",
          "https://petri.com/active-directory-security-understanding-adminsdholder-object"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1078",
                "name": "Valid Accounts",
                "reference": "https://attack.mitre.org/techniques/T1078/",
                "subtechnique": [
                  {
                    "id": "T1078.002",
                    "name": "Domain Accounts",
                    "reference": "https://attack.mitre.org/techniques/T1078/002/"
                  }
                ]
              },
              {
                "id": "T1098",
                "name": "Account Manipulation",
                "reference": "https://attack.mitre.org/techniques/T1098/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'Audit Directory Service Changes' logging policy must be configured for (Success).\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nPolicies >\nWindows Settings >\nSecurity Settings >\nAdvanced Audit Policies Configuration >\nAudit Policies >\nDS Access >\nAudit Directory Service Changes (Success)\n```\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.code",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.event_data.AttributeLDAPDisplayName",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "winlog.event_data.AttributeValue",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "575444fc-d06d-42e8-88a0-a22e1cfc22bf",
        "rule_id": "61d29caf-6c15-4d1e-9ccb-7ad12ccc0bc7",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:36.771Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:05.946Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "any where event.action in (\"Directory Service Changes\", \"directory-service-object-modified\") and\n  event.code == \"5136\" and\n  winlog.event_data.AttributeLDAPDisplayName : \"dSHeuristics\" and\n  length(winlog.event_data.AttributeValue) > 15 and\n  winlog.event_data.AttributeValue regex~ \"[0-9]{15}([1-9a-f]).*\"",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-system.*",
          "logs-windows.*"
        ],
        "filters": []
      },
      {
        "name": "Incoming DCOM Lateral Movement via MSHTA",
        "description": "Identifies the use of Distributed Component Object Model (DCOM) to execute commands from a remote host, which are launched via the HTA Application COM Object. This behavior may indicate an attacker abusing a DCOM application to move laterally while attempting to evade detection.",
        "risk_score": 73,
        "severity": "high",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 207,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Lateral Movement",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://codewhitesec.blogspot.com/2018/07/lethalhta.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1021",
                "name": "Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1021/",
                "subtechnique": [
                  {
                    "id": "T1021.003",
                    "name": "Distributed Component Object Model",
                    "reference": "https://attack.mitre.org/techniques/T1021/003/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1218",
                "name": "System Binary Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1218/",
                "subtechnique": [
                  {
                    "id": "T1218.005",
                    "name": "Mshta",
                    "reference": "https://attack.mitre.org/techniques/T1218/005/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.port",
            "type": "long",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "network.direction",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "network.transport",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "source.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "source.port",
            "type": "long",
            "ecs": true
          }
        ],
        "id": "f63d0b70-3f2c-46e4-ba2b-35f8c39e3d24",
        "rule_id": "622ecb68-fa81-4601-90b5-f8cd661e4520",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:36.772Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:10.153Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence with maxspan=1m\n  [process where host.os.type == \"windows\" and event.type == \"start\" and\n     process.name : \"mshta.exe\" and process.args : \"-Embedding\"\n  ] by host.id, process.entity_id\n  [network where host.os.type == \"windows\" and event.type == \"start\" and process.name : \"mshta.exe\" and\n     network.direction : (\"incoming\", \"ingress\") and network.transport == \"tcp\" and\n     source.port > 49151 and destination.port > 49151 and source.ip != \"127.0.0.1\" and source.ip != \"::1\"\n  ] by host.id, process.entity_id",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-endpoint.events.network-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "Account Configured with Never-Expiring Password",
        "description": "Detects the creation and modification of an account with the \"Don't Expire Password\" option Enabled. Attackers can abuse this misconfiguration to persist in the domain and maintain long-term access using compromised accounts with this property.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Account Configured with Never-Expiring Password\n\nActive Directory provides a setting that prevents users' passwords from expiring. Enabling this setting is bad practice and can expose environments to vulnerabilities that weaken security posture, especially when these accounts are privileged.\n\nThe setting is usually configured so a user account can act as a service account. Attackers can abuse these accounts to persist in the domain and maintain long-term access using compromised accounts with a never-expiring password set.\n\n#### Possible investigation steps\n\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/source host during the past 48 hours.\n- Inspect the account for suspicious or abnormal behaviors in the alert timeframe.\n\n### False positive analysis\n\n- This activity should not happen legitimately. The security team should address any potential benign true positive (B-TP), as this configuration can put the user and the domain at risk.\n- Using user accounts as service accounts is a bad security practice and should not be allowed in the domain. The security team should map and monitor potential benign true positives (B-TPs), especially if the account is privileged. For cases in which user accounts cannot be avoided, Microsoft provides the Group Managed Service Accounts (gMSA) feature, which ensures that the account password is robust and changed regularly and automatically.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Review the privileges assigned to the user to ensure that the least privilege principle is being followed.\n- Reset the password of the account and update its password settings.\n- Search for other occurrences on the domain.\n    - Using the [Active Directory PowerShell module](https://docs.microsoft.com/en-us/powershell/module/activedirectory/get-aduser):\n        - `get-aduser -filter { passwordNeverExpires -eq $true  -and enabled -eq $true } | ft`\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 211,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Data Source: Active Directory",
          "Resources: Investigation Guide",
          "Use Case: Active Directory Monitoring",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "User accounts can be used as service accounts and have their password set never to expire. This is a bad security practice that exposes the account to Credential Access attacks. For cases in which user accounts cannot be avoided, Microsoft provides the Group Managed Service Accounts (gMSA) feature, which ensures that the account password is robust and changed regularly and automatically."
        ],
        "references": [
          "https://www.cert.ssi.gouv.fr/uploads/guide-ad.html#dont_expire",
          "http://web.archive.org/web/20230329171952/https://blog.menasec.net/2019/02/threat-hunting-26-persistent-password.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1098",
                "name": "Account Manipulation",
                "reference": "https://attack.mitre.org/techniques/T1098/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.code",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "message",
            "type": "match_only_text",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.api",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "1d67aa81-4843-4fc7-8da0-4fd82efeaf86",
        "rule_id": "62a70f6f-3c37-43df-a556-f64fa475fba2",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:36.774Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:05.949Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-system.*",
          "logs-windows.*"
        ],
        "filters": [],
        "query": "event.action:\"modified-user-account\" and winlog.api:\"wineventlog\" and event.code:\"4738\" and\n  message:\"'Don't Expire Password' - Enabled\" and not user.id:\"S-1-5-18\"",
        "language": "kuery"
      },
      {
        "name": "Kubernetes Suspicious Assignment of Controller Service Account",
        "description": "This rule detects a request to attach a controller service account to an existing or new pod running in the kube-system namespace. By default, controllers running as part of the API Server utilize admin-equivalent service accounts hosted in the kube-system namespace. Controller service accounts aren't normally assigned to running pods and could indicate adversary behavior within the cluster. An attacker that can create or modify pods or pod controllers in the kube-system namespace, can assign one of these admin-equivalent service accounts to a pod and abuse their powerful token to escalate privileges and gain complete cluster control.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 6,
        "tags": [
          "Data Source: Kubernetes",
          "Tactic: Execution",
          "Tactic: Privilege Escalation"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Controller service accounts aren't normally assigned to running pods, this is abnormal behavior with very few legitimate use-cases and should result in very few false positives."
        ],
        "references": [
          "https://www.paloaltonetworks.com/apps/pan/public/downloadResource?pagePath=/content/pan/en_US/resources/whitepapers/kubernetes-privilege-escalation-excessive-permissions-in-popular-platforms"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1078",
                "name": "Valid Accounts",
                "reference": "https://attack.mitre.org/techniques/T1078/",
                "subtechnique": [
                  {
                    "id": "T1078.001",
                    "name": "Default Accounts",
                    "reference": "https://attack.mitre.org/techniques/T1078/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The Kubernetes Fleet integration with Audit Logs enabled or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "kubernetes",
            "version": "^1.4.1"
          }
        ],
        "required_fields": [
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "kubernetes.audit.annotations.authorization_k8s_io/decision",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "kubernetes.audit.objectRef.namespace",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "kubernetes.audit.objectRef.resource",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "kubernetes.audit.requestObject.spec.serviceAccountName",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "kubernetes.audit.verb",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "564bbd6a-5e63-447e-9bc9-1d3c89e77abb",
        "rule_id": "63c05204-339a-11ed-a261-0242ac120002",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:36.776Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:10.156Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "logs-kubernetes.*"
        ],
        "filters": [],
        "query": "event.dataset : \"kubernetes.audit_logs\"\n  and kubernetes.audit.annotations.authorization_k8s_io/decision:\"allow\"\n  and kubernetes.audit.verb : \"create\"\n  and kubernetes.audit.objectRef.resource : \"pods\"\n  and kubernetes.audit.objectRef.namespace : \"kube-system\"\n  and kubernetes.audit.requestObject.spec.serviceAccountName:*controller",
        "language": "kuery"
      },
      {
        "name": "Network Connection via Signed Binary",
        "description": "Binaries signed with trusted digital certificates can execute on Windows systems protected by digital signature validation. Adversaries may use these binaries to 'live off the land' and execute malicious files that could bypass application allowlists and signature validation.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Network Connection via Signed Binary\n\nBy examining the specific traits of Windows binaries (such as process trees, command lines, network connections, registry modifications, and so on) it's possible to establish a baseline of normal activity. Deviations from this baseline can indicate malicious activity, such as masquerading and deserve further investigation.\n\nThis rule looks for the execution of `expand.exe`, `extrac32.exe`, `ieexec.exe`, or `makecab.exe` utilities, followed by a network connection to an external address. Attackers can abuse utilities to execute malicious files or masquerade as those utilities to bypass detections and evade defenses.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n  - Investigate any abnormal behavior by the subject process such as network connections, registry or file modifications, and any spawned child processes.\n  - Investigate the file digital signature and process original filename, if suspicious, treat it as potential malware.\n- Investigate the target host that the signed binary is communicating with.\n  - Check if the domain is newly registered or unexpected.\n  - Check the reputation of the domain or IP address.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the process executable using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n\n### False positive analysis\n\n- If this activity is expected and noisy in your environment, consider adding exceptions â€” preferably with a combination of destination IP address and command line conditions.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 208,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.iana.org/assignments/iana-ipv4-special-registry/iana-ipv4-special-registry.xhtml"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1218",
                "name": "System Binary Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1218/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "2d5fa4ad-df8b-47c4-96fb-d8469ef8eaf7",
        "rule_id": "63e65ec3-43b1-45b0-8f2d-45b34291dc44",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:36.778Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:05.955Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by process.entity_id\n  [process where host.os.type == \"windows\" and (process.name : \"expand.exe\" or process.name : \"extrac32.exe\" or\n                 process.name : \"ieexec.exe\" or process.name : \"makecab.exe\") and\n                 event.type == \"start\"]\n  [network where host.os.type == \"windows\" and (process.name : \"expand.exe\" or process.name : \"extrac32.exe\" or\n                 process.name : \"ieexec.exe\" or process.name : \"makecab.exe\") and\n    not cidrmatch(destination.ip,\n      \"10.0.0.0/8\", \"127.0.0.0/8\", \"169.254.0.0/16\", \"172.16.0.0/12\", \"192.0.0.0/24\", \"192.0.0.0/29\", \"192.0.0.8/32\",\n      \"192.0.0.9/32\", \"192.0.0.10/32\", \"192.0.0.170/32\", \"192.0.0.171/32\", \"192.0.2.0/24\", \"192.31.196.0/24\",\n      \"192.52.193.0/24\", \"192.168.0.0/16\", \"192.88.99.0/24\", \"224.0.0.0/4\", \"100.64.0.0/10\", \"192.175.48.0/24\",\n      \"198.18.0.0/15\", \"198.51.100.0/24\", \"203.0.113.0/24\", \"240.0.0.0/4\", \"::1\", \"FE80::/10\", \"FF00::/8\")]",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-endpoint.events.network-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "Anomalous Process For a Linux Population",
        "description": "Searches for rare processes running on multiple Linux hosts in an entire fleet or network. This reduces the detection of false positives since automated maintenance processes usually only run occasionally on a single machine but are common to all or many hosts in a fleet.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Anomalous Process For a Linux Population\n\nSearching for abnormal Linux processes is a good methodology to find potentially malicious activity within a network. Understanding what is commonly run within an environment and developing baselines for legitimate activity can help uncover potential malware and suspicious behaviors.\n\nThis rule uses a machine learning job to detect a Linux process that is rare and unusual for all of the monitored Linux hosts in your fleet.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, and whether they are located in expected locations.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Consider the user as identified by the `user.name` field. Is this program part of an expected workflow for the user who ran this program on this host?\n- Validate the activity is not related to planned patches, updates, network administrator activity, or legitimate software installations.\n- Validate if the activity has a consistent cadence (for example, if it runs monthly or quarterly), as it could be part of a monthly or quarterly business process.\n- Examine the arguments and working directory of the process. These may provide indications as to the source of the program or the nature of the tasks it is performing.\n\n### False Positive Analysis\n\n- If this activity is related to new benign software installation activity, consider adding exceptions â€” preferably with a combination of user and command line conditions.\n- Try to understand the context of the execution by thinking about the user, machine, or business purpose. A small number of endpoints, such as servers with unique software, might appear unusual but satisfy a specific business need.\n\n### Response and Remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that   attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 105,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Rule Type: ML",
          "Rule Type: Machine Learning",
          "Tactic: Persistence",
          "Resources: Investigation Guide"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "15m",
        "from": "now-2700s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "A newly installed program or one that runs rarely as part of a monthly or quarterly workflow could trigger this alert."
        ],
        "references": [
          "https://www.elastic.co/guide/en/security/current/prebuilt-ml-jobs.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1543",
                "name": "Create or Modify System Process",
                "reference": "https://attack.mitre.org/techniques/T1543/",
                "subtechnique": [
                  {
                    "id": "T1543.003",
                    "name": "Windows Service",
                    "reference": "https://attack.mitre.org/techniques/T1543/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires the installation of associated Machine Learning jobs, as well as data coming in from one of the following integrations:\n- Elastic Defend\n- Auditd Manager\n\n### Anomaly Detection Setup\n\nOnce the rule is enabled, the associated Machine Learning job will start automatically. You can view the Machine Learning job linked under the \"Definition\" panel of the detection rule. If the job does not start due to an error, the issue must be resolved for the job to commence successfully. For more details on setting up anomaly detection jobs, refer to the [helper guide](https://www.elastic.co/guide/en/kibana/current/xpack-ml-anomalies.html).\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration to your system:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n### Auditd Manager Integration Setup\nThe Auditd Manager Integration receives audit events from the Linux Audit Framework which is a part of the Linux kernel.\nAuditd Manager provides a user-friendly interface and automation capabilities for configuring and monitoring system auditing through the auditd daemon. With `auditd_manager`, administrators can easily define audit rules, track system events, and generate comprehensive audit reports, improving overall security and compliance in the system.\n\n#### The following steps should be executed in order to add the Elastic Agent System integration \"auditd_manager\" to your system:\n- Go to the Kibana home page and click â€œAdd integrationsâ€.\n- In the query bar, search for â€œAuditd Managerâ€ and select the integration to see more details about it.\n- Click â€œAdd Auditd Managerâ€.\n- Configure the integration name and optionally add a description.\n- Review optional and advanced settings accordingly.\n- Add the newly installed â€œauditd managerâ€ to an existing or a new agent policy, and deploy the agent on a Linux system from which auditd log files are desirable.\n- Click â€œSave and Continueâ€.\n- For more details on the integration refer to the [helper guide](https://docs.elastic.co/integrations/auditd_manager).\n\n#### Rule Specific Setup Note\nAuditd Manager subscribes to the kernel and receives events as they occur without any additional configuration.\nHowever, if more advanced configuration is required to detect specific behavior, audit rules can be added to the integration in either the \"audit rules\" configuration box or the \"auditd rule files\" box by specifying a file to read the audit rules from.\n- For this detection rule no additional audit rules are required.\n",
        "related_integrations": [
          {
            "package": "auditd_manager",
            "version": "^1.0.0"
          },
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [],
        "id": "519312d8-3e9d-4c7f-b605-f92c34f77612",
        "rule_id": "647fc812-7996-4795-8869-9c4ea595fe88",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:36.779Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:10.160Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "machine_learning",
        "anomaly_threshold": 50,
        "machine_learning_job_id": [
          "v3_linux_anomalous_process_all_hosts"
        ]
      },
      {
        "name": "Modification of Safari Settings via Defaults Command",
        "description": "Identifies changes to the Safari configuration using the built-in defaults command. Adversaries may attempt to enable or disable certain Safari settings, such as enabling JavaScript from Apple Events to ease in the hijacking of the users browser.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 106,
        "tags": [
          "Domain: Endpoint",
          "OS: macOS",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://objectivebythesea.com/v2/talks/OBTS_v2_Zohar.pdf"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.001",
                    "name": "Disable or Modify Tools",
                    "reference": "https://attack.mitre.org/techniques/T1562/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a macOS System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, for MacOS it is recommended to select \"Traditional Endpoints\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "cb279363-6326-436b-b6c4-8097c0428df4",
        "rule_id": "6482255d-f468-45ea-a5b3-d3a7de1331ae",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:36.781Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:10.163Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": [],
        "query": "event.category:process and host.os.type:macos and event.type:start and\n  process.name:defaults and process.args:\n    (com.apple.Safari and write and not\n      (\n      UniversalSearchEnabled or\n      SuppressSearchSuggestions or\n      WebKitTabToLinksPreferenceKey or\n      ShowFullURLInSmartSearchField or\n      com.apple.Safari.ContentPageGroupIdentifier.WebKit2TabsToLinks\n      )\n    )",
        "language": "kuery"
      },
      {
        "name": "Kubernetes Exposed Service Created With Type NodePort",
        "description": "This rule detects an attempt to create or modify a service as type NodePort. The NodePort service allows a user to externally expose a set of labeled pods to the internet. This creates an open port on every worker node in the cluster that has a pod for that service. When external traffic is received on that open port, it directs it to the specific pod through the service representing it. A malicious user can configure a service as type Nodeport in order to intercept traffic from other pods or nodes, bypassing firewalls and other network security measures configured for load balancers within a cluster. This creates a direct method of communication between the cluster and the outside world, which could be used for more malicious behavior and certainly widens the attack surface of your cluster.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 203,
        "tags": [
          "Data Source: Kubernetes",
          "Tactic: Execution",
          "Tactic: Persistence"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Developers may have a legitimate use for NodePorts. For frontend parts of an application you may want to expose a Service onto an external IP address without using cloud specific Loadbalancers. NodePort can be used to expose the Service on each Node's IP at a static port (the NodePort). You'll be able to contact the NodePort Service from outside the cluster, by requesting <NodeIP>:<NodePort>. NodePort unlike Loadbalancers, allow the freedom to set up your own load balancing solution, configure environments that aren't fully supported by Kubernetes, or even to expose one or more node's IPs directly."
        ],
        "references": [
          "https://kubernetes.io/docs/concepts/services-networking/service/#publishing-services-service-types",
          "https://kubernetes.io/docs/concepts/services-networking/service/#type-nodeport",
          "https://www.tigera.io/blog/new-vulnerability-exposes-kubernetes-to-man-in-the-middle-attacks-heres-how-to-mitigate/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1133",
                "name": "External Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1133/"
              }
            ]
          }
        ],
        "setup": "The Kubernetes Fleet integration with Audit Logs enabled or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "kubernetes",
            "version": "^1.4.1"
          }
        ],
        "required_fields": [
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "kubernetes.audit.annotations.authorization_k8s_io/decision",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "kubernetes.audit.objectRef.resource",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "kubernetes.audit.requestObject.spec.type",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "kubernetes.audit.verb",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "1fc47ed2-6fd5-4921-b182-cc99e36abd5a",
        "rule_id": "65f9bccd-510b-40df-8263-334f03174fed",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:36.783Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:10.166Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "logs-kubernetes.*"
        ],
        "filters": [],
        "query": "event.dataset : \"kubernetes.audit_logs\"\n  and kubernetes.audit.annotations.authorization_k8s_io/decision:\"allow\"\n  and kubernetes.audit.objectRef.resource:\"services\"\n  and kubernetes.audit.verb:(\"create\" or \"update\" or \"patch\")\n  and kubernetes.audit.requestObject.spec.type:\"NodePort\"",
        "language": "kuery"
      },
      {
        "name": "Attempt to Mount SMB Share via Command Line",
        "description": "Identifies the execution of macOS built-in commands to mount a Server Message Block (SMB) network share. Adversaries may use valid accounts to interact with a remote network share using SMB.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 107,
        "tags": [
          "Domain: Endpoint",
          "OS: macOS",
          "Use Case: Threat Detection",
          "Tactic: Lateral Movement",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.freebsd.org/cgi/man.cgi?mount_smbfs",
          "https://ss64.com/osx/mount.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1021",
                "name": "Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1021/",
                "subtechnique": [
                  {
                    "id": "T1021.002",
                    "name": "SMB/Windows Admin Shares",
                    "reference": "https://attack.mitre.org/techniques/T1021/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a macOS System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, for MacOS it is recommended to select \"Traditional Endpoints\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "26274d8d-617c-4714-8a45-46fe47d08fa9",
        "rule_id": "661545b4-1a90-4f45-85ce-2ebd7c6a15d0",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:36.785Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:10.169Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and\n  (\n    process.name : \"mount_smbfs\" or\n    (process.name : \"open\" and process.args : \"smb://*\") or\n    (process.name : \"mount\" and process.args : \"smbfs\") or\n    (process.name : \"osascript\" and process.command_line : \"osascript*mount volume*smb://*\")\n  ) and\n  not process.parent.executable : \"/Applications/Google Drive.app/Contents/MacOS/Google Drive\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "WebServer Access Logs Deleted",
        "description": "Identifies the deletion of WebServer access logs. This may indicate an attempt to evade detection or destroy forensic evidence on a system.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 207,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "OS: Windows",
          "OS: macOS",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1070",
                "name": "Indicator Removal",
                "reference": "https://attack.mitre.org/techniques/T1070/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "789fbf1c-ab8a-49cb-b0fa-a14ec3b32897",
        "rule_id": "665e7a4f-c58e-4fc6-bc83-87a7572670ac",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:36.788Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:10.176Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where event.type == \"deletion\" and\n  file.path : (\"C:\\\\inetpub\\\\logs\\\\LogFiles\\\\*.log\",\n               \"/var/log/apache*/access.log\",\n               \"/etc/httpd/logs/access_log\",\n               \"/var/log/httpd/access_log\",\n               \"/var/www/*/logs/access.log\")",
        "language": "eql",
        "index": [
          "auditbeat-*",
          "winlogbeat-*",
          "logs-endpoint.events.*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious Termination of ESXI Process",
        "description": "Identifies instances where VMware processes, such as \"vmware-vmx\" or \"vmx,\" are terminated on a Linux system by a \"kill\" command. The rule monitors for the \"end\" event type, which signifies the termination of a process. The presence of a \"kill\" command as the parent process for terminating VMware processes may indicate that a threat actor is attempting to interfere with the virtualized environment on the targeted system.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 6,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Impact",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.bleepingcomputer.com/news/security/massive-esxiargs-ransomware-attack-targets-vmware-esxi-servers-worldwide/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0040",
              "name": "Impact",
              "reference": "https://attack.mitre.org/tactics/TA0040/"
            },
            "technique": [
              {
                "id": "T1489",
                "name": "Service Stop",
                "reference": "https://attack.mitre.org/techniques/T1489/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "36727401-2429-4e9a-928d-782fd7a556a6",
        "rule_id": "6641a5af-fb7e-487a-adc4-9e6503365318",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:36.786Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:10.172Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"end\" and process.name in (\"vmware-vmx\", \"vmx\")\nand process.parent.name == \"kill\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "Connection to Commonly Abused Web Services",
        "description": "Adversaries may implement command and control (C2) communications that use common web services to hide their activity. This attack technique is typically targeted at an organization and uses web services common to the victim network, which allows the adversary to blend into legitimate traffic activity. These popular services are typically targeted since they have most likely been used before compromise, which helps malicious traffic blend in.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Connection to Commonly Abused Web Services\n\nAdversaries may use an existing, legitimate external Web service as a means for relaying data to/from a compromised system. Popular websites and social media acting as a mechanism for C2 may give a significant amount of cover due to the likelihood that hosts within a network are already communicating with them prior to a compromise.\n\nThis rule looks for processes outside known legitimate program locations communicating with a list of services that can be abused for exfiltration or command and control.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n> This investigation guide uses the [Investigate Markdown Plugin](https://www.elastic.co/guide/en/security/master/interactive-investigation-guides.html) introduced in Elastic Stack version 8.8.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n  - !{investigate{\"label\":\"Alerts associated with the user in the last 48h\",\"providers\":[[{\"excluded\":false,\"field\":\"event.kind\",\"queryType\":\"phrase\",\"value\":\"signal\",\"valueType\":\"string\"},{\"excluded\":false,\"field\":\"user.id\",\"queryType\":\"phrase\",\"value\":\"{{user.id}}\",\"valueType\":\"string\"}]],\"relativeFrom\":\"now-48h/h\",\"relativeTo\":\"now\"}}\n  - !{investigate{\"label\":\"Alerts associated with the host in the last 48h\",\"providers\":[[{\"excluded\":false,\"field\":\"event.kind\",\"queryType\":\"phrase\",\"value\":\"signal\",\"valueType\":\"string\"},{\"excluded\":false,\"field\":\"host.name\",\"queryType\":\"phrase\",\"value\":\"{{host.name}}\",\"valueType\":\"string\"}]],\"relativeFrom\":\"now-48h/h\",\"relativeTo\":\"now\"}}\n- Verify whether the digital signature exists in the executable.\n- Identify the operation type (upload, download, tunneling, etc.).\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the process executable using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n        - !{investigate{\"label\":\"Investigate the Subject Process Network Events\",\"providers\":[[{\"excluded\":false,\"field\":\"event.category\",\"queryType\":\"phrase\",\"value\":\"network\",\"valueType\":\"string\"},{\"excluded\":false,\"field\":\"process.entity_id\",\"queryType\":\"phrase\",\"value\":\"{{process.entity_id}}\",\"valueType\":\"string\"}]]}}\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n\n### False positive analysis\n\n- This rule has a high chance to produce false positives because it detects communication with legitimate services. Noisy false positives can be added as exceptions.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 116,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Command and Control",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/security-labs/operation-bleeding-bear",
          "https://www.elastic.co/security-labs/siestagraph-new-implant-uncovered-in-asean-member-foreign-ministry"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            },
            "technique": [
              {
                "id": "T1102",
                "name": "Web Service",
                "reference": "https://attack.mitre.org/techniques/T1102/"
              },
              {
                "id": "T1568",
                "name": "Dynamic Resolution",
                "reference": "https://attack.mitre.org/techniques/T1568/",
                "subtechnique": [
                  {
                    "id": "T1568.002",
                    "name": "Domain Generation Algorithms",
                    "reference": "https://attack.mitre.org/techniques/T1568/002/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0010",
              "name": "Exfiltration",
              "reference": "https://attack.mitre.org/tactics/TA0010/"
            },
            "technique": [
              {
                "id": "T1567",
                "name": "Exfiltration Over Web Service",
                "reference": "https://attack.mitre.org/techniques/T1567/",
                "subtechnique": [
                  {
                    "id": "T1567.001",
                    "name": "Exfiltration to Code Repository",
                    "reference": "https://attack.mitre.org/techniques/T1567/001/"
                  },
                  {
                    "id": "T1567.002",
                    "name": "Exfiltration to Cloud Storage",
                    "reference": "https://attack.mitre.org/techniques/T1567/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "dns.question.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "network.protocol",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.code_signature.subject_name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.code_signature.trusted",
            "type": "boolean",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "516e182b-65e7-4d92-a1c5-dd8600d361a1",
        "rule_id": "66883649-f908-4a5b-a1e0-54090a1d3a32",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:36.790Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:05.966Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "network where host.os.type == \"windows\" and network.protocol == \"dns\" and\n    process.name != null and user.id not in (\"S-1-5-18\", \"S-1-5-19\", \"S-1-5-20\") and\n    /* Add new WebSvc domains here */\n    dns.question.name :\n       (\n        \"raw.githubusercontent.*\",\n        \"pastebin.*\",\n        \"paste4btc.com\",\n        \"paste.ee\",\n        \"ghostbin.com\",\n        \"drive.google.com\",\n        \"?.docs.live.net\",\n        \"api.dropboxapi.*\",\n        \"content.dropboxapi.*\",\n        \"dl.dropboxusercontent.*\",\n        \"api.onedrive.com\",\n        \"*.onedrive.org\",\n        \"onedrive.live.com\",\n        \"filebin.net\",\n        \"*.ngrok.io\",\n        \"ngrok.com\",\n        \"*.portmap.*\",\n        \"*serveo.net\",\n        \"*localtunnel.me\",\n        \"*pagekite.me\",\n        \"*localxpose.io\",\n        \"*notabug.org\",\n        \"rawcdn.githack.*\",\n        \"paste.nrecom.net\",\n        \"zerobin.net\",\n        \"controlc.com\",\n        \"requestbin.net\",\n        \"slack.com\",\n        \"api.slack.com\",\n        \"slack-redir.net\",\n        \"slack-files.com\",\n        \"cdn.discordapp.com\",\n        \"discordapp.com\",\n        \"discord.com\",\n        \"apis.azureedge.net\",\n        \"cdn.sql.gg\",\n        \"?.top4top.io\",\n        \"top4top.io\",\n        \"www.uplooder.net\",\n        \"*.cdnmegafiles.com\",\n        \"transfer.sh\",\n        \"gofile.io\",\n        \"updates.peer2profit.com\",\n        \"api.telegram.org\",\n        \"t.me\",\n        \"meacz.gq\",\n        \"rwrd.org\",\n        \"*.publicvm.com\",\n        \"*.blogspot.com\",\n        \"api.mylnikov.org\",\n        \"file.io\",\n        \"stackoverflow.com\",\n        \"*files.1drv.com\",\n        \"api.anonfile.com\",\n        \"*hosting-profi.de\",\n        \"ipbase.com\",\n        \"ipfs.io\",\n        \"*up.freeo*.space\",\n        \"api.mylnikov.org\",\n        \"script.google.com\",\n        \"script.googleusercontent.com\",\n        \"api.notion.com\",\n        \"graph.microsoft.com\",\n        \"*.sharepoint.com\",\n        \"mbasic.facebook.com\",\n        \"login.live.com\",\n        \"api.gofile.io\",\n        \"api.anonfiles.com\",\n        \"api.notion.com\",\n        \"api.trello.com\",\n        \"gist.githubusercontent.com\",\n        \"files.pythonhosted.org\",\n        \"g.live.com\",\n        \"*.zulipchat.com\",\n        \"webhook.site\",\n        \"run.mocky.io\",\n        \"mockbin.org\", \n        \"www.googleapis.com\", \n        \"googleapis.com\",\n        \"global.rel.tunnels.api.visualstudio.com\",\n        \"*.devtunnels.ms\") and\n        \n    /* Insert noisy false positives here */\n    not (\n      (\n        process.executable : (\n          \"?:\\\\Program Files\\\\*.exe\",\n          \"?:\\\\Program Files (x86)\\\\*.exe\",\n          \"?:\\\\Windows\\\\System32\\\\WWAHost.exe\",\n          \"?:\\\\Windows\\\\System32\\\\smartscreen.exe\",\n          \"?:\\\\Windows\\\\System32\\\\MicrosoftEdgeCP.exe\",\n          \"?:\\\\ProgramData\\\\Microsoft\\\\Windows Defender\\\\Platform\\\\*\\\\MsMpEng.exe\",\n          \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Google\\\\Chrome\\\\Application\\\\chrome.exe\",\n          \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\BraveSoftware\\\\*\\\\Application\\\\brave.exe\",\n          \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Vivaldi\\\\Application\\\\vivaldi.exe\",\n          \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Programs\\\\Opera*\\\\opera.exe\",\n          \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Programs\\\\Fiddler\\\\Fiddler.exe\",\n          \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Programs\\\\Microsoft VS Code\\\\Code.exe\",\n          \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Microsoft\\\\OneDrive\\\\OneDrive.exe\",\n          \"?:\\\\Windows\\\\system32\\\\mobsync.exe\",\n          \"?:\\\\Windows\\\\SysWOW64\\\\mobsync.exe\"\n        )\n      ) or\n    \n      /* Discord App */\n      (process.name : \"Discord.exe\" and (process.code_signature.subject_name : \"Discord Inc.\" and\n       process.code_signature.trusted == true) and dns.question.name : (\"discord.com\", \"cdn.discordapp.com\", \"discordapp.com\")\n      ) or \n\n      /* MS Sharepoint */\n      (process.name : \"Microsoft.SharePoint.exe\" and (process.code_signature.subject_name : \"Microsoft Corporation\" and\n       process.code_signature.trusted == true) and dns.question.name : \"onedrive.live.com\"\n      ) or \n\n      /* Firefox */\n      (process.name : \"firefox.exe\" and (process.code_signature.subject_name : \"Mozilla Corporation\" and\n       process.code_signature.trusted == true)\n      ) or \n\n      /* Dropbox */\n      (process.name : \"Dropbox.exe\" and (process.code_signature.subject_name : \"Dropbox, Inc\" and\n       process.code_signature.trusted == true) and dns.question.name : (\"api.dropboxapi.com\", \"*.dropboxusercontent.com\")\n      ) or \n\n      /* Obsidian - Plugins are stored on raw.githubusercontent.com */\n      (process.name : \"Obsidian.exe\" and (process.code_signature.subject_name : \"Dynalist Inc\" and\n       process.code_signature.trusted == true) and dns.question.name : \"raw.githubusercontent.com\"\n      ) or \n\n      /* WebExperienceHostApp */\n      (process.name : \"WebExperienceHostApp.exe\" and (process.code_signature.subject_name : \"Microsoft Windows\" and\n       process.code_signature.trusted == true) and dns.question.name : (\"onedrive.live.com\", \"skyapi.onedrive.live.com\")\n      ) or\n\n      (process.code_signature.subject_name : \"Microsoft *\" and process.code_signature.trusted == true and\n       dns.question.name : (\"*.sharepoint.com\", \"graph.microsoft.com\", \"g.live.com\", \"login.live.com\", \"login.live.com\")) or\n\n      (process.code_signature.trusted == true and\n       process.code_signature.subject_name :\n                             (\"Johannes Schindelin\",\n                              \"Redis Inc.\",\n                              \"Slack Technologies, LLC\",\n                              \"Cisco Systems, Inc.\",\n                              \"Dropbox, Inc\",\n                              \"Amazon.com Services LLC\"))\n    )",
        "language": "eql",
        "index": [
          "logs-endpoint.events.network-*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious macOS MS Office Child Process",
        "description": "Identifies suspicious child processes of frequently targeted Microsoft Office applications (Word, PowerPoint, and Excel). These child processes are often launched during exploitation of Office applications or by documents with malicious macros.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 207,
        "tags": [
          "Domain: Endpoint",
          "OS: macOS",
          "Use Case: Threat Detection",
          "Tactic: Initial Access",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://blog.malwarebytes.com/cybercrime/2017/02/microsoft-office-macro-malware-targets-macs/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1566",
                "name": "Phishing",
                "reference": "https://attack.mitre.org/techniques/T1566/",
                "subtechnique": [
                  {
                    "id": "T1566.001",
                    "name": "Spearphishing Attachment",
                    "reference": "https://attack.mitre.org/techniques/T1566/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a macOS System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, for MacOS it is recommended to select \"Traditional Endpoints\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.Ext.effective_parent.executable",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "0b4eef5d-bc5c-4a32-bc2b-059e3c02c620",
        "rule_id": "66da12b1-ac83-40eb-814c-07ed1d82b7b9",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:36.792Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:10.179Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where event.action == \"exec\" and host.os.type == \"macos\" and\n    process.parent.name: (\n      \"Microsoft Word\",\n      \"Microsoft Outlook\",\n      \"Microsoft Excel\",\n      \"Microsoft PowerPoint\",\n      \"Microsoft OneNote\"\n    ) and\n  process.name : (\n    \"curl\",\n    \"nscurl\",\n    \"bash\",\n    \"sh\",\n    \"osascript\",\n    \"python*\",\n    \"perl*\",\n    \"mktemp\",\n    \"chmod\",\n    \"php\",\n    \"nohup\",\n    \"openssl\",\n    \"plutil\",\n    \"PlistBuddy\",\n    \"xattr\",\n    \"mktemp\",\n    \"sqlite3\",\n    \"funzip\",\n    \"popen\"\n  ) and\n\n  // Filter FPs related to product version discovery and Office error reporting behavior\n  not process.args:\n    (\n      \"ProductVersion\",\n      \"hw.model\",\n      \"ioreg\",\n      \"ProductName\",\n      \"ProductUserVisibleVersion\",\n      \"ProductBuildVersion\",\n      \"/Library/Application Support/Microsoft/MERP*/Microsoft Error Reporting.app/Contents/MacOS/Microsoft Error Reporting\",\n      \"open -a Safari *\",\n      \"defaults read *\",\n      \"sysctl hw.model*\",\n      \"ioreg -d2 -c IOPlatformExpertDevice *\",\n      \"ps aux | grep 'ToDesk_Desktop' | grep -v grep\",\n      \"PIPE=\\\"$CFFIXED_USER_HOME/.zoteroIntegrationPipe*\"\n    ) and\n\n   not process.parent.executable :\n        (\n          \"/Applications/ToDesk.app/Contents/MacOS/ToDesk_Service\",\n          \"/usr/local/Privacy-i/PISupervisor\",\n          \"/Library/Addigy/lan-cache\",\n          \"/Library/Elastic/Agent/*\",\n          \"/opt/jc/bin/jumpcloud-agent\",\n          \"/usr/sbin/networksetup\"\n        ) and\n   not (process.name : \"sh\" and process.command_line : \"*$CFFIXED_USER_HOME/.zoteroIntegrationPipe*\") and\n\n   not process.Ext.effective_parent.executable : (\n        \"/Applications/ToDesk.app/Contents/MacOS/ToDesk_Service\",\n        \"/usr/local/Privacy-i/PISupervisor\",\n        \"/Library/Addigy/auditor\",\n        \"/Library/Elastic/Agent/*\",\n        \"/opt/jc/bin/jumpcloud-agent\",\n        \"/usr/sbin/networksetup\"\n      )",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Modification of the msPKIAccountCredentials",
        "description": "Identify the modification of the msPKIAccountCredentials attribute in an Active Directory User Object. Attackers can abuse the credentials roaming feature to overwrite an arbitrary file for privilege escalation. ms-PKI-AccountCredentials contains binary large objects (BLOBs) of encrypted credential objects from the credential manager store, private keys, certificates, and certificate requests.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 113,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Data Source: Active Directory",
          "Tactic: Privilege Escalation",
          "Use Case: Active Directory Monitoring",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.mandiant.com/resources/blog/apt29-windows-credential-roaming",
          "https://social.technet.microsoft.com/wiki/contents/articles/11483.windows-credential-roaming.aspx",
          "https://learn.microsoft.com/en-us/windows/security/threat-protection/auditing/event-5136"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1068",
                "name": "Exploitation for Privilege Escalation",
                "reference": "https://attack.mitre.org/techniques/T1068/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'Audit Directory Service Changes' logging policy must be configured for (Success, Failure).\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nPolicies >\nWindows Settings >\nSecurity Settings >\nAdvanced Audit Policies Configuration >\nAudit Policies >\nDS Access >\nAudit Directory Service Changes (Success,Failure)\n```\n",
        "related_integrations": [
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.code",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.event_data.AttributeLDAPDisplayName",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "winlog.event_data.OperationType",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "winlog.event_data.SubjectUserSid",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "e799b732-a358-4e95-9c2b-ce894c6473b0",
        "rule_id": "670b3b5a-35e5-42db-bd36-6c5b9b4b7313",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:36.794Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:05.970Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-system.*",
          "logs-windows.*"
        ],
        "filters": [],
        "query": "event.action:(\"Directory Service Changes\" or \"directory-service-object-modified\") and event.code:\"5136\" and\n  winlog.event_data.AttributeLDAPDisplayName:\"msPKIAccountCredentials\" and winlog.event_data.OperationType:\"%%14674\" and\n  not winlog.event_data.SubjectUserSid : \"S-1-5-18\"",
        "language": "kuery"
      },
      {
        "name": "O365 Mailbox Audit Logging Bypass",
        "description": "Detects the occurrence of mailbox audit bypass associations. The mailbox audit is responsible for logging specified mailbox events (like accessing a folder or a message or permanently deleting a message). However, actions taken by some authorized accounts, such as accounts used by third-party tools or accounts used for lawful monitoring, can create a large number of mailbox audit log entries and may not be of interest to your organization. Because of this, administrators can create bypass associations, allowing certain accounts to perform their tasks without being logged. Attackers can abuse this allowlist mechanism to conceal actions taken, as the mailbox audit will log no activity done by the account.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Cloud",
          "Data Source: Microsoft 365",
          "Tactic: Initial Access",
          "Tactic: Defense Evasion"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-1800s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Legitimate allowlisting of noisy accounts"
        ],
        "references": [
          "https://twitter.com/misconfig/status/1476144066807140355"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.001",
                    "name": "Disable or Modify Tools",
                    "reference": "https://attack.mitre.org/techniques/T1562/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The Office 365 Logs Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "o365",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "e692976b-6dc4-42b8-9776-d3607b6695df",
        "rule_id": "675239ea-c1bc-4467-a6d3-b9e2cc7f676d",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:36.795Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:10.191Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-o365*"
        ],
        "filters": [],
        "query": "event.dataset:o365.audit and event.provider:Exchange and event.action:Set-MailboxAuditBypassAssociation and event.outcome:success",
        "language": "kuery"
      },
      {
        "name": "Image File Execution Options Injection",
        "description": "The Debugger and SilentProcessExit registry keys can allow an adversary to intercept the execution of files, causing a different process to be executed. This functionality can be abused by an adversary to establish persistence.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 309,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: SentinelOne"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://oddvar.moe/2018/04/10/persistence-using-globalflags-in-image-file-execution-options-hidden-from-autoruns-exe/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1546",
                "name": "Event Triggered Execution",
                "reference": "https://attack.mitre.org/techniques/T1546/",
                "subtechnique": [
                  {
                    "id": "T1546.012",
                    "name": "Image File Execution Options Injection",
                    "reference": "https://attack.mitre.org/techniques/T1546/012/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1112",
                "name": "Modify Registry",
                "reference": "https://attack.mitre.org/techniques/T1112/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.data.strings",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "registry.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.value",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "11672fc7-f6a4-4f63-887a-3d93ed6e58f1",
        "rule_id": "6839c821-011d-43bd-bd5b-acff00257226",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:36.797Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:10.195Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n  registry.value : (\"Debugger\", \"MonitorProcess\") and length(registry.data.strings) > 0 and\n  registry.path : (\n    \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Image File Execution Options\\\\*.exe\\\\Debugger\",\n    \"HKLM\\\\SOFTWARE\\\\WOW6432Node\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Image File Execution Options\\\\*\\\\Debugger\",\n    \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\SilentProcessExit\\\\*\\\\MonitorProcess\",\n    \"HKLM\\\\SOFTWARE\\\\WOW6432Node\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\SilentProcessExit\\\\*\\\\MonitorProcess\",\n    \"\\\\REGISTRY\\\\MACHINE\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Image File Execution Options\\\\*.exe\\\\Debugger\",\n    \"\\\\REGISTRY\\\\MACHINE\\\\SOFTWARE\\\\WOW6432Node\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Image File Execution Options\\\\*\\\\Debugger\",\n    \"\\\\REGISTRY\\\\MACHINE\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\SilentProcessExit\\\\*\\\\MonitorProcess\",\n    \"\\\\REGISTRY\\\\MACHINE\\\\SOFTWARE\\\\WOW6432Node\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\SilentProcessExit\\\\*\\\\MonitorProcess\",\n    \"MACHINE\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Image File Execution Options\\\\*.exe\\\\Debugger\",\n    \"MACHINE\\\\SOFTWARE\\\\WOW6432Node\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Image File Execution Options\\\\*\\\\Debugger\",\n    \"MACHINE\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\SilentProcessExit\\\\*\\\\MonitorProcess\",\n    \"MACHINE\\\\SOFTWARE\\\\WOW6432Node\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\SilentProcessExit\\\\*\\\\MonitorProcess\"\n  ) and\n    /* add FPs here */\n  not registry.data.strings regex~ (\"\"\"C:\\\\Program Files( \\(x86\\))?\\\\ThinKiosk\\\\thinkiosk\\.exe\"\"\", \"\"\".*\\\\PSAppDeployToolkit\\\\.*\"\"\")",
        "language": "eql",
        "index": [
          "logs-endpoint.events.registry-*",
          "endgame-*",
          "logs-windows.sysmon_operational-*",
          "winlogbeat-*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*"
        ],
        "filters": []
      },
      {
        "name": "New or Modified Federation Domain",
        "description": "Identifies a new or modified federation domain, which can be used to create a trust between O365 and an external identity provider.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 207,
        "tags": [
          "Domain: Cloud",
          "Data Source: Microsoft 365",
          "Use Case: Identity and Access Audit",
          "Tactic: Privilege Escalation"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Austin Songer"
        ],
        "false_positives": [],
        "references": [
          "https://docs.microsoft.com/en-us/powershell/module/exchange/remove-accepteddomain?view=exchange-ps",
          "https://docs.microsoft.com/en-us/powershell/module/exchange/remove-federateddomain?view=exchange-ps",
          "https://docs.microsoft.com/en-us/powershell/module/exchange/new-accepteddomain?view=exchange-ps",
          "https://docs.microsoft.com/en-us/powershell/module/exchange/add-federateddomain?view=exchange-ps",
          "https://docs.microsoft.com/en-us/powershell/module/exchange/set-accepteddomain?view=exchange-ps",
          "https://docs.microsoft.com/en-us/powershell/module/msonline/set-msoldomainfederationsettings?view=azureadps-1.0"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1484",
                "name": "Domain or Tenant Policy Modification",
                "reference": "https://attack.mitre.org/techniques/T1484/",
                "subtechnique": [
                  {
                    "id": "T1484.002",
                    "name": "Trust Modification",
                    "reference": "https://attack.mitre.org/techniques/T1484/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The Office 365 Logs Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "o365",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "5b45dfd8-29b3-442b-b629-1b0f1d798ae6",
        "rule_id": "684554fc-0777-47ce-8c9b-3d01f198d7f8",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:36.799Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:10.198Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-o365*"
        ],
        "filters": [],
        "query": "event.dataset:o365.audit and event.provider:Exchange and event.category:web and event.action:(\"Set-AcceptedDomain\" or\n\"Set-MsolDomainFederationSettings\" or \"Add-FederatedDomain\" or \"New-AcceptedDomain\" or \"Remove-AcceptedDomain\" or \"Remove-FederatedDomain\") and\nevent.outcome:success",
        "language": "kuery"
      },
      {
        "name": "Okta ThreatInsight Threat Suspected Promotion",
        "description": "Okta ThreatInsight is a feature that provides valuable debug data regarding authentication and authorization processes, which is logged in the system. Within this data, there is a specific field called threat_suspected, which represents Okta's internal evaluation of the authentication or authorization workflow. When this field is set to True, it suggests the presence of potential credential access techniques, such as password-spraying, brute-forcing, replay attacks, and other similar threats.",
        "risk_score": 47,
        "severity": "medium",
        "rule_name_override": "okta.display_message",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\nThis is a promotion rule for Okta ThreatInsight suspected threat events, which are alertable events per the vendor.\nConsult vendor documentation on interpreting specific events.",
        "output_index": "",
        "version": 409,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Data Source: Okta"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [
          {
            "field": "okta.debug_context.debug_data.risk_level",
            "operator": "equals",
            "severity": "low",
            "value": "LOW"
          },
          {
            "field": "okta.debug_context.debug_data.risk_level",
            "operator": "equals",
            "severity": "medium",
            "value": "MEDIUM"
          },
          {
            "field": "okta.debug_context.debug_data.risk_level",
            "operator": "equals",
            "severity": "high",
            "value": "HIGH"
          }
        ],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://help.okta.com/en-us/Content/Topics/Security/threat-insight/configure-threatinsight-system-log.html",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [],
        "setup": "",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "okta.debug_context.debug_data.threat_suspected",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "285f44c8-e9fd-4c44-8403-d8903f72d9ae",
        "rule_id": "6885d2ae-e008-4762-b98a-e8e1cd3a81e9",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:36.801Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:10.202Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset:okta.system and (event.action:security.threat.detected or okta.debug_context.debug_data.threat_suspected: true)",
        "language": "kuery"
      },
      {
        "name": "Persistence via TelemetryController Scheduled Task Hijack",
        "description": "Detects the successful hijack of Microsoft Compatibility Appraiser scheduled task to establish persistence with an integrity level of system.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 312,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Tactic: Privilege Escalation",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.trustedsec.com/blog/abusing-windows-telemetry-for-persistence"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1053",
                "name": "Scheduled Task/Job",
                "reference": "https://attack.mitre.org/techniques/T1053/",
                "subtechnique": [
                  {
                    "id": "T1053.005",
                    "name": "Scheduled Task",
                    "reference": "https://attack.mitre.org/techniques/T1053/005/"
                  }
                ]
              },
              {
                "id": "T1574",
                "name": "Hijack Execution Flow",
                "reference": "https://attack.mitre.org/techniques/T1574/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1053",
                "name": "Scheduled Task/Job",
                "reference": "https://attack.mitre.org/techniques/T1053/",
                "subtechnique": [
                  {
                    "id": "T1053.005",
                    "name": "Scheduled Task",
                    "reference": "https://attack.mitre.org/techniques/T1053/005/"
                  }
                ]
              },
              {
                "id": "T1574",
                "name": "Hijack Execution Flow",
                "reference": "https://attack.mitre.org/techniques/T1574/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "3b5a86bc-7e2a-4ea2-aab9-78dade5c636e",
        "rule_id": "68921d85-d0dc-48b3-865f-43291ca2c4f2",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:36.802Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:10.205Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.parent.name : \"CompatTelRunner.exe\" and process.args : \"-cv*\" and\n  not process.name : (\"conhost.exe\",\n                      \"DeviceCensus.exe\",\n                      \"CompatTelRunner.exe\",\n                      \"DismHost.exe\",\n                      \"rundll32.exe\",\n                      \"powershell.exe\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "AWS CloudWatch Log Group Deletion",
        "description": "Identifies the deletion of a specified AWS CloudWatch log group. When a log group is deleted, all the archived log events associated with the log group are also permanently deleted.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating AWS CloudWatch Log Group Deletion\n\nAmazon CloudWatch is a monitoring and observability service that collects monitoring and operational data in the form of logs, metrics, and events for resources and applications. This data can be used to detect anomalous behavior in your environments, set alarms, visualize logs and metrics side by side, take automated actions, troubleshoot issues, and discover insights to keep your applications running smoothly.\n\nA log group is a group of log streams that share the same retention, monitoring, and access control settings. You can define log groups and specify which streams to put into each group. There is no limit on the number of log streams that can belong to one log group.\n\nThis rule looks for the deletion of a log group using the API `DeleteLogGroup` action. Attackers can do this to cover their tracks and impact security monitoring that relies on these sources.\n\n#### Possible investigation steps\n\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Investigate other alerts associated with the user account during the past 48 hours.\n- Contact the account and resource owners and confirm whether they are aware of this activity.\n- Check if this operation was approved and performed according to the organization's change management policy.\n- Considering the source IP address and geolocation of the user who issued the command:\n    - Do they look normal for the user?\n    - If the source is an EC2 IP address, is it associated with an EC2 instance in one of your accounts or is the source IP from an EC2 instance that's not under your control?\n    - If it is an authorized EC2 instance, is the activity associated with normal behavior for the instance role or roles? Are there any other alerts or signs of suspicious activity involving this instance?\n- Investigate the deleted log group's criticality and whether the responsible team is aware of the deletion.\n- If you suspect the account has been compromised, scope potentially compromised assets by tracking servers, services, and data accessed by the account in the last 24 hours.\n\n### False positive analysis\n\n- If this rule is noisy in your environment due to expected activity, consider adding exceptions â€” preferably with a combination of user and IP address conditions.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Disable or limit the account during the investigation and response.\n- Identify the possible impact of the incident and prioritize accordingly; the following actions can help you gain context:\n    - Identify the account role in the cloud environment.\n    - Assess the criticality of affected services and servers.\n    - Work with your IT team to identify and minimize the impact on users.\n    - Identify if the attacker is moving laterally and compromising other accounts, servers, or services.\n    - Identify any regulatory or legal ramifications related to this activity.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords or delete API keys as needed to revoke the attacker's access to the environment. Work with your IT teams to minimize the impact on business operations during these actions.\n- Check if unauthorized new users were created, remove unauthorized new accounts, and request password resets for other IAM users.\n- Consider enabling multi-factor authentication for users.\n- Review the permissions assigned to the implicated user to ensure that the least privilege principle is being followed.\n- Implement security best practices [outlined](https://aws.amazon.com/premiumsupport/knowledge-center/security-best-practices/) by AWS.\n- Take the actions needed to return affected systems, data, or services to their normal operational levels.\n- Identify the initial vector abused by the attacker and take action to prevent reinfection via the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).",
        "output_index": "",
        "version": 209,
        "tags": [
          "Domain: Cloud",
          "Data Source: AWS",
          "Data Source: Amazon Web Services",
          "Data Source: AWS CloudWatch",
          "Use Case: Log Auditing",
          "Resources: Investigation Guide",
          "Tactic: Impact"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-3600s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. Log group deletions by unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule."
        ],
        "references": [
          "https://awscli.amazonaws.com/v2/documentation/api/latest/reference/logs/delete-log-group.html",
          "https://docs.aws.amazon.com/AmazonCloudWatchLogs/latest/APIReference/API_DeleteLogGroup.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0040",
              "name": "Impact",
              "reference": "https://attack.mitre.org/tactics/TA0040/"
            },
            "technique": [
              {
                "id": "T1485",
                "name": "Data Destruction",
                "reference": "https://attack.mitre.org/techniques/T1485/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.001",
                    "name": "Disable or Modify Tools",
                    "reference": "https://attack.mitre.org/techniques/T1562/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The AWS Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "aws",
            "version": "^2.0.0",
            "integration": "cloudtrail"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "8f5fd947-55c3-4fee-bbde-ee1d75ca481a",
        "rule_id": "68a7a5a5-a2fc-4a76-ba9f-26849de881b4",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:36.806Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:10.211Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-aws.cloudtrail-*"
        ],
        "filters": [],
        "query": "event.dataset:aws.cloudtrail and event.provider:logs.amazonaws.com and event.action:DeleteLogGroup and event.outcome:success",
        "language": "kuery"
      },
      {
        "name": "Scheduled Task Created by a Windows Script",
        "description": "A scheduled task was created by a Windows script via cscript.exe, wscript.exe or powershell.exe. This can be abused by an adversary to establish persistence.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\nDecode the base64 encoded Tasks Actions registry value to investigate the task's configured action.",
        "output_index": "",
        "version": 208,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Tactic: Execution",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Legitimate scheduled tasks may be created during installation of new software."
        ],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1053",
                "name": "Scheduled Task/Job",
                "reference": "https://attack.mitre.org/techniques/T1053/",
                "subtechnique": [
                  {
                    "id": "T1053.005",
                    "name": "Scheduled Task",
                    "reference": "https://attack.mitre.org/techniques/T1053/005/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  },
                  {
                    "id": "T1059.005",
                    "name": "Visual Basic",
                    "reference": "https://attack.mitre.org/techniques/T1059/005/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "dll.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.value",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "8167da14-17eb-42eb-858d-2fdcba1790ff",
        "rule_id": "689b9d57-e4d5-4357-ad17-9c334609d79a",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:36.804Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:10.208Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by host.id with maxspan = 30s\n  [any where host.os.type == \"windows\" and \n    (event.category : (\"library\", \"driver\") or (event.category == \"process\" and event.action : \"Image loaded*\")) and\n    (?dll.name : \"taskschd.dll\" or file.name : \"taskschd.dll\") and\n    process.name : (\"cscript.exe\", \"wscript.exe\", \"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\")]\n  [registry where host.os.type == \"windows\" and event.type == \"change\" and registry.value : \"Actions\" and\n    registry.path : (\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Schedule\\\\TaskCache\\\\Tasks\\\\*\\\\Actions\",\n      \"\\\\REGISTRY\\\\MACHINE\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Schedule\\\\TaskCache\\\\Tasks\\\\*\\\\Actions\"\n  )]",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.registry-*",
          "logs-endpoint.events.library-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "UAC Bypass via ICMLuaUtil Elevated COM Interface",
        "description": "Identifies User Account Control (UAC) bypass attempts via the ICMLuaUtil Elevated COM interface. Attackers may attempt to bypass UAC to stealthily execute code with elevated permissions.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 210,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Tactic: Defense Evasion",
          "Tactic: Execution",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: Microsoft Defender for Endpoint"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1548",
                "name": "Abuse Elevation Control Mechanism",
                "reference": "https://attack.mitre.org/techniques/T1548/",
                "subtechnique": [
                  {
                    "id": "T1548.002",
                    "name": "Bypass User Account Control",
                    "reference": "https://attack.mitre.org/techniques/T1548/002/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1548",
                "name": "Abuse Elevation Control Mechanism",
                "reference": "https://attack.mitre.org/techniques/T1548/",
                "subtechnique": [
                  {
                    "id": "T1548.002",
                    "name": "Bypass User Account Control",
                    "reference": "https://attack.mitre.org/techniques/T1548/002/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1559",
                "name": "Inter-Process Communication",
                "reference": "https://attack.mitre.org/techniques/T1559/",
                "subtechnique": [
                  {
                    "id": "T1559.001",
                    "name": "Component Object Model",
                    "reference": "https://attack.mitre.org/techniques/T1559/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "38600159-ecd8-4c10-87ba-6d8f06dd03f5",
        "rule_id": "68d56fdc-7ffa-4419-8e95-81641bd6f845",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:36.808Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:10.215Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n process.parent.name == \"dllhost.exe\" and\n process.parent.args in (\"/Processid:{3E5FC7F9-9A51-4367-9063-A120244FBEC7}\", \"/Processid:{D2E7041B-2927-42FB-8E9F-7CE93B6DC937}\") and\n process.pe.original_file_name != \"WerFault.exe\"",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-m365_defender.event-*"
        ],
        "filters": []
      },
      {
        "name": "AWS KMS Customer Managed Key Disabled or Scheduled for Deletion",
        "description": "Identifies attempts to disable or schedule the deletion of an AWS KMS Customer Managed Key (CMK). Deleting an AWS KMS key is destructive and potentially dangerous. It deletes the key material and all metadata associated with the KMS key and is irreversible. After a KMS key is deleted, the data that was encrypted under that KMS key can no longer be decrypted, which means that data becomes unrecoverable.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 106,
        "tags": [
          "Domain: Cloud",
          "Data Source: AWS",
          "Data Source: Amazon Web Services",
          "Data Source: AWS KMS",
          "Use Case: Log Auditing",
          "Tactic: Impact"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-3600s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Xavier Pich"
        ],
        "false_positives": [
          "A KMS customer managed key may be disabled or scheduled for deletion by a system administrator. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. Key deletions by unfamiliar users should be investigated. If known behavior is causing false positives, it can be exempted from the rule."
        ],
        "references": [
          "https://docs.aws.amazon.com/cli/latest/reference/kms/disable-key.html",
          "https://docs.aws.amazon.com/cli/latest/reference/kms/schedule-key-deletion.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0040",
              "name": "Impact",
              "reference": "https://attack.mitre.org/tactics/TA0040/"
            },
            "technique": [
              {
                "id": "T1485",
                "name": "Data Destruction",
                "reference": "https://attack.mitre.org/techniques/T1485/"
              }
            ]
          }
        ],
        "setup": "The AWS Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "aws",
            "version": "^2.0.0",
            "integration": "cloudtrail"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "923c804f-d535-4f83-beff-3a542f8a2220",
        "rule_id": "6951f15e-533c-4a60-8014-a3c3ab851a1b",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:36.820Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:10.218Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-aws.cloudtrail-*"
        ],
        "filters": [],
        "query": "event.dataset:aws.cloudtrail and event.provider:kms.amazonaws.com and event.action:(\"DisableKey\" or \"ScheduleKeyDeletion\") and event.outcome:success",
        "language": "kuery"
      },
      {
        "name": "Modification of Boot Configuration",
        "description": "Identifies use of bcdedit.exe to delete boot configuration data. This tactic is sometimes used as by malware or an attacker as a destructive technique.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Modification of Boot Configuration\n\nBoot entry parameters, or boot parameters, are optional, system-specific settings that represent configuration options. These are stored in a boot configuration data (BCD) store, and administrators can use utilities like `bcdedit.exe` to configure these.\n\nThis rule identifies the usage of `bcdedit.exe` to:\n\n- Disable Windows Error Recovery (recoveryenabled).\n- Ignore errors if there is a failed boot, failed shutdown, or failed checkpoint (bootstatuspolicy ignoreallfailures).\n\nThese are common steps in destructive attacks by adversaries leveraging ransomware.\n\n#### Possible investigation steps\n\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n- Check if any files on the host machine have been encrypted.\n\n### False positive analysis\n\n- The usage of these options is not inherently malicious. Administrators can modify these configurations to force a machine to boot for troubleshooting or data recovery purposes.\n\n### Related rules\n\n- Deleting Backup Catalogs with Wbadmin - 581add16-df76-42bb-af8e-c979bfb39a59\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Consider isolating the involved host to prevent destructive behavior, which is commonly associated with this activity.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- If any other destructive action was identified on the host, it is recommended to prioritize the investigation and look for ransomware preparation and execution activities.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 311,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Impact",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0040",
              "name": "Impact",
              "reference": "https://attack.mitre.org/tactics/TA0040/"
            },
            "technique": [
              {
                "id": "T1490",
                "name": "Inhibit System Recovery",
                "reference": "https://attack.mitre.org/techniques/T1490/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "891dd643-ddbb-4ef0-b46f-3f3a467d9ac5",
        "rule_id": "69c251fb-a5d6-4035-b5ec-40438bd829ff",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:36.822Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:10.221Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (process.name : \"bcdedit.exe\" or ?process.pe.original_file_name == \"bcdedit.exe\") and\n    (\n      (process.args : \"/set\" and process.args : \"bootstatuspolicy\" and process.args : \"ignoreallfailures\") or\n      (process.args : \"no\" and process.args : \"recoveryenabled\")\n    )",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "AWS IAM Password Recovery Requested",
        "description": "Identifies AWS IAM password recovery requests. An adversary may attempt to gain unauthorized AWS access by abusing password recovery mechanisms.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Cloud",
          "Data Source: AWS",
          "Data Source: Amazon Web Services",
          "Data Source: AWS Signin",
          "Use Case: Identity and Access Audit",
          "Tactic: Initial Access"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-3600s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Verify whether the user identity, user agent, and/or hostname should be requesting changes in your environment. Password reset attempts from unfamiliar users should be investigated. If known behavior is causing false positives, it can be exempted from the rule."
        ],
        "references": [
          "https://www.cadosecurity.com/an-ongoing-aws-phishing-campaign/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1078",
                "name": "Valid Accounts",
                "reference": "https://attack.mitre.org/techniques/T1078/"
              }
            ]
          }
        ],
        "setup": "The AWS Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "aws",
            "version": "^2.0.0",
            "integration": "cloudtrail"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "6df9ba41-349e-420b-bef9-3401cfb03933",
        "rule_id": "69c420e8-6c9e-4d28-86c0-8a2be2d1e78c",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:36.823Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:10.225Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-aws.cloudtrail-*"
        ],
        "filters": [],
        "query": "event.dataset:aws.cloudtrail and event.provider:signin.amazonaws.com and event.action:PasswordRecoveryRequested and event.outcome:success",
        "language": "kuery"
      },
      {
        "name": "Unusual Service Host Child Process - Childless Service",
        "description": "Identifies unusual child processes of Service Host (svchost.exe) that traditionally do not spawn any child processes. This may indicate a code injection or an equivalent form of exploitation.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 310,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Tactic: Privilege Escalation",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: SentinelOne"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Changes to Windows services or a rarely executed child process."
        ],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1055",
                "name": "Process Injection",
                "reference": "https://attack.mitre.org/techniques/T1055/",
                "subtechnique": [
                  {
                    "id": "T1055.012",
                    "name": "Process Hollowing",
                    "reference": "https://attack.mitre.org/techniques/T1055/012/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1055",
                "name": "Process Injection",
                "reference": "https://attack.mitre.org/techniques/T1055/",
                "subtechnique": [
                  {
                    "id": "T1055.012",
                    "name": "Process Hollowing",
                    "reference": "https://attack.mitre.org/techniques/T1055/012/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "bbce6b1c-ea18-4934-bd5e-6e20c768dc3a",
        "rule_id": "6a8ab9cc-4023-4d17-b5df-1a3e16882ce7",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:36.825Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:10.228Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.parent.name : \"svchost.exe\" and\n\n  /* based on svchost service arguments -s svcname where the service is known to be childless */\n  process.parent.args : (\n    \"WdiSystemHost\", \"LicenseManager\", \"StorSvc\", \"CDPSvc\", \"cdbhsvc\", \"BthAvctpSvc\", \"SstpSvc\", \"WdiServiceHost\",\n    \"imgsvc\", \"TrkWks\", \"WpnService\", \"IKEEXT\", \"PolicyAgent\", \"CryptSvc\", \"netprofm\", \"ProfSvc\", \"StateRepository\",\n    \"camsvc\", \"LanmanWorkstation\", \"NlaSvc\", \"EventLog\", \"hidserv\", \"DisplayEnhancementService\", \"ShellHWDetection\",\n    \"AppHostSvc\", \"fhsvc\", \"CscService\", \"PushToInstall\"\n  ) and\n\n  /* unknown FPs can be added here */\n  not process.name : (\"WerFault.exe\", \"WerFaultSecure.exe\", \"wermgr.exe\") and\n  not (process.executable : \"?:\\\\Windows\\\\System32\\\\RelPost.exe\" and process.parent.args : \"WdiSystemHost\") and\n  not (\n    process.name : \"rundll32.exe\" and\n    process.args : \"?:\\\\WINDOWS\\\\System32\\\\winethc.dll,ForceProxyDetectionOnNextRun\" and\n    process.parent.args : \"WdiServiceHost\"\n  ) and\n  not (\n    process.executable : (\n      \"?:\\\\Program Files\\\\*\",\n      \"?:\\\\Program Files (x86)\\\\*\",\n      \"?:\\\\Windows\\\\System32\\\\Kodak\\\\kds_?????\\\\lib\\\\lexexe.exe\"\n    ) and process.parent.args : \"imgsvc\"\n  )",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "winlogbeat-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*"
        ],
        "filters": []
      },
      {
        "name": "Exporting Exchange Mailbox via PowerShell",
        "description": "Identifies the use of the Exchange PowerShell cmdlet, New-MailBoxExportRequest, to export the contents of a primary mailbox or archive to a .pst file. Adversaries may target user email to collect sensitive information.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Exporting Exchange Mailbox via PowerShell\n\nEmail mailboxes and their information can be valuable assets for attackers. Company mailboxes often contain sensitive information such as login credentials, intellectual property, financial data, and personal information, making them high-value targets for malicious actors.\n\nThe `New-MailBoxExportRequest` cmdlet is used to begin the process of exporting contents of a primary mailbox or archive to a .pst file. Note that this is done on a per-mailbox basis and this cmdlet is available only in on-premises Exchange.\n\nAttackers can abuse this functionality in preparation for exfiltrating contents, which is likely to contain sensitive and strategic data.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate the export operation:\n  - Identify the user account that performed the action and whether it should perform this kind of action.\n  - Contact the account owner and confirm whether they are aware of this activity.\n  - Check if this operation was approved and performed according to the organization's change management policy.\n  - Retrieve the operation status and use the `Get-MailboxExportRequest` cmdlet to review previous requests.\n  - By default, no group in Exchange has the privilege to import or export mailboxes. Investigate administrators that assigned the \"Mailbox Import Export\" privilege for abnormal activity.\n- Investigate if there is a significant quantity of export requests in the alert timeframe. This operation is done on a per-mailbox basis and can be part of a mass export.\n- If the operation was completed successfully:\n  - Check if the file is on the path specified in the command.\n  - Investigate if the file was compressed, archived, or retrieved by the attacker for exfiltration.\n\n### False positive analysis\n\n- This mechanism can be used legitimately. Analysts can dismiss the alert if the administrator is aware of the activity and it is done with proper approval.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- If the involved host is not the Exchange server, isolate the host to prevent further post-compromise behavior.\n- Use the `Remove-MailboxExportRequest` cmdlet to remove fully or partially completed export requests.\n- Prioritize cases that involve personally identifiable information (PII) or other classified data.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Review the privileges of users with the \"Mailbox Import Export\" privilege to ensure that the least privilege principle is being followed.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 417,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Collection",
          "Tactic: Execution",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: SentinelOne",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: System",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Legitimate exchange system administration activity."
        ],
        "references": [
          "https://www.volexity.com/blog/2020/12/14/dark-halo-leverages-solarwinds-compromise-to-breach-organizations/",
          "https://docs.microsoft.com/en-us/powershell/module/exchange/new-mailboxexportrequest?view=exchange-ps",
          "https://www.elastic.co/security-labs/siestagraph-new-implant-uncovered-in-asean-member-foreign-ministry"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0009",
              "name": "Collection",
              "reference": "https://attack.mitre.org/tactics/TA0009/"
            },
            "technique": [
              {
                "id": "T1005",
                "name": "Data from Local System",
                "reference": "https://attack.mitre.org/techniques/T1005/"
              },
              {
                "id": "T1114",
                "name": "Email Collection",
                "reference": "https://attack.mitre.org/techniques/T1114/",
                "subtechnique": [
                  {
                    "id": "T1114.002",
                    "name": "Remote Email Collection",
                    "reference": "https://attack.mitre.org/techniques/T1114/002/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "1e215f49-c4f2-4bc4-9e2f-dcf751e4fbc3",
        "rule_id": "6aace640-e631-4870-ba8e-5fdda09325db",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:36.827Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:10.231Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.name: (\"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\") and\n  process.command_line : (\"*MailboxExportRequest*\", \"*-Mailbox*-ContentFilter*\")",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "winlogbeat-*",
          "logs-windows.*",
          "endgame-*",
          "logs-system.security*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-m365_defender.event-*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Remote Computer Account DnsHostName Update",
        "description": "Identifies the remote update to a computer account's DnsHostName attribute. If the new value set is a valid domain controller DNS hostname and the subject computer name is not a domain controller, then it's highly likely a preparation step to exploit CVE-2022-26923 in an attempt to elevate privileges from a standard domain user to domain admin privileges.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 208,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Use Case: Active Directory Monitoring",
          "Data Source: Active Directory",
          "Use Case: Vulnerability",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://research.ifcr.dk/certifried-active-directory-domain-privilege-escalation-cve-2022-26923-9e098fe298f4",
          "https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2022-26923"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1068",
                "name": "Exploitation for Privilege Escalation",
                "reference": "https://attack.mitre.org/techniques/T1068/"
              },
              {
                "id": "T1078",
                "name": "Valid Accounts",
                "reference": "https://attack.mitre.org/techniques/T1078/",
                "subtechnique": [
                  {
                    "id": "T1078.002",
                    "name": "Domain Accounts",
                    "reference": "https://attack.mitre.org/techniques/T1078/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.event_data.DnsHostName",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "winlog.event_data.TargetUserName",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "c87d62bc-f0d0-45e9-b856-50c5d3281c54",
        "rule_id": "6bed021a-0afb-461c-acbe-ffdb9574d3f3",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:37.000Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:05.987Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "iam where event.action == \"changed-computer-account\" and user.id : (\"S-1-5-21-*\", \"S-1-12-1-*\") and\n\n    /* if DnsHostName value equal a DC DNS hostname then it's highly suspicious */\n    winlog.event_data.DnsHostName : \"??*\" and\n\n    /* exclude FPs where DnsHostName starts with the ComputerName that was changed */\n    not startswith~(winlog.event_data.DnsHostName, substring(winlog.event_data.TargetUserName, 0, length(winlog.event_data.TargetUserName) - 1))",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-system.*",
          "logs-windows.*"
        ],
        "filters": []
      },
      {
        "name": "Microsoft Exchange Server UM Writing Suspicious Files",
        "description": "Identifies suspicious files being written by the Microsoft Exchange Server Unified Messaging (UM) service. This activity has been observed exploiting CVE-2021-26858.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\nPositive hits can be checked against the established Microsoft [baselines](https://github.com/microsoft/CSS-Exchange/tree/main/Security/Baselines).\n\nMicrosoft highly recommends that the best course of action is patching, but this may not protect already compromised systems\nfrom existing intrusions. Other tools for detecting and mitigating can be found within their Exchange support\n[repository](https://github.com/microsoft/CSS-Exchange/tree/main/Security)\n",
        "output_index": "",
        "version": 308,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Initial Access",
          "Tactic: Lateral Movement",
          "Data Source: Elastic Endgame",
          "Use Case: Vulnerability",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: SentinelOne"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic",
          "Austin Songer"
        ],
        "false_positives": [
          "Files generated during installation will generate a lot of noise, so the rule should only be enabled after the fact.",
          "This rule was tuned using the following baseline: https://raw.githubusercontent.com/microsoft/CSS-Exchange/main/Security/Baselines/baseline_15.2.792.5.csv from Microsoft. Depending on version, consult https://github.com/microsoft/CSS-Exchange/tree/main/Security/Baselines to help determine normalcy."
        ],
        "references": [
          "https://www.microsoft.com/security/blog/2021/03/02/hafnium-targeting-exchange-servers",
          "https://www.volexity.com/blog/2021/03/02/active-exploitation-of-microsoft-exchange-zero-day-vulnerabilities"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1190",
                "name": "Exploit Public-Facing Application",
                "reference": "https://attack.mitre.org/techniques/T1190/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1210",
                "name": "Exploitation of Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1210/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "afebe150-e312-483c-a8f6-5c7f2fee369f",
        "rule_id": "6cd1779c-560f-4b68-a8f1-11009b27fe63",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:37.013Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:10.250Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"windows\" and event.type == \"creation\" and\n  process.name : (\"UMWorkerProcess.exe\", \"umservice.exe\") and\n  file.extension : (\"php\", \"jsp\", \"js\", \"aspx\", \"asmx\", \"asax\", \"cfm\", \"shtml\") and\n  (\n    file.path : \"?:\\\\inetpub\\\\wwwroot\\\\aspnet_client\\\\*\" or\n\n    (file.path : \"?:\\\\*\\\\Microsoft\\\\Exchange Server*\\\\FrontEnd\\\\HttpProxy\\\\owa\\\\auth\\\\*\" and\n       not (file.path : \"?:\\\\*\\\\Microsoft\\\\Exchange Server*\\\\FrontEnd\\\\HttpProxy\\\\owa\\\\auth\\\\version\\\\*\" or\n            file.name : (\"errorFE.aspx\", \"expiredpassword.aspx\", \"frowny.aspx\", \"GetIdToken.htm\", \"logoff.aspx\",\n                        \"logon.aspx\", \"OutlookCN.aspx\", \"RedirSuiteServiceProxy.aspx\", \"signout.aspx\"))) or\n\n    (file.path : \"?:\\\\*\\\\Microsoft\\\\Exchange Server*\\\\FrontEnd\\\\HttpProxy\\\\ecp\\\\auth\\\\*\" and\n       not file.name : \"TimeoutLogoff.aspx\")\n  )",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.file-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*"
        ],
        "filters": []
      },
      {
        "name": "AdminSDHolder Backdoor",
        "description": "Detects modifications in the AdminSDHolder object. Attackers can abuse the SDProp process to implement a persistent backdoor in Active Directory. SDProp compares the permissions on protected objects with those defined on the AdminSDHolder object. If the permissions on any of the protected accounts and groups do not match, the permissions on the protected accounts and groups are reset to match those of the domain's AdminSDHolder object, regaining their Administrative Privileges.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 210,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Use Case: Active Directory Monitoring",
          "Data Source: Active Directory",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://adsecurity.org/?p=1906",
          "https://docs.microsoft.com/en-us/windows-server/identity/ad-ds/plan/security-best-practices/appendix-c--protected-accounts-and-groups-in-active-directory#adminsdholder"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1078",
                "name": "Valid Accounts",
                "reference": "https://attack.mitre.org/techniques/T1078/",
                "subtechnique": [
                  {
                    "id": "T1078.002",
                    "name": "Domain Accounts",
                    "reference": "https://attack.mitre.org/techniques/T1078/002/"
                  }
                ]
              },
              {
                "id": "T1098",
                "name": "Account Manipulation",
                "reference": "https://attack.mitre.org/techniques/T1098/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.code",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.event_data.ObjectDN",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "ac517b48-0f5e-427a-9a2f-dfdd7396f8ec",
        "rule_id": "6e9130a5-9be6-48e5-943a-9628bfc74b18",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:37.275Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:05.994Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-system.*",
          "logs-windows.*"
        ],
        "filters": [],
        "query": "event.action:(\"Directory Service Changes\" or \"directory-service-object-modified\") and event.code:5136 and\n  winlog.event_data.ObjectDN:CN=AdminSDHolder,CN=System*",
        "language": "kuery"
      },
      {
        "name": "Anomalous Process For a Windows Population",
        "description": "Searches for rare processes running on multiple hosts in an entire fleet or network. This reduces the detection of false positives since automated maintenance processes usually only run occasionally on a single machine but are common to all or many hosts in a fleet.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n###  Investigating Anomalous Process For a Windows Population\n\nSearching for abnormal Windows processes is a good methodology to find potentially malicious activity within a network. Understanding what is commonly run within an environment and developing baselines for legitimate activity can help uncover potential malware and suspicious behaviors.\n\nThis rule uses a machine learning job to detect a Windows process that is rare and unusual for all of the monitored Windows hosts in your environment.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n  - If the parent process is a legitimate system utility or service, this could be related to software updates or system management. If the parent process is something user-facing like an Office application, this process could be more suspicious.\n  - Investigate the process metadata â€” such as the digital signature, directory, etc. â€” to obtain more context that can indicate whether the executable is associated with an expected software vendor or package.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Consider the user as identified by the `user.name` field. Is this program part of an expected workflow for the user who ran this program on this host?\n- Validate the activity is not related to planned patches, updates, network administrator activity, or legitimate software installations.\n- Validate if the activity has a consistent cadence (for example, if it runs monthly or quarterly), as it could be part of a monthly or quarterly business process.\n- Examine the arguments and working directory of the process. These may provide indications as to the source of the program or the nature of the tasks it is performing.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the process executable using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSyste' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Retrieve Service Unisgned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n\n### False Positive Analysis\n\n- If this activity is related to new benign software installation activity, consider adding exceptions â€” preferably with a combination of user and command line conditions.\n- Try to understand the context of the execution by thinking about the user, machine, or business purpose. A small number of endpoints, such as servers with unique software, might appear unusual but satisfy a specific business need.\n\n### Related Rules\n\n- Unusual Process For a Windows Host - 6d448b96-c922-4adb-b51c-b767f1ea5b76\n- Unusual Windows Path Activity - 445a342e-03fb-42d0-8656-0367eb2dead5\n- Unusual Windows Process Calling the Metadata Service - abae61a8-c560-4dbd-acca-1e1438bff36b\n\n### Response and Remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 208,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Rule Type: ML",
          "Rule Type: Machine Learning",
          "Tactic: Persistence",
          "Tactic: Execution"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "15m",
        "from": "now-2700s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "A newly installed program or one that runs rarely as part of a monthly or quarterly workflow could trigger this alert."
        ],
        "references": [
          "https://www.elastic.co/guide/en/security/current/prebuilt-ml-jobs.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1543",
                "name": "Create or Modify System Process",
                "reference": "https://attack.mitre.org/techniques/T1543/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1204",
                "name": "User Execution",
                "reference": "https://attack.mitre.org/techniques/T1204/",
                "subtechnique": [
                  {
                    "id": "T1204.002",
                    "name": "Malicious File",
                    "reference": "https://attack.mitre.org/techniques/T1204/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires the installation of associated Machine Learning jobs, as well as data coming in from one of the following integrations:\n- Elastic Defend\n- Windows\n\n### Anomaly Detection Setup\n\nOnce the rule is enabled, the associated Machine Learning job will start automatically. You can view the Machine Learning job linked under the \"Definition\" panel of the detection rule. If the job does not start due to an error, the issue must be resolved for the job to commence successfully. For more details on setting up anomaly detection jobs, refer to the [helper guide](https://www.elastic.co/guide/en/kibana/current/xpack-ml-anomalies.html).\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration to your system:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n### Windows Integration Setup\nThe Windows integration allows you to monitor the Windows OS, services, applications, and more.\n\n#### The following steps should be executed in order to add the Elastic Agent System integration \"windows\" to your system:\n- Go to the Kibana home page and click â€œAdd integrationsâ€.\n- In the query bar, search for â€œWindowsâ€ and select the integration to see more details about it.\n- Click â€œAdd Windowsâ€.\n- Configure the integration name and optionally add a description.\n- Review optional and advanced settings accordingly.\n- Add the newly installed â€œwindowsâ€ to an existing or a new agent policy, and deploy the agent on your system from which windows log files are desirable.\n- Click â€œSave and Continueâ€.\n- For more details on the integration refer to the [helper guide](https://docs.elastic.co/integrations/windows).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [],
        "id": "ea31b060-0896-401b-84a4-ddba66851e3c",
        "rule_id": "6e40d56f-5c0e-4ac6-aece-bee96645b172",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:37.277Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:06.249Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "machine_learning",
        "anomaly_threshold": 50,
        "machine_learning_job_id": [
          "v3_windows_anomalous_process_all_hosts"
        ]
      },
      {
        "name": "Accepted Default Telnet Port Connection",
        "description": "This rule detects network events that may indicate the use of Telnet traffic. Telnet is commonly used by system administrators to remotely control older or embedded systems using the command line shell. It should almost never be directly exposed to the Internet, as it is frequently targeted and exploited by threat actors as an initial access or backdoor vector. As a plain-text protocol, it may also expose usernames and passwords to anyone capable of observing the traffic.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "timeline_id": "300afc76-072d-4261-864d-4149714bf3f1",
        "timeline_title": "Comprehensive Network Timeline",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 106,
        "tags": [
          "Domain: Endpoint",
          "Use Case: Threat Detection",
          "Tactic: Command and Control",
          "Tactic: Lateral Movement",
          "Tactic: Initial Access",
          "Data Source: PAN-OS"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "IoT (Internet of Things) devices and networks may use telnet and can be excluded if desired. Some business work-flows may use Telnet for administration of older devices. These often have a predictable behavior. Telnet activity involving an unusual source or destination may be more suspicious. Telnet activity involving a production server that has no known associated Telnet work-flow or business requirement is often suspicious."
        ],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            }
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1021",
                "name": "Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1021/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1190",
                "name": "Exploit Public-Facing Application",
                "reference": "https://attack.mitre.org/techniques/T1190/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "network_traffic",
            "version": "^1.1.0"
          },
          {
            "package": "panw",
            "version": "^4.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.port",
            "type": "long",
            "ecs": true
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "dd5effab-8850-4043-862a-b741619d0a2b",
        "rule_id": "34fde489-94b0-4500-a76f-b8a157cf9269",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:37.310Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:09.061Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "packetbeat-*",
          "auditbeat-*",
          "filebeat-*",
          "logs-network_traffic.*",
          "logs-panw.panos*"
        ],
        "filters": [],
        "query": "(event.dataset:network_traffic.flow or event.category:(network or network_traffic))\n    and event.type:connection and not event.action:(\n        flow_dropped or flow_denied or denied or deny or\n        flow_terminated or timeout or Reject or network_flow)\n    and destination.port:23",
        "language": "kuery"
      },
      {
        "name": "ESXI Discovery via Find",
        "description": "Identifies instances where the 'find' command is started on a Linux system with arguments targeting specific VM-related paths, such as \"/etc/vmware/\", \"/usr/lib/vmware/\", or \"/vmfs/*\". These paths are associated with VMware virtualization software, and their presence in the find command arguments may indicate that a threat actor is attempting to search for, analyze, or manipulate VM-related files and configurations on the system.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 7,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame",
          "Data Source: Auditd Manager"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.bleepingcomputer.com/news/security/massive-esxiargs-ransomware-attack-targets-vmware-esxi-servers-worldwide/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1518",
                "name": "Software Discovery",
                "reference": "https://attack.mitre.org/techniques/T1518/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "auditd_manager",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "5db85b02-c739-41e9-b579-37a02f06e817",
        "rule_id": "33a6752b-da5e-45f8-b13a-5f094c09522f",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:37.326Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:09.057Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and\nevent.action in (\"exec\", \"exec_event\", \"executed\", \"process_started\") and process.name == \"find\" and\nprocess.args : (\"/etc/vmware/*\", \"/usr/lib/vmware/*\", \"/vmfs/*\") and \nnot process.parent.executable == \"/usr/lib/vmware/viewagent/bin/uninstall_viewagent.sh\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*",
          "auditbeat-*",
          "logs-auditd_manager.auditd-*"
        ],
        "filters": []
      },
      {
        "name": "AWS IAM User Addition to Group",
        "description": "Identifies the addition of a user to a specified group in AWS Identity and Access Management (IAM).",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating AWS IAM User Addition to Group\n\nAWS Identity and Access Management (IAM) provides fine-grained access control across all of AWS. With IAM, you can specify who can access which services and resources, and under which conditions. With IAM policies, you manage permissions to your workforce and systems to ensure least-privilege permissions.\n\nThis rule looks for the addition of users to a specified user group.\n\n#### Possible investigation steps\n\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Investigate other alerts associated with the user account during the past 48 hours.\n- Contact the account and resource owners and confirm whether they are aware of this activity.\n- Check if this operation was approved and performed according to the organization's change management policy.\n- If you suspect the account has been compromised, scope potentially compromised assets by tracking servers, services, and data accessed by the account in the last 24 hours.\n\n### False positive analysis\n\n- False positives may occur due to the intended usage of the service. Tuning is needed in order to have higher confidence. Consider adding exceptions â€” preferably with a combination of user agent and IP address conditions â€” to reduce noise from onboarding processes and administrator activities.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Disable or limit the account during the investigation and response.\n- Identify the possible impact of the incident and prioritize accordingly; the following actions can help you gain context:\n    - Identify the account role in the cloud environment.\n    - Assess the criticality of affected services and servers.\n    - Work with your IT team to identify and minimize the impact on users.\n    - Identify if the attacker is moving laterally and compromising other accounts, servers, or services.\n    - Identify any regulatory or legal ramifications related to this activity.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords or delete API keys as needed to revoke the attacker's access to the environment. Work with your IT teams to minimize the impact on business operations during these actions.\n- Check if unauthorized new users were created, remove unauthorized new accounts, and request password resets for other IAM users.\n- Consider enabling multi-factor authentication for users.\n- Review the permissions assigned to the implicated user to ensure that the least privilege principle is being followed.\n- Implement security best practices [outlined](https://aws.amazon.com/premiumsupport/knowledge-center/security-best-practices/) by AWS.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection via the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).",
        "output_index": "",
        "version": 209,
        "tags": [
          "Domain: Cloud",
          "Data Source: AWS",
          "Data Source: Amazon Web Services",
          "Use Case: Identity and Access Audit",
          "Tactic: Credential Access",
          "Tactic: Persistence",
          "Resources: Investigation Guide"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-3600s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Adding users to a specified group may be done by a system or network administrator. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. User additions from unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule."
        ],
        "references": [
          "https://docs.aws.amazon.com/IAM/latest/APIReference/API_AddUserToGroup.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            }
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1098",
                "name": "Account Manipulation",
                "reference": "https://attack.mitre.org/techniques/T1098/"
              }
            ]
          }
        ],
        "setup": "The AWS Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "aws",
            "version": "^2.0.0",
            "integration": "cloudtrail"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "3d66c82b-9847-4d7d-9c29-e6fdfbe07dd3",
        "rule_id": "333de828-8190-4cf5-8d7c-7575846f6fe0",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:37.332Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:09.054Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-aws.cloudtrail-*"
        ],
        "filters": [],
        "query": "event.dataset:aws.cloudtrail and event.provider:iam.amazonaws.com and event.action:AddUserToGroup and event.outcome:success",
        "language": "kuery"
      },
      {
        "name": "Remote File Download via PowerShell",
        "description": "Identifies powershell.exe being used to download an executable file from an untrusted remote destination.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Remote File Download via PowerShell\n\nAttackers commonly transfer tooling or malware from external systems into a compromised environment using the command and control channel. However, they can also abuse signed utilities to drop these files.\n\nPowerShell is one of system administrators' main tools for automation, report routines, and other tasks. This makes it available for use in various environments and creates an attractive way for attackers to execute code and perform actions. This rule correlates network and file events to detect downloads of executable and script files performed using PowerShell.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n> This investigation guide uses the [Investigate Markdown Plugin](https://www.elastic.co/guide/en/security/master/interactive-investigation-guides.html) introduced in Elastic Stack version 8.8.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Evaluate whether the user needs to use PowerShell to complete tasks.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n  - !{investigate{\"label\":\"Alerts associated with the user in the last 48h\",\"providers\":[[{\"excluded\":false,\"field\":\"event.kind\",\"queryType\":\"phrase\",\"value\":\"signal\",\"valueType\":\"string\"},{\"excluded\":false,\"field\":\"user.id\",\"queryType\":\"phrase\",\"value\":\"{{user.id}}\",\"valueType\":\"string\"}]],\"relativeFrom\":\"now-48h/h\",\"relativeTo\":\"now\"}}\n  - !{investigate{\"label\":\"Alerts associated with the host in the last 48h\",\"providers\":[[{\"excluded\":false,\"field\":\"event.kind\",\"queryType\":\"phrase\",\"value\":\"signal\",\"valueType\":\"string\"},{\"excluded\":false,\"field\":\"host.name\",\"queryType\":\"phrase\",\"value\":\"{{host.name}}\",\"valueType\":\"string\"}]],\"relativeFrom\":\"now-48h/h\",\"relativeTo\":\"now\"}}\n- Check the reputation of the domain or IP address used to host the downloaded file.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the file using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n        - !{investigate{\"label\":\"Investigate the Subject Process Network Events\",\"providers\":[[{\"excluded\":false,\"field\":\"process.entity_id\",\"queryType\":\"phrase\",\"value\":\"{{process.entity_id}}\",\"valueType\":\"string\"},{\"excluded\":false,\"field\":\"event.category\",\"queryType\":\"phrase\",\"value\":\"network\",\"valueType\":\"string\"}]]}}\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n### False positive analysis\n\n- Administrators can use PowerShell legitimately to download executable and script files. Analysts can dismiss the alert if the Administrator is aware of the activity and the triage has not identified suspicious or malicious files.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 110,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Command and Control",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            },
            "technique": [
              {
                "id": "T1105",
                "name": "Ingress Tool Transfer",
                "reference": "https://attack.mitre.org/techniques/T1105/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "dns.question.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "network.protocol",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "0d52222c-ee3a-40f7-a19c-9dc9beff5543",
        "rule_id": "33f306e8-417c-411b-965c-c2812d6d3f4d",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:37.321Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:05.887Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by process.entity_id with maxspan=30s\n\n[network where host.os.type == \"windows\" and\n  process.name : (\"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\") and network.protocol == \"dns\" and\n   not dns.question.name : (\n          \"localhost\", \"*.microsoft.com\", \"*.azureedge.net\", \"*.powershellgallery.com\",\n          \"*.windowsupdate.com\", \"metadata.google.internal\", \"dist.nuget.org\",\n          \"artifacts.elastic.co\", \"*.digicert.com\", \"packages.chocolatey.org\",\n          \"outlook.office365.com\"\n       ) and not user.id : \"S-1-5-18\"]\n[file where host.os.type == \"windows\" and event.type == \"creation\" and\n  process.name : \"powershell.exe\" and file.extension : (\"exe\", \"dll\", \"ps1\", \"bat\") and\n  not file.name : \"__PSScriptPolicy*.ps1\"]",
        "language": "eql",
        "index": [
          "logs-endpoint.events.network-*",
          "logs-endpoint.events.file-*"
        ],
        "filters": []
      },
      {
        "name": "Execution via Electron Child Process Node.js Module",
        "description": "Identifies attempts to execute a child process from within the context of an Electron application using the child_process Node.js module. Adversaries may abuse this technique to inherit permissions from parent processes.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 106,
        "tags": [
          "Domain: Endpoint",
          "OS: macOS",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Tactic: Execution",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.matthewslipper.com/2019/09/22/everything-you-wanted-electron-child-process.html",
          "https://www.trustedsec.com/blog/macos-injection-via-third-party-frameworks/",
          "https://nodejs.org/api/child_process.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1548",
                "name": "Abuse Elevation Control Mechanism",
                "reference": "https://attack.mitre.org/techniques/T1548/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a macOS System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, for MacOS it is recommended to select \"Traditional Endpoints\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "f576c4ee-5e3e-4ad7-ba03-24e819605c6d",
        "rule_id": "35330ba2-c859-4c98-8b7f-c19159ea0e58",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:37.344Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:09.064Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": [],
        "query": "event.category:process and host.os.type:macos and event.type:(start or process_started) and process.args:(\"-e\" and const*require*child_process*)",
        "language": "kuery"
      },
      {
        "name": "Port Forwarding Rule Addition",
        "description": "Identifies the creation of a new port forwarding rule. An adversary may abuse this technique to bypass network segmentation restrictions.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Port Forwarding Rule Addition\n\nNetwork port forwarding is a mechanism to redirect incoming TCP connections (IPv4 or IPv6) from the local TCP port to any other port number, or even to a port on a remote computer.\n\nAttackers may configure port forwarding rules to bypass network segmentation restrictions, using the host as a jump box to access previously unreachable systems.\n\nThis rule monitors the modifications to the `HKLM\\SYSTEM\\*ControlSet*\\Services\\PortProxy\\v4tov4\\` subkeys.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account and system owners and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n- Identify the target host IP address, check the connections originating from the host where the modification occurred, and inspect the credentials used.\n  - Investigate suspicious login activity, such as unauthorized access and logins from outside working hours and unusual locations.\n\n### False positive analysis\n\n- This mechanism can be used legitimately. Analysts can dismiss the alert if the Administrator is aware of the activity and there are justifications for this configuration.\n- If this rule is noisy in your environment due to expected activity, consider adding exceptions â€” preferably with a combination of user and command line conditions.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Delete the port forwarding rule.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 413,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Command and Control",
          "Tactic: Defense Evasion",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Microsoft Defender for Endpoint"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.fireeye.com/blog/threat-research/2019/01/bypassing-network-restrictions-through-rdp-tunneling.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            },
            "technique": [
              {
                "id": "T1572",
                "name": "Protocol Tunneling",
                "reference": "https://attack.mitre.org/techniques/T1572/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1112",
                "name": "Modify Registry",
                "reference": "https://attack.mitre.org/techniques/T1112/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.path",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "f12dde59-9b8c-45ab-9575-a7c5f02c98c0",
        "rule_id": "3535c8bb-3bd5-40f4-ae32-b7cd589d5372",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:38.309Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:09.067Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "registry where host.os.type == \"windows\" and registry.path : (\n  \"HKLM\\\\SYSTEM\\\\*ControlSet*\\\\Services\\\\PortProxy\\\\v4tov4\\\\*\",\n  \"\\\\REGISTRY\\\\MACHINE\\\\SYSTEM\\\\*ControlSet*\\\\Services\\\\PortProxy\\\\v4tov4\\\\*\",\n  \"MACHINE\\\\SYSTEM\\\\*ControlSet*\\\\Services\\\\PortProxy\\\\v4tov4\\\\*\"\n)",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.registry-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-m365_defender.event-*"
        ],
        "filters": []
      },
      {
        "name": "Finder Sync Plugin Registered and Enabled",
        "description": "Finder Sync plugins enable users to extend Finderâ€™s functionality by modifying the user interface. Adversaries may abuse this feature by adding a rogue Finder Plugin to repeatedly execute malicious payloads for persistence.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Endpoint",
          "OS: macOS",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Trusted Finder Sync Plugins"
        ],
        "references": [
          "https://github.com/specterops/presentations/raw/master/Leo%20Pitt/Hey_Im_Still_in_Here_Modern_macOS_Persistence_SO-CON2020.pdf"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1543",
                "name": "Create or Modify System Process",
                "reference": "https://attack.mitre.org/techniques/T1543/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a macOS System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, for MacOS it is recommended to select \"Traditional Endpoints\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.Ext.effective_parent.executable",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "8fc7d9b8-3b6a-4d37-a235-64eea09624f4",
        "rule_id": "37f638ea-909d-4f94-9248-edd21e4a9906",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:38.311Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:09.091Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"macos\" and event.type in (\"start\", \"process_started\") and process.name : \"pluginkit\" and\n  process.args : \"-e\" and process.args : \"use\" and process.args : \"-i\" and\n  not process.args :\n  (\n    \"com.google.GoogleDrive.FinderSyncAPIExtension\",\n    \"com.google.drivefs.findersync\",\n    \"com.boxcryptor.osx.Rednif\",\n    \"com.adobe.accmac.ACCFinderSync\",\n    \"com.microsoft.OneDrive.FinderSync\",\n    \"com.insynchq.Insync.Insync-Finder-Integration\",\n    \"com.box.desktop.findersyncext\"\n  ) and\n  not process.parent.executable : (\"/Library/Application Support/IDriveforMac/IDriveHelperTools/FinderPluginApp.app/Contents/MacOS/FinderPluginApp\",\n                                   \"/Applications/Google Drive.app/Contents/MacOS/Google Drive\") and\n  not process.Ext.effective_parent.executable : (\"/Applications/Google Drive.app/Contents/MacOS/Google Drive\",\n                                                 \"/usr/local/jamf/bin/jamf\",\n                                                 \"/Applications/Nextcloud.app/Contents/MacOS/Nextcloud\",\n                                                 \"/Library/Application Support/Checkpoint/Endpoint Security/AMFinderExtensions.app/Contents/MacOS/AMFinderExtensions\",\n                                                 \"/Applications/pCloud Drive.app/Contents/MacOS/pCloud Drive\")",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Network Traffic to Rare Destination Country",
        "description": "A machine learning job detected a rare destination country name in the network logs. This can be due to initial access, persistence, command-and-control, or exfiltration activity. For example, when a user clicks on a link in a phishing email or opens a malicious document, a request may be sent to download and run a payload from a server in a country which does not normally appear in network traffic or business work-flows. Malware instances and persistence mechanisms may communicate with command-and-control (C2) infrastructure in their country of origin, which may be an unusual destination country for the source network.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 104,
        "tags": [
          "Use Case: Threat Detection",
          "Rule Type: ML",
          "Rule Type: Machine Learning"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "15m",
        "from": "now-1800s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Business workflows that occur very occasionally, and involve a business relationship with an organization in a country that does not routinely appear in network events, can trigger this alert. A new business workflow with an organization in a country with which no workflows previously existed may trigger this alert - although the model will learn that the new destination country is no longer anomalous as the activity becomes ongoing. Business travelers who roam to many countries for brief periods may trigger this alert."
        ],
        "references": [
          "https://www.elastic.co/guide/en/security/current/prebuilt-ml-jobs.html"
        ],
        "max_signals": 100,
        "threat": [],
        "setup": "## Setup\n\nThis rule requires the installation of associated Machine Learning jobs, as well as data coming in from one of the following integrations:\n- Elastic Defend\n- Network Packet Capture\n\n### Anomaly Detection Setup\n\nOnce the rule is enabled, the associated Machine Learning job will start automatically. You can view the Machine Learning job linked under the \"Definition\" panel of the detection rule. If the job does not start due to an error, the issue must be resolved for the job to commence successfully. For more details on setting up anomaly detection jobs, refer to the [helper guide](https://www.elastic.co/guide/en/kibana/current/xpack-ml-anomalies.html).\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration to your system:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n### Network Packet Capture Integration Setup\nThe Network Packet Capture integration sniffs network packets on a host and dissects known protocols. Monitoring the network traffic is critical to gaining observability and securing your environment â€” ensuring high levels of performance and security. The Network Packet Capture integration captures the network traffic between your application servers, decodes common application layer protocols and records the interesting fields for each transaction.\n\n#### The following steps should be executed in order to add the Elastic Agent System integration \"network_traffic\" to your system:\n- Go to the Kibana home page and click â€œAdd integrationsâ€.\n- In the query bar, search for â€œNetwork Packet Captureâ€ and select the integration to see more details about it.\n- Click â€œAdd Network Packet Captureâ€.\n- Configure the integration name and optionally add a description.\n- Review optional and advanced settings accordingly.\n- Add the newly installed â€œnetwork_trafficâ€ to an existing or a new agent policy, and deploy the agent on your system from which network log files are desirable.\n- Click â€œSave and Continueâ€.\n- For more details on the integration refer to the [helper guide](https://docs.elastic.co/integrations/network_traffic).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "network_traffic",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [],
        "id": "e8073ce1-f63f-41d4-ba84-4cd71c408b05",
        "rule_id": "35f86980-1fb1-4dff-b311-3be941549c8d",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:38.326Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:09.070Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "machine_learning",
        "anomaly_threshold": 75,
        "machine_learning_job_id": [
          "rare_destination_country"
        ]
      },
      {
        "name": "Unusual Parent-Child Relationship",
        "description": "Identifies Windows programs run from unexpected parent processes. This could indicate masquerading or other strange activity on a system.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Unusual Parent-Child Relationship\n\nWindows internal/system processes have some characteristics that can be used to spot suspicious activities. One of these characteristics is parent-child relationships. These relationships can be used to baseline the typical behavior of the system and then alert on occurrences that don't comply with the baseline.\n\nThis rule uses this information to spot suspicious parent and child processes.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate any abnormal behavior by the subject process such as network connections, registry or file modifications, and any spawned child processes.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the process executable using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 314,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/sbousseaden/Slides/blob/master/Hunting%20MindMaps/PNG/Windows%20Processes%20TH.map.png",
          "https://www.andreafortuna.org/2017/06/15/standard-windows-processes-a-brief-reference/",
          "https://www.elastic.co/security-labs/elastic-security-labs-steps-through-the-r77-rootkit"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1055",
                "name": "Process Injection",
                "reference": "https://attack.mitre.org/techniques/T1055/",
                "subtechnique": [
                  {
                    "id": "T1055.012",
                    "name": "Process Hollowing",
                    "reference": "https://attack.mitre.org/techniques/T1055/012/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "733abbbf-7d08-4e67-8145-ee88f9044fbf",
        "rule_id": "35df0dd8-092d-4a83-88c1-5151a804f31b",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:38.349Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:05.891Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\nprocess.parent.name != null and\n (\n   /* suspicious parent processes */\n   (process.name:\"autochk.exe\" and not process.parent.name:\"smss.exe\") or\n   (process.name:(\"fontdrvhost.exe\", \"dwm.exe\") and not process.parent.name:(\"wininit.exe\", \"winlogon.exe\")) or\n   (process.name:(\"consent.exe\", \"RuntimeBroker.exe\", \"TiWorker.exe\") and not process.parent.name:\"svchost.exe\") or\n   (process.name:\"SearchIndexer.exe\" and not process.parent.name:\"services.exe\") or\n   (process.name:\"SearchProtocolHost.exe\" and not process.parent.name:(\"SearchIndexer.exe\", \"dllhost.exe\")) or\n   (process.name:\"dllhost.exe\" and not process.parent.name:(\"services.exe\", \"svchost.exe\")) or\n   (process.name:\"smss.exe\" and not process.parent.name:(\"System\", \"smss.exe\")) or\n   (process.name:\"csrss.exe\" and not process.parent.name:(\"smss.exe\", \"svchost.exe\")) or\n   (process.name:\"wininit.exe\" and not process.parent.name:\"smss.exe\") or\n   (process.name:\"winlogon.exe\" and not process.parent.name:\"smss.exe\") or\n   (process.name:(\"lsass.exe\", \"LsaIso.exe\") and not process.parent.name:\"wininit.exe\") or\n   (process.name:\"LogonUI.exe\" and not process.parent.name:(\"wininit.exe\", \"winlogon.exe\")) or\n   (process.name:\"services.exe\" and not process.parent.name:\"wininit.exe\") or\n   (process.name:\"svchost.exe\" and not process.parent.name:(\"MsMpEng.exe\", \"services.exe\", \"svchost.exe\")) or\n   (process.name:\"spoolsv.exe\" and not process.parent.name:\"services.exe\") or\n   (process.name:\"taskhost.exe\" and not process.parent.name:(\"services.exe\", \"svchost.exe\", \"ngentask.exe\")) or\n   (process.name:\"taskhostw.exe\" and not process.parent.name:(\"services.exe\", \"svchost.exe\")) or\n   (process.name:\"userinit.exe\" and not process.parent.name:(\"dwm.exe\", \"winlogon.exe\")) or\n   (process.name:(\"wmiprvse.exe\", \"wsmprovhost.exe\", \"winrshost.exe\") and not process.parent.name:\"svchost.exe\") or\n   /* suspicious child processes */\n   (process.parent.name:(\"SearchProtocolHost.exe\", \"taskhost.exe\", \"csrss.exe\") and not process.name:(\"werfault.exe\", \"wermgr.exe\", \"WerFaultSecure.exe\", \"conhost.exe\")) or\n   (process.parent.name:\"autochk.exe\" and not process.name:(\"chkdsk.exe\", \"doskey.exe\", \"WerFault.exe\")) or\n   (process.parent.name:\"smss.exe\" and not process.name:(\"autochk.exe\", \"smss.exe\", \"csrss.exe\", \"wininit.exe\", \"winlogon.exe\", \"setupcl.exe\", \"WerFault.exe\")) or\n   (process.parent.name:\"wermgr.exe\" and not process.name:(\"WerFaultSecure.exe\", \"wermgr.exe\", \"WerFault.exe\")) or\n   (process.parent.name:\"conhost.exe\" and not process.name:(\"mscorsvw.exe\", \"wermgr.exe\", \"WerFault.exe\", \"WerFaultSecure.exe\"))\n  )",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Potential Sudo Token Manipulation via Process Injection",
        "description": "This rule detects potential sudo token manipulation attacks through process injection by monitoring the use of a debugger (gdb) process followed by a successful uid change event during the execution of the sudo process. A sudo token manipulation attack is performed by injecting into a process that has a valid sudo token, which can then be used by attackers to activate their own sudo token. This attack requires ptrace to be enabled in conjunction with the existence of a living process that has a valid sudo token with the same uid as the current user.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 107,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/nongiach/sudo_inject"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1055",
                "name": "Process Injection",
                "reference": "https://attack.mitre.org/techniques/T1055/",
                "subtechnique": [
                  {
                    "id": "T1055.008",
                    "name": "Ptrace System Calls",
                    "reference": "https://attack.mitre.org/techniques/T1055/008/"
                  }
                ]
              },
              {
                "id": "T1548",
                "name": "Abuse Elevation Control Mechanism",
                "reference": "https://attack.mitre.org/techniques/T1548/",
                "subtechnique": [
                  {
                    "id": "T1548.003",
                    "name": "Sudo and Sudo Caching",
                    "reference": "https://attack.mitre.org/techniques/T1548/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.group.id",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.session_leader.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "1ad65dea-88c9-4d27-aa8a-5b4f274464d4",
        "rule_id": "ff9bc8b9-f03b-4283-be58-ee0a16f5a11b",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-13T19:42:38.351Z",
        "updated_by": "elastic",
        "created_at": "2024-12-13T19:25:17.281Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by host.id, process.session_leader.entity_id with maxspan=15s\n[ process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and \n  process.name == \"gdb\" and process.user.id != \"0\" and process.group.id != \"0\" ]\n[ process where host.os.type == \"linux\" and event.action == \"uid_change\" and event.type == \"change\" and \n  process.name == \"sudo\" and process.user.id == \"0\" and process.group.id == \"0\" ]",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      }
    ],
    "skipped": []
  },
  "errors": [
    {
      "message": "Rule update for rule 0f4d35e4-925e-4959-ab24-911be207ee6f has a rule type change. All 'pick_version' values for rule must match 'TARGET'",
      "rules": [
        {
          "rule_id": "0f4d35e4-925e-4959-ab24-911be207ee6f"
        }
      ]
    },
    {
      "message": "Rule update for rule 17b0a495-4d9f-414c-8ad0-92f018b8e001 has a rule type change. All 'pick_version' values for rule must match 'TARGET'",
      "rules": [
        {
          "rule_id": "17b0a495-4d9f-414c-8ad0-92f018b8e001"
        }
      ]
    },
    {
      "message": "Rule update for rule 7592c127-89fb-4209-a8f6-f9944dfd7e02 has a rule type change. All 'pick_version' values for rule must match 'TARGET'",
      "rules": [
        {
          "rule_id": "7592c127-89fb-4209-a8f6-f9944dfd7e02"
        }
      ]
    },
    {
      "message": "Rule update for rule 7fb500fa-8e24-4bd1-9480-2a819352602c has a rule type change. All 'pick_version' values for rule must match 'TARGET'",
      "rules": [
        {
          "rule_id": "7fb500fa-8e24-4bd1-9480-2a819352602c"
        }
      ]
    },
    {
      "message": "Rule update for rule 40ddbcc8-6561-44d9-afc8-eefdbfe0cccd has a rule type change. All 'pick_version' values for rule must match 'TARGET'",
      "rules": [
        {
          "rule_id": "40ddbcc8-6561-44d9-afc8-eefdbfe0cccd"
        }
      ]
    },
    {
      "message": "Rule update for rule 474fd20e-14cc-49c5-8160-d9ab4ba16c8b has a rule type change. All 'pick_version' values for rule must match 'TARGET'",
      "rules": [
        {
          "rule_id": "474fd20e-14cc-49c5-8160-d9ab4ba16c8b"
        }
      ]
    },
    {
      "message": "Rule update for rule 96d11d31-9a79-480f-8401-da28b194608f has a rule type change. All 'pick_version' values for rule must match 'TARGET'",
      "rules": [
        {
          "rule_id": "96d11d31-9a79-480f-8401-da28b194608f"
        }
      ]
    },
    {
      "message": "Rule update for rule 80084fa9-8677-4453-8680-b891d3c0c778 has a rule type change. All 'pick_version' values for rule must match 'TARGET'",
      "rules": [
        {
          "rule_id": "80084fa9-8677-4453-8680-b891d3c0c778"
        }
      ]
    },
    {
      "message": "Rule update for rule 9f9a2a82-93a8-4b1a-8778-1780895626d4 has a rule type change. All 'pick_version' values for rule must match 'TARGET'",
      "rules": [
        {
          "rule_id": "9f9a2a82-93a8-4b1a-8778-1780895626d4"
        }
      ]
    },
    {
      "message": "Rule update for rule 56fdfcf1-ca7c-4fd9-951d-e215ee26e404 has a rule type change. All 'pick_version' values for rule must match 'TARGET'",
      "rules": [
        {
          "rule_id": "56fdfcf1-ca7c-4fd9-951d-e215ee26e404"
        }
      ]
    },
    {
      "message": "Rule update for rule ded09d02-0137-4ccc-8005-c45e617e8d4c has a rule type change. All 'pick_version' values for rule must match 'TARGET'",
      "rules": [
        {
          "rule_id": "ded09d02-0137-4ccc-8005-c45e617e8d4c"
        }
      ]
    },
    {
      "message": "Rule update for rule 717f82c2-7741-4f9b-85b8-d06aeb853f4f has a rule type change. All 'pick_version' values for rule must match 'TARGET'",
      "rules": [
        {
          "rule_id": "717f82c2-7741-4f9b-85b8-d06aeb853f4f"
        }
      ]
    },
    {
      "message": "Rule update for rule 852c1f19-68e8-43a6-9dce-340771fe1be3 has a rule type change. All 'pick_version' values for rule must match 'TARGET'",
      "rules": [
        {
          "rule_id": "852c1f19-68e8-43a6-9dce-340771fe1be3"
        }
      ]
    },
    {
      "message": "Rule update for rule 15a8ba77-1c13-4274-88fe-6bd14133861e has a rule type change. All 'pick_version' values for rule must match 'TARGET'",
      "rules": [
        {
          "rule_id": "15a8ba77-1c13-4274-88fe-6bd14133861e"
        }
      ]
    },
    {
      "message": "Rule update for rule 16fac1a1-21ee-4ca6-b720-458e3855d046 has a rule type change. All 'pick_version' values for rule must match 'TARGET'",
      "rules": [
        {
          "rule_id": "16fac1a1-21ee-4ca6-b720-458e3855d046"
        }
      ]
    },
    {
      "message": "Rule update for rule 2215b8bd-1759-4ffa-8ab8-55c8e6b32e7f has a rule type change. All 'pick_version' values for rule must match 'TARGET'",
      "rules": [
        {
          "rule_id": "2215b8bd-1759-4ffa-8ab8-55c8e6b32e7f"
        }
      ]
    },
    {
      "message": "Rule update for rule 26f68dba-ce29-497b-8e13-b4fde1db5a2d has a rule type change. All 'pick_version' values for rule must match 'TARGET'",
      "rules": [
        {
          "rule_id": "26f68dba-ce29-497b-8e13-b4fde1db5a2d"
        }
      ]
    },
    {
      "message": "Rule update for rule 291a0de9-937a-4189-94c0-3e847c8b13e4 has a rule type change. All 'pick_version' values for rule must match 'TARGET'",
      "rules": [
        {
          "rule_id": "291a0de9-937a-4189-94c0-3e847c8b13e4"
        }
      ]
    },
    {
      "message": "Rule update for rule 9d110cb3-5f4b-4c9a-b9f5-53f0a1707ae2 has a rule type change. All 'pick_version' values for rule must match 'TARGET'",
      "rules": [
        {
          "rule_id": "9d110cb3-5f4b-4c9a-b9f5-53f0a1707ae2"
        }
      ]
    },
    {
      "message": "Rule update for rule 9d110cb3-5f4b-4c9a-b9f5-53f0a1707ae6 has a rule type change. All 'pick_version' values for rule must match 'TARGET'",
      "rules": [
        {
          "rule_id": "9d110cb3-5f4b-4c9a-b9f5-53f0a1707ae6"
        }
      ]
    },
    {
      "message": "Rule update for rule 9d110cb3-5f4b-4c9a-b9f5-53f0a1707ae9 has a rule type change. All 'pick_version' values for rule must match 'TARGET'",
      "rules": [
        {
          "rule_id": "9d110cb3-5f4b-4c9a-b9f5-53f0a1707ae9"
        }
      ]
    },
    {
      "message": "Rule update for rule a1329140-8de3-4445-9f87-908fb6d824f4 has a rule type change. All 'pick_version' values for rule must match 'TARGET'",
      "rules": [
        {
          "rule_id": "a1329140-8de3-4445-9f87-908fb6d824f4"
        }
      ]
    },
    {
      "message": "Rule update for rule b9554892-5e0e-424b-83a0-5aef95aa43bf has a rule type change. All 'pick_version' values for rule must match 'TARGET'",
      "rules": [
        {
          "rule_id": "b9554892-5e0e-424b-83a0-5aef95aa43bf"
        }
      ]
    },
    {
      "message": "Rule update for rule bf1073bf-ce26-4607-b405-ba1ed8e9e204 has a rule type change. All 'pick_version' values for rule must match 'TARGET'",
      "rules": [
        {
          "rule_id": "bf1073bf-ce26-4607-b405-ba1ed8e9e204"
        }
      ]
    },
    {
      "message": "Rule update for rule 55c2bf58-2a39-4c58-a384-c8b1978153c2 has a rule type change. All 'pick_version' values for rule must match 'TARGET'",
      "rules": [
        {
          "rule_id": "55c2bf58-2a39-4c58-a384-c8b1978153c2"
        }
      ]
    },
    {
      "message": "Rule update for rule 5bb4a95d-5a08-48eb-80db-4c3a63ec78a8 has a rule type change. All 'pick_version' values for rule must match 'TARGET'",
      "rules": [
        {
          "rule_id": "5bb4a95d-5a08-48eb-80db-4c3a63ec78a8"
        }
      ]
    },
    {
      "message": "Rule update for rule 6b84d470-9036-4cc0-a27c-6d90bbfe81ab has a rule type change. All 'pick_version' values for rule must match 'TARGET'",
      "rules": [
        {
          "rule_id": "6b84d470-9036-4cc0-a27c-6d90bbfe81ab"
        }
      ]
    },
    {
      "message": "Rule update for rule 37b211e8-4e2f-440f-86d8-06cc8f158cfa has a rule type change. All 'pick_version' values for rule must match 'TARGET'",
      "rules": [
        {
          "rule_id": "37b211e8-4e2f-440f-86d8-06cc8f158cfa"
        }
      ]
    },
    {
      "message": "Rule update for rule 3a59fc81-99d3-47ea-8cd6-d48d561fca20 has a rule type change. All 'pick_version' values for rule must match 'TARGET'",
      "rules": [
        {
          "rule_id": "3a59fc81-99d3-47ea-8cd6-d48d561fca20"
        }
      ]
    },
    {
      "message": "Rule update for rule cd89602e-9db0-48e3-9391-ae3bf241acd8 has a rule type change. All 'pick_version' values for rule must match 'TARGET'",
      "rules": [
        {
          "rule_id": "cd89602e-9db0-48e3-9391-ae3bf241acd8"
        }
      ]
    },
    {
      "message": "Rule update for rule debff20a-46bc-4a4d-bae5-5cdd14222795 has a rule type change. All 'pick_version' values for rule must match 'TARGET'",
      "rules": [
        {
          "rule_id": "debff20a-46bc-4a4d-bae5-5cdd14222795"
        }
      ]
    },
    {
      "message": "Rule update for rule e052c845-48d0-4f46-8a13-7d0aba05df82 has a rule type change. All 'pick_version' values for rule must match 'TARGET'",
      "rules": [
        {
          "rule_id": "e052c845-48d0-4f46-8a13-7d0aba05df82"
        }
      ]
    },
    {
      "message": "Rule update for rule 8a1b0278-0f9a-487d-96bd-d4833298e87a has a rule type change. All 'pick_version' values for rule must match 'TARGET'",
      "rules": [
        {
          "rule_id": "8a1b0278-0f9a-487d-96bd-d4833298e87a"
        }
      ]
    },
    {
      "message": "Rule update for rule 8acb7614-1d92-4359-bfcf-478b6d9de150 has a rule type change. All 'pick_version' values for rule must match 'TARGET'",
      "rules": [
        {
          "rule_id": "8acb7614-1d92-4359-bfcf-478b6d9de150"
        }
      ]
    },
    {
      "message": "Rule update for rule 90169566-2260-4824-b8e4-8615c3b4ed52 has a rule type change. All 'pick_version' values for rule must match 'TARGET'",
      "rules": [
        {
          "rule_id": "90169566-2260-4824-b8e4-8615c3b4ed52"
        }
      ]
    },
    {
      "message": "Rule update for rule 0d69150b-96f8-467c-a86d-a67a3378ce77 has a rule type change. All 'pick_version' values for rule must match 'TARGET'",
      "rules": [
        {
          "rule_id": "0d69150b-96f8-467c-a86d-a67a3378ce77"
        }
      ]
    },
    {
      "message": "Rule update for rule 93075852-b0f5-4b8b-89c3-a226efae5726 has a rule type change. All 'pick_version' values for rule must match 'TARGET'",
      "rules": [
        {
          "rule_id": "93075852-b0f5-4b8b-89c3-a226efae5726"
        }
      ]
    },
    {
      "message": "Rule update for rule 931e25a5-0f5e-4ae0-ba0d-9e94eff7e3a4 has a rule type change. All 'pick_version' values for rule must match 'TARGET'",
      "rules": [
        {
          "rule_id": "931e25a5-0f5e-4ae0-ba0d-9e94eff7e3a4"
        }
      ]
    },
    {
      "message": "Rule update for rule 93f47b6f-5728-4004-ba00-625083b3dcb0 has a rule type change. All 'pick_version' values for rule must match 'TARGET'",
      "rules": [
        {
          "rule_id": "93f47b6f-5728-4004-ba00-625083b3dcb0"
        }
      ]
    },
    {
      "message": "Rule update for rule eb9eb8ba-a983-41d9-9c93-a1c05112ca5e has a rule type change. All 'pick_version' values for rule must match 'TARGET'",
      "rules": [
        {
          "rule_id": "eb9eb8ba-a983-41d9-9c93-a1c05112ca5e"
        }
      ]
    },
    {
      "message": "Rule update for rule fd7a6052-58fa-4397-93c3-4795249ccfa2 has a rule type change. All 'pick_version' values for rule must match 'TARGET'",
      "rules": [
        {
          "rule_id": "fd7a6052-58fa-4397-93c3-4795249ccfa2"
        }
      ]
    },
    {
      "message": "Rule update for rule ff10d4d8-fea7-422d-afb1-e5a2702369a9 has a rule type change. All 'pick_version' values for rule must match 'TARGET'",
      "rules": [
        {
          "rule_id": "ff10d4d8-fea7-422d-afb1-e5a2702369a9"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '041d4d41-9589-43e2-ba13-5680af75ebc2' for fields: name, tags, note. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "041d4d41-9589-43e2-ba13-5680af75ebc2"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '4973e46b-a663-41b8-a875-ced16dda2bb0' for fields: name, tags, severity, risk_score, note, eql_query. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "4973e46b-a663-41b8-a875-ced16dda2bb0"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '4b1a807a-4e7b-414e-8cea-24bf580f6fc5' for fields: tags. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "4b1a807a-4e7b-414e-8cea-24bf580f6fc5"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'ccc55af4-9882-4c67-87b4-449a7ae8079c' for fields: tags. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "ccc55af4-9882-4c67-87b4-449a7ae8079c"
        }
      ]
    }
  ]
}