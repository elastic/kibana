{
  "summary": {
    "total": 570,
    "skipped": 0,
    "succeeded": 308,
    "failed": 262
  },
  "results": {
    "updated": [
      {
        "name": "Multiple Okta User Authentication Events with Same Device Token Hash",
        "description": "Detects when a high number of Okta user authentication events are reported for multiple users in a short time frame. Adversaries may attempt to launch a credential stuffing or password spraying attack from the same device by using a list of known usernames and passwords to gain unauthorized access to user accounts.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Multiple Okta User Authentication Events with Same Device Token Hash\n\nThis rule detects when a high number of Okta user authentication events are reported for multiple users in a short time frame. Adversaries may attempt to launch a credential stuffing attack from the same device by using a list of known usernames and passwords to gain unauthorized access to user accounts. Note that Okta does not log unrecognized usernames supplied during authentication attempts, so this rule may not detect all credential stuffing attempts or may indicate a targeted attack.\n\n#### Possible investigation steps:\n- Since this is an ES|QL rule, the `okta.actor.alternate_id` and `okta.debug_context.debug_data.dt_hash` values can be used to pivot into the raw authentication events related to this activity.\n- Identify the users involved in this action by examining the `okta.actor.id`, `okta.actor.type`, `okta.actor.alternate_id`, and `okta.actor.display_name` fields.\n- Determine the device client used for these actions by analyzing `okta.client.ip`, `okta.client.user_agent.raw_user_agent`, `okta.client.zone`, `okta.client.device`, and `okta.client.id` fields.\n- Review the `okta.security_context.is_proxy` field to determine if the device is a proxy.\n    - If the device is a proxy, this may indicate that a user is using a proxy to access multiple accounts for password spraying.\n- With the list of `okta.actor.alternate_id` values, review `event.outcome` results to determine if the authentication was successful.\n    - If the authentication was successful for any user, pivoting to `event.action` values for those users may provide additional context.\n- With Okta end users identified, review the `okta.debug_context.debug_data.dt_hash` field.\n    - Historical analysis should indicate if this device token hash is commonly associated with the user.\n- Review the `okta.event_type` field to determine the type of authentication event that occurred.\n    - If the event type is `user.authentication.sso`, the user may have legitimately started a session via a proxy for security or privacy reasons.\n    - If the event type is `user.authentication.password`, the user may be using a proxy to access multiple accounts for password spraying.\n- Examine the `okta.outcome.result` field to determine if the authentication was successful.\n- Review the past activities of the actor(s) involved in this action by checking their previous actions.\n- Evaluate the actions that happened just before and after this event in the `okta.event_type` field to help understand the full context of the activity.\n    - This may help determine the authentication and authorization actions that occurred between the user, Okta and application.\n\n### False positive analysis:\n- A user may have legitimately started a session via a proxy for security or privacy reasons.\n- Users may share an endpoint related to work or personal use in which separate Okta accounts are used.\n    - Architecturally, this shared endpoint may leverage a proxy for security or privacy reasons.\n    - Shared systems such as Kiosks and conference room computers may be used by multiple users.\n    - Shared working spaces may have a single endpoint that is used by multiple users.\n\n### Response and remediation:\n- Review the profile of the users involved in this action to determine if proxy usage may be expected.\n- If the user is legitimate and the authentication behavior is not suspicious based on device analysis, no action is required.\n- If the user is legitimate but the authentication behavior is suspicious, consider resetting passwords for the users involves and enabling multi-factor authentication (MFA).\n    - If MFA is already enabled, consider resetting MFA for the users.\n- If any of the users are not legitimate, consider deactivating the user's account.\n- Conduct a review of Okta policies and ensure they are in accordance with security best practices.\n- Check with internal IT teams to determine if the accounts involved recently had MFA reset at the request of the user.\n    - If so, confirm with the user this was a legitimate request.\n    - If so and this was not a legitimate request, consider deactivating the user's account temporarily.\n        - Reset passwords and reset MFA for the user.\n- If this is a false positive, consider adding the `okta.debug_context.debug_data.dt_hash` field to the `exceptions` list in the rule.\n    - This will prevent future occurrences of this event for this device from triggering the rule.\n",
        "output_index": "",
        "version": 203,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Data Source: Okta",
          "Tactic: Credential Access"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Users may share an endpoint related to work or personal use in which separate Okta accounts are used.",
          "Shared systems such as Kiosks and conference room computers may be used by multiple users."
        ],
        "references": [
          "https://support.okta.com/help/s/article/How-does-the-Device-Token-work?language=en_US",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://sec.okta.com/articles/2023/08/cross-tenant-impersonation-prevention-and-detection",
          "https://www.okta.com/resources/whitepaper-how-adaptive-mfa-can-help-in-mitigating-brute-force-attacks/",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1110",
                "name": "Brute Force",
                "reference": "https://attack.mitre.org/techniques/T1110/",
                "subtechnique": [
                  {
                    "id": "T1110.003",
                    "name": "Password Spraying",
                    "reference": "https://attack.mitre.org/techniques/T1110/003/"
                  }
                ]
              },
              {
                "id": "T1110",
                "name": "Brute Force",
                "reference": "https://attack.mitre.org/techniques/T1110/",
                "subtechnique": [
                  {
                    "id": "T1110.004",
                    "name": "Credential Stuffing",
                    "reference": "https://attack.mitre.org/techniques/T1110/004/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [],
        "required_fields": [],
        "id": "52b2a01a-f046-4388-9be2-fb208c2a1383",
        "rule_id": "95b99adc-2cda-11ef-84e1-f661ea17fbce",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:31.832Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:40.649Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "esql",
        "language": "esql",
        "query": "FROM logs-okta*\n| WHERE\n    event.dataset == \"okta.system\"\n    AND (event.action RLIKE \"user\\\\.authentication(.*)\" OR event.action == \"user.session.start\")\n    AND okta.debug_context.debug_data.dt_hash != \"-\"\n    AND okta.outcome.reason == \"INVALID_CREDENTIALS\"\n| KEEP event.action, okta.debug_context.debug_data.dt_hash, okta.actor.id, okta.actor.alternate_id, okta.outcome.reason\n| STATS\n    target_auth_count = COUNT_DISTINCT(okta.actor.id)\n    BY okta.debug_context.debug_data.dt_hash, okta.actor.alternate_id\n| WHERE\n    target_auth_count > 20\n| SORT\n    target_auth_count DESC"
      },
      {
        "name": "AWS Bedrock Guardrails Detected Multiple Policy Violations Within a Single Blocked Request",
        "description": "Identifies multiple violations of AWS Bedrock guardrails within a single request, resulting in a block action, increasing the likelihood of malicious intent. Multiple violations implies that a user may be intentionally attempting to cirvumvent security controls, access sensitive information, or possibly exploit a vulnerability in the system.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Amazon Bedrock Guardrail Multiple Policy Violations Within a Single Blocked Request.\n\nAmazon Bedrock Guardrail is a set of features within Amazon Bedrock designed to help businesses apply robust safety and privacy controls to their generative AI applications.\n\nIt enables users to set guidelines and filters that manage content quality, relevancy, and adherence to responsible AI practices.\n\nThrough Guardrail, organizations can define \"denied topics\" to prevent the model from generating content on specific, undesired subjects,\nand they can establish thresholds for harmful content categories, including hate speech, violence, or offensive language.\n\n#### Possible investigation steps\n\n- Identify the user account and the user request that caused multiple policy violations and whether it should perform this kind of action.\n- Investigate the user activity that might indicate a potential brute force attack.\n- Investigate other alerts associated with the user account during the past 48 hours.\n- Consider the time of day. If the user is a human (not a program or script), did the activity take place during a normal time of day?\n- Examine the account's prompts and responses in the last 24 hours.\n- If you suspect the account has been compromised, scope potentially compromised assets by tracking Amazon Bedrock model access, prompts generated, and responses to the prompts by the account in the last 24 hours.\n\n### False positive analysis\n\n- Verify the user account that caused multiple policy violations, is not testing any new model deployments or updated compliance policies in Amazon Bedrock guardrails.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Disable or limit the account during the investigation and response.\n- Identify the possible impact of the incident and prioritize accordingly; the following actions can help you gain context:\n    - Identify the account role in the cloud environment.\n    - Identify if the attacker is moving laterally and compromising other Amazon Bedrock Services.\n    - Identify any regulatory or legal ramifications related to this activity.\n- Review the permissions assigned to the implicated user group or role behind these requests to ensure they are authorized and expected to access bedrock and ensure that the least privilege principle is being followed.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection via the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 3,
        "tags": [
          "Domain: LLM",
          "Data Source: AWS Bedrock",
          "Data Source: AWS S3",
          "Resources: Investigation Guide",
          "Use Case: Policy Violation",
          "Mitre Atlas: T0051",
          "Mitre Atlas: T0054"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-3600s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Legitimate misunderstanding by users or overly strict policies"
        ],
        "references": [
          "https://docs.aws.amazon.com/bedrock/latest/userguide/guardrails-components.html",
          "https://atlas.mitre.org/techniques/AML.T0051",
          "https://atlas.mitre.org/techniques/AML.T0054",
          "https://www.elastic.co/security-labs/elastic-advances-llm-security"
        ],
        "max_signals": 100,
        "threat": [],
        "setup": "## Setup\n\nThis rule requires that guardrails are configured in AWS Bedrock. For more information, see the AWS Bedrock documentation:\n\nhttps://docs.aws.amazon.com/bedrock/latest/userguide/guardrails-create.html\n",
        "related_integrations": [],
        "required_fields": [],
        "id": "f917a070-dcea-46f9-8c98-debb46d7402d",
        "rule_id": "f4c2515a-18bb-47ce-a768-1dc4e7b0fe6c",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:31.838Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:51.747Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "esql",
        "language": "esql",
        "query": "from logs-aws_bedrock.invocation-*\n| where gen_ai.policy.action == \"BLOCKED\"\n| eval policy_violations = mv_count(gen_ai.policy.name)\n| where policy_violations > 1\n| keep gen_ai.policy.action, policy_violations, user.id, gen_ai.request.model.id, cloud.account.id, user.id\n| stats total_unique_request_violations = count(*) by policy_violations, user.id, gen_ai.request.model.id, cloud.account.id\n| sort total_unique_request_violations desc"
      },
      {
        "name": "Mofcomp Activity",
        "description": "Managed Object Format (MOF) files can be compiled locally or remotely through mofcomp.exe. Attackers may leverage MOF files to build their own namespaces and classes into the Windows Management Instrumentation (WMI) repository, or establish persistence using WMI Event Subscription.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 4,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Data Source: Elastic Defend",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Elastic Endgame",
          "Data Source: System",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1047",
                "name": "Windows Management Instrumentation",
                "reference": "https://attack.mitre.org/techniques/T1047/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1546",
                "name": "Event Triggered Execution",
                "reference": "https://attack.mitre.org/techniques/T1546/",
                "subtechnique": [
                  {
                    "id": "T1546.003",
                    "name": "Windows Management Instrumentation Event Subscription",
                    "reference": "https://attack.mitre.org/techniques/T1546/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "21cc16c4-e5a4-4a77-9f9d-664d60c7467c",
        "rule_id": "210d4430-b371-470e-b879-80b7182aa75e",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:31.841Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:13.739Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.name : \"mofcomp.exe\" and process.args : \"*.mof\" and\n  not user.id : \"S-1-5-18\" and\n  not\n  (\n    process.parent.name : \"ScenarioEngine.exe\" and\n    process.args : (\n      \"*\\\\MSSQL\\\\Binn\\\\*.mof\",\n      \"*\\\\Microsoft SQL Server\\\\???\\\\Shared\\\\*.mof\",\n      \"*\\\\OLAP\\\\bin\\\\*.mof\"\n    )\n  )",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "logs-m365_defender.event-*",
          "endgame-*",
          "logs-system.security-*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Successful Application SSO from Rare Unknown Client Device",
        "description": "Detects successful single sign-on (SSO) events to Okta applications from an unrecognized or \"unknown\" client device, as identified by the user-agent string. This activity may be indicative of exploitation of a vulnerability in Okta's Classic Engine, which could allow an attacker to bypass application-specific sign-on policies, such as device or network restrictions. The vulnerability potentially enables unauthorized access to applications using only valid, stolen credentials, without requiring additional authentication factors.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 204,
        "tags": [
          "Domain: SaaS",
          "Data Source: Okta",
          "Use Case: Threat Detection",
          "Use Case: Identity and Access Audit",
          "Tactic: Initial Access"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://trust.okta.com/security-advisories/okta-classic-application-sign-on-policy-bypass-2024/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1078",
                "name": "Valid Accounts",
                "reference": "https://attack.mitre.org/techniques/T1078/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "okta.client.device",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "e850830a-19b4-4773-8a96-1bd46cb3d85b",
        "rule_id": "1502a836-84b2-11ef-b026-f661ea17fbcc",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:31.868Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:23.814Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "event.dataset: \"okta.system\"\n    and event.action: \"user.authentication.sso\"\n    and event.outcome: \"success\"\n    and okta.client.device: (\"Unknown\" or \"unknown\")",
        "new_terms_fields": [
          "client.user.name",
          "okta.client.user_agent.raw_user_agent"
        ],
        "history_window_start": "now-14d",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Okta User Sessions Started from Different Geolocations",
        "description": "Detects when a specific Okta actor has multiple sessions started from different geolocations. Adversaries may attempt to launch an attack by using a list of known usernames and passwords to gain unauthorized access to user accounts from different locations.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "\n## Triage and analysis\n\n### Investigating Okta User Sessions Started from Different Geolocations\n\nThis rule detects when a specific Okta actor has multiple sessions started from different geolocations. Adversaries may attempt to launch an attack by using a list of known usernames and passwords to gain unauthorized access to user accounts from different locations.\n\n#### Possible investigation steps:\n- Since this is an ES|QL rule, the `okta.actor.alternate_id` and `okta.client.id` values can be used to pivot into the raw authentication events related to this alert.\n- Identify the users involved in this action by examining the `okta.actor.id`, `okta.actor.type`, `okta.actor.alternate_id`, and `okta.actor.display_name` fields.\n- Determine the device client used for these actions by analyzing `okta.client.ip`, `okta.client.user_agent.raw_user_agent`, `okta.client.zone`, `okta.client.device`, and `okta.client.id` fields.\n- With Okta end users identified, review the `okta.debug_context.debug_data.dt_hash` field.\n    - Historical analysis should indicate if this device token hash is commonly associated with the user.\n- Review the `okta.event_type` field to determine the type of authentication event that occurred.\n    - If the event type is `user.authentication.sso`, the user may have legitimately started a session via a proxy for security or privacy reasons.\n    - If the event type is `user.authentication.password`, the user may be using a proxy to access multiple accounts for password spraying.\n    - If the event type is `user.session.start`, the source may have attempted to establish a session via the Okta authentication API.\n- Review the past activities of the actor(s) involved in this action by checking their previous actions.\n- Evaluate the actions that happened just before and after this event in the `okta.event_type` field to help understand the full context of the activity.\n    - This may help determine the authentication and authorization actions that occurred between the user, Okta and application.\n\n### False positive analysis:\n- It is very rare that a legitimate user would have multiple sessions started from different geo-located countries in a short time frame.\n\n### Response and remediation:\n- If the user is legitimate and the authentication behavior is not suspicious based on device analysis, no action is required.\n- If the user is legitimate but the authentication behavior is suspicious, consider resetting passwords for the users involves and enabling multi-factor authentication (MFA).\n    - If MFA is already enabled, consider resetting MFA for the users.\n- If any of the users are not legitimate, consider deactivating the user's account.\n- Conduct a review of Okta policies and ensure they are in accordance with security best practices.\n- Check with internal IT teams to determine if the accounts involved recently had MFA reset at the request of the user.\n    - If so, confirm with the user this was a legitimate request.\n    - If so and this was not a legitimate request, consider deactivating the user's account temporarily.\n        - Reset passwords and reset MFA for the user.\n- If this is a false positive, consider adding the `okta.debug_context.debug_data.dt_hash` field to the `exceptions` list in the rule.\n    - This will prevent future occurrences of this event for this device from triggering the rule.\n    - Alternatively adding `okta.client.ip` or a CIDR range to the `exceptions` list can prevent future occurrences of this event from triggering the rule.\n        - This should be done with caution as it may prevent legitimate alerts from being generated.\n",
        "output_index": "",
        "version": 303,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Data Source: Okta",
          "Tactic: Initial Access"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "15m",
        "from": "now-1800s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://sec.okta.com/articles/2023/08/cross-tenant-impersonation-prevention-and-detection",
          "https://www.rezonate.io/blog/okta-logs-decoded-unveiling-identity-threats-through-threat-hunting/",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1078",
                "name": "Valid Accounts",
                "reference": "https://attack.mitre.org/techniques/T1078/",
                "subtechnique": [
                  {
                    "id": "T1078.004",
                    "name": "Cloud Accounts",
                    "reference": "https://attack.mitre.org/techniques/T1078/004/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.\n",
        "related_integrations": [],
        "required_fields": [],
        "id": "7fee8258-2fc0-4bef-ac29-a718ad32dc07",
        "rule_id": "2e56e1bc-867a-11ee-b13e-f661ea17fbcd",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:31.871Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:27.933Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "esql",
        "language": "esql",
        "query": "FROM logs-okta*\n| WHERE\n    event.dataset == \"okta.system\"\n    AND (event.action RLIKE \"user\\\\.authentication(.*)\" OR event.action == \"user.session.start\")\n    AND okta.security_context.is_proxy != true and okta.actor.id != \"unknown\"\n    AND event.outcome == \"success\"\n| KEEP event.action, okta.security_context.is_proxy, okta.actor.id, event.outcome, client.geo.country_name, okta.actor.alternate_id\n| STATS\n    geo_auth_counts = COUNT_DISTINCT(client.geo.country_name)\n    BY okta.actor.id, okta.actor.alternate_id\n| WHERE\n    geo_auth_counts >= 2"
      },
      {
        "name": "Multiple Device Token Hashes for Single Okta Session",
        "description": "This rule detects when a specific Okta actor has multiple device token hashes for a single Okta session. This may indicate an authenticated session has been hijacked or is being used by multiple devices. Adversaries may hijack a session to gain unauthorized access to Okta admin console, applications, tenants, or other resources.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Multiple Device Token Hashes for Single Okta Session\n\nThis rule detects when a specific Okta actor has multiple device token hashes for a single Okta session. This may indicate an authenticated session has been hijacked or is being used by multiple devices. Adversaries may hijack a session to gain unauthorized access to Okta admin console, applications, tenants, or other resources.\n\n#### Possible investigation steps:\n- Since this is an ES|QL rule, the `okta.actor.alternate_id` and `okta.authentication_context.external_session_id` values can be used to pivot into the raw authentication events related to this alert.\n- Identify the users involved in this action by examining the `okta.actor.id`, `okta.actor.type`, `okta.actor.alternate_id`, and `okta.actor.display_name` fields.\n- Determine the device client used for these actions by analyzing `okta.client.ip`, `okta.client.user_agent.raw_user_agent`, `okta.client.zone`, `okta.client.device`, and `okta.client.id` fields.\n- With Okta end users identified, review the `okta.debug_context.debug_data.dt_hash` field.\n    - Historical analysis should indicate if this device token hash is commonly associated with the user.\n- Review the `okta.event_type` field to determine the type of authentication event that occurred.\n    - Authentication events have been filtered out to focus on Okta activity via established sessions.\n- Review the past activities of the actor(s) involved in this action by checking their previous actions.\n- Evaluate the actions that happened just before and after this event in the `okta.event_type` field to help understand the full context of the activity.\n    - This may help determine the authentication and authorization actions that occurred between the user, Okta and application.\n- Aggregate by `okta.actor.alternate_id` and `event.action` to determine the type of actions that are being performed by the actor(s) involved in this action.\n    - If various activity is reported that seems to indicate actions from separate users, consider deactivating the user's account temporarily.\n\n### False positive analysis:\n- It is very rare that a legitimate user would have multiple device token hashes for a single Okta session as DT hashes do not change after an authenticated session is established.\n\n### Response and remediation:\n- Consider stopping all sessions for the user(s) involved in this action.\n- If this does not appear to be a false positive, consider resetting passwords for the users involved and enabling multi-factor authentication (MFA).\n    - If MFA is already enabled, consider resetting MFA for the users.\n- If any of the users are not legitimate, consider deactivating the user's account.\n- Conduct a review of Okta policies and ensure they are in accordance with security best practices.\n- Check with internal IT teams to determine if the accounts involved recently had MFA reset at the request of the user.\n    - If so, confirm with the user this was a legitimate request.\n    - If so and this was not a legitimate request, consider deactivating the user's account temporarily.\n        - Reset passwords and reset MFA for the user.\n- Alternatively adding `okta.client.ip` or a CIDR range to the `exceptions` list can prevent future occurrences of this event from triggering the rule.\n    - This should be done with caution as it may prevent legitimate alerts from being generated.\n",
        "output_index": "",
        "version": 304,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Data Source: Okta",
          "Tactic: Credential Access",
          "Domain: SaaS"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://sec.okta.com/articles/2023/08/cross-tenant-impersonation-prevention-and-detection",
          "https://support.okta.com/help/s/article/session-hijacking-attack-definition-damage-defense?language=en_US",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1539",
                "name": "Steal Web Session Cookie",
                "reference": "https://attack.mitre.org/techniques/T1539/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [],
        "required_fields": [],
        "id": "cb6391eb-365e-496d-9479-3a87fa901b12",
        "rule_id": "cc382a2e-7e52-11ee-9aac-f661ea17fbcd",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:31.874Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:45.701Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "esql",
        "language": "esql",
        "query": "FROM logs-okta*\n| WHERE\n    event.dataset == \"okta.system\"\n    // ignore authentication events where session and device token hash change often\n    AND NOT event.action IN (\n        \"policy.evaluate_sign_on\",\n        \"user.session.start\",\n        \"user.authentication.sso\"\n    )\n    // ignore Okta system events and only allow registered users\n    AND (\n        okta.actor.alternate_id != \"system@okta.com\"\n        AND okta.actor.alternate_id RLIKE \"[^@\\\\s]+\\\\@[^@\\\\s]+\"\n    )\n    AND okta.authentication_context.external_session_id != \"unknown\"\n| KEEP event.action, okta.actor.alternate_id, okta.authentication_context.external_session_id, okta.debug_context.debug_data.dt_hash\n| STATS\n    dt_hash_counts = COUNT_DISTINCT(okta.debug_context.debug_data.dt_hash) BY\n        okta.actor.alternate_id,\n        okta.authentication_context.external_session_id\n| WHERE\n    dt_hash_counts >= 2\n| SORT\n    dt_hash_counts DESC"
      },
      {
        "name": "Unusual High Confidence Content Filter Blocks Detected",
        "description": "Detects repeated high-confidence 'BLOCKED' actions coupled with specific 'Content Filter' policy violation having codes such as 'MISCONDUCT', 'HATE', 'SEXUAL', INSULTS', 'PROMPT_ATTACK', 'VIOLENCE' indicating persistent misuse or attempts to probe the model's ethical boundaries.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Amazon Bedrock Guardrail High Confidence Content Filter Blocks.\n\nAmazon Bedrock Guardrail is a set of features within Amazon Bedrock designed to help businesses apply robust safety and privacy controls to their generative AI applications.\n\nIt enables users to set guidelines and filters that manage content quality, relevancy, and adherence to responsible AI practices.\n\nThrough Guardrail, organizations can enable Content filter for Hate, Insults, Sexual Violence and Misconduct along with Prompt Attack filters prompts \nto prevent the model from generating content on specific, undesired subjects, and they can establish thresholds for harmful content categories.\n\n#### Possible investigation steps\n\n- Identify the user account whose prompts caused high confidence content filter blocks and whether it should perform this kind of action.\n- Investigate other alerts associated with the user account during the past 48 hours.\n- Consider the time of day. If the user is a human (not a program or script), did the activity take place during a normal time of day?\n- Examine the account's prompts and responses in the last 24 hours.\n- If you suspect the account has been compromised, scope potentially compromised assets by tracking Amazon Bedrock model access, prompts generated, and responses to the prompts by the account in the last 24 hours.\n\n### False positive analysis\n\n- Verify the user account that queried denied topics, is not testing any new model deployments or updated compliance policies in Amazon Bedrock guardrails.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Disable or limit the account during the investigation and response.\n- Identify the possible impact of the incident and prioritize accordingly; the following actions can help you gain context:\n    - Identify the account role in the cloud environment.\n    - Identify if the attacker is moving laterally and compromising other Amazon Bedrock Services.\n    - Identify any regulatory or legal ramifications related to this activity.\n- Review the permissions assigned to the implicated user group or role behind these requests to ensure they are authorized and expected to access bedrock and ensure that the least privilege principle is being followed.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection via the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 5,
        "tags": [
          "Domain: LLM",
          "Data Source: AWS Bedrock",
          "Data Source: AWS S3",
          "Use Case: Policy Violation",
          "Mitre Atlas: T0051",
          "Mitre Atlas: T0054"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-3600s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "New model deployments.",
          "Testing updates to compliance policies."
        ],
        "references": [
          "https://docs.aws.amazon.com/bedrock/latest/userguide/guardrails-components.html",
          "https://atlas.mitre.org/techniques/AML.T0051",
          "https://atlas.mitre.org/techniques/AML.T0054",
          "https://www.elastic.co/security-labs/elastic-advances-llm-security"
        ],
        "max_signals": 100,
        "threat": [],
        "setup": "## Setup\n\nThis rule requires that guardrails are configured in AWS Bedrock. For more information, see the AWS Bedrock documentation:\n\nhttps://docs.aws.amazon.com/bedrock/latest/userguide/guardrails-create.html\n",
        "related_integrations": [],
        "required_fields": [],
        "id": "8bfa6baa-b48e-4f13-bfb0-4930f81615d9",
        "rule_id": "4f855297-c8e0-4097-9d97-d653f7e471c4",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:31.877Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:30.325Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "esql",
        "language": "esql",
        "query": "from logs-aws_bedrock.invocation-*\n| MV_EXPAND gen_ai.compliance.violation_code\n| MV_EXPAND gen_ai.policy.confidence\n| MV_EXPAND gen_ai.policy.name \n| where gen_ai.policy.action == \"BLOCKED\" and gen_ai.policy.name == \"content_policy\" and gen_ai.policy.confidence LIKE \"HIGH\" and gen_ai.compliance.violation_code IN (\"HATE\", \"MISCONDUCT\", \"SEXUAL\", \"INSULTS\", \"PROMPT_ATTACK\", \"VIOLENCE\")\n| keep user.id, gen_ai.compliance.violation_code\n| stats block_count_per_violation = count() by user.id, gen_ai.compliance.violation_code \n| SORT block_count_per_violation DESC \n| keep user.id, gen_ai.compliance.violation_code, block_count_per_violation\n| STATS violation_count = SUM(block_count_per_violation) by user.id\n| WHERE violation_count > 5 \n| SORT violation_count DESC"
      },
      {
        "name": "AWS IAM AdministratorAccess Policy Attached to User",
        "description": "An adversary with access to a set of compromised credentials may attempt to persist or escalate privileges by attaching additional permissions to compromised user accounts. This rule looks for use of the IAM `AttachUserPolicy` API operation to attach the highly permissive `AdministratorAccess` AWS managed policy to an existing IAM user.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating AWS IAM AdministratorAccess Policy Attached to User\n\nThe AWS IAM `AdministratorAccess` managed policy provides full access to all AWS services and resources.\nWith access to the `iam:AttachUserPolicy` permission, a set of compromised credentials could be used to attach\nthis policy to the current user for privilege escalation or another user as a means of persistence. This rule uses [ES|QL](https://www.elastic.co/guide/en/security/master/rules-ui-create.html#create-esql-rule)\nto look for use of the `AttachUserPolicy` operation along with request_parameters where the policyName is `AdministratorAccess`.\n\n\n#### Possible investigation steps\n\n- Identify the account and its role in the environment.\n- Review IAM permission policies for the user identity.\n- Identify the applications or users that should use this account.\n- Investigate other alerts associated with the account during the past 48 hours.\n- Investigate abnormal values in the `user_agent.original` field by comparing them with the intended and authorized usage and historical data. Suspicious user agent values include non-SDK, AWS CLI, custom user agents, etc.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Considering the source IP address and geolocation of the user who issued the command:\n    - Do they look normal for the calling user?\n    - If the source is an EC2 IP address, is it associated with an EC2 instance in one of your accounts or is the source IP from an EC2 instance that's not under your control?\n    - If it is an authorized EC2 instance, is the activity associated with normal behavior for the instance role or roles? Are there any other alerts or signs of suspicious activity involving this instance?\n- If you suspect the account has been compromised, scope potentially compromised assets by tracking servers, services, and data accessed by the account in the last 24 hours.\n    - Determine what other API calls were made by the user.\n    - Assess whether this behavior is prevalent in the environment by looking for similar occurrences involving other users.\n\n### False positive analysis\n\n- False positives may occur due to the intended usage of the IAM `AdministratorAccess` managed policy. Verify the `aws.cloudtrail.user_identity.arn` should have the `iam:AttachUserPolicy` permission and that the `target.userName` should be given full administrative access.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Disable or limit the account during the investigation and response.\n    - Rotate user credentials\n    - Remove the `AdministratorAccess` policy from the affected user(s)\n- Identify the possible impact of the incident and prioritize accordingly; the following actions can help you gain context:\n    - Identify the account role in the cloud environment.\n    - Assess the criticality of affected services and servers.\n    - Work with your IT team to identify and minimize the impact on users.\n    - Identify if the attacker is moving laterally and compromising other accounts, servers, or services.\n    - Identify any regulatory or legal ramifications related to this activity.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified.\n    - Rotate secrets or delete API keys as needed to revoke the attacker's access to the environment.\n    - Work with your IT teams to minimize the impact on business operations during these actions.\n- Check if unauthorized new users were created, remove unauthorized new accounts, and request password resets for other IAM users.\n- Consider enabling multi-factor authentication for users.\n- Review the permissions assigned to the implicated user to ensure that the least privilege principle is being followed.\n- Implement security best practices [outlined](https://aws.amazon.com/premiumsupport/knowledge-center/security-best-practices/) by AWS.\n- Take the actions needed to return affected systems, data, or services to their normal operational levels.\n- Identify the initial vector abused by the attacker and take action to prevent reinfection via the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "investigation_fields": {
          "field_names": [
            "@timestamp",
            "user.name",
            "source.address",
            "aws.cloudtrail.user_identity.arn",
            "user_agent.original",
            "target.userName",
            "event.action",
            "policyName",
            "event.outcome",
            "cloud.region",
            "event.provider",
            "aws.cloudtrail.request_parameters"
          ]
        },
        "version": 4,
        "tags": [
          "Domain: Cloud",
          "Data Source: AWS",
          "Data Source: Amazon Web Services",
          "Data Source: AWS IAM",
          "Use Case: Identity and Access Audit",
          "Tactic: Privilege Escalation",
          "Tactic: Persistence",
          "Resources: Investigation Guide"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "While this can be normal behavior, it should be investigated to ensure validity. Verify whether the user identity should be using the IAM `AttachUserPolicy` API operation to attach the `AdministratorAccess` policy to the target user."
        ],
        "references": [
          "https://docs.aws.amazon.com/IAM/latest/APIReference/API_AttachUserPolicy.html",
          "https://docs.aws.amazon.com/aws-managed-policy/latest/reference/AdministratorAccess.html",
          "https://hackingthe.cloud/aws/exploitation/iam_privilege_escalation/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1098",
                "name": "Account Manipulation",
                "reference": "https://attack.mitre.org/techniques/T1098/",
                "subtechnique": [
                  {
                    "id": "T1098.003",
                    "name": "Additional Cloud Roles",
                    "reference": "https://attack.mitre.org/techniques/T1098/003/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1098",
                "name": "Account Manipulation",
                "reference": "https://attack.mitre.org/techniques/T1098/",
                "subtechnique": [
                  {
                    "id": "T1098.003",
                    "name": "Additional Cloud Roles",
                    "reference": "https://attack.mitre.org/techniques/T1098/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [],
        "required_fields": [],
        "id": "06c2621c-6f68-4936-988b-de5dd2fd047c",
        "rule_id": "9aa4be8d-5828-417d-9f54-7cd304571b24",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:31.880Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:40.803Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "esql",
        "language": "esql",
        "query": "from logs-aws.cloudtrail-* metadata _id, _version, _index\n| where event.provider == \"iam.amazonaws.com\" and event.action == \"AttachUserPolicy\" and event.outcome == \"success\"\n| dissect aws.cloudtrail.request_parameters \"{%{?policyArn}=%{?arn}:%{?aws}:%{?iam}::%{?aws}:%{?policy}/%{policyName},%{?userName}=%{target.userName}}\"\n| where policyName == \"AdministratorAccess\"\n| keep\n    @timestamp,\n    cloud.region,\n    event.provider,\n    event.action,\n    event.outcome,\n    policyName,\n    target.userName,\n    aws.cloudtrail.request_parameters,\n    aws.cloudtrail.user_identity.arn,\n    related.user,\n    user_agent.original,\n    user.name,\n    source.address"
      },
      {
        "name": "AWS Bedrock Detected Multiple Attempts to use Denied Models by a Single User",
        "description": "Identifies multiple successive failed attempts to use denied model resources within AWS Bedrock. This could indicated attempts to bypass limitations of other approved models, or to force an impact on the environment by incurring exhorbitant costs.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Attempt to use Denied Amazon Bedrock Models.\n\nAmazon Bedrock is AWS’s managed service that enables developers to build and scale generative AI applications using large foundation models (FMs) from top providers.\n\nBedrock offers a variety of pretrained models from Amazon (such as the Titan series), as well as models from providers like Anthropic, Meta, Cohere, and AI21 Labs.\n\n#### Possible investigation steps\n\n- Identify the user account that attempted to use denied models.\n- Investigate other alerts associated with the user account during the past 48 hours.\n- Consider the time of day. If the user is a human (not a program or script), did the activity take place during a normal time of day?\n- Examine the account's attempts to access Amazon Bedrock models in the last 24 hours.\n- If you suspect the account has been compromised, scope potentially compromised assets by tracking Amazon Bedrock model access, prompts generated, and responses to the prompts by the account in the last 24 hours.\n\n### False positive analysis\n\n- Verify the user account that attempted to use denied models, is a legitimate misunderstanding by users or overly strict policies.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Disable or limit the account during the investigation and response.\n- Identify the possible impact of the incident and prioritize accordingly; the following actions can help you gain context:\n    - Identify the account role in the cloud environment.\n    - Identify if the attacker is moving laterally and compromising other Amazon Bedrock Services.\n    - Identify any regulatory or legal ramifications related to this activity.\n- Review the permissions assigned to the implicated user group or role behind these requests to ensure they are authorized and expected to access bedrock and ensure that the least privilege principle is being followed.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection via the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "investigation_fields": {
          "field_names": [
            "user.id",
            "cloud.account.id",
            "gen_ai.request.model.id",
            "total_denials"
          ]
        },
        "version": 3,
        "tags": [
          "Domain: LLM",
          "Data Source: AWS Bedrock",
          "Data Source: AWS S3",
          "Resources: Investigation Guide",
          "Use Case: Policy Violation",
          "Mitre Atlas: T0015",
          "Mitre Atlas: T0034"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-3600s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Legitimate misunderstanding by users or overly strict policies"
        ],
        "references": [
          "https://docs.aws.amazon.com/bedrock/latest/userguide/guardrails-components.html",
          "https://atlas.mitre.org/techniques/AML.T0015",
          "https://atlas.mitre.org/techniques/AML.T0034",
          "https://www.elastic.co/security-labs/elastic-advances-llm-security"
        ],
        "max_signals": 100,
        "threat": [],
        "setup": "## Setup\n\nThis rule requires that guardrails are configured in AWS Bedrock. For more information, see the AWS Bedrock documentation:\n\nhttps://docs.aws.amazon.com/bedrock/latest/userguide/guardrails-create.html\n",
        "related_integrations": [],
        "required_fields": [],
        "id": "b4d1b1ab-d2a3-4a09-9ef3-47ed9aadd70c",
        "rule_id": "17261da3-a6d0-463c-aac8-ea1718afcd20",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:31.883Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:24.396Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "esql",
        "language": "esql",
        "query": "from logs-aws_bedrock.invocation-*\n| where gen_ai.response.error_code == \"AccessDeniedException\"\n| keep user.id, gen_ai.request.model.id, cloud.account.id, gen_ai.response.error_code\n| stats total_denials = count(*) by user.id, gen_ai.request.model.id, cloud.account.id\n| where total_denials > 3\n| sort total_denials desc"
      },
      {
        "name": "AWS Bedrock Detected Multiple Validation Exception Errors by a Single User",
        "description": "Identifies multiple validation exeception errors within AWS Bedrock. Validation errors occur when you run the InvokeModel or InvokeModelWithResponseStream APIs on a foundation model that uses an incorrect inference parameter or corresponding value. These errors also occur when you use an inference parameter for one model with a model that doesn't have the same API parameter. This could indicate attempts to bypass limitations of other approved models, or to force an impact on the environment by incurring exhorbitant costs.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Amazon Bedrock Model Validation Exception Errors.\n\nAmazon Bedrock is AWS’s managed service that enables developers to build and scale generative AI applications using large foundation models (FMs) from top providers.\n\nBedrock offers a variety of pretrained models from Amazon (such as the Titan series), as well as models from providers like Anthropic, Meta, Cohere, and AI21 Labs.\n\n#### Possible investigation steps\n\n- Identify the user account that caused validation errors in accessing the Amazon Bedrock models.\n- Investigate other alerts associated with the user account during the past 48 hours.\n- Consider the time of day. If the user is a human (not a program or script), did the activity take place during a normal time of day?\n- Examine the account's attempts to access Amazon Bedrock models in the last 24 hours.\n- If you suspect the account has been compromised, scope potentially compromised assets by tracking Amazon Bedrock model access, prompts generated, and responses to the prompts by the account in the last 24 hours.\n\n### False positive analysis\n\n- Verify the user account that that caused validation errors is a legitimate misunderstanding by users on accessing the bedrock models.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Disable or limit the account during the investigation and response.\n- Identify the possible impact of the incident and prioritize accordingly; the following actions can help you gain context:\n    - Identify the account role in the cloud environment.\n    - Identify if the attacker is moving laterally and compromising other Amazon Bedrock Services.\n    - Identify any regulatory or legal ramifications related to this activity.\n    - Identify if any implication to resource billing.\n- Review the permissions assigned to the implicated user group or role behind these requests to ensure they are authorized and expected to access bedrock and ensure that the least privilege principle is being followed.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection via the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "investigation_fields": {
          "field_names": [
            "target_time_window",
            "user.id",
            "cloud.account.id",
            "total_denials"
          ]
        },
        "version": 3,
        "tags": [
          "Domain: LLM",
          "Data Source: AWS",
          "Data Source: AWS Bedrock",
          "Data Source: AWS S3",
          "Use Case: Policy Violation",
          "Mitre Atlas: T0015",
          "Mitre Atlas: T0034",
          "Mitre Atlas: T0046"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-3600s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Legitimate misunderstanding by users on accessing the bedrock models."
        ],
        "references": [
          "https://atlas.mitre.org/techniques/AML.T0015",
          "https://atlas.mitre.org/techniques/AML.T0034",
          "https://atlas.mitre.org/techniques/AML.T0046",
          "https://www.elastic.co/security-labs/elastic-advances-llm-security"
        ],
        "max_signals": 100,
        "threat": [],
        "setup": "## Setup\n\nThis rule requires that AWS Bedrock Integration be configured. For more information, see the AWS Bedrock integration documentation:\n\nhttps://www.elastic.co/docs/current/integrations/aws_bedrock\n",
        "related_integrations": [],
        "required_fields": [],
        "id": "9329075d-ba80-4db9-ac1e-bfcdc794b099",
        "rule_id": "725a048a-88c5-4fc7-8677-a44fc0031822",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:31.885Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:36.404Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "esql",
        "language": "esql",
        "query": "from logs-aws_bedrock.invocation-*\n// truncate the timestamp to a 1-minute window\n| eval target_time_window = DATE_TRUNC(1 minutes, @timestamp)\n| where gen_ai.response.error_code == \"ValidationException\"\n| keep user.id, gen_ai.request.model.id, cloud.account.id, gen_ai.response.error_code, target_time_window\n// count the number of users causing validation errors within a 1 minute window\n| stats total_denials = count(*) by target_time_window, user.id, cloud.account.id\n| where total_denials > 3"
      },
      {
        "name": "Cupsd or Foomatic-rip Shell Execution",
        "description": "This detection rule addresses multiple vulnerabilities in the CUPS printing system, including CVE-2024-47176, CVE-2024-47076, CVE-2024-47175, and CVE-2024-47177. Specifically, this rule detects shell executions from the foomatic-rip parent process. These flaws impact components like cups-browsed, libcupsfilters, libppd, and foomatic-rip, allowing remote unauthenticated attackers to manipulate IPP URLs or inject malicious data through crafted UDP packets or network spoofing. This can result in arbitrary command execution when a print job is initiated.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Cupsd or Foomatic-rip Shell Execution\n\nThis rule identifies potential exploitation attempts of several vulnerabilities in the CUPS printing system (CVE-2024-47176, CVE-2024-47076, CVE-2024-47175, CVE-2024-47177). These vulnerabilities allow attackers to send crafted IPP requests or manipulate UDP packets to execute arbitrary commands or modify printer configurations. Attackers can exploit these flaws to inject malicious data, leading to Remote Code Execution (RCE) on affected systems.\n\n#### Possible Investigation Steps\n\n- Investigate the incoming IPP requests or UDP packets targeting port 631.\n- Examine the printer configurations on the system to determine if any unauthorized printers or URLs have been added.\n- Investigate the process tree to check if any unexpected processes were triggered as a result of IPP activity. Review the executable files for legitimacy.\n- Check for additional alerts related to the compromised system or user within the last 48 hours.\n- Investigate network traffic logs for suspicious outbound connections to unrecognized domains or IP addresses.\n- Check if any of the contacted domains or addresses are newly registered or have a suspicious reputation.\n- Retrieve any scripts or executables dropped by the attack for further analysis in a private sandbox environment:\n- Analyze potential malicious activity, including:\n  - Attempts to communicate with external servers.\n  - File access or creation of unauthorized executables.\n  - Cron jobs, services, or other persistence mechanisms.\n\n### Related Rules\n- Printer User (lp) Shell Execution - f86cd31c-5c7e-4481-99d7-6875a3e31309\n- Network Connection by Cups or Foomatic-rip Child - e80ee207-9505-49ab-8ca8-bc57d80e2cab\n- File Creation by Cups or Foomatic-rip Child - b9b14be7-b7f4-4367-9934-81f07d2f63c4\n- Suspicious Execution from Foomatic-rip or Cupsd Parent - 986361cd-3dac-47fe-afa1-5c5dd89f2fb4\n\n### False Positive Analysis\n\n- This activity is rarely legitimate. However, verify the context to rule out non-malicious printer configuration changes or legitimate IPP requests.\n\n### Response and Remediation\n\n- Initiate the incident response process based on the triage outcome.\n- Isolate the compromised host to prevent further exploitation.\n- If the investigation confirms malicious activity, search the environment for additional compromised hosts.\n- Implement network segmentation or restrictions to contain the attack.\n- Stop suspicious processes or services tied to CUPS exploitation.\n- Block identified Indicators of Compromise (IoCs), including IP addresses, domains, or hashes of involved files.\n- Review compromised systems for backdoors, such as reverse shells or persistence mechanisms like cron jobs.\n- Investigate potential credential exposure on compromised systems and reset passwords for any affected accounts.\n- Restore the original printer configurations or uninstall unauthorized printer entries.\n- Perform a thorough antimalware scan to identify any lingering threats or artifacts from the attack.\n- Investigate how the attacker gained initial access and address any weaknesses to prevent future exploitation.\n- Use insights from the incident to improve detection and response times in future incidents (MTTD and MTTR).\n",
        "output_index": "",
        "version": 2,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Use Case: Vulnerability",
          "Tactic: Execution",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/security-labs/cups-overflow",
          "https://www.evilsocket.net/2024/09/26/Attacking-UNIX-systems-via-CUPS-Part-I/",
          "https://gist.github.com/stong/c8847ef27910ae344a7b5408d9840ee1",
          "https://github.com/RickdeJager/cupshax/blob/main/cupshax.py"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1203",
                "name": "Exploitation for Client Execution",
                "reference": "https://attack.mitre.org/techniques/T1203/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "c3a85e16-accc-44e6-b9b6-d3468cc77398",
        "rule_id": "476267ff-e44f-476e-99c1-04c78cb3769d",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:31.888Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:30.198Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\nprocess.parent.name == \"foomatic-rip\" and\nprocess.name in (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\") and not (\n  process.command_line like (\n    \"*/tmp/foomatic-*\", \"*-sDEVICE=ps2write*\", \"*printf*\", \"/bin/sh -e -c cat\", \"/bin/bash -c cat\",\n    \"/bin/bash -e -c cat\"\n  ) or\n  process.args like \"gs*\"\n)",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "AWS IAM User Created Access Keys For Another User",
        "description": "An adversary with access to a set of compromised credentials may attempt to persist or escalate privileges by creating a new set of credentials for an existing user. This rule looks for use of the IAM `CreateAccessKey` API operation to create new programmatic access keys for another IAM user.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating AWS IAM User Created Access Keys For Another User\n\nAWS access keys created for IAM users or root user are long-term credentials that provide programmatic access to AWS.\nWith access to the `iam:CreateAccessKey` permission, a set of compromised credentials could be used to create a new\nset of credentials for another user for privilege escalation or as a means of persistence. This rule uses [ES|QL](https://www.elastic.co/guide/en/security/master/rules-ui-create.html#create-esql-rule)\nto look for use of the `CreateAccessKey` operation where the user.name is different from the user.target.name.\n\n\n#### Possible investigation steps\n\n- Identify both related accounts and their role in the environment.\n- Review IAM permission policies for the user identities.\n- Identify the applications or users that should use these accounts.\n- Investigate other alerts associated with the accounts during the past 48 hours.\n- Investigate abnormal values in the `user_agent.original` field by comparing them with the intended and authorized usage and historical data. Suspicious user agent values include non-SDK, AWS CLI, custom user agents, etc.\n- Contact the account owners and confirm whether they are aware of this activity.\n- Considering the source IP address and geolocation of the user who issued the command:\n    - Do they look normal for the calling user?\n    - If the source is an EC2 IP address, is it associated with an EC2 instance in one of your accounts or is the source IP from an EC2 instance that's not under your control?\n    - If it is an authorized EC2 instance, is the activity associated with normal behavior for the instance role or roles? Are there any other alerts or signs of suspicious activity involving this instance?\n- If you suspect the account has been compromised, scope potentially compromised assets by tracking servers, services, and data accessed by the account in the last 24 hours.\n    - Determine what other API calls were made by the user.\n    - Assess whether this behavior is prevalent in the environment by looking for similar occurrences involving other users.\n\n### False positive analysis\n\n- False positives may occur due to the intended usage of the IAM `CreateAccessKey` operation. Verify the `aws.cloudtrail.user_identity.arn` should use this operation against the `user.target.name` account.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Disable or limit the account during the investigation and response.\n    - Rotate user credentials\n    - Remove the newly created credentials from the affected user(s)\n- Identify the possible impact of the incident and prioritize accordingly; the following actions can help you gain context:\n    - Identify the account role in the cloud environment.\n    - Assess the criticality of affected services and servers.\n    - Work with your IT team to identify and minimize the impact on users.\n    - Identify if the attacker is moving laterally and compromising other accounts, servers, or services.\n    - Identify any regulatory or legal ramifications related to this activity.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified.\n    - Rotate secrets or delete API keys as needed to revoke the attacker's access to the environment.\n    - Work with your IT teams to minimize the impact on business operations during these actions.\n- Remove unauthorized new accounts, and request password resets for other IAM users.\n- Consider enabling multi-factor authentication for users.\n- Review the permissions assigned to the implicated user to ensure that the least privilege principle is being followed.\n- Implement security best practices [outlined](https://aws.amazon.com/premiumsupport/knowledge-center/security-best-practices/) by AWS.\n- Take the actions needed to return affected systems, data, or services to their normal operational levels.\n- Identify the initial vector abused by the attacker and take action to prevent reinfection via the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "investigation_fields": {
          "field_names": [
            "@timestamp",
            "user.name",
            "source.address",
            "aws.cloudtrail.user_identity.arn",
            "aws.cloudtrail.user_identity.type",
            "user_agent.original",
            "user.target.name",
            "event.action",
            "event.outcome",
            "cloud.region",
            "event.provider",
            "aws.cloudtrail.request_parameters",
            "aws.cloudtrail.response_elements"
          ]
        },
        "version": 5,
        "tags": [
          "Domain: Cloud",
          "Data Source: AWS",
          "Data Source: Amazon Web Services",
          "Data Source: AWS IAM",
          "Use Case: Identity and Access Audit",
          "Tactic: Privilege Escalation",
          "Tactic: Persistence",
          "Resources: Investigation Guide"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "While this can be normal behavior, it should be investigated to ensure validity. Verify whether the user identity should be using the IAM `CreateAccessKey` for the targeted user."
        ],
        "references": [
          "https://hackingthe.cloud/aws/exploitation/iam_privilege_escalation/#iamcreateaccesskey",
          "https://cloud.hacktricks.xyz/pentesting-cloud/aws-security/aws-persistence/aws-iam-persistence",
          "https://permiso.io/blog/lucr-3-scattered-spider-getting-saas-y-in-the-cloud",
          "https://docs.aws.amazon.com/IAM/latest/APIReference/API_CreateAccessKey.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1098",
                "name": "Account Manipulation",
                "reference": "https://attack.mitre.org/techniques/T1098/",
                "subtechnique": [
                  {
                    "id": "T1098.001",
                    "name": "Additional Cloud Credentials",
                    "reference": "https://attack.mitre.org/techniques/T1098/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1098",
                "name": "Account Manipulation",
                "reference": "https://attack.mitre.org/techniques/T1098/",
                "subtechnique": [
                  {
                    "id": "T1098.001",
                    "name": "Additional Cloud Credentials",
                    "reference": "https://attack.mitre.org/techniques/T1098/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [],
        "required_fields": [],
        "id": "62d347e1-71af-4230-9dfe-6ecca7923f8a",
        "rule_id": "696015ef-718e-40ff-ac4a-cc2ba88dbeeb",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:31.891Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:35.347Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "esql",
        "language": "esql",
        "query": "from logs-aws.cloudtrail-* metadata _id, _version, _index\n| where event.provider == \"iam.amazonaws.com\"\n    and event.action == \"CreateAccessKey\"\n    and event.outcome == \"success\"\n    and user.name != user.target.name\n| keep\n    @timestamp,\n    cloud.region,\n    event.provider,\n    event.action,\n    event.outcome,\n    user.name,\n    source.address,\n    user.target.name,\n    user_agent.original,\n    aws.cloudtrail.request_parameters,\n    aws.cloudtrail.response_elements,\n    aws.cloudtrail.user_identity.arn,\n    aws.cloudtrail.user_identity.type"
      },
      {
        "name": "Encrypting Files with WinRar or 7z",
        "description": "Identifies use of WinRar or 7z to create an encrypted files. Adversaries will often compress and encrypt data in preparation for exfiltration.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Encrypting Files with WinRar or 7z\n\nAttackers may compress and/or encrypt data collected before exfiltration. Compressing the data can help obfuscate the collected data and minimize the amount of data sent over the network. Encryption can be used to hide information that is being exfiltrated from detection or make exfiltration less apparent upon inspection by a defender.\n\nThese steps are usually done in preparation for exfiltration, meaning the attack may be in its final stages.\n\n#### Possible investigation steps\n\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Retrieve the encrypted file.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Check if the password used in the encryption was included in the command line.\n- Decrypt the `.rar`/`.zip` and check if the information is sensitive.\n- If the password is not available, and the format is `.zip` or the option used in WinRAR is not the `-hp`, list the file names included in the encrypted file.\n- Investigate if the file was transferred to an attacker-controlled server.\n\n### False positive analysis\n\n- Backup software can use these utilities. Check the `process.parent.executable` and `process.parent.command_line` fields to determine what triggered the encryption.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Prioritize cases that involve personally identifiable information (PII) or other classified data.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 214,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Collection",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: SentinelOne"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.welivesecurity.com/2020/12/02/turla-crutch-keeping-back-door-open/",
          "https://www.elastic.co/security-labs/siestagraph-new-implant-uncovered-in-asean-member-foreign-ministry"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0009",
              "name": "Collection",
              "reference": "https://attack.mitre.org/tactics/TA0009/"
            },
            "technique": [
              {
                "id": "T1005",
                "name": "Data from Local System",
                "reference": "https://attack.mitre.org/techniques/T1005/"
              },
              {
                "id": "T1560",
                "name": "Archive Collected Data",
                "reference": "https://attack.mitre.org/techniques/T1560/",
                "subtechnique": [
                  {
                    "id": "T1560.001",
                    "name": "Archive via Utility",
                    "reference": "https://attack.mitre.org/techniques/T1560/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.code_signature.subject_name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "2b304526-849a-4c5d-85e8-13dd4f2f63cf",
        "rule_id": "45d273fb-1dca-457d-9855-bcb302180c21",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:31.894Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:30.180Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n(\n  (\n    (\n      process.name:\"rar.exe\" or ?process.code_signature.subject_name == \"win.rar GmbH\" or\n      ?process.pe.original_file_name == \"Command line RAR\"\n    ) and\n    process.args == \"a\" and process.args : (\"-hp*\", \"-p*\", \"/hp*\", \"/p*\")\n  ) or\n  (\n    (process.name : (\"7z.exe\", \"7za.exe\") or ?process.pe.original_file_name in (\"7z.exe\", \"7za.exe\")) and\n    process.args == \"a\" and process.args : \"-p*\"\n  )\n) and\n  not process.parent.executable : (\n        \"C:\\\\Program Files\\\\*.exe\",\n        \"C:\\\\Program Files (x86)\\\\*.exe\",\n        \"?:\\\\ManageEngine\\\\*\\\\jre\\\\bin\\\\java.exe\",\n        \"?:\\\\Nox\\\\bin\\\\Nox.exe\",\n        \"\\\\Device\\\\HarddiskVolume?\\\\Program Files\\\\*.exe\",\n        \"\\\\Device\\\\HarddiskVolume?\\\\Program Files (x86)\\\\*.exe\",\n        \"\\\\Device\\\\HarddiskVolume?\\\\ManageEngine\\\\*\\\\jre\\\\bin\\\\java.exe\",\n        \"\\\\Device\\\\HarddiskVolume?\\\\Nox\\\\bin\\\\Nox.exe\"\n      )",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "winlogbeat-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*"
        ],
        "filters": []
      },
      {
        "name": "Privilege Escalation via SUID/SGID",
        "description": "Identifies instances where a process is executed with user/group ID 0 (root), and a real user/group ID that is not 0. This is indicative of a process that has been granted SUID/SGID permissions, allowing it to run with elevated privileges. Attackers may leverage a misconfiguration for exploitation in order to escalate their privileges to root, or establish a backdoor for persistence.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 105,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Tactic: Persistence",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://gtfobins.github.io/#+suid",
          "https://www.elastic.co/security-labs/primer-on-persistence-mechanisms"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1068",
                "name": "Exploitation for Privilege Escalation",
                "reference": "https://attack.mitre.org/techniques/T1068/"
              },
              {
                "id": "T1548",
                "name": "Abuse Elevation Control Mechanism",
                "reference": "https://attack.mitre.org/techniques/T1548/",
                "subtechnique": [
                  {
                    "id": "T1548.001",
                    "name": "Setuid and Setgid",
                    "reference": "https://attack.mitre.org/techniques/T1548/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            }
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.group.id",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.real_group.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.real_user.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "29592db6-5b0b-4ed4-97dc-aeddfcdd9555",
        "rule_id": "28eb3afe-131d-48b0-a8fc-9784f3d54f3c",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:31.898Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:26.602Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and (\n  (process.user.id == \"0\" and process.real_user.id != \"0\") or \n  (process.group.id == \"0\" and process.real_group.id != \"0\")\n) and (\n  process.name in (\n    \"aa-exec\", \"ab\", \"agetty\", \"alpine\", \"ar\", \"arj\", \"arp\", \"as\", \"ascii-xfr\", \"ash\", \"aspell\",\n    \"atobm\", \"awk\", \"base32\", \"base64\", \"basenc\", \"basez\", \"bash\", \"bc\", \"bridge\", \"busctl\",\n    \"busybox\", \"bzip2\", \"cabal\", \"capsh\", \"cat\", \"choom\", \"chown\", \"chroot\", \"clamscan\", \"cmp\",\n    \"column\", \"comm\", \"cp\", \"cpio\", \"cpulimit\", \"csh\", \"csplit\", \"csvtool\", \"cupsfilter\", \"curl\",\n    \"cut\", \"dash\", \"date\", \"dd\", \"debugfs\", \"dialog\", \"diff\", \"dig\", \"distcc\", \"dmsetup\", \"docker\",\n    \"dosbox\", \"ed\", \"efax\", \"elvish\", \"emacs\", \"env\", \"eqn\", \"espeak\", \"expand\", \"expect\", \"file\",\n    \"find\", \"fish\", \"flock\", \"fmt\", \"fold\", \"gawk\", \"gcore\", \"gdb\", \"genie\", \"genisoimage\", \"gimp\",\n    \"grep\", \"gtester\", \"gzip\", \"hd\", \"head\", \"hexdump\", \"highlight\", \"hping3\", \"iconv\", \"install\",\n    \"ionice\", \"ispell\", \"jjs\", \"join\", \"jq\", \"jrunscript\", \"julia\", \"ksh\", \"ksshell\", \"kubectl\",\n    \"ld.so\", \"less\", \"links\", \"logsave\", \"look\", \"lua\", \"make\", \"mawk\", \"minicom\", \"more\",\n    \"mosquitto\", \"msgattrib\", \"msgcat\", \"msgconv\", \"msgfilter\", \"msgmerge\", \"msguniq\", \"multitime\",\n    \"mv\", \"nasm\", \"nawk\", \"ncftp\", \"nft\", \"nice\", \"nl\", \"nm\", \"nmap\", \"node\", \"nohup\", \"ntpdate\",\n    \"od\", \"openssl\", \"openvpn\", \"pandoc\", \"paste\", \"perf\", \"perl\", \"pexec\", \"pg\", \"php\", \"pidstat\",\n    \"pr\", \"ptx\", \"python\", \"rc\", \"readelf\", \"restic\", \"rev\", \"rlwrap\", \"rsync\", \"rtorrent\",\n    \"run-parts\", \"rview\", \"rvim\", \"sash\", \"scanmem\", \"sed\", \"setarch\", \"setfacl\", \"setlock\", \"shuf\",\n    \"soelim\", \"softlimit\", \"sort\", \"sqlite3\", \"ss\", \"ssh-agent\", \"ssh-keygen\", \"ssh-keyscan\",\n    \"sshpass\", \"start-stop-daemon\", \"stdbuf\", \"strace\", \"strings\", \"sysctl\", \"systemctl\", \"tac\",\n    \"tail\", \"taskset\", \"tbl\", \"tclsh\", \"tee\", \"terraform\", \"tftp\", \"tic\", \"time\", \"timeout\", \"troff\",\n    \"ul\", \"unexpand\", \"uniq\", \"unshare\", \"unsquashfs\", \"unzip\", \"update-alternatives\", \"uudecode\",\n    \"uuencode\", \"vagrant\", \"varnishncsa\", \"view\", \"vigr\", \"vim\", \"vimdiff\", \"vipw\", \"w3m\", \"watch\",\n    \"wc\", \"wget\", \"whiptail\", \"xargs\", \"xdotool\", \"xmodmap\", \"xmore\", \"xxd\", \"xz\", \"yash\", \"zsh\",\n    \"zsoelim\"\n  ) or \n  process.name == \"ip\" and (\n    (process.args == \"-force\" and process.args in (\"-batch\", \"-b\")) or (process.args == \"exec\")\n  )\n) and not process.parent.name == \"spine\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Multiple Okta User Auth Events with Same Device Token Hash Behind a Proxy",
        "description": "Detects when Okta user authentication events are reported for multiple users with the same device token hash behind a proxy.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Multiple Okta User Auth Events with Same Device Token Hash Behind a Proxy\n\nThis rule detects when Okta user authentication events are reported for multiple users with the same device token hash behind a proxy. This may indicate that a shared device between users, or that a user is using a proxy to access multiple accounts for password spraying.\n\n#### Possible investigation steps:\n- Identify the users involved in this action by examining the `okta.actor.id`, `okta.actor.type`, `okta.actor.alternate_id`, and `okta.actor.display_name` fields.\n- Determine the device client used for these actions by analyzing `okta.client.ip`, `okta.client.user_agent.raw_user_agent`, `okta.client.zone`, `okta.client.device`, and `okta.client.id` fields.\n    - Since the device is behind a proxy, the `okta.client.ip` field will not be useful for determining the actual device IP address.\n- Review the `okta.request.ip_chain` field for more information about the geographic location of the proxy.\n- With Okta end users identified, review the `okta.debug_context.debug_data.dt_hash` field.\n    - Historical analysis should indicate if this device token hash is commonly associated with the user.\n- Review the `okta.event_type` field to determine the type of authentication event that occurred.\n    - If the event type is `user.authentication.sso`, the user may have legitimately started a session via a proxy for security or privacy reasons.\n    - If the event type is `user.authentication.password`, the user may be using a proxy to access multiple accounts for password spraying.\n- Examine the `okta.outcome.result` field to determine if the authentication was successful.\n- Review the past activities of the actor(s) involved in this action by checking their previous actions.\n- Evaluate the actions that happened just before and after this event in the `okta.event_type` field to help understand the full context of the activity.\n    - This may help determine the authentication and authorization actions that occurred between the user, Okta and application.\n\n### False positive analysis:\n- A user may have legitimately started a session via a proxy for security or privacy reasons.\n- Users may share an endpoint related to work or personal use in which separate Okta accounts are used.\n    - Architecturally, this shared endpoint may leverage a proxy for security or privacy reasons.\n    - Shared systems such as Kiosks and conference room computers may be used by multiple users.\n    - Shared working spaces may have a single endpoint that is used by multiple users.\n\n### Response and remediation:\n- Review the profile of the users involved in this action to determine if proxy usage may be expected.\n- If the user is legitimate and the authentication behavior is not suspicious based on device analysis, no action is required.\n- If the user is legitimate but the authentication behavior is suspicious, consider resetting passwords for the users involves and enabling multi-factor authentication (MFA).\n    - If MFA is already enabled, consider resetting MFA for the users.\n- If any of the users are not legitimate, consider deactivating the user's account.\n- Conduct a review of Okta policies and ensure they are in accordance with security best practices.\n- Check with internal IT teams to determine if the accounts involved recently had MFA reset at the request of the user.\n    - If so, confirm with the user this was a legitimate request.\n    - If so and this was not a legitimate request, consider deactivating the user's account temporarily.\n        - Reset passwords and reset MFA for the user.\n- If this is a false positive, consider adding the `okta.debug_context.debug_data.dt_hash` field to the `exceptions` list in the rule.\n    - This will prevent future occurrences of this event for this device from triggering the rule.\n",
        "output_index": "",
        "version": 206,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Data Source: Okta",
          "Tactic: Credential Access"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "An Okta admnistrator may be logged into multiple accounts from the same host for legitimate reasons.",
          "Users may share an endpoint related to work or personal use in which separate Okta accounts are used.",
          "Shared systems such as Kiosks and conference room computers may be used by multiple users."
        ],
        "references": [
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://sec.okta.com/articles/2023/08/cross-tenant-impersonation-prevention-and-detection",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1110",
                "name": "Brute Force",
                "reference": "https://attack.mitre.org/techniques/T1110/",
                "subtechnique": [
                  {
                    "id": "T1110.003",
                    "name": "Password Spraying",
                    "reference": "https://attack.mitre.org/techniques/T1110/003/"
                  }
                ]
              },
              {
                "id": "T1110",
                "name": "Brute Force",
                "reference": "https://attack.mitre.org/techniques/T1110/",
                "subtechnique": [
                  {
                    "id": "T1110.004",
                    "name": "Credential Stuffing",
                    "reference": "https://attack.mitre.org/techniques/T1110/004/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "okta.actor.id",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "okta.debug_context.debug_data.dt_hash",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "okta.event_type",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "okta.security_context.is_proxy",
            "type": "boolean",
            "ecs": false
          }
        ],
        "id": "49f5468e-6308-42dc-8af4-e35f6ac1b25f",
        "rule_id": "50887ba8-7ff7-11ee-a038-f661ea17fbcd",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:31.901Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:30.329Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "threshold",
        "query": "event.dataset:okta.system\n    and not okta.actor.id:okta* and okta.debug_context.debug_data.dt_hash:*\n    and okta.event_type:user.authentication* and okta.security_context.is_proxy:true",
        "threshold": {
          "field": [
            "okta.debug_context.debug_data.dt_hash"
          ],
          "value": 1,
          "cardinality": [
            {
              "field": "okta.actor.id",
              "value": 3
            }
          ]
        },
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Stolen Credentials Used to Login to Okta Account After MFA Reset",
        "description": "Detects a sequence of suspicious activities on Windows hosts indicative of credential compromise, followed by efforts to undermine multi-factor authentication (MFA) and single sign-on (SSO) mechanisms for an Okta user account.",
        "risk_score": 73,
        "severity": "high",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Stolen Credentials Used to Login to Okta Account After MFA Reset\n\nThis rule detects a sequence of suspicious activities on Windows hosts indicative of credential compromise, followed by efforts to undermine multi-factor authentication (MFA) and single sign-on (SSO) mechanisms for an Okta user account.\n\nTypically, adversaries initially extract credentials from targeted endpoints through various means. Subsequently, leveraging social engineering, they may seek to reset the MFA credentials associated with an Okta account, especially in scenarios where Active Directory (AD) services are integrated with Okta. Successfully resetting MFA allows the unauthorized use of stolen credentials to gain access to the compromised Okta account. The attacker can then register their own device for MFA, paving the way for unfettered access to the user's Okta account and any associated SaaS applications. This is particularly alarming if the compromised account has administrative rights, as it could lead to widespread access to organizational resources and configurations.\n\n#### Possible investigation steps:\n- Identify the user account associated with the Okta login attempt by examining the `user.name` field.\n- Identify the endpoint for the Credential Access alert for this user by examining the `host.name` and `host.id` fields from the alert document.\n- Cross-examine the Okta user and endpoint user to confirm that they are the same person.\n- Reach out to the user to confirm if they have intentionally reset their MFA credentials recently or asked for help in doing so.\n- If the user is unaware of the MFA reset, incident response may be required immediately to prevent further compromise.\n\n### False positive analysis:\n- A Windows administrator may have triggered a low-fidelity credential access alert during a legitimate administrative action. Following this, the administrator may have reset the MFA credentials for themselves and then logged into the Okta console for AD directory services integration management.\n\n### Response and remediation:\n- If confirmed that the user did not intentionally have their MFA factor reset, deactivate the user account.\n- After deactivation, reset the user's password and MFA factor to regain control of the account.\n    - Ensure that all user sessions are stopped during this process.\n- Immediately reset the user's AD password as well if Okta does not sync back to AD.\n- Forensic analysis on the user's endpoint may be required to determine the root cause of the compromise and identify the scope of the compromise.\n- Review Okta system logs to identify any other suspicious activity associated with the user account, such as creation of a backup account.\n- With the device ID captured from the MFA factor reset, search across all Okta logs for any other activity associated with the device ID.\n\n## Setup",
        "output_index": "",
        "version": 205,
        "tags": [
          "Tactic: Persistence",
          "Use Case: Identity and Access Audit",
          "Data Source: Okta",
          "Data Source: Elastic Defend",
          "Rule Type: Higher-Order Rule",
          "Domain: Endpoint",
          "Domain: Cloud"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "6h",
        "from": "now-43200s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "A Windows administrator may have triggered a low-fidelity credential access alert during a legitimate administrative action. Following this, the administrator may have reset the MFA credentials for themselves and then logged into the Okta console for AD directory services integration management."
        ],
        "references": [
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://sec.okta.com/articles/2023/08/cross-tenant-impersonation-prevention-and-detection",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1556",
                "name": "Modify Authentication Process",
                "reference": "https://attack.mitre.org/techniques/T1556/",
                "subtechnique": [
                  {
                    "id": "T1556.006",
                    "name": "Multi-Factor Authentication",
                    "reference": "https://attack.mitre.org/techniques/T1556/006/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The Okta and Elastic Defend fleet integration structured data is required to be compatible with this rule. Directory services integration in Okta with AD synced is also required for this rule to be effective as it relies on triaging `user.name` from Okta and Elastic Defend events.",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "okta.event_type",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "signal.rule.threat.tactic.name",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "user.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "792bef44-26b7-4896-a61e-0e00ac8ba6aa",
        "rule_id": "5610b192-7f18-11ee-825b-f661ea17fbcd",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:31.904Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:32.295Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by user.name with maxspan=12h\n    [any where host.os.type == \"windows\" and signal.rule.threat.tactic.name == \"Credential Access\"]\n    [any where event.dataset == \"okta.system\" and okta.event_type == \"user.mfa.factor.update\"]\n    [any where event.dataset == \"okta.system\" and okta.event_type: (\"user.session.start\", \"user.authentication*\")]",
        "language": "eql",
        "index": [
          "filebeat-*",
          "logs-okta*",
          ".alerts-security.*",
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "AWS STS GetCallerIdentity API Called for the First Time",
        "description": "An adversary with access to a set of compromised credentials may attempt to verify that the credentials are valid and determine what account they are using. This rule looks for the first time an identity has called the STS `GetCallerIdentity` API operation in the last 15 days, which may be an indicator of compromised credentials. A legitimate user would not need to call this operation as they should know the account they are using.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating AWS GetCallerIdentity API Called for the First Time\n\nAWS Security Token Service (AWS STS) is a service that enables you to request temporary, limited-privilege credentials for users.\nThe `GetCallerIdentity` function returns details about the IAM user or role owning the credentials used to call the operation.\nNo permissions are required to run this operation and the same information is returned even when access is denied.\nThis rule looks for use of the `GetCallerIdentity` operation. This is a [New Terms](https://www.elastic.co/guide/en/security/master/rules-ui-create.html#create-new-terms-rule) rule indicating this is the first time a specific user identity has called this operation within the last 15 days.\n\n#### Possible investigation steps\n\n- Identify the account and its role in the environment, a role belonging to a service like Lambda or an EC2 instance would be highly suspicious.\n- Identify the applications or users that should use this account.\n- Investigate other alerts associated with the account during the past 48 hours.\n- Investigate abnormal values in the `user_agent.original` field by comparing them with the intended and authorized usage and historical data. Suspicious user agent values include non-SDK, AWS CLI, custom user agents, etc.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences involving other users.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Considering the source IP address and geolocation of the user who issued the command:\n    - Do they look normal for the calling user?\n    - If the source is an EC2 IP address, is it associated with an EC2 instance in one of your accounts or is the source IP from an EC2 instance that's not under your control?\n    - If it is an authorized EC2 instance, is the activity associated with normal behavior for the instance role or roles? Are there any other alerts or signs of suspicious activity involving this instance?\n- Review IAM permission policies for the user identity.\n- If you suspect the account has been compromised, scope potentially compromised assets by tracking servers, services, and data accessed by the account in the last 24 hours.\n\n### False positive analysis\n\n- False positives may occur due to the intended usage of the service. Tuning is needed in order to have higher confidence. Consider adding exceptions — preferably with a combination of user agent and IP address conditions.\n- Automation workflows that rely on the results from this API request may also generate false-positives. We recommend adding exceptions related to the `user.name` or `aws.cloudtrail.user_identity.arn` values to ignore these.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Disable or limit the account during the investigation and response.\n- Identify the possible impact of the incident and prioritize accordingly; the following actions can help you gain context:\n    - Identify the account role in the cloud environment.\n    - Assess the criticality of affected services and servers.\n    - Work with your IT team to identify and minimize the impact on users.\n    - Identify if the attacker is moving laterally and compromising other accounts, servers, or services.\n    - Identify any regulatory or legal ramifications related to this activity.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Rotate secrets or delete API keys as needed to revoke the attacker's access to the environment. Work with your IT teams to minimize the impact on business operations during these actions.\n- Check if unauthorized new users were created, remove unauthorized new accounts, and request password resets for other IAM users.\n- Consider enabling multi-factor authentication for users.\n- Review the permissions assigned to the implicated user to ensure that the least privilege principle is being followed.\n- Implement security best practices [outlined](https://aws.amazon.com/premiumsupport/knowledge-center/security-best-practices/) by AWS.\n- Take the actions needed to return affected systems, data, or services to their normal operational levels.\n- Identify the initial vector abused by the attacker and take action to prevent reinfection via the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "investigation_fields": {
          "field_names": [
            "@timestamp",
            "user.name",
            "source.address",
            "aws.cloudtrail.user_identity.type",
            "aws.cloudtrail.user_identity.arn",
            "user_agent.original",
            "event.action",
            "event.outcome",
            "cloud.region",
            "aws.cloudtrail.request_parameters"
          ]
        },
        "version": 3,
        "tags": [
          "Domain: Cloud",
          "Data Source: AWS",
          "Data Source: Amazon Web Services",
          "Data Source: AWS STS",
          "Use Case: Identity and Access Audit",
          "Tactic: Discovery",
          "Resources: Investigation Guide"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-3600s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Verify whether the user identity should be using the STS `GetCallerIdentity` API operation. If known behavior is causing false positives, it can be exempted from the rule."
        ],
        "references": [
          "https://docs.aws.amazon.com/STS/latest/APIReference/API_GetCallerIdentity.html",
          "https://www.secureworks.com/research/detecting-the-use-of-stolen-aws-lambda-credentials",
          "https://detectioninthe.cloud/ttps/discovery/get_caller_identity/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1087",
                "name": "Account Discovery",
                "reference": "https://attack.mitre.org/techniques/T1087/",
                "subtechnique": [
                  {
                    "id": "T1087.004",
                    "name": "Cloud Account",
                    "reference": "https://attack.mitre.org/techniques/T1087/004/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "aws",
            "version": "^2.0.0",
            "integration": "cloudtrail"
          }
        ],
        "required_fields": [
          {
            "name": "aws.cloudtrail.user_identity.type",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "56bf9c61-6965-463b-a8c9-b679902d2b21",
        "rule_id": "30fbf4db-c502-4e68-a239-2e99af0f70da",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:31.907Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:27.980Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "event.dataset: \"aws.cloudtrail\"\n    and event.provider: \"sts.amazonaws.com\"\n    and event.action: \"GetCallerIdentity\"\n    and event.outcome: \"success\"\n    and not aws.cloudtrail.user_identity.type: \"AssumedRole\"",
        "new_terms_fields": [
          "aws.cloudtrail.user_identity.arn"
        ],
        "history_window_start": "now-10d",
        "index": [
          "filebeat-*",
          "logs-aws.cloudtrail-*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Multiple Okta User Authentication Events with Client Address",
        "description": "Detects when a certain threshold of Okta user authentication events are reported for multiple users from the same client address. Adversaries may attempt to launch a credential stuffing or password spraying attack from the same device by using a list of known usernames and passwords to gain unauthorized access to user accounts.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Multiple Okta User Authentication Events with Client Address\n\nThis rule detects when a certain threshold of Okta user authentication events are reported for multiple users from the same client address. Adversaries may attempt to launch a credential stuffing attack from the same device by using a list of known usernames and passwords to gain unauthorized access to user accounts. Note that Okta does not log unrecognized usernames supplied during authentication attempts, so this rule may not detect all credential stuffing attempts or may indicate a targeted attack.\n\n#### Possible investigation steps:\nSince this is an ES|QL rule, the `okta.actor.alternate_id` and `okta.client.ip` values can be used to pivot into the raw authentication events related to this activity.\n- Identify the users involved in this action by examining the `okta.actor.id`, `okta.actor.type`, `okta.actor.alternate_id`, and `okta.actor.display_name` fields.\n- Determine the device client used for these actions by analyzing `okta.client.ip`, `okta.client.user_agent.raw_user_agent`, `okta.client.zone`, `okta.client.device`, and `okta.client.id` fields.\n- Review the `okta.security_context.is_proxy` field to determine if the device is a proxy.\n    - If the device is a proxy, this may indicate that a user is using a proxy to access multiple accounts for password spraying.\n- With the list of `okta.actor.alternate_id` values, review `event.outcome` results to determine if the authentication was successful.\n    - If the authentication was successful for any user, pivoting to `event.action` values for those users may provide additional context.\n- With Okta end users identified, review the `okta.debug_context.debug_data.dt_hash` field.\n    - Historical analysis should indicate if this device token hash is commonly associated with the user.\n- Review the `okta.event_type` field to determine the type of authentication event that occurred.\n    - If the event type is `user.authentication.sso`, the user may have legitimately started a session via a proxy for security or privacy reasons.\n    - If the event type is `user.authentication.password`, the user may be using a proxy to access multiple accounts for password spraying.\n    - If the event type is `user.session.start`, the source may have attempted to establish a session via the Okta authentication API.\n- Examine the `okta.outcome.result` field to determine if the authentication was successful.\n- Review the past activities of the actor(s) involved in this action by checking their previous actions.\n- Evaluate the actions that happened just before and after this event in the `okta.event_type` field to help understand the full context of the activity.\n    - This may help determine the authentication and authorization actions that occurred between the user, Okta and application.\n\n### False positive analysis:\n- A user may have legitimately started a session via a proxy for security or privacy reasons.\n- Users may share an endpoint related to work or personal use in which separate Okta accounts are used.\n    - Architecturally, this shared endpoint may leverage a proxy for security or privacy reasons.\n    - Shared systems such as Kiosks and conference room computers may be used by multiple users.\n    - Shared working spaces may have a single endpoint that is used by multiple users.\n\n### Response and remediation:\n- Review the profile of the users involved in this action to determine if proxy usage may be expected.\n- If the user is legitimate and the authentication behavior is not suspicious based on device analysis, no action is required.\n- If the user is legitimate but the authentication behavior is suspicious, consider resetting passwords for the users involves and enabling multi-factor authentication (MFA).\n    - If MFA is already enabled, consider resetting MFA for the users.\n- If any of the users are not legitimate, consider deactivating the user's account.\n- Conduct a review of Okta policies and ensure they are in accordance with security best practices.\n- Check with internal IT teams to determine if the accounts involved recently had MFA reset at the request of the user.\n    - If so, confirm with the user this was a legitimate request.\n    - If so and this was not a legitimate request, consider deactivating the user's account temporarily.\n        - Reset passwords and reset MFA for the user.\n- If this is a false positive, consider adding the `okta.debug_context.debug_data.dt_hash` field to the `exceptions` list in the rule.\n    - This will prevent future occurrences of this event for this device from triggering the rule.\n    - Alternatively adding `okta.client.ip` or a CIDR range to the `exceptions` list can prevent future occurrences of this event from triggering the rule.\n        - This should be done with caution as it may prevent legitimate alerts from being generated.\n",
        "output_index": "",
        "version": 203,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Data Source: Okta",
          "Tactic: Credential Access"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Users may share an endpoint related to work or personal use in which separate Okta accounts are used.",
          "Shared systems such as Kiosks and conference room computers may be used by multiple users."
        ],
        "references": [
          "https://support.okta.com/help/s/article/How-does-the-Device-Token-work?language=en_US",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://sec.okta.com/articles/2023/08/cross-tenant-impersonation-prevention-and-detection",
          "https://www.okta.com/resources/whitepaper-how-adaptive-mfa-can-help-in-mitigating-brute-force-attacks/",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1110",
                "name": "Brute Force",
                "reference": "https://attack.mitre.org/techniques/T1110/",
                "subtechnique": [
                  {
                    "id": "T1110.003",
                    "name": "Password Spraying",
                    "reference": "https://attack.mitre.org/techniques/T1110/003/"
                  }
                ]
              },
              {
                "id": "T1110",
                "name": "Brute Force",
                "reference": "https://attack.mitre.org/techniques/T1110/",
                "subtechnique": [
                  {
                    "id": "T1110.004",
                    "name": "Credential Stuffing",
                    "reference": "https://attack.mitre.org/techniques/T1110/004/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [],
        "required_fields": [],
        "id": "4fd17fa1-4571-4e94-9fca-45d7fa4f37e2",
        "rule_id": "94e734c0-2cda-11ef-84e1-f661ea17fbce",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:31.911Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:40.635Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "esql",
        "language": "esql",
        "query": "FROM logs-okta*\n| WHERE\n    event.dataset == \"okta.system\"\n    AND (event.action == \"user.session.start\" OR event.action RLIKE \"user\\\\.authentication(.*)\")\n    AND okta.outcome.reason == \"INVALID_CREDENTIALS\"\n| KEEP okta.client.ip, okta.actor.alternate_id, okta.actor.id, event.action, okta.outcome.reason\n| STATS\n    source_auth_count = COUNT_DISTINCT(okta.actor.id)\n    BY okta.client.ip, okta.actor.alternate_id\n| WHERE\n    source_auth_count > 5\n| SORT\n    source_auth_count DESC"
      },
      {
        "name": "Mshta Making Network Connections",
        "description": "Identifies Mshta.exe making outbound network connections. This may indicate adversarial activity, as Mshta is often leveraged by adversaries to execute malicious scripts and evade detection.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 208,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-1200s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/security-labs/elastic-protects-against-data-wiper-malware-targeting-ukraine-hermeticwiper"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1218",
                "name": "System Binary Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1218/",
                "subtechnique": [
                  {
                    "id": "T1218.005",
                    "name": "Mshta",
                    "reference": "https://attack.mitre.org/techniques/T1218/005/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "00fa34d2-b280-47ee-a461-dda6edbe0d0d",
        "rule_id": "c2d90150-0133-451c-a783-533e736c12d7",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:31.914Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:45.030Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by process.entity_id with maxspan=10m\n  [process where host.os.type == \"windows\" and event.type == \"start\" and process.name : \"mshta.exe\" and\n     not process.parent.name : \"Microsoft.ConfigurationManagement.exe\" and\n     not (process.parent.executable : \"C:\\\\Amazon\\\\Amazon Assistant\\\\amazonAssistantService.exe\" or\n          process.parent.executable : \"C:\\\\TeamViewer\\\\TeamViewer.exe\") and\n     not process.args : \"ADSelfService_Enroll.hta\"]\n  [network where host.os.type == \"windows\" and process.name : \"mshta.exe\"]",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "logs-endpoint.events.network-*",
          "winlogbeat-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "AWS EC2 Multi-Region DescribeInstances API Calls",
        "description": "Identifies when a single AWS resource is making `DescribeInstances` API calls in more than 10 regions within a 30-second window. This could indicate a potential threat actor attempting to discover the AWS infrastructure across multiple regions using compromised credentials or a compromised instance. Adversaries may use this information to identify potential targets for further exploitation or to gain a better understanding of the target's infrastructure.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and Analysis\n\n### Investigating AWS EC2 Multi-Region DescribeInstances API Calls\n\nThis rule detects instances where a single AWS resource makes `DescribeInstances` API calls in over 10 regions within a 30-second window. This could indicate an adversary using compromised credentials or an exploited resource to enumerate AWS infrastructure across multiple regions. Attackers often leverage multi-region enumeration to assess the overall cloud environment and find potential targets for further exploitation.\n\n#### Possible Investigation Steps\n\n- **Identify the Resource and Actor**:\n  - **Actor ARN**: Check `aws.cloudtrail.user_identity.arn` to determine the exact identity performing the enumeration. Validate if the user is expected to perform region-wide `DescribeInstances` actions across multiple regions or if it seems unusual.\n  - **Account and Role Details**: Examine `cloud.account.id` and `aws.cloudtrail.user_identity.session_context.session_issuer` for information about the AWS account and specific role associated with the action.\n\n- **Analyze API Call Patterns**:\n  - **Frequency and Scope**: Review `cloud.region` field and confirm if this specific resource commonly performs `DescribeInstances` calls across multiple regions.\n  - **Time Window Context**: Compare the timing of the API calls within the `target_time_window` to determine if this burst pattern aligns with expected system usage or is potentially malicious.\n\n- **Check User Agent and Tooling**:\n  - **Source and User Agent**: Verify `user_agent.original` to determine if the request was made through expected tooling (e.g., AWS CLI or SDK) or a third-party tool that might indicate non-standard access.\n  - **Source IP Address**: Look into `source.address` to identify the origin of the calls. Unusual IP addresses, especially those outside expected ranges, may indicate compromised access.\n\n- **Evaluate for Potential Reconnaissance Behavior**:\n  - **Account and Region Enumeration**: Adversaries may use region-wide `DescribeInstances` requests to discover resources within an account across different regions. Confirm if this access aligns with operational practices or represents excessive access.\n  - **Permissions and Roles**: Investigate the permissions associated with the user role. Excessive permissions on a compromised role may allow broader enumeration, which should be restricted.\n\n- **Review Related CloudTrail Events**:\n  - **Additional Describe or List Actions**: Identify any associated `Describe` or `List` API calls that may indicate further enumeration of other AWS services within the same timeframe.\n  - **Potential Preceding Events**: Look for preceding login or access events from the same actor, as these may indicate potential credential compromise or unauthorized escalation of privileges.\n\n### False Positive Analysis\n\n- **Expected Enumeration**: Certain administrative or automation scripts may conduct broad `DescribeInstances` API calls for inventory purposes. Review usage patterns or consult relevant teams to validate the purpose.\n- **Automated Cloud Management**: Some automated services may perform regional checks for compliance or backup operations. If this rule is triggered repeatedly by a known service, consider whitelisting or tuning accordingly.\n\n### Response and Remediation\n\n- **Review IAM Policies and Role Permissions**: Limit the permissions of roles associated with this resource, restricting unnecessary multi-region enumeration access.\n- **Enforce Least Privilege Access**: Ensure that permissions for DescribeInstances are tightly controlled and restricted to specific roles or accounts that require multi-region access.\n- **Increase Monitoring and Alerts**: Set up additional monitoring on this role or account for further signs of unauthorized activity or lateral movement attempts.\n- **Access Review**: Conduct a review of users and entities with `DescribeInstances` permissions, especially for multi-region capabilities, and ensure these permissions are necessary for their functions.\n\n### Additional Information\n\nFor further information on AWS `DescribeInstances` permissions and best practices, refer to the [AWS DescribeInstances API documentation](https://docs.aws.amazon.com/AWSEC2/latest/APIReference/API_DescribeInstances.html).\n",
        "output_index": "",
        "investigation_fields": {
          "field_names": [
            "aws.cloudtrail.user_identity.arn",
            "target_time_window",
            "region_count",
            "window_count"
          ]
        },
        "version": 3,
        "tags": [
          "Domain: Cloud",
          "Data Source: AWS",
          "Data Source: AWS EC2",
          "Resources: Investigation Guide",
          "Use Case: Threat Detection",
          "Tactic: Discovery"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Legitimate use of the `DescribeInstances` API call by an AWS resource that requires information about instances in multiple regions.",
          "Scheduled tasks or scripts that require information about instances in multiple regions."
        ],
        "references": [
          "https://www.sentinelone.com/labs/exploring-fbot-python-based-malware-targeting-cloud-and-payment-services/",
          "https://docs.aws.amazon.com/AWSEC2/latest/APIReference/API_DescribeInstances.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1580",
                "name": "Cloud Infrastructure Discovery",
                "reference": "https://attack.mitre.org/techniques/T1580/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [],
        "required_fields": [],
        "id": "b854dfaa-b417-4089-8850-ec5eee236269",
        "rule_id": "393ef120-63d1-11ef-8e38-f661ea17fbce",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:31.917Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:28.156Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "esql",
        "language": "esql",
        "query": "from logs-aws.cloudtrail-*\n\n// filter for DescribeInstances API calls\n| where event.dataset == \"aws.cloudtrail\" and event.provider == \"ec2.amazonaws.com\" and event.action == \"DescribeInstances\"\n\n// truncate the timestamp to a 30-second window\n| eval target_time_window = DATE_TRUNC(30 seconds, @timestamp)\n\n// keep only the relevant fields\n| keep target_time_window, aws.cloudtrail.user_identity.arn, cloud.region\n\n// count the number of unique regions and total API calls within the 30-second window\n| stats region_count = count_distinct(cloud.region), window_count = count(*) by target_time_window, aws.cloudtrail.user_identity.arn\n\n// filter for resources making DescribeInstances API calls in more than 10 regions within the 30-second window\n| where region_count >= 10 and window_count >= 10\n\n// sort the results by time windows in descending order\n| sort target_time_window desc"
      },
      {
        "name": "Outbound Scheduled Task Activity via PowerShell",
        "description": "Identifies the PowerShell process loading the Task Scheduler COM DLL followed by an outbound RPC network connection within a short time period. This may indicate lateral movement or remote discovery via scheduled tasks.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 209,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Legitimate scheduled tasks may be created during installation of new software."
        ],
        "references": [
          "https://www.volexity.com/blog/2020/12/14/dark-halo-leverages-solarwinds-compromise-to-breach-organizations/",
          "https://www.elastic.co/security-labs/hunting-for-lateral-movement-using-event-query-language"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1053",
                "name": "Scheduled Task/Job",
                "reference": "https://attack.mitre.org/techniques/T1053/",
                "subtechnique": [
                  {
                    "id": "T1053.005",
                    "name": "Scheduled Task",
                    "reference": "https://attack.mitre.org/techniques/T1053/005/"
                  }
                ]
              },
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.address",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "destination.port",
            "type": "long",
            "ecs": true
          },
          {
            "name": "dll.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "95aa5380-71ee-499c-9482-0587894b2163",
        "rule_id": "5cd55388-a19c-47c7-8ec4-f41656c2fded",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:31.920Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:32.850Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by host.id, process.entity_id with maxspan = 5s\n [any where host.os.type == \"windows\" and (event.category == \"library\" or (event.category == \"process\" and event.action : \"Image loaded*\")) and\n  (?dll.name : \"taskschd.dll\" or file.name : \"taskschd.dll\") and process.name : (\"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\")]\n [network where host.os.type == \"windows\" and process.name : (\"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\") and destination.port == 135 and not destination.address in (\"127.0.0.1\", \"::1\")]",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.library-*",
          "logs-endpoint.events.network-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "Windows Service Installed via an Unusual Client",
        "description": "Identifies the creation of a Windows service by an unusual client process. Services may be created with administrator privileges but are executed under SYSTEM privileges, so an adversary may also use a service to escalate privileges from administrator to SYSTEM.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 211,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.x86matthew.com/view_post?id=create_svc_rpc",
          "https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4697",
          "https://github.com/atc-project/atomic-threat-coverage/blob/master/Atomic_Threat_Coverage/Logging_Policies/LP_0100_windows_audit_security_system_extension.md",
          "https://www.elastic.co/security-labs/siestagraph-new-implant-uncovered-in-asean-member-foreign-ministry"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1543",
                "name": "Create or Modify System Process",
                "reference": "https://attack.mitre.org/techniques/T1543/",
                "subtechnique": [
                  {
                    "id": "T1543.003",
                    "name": "Windows Service",
                    "reference": "https://attack.mitre.org/techniques/T1543/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'Audit Security System Extension' logging policy must be configured for (Success)\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nPolicies >\nWindows Settings >\nSecurity Settings >\nAdvanced Audit Policies Configuration >\nAudit Policies >\nSystem >\nAudit Security System Extension (Success)\n```\n",
        "related_integrations": [
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.event_data.ClientProcessId",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "winlog.event_data.ParentProcessId",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "winlog.event_data.ServiceFileName",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "9ceffb3f-ec47-493f-9b05-4267a7123597",
        "rule_id": "55c2bf58-2a39-4c58-a384-c8b1978153c2",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:31.923Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:32.281Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "configuration where host.os.type == \"windows\" and\n  event.action == \"service-installed\" and\n  (winlog.event_data.ClientProcessId == \"0\" or winlog.event_data.ParentProcessId == \"0\") and\n  not winlog.event_data.ServiceFileName : (\n    \"?:\\\\Windows\\\\VeeamVssSupport\\\\VeeamGuestHelper.exe\",\n    \"?:\\\\Windows\\\\VeeamLogShipper\\\\VeeamLogShipper.exe\",\n    \"%SystemRoot%\\\\system32\\\\Drivers\\\\Crowdstrike\\\\*-CsInstallerService.exe\",\n    \"\\\"%windir%\\\\AdminArsenal\\\\PDQInventory-Scanner\\\\service-1\\\\PDQInventory-Scanner-1.exe\\\" \"\n  )",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-system.*",
          "logs-windows.*"
        ],
        "filters": []
      },
      {
        "name": "High Number of Okta Device Token Cookies Generated for Authentication",
        "description": "Detects when an Okta client address has a certain threshold of Okta user authentication events with multiple device token hashes generated for single user authentication. Adversaries may attempt to launch a credential stuffing or password spraying attack from the same device by using a list of known usernames and passwords to gain unauthorized access to user accounts.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating High Number of Okta Device Token Cookies Generated for Authentication\n\nThis rule detects when a certain threshold of Okta user authentication events are reported for multiple users from the same client address. Adversaries may attempt to launch a credential stuffing attack from the same device by using a list of known usernames and passwords to gain unauthorized access to user accounts. Note that Okta does not log unrecognized usernames supplied during authentication attempts, so this rule may not detect all credential stuffing attempts or may indicate a targeted attack.\n\n#### Possible investigation steps:\n- Since this is an ES|QL rule, the `okta.actor.alternate_id` and `okta.client.ip` values can be used to pivot into the raw authentication events related to this activity.\n- Identify the users involved in this action by examining the `okta.actor.id`, `okta.actor.type`, `okta.actor.alternate_id`, and `okta.actor.display_name` fields.\n- Determine the device client used for these actions by analyzing `okta.client.ip`, `okta.client.user_agent.raw_user_agent`, `okta.client.zone`, `okta.client.device`, and `okta.client.id` fields.\n- Review the `okta.security_context.is_proxy` field to determine if the device is a proxy.\n    - If the device is a proxy, this may indicate that a user is using a proxy to access multiple accounts for password spraying.\n- With the list of `okta.actor.alternate_id` values, review `event.outcome` results to determine if the authentication was successful.\n    - If the authentication was successful for any user, pivoting to `event.action` values for those users may provide additional context.\n- With Okta end users identified, review the `okta.debug_context.debug_data.dt_hash` field.\n    - Historical analysis should indicate if this device token hash is commonly associated with the user.\n- Review the `okta.event_type` field to determine the type of authentication event that occurred.\n    - If the event type is `user.authentication.sso`, the user may have legitimately started a session via a proxy for security or privacy reasons.\n    - If the event type is `user.authentication.password`, the user may be using a proxy to access multiple accounts for password spraying.\n    - If the event type is `user.session.start`, the source may have attempted to establish a session via the Okta authentication API.\n- Examine the `okta.outcome.result` field to determine if the authentication was successful.\n- Review the past activities of the actor(s) involved in this action by checking their previous actions.\n- Evaluate the actions that happened just before and after this event in the `okta.event_type` field to help understand the full context of the activity.\n    - This may help determine the authentication and authorization actions that occurred between the user, Okta and application.\n\n### False positive analysis:\n- A user may have legitimately started a session via a proxy for security or privacy reasons.\n- Users may share an endpoint related to work or personal use in which separate Okta accounts are used.\n    - Architecturally, this shared endpoint may leverage a proxy for security or privacy reasons.\n    - Shared systems such as Kiosks and conference room computers may be used by multiple users.\n    - Shared working spaces may have a single endpoint that is used by multiple users.\n\n### Response and remediation:\n- Review the profile of the users involved in this action to determine if proxy usage may be expected.\n- If the user is legitimate and the authentication behavior is not suspicious based on device analysis, no action is required.\n- If the user is legitimate but the authentication behavior is suspicious, consider resetting passwords for the users involves and enabling multi-factor authentication (MFA).\n    - If MFA is already enabled, consider resetting MFA for the users.\n- If any of the users are not legitimate, consider deactivating the user's account.\n- Conduct a review of Okta policies and ensure they are in accordance with security best practices.\n- Check with internal IT teams to determine if the accounts involved recently had MFA reset at the request of the user.\n    - If so, confirm with the user this was a legitimate request.\n    - If so and this was not a legitimate request, consider deactivating the user's account temporarily.\n        - Reset passwords and reset MFA for the user.\n- If this is a false positive, consider adding the `okta.debug_context.debug_data.dt_hash` field to the `exceptions` list in the rule.\n    - This will prevent future occurrences of this event for this device from triggering the rule.\n    - Alternatively adding `okta.client.ip` or a CIDR range to the `exceptions` list can prevent future occurrences of this event from triggering the rule.\n        - This should be done with caution as it may prevent legitimate alerts from being generated.\n",
        "output_index": "",
        "version": 203,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Data Source: Okta",
          "Tactic: Credential Access"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Users may share an endpoint related to work or personal use in which separate Okta accounts are used.",
          "Shared systems such as Kiosks and conference room computers may be used by multiple users."
        ],
        "references": [
          "https://support.okta.com/help/s/article/How-does-the-Device-Token-work?language=en_US",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://sec.okta.com/articles/2023/08/cross-tenant-impersonation-prevention-and-detection",
          "https://www.okta.com/resources/whitepaper-how-adaptive-mfa-can-help-in-mitigating-brute-force-attacks/",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1110",
                "name": "Brute Force",
                "reference": "https://attack.mitre.org/techniques/T1110/",
                "subtechnique": [
                  {
                    "id": "T1110.003",
                    "name": "Password Spraying",
                    "reference": "https://attack.mitre.org/techniques/T1110/003/"
                  }
                ]
              },
              {
                "id": "T1110",
                "name": "Brute Force",
                "reference": "https://attack.mitre.org/techniques/T1110/",
                "subtechnique": [
                  {
                    "id": "T1110.004",
                    "name": "Credential Stuffing",
                    "reference": "https://attack.mitre.org/techniques/T1110/004/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [],
        "required_fields": [],
        "id": "b78b9d10-9265-47a1-a5e8-99409123ac12",
        "rule_id": "23f18264-2d6d-11ef-9413-f661ea17fbce",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:31.932Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:25.945Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "esql",
        "language": "esql",
        "query": "FROM logs-okta*\n| WHERE\n    event.dataset == \"okta.system\"\n    AND (event.action RLIKE \"user\\\\.authentication(.*)\" OR event.action == \"user.session.start\")\n    AND okta.debug_context.debug_data.request_uri == \"/api/v1/authn\"\n    AND okta.outcome.reason == \"INVALID_CREDENTIALS\"\n| KEEP event.action, okta.debug_context.debug_data.dt_hash, okta.client.ip, okta.actor.alternate_id, okta.debug_context.debug_data.request_uri, okta.outcome.reason\n| STATS\n    source_auth_count = COUNT_DISTINCT(okta.debug_context.debug_data.dt_hash)\n    BY okta.client.ip, okta.actor.alternate_id\n| WHERE\n    source_auth_count >= 30\n| SORT\n    source_auth_count DESC"
      },
      {
        "name": "Attempted Bypass of Okta MFA",
        "description": "Detects attempts to bypass Okta multi-factor authentication (MFA). An adversary may attempt to bypass the Okta MFA policies configured for an organization in order to obtain unauthorized access to an application.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Attempted Bypass of Okta MFA\n\nMulti-factor authentication (MFA) is a crucial security measure in preventing unauthorized access. Okta MFA, like other MFA solutions, requires the user to provide multiple means of identification at login. An adversary might attempt to bypass Okta MFA to gain unauthorized access to an application.\n\nThis rule detects attempts to bypass Okta MFA. It might indicate a serious attempt to compromise a user account within the organization's network.\n\n#### Possible investigation steps\n\n- Identify the actor related to the alert by reviewing `okta.actor.id`, `okta.actor.type`, `okta.actor.alternate_id`, or `okta.actor.display_name` fields in the alert.\n- Review the `okta.client.user_agent.raw_user_agent` field to understand the device and software used by the actor.\n- Examine the `okta.outcome.reason` field for additional context around the bypass attempt.\n- Check the `okta.outcome.result` field to confirm the MFA bypass attempt.\n- Check if there are multiple unsuccessful MFA attempts from the same actor or IP address (`okta.client.ip`).\n- Check for successful logins immediately following the MFA bypass attempt.\n- Verify whether the actor's activity aligns with typical behavior or if any unusual activity took place around the time of the bypass attempt.\n\n### False positive analysis\n\n- Check if there were issues with the MFA system at the time of the bypass attempt. This could indicate a system error rather than a genuine bypass attempt.\n- Check the geographical location (`okta.request.ip_chain.geographical_context`) and time of the login attempt. If these match the actor's normal behavior, it might be a false positive.\n- Verify the actor's MFA settings to ensure they are correctly configured.\n\n### Response and remediation\n\n- If unauthorized access is confirmed, initiate the incident response process.\n- Immediately lock the affected actor account and require a password change.\n- Consider resetting MFA tokens for the actor and require re-enrollment.\n- Check if the compromised account was used to access or alter any sensitive data or systems.\n- If a specific MFA bypass technique was used, ensure your systems are patched or configured to prevent such techniques.\n- Assess the criticality of affected services and servers.\n- Work with your IT team to minimize the impact on users and maintain business continuity.\n- If multiple accounts are affected, consider a broader reset or audit of MFA tokens.\n- Implement security best practices [outlined](https://www.okta.com/blog/2019/10/9-admin-best-practices-to-keep-your-org-secure/) by Okta.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).",
        "output_index": "",
        "version": 411,
        "tags": [
          "Data Source: Okta",
          "Use Case: Identity and Access Audit",
          "Tactic: Credential Access"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/okta-and-lapsus-what-you-need-to-know",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1111",
                "name": "Multi-Factor Authentication Interception",
                "reference": "https://attack.mitre.org/techniques/T1111/"
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "fd45ff25-c094-4362-b7cc-df8c6837cc2b",
        "rule_id": "3805c3dc-f82c-4f8d-891e-63c24d3102b0",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:31.935Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:28.117Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset:okta.system and event.action:user.mfa.attempt_bypass",
        "language": "kuery"
      },
      {
        "name": "Suspicious Execution via Scheduled Task",
        "description": "Identifies execution of a suspicious program via scheduled tasks by looking at process lineage and command line usage.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 209,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Tactic: Execution",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Legitimate scheduled tasks running third party software."
        ],
        "references": [
          "https://www.elastic.co/security-labs/elastic-protects-against-data-wiper-malware-targeting-ukraine-hermeticwiper"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1053",
                "name": "Scheduled Task/Job",
                "reference": "https://attack.mitre.org/techniques/T1053/",
                "subtechnique": [
                  {
                    "id": "T1053.005",
                    "name": "Scheduled Task",
                    "reference": "https://attack.mitre.org/techniques/T1053/005/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1053",
                "name": "Scheduled Task/Job",
                "reference": "https://attack.mitre.org/techniques/T1053/",
                "subtechnique": [
                  {
                    "id": "T1053.005",
                    "name": "Scheduled Task",
                    "reference": "https://attack.mitre.org/techniques/T1053/005/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.working_directory",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "d9a5dfac-75b7-49ca-a3ca-f1638c681a5c",
        "rule_id": "5d1d6907-0747-4d5d-9b24-e4a18853dc0a",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:31.938Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:32.896Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n    /* Schedule service cmdline on Win10+ */\n    process.parent.name : \"svchost.exe\" and process.parent.args : \"Schedule\" and\n    /* add suspicious programs here */\n    process.pe.original_file_name in\n                                (\n                                  \"cscript.exe\",\n                                  \"wscript.exe\",\n                                  \"PowerShell.EXE\",\n                                  \"Cmd.Exe\",\n                                  \"MSHTA.EXE\",\n                                  \"RUNDLL32.EXE\",\n                                  \"REGSVR32.EXE\",\n                                  \"MSBuild.exe\",\n                                  \"InstallUtil.exe\",\n                                  \"RegAsm.exe\",\n                                  \"RegSvcs.exe\",\n                                  \"msxsl.exe\",\n                                  \"CONTROL.EXE\",\n                                  \"EXPLORER.EXE\",\n                                  \"Microsoft.Workflow.Compiler.exe\",\n                                  \"msiexec.exe\"\n                                  ) and\n    /* add suspicious paths here */\n    process.args : (\n       \"C:\\\\Users\\\\*\",\n       \"C:\\\\ProgramData\\\\*\",\n       \"C:\\\\Windows\\\\Temp\\\\*\",\n       \"C:\\\\Windows\\\\Tasks\\\\*\",\n       \"C:\\\\PerfLogs\\\\*\",\n       \"C:\\\\Intel\\\\*\",\n       \"C:\\\\Windows\\\\Debug\\\\*\",\n       \"C:\\\\HP\\\\*\") and\n\n     not (process.name : \"cmd.exe\" and process.args : \"?:\\\\*.bat\" and process.working_directory : \"?:\\\\Windows\\\\System32\\\\\") and\n     not (process.name : \"cscript.exe\" and process.args : \"?:\\\\Windows\\\\system32\\\\calluxxprovider.vbs\") and\n     not (process.name : \"powershell.exe\" and process.args : (\"-File\", \"-PSConsoleFile\") and user.id : \"S-1-5-18\") and\n     not (process.name : \"msiexec.exe\" and user.id : \"S-1-5-18\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.*"
        ],
        "filters": []
      },
      {
        "name": "New Okta Identity Provider (IdP) Added by Admin",
        "description": "Detects the creation of a new Identity Provider (IdP) by a Super Administrator or Organization Administrator within Okta.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating New Okta Identity Provider (IdP) Added by Admin\n\nThis rule detects the creation of a new Identity Provider (IdP) by a Super Administrator or Organization Administrator within Okta.\n\n#### Possible investigation steps:\n- Identify the actor associated with the IdP creation by examining the `okta.actor.id`, `okta.actor.type`, `okta.actor.alternate_id`, and `okta.actor.display_name` fields.\n- Identify the IdP added by reviewing the `okta.target` field and determing if this IdP is authorized.\n- Determine the client used by the actor. Review the `okta.client.ip`, `okta.client.user_agent.raw_user_agent`, `okta.client.zone`, `okta.client.device`, and `okta.client.id` fields.\n- If the client is a device, check the `okta.device.id`, `okta.device.name`, `okta.device.os_platform`, `okta.device.os_version`, and `okta.device.managed` fields.\n- Review the past activities of the actor involved in this action by checking their previous actions logged in the `okta.target` field.\n- Examine the `okta.request.ip_chain` field to potentially determine if the actor used a proxy or VPN to perform this action.\n- Evaluate the actions that happened just before and after this event in the `okta.event_type` field to help understand the full context of the activity.\n\n### False positive analysis:\n- It might be a false positive if the action was part of a planned activity or performed by an authorized person.\n- Several unsuccessful attempts prior to this success, may indicate an adversary attempting to add an unauthorized IdP multiple times.\n\n### Response and remediation:\n- If the IdP is unauthorized, deactivate it immediately via the Okta console.\n- If the IdP is authorized, ensure that the actor who created it is authorized to do so.\n- If the actor is unauthorized, deactivate their account via the Okta console.\n- If the actor is authorized, ensure that the actor's account is not compromised.\n- Reset the user's password and enforce MFA re-enrollment, if applicable.\n- Block the IP address or device used in the attempts if they appear suspicious, using the data from the `okta.client.ip` and `okta.device.id` fields.\n- Conduct a review of Okta policies and ensure they are in accordance with security best practices.\n- If the deactivated IdP was crucial to the organization, consider adding a new IdP and removing the unauthorized IdP.",
        "output_index": "",
        "version": 205,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Tactic: Persistence",
          "Data Source: Okta"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "15m",
        "from": "now-1800s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://blog.cloudflare.com/cloudflare-investigation-of-the-january-2022-okta-compromise/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://sec.okta.com/articles/2023/08/cross-tenant-impersonation-prevention-and-detection",
          "https://unit42.paloaltonetworks.com/muddled-libra/",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1556",
                "name": "Modify Authentication Process",
                "reference": "https://attack.mitre.org/techniques/T1556/",
                "subtechnique": [
                  {
                    "id": "T1556.007",
                    "name": "Hybrid Identity",
                    "reference": "https://attack.mitre.org/techniques/T1556/007/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "okta.outcome.result",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "5793bce7-e961-4d29-8418-0d852697738f",
        "rule_id": "29b53942-7cd4-11ee-b70e-f661ea17fbcd",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:31.941Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:26.621Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset: \"okta.system\" and event.action: \"system.idp.lifecycle.create\" and okta.outcome.result: \"SUCCESS\"",
        "language": "kuery"
      },
      {
        "name": "Modification or Removal of an Okta Application Sign-On Policy",
        "description": "Detects attempts to modify or delete a sign on policy for an Okta application. An adversary may attempt to modify or delete the sign on policy for an Okta application in order to remove or weaken an organization's security controls.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 410,
        "tags": [
          "Tactic: Persistence",
          "Use Case: Identity and Access Audit",
          "Data Source: Okta"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Consider adding exceptions to this rule to filter false positives if sign on policies for Okta applications are regularly modified or deleted in your organization."
        ],
        "references": [
          "https://help.okta.com/en/prod/Content/Topics/Security/App_Based_Signon.htm",
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1556",
                "name": "Modify Authentication Process",
                "reference": "https://attack.mitre.org/techniques/T1556/"
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "7e93bf01-67a3-4d8f-b5de-92d57ae37820",
        "rule_id": "cd16fb10-0261-46e8-9932-a0336278cdbe",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:31.944Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:45.731Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset:okta.system and event.action:(application.policy.sign_on.update or application.policy.sign_on.rule.delete)",
        "language": "kuery"
      },
      {
        "name": "Shell Configuration Creation or Modification",
        "description": "This rule monitors the creation/alteration of a shell configuration file. Unix systems use shell configuration files to set environment variables, create aliases, and customize the user's environment. Adversaries may modify or add a shell configuration file to execute malicious code and gain persistence in the system. This behavior is consistent with the Kaiji malware family.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 5,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Legitimate user shell modification activity."
        ],
        "references": [
          "https://intezer.com/blog/research/kaiji-new-chinese-linux-malware-turning-to-golang/",
          "https://www.elastic.co/security-labs/primer-on-persistence-mechanisms"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1546",
                "name": "Event Triggered Execution",
                "reference": "https://attack.mitre.org/techniques/T1546/",
                "subtechnique": [
                  {
                    "id": "T1546.004",
                    "name": "Unix Shell Configuration Modification",
                    "reference": "https://attack.mitre.org/techniques/T1546/004/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.Ext.original.extension",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "98b46549-0066-4926-b2a6-7facff6ff56e",
        "rule_id": "28f6f34b-8e16-487a-b5fd-9d22eb903db8",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:31.947Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:26.612Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"linux\" and event.action in (\"rename\", \"creation\") and file.path : (\n  // system-wide configurations\n  \"/etc/profile\", \"/etc/profile.d/*\", \"/etc/bash.bashrc\", \"/etc/bash.bash_logout\", \"/etc/zsh/*\",\n  \"/etc/csh.cshrc\", \"/etc/csh.login\", \"/etc/fish/config.fish\", \"/etc/ksh.kshrc\",\n  // root and user configurations\n  \"/home/*/.profile\", \"/home/*/.bashrc\", \"/home/*/.bash_login\", \"/home/*/.bash_logout\", \"/home/*/.bash_profile\",\n  \"/root/.profile\", \"/root/.bashrc\", \"/root/.bash_login\", \"/root/.bash_logout\", \"/root/.bash_profile\",\n  \"/home/*/.zprofile\", \"/home/*/.zshrc\", \"/root/.zprofile\", \"/root/.zshrc\",\n  \"/home/*/.cshrc\", \"/home/*/.login\", \"/home/*/.logout\", \"/root/.cshrc\", \"/root/.login\", \"/root/.logout\",\n  \"/home/*/.config/fish/config.fish\", \"/root/.config/fish/config.fish\",\n  \"/home/*/.kshrc\", \"/root/.kshrc\"\n) and not (\n  process.executable in (\n    \"/bin/dpkg\", \"/usr/bin/dpkg\", \"/bin/dockerd\", \"/usr/bin/dockerd\", \"/usr/sbin/dockerd\", \"/bin/microdnf\",\n    \"/usr/bin/microdnf\", \"/bin/rpm\", \"/usr/bin/rpm\", \"/bin/snapd\", \"/usr/bin/snapd\", \"/bin/yum\", \"/usr/bin/yum\",\n    \"/bin/dnf\", \"/usr/bin/dnf\", \"/bin/podman\", \"/usr/bin/podman\", \"/bin/dnf-automatic\", \"/usr/bin/dnf-automatic\",\n    \"/bin/pacman\", \"/usr/bin/pacman\", \"/usr/bin/dpkg-divert\", \"/bin/dpkg-divert\", \"/sbin/apk\", \"/usr/sbin/apk\",\n    \"/usr/local/sbin/apk\", \"/usr/bin/apt\", \"/usr/sbin/pacman\", \"/bin/podman\", \"/usr/bin/podman\", \"/usr/bin/puppet\",\n    \"/bin/puppet\", \"/opt/puppetlabs/puppet/bin/puppet\", \"/usr/bin/chef-client\", \"/bin/chef-client\",\n    \"/bin/autossl_check\", \"/usr/bin/autossl_check\", \"/proc/self/exe\", \"/dev/fd/*\",  \"/usr/bin/pamac-daemon\",\n    \"/bin/pamac-daemon\", \"/usr/lib/snapd/snapd\", \"/usr/sbin/adduser\", \"/usr/sbin/useradd\", \"/usr/local/bin/dockerd\",\n    \"/usr/sbin/gdm\", \"/usr/bin/unzip\", \"/usr/bin/gnome-shell\", \"/sbin/mkhomedir_helper\", \"/usr/sbin/sshd\",\n    \"/opt/puppetlabs/puppet/bin/ruby\", \"/usr/bin/xfce4-session\", \"/usr/libexec/oddjob/mkhomedir\", \"/sbin/useradd\",\n    \"/usr/lib/systemd/systemd\", \"/usr/sbin/crond\", \"/usr/bin/pamac-daemon\", \"/usr/sbin/mkhomedir_helper\",\n    \"/opt/pbis/sbin/lwsmd\", \"/usr/sbin/oddjobd\"\n  ) or\n  file.extension in (\"swp\", \"swpx\", \"swx\", \"dpkg-remove\") or\n  file.Ext.original.extension == \"dpkg-new\" or\n  process.executable : (\n    \"/nix/store/*\", \"/var/lib/dpkg/*\", \"/tmp/vmis.*\", \"/snap/*\", \"/dev/fd/*\", \"/usr/lib/virtualbox/*\",\n    \"/usr/libexec/platform-python*\"\n  ) or\n  process.executable == null or\n  process.name in (\"adclient\", \"mkhomedir_helper\", \"teleport\", \"mkhomedir\", \"adduser\", \"desktopDaemon\") or\n  (process.name == \"sed\" and file.name : \"sed*\") or\n  (process.name == \"perl\" and file.name : \"e2scrub_all.tmp*\") \n)",
        "language": "eql",
        "index": [
          "logs-endpoint.events.file*"
        ],
        "filters": []
      },
      {
        "name": "System V Init Script Created",
        "description": "Files that are placed in the /etc/init.d/ directory in Unix can be used to start custom applications, services, scripts or commands during start-up. Init.d has been mostly replaced in favor of Systemd. However, the \"systemd-sysv-generator\" can convert init.d files to service unit files that run at boot. Adversaries may add or alter files located in the /etc/init.d/ directory to execute malicious code upon boot in order to gain persistence on the system.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating System V Init Script Created\n\nThe `/etc/init.d` directory is used in Linux systems to store the initialization scripts for various services and daemons that are executed during system startup and shutdown.\n\nAttackers can abuse files within the `/etc/init.d/` directory to run scripts, commands or malicious software every time a system is rebooted by converting an executable file into a service file through the `systemd-sysv-generator`. After conversion, a unit file is created within the `/run/systemd/generator.late/` directory.\n\nThis rule looks for the creation of new files within the `/etc/init.d/` directory. Executable files in these directories will automatically run at boot with root privileges.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n> This investigation guide uses [placeholder fields](https://www.elastic.co/guide/en/security/current/osquery-placeholder-fields.html) to dynamically pass alert data into Osquery queries. Placeholder fields were introduced in Elastic Stack version 8.7.0. If you're using Elastic Stack version 8.6.0 or earlier, you'll need to manually adjust this investigation guide's queries to ensure they properly run.\n#### Possible Investigation Steps\n\n- Investigate the file that was created or modified.\n  - !{osquery{\"label\":\"Osquery - Retrieve File Information\",\"query\":\"SELECT * FROM file WHERE path = {{file.path}}\"}}\n- Investigate whether any other files in the `/etc/init.d/` or `/run/systemd/generator.late/` directories have been altered.\n  - !{osquery{\"label\":\"Osquery - Retrieve File Listing Information\",\"query\":\"SELECT * FROM file WHERE path LIKE '/etc/init.d/%'\"}}\n  - !{osquery{\"label\":\"Osquery - Retrieve Additional File Listing Information\",\"query\":\"SELECT f.path, u.username AS file_owner, g.groupname AS group_owner, datetime(f.atime, 'unixepoch') AS\\nfile_last_access_time, datetime(f.mtime, 'unixepoch') AS file_last_modified_time, datetime(f.ctime, 'unixepoch') AS\\nfile_last_status_change_time, datetime(f.btime, 'unixepoch') AS file_created_time, f.size AS size_bytes FROM file f LEFT\\nJOIN users u ON f.uid = u.uid LEFT JOIN groups g ON f.gid = g.gid WHERE path LIKE '/etc/init.d/%'\\n\"}}\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence and whether they are located in expected locations.\n  - !{osquery{\"label\":\"Osquery - Retrieve Running Processes by User\",\"query\":\"SELECT pid, username, name FROM processes p JOIN users u ON u.uid = p.uid ORDER BY username\"}}\n- Investigate syslog through the `sudo cat /var/log/syslog | grep 'LSB'` command to find traces of the LSB header of the script (if present). If syslog is being ingested into Elasticsearch, the same can be accomplished through Kibana.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Validate whether this activity is related to planned patches, updates, network administrator activity, or legitimate software installations.\n- Investigate whether the altered scripts call other malicious scripts elsewhere on the file system. \n  - If scripts or executables were dropped, retrieve the files and determine if they are malicious:\n    - Use a private sandboxed malware analysis system to perform analysis.\n      - Observe and collect information about the following activities:\n        - Attempts to contact external domains and addresses.\n          - Check if the domain is newly registered or unexpected.\n          - Check the reputation of the domain or IP address.\n        - File access, modification, and creation activities.\n        - Cron jobs, services and other persistence mechanisms.\n            - !{osquery{\"label\":\"Osquery - Retrieve Crontab Information\",\"query\":\"SELECT * FROM crontab\"}}\n\n### False Positive Analysis\n\n- If this activity is related to new benign software installation activity, consider adding exceptions — preferably with a combination of user and command line conditions.\n- If this activity is related to a system administrator who uses init.d for administrative purposes, consider adding exceptions for this specific administrator user account. \n- Try to understand the context of the execution by thinking about the user, machine, or business purpose. A small number of endpoints, such as servers with unique software, might appear unusual but satisfy a specific business need.\n\n### Related Rules\n\n- Suspicious File Creation in /etc for Persistence - 1c84dd64-7e6c-4bad-ac73-a5014ee37042\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Delete the maliciously created service/init.d files or restore it to the original configuration.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Leverage the incident response data and logging to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 13,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Data Source: Elastic Endgame",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.intezer.com/blog/malware-analysis/hiddenwasp-malware-targeting-linux-systems/",
          "https://pberba.github.io/security/2022/02/06/linux-threat-hunting-for-persistence-initialization-scripts-and-shell-configuration/#8-boot-or-logon-initialization-scripts-rc-scripts",
          "https://www.cyberciti.biz/faq/how-to-enable-rc-local-shell-script-on-systemd-while-booting-linux-system/",
          "https://www.elastic.co/security-labs/sequel-on-persistence-mechanisms"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1037",
                "name": "Boot or Logon Initialization Scripts",
                "reference": "https://attack.mitre.org/techniques/T1037/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "82c0b1d5-e056-4e9e-85be-f0ca76e2393a",
        "rule_id": "474fd20e-14cc-49c5-8160-d9ab4ba16c8b",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:31.950Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:30.189Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"linux\" and event.action in (\"creation\", \"file_create_event\", \"rename\", \"file_rename_event\")\nand file.path : \"/etc/init.d/*\" and not (\n  process.executable in (\n    \"/bin/dpkg\", \"/usr/bin/dpkg\", \"/bin/dockerd\", \"/usr/bin/dockerd\", \"/usr/sbin/dockerd\", \"/bin/microdnf\",\n    \"/usr/bin/microdnf\", \"/bin/rpm\", \"/usr/bin/rpm\", \"/bin/snapd\", \"/usr/bin/snapd\", \"/bin/yum\", \"/usr/bin/yum\",\n    \"/bin/dnf\", \"/usr/bin/dnf\", \"/bin/podman\", \"/usr/bin/podman\", \"/bin/dnf-automatic\", \"/usr/bin/dnf-automatic\",\n    \"/bin/pacman\", \"/usr/bin/pacman\", \"/usr/bin/dpkg-divert\", \"/bin/dpkg-divert\", \"/sbin/apk\", \"/usr/sbin/apk\",\n    \"/usr/local/sbin/apk\", \"/usr/bin/apt\", \"/usr/sbin/pacman\", \"/bin/podman\", \"/usr/bin/podman\", \"/usr/bin/puppet\",\n    \"/bin/puppet\", \"/opt/puppetlabs/puppet/bin/puppet\", \"/usr/bin/chef-client\", \"/bin/chef-client\",\n    \"/bin/autossl_check\", \"/usr/bin/autossl_check\", \"/proc/self/exe\", \"/dev/fd/*\",  \"/usr/bin/pamac-daemon\",\n    \"/bin/pamac-daemon\", \"/usr/lib/snapd/snapd\", \"/usr/local/bin/dockerd\"\n  ) or\n  file.extension in (\"swp\", \"swpx\", \"swx\", \"dpkg-remove\") or\n  file.path like (\"/etc/init.d/*beat*\", \"/etc/init.d/elastic-agent*\") or\n  process.executable like (\"/nix/store/*\", \"/var/lib/dpkg/*\", \"/snap/*\", \"/dev/fd/*\", \"/usr/lib/virtualbox/*\") or\n  process.name in (\"docker-init\", \"jumpcloud-agent\", \"crio\") or\n  process.executable == null or\n  (process.name == \"ln\" and file.path : \"/etc/init.d/rc*.d/*\") or\n  (process.name == \"sed\" and file.name : \"sed*\") or\n  (process.name == \"perl\" and file.name : \"e2scrub_all.tmp*\") \n)",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "Attempt to Modify an Okta Policy",
        "description": "Detects attempts to modify an Okta policy. An adversary may attempt to modify an Okta policy in order to weaken an organization's security controls. For example, an adversary may attempt to modify an Okta multi-factor authentication (MFA) policy in order to weaken the authentication requirements for user accounts.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Attempt to Modify an Okta Policy\n\nModifications to Okta policies may indicate attempts to weaken an organization's security controls. If such an attempt is detected, consider the following steps for investigation.\n\n#### Possible investigation steps:\n- Identify the actor associated with the event. Check the fields `okta.actor.id`, `okta.actor.type`, `okta.actor.alternate_id`, and `okta.actor.display_name`.\n- Determine the client used by the actor. You can look at `okta.client.device`, `okta.client.ip`, `okta.client.user_agent.raw_user_agent`, `okta.client.ip_chain.ip`, and `okta.client.geographical_context`.\n- Check the nature of the policy modification. You can review the `okta.target` field, especially `okta.target.display_name` and `okta.target.id`.\n- Examine the `okta.outcome.result` and `okta.outcome.reason` fields to understand the outcome of the modification attempt.\n- Check if there have been other similar modification attempts in a short time span from the same actor or IP address.\n\n### False positive analysis:\n- This alert might be a false positive if Okta policies are regularly updated in your organization as a part of normal operations.\n- Check if the actor associated with the event has legitimate rights to modify the Okta policies.\n- Verify the actor's geographical location and the time of the modification attempt. If these align with the actor's regular behavior, it could be a false positive.\n\n### Response and remediation:\n- If unauthorized modification is confirmed, initiate the incident response process.\n- Lock the actor's account and enforce password change as an immediate response.\n- Reset MFA tokens for the actor and enforce re-enrollment, if applicable.\n- Review any other actions taken by the actor to assess the overall impact.\n- If the attack was facilitated by a particular technique, ensure your systems are patched or configured to prevent such techniques.\n- Consider a security review of your Okta policies and rules to ensure they follow security best practices.",
        "output_index": "",
        "version": 410,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Data Source: Okta",
          "Tactic: Defense Evasion"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Consider adding exceptions to this rule to filter false positives if Okta policies are regularly modified in your organization."
        ],
        "references": [
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.007",
                    "name": "Disable or Modify Cloud Firewall",
                    "reference": "https://attack.mitre.org/techniques/T1562/007/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "0bb6368c-1eac-4168-a9f4-72d4a4531d12",
        "rule_id": "6731fbf2-8f28-49ed-9ab9-9a918ceb5a45",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:31.953Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:35.272Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset:okta.system and event.action:policy.lifecycle.update",
        "language": "kuery"
      },
      {
        "name": "Attempt to Deactivate an Okta Policy Rule",
        "description": "Detects attempts to deactivate a rule within an Okta policy. An adversary may attempt to deactivate a rule within an Okta policy in order to remove or weaken an organization's security controls.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Attempt to Deactivate an Okta Policy Rule\n\nIdentity and Access Management (IAM) systems like Okta serve as the first line of defense for an organization's network, and are often targeted by adversaries. By disabling security rules, adversaries can circumvent multi-factor authentication, access controls, or other protective measures enforced by these policies, enabling unauthorized access, privilege escalation, or other malicious activities.\n\nThis rule detects attempts to deactivate a rule within an Okta policy, which could be indicative of an adversary's attempt to weaken an organization's security controls. A threat actor may do this to remove barriers to their activities or enable future attacks.\n\n#### Possible investigation steps:\n\n- Identify the actor related to the alert by reviewing `okta.actor.id`, `okta.actor.type`, `okta.actor.alternate_id`, or `okta.actor.display_name` fields in the alert.\n- Review the `okta.client.user_agent.raw_user_agent` field to understand the device and software used by the actor.\n- Examine the `okta.outcome.reason` field for additional context around the deactivation attempt.\n- Check the `okta.outcome.result` field to confirm the policy rule deactivation attempt.\n- Check if there are multiple policy rule deactivation attempts from the same actor or IP address (`okta.client.ip`).\n- Check for successful logins immediately following the policy rule deactivation attempt.\n- Verify whether the actor's activity aligns with typical behavior or if any unusual activity took place around the time of the deactivation attempt.\n\n### False positive analysis:\n\n- Check if there were issues with the Okta system at the time of the deactivation attempt. This could indicate a system error rather than a genuine threat activity.\n- Check the geographical location (`okta.request.ip_chain.geographical_context`) and time of the deactivation attempt. If these match the actor's normal behavior, it might be a false positive.\n- Verify the actor's administrative rights to ensure they are correctly configured.\n\n### Response and remediation:\n\n- If unauthorized policy rule deactivation is confirmed, initiate the incident response process.\n- Immediately lock the affected actor account and require a password change.\n- Consider resetting MFA tokens for the actor and require re-enrollment.\n- Check if the compromised account was used to access or alter any sensitive data or systems.\n- If a specific deactivation technique was used, ensure your systems are patched or configured to prevent such techniques.\n- Assess the criticality of affected services and servers.\n- Work with your IT team to minimize the impact on users and maintain business continuity.\n- If multiple accounts are affected, consider a broader reset or audit of MFA tokens.\n- Implement security best practices [outlined](https://www.okta.com/blog/2019/10/9-admin-best-practices-to-keep-your-org-secure/) by Okta.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).",
        "output_index": "",
        "version": 411,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Tactic: Defense Evasion",
          "Data Source: Okta"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Consider adding exceptions to this rule to filter false positives if Okta MFA rules are regularly deactivated in your organization."
        ],
        "references": [
          "https://help.okta.com/en/prod/Content/Topics/Security/Security_Policies.htm",
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.007",
                    "name": "Disable or Modify Cloud Firewall",
                    "reference": "https://attack.mitre.org/techniques/T1562/007/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "36d310a4-8ca6-4431-a46c-068f93a2ce49",
        "rule_id": "cc92c835-da92-45c9-9f29-b4992ad621a0",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:31.956Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:45.726Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset:okta.system and event.action:policy.rule.deactivate",
        "language": "kuery"
      },
      {
        "name": "Unauthorized Scope for Public App OAuth2 Token Grant with Client Credentials",
        "description": "Identifies a failed OAuth 2.0 token grant attempt for a public client app using client credentials. This event is generated when a public client app attempts to exchange a client credentials grant for an OAuth 2.0 access token, but the request is denied due to the lack of required scopes. This could indicate compromised client credentials in which an adversary is attempting to obtain an access token for unauthorized scopes. This is a [New Terms](https://www.elastic.co/guide/en/security/master/rules-ui-create.html#create-new-terms-rule) rule where the `okta.actor.display_name` field value has not been seen in the last 14 days regarding this event.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 205,
        "tags": [
          "Domain: SaaS",
          "Data Source: Okta",
          "Use Case: Threat Detection",
          "Use Case: Identity and Access Audit",
          "Tactic: Defense Evasion"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.blog/news-insights/company-news/security-alert-stolen-oauth-user-tokens/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1550",
                "name": "Use Alternate Authentication Material",
                "reference": "https://attack.mitre.org/techniques/T1550/",
                "subtechnique": [
                  {
                    "id": "T1550.001",
                    "name": "Application Access Token",
                    "reference": "https://attack.mitre.org/techniques/T1550/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "okta.actor.display_name",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "okta.actor.type",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "okta.client.user_agent.raw_user_agent",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "okta.debug_context.debug_data.flattened.grantType",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "okta.debug_context.debug_data.flattened.requestedScopes",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "okta.outcome.reason",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "okta.outcome.result",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "0fb5b660-7cb5-4595-b7dc-c5c0bfd43a75",
        "rule_id": "6649e656-6f85-11ef-8876-f661ea17fbcc",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:31.959Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:35.231Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "event.dataset: okta.system\n    and event.action: \"app.oauth2.as.token.grant\"\n    and okta.actor.type: \"PublicClientApp\"\n    and okta.debug_context.debug_data.flattened.grantType: \"client_credentials\"\n    and okta.outcome.result: \"FAILURE\"\n    and not okta.client.user_agent.raw_user_agent: \"Okta-Integrations\"\n    and not okta.actor.display_name: (Okta* or Datadog)\n    and not okta.debug_context.debug_data.flattened.requestedScopes: (\"okta.logs.read\" or \"okta.eventHooks.read\" or \"okta.inlineHooks.read\")\n    and okta.outcome.reason: \"no_matching_scope\"",
        "new_terms_fields": [
          "okta.actor.display_name"
        ],
        "history_window_start": "now-14d",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Attempt to Delete an Okta Application",
        "description": "Detects attempts to delete an Okta application. An adversary may attempt to modify, deactivate, or delete an Okta application in order to weaken an organization's security controls or disrupt their business operations.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 409,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Data Source: Okta",
          "Tactic: Impact"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Consider adding exceptions to this rule to filter false positives if your organization's Okta applications are regularly deleted and the behavior is expected."
        ],
        "references": [
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0040",
              "name": "Impact",
              "reference": "https://attack.mitre.org/tactics/TA0040/"
            },
            "technique": [
              {
                "id": "T1489",
                "name": "Service Stop",
                "reference": "https://attack.mitre.org/techniques/T1489/"
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "17705fbd-c3c8-454f-a334-2ddee31aab47",
        "rule_id": "d48e1c13-4aca-4d1f-a7b1-a9161c0ad86f",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:31.962Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:47.165Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset:okta.system and event.action:application.lifecycle.delete",
        "language": "kuery"
      },
      {
        "name": "AWS Bedrock Guardrails Detected Multiple Violations by a Single User Over a Session",
        "description": "Identifies multiple violations of AWS Bedrock guardrails by the same user in the same account over a session. Multiple violations implies that a user may be intentionally attempting to cirvumvent security controls, access sensitive information, or possibly exploit a vulnerability in the system.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Amazon Bedrock Guardrail Multiple Policy Violations by a Single User Over a Session.\n\nAmazon Bedrock Guardrail is a set of features within Amazon Bedrock designed to help businesses apply robust safety and privacy controls to their generative AI applications.\n\nIt enables users to set guidelines and filters that manage content quality, relevancy, and adherence to responsible AI practices.\n\nThrough Guardrail, organizations can define \"denied topics\" to prevent the model from generating content on specific, undesired subjects,\nand they can establish thresholds for harmful content categories, including hate speech, violence, or offensive language.\n\n#### Possible investigation steps\n\n- Identify the user account that caused multiple policy violations over a session and whether it should perform this kind of action.\n- Investigate the user activity that might indicate a potential brute force attack.\n- Investigate other alerts associated with the user account during the past 48 hours.\n- Consider the time of day. If the user is a human (not a program or script), did the activity take place during a normal time of day?\n- Examine the account's prompts and responses in the last 24 hours.\n- If you suspect the account has been compromised, scope potentially compromised assets by tracking Amazon Bedrock model access, prompts generated, and responses to the prompts by the account in the last 24 hours.\n\n### False positive analysis\n\n- Verify the user account that caused multiple policy violations by a single user over session, is not testing any new model deployments or updated compliance policies in Amazon Bedrock guardrails.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Disable or limit the account during the investigation and response.\n- Identify the possible impact of the incident and prioritize accordingly; the following actions can help you gain context:\n    - Identify the account role in the cloud environment.\n    - Identify if the attacker is moving laterally and compromising other Amazon Bedrock Services.\n    - Identify any regulatory or legal ramifications related to this activity.\n- Review the permissions assigned to the implicated user group or role behind these requests to ensure they are authorized and expected to access bedrock and ensure that the least privilege principle is being followed.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection via the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 4,
        "tags": [
          "Domain: LLM",
          "Data Source: AWS Bedrock",
          "Data Source: AWS S3",
          "Resources: Investigation Guide",
          "Use Case: Policy Violation",
          "Mitre Atlas: T0051",
          "Mitre Atlas: T0054"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-3600s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Legitimate misunderstanding by users or overly strict policies"
        ],
        "references": [
          "https://docs.aws.amazon.com/bedrock/latest/userguide/guardrails-components.html",
          "https://atlas.mitre.org/techniques/AML.T0051",
          "https://atlas.mitre.org/techniques/AML.T0054",
          "https://www.elastic.co/security-labs/elastic-advances-llm-security"
        ],
        "max_signals": 100,
        "threat": [],
        "setup": "## Setup\n\nThis rule requires that guardrails are configured in AWS Bedrock. For more information, see the AWS Bedrock documentation:\n\nhttps://docs.aws.amazon.com/bedrock/latest/userguide/guardrails-create.html\n",
        "related_integrations": [],
        "required_fields": [],
        "id": "10314165-2740-4903-b84b-1a9d52d32d6f",
        "rule_id": "0cd2f3e6-41da-40e6-b28b-466f688f00a6",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:31.965Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:23.678Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "esql",
        "language": "esql",
        "query": "from logs-aws_bedrock.invocation-*\n| where gen_ai.compliance.violation_detected\n| keep user.id, gen_ai.request.model.id, cloud.account.id\n| stats violations = count(*) by user.id, gen_ai.request.model.id, cloud.account.id\n| where violations > 1\n| sort violations desc"
      },
      {
        "name": "Multiple Okta Sessions Detected for a Single User",
        "description": "Detects when a user has started multiple Okta sessions with the same user account and different session IDs. This may indicate that an attacker has stolen the user's session cookie and is using it to access the user's account from a different location.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 206,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Data Source: Okta",
          "Tactic: Lateral Movement"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-3600s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "A user may have multiple sessions open at the same time, such as on a mobile device and a laptop."
        ],
        "references": [
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://sec.okta.com/articles/2023/08/cross-tenant-impersonation-prevention-and-detection",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1550",
                "name": "Use Alternate Authentication Material",
                "reference": "https://attack.mitre.org/techniques/T1550/",
                "subtechnique": [
                  {
                    "id": "T1550.004",
                    "name": "Web Session Cookie",
                    "reference": "https://attack.mitre.org/techniques/T1550/004/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "okta.actor.display_name",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "okta.actor.id",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "okta.authentication_context.external_session_id",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "okta.event_type",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "4329725e-3f03-4c2f-9d16-299261959a31",
        "rule_id": "621e92b6-7e54-11ee-bdc0-f661ea17fbcd",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": true
        },
        "updated_at": "2024-12-16T14:22:31.968Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:33.543Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "threshold",
        "query": "event.dataset:okta.system and okta.event_type:user.session.start and okta.authentication_context.external_session_id:*\n    and not (okta.actor.id: okta* or okta.actor.display_name: okta*)",
        "threshold": {
          "field": [
            "okta.actor.id"
          ],
          "value": 1,
          "cardinality": [
            {
              "field": "okta.authentication_context.external_session_id",
              "value": 3
            }
          ]
        },
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "AWS S3 Bucket Enumeration or Brute Force",
        "description": "Identifies a high number of failed S3 operations from a single source and account (or anonymous account) within a short timeframe. This activity can be indicative of attempting to cause an increase in billing to an account for excessive random operations, cause resource exhaustion, or enumerating bucket names for discovery.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating AWS S3 Bucket Enumeration or Brute Force\n\nAWS S3 buckets can be be brute forced to cause financial impact against the resource owner. What makes this even riskier is that even private, locked down buckets can still trigger a potential cost, even with an \"Access Denied\", while also being accessible from unauthenticated, anonymous accounts. This also appears to work on several or all [operations](https://docs.aws.amazon.com/cli/latest/reference/s3api/) (GET, PUT, list-objects, etc.). Additionally, buckets are trivially discoverable by default as long as the bucket name is known, making it vulnerable to enumeration for discovery.\n\nAttackers may attempt to enumerate names until a valid bucket is discovered and then pivot to cause financial impact, enumerate for more information, or brute force in other ways to attempt to exfil data.\n\n#### Possible investigation steps\n\n- Examine the history of the operation requests from the same `source.address` and `cloud.account.id` to determine if there is other suspicious activity.\n- Review similar requests and look at the `user.agent` info to ascertain the source of the requests (though do not overly rely on this since it is controlled by the requestor).\n- Review other requests to the same `aws.s3.object.key` as well as other `aws.s3.object.key` accessed by the same `cloud.account.id` or `source.address`.\n- Investigate other alerts associated with the user account during the past 48 hours.\n- Validate the activity is not related to planned patches, updates, or network administrator activity.\n- Examine the request parameters. These may indicate the source of the program or the nature of the task being performed when the error occurred.\n    - Check whether the error is related to unsuccessful attempts to enumerate or access objects, data, or secrets.\n- Considering the source IP address and geolocation of the user who issued the command:\n    - Do they look normal for the calling user?\n    - If the source is an EC2 IP address, is it associated with an EC2 instance in one of your accounts or is the source IP from an EC2 instance that's not under your control?\n    - If it is an authorized EC2 instance, is the activity associated with normal behavior for the instance role or roles? Are there any other alerts or signs of suspicious activity involving this instance?\n- Consider the time of day. If the user is a human (not a program or script), did the activity take place during a normal time of day?\n- Contact the account owner and confirm whether they are aware of this activity if suspicious.\n- If you suspect the account has been compromised, scope potentially compromised assets by tracking servers, services, and data accessed by the account in the last 24 hours.\n\n### False positive analysis\n\n- Verify the `source.address` and `cloud.account.id` - there are some valid operations from within AWS directly that can cause failures and false positives. Additionally, failed automation can also caeuse false positives, but should be identifiable by reviewing the `source.address` and `cloud.account.id`.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Disable or limit the account during the investigation and response.\n- Identify the possible impact of the incident and prioritize accordingly; the following actions can help you gain context:\n    - Identify the account role in the cloud environment.\n    - Assess the criticality of affected services and servers.\n    - Work with your IT team to identify and minimize the impact on users.\n    - Identify if the attacker is moving laterally and compromising other accounts, servers, or services.\n    - Identify any regulatory or legal ramifications related to this activity.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords or delete API keys as needed to revoke the attacker's access to the environment. Work with your IT teams to minimize the impact on business operations during these actions.\n- Check if unauthorized new users were created, remove unauthorized new accounts, and request password resets for other IAM users.\n- Consider enabling multi-factor authentication for users.\n- Review the permissions assigned to the implicated user to ensure that the least privilege principle is being followed.\n- Implement security best practices [outlined](https://aws.amazon.com/premiumsupport/knowledge-center/security-best-practices/) by AWS.\n- Take the actions needed to return affected systems, data, or services to their normal operational levels.\n- Identify the initial vector abused by the attacker and take action to prevent reinfection via the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n- Check for PutBucketPolicy event actions as well to see if they have been tampered with. While we monitor for denied, a single successful action to add a backdoor into the bucket via policy updates (however they got permissions) may be critical to identify during TDIR.\n\n",
        "output_index": "",
        "investigation_fields": {
          "field_names": [
            "source.address",
            "tls.client.server_name",
            "cloud.account.id",
            "failed_requests"
          ]
        },
        "version": 4,
        "tags": [
          "Domain: Cloud",
          "Data Source: AWS",
          "Data Source: Amazon Web Services",
          "Data Source: AWS S3",
          "Resources: Investigation Guide",
          "Use Case: Log Auditing",
          "Tactic: Impact"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Known or internal account IDs or automation"
        ],
        "references": [
          "https://medium.com/@maciej.pocwierz/how-an-empty-s3-bucket-can-make-your-aws-bill-explode-934a383cb8b1",
          "https://docs.aws.amazon.com/cli/latest/reference/s3api/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0040",
              "name": "Impact",
              "reference": "https://attack.mitre.org/tactics/TA0040/"
            },
            "technique": [
              {
                "id": "T1657",
                "name": "Financial Theft",
                "reference": "https://attack.mitre.org/techniques/T1657/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1580",
                "name": "Cloud Infrastructure Discovery",
                "reference": "https://attack.mitre.org/techniques/T1580/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0009",
              "name": "Collection",
              "reference": "https://attack.mitre.org/tactics/TA0009/"
            },
            "technique": [
              {
                "id": "T1530",
                "name": "Data from Cloud Storage",
                "reference": "https://attack.mitre.org/techniques/T1530/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [],
        "required_fields": [],
        "id": "f0746037-27a5-433e-ab3a-834f462416ea",
        "rule_id": "5f0234fd-7f21-42af-8391-511d5fd11d5c",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:31.971Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:32.973Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "esql",
        "language": "esql",
        "query": "from logs-aws.cloudtrail*\n| where event.provider == \"s3.amazonaws.com\" and aws.cloudtrail.error_code == \"AccessDenied\"\n// keep only relevant fields\n| keep tls.client.server_name, source.address, cloud.account.id\n| stats failed_requests = count(*) by tls.client.server_name, source.address, cloud.account.id\n  // can modify the failed request count or tweak time window to fit environment\n  // can add `not cloud.account.id in (KNOWN)` or specify in exceptions\n| where failed_requests > 40"
      },
      {
        "name": "Linux User Added to Privileged Group",
        "description": "Identifies attempts to add a user to a privileged group. Attackers may add users to a privileged group in order to establish persistence on a system.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Linux User User Added to Privileged Group\n\nThe `usermod`, `adduser`, and `gpasswd` commands can be used to assign user accounts to new groups in Linux-based operating systems.\n\nAttackers may add users to a privileged group in order to escalate privileges or establish persistence on a system or domain.\n\nThis rule identifies the usages of `usermod`, `adduser` and `gpasswd` to assign user accounts to a privileged group.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n> This investigation guide uses [placeholder fields](https://www.elastic.co/guide/en/security/current/osquery-placeholder-fields.html) to dynamically pass alert data into Osquery queries. Placeholder fields were introduced in Elastic Stack version 8.7.0. If you're using Elastic Stack version 8.6.0 or earlier, you'll need to manually adjust this investigation guide's queries to ensure they properly run.\n\n#### Possible investigation steps\n\n- Investigate whether the user was succesfully added to the privileged group.\n  - !{osquery{\"label\":\"Osquery - Retrieve Information for a Specific User\",\"query\":\"SELECT * FROM users WHERE username = {{user.name}}\"}}\n- Investigate whether the user is currently logged in and active.\n  - !{osquery{\"label\":\"Osquery - Investigate the Account Authentication Status\",\"query\":\"SELECT * FROM logged_in_users WHERE user = {{user.name}}\"}}\n- Retrieve information about the privileged group to which the user was added.\n  - !{osquery{\"label\":\"Osquery - Retrieve Information for a Specific Group\",\"query\":\"SELECT * FROM groups WHERE groupname = {{group.name}}\"}}\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence and whether they are located in expected locations.\n  - !{osquery{\"label\":\"Osquery - Retrieve Running Processes by User\",\"query\":\"SELECT pid, username, name FROM processes p JOIN users u ON u.uid = p.uid ORDER BY username\"}}\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n\n### False positive analysis\n\n- Adding accounts to a group is a common administrative task, so there is a high chance of the activity being legitimate. Before investigating further, verify that this activity is not benign.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Review the privileges assigned to the involved users to ensure that the least privilege principle is being followed.\n- Delete the account that seems to be involved in malicious activity.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 8,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Data Source: Elastic Endgame",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend",
          "Data Source: Auditd Manager"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/security-labs/primer-on-persistence-mechanisms"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1136",
                "name": "Create Account",
                "reference": "https://attack.mitre.org/techniques/T1136/",
                "subtechnique": [
                  {
                    "id": "T1136.001",
                    "name": "Local Account",
                    "reference": "https://attack.mitre.org/techniques/T1136/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "auditd_manager",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "b354c08f-c374-4ddc-8a49-9003248e8a76",
        "rule_id": "43d6ec12-2b1c-47b5-8f35-e9de65551d3b",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:31.974Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:30.147Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\", \"executed\", \"process_started\")\n and process.args in (\n  \"root\", \"admin\", \"wheel\", \"staff\", \"sudo\",\"disk\", \"video\", \"shadow\", \"lxc\", \"lxd\"\n) and\n(\n  process.name in (\"usermod\", \"adduser\") or\n  (process.name == \"gpasswd\" and process.args in (\"-a\", \"--add\", \"-M\", \"--members\")) \n)",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*",
          "auditbeat-*",
          "logs-auditd_manager.auditd-*"
        ],
        "filters": []
      },
      {
        "name": "Okta Sign-In Events via Third-Party IdP",
        "description": "Detects sign-in events where authentication is carried out via a third-party Identity Provider (IdP).",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Okta Sign-In Events via Third-Party IdP\n\nThis rule detects sign-in events where authentication is carried out via a third-party Identity Provider (IdP).\n\nAdversaries may attempt to add an unauthorized IdP to an Okta tenant to gain access to the tenant. Following this action, adversaries may attempt to sign in to the tenant using the unauthorized IdP. This rule detects both the addition of an unauthorized IdP and the subsequent sign-in attempt.\n\n#### Possible investigation steps:\n- Identify the third-party IdP by examining the `okta.authentication_context.issuer.id` field.\n- Once the third-party IdP is identified, determine if this IdP is authorized to be used by the tenant.\n- If the IdP is unauthorized, deactivate it immediately via the Okta console.\n- Identify the actor associated with the IdP creation by examining the `okta.actor.id`, `okta.actor.type`, `okta.actor.alternate_id`, and `okta.actor.display_name` fields in historical data.\n    - The `New Okta Identity Provider (IdP) Added by Admin` rule may be helpful in identifying the actor and the IdP creation event.\n- Determine the client used by the actor. Review the `okta.client.ip`, `okta.client.user_agent.raw_user_agent`, `okta.client.zone`, `okta.client.device`, and `okta.client.id` fields.\n- If the client is a device, check the `okta.device.id`, `okta.device.name`, `okta.device.os_platform`, `okta.device.os_version`, and `okta.device.managed` fields.\n- Review the past activities of the actor involved in this action by checking their previous actions logged in the `okta.target` field.\n- Examine the `okta.request.ip_chain` field to potentially determine if the actor used a proxy or VPN to perform this action.\n- Evaluate the actions that happened just before and after this event in the `okta.event_type` field to help understand the full context of the activity.\n\n### False positive analysis:\n- It might be a false positive if this IdP is authorized to be used by the tenant.\n- This may be a false positive if an authorized third-party IdP is used to sign in to the tenant but failures occurred due to an incorrect configuration.\n\n### Response and remediation:\n- If the IdP is unauthorized, deactivate it immediately via the Okta console.\n- Reset the effected user's password and enforce MFA re-enrollment, if applicable.\n- Mobile device forensics may be required to determine if the user's device is compromised.\n- If the IdP is authorized, ensure that the actor who created it is authorized to do so.\n- If the actor is unauthorized, deactivate their account via the Okta console.\n- If the actor is authorized, ensure that the actor's account is not compromised.\n\n- Block the IP address or device used in the attempts if they appear suspicious, using the data from the `okta.client.ip` and `okta.device.id` fields.\n- Conduct a review of Okta policies and ensure they are in accordance with security best practices.\n- If the deactivated IdP was crucial to the organization, consider adding a new IdP and removing the unauthorized IdP.",
        "output_index": "",
        "version": 206,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Tactic: Initial Access",
          "Data Source: Okta"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "15m",
        "from": "now-1800s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://blog.cloudflare.com/cloudflare-investigation-of-the-january-2022-okta-compromise/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://sec.okta.com/articles/2023/08/cross-tenant-impersonation-prevention-and-detection",
          "https://unit42.paloaltonetworks.com/muddled-libra/",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1199",
                "name": "Trusted Relationship",
                "reference": "https://attack.mitre.org/techniques/T1199/"
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "okta.authentication_context.issuer.id",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "okta.debug_context.debug_data.request_uri",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "okta.outcome.reason",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "okta.outcome.result",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "759e8167-b0d8-4a71-94aa-f6f7d9103c64",
        "rule_id": "1ceb05c4-7d25-11ee-9562-f661ea17fbcd",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:31.977Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:25.795Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset:okta.system and okta.debug_context.debug_data.request_uri:/oauth2/v1/authorize/callback and\n    (not okta.authentication_context.issuer.id:Okta and event.action:(user.authentication.auth_via_IDP\n        or user.authentication.auth_via_inbound_SAML\n        or user.authentication.auth_via_mfa\n        or user.authentication.auth_via_social)\n        or event.action:user.session.start) or\n    (event.action:user.authentication.auth_via_IDP and okta.outcome.result:FAILURE\n        and okta.outcome.reason:(\"A SAML assert with the same ID has already been processed by Okta for a previous request\"\n            or \"Unable to match transformed username\"\n            or \"Unable to resolve IdP endpoint\"\n            or \"Unable to validate SAML Response\"\n            or \"Unable to validate incoming SAML Assertion\"))",
        "language": "kuery"
      },
      {
        "name": "Systemd Generator Created",
        "description": "This rule detects the creation of a systemd generator file. Generators are small executables executed by systemd at bootup and during configuration reloads. Their main role is to convert non-native configuration and execution parameters into dynamically generated unit files, symlinks, or drop-ins, extending the unit file hierarchy for the service manager. Systemd generators can be used to execute arbitrary code at boot time, which can be leveraged by attackers to maintain persistence on a Linux system.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 3,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Tactic: Privilege Escalation",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://pberba.github.io/security/2022/02/07/linux-threat-hunting-for-persistence-systemd-generators/",
          "https://www.elastic.co/security-labs/primer-on-persistence-mechanisms"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1543",
                "name": "Create or Modify System Process",
                "reference": "https://attack.mitre.org/techniques/T1543/",
                "subtechnique": [
                  {
                    "id": "T1543.002",
                    "name": "Systemd Service",
                    "reference": "https://attack.mitre.org/techniques/T1543/002/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1543",
                "name": "Create or Modify System Process",
                "reference": "https://attack.mitre.org/techniques/T1543/",
                "subtechnique": [
                  {
                    "id": "T1543.002",
                    "name": "Systemd Service",
                    "reference": "https://attack.mitre.org/techniques/T1543/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.Ext.original.extension",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "62103ec7-9565-4df8-9bc7-56a23bc83414",
        "rule_id": "39c06367-b700-4380-848a-cab06e7afede",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:31.980Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:28.705Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"linux\" and event.action in (\"rename\", \"creation\") and file.path : (\n\"/run/systemd/system-generators/*\", \"/etc/systemd/system-generators/*\",\n\"/usr/local/lib/systemd/system-generators/*\", \"/lib/systemd/system-generators/*\",\n\"/usr/lib/systemd/system-generators/*\", \"/etc/systemd/user-generators/*\",\n\"/usr/local/lib/systemd/user-generators/*\", \"/usr/lib/systemd/user-generators/*\",\n\"/lib/systemd/user-generators/*\"\n) and not (\n  process.executable in (\n    \"/bin/dpkg\", \"/usr/bin/dpkg\", \"/bin/dockerd\", \"/usr/bin/dockerd\", \"/usr/sbin/dockerd\", \"/bin/microdnf\",\n    \"/usr/bin/microdnf\", \"/bin/rpm\", \"/usr/bin/rpm\", \"/bin/snapd\", \"/usr/bin/snapd\", \"/bin/yum\", \"/usr/bin/yum\",\n    \"/bin/dnf\", \"/usr/bin/dnf\", \"/bin/podman\", \"/usr/bin/podman\", \"/bin/dnf-automatic\", \"/usr/bin/dnf-automatic\",\n    \"/bin/pacman\", \"/usr/bin/pacman\", \"/usr/bin/dpkg-divert\", \"/bin/dpkg-divert\", \"/sbin/apk\", \"/usr/sbin/apk\",\n    \"/usr/local/sbin/apk\", \"/usr/bin/apt\", \"/usr/sbin/pacman\", \"/bin/podman\", \"/usr/bin/podman\", \"/usr/bin/puppet\",\n    \"/bin/puppet\", \"/opt/puppetlabs/puppet/bin/puppet\", \"/usr/bin/chef-client\", \"/bin/chef-client\", \"/usr/sbin/sshd\",\n    \"/bin/autossl_check\", \"/usr/bin/autossl_check\", \"/proc/self/exe\", \"/dev/fd/*\",  \"/usr/bin/pamac-daemon\",\n    \"/bin/pamac-daemon\", \"/usr/lib/snapd/snapd\", \"/usr/local/bin/dockerd\", \"/usr/libexec/platform-python\"\n  ) or\n  file.extension in (\"swp\", \"swpx\", \"swx\", \"dpkg-remove\") or\n  file.Ext.original.extension == \"dpkg-new\" or\n  process.executable == null\n)",
        "language": "eql",
        "index": [
          "logs-endpoint.events.file*"
        ],
        "filters": []
      },
      {
        "name": "Okta User Session Impersonation",
        "description": "A user has initiated a session impersonation granting them access to the environment with the permissions of the user they are impersonating. This would likely indicate Okta administrative access and should only ever occur if requested and expected.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Okta User Session Impersonation\n\nThe detection of an Okta User Session Impersonation indicates that a user has initiated a session impersonation which grants them access with the permissions of the user they are impersonating. This type of activity typically indicates Okta administrative access and should only ever occur if requested and expected.\n\n#### Possible investigation steps\n\n- Identify the actor associated with the impersonation event by checking the `okta.actor.id`, `okta.actor.type`, `okta.actor.alternate_id`, or `okta.actor.display_name` fields.\n- Review the `event.action` field to confirm the initiation of the impersonation event.\n- Check the `event.time` field to understand the timing of the event.\n- Check the `okta.target.id`, `okta.target.type`, `okta.target.alternate_id`, or `okta.target.display_name` to identify the user who was impersonated.\n- Review any activities that occurred during the impersonation session. Look for any activities related to the impersonated user's account during and after the impersonation event.\n\n### False positive analysis\n\n- Verify if the session impersonation was part of an approved activity. Check if it was associated with any documented administrative tasks or troubleshooting efforts.\n- Ensure that the impersonation session was initiated by an authorized individual. You can check this by verifying the `okta.actor.id` or `okta.actor.display_name` against the list of approved administrators.\n\n### Response and remediation\n\n- If the impersonation was not authorized, consider it as a breach. Suspend the user account of the impersonator immediately.\n- Reset the user session and invalidate any active sessions related to the impersonated user.\n- If a specific impersonation technique was used, ensure that systems are patched or configured to prevent such techniques.\n- Conduct a thorough investigation to understand the extent of the breach and the potential impact on the systems and data.\n- Review and update your security policies to prevent such incidents in the future.\n- Implement additional monitoring and logging of Okta events to improve visibility of user actions.",
        "output_index": "",
        "version": 411,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Tactic: Credential Access",
          "Data Source: Okta"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "15m",
        "from": "now-1800s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://blog.cloudflare.com/cloudflare-investigation-of-the-january-2022-okta-compromise/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta",
          "https://www.elastic.co/security-labs/okta-and-lapsus-what-you-need-to-know"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            }
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "2e62b0d8-75a9-43a1-a10c-89c0c28edee3",
        "rule_id": "cdbebdc1-dc97-43c6-a538-f26a20c0a911",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:31.989Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:45.756Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset:okta.system and event.action:user.session.impersonation.initiate",
        "language": "kuery"
      },
      {
        "name": "Network Connection from Binary with RWX Memory Region",
        "description": "Monitors for the execution of a unix binary with read, write and execute memory region permissions, followed by a network connection. The mprotect() system call is used to change the access protections on a region of memory that has already been allocated. This syscall allows a process to modify the permissions of pages in its virtual address space, enabling or disabling permissions such as read, write, and execute for those pages. RWX permissions on memory is in many cases overly permissive, and should (especially in conjunction with an outbound network connection) be analyzed thoroughly.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 3,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Data Source: Elastic Defend",
          "Data Source: Auditd Manager"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://man7.org/linux/man-pages/man2/mprotect.2.html",
          "https://www.elastic.co/security-labs/linux-detection-engineering-with-auditd"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.004",
                    "name": "Unix Shell",
                    "reference": "https://attack.mitre.org/techniques/T1059/004/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            },
            "technique": [
              {
                "id": "T1071",
                "name": "Application Layer Protocol",
                "reference": "https://attack.mitre.org/techniques/T1071/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires the use of the `auditd_manager` integration. `Auditd_manager` is a tool designed to simplify and enhance the management of the audit subsystem in Linux systems. It provides a user-friendly interface and automation capabilities for configuring and monitoring system auditing through the auditd daemon. With `auditd_manager`, administrators can easily define audit rules, track system events, and generate comprehensive audit reports, improving overall security and compliance in the system. The following steps should be executed in order to install and deploy `auditd_manager` on a Linux system.\n```\nKibana -->\nManagement -->\nIntegrations -->\nAuditd Manager -->\nAdd Auditd Manager\n```\n`Auditd_manager` subscribes to the kernel and receives events as they occur without any additional configuration. However, if more advanced configuration is required to detect specific behavior, audit rules can be added to the integration in either the \"audit rules\" configuration box or the \"auditd rule files\" box by specifying a file to read the audit rules from.\nFor this detection rule to trigger, the following additional audit rules are required to be added to the integration:\n```\n-a always,exit -F arch=b64 -S mprotect\n```\nAdd the newly installed `auditd manager` to an agent policy, and deploy the agent on a Linux system from which auditd log files are desirable.\n",
        "related_integrations": [
          {
            "package": "auditd_manager",
            "version": "^1.0.0"
          },
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "auditd.data.a2",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "auditd.data.syscall",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "destination.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pid",
            "type": "long",
            "ecs": true
          }
        ],
        "id": "98763d59-85b8-4fb0-972e-9f525690a941",
        "rule_id": "32300431-c2d5-432d-8ec8-0e03f9924756",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:31.992Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:27.999Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sample by host.id, process.pid, process.name\n  /* auditd.data.a2 == \"7\" translates to RWX memory region protection (PROT_READ | PROT_WRITE | PROT_EXEC) */\n  [process where host.os.type == \"linux\" and auditd.data.syscall == \"mprotect\" and auditd.data.a2 == \"7\" and\n   not process.name == \"httpd\"]\n  [network where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"connection_attempted\" and\n   not cidrmatch(destination.ip, \"127.0.0.0/8\", \"169.254.0.0/16\", \"224.0.0.0/4\", \"::1\")]",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "auditbeat-*",
          "logs-auditd_manager.auditd-*"
        ],
        "filters": []
      },
      {
        "name": "Attempt to Delete an Okta Network Zone",
        "description": "Detects attempts to delete an Okta network zone. Okta network zones can be configured to limit or restrict access to a network based on IP addresses or geolocations. An adversary may attempt to modify, delete, or deactivate an Okta network zone in order to remove or weaken an organization's security controls.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Attempt to Delete an Okta Network Zone\n\nOkta network zones can be configured to limit or restrict access to a network based on IP addresses or geolocations. Deleting a network zone in Okta might remove or weaken the security controls of an organization, which might be an indicator of an adversary's attempt to evade defenses.\n\n#### Possible investigation steps:\n\n- Identify the actor associated with the alert by examining the `okta.actor.id`, `okta.actor.type`, `okta.actor.alternate_id`, or `okta.actor.display_name` fields.\n- Examine the `event.action` field to confirm the deletion of a network zone.\n- Investigate the `okta.target.id`, `okta.target.type`, `okta.target.alternate_id`, or `okta.target.display_name` fields to identify the network zone that was deleted.\n- Review the `event.time` field to understand when the event happened.\n- Check the actor's activities before and after the event to understand the context of this event.\n\n### False positive analysis:\n\n- Verify the `okta.client.user_agent.raw_user_agent` field to understand the device and software used by the actor. If these match the actor's typical behavior, it might be a false positive.\n- Check if the actor is a known administrator or a member of the IT team who might have a legitimate reason to delete a network zone.\n- Cross-verify the actor's actions with any known planned changes or maintenance activities.\n\n### Response and remediation:\n\n- If unauthorized access or actions are confirmed, immediately lock the affected actor's account and require a password change.\n- If a network zone was deleted without authorization, create a new network zone with similar settings as the deleted one.\n- Review and update the privileges of the actor who initiated the deletion.\n- Identify any gaps in the security policies and procedures and update them as necessary.\n- Implement additional monitoring and logging of Okta events to improve visibility of user actions.\n- Communicate and train the employees about the importance of following proper procedures for modifying network zone settings.",
        "output_index": "",
        "version": 410,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Data Source: Okta",
          "Use Case: Network Security Monitoring",
          "Tactic: Defense Evasion"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Consider adding exceptions to this rule to filter false positives if Oyour organization's Okta network zones are regularly deleted."
        ],
        "references": [
          "https://help.okta.com/en/prod/Content/Topics/Security/network/network-zones.htm",
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.007",
                    "name": "Disable or Modify Cloud Firewall",
                    "reference": "https://attack.mitre.org/techniques/T1562/007/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "a3f27abd-1300-459d-affa-b8cc33c7d223",
        "rule_id": "c749e367-a069-4a73-b1f2-43a3798153ad",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:31.998Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:45.088Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset:okta.system and event.action:zone.delete",
        "language": "kuery"
      },
      {
        "name": "Attempt to Delete an Okta Policy Rule",
        "description": "Detects attempts to delete a rule within an Okta policy. An adversary may attempt to delete an Okta policy rule in order to weaken an organization's security controls.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Attempt to Delete an Okta Policy Rule\n\nOkta policy rules are integral components of an organization's security controls, as they define how user access to resources is managed. Deletion of a rule within an Okta policy could potentially weaken the organization's security posture, allowing for unauthorized access or facilitating other malicious activities.\n\nThis rule detects attempts to delete an Okta policy rule, which could indicate an adversary's attempt to weaken an organization's security controls. Adversaries may do this to circumvent security measures and enable further malicious activities.\n\n#### Possible investigation steps:\n\n- Identify the actor related to the alert by reviewing `okta.actor.id`, `okta.actor.type`, `okta.actor.alternate_id`, or `okta.actor.display_name` fields in the alert.\n- Review the `okta.client.user_agent.raw_user_agent` field to understand the device and software used by the actor.\n- Examine the `okta.outcome.reason` field for additional context around the deletion attempt.\n- Check the `okta.outcome.result` field to confirm the policy rule deletion attempt.\n- Check if there are multiple policy rule deletion attempts from the same actor or IP address (`okta.client.ip`).\n- Check for successful logins immediately following the policy rule deletion attempt.\n- Verify whether the actor's activity aligns with typical behavior or if any unusual activity took place around the time of the deletion attempt.\n\n### False positive analysis:\n\n- Check if there were issues with the Okta system at the time of the deletion attempt. This could indicate a system error rather than a genuine threat activity.\n- Check the geographical location (`okta.request.ip_chain.geographical_context`) and time of the deletion attempt. If these match the actor's normal behavior, it might be a false positive.\n- Verify the actor's administrative rights to ensure they are correctly configured.\n\n### Response and remediation:\n\n- If unauthorized policy rule deletion is confirmed, initiate the incident response process.\n- Immediately lock the affected actor account and require a password change.\n- Consider resetting MFA tokens for the actor and require re-enrollment.\n- Check if the compromised account was used to access or alter any sensitive data or systems.\n- If a specific deletion technique was used, ensure your systems are patched or configured to prevent such techniques.\n- Assess the criticality of affected services and servers.\n- Work with your IT team to minimize the impact on users and maintain business continuity.\n- If multiple accounts are affected, consider a broader reset or audit of MFA tokens.\n- Implement security best practices [outlined](https://www.okta.com/blog/2019/10/9-admin-best-practices-to-keep-your-org-secure/) by Okta.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).",
        "output_index": "",
        "version": 410,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Data Source: Okta",
          "Tactic: Defense Evasion"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Consider adding exceptions to this rule to filter false positives if Okta MFA rules are regularly modified in your organization."
        ],
        "references": [
          "https://help.okta.com/en/prod/Content/Topics/Security/Security_Policies.htm",
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.007",
                    "name": "Disable or Modify Cloud Firewall",
                    "reference": "https://attack.mitre.org/techniques/T1562/007/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "4ff968cc-837d-4263-b784-4cf100de9810",
        "rule_id": "d5d86bf5-cf0c-4c06-b688-53fdc072fdfd",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:31.995Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:47.204Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset:okta.system and event.action:policy.rule.delete",
        "language": "kuery"
      },
      {
        "name": "Unauthorized Access to an Okta Application",
        "description": "Identifies unauthorized access attempts to Okta applications.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 410,
        "tags": [
          "Tactic: Initial Access",
          "Use Case: Identity and Access Audit",
          "Data Source: Okta"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic",
          "Austin Songer"
        ],
        "false_positives": [],
        "references": [
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1078",
                "name": "Valid Accounts",
                "reference": "https://attack.mitre.org/techniques/T1078/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            }
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            }
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            }
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "65c9eff9-0162-48d7-b61d-534dca148d05",
        "rule_id": "4edd3e1a-3aa0-499b-8147-4d2ea43b1613",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:32.001Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:30.320Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset:okta.system and event.action:app.generic.unauth_app_access_attempt",
        "language": "kuery"
      },
      {
        "name": "MFA Deactivation with no Re-Activation for Okta User Account",
        "description": "Detects multi-factor authentication (MFA) deactivation with no subsequent re-activation for an Okta user account. An adversary may deactivate MFA for an Okta user account in order to weaken the authentication requirements for the account.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating MFA Deactivation with no Re-Activation for Okta User Account\n\nMFA is used to provide an additional layer of security for user accounts. An adversary may achieve MFA deactivation for an Okta user account to achieve persistence.\n\nThis rule fires when an Okta user account has MFA deactivated and no subsequent MFA reactivation is observed within 12 hours.\n\n#### Possible investigation steps:\n\n- Identify the actor related to the alert by reviewing `okta.actor.alternate_id` field in the alert. This should give the username of the account being targeted.\n- Review `okta.target` or `user.target.full_name` fields to determine if deactivation was performed by a se parate user.\n- Using the `okta.actor.alternate_id` field, search  for MFA re-activation events where `okta.event_type` is `user.mfa.factor.activate`.\n- Review events where `okta.event_type` is `user.authenticate*` to determine if the user account had suspicious login activity.\n    - Geolocation details found in `client.geo*` related fields may be useful in determining if the login activity was suspicious for this user.\n\n#### False positive steps:\n\n- Determine with the target user if MFA deactivation was expected.\n- Determine if MFA is required for the target user account.\n\n#### Response and remediation:\n\n- If the MFA deactivation was not expected, consider deactivating the user\n    - This should be followed by resetting the user's password and re-enabling MFA.\n- If the MFA deactivation was expected, consider adding an exception to this rule to filter false positives.\n- Investigate the source of the attack. If a specific machine or network is compromised, additional steps may need to be taken to address the issue.\n- Encourage users to use complex, unique passwords and consider implementing multi-factor authentication.\n- Check if the compromised account was used to access or alter any sensitive data, applications or systems.\n- Review the client user-agent to determine if it's a known custom application that can be whitelisted.\n",
        "output_index": "",
        "version": 412,
        "tags": [
          "Tactic: Persistence",
          "Use Case: Identity and Access Audit",
          "Data Source: Okta",
          "Domain: Cloud"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "6h",
        "from": "now-43200s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "If the behavior of deactivating MFA for Okta user accounts is expected, consider adding exceptions to this rule to filter false positives."
        ],
        "references": [
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1556",
                "name": "Modify Authentication Process",
                "reference": "https://attack.mitre.org/techniques/T1556/",
                "subtechnique": [
                  {
                    "id": "T1556.006",
                    "name": "Multi-Factor Authentication",
                    "reference": "https://attack.mitre.org/techniques/T1556/006/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.\n",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "okta.actor.id",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "okta.event_type",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "okta.outcome.reason",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "okta.outcome.result",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "3cf92b9b-059d-4e79-b3f0-2b8c61724487",
        "rule_id": "cd89602e-9db0-48e3-9391-ae3bf241acd8",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:32.004Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:45.750Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by okta.actor.id with maxspan=12h\n    [any where event.dataset == \"okta.system\" and okta.event_type in (\"user.mfa.factor.deactivate\", \"user.mfa.factor.reset_all\")\n        and okta.outcome.reason != \"User reset SECURITY_QUESTION factor\" and okta.outcome.result == \"SUCCESS\"]\n    ![any where event.dataset == \"okta.system\" and okta.event_type == \"user.mfa.factor.activate\"]",
        "language": "eql",
        "index": [
          "filebeat-*",
          "logs-okta.system*"
        ],
        "filters": []
      },
      {
        "name": "Potential Abuse of Resources by High Token Count and Large Response Sizes",
        "description": "Detects potential resource exhaustion or data breach attempts by monitoring for users who consistently generate high input token counts, submit numerous requests, and receive large responses. This behavior could indicate an attempt to overload the system or extract an unusually large amount of data, possibly revealing sensitive information or causing service disruptions.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Amazon Bedrock Models High Token Count and Large Response Sizes.\n\nAmazon Bedrock is AWS’s managed service that enables developers to build and scale generative AI applications using large foundation models (FMs) from top providers.\n\nBedrock offers a variety of pretrained models from Amazon (such as the Titan series), as well as models from providers like Anthropic, Meta, Cohere, and AI21 Labs.\n\n#### Possible investigation steps\n\n- Identify the user account that used high prompt token counts and whether it should perform this kind of action.\n- Investigate large response sizes and the number of requests made by the user account.\n- Investigate other alerts associated with the user account during the past 48 hours.\n- Consider the time of day. If the user is a human (not a program or script), did the activity take place during a normal time of day?\n- Examine the account's prompts and responses in the last 24 hours.\n- If you suspect the account has been compromised, scope potentially compromised assets by tracking Amazon Bedrock model access, prompts generated, and responses to the prompts by the account in the last 24 hours.\n\n### False positive analysis\n\n- Verify the user account that used high prompt and large response sizes, has a business justification for the heavy usage of the system.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Disable or limit the account during the investigation and response.\n- Identify the possible impact of the incident and prioritize accordingly; the following actions can help you gain context:\n    - Identify the account role in the cloud environment.\n    - Identify if the attacker is moving laterally and compromising other Amazon Bedrock Services.\n    - Identify any regulatory or legal ramifications related to this activity.\n    - Identify potential resource exhaustion and impact on billing.\n- Review the permissions assigned to the implicated user group or role behind these requests to ensure they are authorized and expected to access bedrock and ensure that the least privilege principle is being followed.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection via the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 3,
        "tags": [
          "Domain: LLM",
          "Data Source: AWS Bedrock",
          "Data Source: Amazon Web Services",
          "Data Source: AWS S3",
          "Use Case: Potential Overload",
          "Use Case: Resource Exhaustion",
          "Mitre Atlas: LLM04"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-3600s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Authorized heavy usage of the system that is business justified and monitored."
        ],
        "references": [
          "https://atlas.mitre.org/techniques/AML.T0051",
          "https://owasp.org/www-project-top-10-for-large-language-model-applications/",
          "https://www.elastic.co/security-labs/elastic-advances-llm-security"
        ],
        "max_signals": 100,
        "threat": [],
        "setup": "## Setup\n\nThis rule requires that guardrails are configured in AWS Bedrock. For more information, see the AWS Bedrock documentation:\n\nhttps://docs.aws.amazon.com/bedrock/latest/userguide/guardrails-create.html\n",
        "related_integrations": [],
        "required_fields": [],
        "id": "993342c8-25b2-4099-ae53-60d616253717",
        "rule_id": "b1773d05-f349-45fb-9850-287b8f92f02d",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:32.007Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:42.945Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "esql",
        "language": "esql",
        "query": "from logs-aws_bedrock.invocation-*\n| keep user.id, gen_ai.usage.prompt_tokens, gen_ai.usage.completion_tokens\n| stats max_tokens = max(gen_ai.usage.prompt_tokens),\n         total_requests = count(*),\n         avg_response_size = avg(gen_ai.usage.completion_tokens)\n  by user.id\n// tokens count depends on specific LLM, as is related to how embeddings are generated.\n| where max_tokens > 5000 and total_requests > 10 and avg_response_size > 500\n| eval risk_factor = (max_tokens / 1000) * total_requests * (avg_response_size / 500)\n| where risk_factor > 10\n| sort risk_factor desc"
      },
      {
        "name": "New Okta Authentication Behavior Detected",
        "description": "Detects events where Okta behavior detection has identified a new authentication behavior.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating New Okta Authentication Behavior Detected\n\nThis rule detects events where Okta behavior detection has identified a new authentication behavior such as a new device or location.\n\n#### Possible investigation steps:\n- Identify the user involved in this action by examining the `okta.actor.id`, `okta.actor.type`, `okta.actor.alternate_id`, and `okta.actor.display_name` fields.\n- Determine the authentication anomaly by examining the `okta.debug_context.debug_data.risk_behaviors` and `okta.debug_context.debug_data.flattened` fields.\n- Determine the client used by the actor. Review the `okta.client.ip`, `okta.client.user_agent.raw_user_agent`, `okta.client.zone`, `okta.client.device`, and `okta.client.id` fields.\n- If the client is a device, check the `okta.device.id`, `okta.device.name`, `okta.device.os_platform`, `okta.device.os_version`, and `okta.device.managed` fields.\n- Review the past activities of the actor involved in this action by checking their previous actions.\n- Examine the `okta.request.ip_chain` field to potentially determine if the actor used a proxy or VPN to perform this action.\n- Evaluate the actions that happened just before and after this event in the `okta.event_type` field to help understand the full context of the activity.\n\n### False positive analysis:\n- A user may be using a new device or location to sign in.\n- The Okta behavior detection may be incorrectly identifying a new authentication behavior and need adjusted.\n\n### Response and remediation:\n- If the user is legitimate and the authentication behavior is not suspicious, no action is required.\n- If the user is legitimate but the authentication behavior is suspicious, consider resetting the user's password and enabling multi-factor authentication (MFA).\n    - If MFA is already enabled, consider resetting MFA for the user.\n- If the user is not legitimate, consider deactivating the user's account.\n- If this is a false positive, consider adjusting the Okta behavior detection settings.\n- Block the IP address or device used in the attempts if they appear suspicious, using the data from the `okta.client.ip` and `okta.device.id` fields.\n- Conduct a review of Okta policies and ensure they are in accordance with security best practices.",
        "output_index": "",
        "version": 206,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Tactic: Initial Access",
          "Data Source: Okta"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "15m",
        "from": "now-1800s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://sec.okta.com/articles/2023/08/cross-tenant-impersonation-prevention-and-detection",
          "https://unit42.paloaltonetworks.com/muddled-libra/",
          "https://help.okta.com/oie/en-us/content/topics/security/behavior-detection/about-behavior-detection.htm",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            }
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "okta.debug_context.debug_data.risk_behaviors",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "4aafdb8b-609c-4528-9eb4-c30dba8eb20c",
        "rule_id": "260486ee-7d98-11ee-9599-f661ea17fbcd",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:32.010Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:25.968Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset:okta.system and okta.debug_context.debug_data.risk_behaviors:*",
        "language": "kuery"
      },
      {
        "name": "Systemd Service Created",
        "description": "This rule detects the creation or renaming of a new Systemd file in all of the common Systemd service locations for both root and regular users. Systemd service files are configuration files in Linux systems used to define and manage system services. Malicious actors can leverage systemd service files to achieve persistence by creating or modifying services to execute malicious commands or payloads during system startup or at a predefined interval by adding a systemd timer. This allows them to maintain unauthorized access, execute additional malicious activities, or evade detection.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Systemd Service Created\n\nSystemd service files are configuration files in Linux systems used to define and manage system services.\n\nMalicious actors can leverage systemd service files to achieve persistence by creating or modifying service files to execute malicious commands or payloads during system startup. This allows them to maintain unauthorized access, execute additional malicious activities, or evade detection.\n\nThis rule monitors the creation of new systemd service files, potentially indicating the creation of a persistence mechanism.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n> This investigation guide uses [placeholder fields](https://www.elastic.co/guide/en/security/current/osquery-placeholder-fields.html) to dynamically pass alert data into Osquery queries. Placeholder fields were introduced in Elastic Stack version 8.7.0. If you're using Elastic Stack version 8.6.0 or earlier, you'll need to manually adjust this investigation guide's queries to ensure they properly run.\n\n#### Possible Investigation Steps\n\n- Investigate the systemd service file that was created or modified.\n  - !{osquery{\"label\":\"Osquery - Retrieve File Information\",\"query\":\"SELECT * FROM file WHERE path = {{file.path}}\"}}\n- Investigate the currently enabled systemd services through the following command `sudo systemctl list-unit-files`.\n- Investigate whether any other files in any of the available systemd directories have been altered through OSQuery.\n  - !{osquery{\"label\":\"Osquery - Retrieve File Listing Information\",\"query\":\"SELECT * FROM file WHERE (path LIKE '/etc/systemd/system/%' OR path LIKE '/usr/local/lib/systemd/system/%' OR path LIKE\\n'/lib/systemd/system/%' OR path LIKE '/usr/lib/systemd/system/%' OR path LIKE\\n'/home/{{user.name}}/.config/systemd/user/%' OR path LIKE '/home/{{user.name}}/.local/share/systemd/user/%' OR path LIKE\\n'/root/.config/systemd/user/%' OR path LIKE '/root/.local/share/systemd/user/%' OR path LIKE '/etc/systemd/user/%' OR\\npath LIKE '/usr/lib/systemd/user/%')\\n\"}}\n  - !{osquery{\"label\":\"Osquery - Retrieve Additional File Listing Information\",\"query\":\"SELECT f.path, u.username AS file_owner, g.groupname AS group_owner, datetime(f.atime, 'unixepoch') AS\\nfile_last_access_time, datetime(f.mtime, 'unixepoch') AS file_last_modified_time, datetime(f.ctime, 'unixepoch') AS\\nfile_last_status_change_time, datetime(f.btime, 'unixepoch') AS file_created_time, f.size AS size_bytes FROM file f LEFT\\nJOIN users u ON f.uid = u.uid LEFT JOIN groups g ON f.gid = g.gid WHERE ( path LIKE '/etc/systemd/system/%' OR path LIKE\\n'/usr/local/lib/systemd/system/%' OR path LIKE '/lib/systemd/system/%' OR path LIKE '/usr/lib/systemd/system/%' OR path\\nLIKE '/home/{{user.name}}/.config/systemd/user/%' OR path LIKE '/home/{{user.name}}/.local/share/systemd/user/%' OR path\\nLIKE '/root/.config/systemd/user/%' OR path LIKE '/root/.local/share/systemd/user/%' OR path LIKE '/etc/systemd/user/%'\\nOR path LIKE '/usr/lib/systemd/user/%')\\n\"}}\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence and whether they are located in expected locations.\n  - !{osquery{\"label\":\"Osquery - Retrieve Running Processes by User\",\"query\":\"SELECT pid, username, name FROM processes p JOIN users u ON u.uid = p.uid ORDER BY username\"}}\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Validate the activity is not related to planned patches, updates, network administrator activity, or legitimate software installations.\n- Investigate whether the altered scripts call other malicious scripts elsewhere on the file system. \n  - If scripts or executables were dropped, retrieve the files and determine if they are malicious:\n    - Use a private sandboxed malware analysis system to perform analysis.\n      - Observe and collect information about the following activities:\n        - Attempts to contact external domains and addresses.\n          - Check if the domain is newly registered or unexpected.\n          - Check the reputation of the domain or IP address.\n        - File access, modification, and creation activities.\n        - Cron jobs, services and other persistence mechanisms.\n            - !{osquery{\"label\":\"Osquery - Retrieve Crontab Information\",\"query\":\"SELECT * FROM crontab\"}}\n- Investigate abnormal behaviors by the subject process/user such as network connections, file modifications, and any other spawned child processes.\n  - Investigate listening ports and open sockets to look for potential command and control traffic or data exfiltration.\n    - !{osquery{\"label\":\"Osquery - Retrieve Listening Ports\",\"query\":\"SELECT pid, address, port, socket, protocol, path FROM listening_ports\"}}\n    - !{osquery{\"label\":\"Osquery - Retrieve Open Sockets\",\"query\":\"SELECT pid, family, remote_address, remote_port, socket, state FROM process_open_sockets\"}}\n  - Identify the user account that performed the action, analyze it, and check whether it should perform this kind of action.\n    - !{osquery{\"label\":\"Osquery - Retrieve Information for a Specific User\",\"query\":\"SELECT * FROM users WHERE username = {{user.name}}\"}}\n- Investigate whether the user is currently logged in and active.\n    - !{osquery{\"label\":\"Osquery - Investigate the Account Authentication Status\",\"query\":\"SELECT * FROM logged_in_users WHERE user = {{user.name}}\"}}\n\n### False Positive Analysis\n\n- If this activity is related to new benign software installation activity, consider adding exceptions — preferably with a combination of user and command line conditions.\n- If this activity is related to a system administrator who uses systemd services for administrative purposes, consider adding exceptions for this specific administrator user account. \n- Try to understand the context of the execution by thinking about the user, machine, or business purpose. A small number of endpoints, such as servers with unique software, might appear unusual but satisfy a specific business need.\n\n### Related Rules\n\n- Potential Persistence Through Run Control Detected - 0f4d35e4-925e-4959-ab24-911be207ee6f\n- Potential Persistence Through init.d Detected - 474fd20e-14cc-49c5-8160-d9ab4ba16c8b\n- Systemd Timer Created - 7fb500fa-8e24-4bd1-9480-2a819352602c\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Delete the service/timer or restore its original configuration.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Leverage the incident response data and logging to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 15,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Tactic: Privilege Escalation",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://pberba.github.io/security/2022/01/30/linux-threat-hunting-for-persistence-systemd-timers-cron/",
          "https://www.elastic.co/security-labs/primer-on-persistence-mechanisms"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1543",
                "name": "Create or Modify System Process",
                "reference": "https://attack.mitre.org/techniques/T1543/",
                "subtechnique": [
                  {
                    "id": "T1543.002",
                    "name": "Systemd Service",
                    "reference": "https://attack.mitre.org/techniques/T1543/002/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1543",
                "name": "Create or Modify System Process",
                "reference": "https://attack.mitre.org/techniques/T1543/",
                "subtechnique": [
                  {
                    "id": "T1543.002",
                    "name": "Systemd Service",
                    "reference": "https://attack.mitre.org/techniques/T1543/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.Ext.original.extension",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "08a9daac-0267-431b-bb09-5384d5d716a2",
        "rule_id": "17b0a495-4d9f-414c-8ad0-92f018b8e001",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:32.013Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:24.407Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"linux\" and event.action in (\"rename\", \"creation\") and file.path : (\n  \"/etc/systemd/system/*\", \"/etc/systemd/user/*\", \"/usr/local/lib/systemd/system/*\",\n  \"/lib/systemd/system/*\", \"/usr/lib/systemd/system/*\", \"/usr/lib/systemd/user/*\",\n  \"/home/*/.config/systemd/user/*\", \"/home/*/.local/share/systemd/user/*\",\n  \"/root/.config/systemd/user/*\", \"/root/.local/share/systemd/user/*\"\n) and file.extension == \"service\" and not (\n  process.executable in (\n    \"/bin/dpkg\", \"/usr/bin/dpkg\", \"/bin/dockerd\", \"/usr/bin/dockerd\", \"/usr/sbin/dockerd\", \"/bin/microdnf\",\n    \"/usr/bin/microdnf\", \"/bin/rpm\", \"/usr/bin/rpm\", \"/bin/snapd\", \"/usr/bin/snapd\", \"/bin/yum\", \"/usr/bin/yum\",\n    \"/bin/dnf\", \"/usr/bin/dnf\", \"/bin/podman\", \"/usr/bin/podman\", \"/bin/dnf-automatic\", \"/usr/bin/dnf-automatic\",\n    \"/bin/pacman\", \"/usr/bin/pacman\", \"/usr/bin/dpkg-divert\", \"/bin/dpkg-divert\", \"/sbin/apk\", \"/usr/sbin/apk\",\n    \"/usr/local/sbin/apk\", \"/usr/bin/apt\", \"/usr/sbin/pacman\", \"/bin/podman\", \"/usr/bin/podman\", \"/usr/bin/puppet\",\n    \"/bin/puppet\", \"/opt/puppetlabs/puppet/bin/puppet\", \"/usr/bin/chef-client\", \"/bin/chef-client\",\n    \"/bin/autossl_check\", \"/usr/bin/autossl_check\", \"/proc/self/exe\", \"/dev/fd/*\",  \"/usr/bin/pamac-daemon\",\n    \"/bin/pamac-daemon\", \"/usr/lib/snapd/snapd\", \"/usr/local/bin/dockerd\", \"/usr/bin/crio\", \"/usr/sbin/crond\",\n    \"/opt/puppetlabs/puppet/bin/ruby\", \"/usr/libexec/platform-python\", \"/kaniko/kaniko-executor\",\n    \"/usr/local/bin/dockerd\", \"/usr/bin/podman\", \"/bin/install\", \"/proc/self/exe\", \"/usr/lib/systemd/systemd\",\n    \"/usr/sbin/sshd\", \"/usr/bin/gitlab-runner\", \"/opt/gitlab/embedded/bin/ruby\", \"/usr/sbin/gdm\", \"/usr/bin/install\",\n    \"/usr/local/manageengine/uems_agent/bin/dcregister\"\n  ) or\n  file.extension in (\"swp\", \"swpx\", \"swx\", \"dpkg-remove\") or\n  file.Ext.original.extension == \"dpkg-new\" or\n  process.executable : (\n    \"/nix/store/*\", \"/var/lib/dpkg/*\", \"/tmp/vmis.*\", \"/snap/*\", \"/dev/fd/*\", \"/usr/lib/virtualbox/*\"\n  ) or\n  process.executable == null or\n  process.name like (\n    \"ssm-agent-worker\", \"python*\", \"platform-python*\", \"dnf_install\", \"cloudflared\", \"lxc-pve-prestart-hook\",\n    \"convert-usrmerge\", \"elastic-agent\", \"google_metadata_script_runner\", \"update-alternatives\", \"gitlab-runner\",\n    \"install\", \"crio\", \"apt-get\", \"package-cleanup\", \"dcservice\", \"dcregister\", \"jumpcloud-agent\", \"executor\"\n  ) or\n  (process.name == \"sed\" and file.name : \"sed*\") or\n  (process.name == \"perl\" and file.name : \"e2scrub_all.tmp*\") \n)",
        "language": "eql",
        "index": [
          "logs-endpoint.events.file*"
        ],
        "filters": []
      },
      {
        "name": "Attempt to Modify an Okta Application",
        "description": "Detects attempts to modify an Okta application. An adversary may attempt to modify, deactivate, or delete an Okta application in order to weaken an organization's security controls or disrupt their business operations.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 409,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Data Source: Okta",
          "Tactic: Impact"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Consider adding exceptions to this rule to filter false positives if your organization's Okta applications are regularly modified and the behavior is expected."
        ],
        "references": [
          "https://help.okta.com/en/prod/Content/Topics/Apps/Apps_Apps.htm",
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0040",
              "name": "Impact",
              "reference": "https://attack.mitre.org/tactics/TA0040/"
            }
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "1d7e7a29-a2a6-4b1a-b25e-a1dac0a526d6",
        "rule_id": "c74fd275-ab2c-4d49-8890-e2943fa65c09",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:32.016Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:45.093Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset:okta.system and event.action:application.lifecycle.update",
        "language": "kuery"
      },
      {
        "name": "Okta Brute Force or Password Spraying Attack",
        "description": "Identifies a high number of failed Okta user authentication attempts from a single IP address, which could be indicative of a brute force or password spraying attack. An adversary may attempt a brute force or password spraying attack to obtain unauthorized access to user accounts.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Okta Brute Force or Password Spraying Attack\n\nThis rule alerts when a high number of failed Okta user authentication attempts occur from a single IP address. This could be indicative of a brute force or password spraying attack, where an adversary may attempt to gain unauthorized access to user accounts by guessing the passwords.\n\n#### Possible investigation steps:\n\n- Review the `source.ip` field to identify the IP address from which the high volume of failed login attempts originated.\n- Look into the `event.outcome` field to verify that these are indeed failed authentication attempts.\n- Determine the `user.name` or `user.email` related to these failed login attempts. If the attempts are spread across multiple accounts, it might indicate a password spraying attack.\n- Check the timeline of the events. Are the failed attempts spread out evenly, or are there burst periods, which might indicate an automated tool?\n- Determine the geographical location of the source IP. Is this location consistent with the user's typical login location?\n- Analyze any previous successful logins from this IP. Was this IP previously associated with successful logins?\n\n### False positive analysis:\n\n- A single user or automated process that attempts to authenticate using expired or wrong credentials multiple times may trigger a false positive.\n- Analyze the behavior of the source IP. If the IP is associated with legitimate users or services, it may be a false positive.\n\n### Response and remediation:\n\n- If you identify unauthorized access attempts, consider blocking the source IP at the firewall level.\n- Notify the users who are targeted by the attack. Ask them to change their passwords and ensure they use unique, complex passwords.\n- Enhance monitoring on the affected user accounts for any suspicious activity.\n- If the attack is persistent, consider implementing CAPTCHA or account lockouts after a certain number of failed login attempts.\n- If the attack is persistent, consider implementing multi-factor authentication (MFA) for the affected user accounts.\n- Review and update your security policies based on the findings from the incident.",
        "output_index": "",
        "version": 412,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Tactic: Credential Access",
          "Data Source: Okta"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Automated processes that attempt to authenticate using expired credentials and unbounded retries may lead to false positives."
        ],
        "references": [
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1110",
                "name": "Brute Force",
                "reference": "https://attack.mitre.org/techniques/T1110/"
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "5b05fac2-9477-4124-999a-9f4ea365fb87",
        "rule_id": "42bf698b-4738-445b-8231-c834ddefd8a0",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:32.019Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:30.133Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "threshold",
        "query": "event.dataset:okta.system and event.category:authentication and event.outcome:failure",
        "threshold": {
          "field": [
            "source.ip"
          ],
          "value": 25
        },
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Attempt to Revoke Okta API Token",
        "description": "Identifies attempts to revoke an Okta API token. An adversary may attempt to revoke or delete an Okta API token to disrupt an organization's business operations.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Attempt to Revoke Okta API Token\n\nThe rule alerts when attempts are made to revoke an Okta API token. The API tokens are critical for integration services, and revoking them may lead to disruption in services. Therefore, it's important to validate these activities.\n\n#### Possible investigation steps:\n- Identify the actor associated with the API token revocation attempt. You can use the `okta.actor.alternate_id` field for this purpose.\n- Determine the client used by the actor. Review the `okta.client.device`, `okta.client.ip`, `okta.client.user_agent.raw_user_agent`, `okta.client.ip_chain.ip`, and `okta.client.geographical_context` fields.\n- Verify if the API token revocation was authorized or part of some planned activity.\n- Check the `okta.outcome.result` and `okta.outcome.reason` fields to see if the attempt was successful or failed.\n- Analyze the past activities of the actor involved in this action. An actor who usually performs such activities may indicate a legitimate reason.\n- Evaluate the actions that happened just before and after this event. It can help understand the full context of the activity.\n\n### False positive analysis:\n- It might be a false positive if the action was part of a planned activity or was performed by an authorized person.\n\n### Response and remediation:\n- If unauthorized revocation attempts are confirmed, initiate the incident response process.\n- Block the IP address or device used in the attempts, if they appear suspicious.\n- Reset the user's password and enforce MFA re-enrollment, if applicable.\n- Conduct a review of Okta policies and ensure they are in accordance with security best practices.\n- If the revoked token was used for critical integrations, coordinate with the relevant team to minimize the impact.",
        "output_index": "",
        "version": 410,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Data Source: Okta",
          "Tactic: Impact"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "If the behavior of revoking Okta API tokens is expected, consider adding exceptions to this rule to filter false positives."
        ],
        "references": [
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0040",
              "name": "Impact",
              "reference": "https://attack.mitre.org/tactics/TA0040/"
            },
            "technique": [
              {
                "id": "T1531",
                "name": "Account Access Removal",
                "reference": "https://attack.mitre.org/techniques/T1531/"
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "663e0641-23e8-4339-bfb9-a09c9b97d405",
        "rule_id": "676cff2b-450b-4cf1-8ed2-c0c58a4a2dd7",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:32.355Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:35.283Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset:okta.system and event.action:system.api_token.revoke",
        "language": "kuery"
      },
      {
        "name": "Okta ThreatInsight Threat Suspected Promotion",
        "description": "Okta ThreatInsight is a feature that provides valuable debug data regarding authentication and authorization processes, which is logged in the system. Within this data, there is a specific field called threat_suspected, which represents Okta's internal evaluation of the authentication or authorization workflow. When this field is set to True, it suggests the presence of potential credential access techniques, such as password-spraying, brute-forcing, replay attacks, and other similar threats.",
        "risk_score": 47,
        "severity": "medium",
        "rule_name_override": "okta.display_message",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\nThis is a promotion rule for Okta ThreatInsight suspected threat events, which are alertable events per the vendor.\nConsult vendor documentation on interpreting specific events.",
        "output_index": "",
        "version": 409,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Data Source: Okta"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [
          {
            "field": "okta.debug_context.debug_data.risk_level",
            "operator": "equals",
            "severity": "low",
            "value": "LOW"
          },
          {
            "field": "okta.debug_context.debug_data.risk_level",
            "operator": "equals",
            "severity": "medium",
            "value": "MEDIUM"
          },
          {
            "field": "okta.debug_context.debug_data.risk_level",
            "operator": "equals",
            "severity": "high",
            "value": "HIGH"
          }
        ],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://help.okta.com/en-us/Content/Topics/Security/threat-insight/configure-threatinsight-system-log.html",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [],
        "setup": "",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "okta.debug_context.debug_data.threat_suspected",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "6ff26e91-9890-4e7a-b450-73c55f2f52fd",
        "rule_id": "6885d2ae-e008-4762-b98a-e8e1cd3a81e9",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:32.393Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:35.300Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset:okta.system and (event.action:security.threat.detected or okta.debug_context.debug_data.threat_suspected: true)",
        "language": "kuery"
      },
      {
        "name": "Exporting Exchange Mailbox via PowerShell",
        "description": "Identifies the use of the Exchange PowerShell cmdlet, New-MailBoxExportRequest, to export the contents of a primary mailbox or archive to a .pst file. Adversaries may target user email to collect sensitive information.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Exporting Exchange Mailbox via PowerShell\n\nEmail mailboxes and their information can be valuable assets for attackers. Company mailboxes often contain sensitive information such as login credentials, intellectual property, financial data, and personal information, making them high-value targets for malicious actors.\n\nThe `New-MailBoxExportRequest` cmdlet is used to begin the process of exporting contents of a primary mailbox or archive to a .pst file. Note that this is done on a per-mailbox basis and this cmdlet is available only in on-premises Exchange.\n\nAttackers can abuse this functionality in preparation for exfiltrating contents, which is likely to contain sensitive and strategic data.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate the export operation:\n  - Identify the user account that performed the action and whether it should perform this kind of action.\n  - Contact the account owner and confirm whether they are aware of this activity.\n  - Check if this operation was approved and performed according to the organization's change management policy.\n  - Retrieve the operation status and use the `Get-MailboxExportRequest` cmdlet to review previous requests.\n  - By default, no group in Exchange has the privilege to import or export mailboxes. Investigate administrators that assigned the \"Mailbox Import Export\" privilege for abnormal activity.\n- Investigate if there is a significant quantity of export requests in the alert timeframe. This operation is done on a per-mailbox basis and can be part of a mass export.\n- If the operation was completed successfully:\n  - Check if the file is on the path specified in the command.\n  - Investigate if the file was compressed, archived, or retrieved by the attacker for exfiltration.\n\n### False positive analysis\n\n- This mechanism can be used legitimately. Analysts can dismiss the alert if the administrator is aware of the activity and it is done with proper approval.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- If the involved host is not the Exchange server, isolate the host to prevent further post-compromise behavior.\n- Use the `Remove-MailboxExportRequest` cmdlet to remove fully or partially completed export requests.\n- Prioritize cases that involve personally identifiable information (PII) or other classified data.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Review the privileges of users with the \"Mailbox Import Export\" privilege to ensure that the least privilege principle is being followed.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 417,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Collection",
          "Tactic: Execution",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: SentinelOne",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: System",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Legitimate exchange system administration activity."
        ],
        "references": [
          "https://www.volexity.com/blog/2020/12/14/dark-halo-leverages-solarwinds-compromise-to-breach-organizations/",
          "https://docs.microsoft.com/en-us/powershell/module/exchange/new-mailboxexportrequest?view=exchange-ps",
          "https://www.elastic.co/security-labs/siestagraph-new-implant-uncovered-in-asean-member-foreign-ministry"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0009",
              "name": "Collection",
              "reference": "https://attack.mitre.org/tactics/TA0009/"
            },
            "technique": [
              {
                "id": "T1005",
                "name": "Data from Local System",
                "reference": "https://attack.mitre.org/techniques/T1005/"
              },
              {
                "id": "T1114",
                "name": "Email Collection",
                "reference": "https://attack.mitre.org/techniques/T1114/",
                "subtechnique": [
                  {
                    "id": "T1114.002",
                    "name": "Remote Email Collection",
                    "reference": "https://attack.mitre.org/techniques/T1114/002/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "75ea8286-a7c2-4838-8d2b-36f794a421ba",
        "rule_id": "6aace640-e631-4870-ba8e-5fdda09325db",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:32.397Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:35.371Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.name: (\"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\") and\n  process.command_line : (\"*MailboxExportRequest*\", \"*-Mailbox*-ContentFilter*\")",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "winlogbeat-*",
          "logs-windows.*",
          "endgame-*",
          "logs-system.security*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-m365_defender.event-*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "First Occurrence of Okta User Session Started via Proxy",
        "description": "Identifies the first occurrence of an Okta user session started via a proxy.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating First Occurrence of Okta User Session Started via Proxy\n\nThis rule detects the first occurrence of an Okta user session started via a proxy. This rule is designed to help identify suspicious authentication behavior that may be indicative of an attacker attempting to gain access to an Okta account while remaining anonymous. This rule leverages the New Terms rule type feature where the `okta.actor.id` value is checked against the previous 7 days of data to determine if the value has been seen before for this activity.\n\n#### Possible investigation steps:\n- Identify the user involved in this action by examining the `okta.actor.id`, `okta.actor.type`, `okta.actor.alternate_id`, and `okta.actor.display_name` fields.\n- Determine the client used by the actor. Review the `okta.client.ip`, `okta.client.user_agent.raw_user_agent`, `okta.client.zone`, `okta.client.device`, and `okta.client.id` fields.\n- Examine the `okta.debug_context.debug_data.flattened` field for more information about the proxy used.\n- Review the `okta.request.ip_chain` field for more information about the geographic location of the proxy.\n- Review the past activities of the actor involved in this action by checking their previous actions.\n- Evaluate the actions that happened just before and after this event in the `okta.event_type` field to help understand the full context of the activity.\n\n### False positive analysis:\n- A user may have legitimately started a session via a proxy for security or privacy reasons.\n\n### Response and remediation:\n- Review the profile of the user involved in this action to determine if proxy usage may be expected.\n- If the user is legitimate and the authentication behavior is not suspicious, no action is required.\n- If the user is legitimate but the authentication behavior is suspicious, consider resetting the user's password and enabling multi-factor authentication (MFA).\n    - If MFA is already enabled, consider resetting MFA for the user.\n- If the user is not legitimate, consider deactivating the user's account.\n- Conduct a review of Okta policies and ensure they are in accordance with security best practices.\n\n## Setup",
        "output_index": "",
        "version": 205,
        "tags": [
          "Tactic: Initial Access",
          "Use Case: Identity and Access Audit",
          "Data Source: Okta"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://developer.okta.com/docs/reference/api/system-log/#issuer-object",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://sec.okta.com/articles/2023/08/cross-tenant-impersonation-prevention-and-detection",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1133",
                "name": "External Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1133/"
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "okta.actor.id",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "okta.event_type",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "okta.security_context.is_proxy",
            "type": "boolean",
            "ecs": false
          }
        ],
        "id": "ddc05c6c-203b-4f8e-8f53-cdb9cb4e8a7d",
        "rule_id": "6f1bb4b2-7dc8-11ee-92b2-f661ea17fbcd",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:35.323Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:35.442Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "event.dataset:okta.system and okta.event_type: (user.session.start or user.authentication.verify) and okta.security_context.is_proxy:true and not okta.actor.id: okta*",
        "new_terms_fields": [
          "okta.actor.id",
          "cloud.account.id"
        ],
        "history_window_start": "now-7d",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Potential Windows Error Manager Masquerading",
        "description": "Identifies suspicious instances of the Windows Error Reporting process (WerFault.exe or Wermgr.exe) with matching command-line and process executable values performing outgoing network connections. This may be indicative of a masquerading attempt to evade suspicious child process behavior detections.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Potential Windows Error Manager Masquerading\n\nBy examining the specific traits of Windows binaries -- such as process trees, command lines, network connections, registry modifications, and so on -- it's possible to establish a baseline of normal activity. Deviations from this baseline can indicate malicious activity, such as masquerading and deserve further investigation.\n\nThis rule identifies a potential malicious process masquerading as `wermgr.exe` or `WerFault.exe`, by looking for a process creation with no arguments followed by a network connection.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate any abnormal behavior by the subject process such as network connections, registry or file modifications, and any spawned child processes.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the process executable using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 209,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Legit Application Crash with rare Werfault commandline value"
        ],
        "references": [
          "https://twitter.com/SBousseaden/status/1235533224337641473",
          "https://www.hexacorn.com/blog/2019/09/20/werfault-command-line-switches-v0-1/",
          "https://app.any.run/tasks/26051d84-b68e-4afb-8a9a-76921a271b81/",
          "https://www.elastic.co/security-labs/elastic-security-uncovers-blister-malware-campaign"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1036",
                "name": "Masquerading",
                "reference": "https://attack.mitre.org/techniques/T1036/",
                "subtechnique": [
                  {
                    "id": "T1036.005",
                    "name": "Match Legitimate Name or Location",
                    "reference": "https://attack.mitre.org/techniques/T1036/005/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "network.direction",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "network.protocol",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args_count",
            "type": "long",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "994e6c03-7b27-401d-8d4d-2cbc059853b4",
        "rule_id": "6ea41894-66c3-4df7-ad6b-2c5074eb3df8",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:35.326Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:35.428Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by host.id, process.entity_id with maxspan = 5s\n  [process where host.os.type == \"windows\" and event.type:\"start\" and process.name : (\"wermgr.exe\", \"WerFault.exe\") and process.args_count == 1]\n  [network where host.os.type == \"windows\" and process.name : (\"wermgr.exe\", \"WerFault.exe\") and network.protocol != \"dns\" and\n    network.direction : (\"outgoing\", \"egress\") and destination.ip !=\"::1\" and destination.ip !=\"127.0.0.1\"\n  ]",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-endpoint.events.network-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious RDP ActiveX Client Loaded",
        "description": "Identifies suspicious Image Loading of the Remote Desktop Services ActiveX Client (mstscax), this may indicate the presence of RDP lateral movement capability.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 210,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Lateral Movement",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://posts.specterops.io/revisiting-remote-desktop-lateral-movement-8fb905cb46c3",
          "https://www.elastic.co/security-labs/hunting-for-lateral-movement-using-event-query-language"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1021",
                "name": "Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1021/",
                "subtechnique": [
                  {
                    "id": "T1021.001",
                    "name": "Remote Desktop Protocol",
                    "reference": "https://attack.mitre.org/techniques/T1021/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "dll.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "9a68e695-eda3-4ecd-a53b-21aa66cdab15",
        "rule_id": "71c5cb27-eca5-4151-bb47-64bc3f883270",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:35.335Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:36.386Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "any where host.os.type == \"windows\" and\n (event.category : (\"library\", \"driver\") or (event.category == \"process\" and event.action : \"Image loaded*\")) and\n (?dll.name : \"mstscax.dll\" or file.name : \"mstscax.dll\") and\n   /* depending on noise in your env add here extra paths  */\n  process.executable : (\n    \"C:\\\\Windows\\\\*\",\n    \"C:\\\\Users\\\\Public\\\\*\",\n    \"C:\\\\Users\\\\Default\\\\*\",\n    \"C:\\\\Intel\\\\*\",\n    \"C:\\\\PerfLogs\\\\*\",\n    \"C:\\\\ProgramData\\\\*\",\n    \"\\\\Device\\\\Mup\\\\*\",\n    \"\\\\\\\\*\"\n  ) and\n  /* add here FPs */\n  not process.executable : (\n    \"?:\\\\Windows\\\\System32\\\\mstsc.exe\",\n    \"?:\\\\Windows\\\\SysWOW64\\\\mstsc.exe\",\n    \"?:\\\\Windows\\\\System32\\\\vmconnect.exe\",\n    \"?:\\\\Windows\\\\System32\\\\WindowsSandboxClient.exe\",\n    \"?:\\\\Windows\\\\System32\\\\hvsirdpclient.exe\"\n  )",
        "language": "eql",
        "index": [
          "logs-endpoint.events.library-*",
          "winlogbeat-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "Attempt to Reset MFA Factors for an Okta User Account",
        "description": "Detects attempts to reset an Okta user's enrolled multi-factor authentication (MFA) factors. An adversary may attempt to reset the MFA factors for an Okta user's account in order to register new MFA factors and abuse the account to blend in with normal activity in the victim's environment.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 410,
        "tags": [
          "Tactic: Persistence",
          "Use Case: Identity and Access Audit",
          "Data Source: Okta"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Consider adding exceptions to this rule to filter false positives if the MFA factors for Okta user accounts are regularly reset in your organization."
        ],
        "references": [
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta",
          "https://www.elastic.co/security-labs/okta-and-lapsus-what-you-need-to-know"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1098",
                "name": "Account Manipulation",
                "reference": "https://attack.mitre.org/techniques/T1098/"
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "6dcddacb-4d78-4d3d-bb5c-8126160891d6",
        "rule_id": "729aa18d-06a6-41c7-b175-b65b739b1181",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:35.339Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:36.414Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset:okta.system and event.action:user.mfa.factor.reset_all",
        "language": "kuery"
      },
      {
        "name": "Remotely Started Services via RPC",
        "description": "Identifies remote execution of Windows services over remote procedure call (RPC). This could be indicative of lateral movement, but will be noisy if commonly done by administrators.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Remotely Started Services via RPC\n\nThe Service Control Manager Remote Protocol is a client/server protocol used for configuring and controlling service programs running on a remote computer. A remote service management session begins with the client initiating the connection request to the server. If the server grants the request, the connection is established. The client can then make multiple requests to modify, query the configuration, or start and stop services on the server by using the same session until the session is terminated.\n\nThis rule detects the remote creation or start of a service by correlating a `services.exe` network connection and the spawn of a child process.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Review login events (e.g., 4624) in the alert timeframe to identify the account used to perform this action. Use the `source.address` field to help identify the source system.\n- Review network events from the source system using the source port identified on the alert and try to identify the program used to initiate the action.\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate any abnormal behavior by the subject process such as network connections, registry or file modifications, and any spawned child processes.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Validate if the activity is not related to planned patches, updates, network administrator activity, or legitimate software installations.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the process executable using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n\n### False positive analysis\n\n- Remote management software like SCCM may trigger this rule. If noisy on your environment, consider adding exceptions.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 213,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Lateral Movement",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-scmr/705b624a-13de-43cc-b8a2-99573da3635f",
          "https://www.elastic.co/security-labs/elastic-protects-against-data-wiper-malware-targeting-ukraine-hermeticwiper"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1021",
                "name": "Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1021/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.port",
            "type": "long",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "network.direction",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "network.transport",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "source.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "source.port",
            "type": "long",
            "ecs": true
          }
        ],
        "id": "a2b93ec0-7200-4c21-974a-92857ff4776a",
        "rule_id": "aa9a274d-6b53-424d-ac5e-cb8ca4251650",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:35.342Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:42.805Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence with maxspan=1s\n   [network where host.os.type == \"windows\" and process.name : \"services.exe\" and\n      network.direction : (\"incoming\", \"ingress\") and network.transport == \"tcp\" and\n      source.port >= 49152 and destination.port >= 49152 and source.ip != \"127.0.0.1\" and source.ip != \"::1\"\n   ] by host.id, process.entity_id\n   [process where host.os.type == \"windows\" and \n       event.type == \"start\" and process.parent.name : \"services.exe\" and\n       not (process.executable : \"?:\\\\Windows\\\\System32\\\\msiexec.exe\" and process.args : \"/V\") and\n       not process.executable : (\n                \"?:\\\\Pella Corporation\\\\OSCToGPAutoService\\\\OSCToGPAutoSvc.exe\",\n                \"?:\\\\Pella Corporation\\\\Pella Order Management\\\\GPAutoSvc.exe\",\n                \"?:\\\\Pella Corporation\\\\Pella Order Management\\\\GPAutoSvc.exe\",\n                \"?:\\\\Program Files (x86)\\\\*.exe\",\n                \"?:\\\\Program Files\\\\*.exe\",\n                \"?:\\\\Windows\\\\ADCR_Agent\\\\adcrsvc.exe\",\n                \"?:\\\\Windows\\\\AdminArsenal\\\\PDQ*.exe\",\n                \"?:\\\\Windows\\\\CAInvokerService.exe\",\n                \"?:\\\\Windows\\\\ccmsetup\\\\ccmsetup.exe\",\n                \"?:\\\\Windows\\\\eset-remote-install-service.exe\",\n                \"?:\\\\Windows\\\\ProPatches\\\\Scheduler\\\\STSchedEx.exe\",\n                \"?:\\\\Windows\\\\PSEXESVC.EXE\",\n                \"?:\\\\Windows\\\\RemoteAuditService.exe\",\n                \"?:\\\\Windows\\\\servicing\\\\TrustedInstaller.exe\",\n                \"?:\\\\Windows\\\\System32\\\\certsrv.exe\",\n                \"?:\\\\Windows\\\\System32\\\\sppsvc.exe\",\n                \"?:\\\\Windows\\\\System32\\\\srmhost.exe\",\n                \"?:\\\\Windows\\\\System32\\\\svchost.exe\",\n                \"?:\\\\Windows\\\\System32\\\\taskhostex.exe\",\n                \"?:\\\\Windows\\\\System32\\\\upfc.exe\",\n                \"?:\\\\Windows\\\\System32\\\\vds.exe\",\n                \"?:\\\\Windows\\\\System32\\\\VSSVC.exe\",\n                \"?:\\\\Windows\\\\System32\\\\wbem\\\\WmiApSrv.exe\",\n                \"?:\\\\Windows\\\\SysWOW64\\\\NwxExeSvc\\\\NwxExeSvc.exe\",\n                \"?:\\\\Windows\\\\Veeam\\\\Backup\\\\VeeamDeploymentSvc.exe\",\n                \"?:\\\\Windows\\\\VeeamLogShipper\\\\VeeamLogShipper.exe\",\n                \"?:\\\\Windows\\\\VeeamVssSupport\\\\VeeamGuestHelper.exe\"\n       )] by host.id, process.parent.entity_id",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "logs-endpoint.events.network-*",
          "winlogbeat-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "Git Hook Created or Modified",
        "description": "This rule detects the creation or modification of a Git hook file on a Linux system. Git hooks are scripts that Git executes before or after events such as commit, push, and receive. They are used to automate tasks, enforce policies, and customize Git's behavior. Attackers can abuse Git hooks to maintain persistence on a system by executing malicious code whenever a specific Git event occurs.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 3,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Tactic: Execution",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://git-scm.com/docs/githooks/2.26.0",
          "https://www.elastic.co/security-labs/sequel-on-persistence-mechanisms"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1543",
                "name": "Create or Modify System Process",
                "reference": "https://attack.mitre.org/techniques/T1543/"
              },
              {
                "id": "T1574",
                "name": "Hijack Execution Flow",
                "reference": "https://attack.mitre.org/techniques/T1574/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.004",
                    "name": "Unix Shell",
                    "reference": "https://attack.mitre.org/techniques/T1059/004/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            }
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "21bb2f1c-06ce-4f0b-9055-ed4729b7e7cc",
        "rule_id": "ac531fcc-1d3b-476d-bbb5-1357728c9a37",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:35.345Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:42.840Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"linux\" and event.type == \"creation\" and file.path : \"*.git/hooks/*\" and\nfile.extension == null and process.executable != null and not (\n  process.executable in (\n    \"/bin/dpkg\", \"/usr/bin/dpkg\", \"/bin/dockerd\", \"/usr/bin/dockerd\", \"/usr/sbin/dockerd\", \"/bin/microdnf\",\n    \"/usr/bin/microdnf\", \"/bin/rpm\", \"/usr/bin/rpm\", \"/bin/snapd\", \"/usr/bin/snapd\", \"/bin/yum\", \"/usr/bin/yum\",\n    \"/bin/dnf\", \"/usr/bin/dnf\", \"/bin/podman\", \"/usr/bin/podman\", \"/bin/dnf-automatic\", \"/usr/bin/dnf-automatic\",\n    \"/bin/pacman\", \"/usr/bin/pacman\", \"/usr/bin/dpkg-divert\", \"/bin/dpkg-divert\", \"/sbin/apk\", \"/usr/sbin/apk\",\n    \"/usr/local/sbin/apk\", \"/usr/bin/apt\", \"/usr/sbin/pacman\", \"/bin/podman\", \"/usr/bin/podman\", \"/usr/bin/puppet\",\n    \"/bin/puppet\", \"/opt/puppetlabs/puppet/bin/puppet\", \"/usr/bin/chef-client\", \"/bin/chef-client\",\n    \"/bin/autossl_check\", \"/usr/bin/autossl_check\", \"/proc/self/exe\", \"/usr/bin/pamac-daemon\", \"/bin/pamac-daemon\",\n    \"/usr/local/bin/dockerd\", \"/sbin/dockerd\"\n  ) or\n  process.executable : (\"/nix/store/*\", \"/var/lib/dpkg/*\", \"/snap/*\", \"/dev/fd/*\") or\n  process.name in (\"git\", \"dirname\", \"tar\", \"gitea\", \"git-lfs\") or\n  (process.name == \"sed\" and file.name : \"sed*\") or\n  (process.name == \"perl\" and file.name : \"e2scrub_all.tmp*\") \n)",
        "language": "eql",
        "index": [
          "logs-endpoint.events.file*"
        ],
        "filters": []
      },
      {
        "name": "Local Scheduled Task Creation",
        "description": "Indicates the creation of a scheduled task. Adversaries can use these to establish persistence, move laterally, and/or escalate privileges.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 208,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Legitimate scheduled tasks may be created during installation of new software."
        ],
        "references": [
          "https://www.elastic.co/security-labs/hunting-for-persistence-using-elastic-security-part-1",
          "https://www.elastic.co/security-labs/hunting-for-persistence-using-elastic-security-part-2",
          "https://www.elastic.co/security-labs/invisible-miners-unveiling-ghostengine",
          "https://www.elastic.co/security-labs/elastic-protects-against-data-wiper-malware-targeting-ukraine-hermeticwiper"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1053",
                "name": "Scheduled Task/Job",
                "reference": "https://attack.mitre.org/techniques/T1053/",
                "subtechnique": [
                  {
                    "id": "T1053.005",
                    "name": "Scheduled Task",
                    "reference": "https://attack.mitre.org/techniques/T1053/005/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.Ext.token.integrity_level_name",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.code_signature.trusted",
            "type": "boolean",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.event_data.IntegrityLevel",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "25ddf060-b462-4b57-8e02-0d109a58d5a1",
        "rule_id": "afcce5ad-65de-4ed2-8516-5e093d3ac99a",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:35.348Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:42.920Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence with maxspan=1m\n  [process where host.os.type == \"windows\" and event.type != \"end\" and\n    ((process.name : (\"cmd.exe\", \"wscript.exe\", \"rundll32.exe\", \"regsvr32.exe\", \"wmic.exe\", \"mshta.exe\",\n                      \"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\", \"WmiPrvSe.exe\", \"wsmprovhost.exe\", \"winrshost.exe\") or\n    process.pe.original_file_name : (\"cmd.exe\", \"wscript.exe\", \"rundll32.exe\", \"regsvr32.exe\", \"wmic.exe\", \"mshta.exe\",\n                                     \"powershell.exe\", \"pwsh.dll\", \"powershell_ise.exe\", \"WmiPrvSe.exe\", \"wsmprovhost.exe\",\n                                     \"winrshost.exe\")) or\n    ?process.code_signature.trusted == false)] by process.entity_id\n  [process where host.os.type == \"windows\" and event.type == \"start\" and\n    (process.name : \"schtasks.exe\" or process.pe.original_file_name == \"schtasks.exe\") and\n    process.args : (\"/create\", \"-create\") and process.args : (\"/RU\", \"/SC\", \"/TN\", \"/TR\", \"/F\", \"/XML\") and\n    /* exclude SYSTEM Integrity Level - look for task creations by non-SYSTEM user */\n    not (?process.Ext.token.integrity_level_name : \"System\" or ?winlog.event_data.IntegrityLevel : \"System\")\n  ] by process.parent.entity_id",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "Attempt to Delete an Okta Policy",
        "description": "Detects attempts to delete an Okta policy. An adversary may attempt to delete an Okta policy in order to weaken an organization's security controls. For example, an adversary may attempt to delete an Okta multi-factor authentication (MFA) policy in order to weaken the authentication requirements for user accounts.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Attempt to Delete an Okta Policy\n\nOkta policies are critical to managing user access and enforcing security controls within an organization. The deletion of an Okta policy could drastically weaken an organization's security posture by allowing unrestricted access or facilitating other malicious activities.\n\nThis rule detects attempts to delete an Okta policy, which could be indicative of an adversary's attempt to weaken an organization's security controls. Adversaries may do this to bypass security barriers and enable further malicious activities.\n\n#### Possible investigation steps:\n\n- Identify the actor related to the alert by reviewing `okta.actor.id`, `okta.actor.type`, `okta.actor.alternate_id`, or `okta.actor.display_name` fields in the alert.\n- Review the `okta.client.user_agent.raw_user_agent` field to understand the device and software used by the actor.\n- Examine the `okta.outcome.reason` field for additional context around the deletion attempt.\n- Check the `okta.outcome.result` field to confirm the policy deletion attempt.\n- Check if there are multiple policy deletion attempts from the same actor or IP address (`okta.client.ip`).\n- Check for successful logins immediately following the policy deletion attempt.\n- Verify whether the actor's activity aligns with typical behavior or if any unusual activity took place around the time of the deletion attempt.\n\n### False positive analysis:\n\n- Check if there were issues with the Okta system at the time of the deletion attempt. This could indicate a system error rather than a genuine threat activity.\n- Check the geographical location (`okta.request.ip_chain.geographical_context`) and time of the deletion attempt. If these match the actor's normal behavior, it might be a false positive.\n- Verify the actor's administrative rights to ensure they are correctly configured.\n\n### Response and remediation:\n\n- If unauthorized policy deletion is confirmed, initiate the incident response process.\n- Immediately lock the affected actor account and require a password change.\n- Consider resetting MFA tokens for the actor and require re-enrollment.\n- Check if the compromised account was used to access or alter any sensitive data or systems.\n- If a specific deletion technique was used, ensure your systems are patched or configured to prevent such techniques.\n- Assess the criticality of affected services and servers.\n- Work with your IT team to minimize the impact on users and maintain business continuity.\n- If multiple accounts are affected, consider a broader reset or audit of MFA tokens.\n- Implement security best practices [outlined](https://www.okta.com/blog/2019/10/9-admin-best-practices-to-keep-your-org-secure/) by Okta.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).",
        "output_index": "",
        "version": 410,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Data Source: Okta",
          "Tactic: Defense Evasion"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Consider adding exceptions to this rule to filter false positives if Okta policies are regularly deleted in your organization."
        ],
        "references": [
          "https://help.okta.com/en/prod/Content/Topics/Security/Security_Policies.htm",
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.007",
                    "name": "Disable or Modify Cloud Firewall",
                    "reference": "https://attack.mitre.org/techniques/T1562/007/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "7b93e06f-ecc3-4b0f-9085-39b64748509f",
        "rule_id": "b4bb1440-0fcb-4ed1-87e5-b06d58efc5e9",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:35.351Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:43.586Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset:okta.system and event.action:policy.lifecycle.delete",
        "language": "kuery"
      },
      {
        "name": "Attempt to Deactivate an Okta Policy",
        "description": "Detects attempts to deactivate an Okta policy. An adversary may attempt to deactivate an Okta policy in order to weaken an organization's security controls. For example, an adversary may attempt to deactivate an Okta multi-factor authentication (MFA) policy in order to weaken the authentication requirements for user accounts.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Attempt to Deactivate an Okta Policy\n\nOkta policies define rules to manage user access to resources. Policies such as multi-factor authentication (MFA) are critical for enforcing strong security measures. Deactivation of an Okta policy could potentially weaken the security posture, allowing for unauthorized access or facilitating other malicious activities.\n\nThis rule is designed to detect attempts to deactivate an Okta policy, which could be indicative of an adversary's attempt to weaken an organization's security controls. For example, disabling an MFA policy could lower the security of user authentication processes.\n\n#### Possible investigation steps:\n\n- Identify the actor related to the alert by reviewing `okta.actor.id`, `okta.actor.type`, `okta.actor.alternate_id`, or `okta.actor.display_name` fields in the alert.\n- Review the `okta.client.user_agent.raw_user_agent` field to understand the device and software used by the actor.\n- Examine the `okta.outcome.reason` field for additional context around the deactivation attempt.\n- Check the `okta.outcome.result` field to confirm the policy deactivation attempt.\n- Check if there are multiple policy deactivation attempts from the same actor or IP address (`okta.client.ip`).\n- Check for successful logins immediately following the policy deactivation attempt.\n- Verify whether the actor's activity aligns with typical behavior or if any unusual activity took place around the time of the deactivation attempt.\n\n### False positive analysis:\n\n- Check if there were issues with the Okta system at the time of the deactivation attempt. This could indicate a system error rather than a genuine threat activity.\n- Check the geographical location (`okta.request.ip_chain.geographical_context`) and time of the deactivation attempt. If these match the actor's normal behavior, it might be a false positive.\n- Verify the actor's administrative rights to ensure they are correctly configured.\n\n### Response and remediation:\n\n- If unauthorized policy deactivation is confirmed, initiate the incident response process.\n- Immediately lock the affected actor account and require a password change.\n- Consider resetting MFA tokens for the actor and require re-enrollment.\n- Check if the compromised account was used to access or alter any sensitive data or systems.\n- If a specific deactivation technique was used, ensure your systems are patched or configured to prevent such techniques.\n- Assess the criticality of affected services and servers.\n- Work with your IT team to minimize the impact on users and maintain business continuity.\n- If multiple accounts are affected, consider a broader reset or audit of MFA tokens.\n- Implement security best practices [outlined](https://www.okta.com/blog/2019/10/9-admin-best-practices-to-keep-your-org-secure/) by Okta.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).",
        "output_index": "",
        "version": 410,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Data Source: Okta",
          "Tactic: Defense Evasion"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "If the behavior of deactivating Okta policies is expected, consider adding exceptions to this rule to filter false positives."
        ],
        "references": [
          "https://help.okta.com/en/prod/Content/Topics/Security/Security_Policies.htm",
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.007",
                    "name": "Disable or Modify Cloud Firewall",
                    "reference": "https://attack.mitre.org/techniques/T1562/007/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "64dcbda6-e186-46c0-a74b-6ec47257859b",
        "rule_id": "b719a170-3bdb-4141-b0e3-13e3cf627bfe",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:35.354Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:43.626Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset:okta.system and event.action:policy.lifecycle.deactivate",
        "language": "kuery"
      },
      {
        "name": "Administrator Privileges Assigned to an Okta Group",
        "description": "Detects when an administrator role is assigned to an Okta group. An adversary may attempt to assign administrator privileges to an Okta group in order to assign additional permissions to compromised user accounts and maintain access to their target organization.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 409,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Data Source: Okta",
          "Tactic: Persistence"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Administrator roles may be assigned to Okta users by a Super Admin user. Verify that the behavior was expected. Exceptions can be added to this rule to filter expected behavior."
        ],
        "references": [
          "https://help.okta.com/en/prod/Content/Topics/Security/administrators-admin-comparison.htm",
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1098",
                "name": "Account Manipulation",
                "reference": "https://attack.mitre.org/techniques/T1098/"
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "85f0bb35-c651-4ef8-9e9e-16f0d8872a3c",
        "rule_id": "b8075894-0b62-46e5-977c-31275da34419",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:35.356Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:43.636Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset:okta.system and event.action:group.privilege.grant",
        "language": "kuery"
      },
      {
        "name": "Attempts to Brute Force an Okta User Account",
        "description": "Identifies when an Okta user account is locked out 3 times within a 3 hour window. An adversary may attempt a brute force or password spraying attack to obtain unauthorized access to user accounts. The default Okta authentication policy ensures that a user account is locked out after 10 failed authentication attempts.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Attempts to Brute Force an Okta User Account\n\nBrute force attacks aim to guess user credentials through exhaustive trial-and-error attempts. In this context, Okta accounts are targeted.\n\nThis rule fires when an Okta user account has been locked out 3 times within a 3-hour window. This could indicate an attempted brute force or password spraying attack to gain unauthorized access to the user account. Okta's default authentication policy locks a user account after 10 failed authentication attempts.\n\n#### Possible investigation steps:\n\n- Identify the actor related to the alert by reviewing `okta.actor.alternate_id` field in the alert. This should give the username of the account being targeted.\n- Review the `okta.event_type` field to understand the nature of the events that led to the account lockout.\n- Check the `okta.severity` and `okta.display_message` fields for more context around the lockout events.\n- Look for correlation of events from the same IP address. Multiple lockouts from the same IP address might indicate a single source for the attack.\n- If the IP is not familiar, investigate it. The IP could be a proxy, VPN, Tor node, cloud datacenter, or a legitimate IP turned malicious.\n- Determine if the lockout events occurred during the user's regular activity hours. Unusual timing may indicate malicious activity.\n- Examine the authentication methods used during the lockout events by checking the `okta.authentication_context.credential_type` field.\n\n### False positive analysis:\n\n- Determine whether the account owner or an internal user made repeated mistakes in entering their credentials, leading to the account lockout.\n- Ensure there are no known network or application issues that might cause these events.\n\n### Response and remediation:\n\n- Alert the user and your IT department immediately.\n- If unauthorized access is confirmed, initiate your incident response process.\n- Investigate the source of the attack. If a specific machine or network is compromised, additional steps may need to be taken to address the issue.\n- Require the affected user to change their password.\n- If the attack is ongoing, consider blocking the IP address initiating the brute force attack.\n- Implement account lockout policies to limit the impact of brute force attacks.\n- Encourage users to use complex, unique passwords and consider implementing multi-factor authentication.\n- Check if the compromised account was used to access or alter any sensitive data or systems.",
        "output_index": "",
        "version": 412,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Tactic: Credential Access",
          "Data Source: Okta"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-10800s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic",
          "@BenB196",
          "Austin Songer"
        ],
        "false_positives": [],
        "references": [
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1110",
                "name": "Brute Force",
                "reference": "https://attack.mitre.org/techniques/T1110/"
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "c5a32c25-f64c-44e3-ac5a-9aee1f640bcb",
        "rule_id": "e08ccd49-0380-4b2b-8d71-8000377d6e49",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:35.359Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:47.855Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "threshold",
        "query": "event.dataset:okta.system and event.action:user.account.lock",
        "threshold": {
          "field": [
            "okta.actor.alternate_id"
          ],
          "value": 3
        },
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Persistence via KDE AutoStart Script or Desktop File Modification",
        "description": "Identifies the creation or modification of a K Desktop Environment (KDE) AutoStart script or desktop file that will execute upon each user logon. Adversaries may abuse this method for persistence.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Persistence via KDE AutoStart Script or Desktop File Modification\n\nK Desktop Environment (KDE) is a popular graphical desktop environment for Linux systems. It supports AutoStart scripts and desktop files that execute automatically upon user logon.\n\nAdversaries may exploit this feature to maintain persistence on a compromised system by creating or modifying these files.\n\nThe detection rule 'Persistence via KDE AutoStart Script or Desktop File Modification' is designed to identify such activities by monitoring file events on Linux systems. It specifically targets the creation or modification of files with extensions \".sh\" or \".desktop\" in various AutoStart directories. By detecting these events, the rule helps security analysts identify potential abuse of KDE AutoStart functionality by malicious actors.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n> This investigation guide uses [placeholder fields](https://www.elastic.co/guide/en/security/current/osquery-placeholder-fields.html) to dynamically pass alert data into Osquery queries. Placeholder fields were introduced in Elastic Stack version 8.7.0. If you're using Elastic Stack version 8.6.0 or earlier, you'll need to manually adjust this investigation guide's queries to ensure they properly run.\n\n### Possible investigation steps\n\n- Investigate the file that was created or modified.\n  - !{osquery{\"label\":\"Osquery - Retrieve File Listing Information\",\"query\":\"SELECT * FROM file WHERE ( path LIKE '/home/%/.config/autostart/%.sh' OR path LIKE '/home/%/.config/autostart/%.desktop'\\nOR path LIKE '/root/.config/autostart/%.sh' OR path LIKE '/root/.config/autostart/%.desktop' OR path LIKE\\n'/home/%/.kde/Autostart/%.sh' OR path LIKE '/home/%/.kde/Autostart/%.desktop' OR path LIKE '/root/.kde/Autostart/%.sh'\\nOR path LIKE '/root/.kde/Autostart/%.desktop' OR path LIKE '/home/%/.kde4/Autostart/%.sh' OR path LIKE\\n'/home/%/.kde4/Autostart/%.desktop' OR path LIKE '/root/.kde4/Autostart/%.sh' OR path LIKE\\n'/root/.kde4/Autostart/%.desktop' OR path LIKE '/home/%/.kde/share/autostart/%.sh' OR path LIKE\\n'/home/%/.kde/share/autostart/%.desktop' OR path LIKE '/root/.kde/share/autostart/%.sh' OR path LIKE\\n'/root/.kde/share/autostart/%.desktop' OR path LIKE '/home/%/.kde4/share/autostart/%.sh' OR path LIKE\\n'/home/%/.kde4/share/autostart/%.desktop' OR path LIKE '/root/.kde4/share/autostart/%.sh' OR path LIKE\\n'/root/.kde4/share/autostart/%.desktop' OR path LIKE '/home/%/.local/share/autostart/%.sh' OR path LIKE\\n'/home/%/.local/share/autostart/%.desktop' OR path LIKE '/root/.local/share/autostart/%.sh' OR path LIKE\\n'/root/.local/share/autostart/%.desktop' OR path LIKE '/home/%/.config/autostart-scripts/%.sh' OR path LIKE\\n'/home/%/.config/autostart-scripts/%.desktop' OR path LIKE '/root/.config/autostart-scripts/%.sh' OR path LIKE\\n'/root/.config/autostart-scripts/%.desktop' OR path LIKE '/etc/xdg/autostart/%.sh' OR path LIKE\\n'/etc/xdg/autostart/%.desktop' OR path LIKE '/usr/share/autostart/%.sh' OR path LIKE '/usr/share/autostart/%.desktop' )\\n\"}}\n  - !{osquery{\"label\":\"Osquery - Retrieve Additional File Listing Information\",\"query\":\"SELECT f.path, u.username AS file_owner, g.groupname AS group_owner, datetime(f.atime, 'unixepoch') AS\\nfile_last_access_time, datetime(f.mtime, 'unixepoch') AS file_last_modified_time, datetime(f.ctime, 'unixepoch') AS\\nfile_last_status_change_time, datetime(f.btime, 'unixepoch') AS file_created_time, f.size AS size_bytes FROM file f LEFT\\nJOIN users u ON f.uid = u.uid LEFT JOIN groups g ON f.gid = g.gid WHERE ( path LIKE '/home/%/.config/autostart/%.sh' OR\\npath LIKE '/home/%/.config/autostart/%.desktop' OR path LIKE '/root/.config/autostart/%.sh' OR path LIKE\\n'/root/.config/autostart/%.desktop' OR path LIKE '/home/%/.kde/Autostart/%.sh' OR path LIKE\\n'/home/%/.kde/Autostart/%.desktop' OR path LIKE '/root/.kde/Autostart/%.sh' OR path LIKE\\n'/root/.kde/Autostart/%.desktop' OR path LIKE '/home/%/.kde4/Autostart/%.sh' OR path LIKE\\n'/home/%/.kde4/Autostart/%.desktop' OR path LIKE '/root/.kde4/Autostart/%.sh' OR path LIKE\\n'/root/.kde4/Autostart/%.desktop' OR path LIKE '/home/%/.kde/share/autostart/%.sh' OR path LIKE\\n'/home/%/.kde/share/autostart/%.desktop' OR path LIKE '/root/.kde/share/autostart/%.sh' OR path LIKE\\n'/root/.kde/share/autostart/%.desktop' OR path LIKE '/home/%/.kde4/share/autostart/%.sh' OR path LIKE\\n'/home/%/.kde4/share/autostart/%.desktop' OR path LIKE '/root/.kde4/share/autostart/%.sh' OR path LIKE\\n'/root/.kde4/share/autostart/%.desktop' OR path LIKE '/home/%/.local/share/autostart/%.sh' OR path LIKE\\n'/home/%/.local/share/autostart/%.desktop' OR path LIKE '/root/.local/share/autostart/%.sh' OR path LIKE\\n'/root/.local/share/autostart/%.desktop' OR path LIKE '/home/%/.config/autostart-scripts/%.sh' OR path LIKE\\n'/home/%/.config/autostart-scripts/%.desktop' OR path LIKE '/root/.config/autostart-scripts/%.sh' OR path LIKE\\n'/root/.config/autostart-scripts/%.desktop' OR path LIKE '/etc/xdg/autostart/%.sh' OR path LIKE\\n'/etc/xdg/autostart/%.desktop' OR path LIKE '/usr/share/autostart/%.sh' OR path LIKE '/usr/share/autostart/%.desktop' )\\n\"}}\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence and whether they are located in expected locations.\n  - !{osquery{\"label\":\"Osquery - Retrieve Running Processes by User\",\"query\":\"SELECT pid, username, name FROM processes p JOIN users u ON u.uid = p.uid ORDER BY username\"}}\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Validate the activity is not related to planned patches, updates, network administrator activity, or legitimate software installations.\n- Investigate whether the altered scripts call other malicious scripts elsewhere on the file system. \n  - If scripts or executables were dropped, retrieve the files and determine if they are malicious:\n    - Use a private sandboxed malware analysis system to perform analysis.\n      - Observe and collect information about the following activities:\n        - Attempts to contact external domains and addresses.\n          - Check if the domain is newly registered or unexpected.\n          - Check the reputation of the domain or IP address.\n        - File access, modification, and creation activities.\n        - Cron jobs, services and other persistence mechanisms.\n            - !{osquery{\"label\":\"Osquery - Retrieve Crontab Information\",\"query\":\"SELECT * FROM crontab\"}}\n- Investigate abnormal behaviors by the subject process/user such as network connections, file modifications, and any other spawned child processes.\n  - Investigate listening ports and open sockets to look for potential command and control traffic or data exfiltration.\n    - !{osquery{\"label\":\"Osquery - Retrieve Listening Ports\",\"query\":\"SELECT pid, address, port, socket, protocol, path FROM listening_ports\"}}\n    - !{osquery{\"label\":\"Osquery - Retrieve Open Sockets\",\"query\":\"SELECT pid, family, remote_address, remote_port, socket, state FROM process_open_sockets\"}}\n  - Identify the user account that performed the action, analyze it, and check whether it should perform this kind of action.\n    - !{osquery{\"label\":\"Osquery - Retrieve Information for a Specific User\",\"query\":\"SELECT * FROM users WHERE username = {{user.name}}\"}}\n- Investigate whether the user is currently logged in and active.\n    - !{osquery{\"label\":\"Osquery - Investigate the Account Authentication Status\",\"query\":\"SELECT * FROM logged_in_users WHERE user = {{user.name}}\"}}\n\n### False positive analysis\n\n- If this activity is related to new benign software installation activity, consider adding exceptions — preferably with a combination of user and command line conditions.\n- If this activity is related to a system administrator who uses cron jobs for administrative purposes, consider adding exceptions for this specific administrator user account. \n- Try to understand the context of the execution by thinking about the user, machine, or business purpose. A small number of endpoints, such as servers with unique software, might appear unusual but satisfy a specific business need.\n\n### Response and Remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Leverage the incident response data and logging to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 114,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://userbase.kde.org/System_Settings/Autostart",
          "https://www.amnesty.org/en/latest/research/2020/09/german-made-finspy-spyware-found-in-egypt-and-mac-and-linux-versions-revealed/",
          "https://www.intezer.com/blog/research/operation-electrorat-attacker-creates-fake-companies-to-drain-your-crypto-wallets/",
          "https://www.elastic.co/security-labs/primer-on-persistence-mechanisms"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1547",
                "name": "Boot or Logon Autostart Execution",
                "reference": "https://attack.mitre.org/techniques/T1547/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from one of the following integrations:\n- Elastic Defend\n- Auditbeat\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n### Auditbeat Setup\nAuditbeat is a lightweight shipper that you can install on your servers to audit the activities of users and processes on your systems. For example, you can use Auditbeat to collect and centralize audit events from the Linux Audit Framework. You can also use Auditbeat to detect changes to critical files, like binaries and configuration files, and identify potential security policy violations.\n\n#### The following steps should be executed in order to add the Auditbeat on a Linux System:\n- Elastic provides repositories available for APT and YUM-based distributions. Note that we provide binary packages, but no source packages.\n- To install the APT and YUM repositories follow the setup instructions in this [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/setup-repositories.html).\n- To run Auditbeat on Docker follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/running-on-docker.html).\n- To run Auditbeat on Kubernetes follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/running-on-kubernetes.html).\n- For complete “Setup and Run Auditbeat” information refer to the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/setting-up-and-running.html).\n\n#### Custom Ingest Pipeline\nFor versions <8.2, you need to add a custom ingest pipeline to populate `event.ingested` with @timestamp for non-elastic-agent indexes, like auditbeats/filebeat/winlogbeat etc. For more details to add a custom ingest pipeline refer to the [guide](https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "ee3dfed6-202c-404a-938a-dc09a735e963",
        "rule_id": "e3e904b3-0a8e-4e68-86a8-977a163e21d3",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:35.367Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:49.324Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"linux\" and event.type != \"deletion\" and\n  file.extension in (\"sh\", \"desktop\") and\n  file.path :\n    (\n      \"/home/*/.config/autostart/*\", \"/root/.config/autostart/*\",\n      \"/home/*/.kde/Autostart/*\", \"/root/.kde/Autostart/*\",\n      \"/home/*/.kde4/Autostart/*\", \"/root/.kde4/Autostart/*\",\n      \"/home/*/.kde/share/autostart/*\", \"/root/.kde/share/autostart/*\",\n      \"/home/*/.kde4/share/autostart/*\", \"/root/.kde4/share/autostart/*\",\n      \"/home/*/.local/share/autostart/*\", \"/root/.local/share/autostart/*\",\n      \"/home/*/.config/autostart-scripts/*\", \"/root/.config/autostart-scripts/*\",\n      \"/etc/xdg/autostart/*\", \"/usr/share/autostart/*\"\n    ) and\n    not process.name in (\n      \"yum\", \"dpkg\", \"install\", \"dnf\", \"teams\", \"yum-cron\", \"dnf-automatic\", \"docker\", \"dockerd\", \"rpm\", \"pacman\",\n      \"podman\", \"nautilus\", \"remmina\", \"cinnamon-settings.py\", \"executor\", \"xfce4-clipman\", \"jetbrains-toolbox\",\n      \"ansible-admin\"\n    )",
        "language": "eql",
        "index": [
          "auditbeat-*",
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "Attempt to Modify an Okta Network Zone",
        "description": "Detects attempts to modify an Okta network zone. Okta network zones can be configured to limit or restrict access to a network based on IP addresses or geolocations. An adversary may attempt to modify, delete, or deactivate an Okta network zone in order to remove or weaken an organization's security controls.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Attempt to Modify an Okta Network Zone\n\nThe modification of an Okta network zone is a critical event as it could potentially allow an adversary to gain unrestricted access to your network. This rule detects attempts to modify, delete, or deactivate an Okta network zone, which may suggest an attempt to remove or weaken an organization's security controls.\n\n#### Possible investigation steps:\n\n- Identify the actor related to the alert by reviewing `okta.actor.id`, `okta.actor.type`, `okta.actor.alternate_id`, or `okta.actor.display_name` fields in the alert.\n- Review the `okta.client.user_agent.raw_user_agent` field to understand the device and software used by the actor.\n- Examine the `okta.outcome.reason` field for additional context around the modification attempt.\n- Check the `okta.outcome.result` field to confirm the network zone modification attempt.\n- Check if there are multiple network zone modification attempts from the same actor or IP address (`okta.client.ip`).\n- Check for successful logins immediately following the modification attempt.\n- Verify whether the actor's activity aligns with typical behavior or if any unusual activity took place around the time of the modification attempt.\n\n### False positive analysis:\n\n- Check if there were issues with the Okta system at the time of the modification attempt. This could indicate a system error rather than a genuine threat activity.\n- Check the geographical location (`okta.request.ip_chain.geographical_context`) and time of the modification attempt. If these match the actor's normal behavior, it might be a false positive.\n- Verify the actor's administrative rights to ensure they are correctly configured.\n\n### Response and remediation:\n\n- If unauthorized modification is confirmed, initiate the incident response process.\n- Immediately lock the affected actor account and require a password change.\n- Consider resetting MFA tokens for the actor and require re-enrollment.\n- Check if the compromised account was used to access or alter any sensitive data or systems.\n- If a specific modification technique was used, ensure your systems are patched or configured to prevent such techniques.\n- Assess the criticality of affected services and servers.\n- Work with your IT team to minimize the impact on users and maintain business continuity.\n- If multiple accounts are affected, consider a broader reset or audit of MFA tokens.\n- Implement security best practices [outlined](https://www.okta.com/blog/2019/10/9-admin-best-practices-to-keep-your-org-secure/) by Okta.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).",
        "output_index": "",
        "version": 410,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Data Source: Okta",
          "Use Case: Network Security Monitoring",
          "Tactic: Defense Evasion"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Consider adding exceptions to this rule to filter false positives if Oyour organization's Okta network zones are regularly modified."
        ],
        "references": [
          "https://help.okta.com/en/prod/Content/Topics/Security/network/network-zones.htm",
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.007",
                    "name": "Disable or Modify Cloud Firewall",
                    "reference": "https://attack.mitre.org/techniques/T1562/007/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "3d5bddf3-1d12-459b-9443-c4b72e78ea99",
        "rule_id": "e48236ca-b67a-4b4e-840c-fdc7782bc0c3",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:35.370Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:49.328Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset:okta.system and event.action:(zone.update or network_zone.rule.disabled or zone.remove_blacklist)",
        "language": "kuery"
      },
      {
        "name": "Possible Okta DoS Attack",
        "description": "Detects possible Denial of Service (DoS) attacks against an Okta organization. An adversary may attempt to disrupt an organization's business operations by performing a DoS attack against its Okta service.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 409,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Data Source: Okta",
          "Tactic: Impact"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0040",
              "name": "Impact",
              "reference": "https://attack.mitre.org/tactics/TA0040/"
            },
            "technique": [
              {
                "id": "T1498",
                "name": "Network Denial of Service",
                "reference": "https://attack.mitre.org/techniques/T1498/"
              },
              {
                "id": "T1499",
                "name": "Endpoint Denial of Service",
                "reference": "https://attack.mitre.org/techniques/T1499/"
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "89371b79-872e-4aff-99be-41b36310def1",
        "rule_id": "e6e3ecff-03dd-48ec-acbd-54a04de10c68",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:35.373Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:49.358Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset:okta.system and event.action:(application.integration.rate_limit_exceeded or system.org.rate_limit.warning or system.org.rate_limit.violation or core.concurrency.org.limit.violation)",
        "language": "kuery"
      },
      {
        "name": "High Number of Okta User Password Reset or Unlock Attempts",
        "description": "Identifies a high number of Okta user password reset or account unlock attempts. An adversary may attempt to obtain unauthorized access to Okta user accounts using these methods and attempt to blend in with normal activity in their target's environment and evade detection.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating High Number of Okta User Password Reset or Unlock Attempts\n\nThis rule is designed to detect a suspiciously high number of password reset or account unlock attempts in Okta. Excessive password resets or account unlocks can be indicative of an attacker's attempt to gain unauthorized access to an account.\n\n#### Possible investigation steps:\n- Identify the actor associated with the excessive attempts. The `okta.actor.alternate_id` field can be used for this purpose.\n- Determine the client used by the actor. You can look at `okta.client.device`, `okta.client.ip`, `okta.client.user_agent.raw_user_agent`, `okta.client.ip_chain.ip`, and `okta.client.geographical_context`.\n- Review the `okta.outcome.result` and `okta.outcome.reason` fields to understand the outcome of the password reset or unlock attempts.\n- Review the event actions associated with these attempts. Look at the `event.action` field and filter for actions related to password reset and account unlock attempts.\n- Check for other similar patterns of behavior from the same actor or IP address. If there is a high number of failed login attempts before the password reset or unlock attempts, this may suggest a brute force attack.\n- Also, look at the times when these attempts were made. If these were made during off-hours, it could further suggest an adversary's activity.\n\n### False positive analysis:\n- This alert might be a false positive if there are legitimate reasons for a high number of password reset or unlock attempts. This could be due to the user forgetting their password or account lockouts due to too many incorrect attempts.\n- Check the actor's past behavior. If this is their usual behavior and they have a valid reason for it, then it might be a false positive.\n\n### Response and remediation:\n- If unauthorized attempts are confirmed, initiate the incident response process.\n- Reset the user's password and enforce MFA re-enrollment, if applicable.\n- Block the IP address or device used in the attempts, if they appear suspicious.\n- If the attack was facilitated by a particular technique, ensure your systems are patched or configured to prevent such techniques.\n- Consider a security review of your Okta policies and rules to ensure they follow security best practices.",
        "output_index": "",
        "version": 412,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Data Source: Okta",
          "Tactic: Defense Evasion"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-3600s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic",
          "@BenB196",
          "Austin Songer"
        ],
        "false_positives": [
          "The number of Okta user password reset or account unlock attempts will likely vary between organizations. To fit this rule to their organization, users can duplicate this rule and edit the schedule and threshold values in the new rule."
        ],
        "references": [
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1078",
                "name": "Valid Accounts",
                "reference": "https://attack.mitre.org/techniques/T1078/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1078",
                "name": "Valid Accounts",
                "reference": "https://attack.mitre.org/techniques/T1078/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1078",
                "name": "Valid Accounts",
                "reference": "https://attack.mitre.org/techniques/T1078/"
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "b9dbfbe6-a05b-4d68-b7fa-762128bc04a0",
        "rule_id": "e90ee3af-45fc-432e-a850-4a58cf14a457",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:35.376Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:49.430Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "threshold",
        "query": "event.dataset:okta.system and\n  event.action:(system.email.account_unlock.sent_message or system.email.password_reset.sent_message or\n                system.sms.send_account_unlock_message or system.sms.send_password_reset_message or\n                system.voice.send_account_unlock_call or system.voice.send_password_reset_call or\n                user.account.unlock_token)",
        "threshold": {
          "field": [
            "okta.actor.alternate_id"
          ],
          "value": 5
        },
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Attempt to Deactivate an Okta Application",
        "description": "Detects attempts to deactivate an Okta application. An adversary may attempt to modify, deactivate, or delete an Okta application in order to weaken an organization's security controls or disrupt their business operations.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Attempt to Deactivate an Okta Application\n\nThis rule detects attempts to deactivate an Okta application. Unauthorized deactivation could lead to disruption of services and pose a significant risk to the organization.\n\n#### Possible investigation steps:\n- Identify the actor associated with the deactivation attempt by examining the `okta.actor.id`, `okta.actor.type`, `okta.actor.alternate_id`, and `okta.actor.display_name` fields.\n- Determine the client used by the actor. Review the `okta.client.ip`, `okta.client.user_agent.raw_user_agent`, `okta.client.zone`, `okta.client.device`, and `okta.client.id` fields.\n- If the client is a device, check the `okta.device.id`, `okta.device.name`, `okta.device.os_platform`, `okta.device.os_version`, and `okta.device.managed` fields.\n- Understand the context of the event from the `okta.debug_context.debug_data` and `okta.authentication_context` fields.\n- Check the `okta.outcome.result` and `okta.outcome.reason` fields to see if the attempt was successful or failed.\n- Review the past activities of the actor involved in this action by checking their previous actions logged in the `okta.target` field.\n- Analyze the `okta.transaction.id` and `okta.transaction.type` fields to understand the context of the transaction.\n- Evaluate the actions that happened just before and after this event in the `okta.event_type` field to help understand the full context of the activity.\n\n### False positive analysis:\n- It might be a false positive if the action was part of a planned activity, performed by an authorized person, or if the `okta.outcome.result` field shows a failure.\n- An unsuccessful attempt might also indicate an authorized user having trouble rather than a malicious activity.\n\n### Response and remediation:\n- If unauthorized deactivation attempts are confirmed, initiate the incident response process.\n- Block the IP address or device used in the attempts if they appear suspicious, using the data from the `okta.client.ip` and `okta.device.id` fields.\n- Reset the user's password and enforce MFA re-enrollment, if applicable.\n- Conduct a review of Okta policies and ensure they are in accordance with security best practices.\n- If the deactivated application was crucial for business operations, coordinate with the relevant team to reactivate it and minimize the impact.",
        "output_index": "",
        "version": 410,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Data Source: Okta",
          "Tactic: Impact"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Consider adding exceptions to this rule to filter false positives if your organization's Okta applications are regularly deactivated and the behavior is expected."
        ],
        "references": [
          "https://help.okta.com/en/prod/Content/Topics/Apps/Apps_Apps.htm",
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0040",
              "name": "Impact",
              "reference": "https://attack.mitre.org/tactics/TA0040/"
            },
            "technique": [
              {
                "id": "T1489",
                "name": "Service Stop",
                "reference": "https://attack.mitre.org/techniques/T1489/"
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "8f653cef-5a6f-4153-b3a7-9980b6561e26",
        "rule_id": "edb91186-1c7e-4db8-b53e-bfa33a1a0a8a",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:35.379Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:49.509Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset:okta.system and event.action:application.lifecycle.deactivate",
        "language": "kuery"
      },
      {
        "name": "Okta FastPass Phishing Detection",
        "description": "Detects when Okta FastPass prevents a user from authenticating to a phishing website.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 307,
        "tags": [
          "Tactic: Initial Access",
          "Use Case: Identity and Access Audit",
          "Data Source: Okta"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Austin Songer"
        ],
        "false_positives": [],
        "references": [
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://sec.okta.com/fastpassphishingdetection",
          "https://sec.okta.com/articles/2023/08/cross-tenant-impersonation-prevention-and-detection",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1566",
                "name": "Phishing",
                "reference": "https://attack.mitre.org/techniques/T1566/"
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.\n\nThis rule requires Okta to have the following turned on:\n\nOkta Identity Engine - select 'Phishing Resistance for FastPass' under Settings > Features in the Admin Console.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "okta.event_type",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "okta.outcome.reason",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "075af1f6-92fc-402c-96f7-ce3fbe7a4d68",
        "rule_id": "ee39a9f7-5a79-4b0a-9815-d36b3cf28d3e",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:35.381Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:49.518Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset:okta.system and event.category:authentication and\n  okta.event_type:user.authentication.auth_via_mfa and event.outcome:failure and okta.outcome.reason:\"FastPass declined phishing attempt\"",
        "language": "kuery"
      },
      {
        "name": "Administrator Role Assigned to an Okta User",
        "description": "Identifies when an administrator role is assigned to an Okta user. An adversary may attempt to assign an administrator role to an Okta user in order to assign additional permissions to a user account and maintain access to their target's environment.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 409,
        "tags": [
          "Data Source: Okta",
          "Use Case: Identity and Access Audit",
          "Tactic: Persistence"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Administrator roles may be assigned to Okta users by a Super Admin user. Verify that the behavior was expected. Exceptions can be added to this rule to filter expected behavior."
        ],
        "references": [
          "https://help.okta.com/en/prod/Content/Topics/Security/administrators-admin-comparison.htm",
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta",
          "https://www.elastic.co/security-labs/okta-and-lapsus-what-you-need-to-know"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1098",
                "name": "Account Manipulation",
                "reference": "https://attack.mitre.org/techniques/T1098/"
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "f84dbbab-5345-4fcb-addd-d39cf4664590",
        "rule_id": "f06414a6-f2a4-466d-8eba-10f85e8abf71",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:35.384Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:49.993Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset:okta.system and event.action:user.account.privilege.grant",
        "language": "kuery"
      },
      {
        "name": "Potential Execution via XZBackdoor",
        "description": "It identifies potential malicious shell executions through remote SSH and detects cases where the sshd service suddenly terminates soon after successful execution, suggesting suspicious behavior similar to the XZ backdoor.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 4,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Tactic: Persistence",
          "Tactic: Lateral Movement",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/amlweems/xzbot",
          "https://access.redhat.com/security/cve/CVE-2024-3094",
          "https://www.elastic.co/security-labs/500ms-to-midnight"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1543",
                "name": "Create or Modify System Process",
                "reference": "https://attack.mitre.org/techniques/T1543/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1556",
                "name": "Modify Authentication Process",
                "reference": "https://attack.mitre.org/techniques/T1556/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1021",
                "name": "Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1021/",
                "subtechnique": [
                  {
                    "id": "T1021.004",
                    "name": "SSH",
                    "reference": "https://attack.mitre.org/techniques/T1021/004/"
                  }
                ]
              },
              {
                "id": "T1563",
                "name": "Remote Service Session Hijacking",
                "reference": "https://attack.mitre.org/techniques/T1563/",
                "subtechnique": [
                  {
                    "id": "T1563.001",
                    "name": "SSH Hijacking",
                    "reference": "https://attack.mitre.org/techniques/T1563/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.exit_code",
            "type": "long",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.pid",
            "type": "long",
            "ecs": true
          },
          {
            "name": "process.pid",
            "type": "long",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "6d9a4af5-c03d-4b29-a1b4-fae0dd054f13",
        "rule_id": "7afc6cc9-8800-4c7f-be6b-b688d2dea248",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:35.387Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:36.580Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by host.id, user.id with maxspan=1s\n [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and process.name == \"sshd\" and\n    process.args == \"-D\" and process.args == \"-R\"] by process.pid, process.entity_id\n [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and process.parent.name == \"sshd\" and \n  process.executable != null and not (\n    process.executable in (\"/usr/sbin/sshd\", \"/usr/sbin/unix_chkpwd\", \"/usr/bin/google_authorized_keys\", \"/usr/bin/fipscheck\") or\n    process.args like (\"rsync*\", \"systemctl*\", \"/usr/sbin/unix_chkpwd\", \"/usr/bin/google_authorized_keys\", \"/usr/sbin/aad_certhandler*\") or\n    process.command_line like \"sh -c /usr/bin/env -i PATH=*\"\n  )] by process.parent.pid, process.parent.entity_id\n [process where host.os.type == \"linux\" and event.action == \"end\" and process.name == \"sshd\" and process.exit_code != 0] by process.pid, process.entity_id\n [network where host.os.type == \"linux\" and event.type == \"end\" and event.action == \"disconnect_received\" and process.name == \"sshd\"] by process.pid, process.entity_id",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "APT Package Manager Configuration File Creation",
        "description": "Detects file creation events in the configuration directory for the APT package manager. In Linux, APT (Advanced Package Tool) is a command-line utility used for handling packages on (by default) Debian-based systems, providing functions for installing, updating, upgrading, and removing software along with managing package repositories. Attackers can backdoor APT to gain persistence by injecting malicious code into scripts that APT runs, thereby ensuring continued unauthorized access or control each time APT is used for package management.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 4,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://packetstormsecurity.com/files/152668/APT-Package-Manager-Persistence.html",
          "https://www.elastic.co/security-labs/sequel-on-persistence-mechanisms"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1543",
                "name": "Create or Modify System Process",
                "reference": "https://attack.mitre.org/techniques/T1543/"
              },
              {
                "id": "T1546",
                "name": "Event Triggered Execution",
                "reference": "https://attack.mitre.org/techniques/T1546/",
                "subtechnique": [
                  {
                    "id": "T1546.016",
                    "name": "Installer Packages",
                    "reference": "https://attack.mitre.org/techniques/T1546/016/"
                  }
                ]
              },
              {
                "id": "T1574",
                "name": "Hijack Execution Flow",
                "reference": "https://attack.mitre.org/techniques/T1574/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            }
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.Ext.original.extension",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "7f8bbe4e-ae76-495f-8542-5785ed6991c7",
        "rule_id": "7c2e1297-7664-42bc-af11-6d5d35220b6b",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:35.389Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:36.608Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"linux\" and event.action in (\"rename\", \"creation\") and\nfile.path : \"/etc/apt/apt.conf.d/*\" and not (\n  process.executable in (\n    \"/bin/dpkg\", \"/usr/bin/dpkg\", \"/bin/dockerd\", \"/usr/bin/dockerd\", \"/usr/sbin/dockerd\", \"/bin/microdnf\",\n    \"/usr/bin/microdnf\", \"/bin/rpm\", \"/usr/bin/rpm\", \"/bin/snapd\", \"/usr/bin/snapd\", \"/bin/yum\", \"/usr/bin/yum\",\n    \"/bin/dnf\", \"/usr/bin/dnf\", \"/bin/podman\", \"/usr/bin/podman\", \"/bin/dnf-automatic\", \"/usr/bin/dnf-automatic\",\n    \"/bin/pacman\", \"/usr/bin/pacman\", \"/usr/bin/dpkg-divert\", \"/bin/dpkg-divert\", \"/sbin/apk\", \"/usr/sbin/apk\",\n    \"/usr/local/sbin/apk\", \"/usr/bin/apt\", \"/usr/sbin/pacman\", \"/bin/podman\", \"/usr/bin/podman\", \"/usr/bin/puppet\",\n    \"/bin/puppet\", \"/opt/puppetlabs/puppet/bin/puppet\", \"/usr/bin/chef-client\", \"/bin/chef-client\",\n    \"/bin/autossl_check\", \"/usr/bin/autossl_check\", \"/proc/self/exe\", \"/dev/fd/*\",  \"/usr/bin/pamac-daemon\",\n    \"/bin/pamac-daemon\", \"/usr/lib/snapd/snapd\", \"/usr/local/bin/dockerd\", \"/usr/libexec/netplan/generate\",\n    \"/usr/local/bin/apt-get\", \"/usr/bin/apt-get\"\n  ) or\n  file.path :(\"/etc/apt/apt.conf.d/*.tmp*\") or\n  file.extension in (\"swp\", \"swpx\", \"swx\", \"dpkg-remove\") or\n  file.Ext.original.extension == \"dpkg-new\" or\n  process.executable : (\n    \"/nix/store/*\", \"/var/lib/dpkg/*\", \"/tmp/vmis.*\", \"/snap/*\", \"/dev/fd/*\", \"/usr/lib/*\", \"/usr/libexec/*\",\n    \"/etc/kernel/*\"\n  ) or\n  process.executable == null or\n  process.name in (\"pveupdate\", \"perl\") or\n  (process.name == \"sed\" and file.name : \"sed*\") or\n  (process.name == \"perl\" and file.name : \"e2scrub_all.tmp*\") \n)",
        "language": "eql",
        "index": [
          "logs-endpoint.events.file*"
        ],
        "filters": []
      },
      {
        "name": "Systemd Timer Created",
        "description": "Detects the creation of a systemd timer within any of the default systemd timer directories. Systemd timers can be used by an attacker to gain persistence, by scheduling the execution of a command or script. Similarly to cron/at, systemd timers can be set up to execute on boot time, or on a specific point in time, which allows attackers to regain access in case the connection to the infected asset was lost.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Systemd Timer Created\n\nSystemd timers are used for scheduling and automating recurring tasks or services on Linux systems. \n\nAttackers can leverage systemd timers to run scripts, commands, or malicious software at system boot or on a set time interval by creating a systemd timer and a corresponding systemd service file. \n\nThis rule monitors the creation of new systemd timer files, potentially indicating the creation of a persistence mechanism.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n> This investigation guide uses [placeholder fields](https://www.elastic.co/guide/en/security/current/osquery-placeholder-fields.html) to dynamically pass alert data into Osquery queries. Placeholder fields were introduced in Elastic Stack version 8.7.0. If you're using Elastic Stack version 8.6.0 or earlier, you'll need to manually adjust this investigation guide's queries to ensure they properly run.\n\n#### Possible Investigation Steps\n\n- Investigate the timer file that was created or modified.\n  - !{osquery{\"label\":\"Osquery - Retrieve File Information\",\"query\":\"SELECT * FROM file WHERE path = {{file.path}}\"}}\n- Investigate the currently enabled systemd timers through the following command `sudo systemctl list-timers`.\n- Search for the systemd service file named similarly to the timer that was created.\n- Investigate whether any other files in any of the available systemd directories have been altered through OSQuery.\n  - !{osquery{\"label\":\"Osquery - Retrieve File Listing Information\",\"query\":\"SELECT * FROM file WHERE (path LIKE '/etc/systemd/system/%' OR path LIKE '/usr/local/lib/systemd/system/%' OR path LIKE\\n'/lib/systemd/system/%' OR path LIKE '/usr/lib/systemd/system/%' OR path LIKE\\n'/home/{{user.name}}/.config/systemd/user/%' OR path LIKE '/home/{{user.name}}/.local/share/systemd/user/%' OR path LIKE\\n'/root/.config/systemd/user/%' OR path LIKE '/root/.local/share/systemd/user/%' OR path LIKE '/etc/systemd/user/%' OR\\npath LIKE '/usr/lib/systemd/user/%')\\n\"}}\n  - !{osquery{\"label\":\"Osquery - Retrieve Additional File Listing Information\",\"query\":\"SELECT f.path, u.username AS file_owner, g.groupname AS group_owner, datetime(f.atime, 'unixepoch') AS\\nfile_last_access_time, datetime(f.mtime, 'unixepoch') AS file_last_modified_time, datetime(f.ctime, 'unixepoch') AS\\nfile_last_status_change_time, datetime(f.btime, 'unixepoch') AS file_created_time, f.size AS size_bytes FROM file f LEFT\\nJOIN users u ON f.uid = u.uid LEFT JOIN groups g ON f.gid = g.gid WHERE ( path LIKE '/etc/systemd/system/%' OR path LIKE\\n'/usr/local/lib/systemd/system/%' OR path LIKE '/lib/systemd/system/%' OR path LIKE '/usr/lib/systemd/system/%' OR path\\nLIKE '/home/{{user.name}}/.config/systemd/user/%' OR path LIKE '/home/{{user.name}}/.local/share/systemd/user/%' OR path\\nLIKE '/root/.config/systemd/user/%' OR path LIKE '/root/.local/share/systemd/user/%' OR path LIKE '/etc/systemd/user/%'\\nOR path LIKE '/usr/lib/systemd/user/%')\\n\"}}\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence and whether they are located in expected locations.\n  - !{osquery{\"label\":\"Osquery - Retrieve Running Processes by User\",\"query\":\"SELECT pid, username, name FROM processes p JOIN users u ON u.uid = p.uid ORDER BY username\"}}\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Validate the activity is not related to planned patches, updates, network administrator activity, or legitimate software installations.\n- Investigate whether the altered scripts call other malicious scripts elsewhere on the file system. \n  - If scripts or executables were dropped, retrieve the files and determine if they are malicious:\n    - Use a private sandboxed malware analysis system to perform analysis.\n      - Observe and collect information about the following activities:\n        - Attempts to contact external domains and addresses.\n          - Check if the domain is newly registered or unexpected.\n          - Check the reputation of the domain or IP address.\n        - File access, modification, and creation activities.\n        - Cron jobs, services and other persistence mechanisms.\n            - !{osquery{\"label\":\"Osquery - Retrieve Crontab Information\",\"query\":\"SELECT * FROM crontab\"}}\n\n### False Positive Analysis\n\n- If this activity is related to new benign software installation activity, consider adding exceptions — preferably with a combination of user and command line conditions.\n- If this activity is related to a system administrator who uses systemd timers for administrative purposes, consider adding exceptions for this specific administrator user account. \n- Try to understand the context of the execution by thinking about the user, machine, or business purpose. A small number of endpoints, such as servers with unique software, might appear unusual but satisfy a specific business need.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Delete the service/timer or restore its original configuration.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Leverage the incident response data and logging to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 15,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://opensource.com/article/20/7/systemd-timers",
          "https://pberba.github.io/security/2022/01/30/linux-threat-hunting-for-persistence-systemd-timers-cron/",
          "https://www.elastic.co/security-labs/primer-on-persistence-mechanisms"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1053",
                "name": "Scheduled Task/Job",
                "reference": "https://attack.mitre.org/techniques/T1053/",
                "subtechnique": [
                  {
                    "id": "T1053.006",
                    "name": "Systemd Timers",
                    "reference": "https://attack.mitre.org/techniques/T1053/006/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.Ext.original.extension",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "33856492-a298-4c1a-8a77-de5d4e996fbe",
        "rule_id": "7fb500fa-8e24-4bd1-9480-2a819352602c",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:35.392Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:37.226Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"linux\" and event.action in (\"rename\", \"creation\") and file.path : (\n  \"/etc/systemd/system/*\", \"/etc/systemd/user/*\", \"/usr/local/lib/systemd/system/*\",\n  \"/lib/systemd/system/*\", \"/usr/lib/systemd/system/*\", \"/usr/lib/systemd/user/*\",\n  \"/home/*/.config/systemd/user/*\", \"/home/*/.local/share/systemd/user/*\",\n  \"/root/.config/systemd/user/*\", \"/root/.local/share/systemd/user/*\"\n) and file.extension == \"timer\" and not (\n  process.executable in (\n    \"/bin/dpkg\", \"/usr/bin/dpkg\", \"/bin/dockerd\", \"/usr/bin/dockerd\", \"/usr/sbin/dockerd\", \"/bin/microdnf\",\n    \"/usr/bin/microdnf\", \"/bin/rpm\", \"/usr/bin/rpm\", \"/bin/snapd\", \"/usr/bin/snapd\", \"/bin/yum\", \"/usr/bin/yum\",\n    \"/bin/dnf\", \"/usr/bin/dnf\", \"/bin/podman\", \"/usr/bin/podman\", \"/bin/dnf-automatic\", \"/usr/bin/dnf-automatic\",\n    \"/bin/pacman\", \"/usr/bin/pacman\", \"/usr/bin/dpkg-divert\", \"/bin/dpkg-divert\", \"/sbin/apk\", \"/usr/sbin/apk\",\n    \"/usr/local/sbin/apk\", \"/usr/bin/apt\", \"/usr/sbin/pacman\", \"/bin/podman\", \"/usr/bin/podman\", \"/usr/bin/puppet\",\n    \"/bin/puppet\", \"/opt/puppetlabs/puppet/bin/puppet\", \"/usr/bin/chef-client\", \"/bin/chef-client\",\n    \"/bin/autossl_check\", \"/usr/bin/autossl_check\", \"/proc/self/exe\", \"/dev/fd/*\",  \"/usr/bin/pamac-daemon\",\n    \"/bin/pamac-daemon\", \"/usr/lib/snapd/snapd\", \"/usr/local/bin/dockerd\", \"/usr/bin/crio\", \"/usr/sbin/crond\",\n    \"/opt/puppetlabs/puppet/bin/ruby\", \"/usr/libexec/platform-python\", \"/kaniko/kaniko-executor\",\n    \"/usr/local/bin/dockerd\", \"/usr/bin/podman\", \"/bin/install\", \"/proc/self/exe\"\n  ) or\n  process.name like (\n    \"python*\", \"crio\", \"apt-get\", \"install\", \"snapd\", \"cloudflared\", \"sshd\", \"convert-usrmerge\", \"docker-init\",\n    \"google_metadata_script_runner\"\n  ) or\n  file.extension in (\"swp\", \"swpx\", \"swx\", \"dpkg-remove\") or\n  file.Ext.original.extension == \"dpkg-new\" or\n  process.executable : (\n    \"/nix/store/*\", \"/var/lib/dpkg/*\", \"/tmp/vmis.*\", \"/snap/*\", \"/dev/fd/*\", \"/usr/lib/virtualbox/*\"\n  ) or\n  process.executable == null or\n  (process.name == \"sed\" and file.name : \"sed*\") or\n  (process.name == \"perl\" and file.name : \"e2scrub_all.tmp*\") \n)",
        "language": "eql",
        "index": [
          "logs-endpoint.events.file*"
        ],
        "filters": []
      },
      {
        "name": "Potential Okta MFA Bombing via Push Notifications",
        "description": "Detects when an attacker abuses the Multi-Factor authentication mechanism by repeatedly issuing login requests until the user eventually accepts the Okta push notification. An adversary may attempt to bypass the Okta MFA policies configured for an organization to obtain unauthorized access.",
        "risk_score": 73,
        "severity": "high",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Potential Okta MFA Bombing via Push Notifications\n\nMulti-Factor Authentication (MFA) is an effective method to prevent unauthorized access. However, some adversaries may abuse the system by repeatedly sending MFA push notifications until the user unwittingly approves the access.\n\nThis rule detects when a user denies MFA Okta Verify push notifications twice, followed by a successful authentication event within a 10-minute window. This sequence could indicate an adversary's attempt to bypass the Okta MFA policy.\n\n#### Possible investigation steps:\n\n- Identify the user who received the MFA notifications by reviewing the `user.email` field.\n- Identify the time, source IP, and geographical location of the MFA requests and the subsequent successful login.\n- Review the `event.action` field to understand the nature of the events. It should include two `user.mfa.okta_verify.deny_push` actions and one `user.authentication.sso` action.\n- Ask the user if they remember receiving the MFA notifications and subsequently logging into their account.\n- Check if the MFA requests and the successful login occurred during the user's regular activity hours.\n- Look for any other suspicious activity on the account around the same time.\n- Identify whether the same pattern is repeated for other users in your organization. Multiple users receiving push notifications simultaneously might indicate a larger attack.\n\n### False positive analysis:\n\n- Determine if the MFA push notifications were legitimate. Sometimes, users accidentally trigger MFA requests or deny them unintentionally and later approve them.\n- Check if there are known issues with the MFA system causing false denials.\n\n### Response and remediation:\n\n- If unauthorized access is confirmed, initiate your incident response process.\n- Alert the user and your IT department immediately.\n- If possible, isolate the user's account until the issue is resolved.\n- Investigate the source of the unauthorized access.\n- If the account was accessed by an unauthorized party, determine the actions they took after logging in.\n- Consider enhancing your MFA policy to prevent such incidents in the future.\n- Encourage users to report any unexpected MFA notifications immediately.\n- Review and update your incident response plans and security policies based on the findings from the incident.\n",
        "output_index": "",
        "version": 207,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Tactic: Credential Access",
          "Data Source: Okta"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.mandiant.com/resources/russian-targeting-gov-business",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://sec.okta.com/articles/2023/08/cross-tenant-impersonation-prevention-and-detection",
          "https://www.rezonate.io/blog/okta-logs-decoded-unveiling-identity-threats-through-threat-hunting/",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1621",
                "name": "Multi-Factor Authentication Request Generation",
                "reference": "https://attack.mitre.org/techniques/T1621/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.\n",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "okta.actor.id",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "okta.event_type",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "okta.outcome.result",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "fd97b5ab-1ebb-4787-b873-07976acc5441",
        "rule_id": "8a0fbd26-867f-11ee-947c-f661ea17fbcd",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:35.395Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:38.668Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by okta.actor.id with maxspan=10m\n  [authentication where event.dataset == \"okta.system\"\n    and okta.event_type == \"user.mfa.okta_verify.deny_push\"] with runs=5\n  until [authentication where event.dataset == \"okta.system\"\n    and (okta.event_type: (\n      \"user.authentication.sso\",\n      \"user.authentication.auth_via_mfa\",\n      \"user.authentication.verify\",\n      \"user.session.start\") and okta.outcome.result == \"SUCCESS\")]",
        "language": "eql",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "event_category_override": "event.category"
      },
      {
        "name": "Attempt to Deactivate an Okta Network Zone",
        "description": "Detects attempts to deactivate an Okta network zone. Okta network zones can be configured to limit or restrict access to a network based on IP addresses or geolocations. An adversary may attempt to modify, delete, or deactivate an Okta network zone in order to remove or weaken an organization's security controls.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Attempt to Deactivate an Okta Network Zone\n\nThe Okta network zones can be configured to restrict or limit access to a network based on IP addresses or geolocations. Deactivating a network zone in Okta may remove or weaken the security controls of an organization, which might be an indicator of an adversary's attempt to evade defenses.\n\n#### Possible investigation steps\n\n- Identify the actor related to the alert by reviewing the `okta.actor.id`, `okta.actor.type`, `okta.actor.alternate_id`, or `okta.actor.display_name` fields.\n- Examine the `event.action` field to confirm the deactivation of a network zone.\n- Check the `okta.target.id`, `okta.target.type`, `okta.target.alternate_id`, or `okta.target.display_name` to identify the network zone that was deactivated.\n- Investigate the `event.time` field to understand when the event happened.\n- Review the actor's activities before and after the event to understand the context of this event.\n\n### False positive analysis\n\n- Check the `okta.client.user_agent.raw_user_agent` field to understand the device and software used by the actor. If these match the actor's normal behavior, it might be a false positive.\n- Check if the actor is a known administrator or part of the IT team who might have a legitimate reason to deactivate a network zone.\n- Verify the actor's actions with any known planned changes or maintenance activities.\n\n### Response and remediation\n\n- If unauthorized access or actions are confirmed, immediately lock the affected actor account and require a password change.\n- Re-enable the deactivated network zone if it was deactivated without authorization.\n- Review and update the privileges of the actor who initiated the deactivation.\n- Check the security policies and procedures to identify any gaps and update them as necessary.\n- Implement additional monitoring and logging of Okta events to improve visibility of user actions.\n- Communicate and train the employees about the importance of following proper procedures for modifying network zone settings.",
        "output_index": "",
        "version": 410,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Data Source: Okta",
          "Use Case: Network Security Monitoring",
          "Tactic: Defense Evasion"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Consider adding exceptions to this rule to filter false positives if your organization's Okta network zones are regularly modified."
        ],
        "references": [
          "https://help.okta.com/en/prod/Content/Topics/Security/network/network-zones.htm",
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.007",
                    "name": "Disable or Modify Cloud Firewall",
                    "reference": "https://attack.mitre.org/techniques/T1562/007/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "5cd6c980-5173-4264-befa-868ab3b69f0e",
        "rule_id": "8a5c1e5f-ad63-481e-b53a-ef959230f7f1",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:35.397Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:38.708Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset:okta.system and event.action:zone.deactivate",
        "language": "kuery"
      },
      {
        "name": "Remote Scheduled Task Creation",
        "description": "Identifies remote scheduled task creations on a target host. This could be indicative of adversary lateral movement.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Remote Scheduled Task Creation\n\n[Scheduled tasks](https://docs.microsoft.com/en-us/windows/win32/taskschd/about-the-task-scheduler) are a great mechanism for persistence and program execution. These features can be used remotely for a variety of legitimate reasons, but at the same time used by malware and adversaries. When investigating scheduled tasks that were set up remotely, one of the first steps should be to determine the original intent behind the configuration and to verify if the activity is tied to benign behavior such as software installation or any kind of network administrator work. One objective for these alerts is to understand the configured action within the scheduled task. This is captured within the registry event data for this rule and can be base64 decoded to view the value.\n\n#### Possible investigation steps\n\n- Review the base64 encoded tasks actions registry value to investigate the task configured action.\n- Validate if the activity is not related to planned patches, updates, network administrator activity, or legitimate software installations.\n- Further examination should include review of host-based artifacts and network logs from around when the scheduled task was created, on both the source and target machines.\n\n### False positive analysis\n\n- There is a high possibility of benign activity tied to the creation of remote scheduled tasks as it is a general feature within Windows and used for legitimate purposes for a wide range of activity. Any kind of context should be found to further understand the source of the activity and determine the intent based on the scheduled task's contents.\n\n### Related rules\n\n- Service Command Lateral Movement - d61cbcf8-1bc1-4cff-85ba-e7b21c5beedc\n- Remotely Started Services via RPC - aa9a274d-6b53-424d-ac5e-cb8ca4251650\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Remove scheduled task and any other related artifacts.\n- Review privileged account management and user account management settings. Consider implementing group policy object (GPO) policies to further restrict activity, or configuring settings that only allow administrators to create remote scheduled tasks.\n",
        "output_index": "",
        "version": 210,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Lateral Movement",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/security-labs/hunting-for-lateral-movement-using-event-query-language"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1021",
                "name": "Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1021/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1053",
                "name": "Scheduled Task/Job",
                "reference": "https://attack.mitre.org/techniques/T1053/",
                "subtechnique": [
                  {
                    "id": "T1053.005",
                    "name": "Scheduled Task",
                    "reference": "https://attack.mitre.org/techniques/T1053/005/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.port",
            "type": "long",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "network.direction",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.value",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "source.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "source.port",
            "type": "long",
            "ecs": true
          }
        ],
        "id": "ff964c63-4c5c-4dbc-9db7-ecdcf10fa112",
        "rule_id": "954ee7c8-5437-49ae-b2d6-2960883898e9",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:35.400Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:40.644Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "/* Task Scheduler service incoming connection followed by TaskCache registry modification  */\n\nsequence by host.id, process.entity_id with maxspan = 1m\n   [network where host.os.type == \"windows\" and process.name : \"svchost.exe\" and\n   network.direction : (\"incoming\", \"ingress\") and source.port >= 49152 and destination.port >= 49152 and\n   source.ip != \"127.0.0.1\" and source.ip != \"::1\"\n   ]\n   [registry where host.os.type == \"windows\" and event.type == \"change\" and registry.value : \"Actions\" and\n    registry.path : \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Schedule\\\\TaskCache\\\\Tasks\\\\*\\\\Actions\"]",
        "language": "eql",
        "index": [
          "logs-endpoint.events.registry-*",
          "logs-endpoint.events.network-*",
          "winlogbeat-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "Attempt to Create Okta API Token",
        "description": "Detects attempts to create an Okta API token. An adversary may create an Okta API token to maintain access to an organization's network while they work to achieve their objectives. An attacker may abuse an API token to execute techniques such as creating user accounts or disabling security rules or policies.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 409,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Data Source: Okta",
          "Tactic: Persistence"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "If the behavior of creating Okta API tokens is expected, consider adding exceptions to this rule to filter false positives."
        ],
        "references": [
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1136",
                "name": "Create Account",
                "reference": "https://attack.mitre.org/techniques/T1136/"
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "98a55d11-37ea-43b3-9f81-b8080bb3ea8e",
        "rule_id": "96b9f4ea-0e8c-435b-8d53-2096e75fcac5",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:35.402Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:40.668Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset:okta.system and event.action:system.api_token.create",
        "language": "kuery"
      },
      {
        "name": "Suspicious Execution from Foomatic-rip or Cupsd Parent",
        "description": "This detection rule addresses multiple vulnerabilities in the CUPS printing system, including CVE-2024-47176, CVE-2024-47076, CVE-2024-47175, and CVE-2024-47177. Specifically, this rule detects suspicious process command lines executed by child processes of foomatic-rip and cupsd. These flaws impact components like cups-browsed, libcupsfilters, libppd, and foomatic-rip, allowing remote unauthenticated attackers to manipulate IPP URLs or inject malicious data through crafted UDP packets or network spoofing. This can result in arbitrary command execution when a print job is initiated.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Suspicious Execution from Foomatic-rip or Cupsd Parent\n\nThis rule identifies potential exploitation attempts of several vulnerabilities in the CUPS printing system (CVE-2024-47176, CVE-2024-47076, CVE-2024-47175, CVE-2024-47177). These vulnerabilities allow attackers to send crafted IPP requests or manipulate UDP packets to execute arbitrary commands or modify printer configurations. Attackers can exploit these flaws to inject malicious data, leading to Remote Code Execution (RCE) on affected systems.\n\n#### Possible Investigation Steps\n\n- Investigate the incoming IPP requests or UDP packets targeting port 631.\n- Examine the printer configurations on the system to determine if any unauthorized printers or URLs have been added.\n- Investigate the process tree to check if any unexpected processes were triggered as a result of IPP activity. Review the executable files for legitimacy.\n- Check for additional alerts related to the compromised system or user within the last 48 hours.\n- Investigate network traffic logs for suspicious outbound connections to unrecognized domains or IP addresses.\n- Check if any of the contacted domains or addresses are newly registered or have a suspicious reputation.\n- Retrieve any scripts or executables dropped by the attack for further analysis in a private sandbox environment:\n- Analyze potential malicious activity, including:\n  - Attempts to communicate with external servers.\n  - File access or creation of unauthorized executables.\n  - Cron jobs, services, or other persistence mechanisms.\n\n### Related Rules\n- Cupsd or Foomatic-rip Shell Execution - 476267ff-e44f-476e-99c1-04c78cb3769d\n- Printer User (lp) Shell Execution - f86cd31c-5c7e-4481-99d7-6875a3e31309\n- Network Connection by Cups or Foomatic-rip Child - e80ee207-9505-49ab-8ca8-bc57d80e2cab\n- File Creation by Cups or Foomatic-rip Child - b9b14be7-b7f4-4367-9934-81f07d2f63c4\n\n### False Positive Analysis\n\n- This activity is rarely legitimate. However, verify the context to rule out non-malicious printer configuration changes or legitimate IPP requests.\n\n### Response and Remediation\n\n- Initiate the incident response process based on the triage outcome.\n- Isolate the compromised host to prevent further exploitation.\n- If the investigation confirms malicious activity, search the environment for additional compromised hosts.\n- Implement network segmentation or restrictions to contain the attack.\n- Stop suspicious processes or services tied to CUPS exploitation.\n- Block identified Indicators of Compromise (IoCs), including IP addresses, domains, or hashes of involved files.\n- Review compromised systems for backdoors, such as reverse shells or persistence mechanisms like cron jobs.\n- Investigate potential credential exposure on compromised systems and reset passwords for any affected accounts.\n- Restore the original printer configurations or uninstall unauthorized printer entries.\n- Perform a thorough antimalware scan to identify any lingering threats or artifacts from the attack.\n- Investigate how the attacker gained initial access and address any weaknesses to prevent future exploitation.\n- Use insights from the incident to improve detection and response times in future incidents (MTTD and MTTR).\n",
        "output_index": "",
        "version": 2,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Use Case: Vulnerability",
          "Tactic: Execution",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/security-labs/cups-overflow",
          "https://www.evilsocket.net/2024/09/26/Attacking-UNIX-systems-via-CUPS-Part-I/",
          "https://gist.github.com/stong/c8847ef27910ae344a7b5408d9840ee1",
          "https://github.com/RickdeJager/cupshax/blob/main/cupshax.py"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1203",
                "name": "Exploitation for Client Execution",
                "reference": "https://attack.mitre.org/techniques/T1203/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "bd80ffd6-cdbb-4a64-b97f-8ea09536b321",
        "rule_id": "986361cd-3dac-47fe-afa1-5c5dd89f2fb4",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:35.408Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:40.739Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\nprocess.parent.name in (\"foomatic-rip\", \"cupsd\") and process.command_line like (\n  // persistence\n  \"*cron*\", \"*/etc/rc.local*\", \"*/dev/tcp/*\", \"*/etc/init.d*\", \"*/etc/update-motd.d*\", \"*/etc/sudoers*\",\n  \"*/etc/profile*\", \"*autostart*\", \"*/etc/ssh*\", \"*/home/*/.ssh/*\", \"*/root/.ssh*\", \"*~/.ssh/*\", \"*udev*\",\n  \"*/etc/shadow*\", \"*/etc/passwd*\",\n\n  // Downloads\n  \"*curl*\", \"*wget*\",\n\n  // encoding and decoding\n  \"*base64 *\", \"*base32 *\", \"*xxd *\", \"*openssl*\",\n\n  // reverse connections\n  \"*GS_ARGS=*\", \"*/dev/tcp*\", \"*/dev/udp/*\", \"*import*pty*spawn*\", \"*import*subprocess*call*\", \"*TCPSocket.new*\",\n  \"*TCPSocket.open*\", \"*io.popen*\", \"*os.execute*\", \"*fsockopen*\", \"*disown*\", \"*nohup*\",\n\n  // SO loads\n  \"*openssl*-engine*.so*\", \"*cdll.LoadLibrary*.so*\", \"*ruby*-e**Fiddle.dlopen*.so*\", \"*Fiddle.dlopen*.so*\",\n  \"*cdll.LoadLibrary*.so*\",\n\n  // misc. suspicious command lines\n   \"*/etc/ld.so*\", \"*/dev/shm/*\", \"*/var/tmp*\", \"*echo*\", \"*>>*\", \"*|*\"\n) and not process.args like \"gs*\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Potentially Successful MFA Bombing via Push Notifications",
        "description": "Detects when an attacker abuses the Multi-Factor authentication mechanism by repeatedly issuing login requests until the user eventually accepts the Okta push notification. An adversary may attempt to bypass the Okta MFA policies configured for an organization to obtain unauthorized access.",
        "risk_score": 73,
        "severity": "high",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Potential Abuse of Repeated MFA Push Notifications\n\nMulti-Factor Authentication (MFA) is an effective method to prevent unauthorized access. However, some adversaries may abuse the system by repeatedly sending MFA push notifications until the user unwittingly approves the access.\n\nThis rule detects when a user denies MFA Okta Verify push notifications twice, followed by a successful authentication event within a 10-minute window. This sequence could indicate an adversary's attempt to bypass the Okta MFA policy.\n\n#### Possible investigation steps:\n\n- Identify the user who received the MFA notifications by reviewing the `user.email` field.\n- Identify the time, source IP, and geographical location of the MFA requests and the subsequent successful login.\n- Review the `event.action` field to understand the nature of the events. It should include two `user.mfa.okta_verify.deny_push` actions and one `user.authentication.sso` action.\n- Ask the user if they remember receiving the MFA notifications and subsequently logging into their account.\n- Check if the MFA requests and the successful login occurred during the user's regular activity hours.\n- Look for any other suspicious activity on the account around the same time.\n- Identify whether the same pattern is repeated for other users in your organization. Multiple users receiving push notifications simultaneously might indicate a larger attack.\n\n### False positive analysis:\n\n- Determine if the MFA push notifications were legitimate. Sometimes, users accidentally trigger MFA requests or deny them unintentionally and later approve them.\n- Check if there are known issues with the MFA system causing false denials.\n\n### Response and remediation:\n\n- If unauthorized access is confirmed, initiate your incident response process.\n- Alert the user and your IT department immediately.\n- If possible, isolate the user's account until the issue is resolved.\n- Investigate the source of the unauthorized access.\n- If the account was accessed by an unauthorized party, determine the actions they took after logging in.\n- Consider enhancing your MFA policy to prevent such incidents in the future.\n- Encourage users to report any unexpected MFA notifications immediately.\n- Review and update your incident response plans and security policies based on the findings from the incident.",
        "output_index": "",
        "version": 413,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Tactic: Credential Access",
          "Data Source: Okta"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.mandiant.com/resources/russian-targeting-gov-business",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://sec.okta.com/articles/2023/08/cross-tenant-impersonation-prevention-and-detection",
          "https://www.rezonate.io/blog/okta-logs-decoded-unveiling-identity-threats-through-threat-hunting/",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1621",
                "name": "Multi-Factor Authentication Request Generation",
                "reference": "https://attack.mitre.org/techniques/T1621/"
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.module",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "okta.actor.id",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "okta.outcome.result",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "66312bd4-c634-46c6-bd99-38b02b5f2105",
        "rule_id": "97a8e584-fd3b-421f-9b9d-9c9d9e57e9d7",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:35.405Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:40.705Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by okta.actor.id with maxspan=10m\n  [authentication where event.dataset == \"okta.system\" and event.module == \"okta\"\n    and event.action == \"user.mfa.okta_verify.deny_push\"] with runs=3\n  [authentication where event.dataset == \"okta.system\" and event.module == \"okta\"\n    and (event.action : (\n      \"user.authentication.sso\",\n      \"user.authentication.auth_via_mfa\",\n      \"user.authentication.verify\",\n      \"user.session.start\") and okta.outcome.result == \"SUCCESS\")]",
        "language": "eql",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "event_category_override": "event.category"
      },
      {
        "name": "Potential Credential Access via LSASS Memory Dump",
        "description": "Identifies suspicious access to LSASS handle from a call trace pointing to DBGHelp.dll or DBGCore.dll, which both export the MiniDumpWriteDump method that can be used to dump LSASS memory content in preparation for credential access.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 310,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Tactic:Execution",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.ired.team/offensive-security/credential-access-and-credential-dumping/dump-credentials-from-lsass-process-without-mimikatz",
          "https://www.elastic.co/security-labs/detect-credential-access",
          "https://www.elastic.co/security-labs/elastic-protects-against-data-wiper-malware-targeting-ukraine-hermeticwiper"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1003",
                "name": "OS Credential Dumping",
                "reference": "https://attack.mitre.org/techniques/T1003/",
                "subtechnique": [
                  {
                    "id": "T1003.001",
                    "name": "LSASS Memory",
                    "reference": "https://attack.mitre.org/techniques/T1003/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1106",
                "name": "Native API",
                "reference": "https://attack.mitre.org/techniques/T1106/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.code",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.event_data.CallTrace",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "winlog.event_data.TargetImage",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "9cd61645-4f63-40b2-9ce6-392ba3d648d7",
        "rule_id": "9960432d-9b26-409f-972b-839a959e79e2",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:35.411Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:40.774Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.code == \"10\" and\n  winlog.event_data.TargetImage : \"?:\\\\WINDOWS\\\\system32\\\\lsass.exe\" and\n\n   /* DLLs exporting MiniDumpWriteDump API to create an lsass mdmp*/\n  winlog.event_data.CallTrace : (\"*dbghelp*\", \"*dbgcore*\") and\n\n   /* case of lsass crashing */\n  not process.executable : (\n        \"?:\\\\Windows\\\\System32\\\\WerFault.exe\",\n        \"?:\\\\Windows\\\\SysWOW64\\\\WerFault.exe\",\n        \"?:\\\\Windows\\\\System32\\\\WerFaultSecure.exe\"\n      )",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "Potential Credential Access via DCSync",
        "description": "This rule identifies when a User Account starts the Active Directory Replication Process. Attackers can use the DCSync technique to get credential information of individual accounts or the entire domain, thus compromising the entire domain.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Potential Credential Access via DCSync\n\nActive Directory replication is the process by which the changes that originate on one domain controller are automatically transferred to other domain controllers that store the same data.\n\nActive Directory data consists of objects that have properties, or attributes. Each object is an instance of an object class, and object classes and their respective attributes are defined in the Active Directory schema. Objects are defined by the values of their attributes, and changes to attribute values must be transferred from the domain controller on which they occur to every other domain controller that stores a replica of an affected object.\n\nAdversaries can use the DCSync technique that uses Windows Domain Controller's API to simulate the replication process from a remote domain controller, compromising major credential material such as the Kerberos krbtgt keys used legitimately for tickets creation, but also tickets forging by attackers. This attack requires some extended privileges to succeed (DS-Replication-Get-Changes and DS-Replication-Get-Changes-All), which are granted by default to members of the Administrators, Domain Admins, Enterprise Admins, and Domain Controllers groups. Privileged accounts can be abused to grant controlled objects the right to DCsync/Replicate.\n\nMore details can be found on [Threat Hunter Playbook](https://threathunterplaybook.com/library/windows/active_directory_replication.html?highlight=dcsync#directory-replication-services-auditing) and [The Hacker Recipes](https://www.thehacker.recipes/ad/movement/credentials/dumping/dcsync).\n\nThis rule monitors for Event ID 4662 (Operation was performed on an Active Directory object) and identifies events that use the access mask 0x100 (Control Access) and properties that contain at least one of the following or their equivalent Schema-Id-GUID (DS-Replication-Get-Changes, DS-Replication-Get-Changes-All, DS-Replication-Get-Changes-In-Filtered-Set). It also filters out events that use computer accounts and also Azure AD Connect MSOL accounts (more details [here](https://techcommunity.microsoft.com/t5/microsoft-defender-for-identity/ad-connect-msol-user-suspected-dcsync-attack/m-p/788028)).\n\n#### Possible investigation steps\n\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account and system owners and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Correlate security events 4662 and 4624 (Logon Type 3) by their Logon ID (`winlog.logon.id`) on the Domain Controller (DC) that received the replication request. This will tell you where the AD replication request came from, and if it came from another DC or not.\n- Scope which credentials were compromised (for example, whether all accounts were replicated or specific ones).\n\n### False positive analysis\n\n- Administrators may use custom accounts on Azure AD Connect, investigate if it is the case, and if it is properly secured. If noisy in your environment due to expected activity, consider adding the corresponding account as a exception.\n- Although replicating Active Directory (AD) data to non-Domain Controllers is not a common practice and is generally not recommended from a security perspective, some software vendors may require it for their products to function correctly. If this rule is noisy in your environment due to expected activity, consider adding the corresponding account as a exception.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- If the entire domain or the `krbtgt` user was compromised:\n  - Activate your incident response plan for total Active Directory compromise which should include, but not be limited to, a password reset (twice) of the `krbtgt` user.\n- Investigate how the attacker escalated privileges and identify systems they used to conduct lateral movement. Use this information to determine ways the attacker could regain access to the environment.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 215,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Tactic: Privilege Escalation",
          "Data Source: Active Directory",
          "Resources: Investigation Guide",
          "Use Case: Active Directory Monitoring",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://threathunterplaybook.com/notebooks/windows/06_credential_access/WIN-180815210510.html",
          "https://threathunterplaybook.com/library/windows/active_directory_replication.html?highlight=dcsync#directory-replication-services-auditing",
          "https://github.com/SigmaHQ/sigma/blob/master/rules/windows/builtin/security/win_ad_replication_non_machine_account.yml",
          "https://github.com/atc-project/atomic-threat-coverage/blob/master/Atomic_Threat_Coverage/Logging_Policies/LP_0027_windows_audit_directory_service_access.md",
          "https://attack.stealthbits.com/privilege-escalation-using-mimikatz-dcsync",
          "https://www.thehacker.recipes/ad/movement/credentials/dumping/dcsync",
          "https://www.elastic.co/security-labs/siestagraph-new-implant-uncovered-in-asean-member-foreign-ministry"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1003",
                "name": "OS Credential Dumping",
                "reference": "https://attack.mitre.org/techniques/T1003/",
                "subtechnique": [
                  {
                    "id": "T1003.006",
                    "name": "DCSync",
                    "reference": "https://attack.mitre.org/techniques/T1003/006/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1078",
                "name": "Valid Accounts",
                "reference": "https://attack.mitre.org/techniques/T1078/",
                "subtechnique": [
                  {
                    "id": "T1078.002",
                    "name": "Domain Accounts",
                    "reference": "https://attack.mitre.org/techniques/T1078/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'Audit Directory Service Access' logging policy must be configured for (Success, Failure).\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nPolicies >\nWindows Settings >\nSecurity Settings >\nAdvanced Audit Policies Configuration >\nAudit Policies >\nDS Access >\nAudit Directory Service Access (Success,Failure)\n```\n",
        "related_integrations": [
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.code",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.event_data.AccessMask",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "winlog.event_data.Properties",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "winlog.event_data.SubjectUserName",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "caa90dad-8e1e-469d-807b-1fd4658de805",
        "rule_id": "9f962927-1a4f-45f3-a57b-287f2c7029c1",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:35.414Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:41.368Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "any where event.action : (\"Directory Service Access\", \"object-operation-performed\") and\n  event.code == \"4662\" and winlog.event_data.Properties : (\n\n    /* Control Access Rights/Permissions Symbol */\n\n    \"*DS-Replication-Get-Changes*\",\n    \"*DS-Replication-Get-Changes-All*\",\n    \"*DS-Replication-Get-Changes-In-Filtered-Set*\",\n\n    /* Identifying GUID used in ACE */\n\n    \"*1131f6ad-9c07-11d1-f79f-00c04fc2dcd2*\",\n    \"*1131f6aa-9c07-11d1-f79f-00c04fc2dcd2*\",\n    \"*89e95b76-444d-4c62-991a-0facbeda640c*\")\n\n    /* The right to perform an operation controlled by an extended access right. */\n\n    and winlog.event_data.AccessMask : \"0x100\" and\n    not winlog.event_data.SubjectUserName : (\n          \"*$\", \"MSOL_*\", \"OpenDNS_Connector\", \"adconnect\", \"SyncADConnect\",\n          \"SyncADConnectCM\", \"aadsync\", \"svcAzureADSync\", \"-\"\n        )\n\n    /* The Umbrella AD Connector uses the OpenDNS_Connector account to perform replication */",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-system.*",
          "logs-windows.*"
        ],
        "filters": []
      },
      {
        "name": "Systemd-udevd Rule File Creation",
        "description": "Monitors for the creation of rule files that are used by systemd-udevd to manage device nodes and handle kernel device events in the Linux operating system. Systemd-udevd can be exploited for persistence by adversaries by creating malicious udev rules that trigger on specific events, executing arbitrary commands or payloads whenever a certain device is plugged in or recognized by the system.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 7,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/security-labs/sequel-on-persistence-mechanisms"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1037",
                "name": "Boot or Logon Initialization Scripts",
                "reference": "https://attack.mitre.org/techniques/T1037/"
              },
              {
                "id": "T1546",
                "name": "Event Triggered Execution",
                "reference": "https://attack.mitre.org/techniques/T1546/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows\nthe Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click Add integrations.\n- In the query bar, search for Elastic Defend and select the integration to see more details about it.\n- Click Add Elastic Defend.\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either Traditional Endpoints or Cloud Workloads.\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest to select \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in New agent policy name. If other agent policies already exist, you can click the Existing hosts tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click Save and Continue.\n- To complete the integration, select Add Elastic Agent to your hosts and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.Ext.original.extension",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "969a45d2-df76-44ab-9cf2-ca341310336e",
        "rule_id": "054db96b-fd34-43b3-9af2-587b3bd33964",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:35.417Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:22.131Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"linux\" and event.action in (\"rename\", \"creation\") and \nprocess.executable != null and file.extension == \"rules\" and\nfile.path : (\n  \"/lib/udev/*\", \"/etc/udev/rules.d/*\", \"/usr/lib/udev/rules.d/*\", \"/run/udev/rules.d/*\", \"/usr/local/lib/udev/rules.d/*\"\n) and not (\n  process.executable in (\n    \"/bin/dpkg\", \"/usr/bin/dpkg\", \"/bin/dockerd\", \"/usr/bin/dockerd\", \"/usr/sbin/dockerd\", \"/bin/microdnf\",\n    \"/usr/bin/microdnf\", \"/bin/rpm\", \"/usr/bin/rpm\", \"/bin/snapd\", \"/usr/bin/snapd\", \"/bin/yum\", \"/usr/bin/yum\",\n    \"/bin/dnf\", \"/usr/bin/dnf\", \"/bin/podman\", \"/usr/bin/podman\", \"/bin/dnf-automatic\", \"/usr/bin/dnf-automatic\",\n    \"/bin/pacman\", \"/usr/bin/pacman\", \"/usr/bin/dpkg-divert\", \"/bin/dpkg-divert\", \"/sbin/apk\", \"/usr/sbin/apk\",\n    \"/usr/local/sbin/apk\", \"/usr/bin/apt\", \"/usr/sbin/pacman\", \"/bin/podman\", \"/usr/bin/podman\", \"/usr/bin/puppet\",\n    \"/bin/puppet\", \"/opt/puppetlabs/puppet/bin/puppet\", \"/usr/bin/chef-client\", \"/bin/chef-client\",\n    \"/bin/autossl_check\", \"/usr/bin/autossl_check\", \"/proc/self/exe\", \"/dev/fd/*\",  \"/usr/bin/pamac-daemon\",\n    \"/bin/pamac-daemon\", \"/usr/lib/snapd/snapd\", \"/usr/local/bin/dockerd\", \"/usr/libexec/netplan/generate\",\n    \"/lib/systemd/system-generators/netplan\", \"/lib/systemd/systemd\", \"/usr/bin/containerd\", \"/usr/sbin/sshd\",\n    \"/kaniko/executor\"\n  ) or\n  file.Ext.original.extension == \"dpkg-new\" or\n  process.executable : (\n    \"/nix/store/*\", \"/var/lib/dpkg/*\", \"/snap/*\", \"/dev/fd/*\", \"/usr/lib/*\", \"/usr/libexec/*\"\n  ) or\n  process.name in (\"systemd\", \"netplan\", \"apt-get\", \"vmware-config-tools.pl\", \"systemd-hwdb\") or\n  (process.name == \"sed\" and file.name : \"sed*\") or\n  (process.name == \"perl\" and file.name : \"e2scrub_all.tmp*\") \n)",
        "language": "eql",
        "index": [
          "logs-endpoint.events.file*"
        ],
        "filters": []
      },
      {
        "name": "Yum Package Manager Plugin File Creation",
        "description": "Detects file creation events in the plugin directories for the Yum package manager. In Linux, Yum (Yellowdog Updater, Modified) is a command-line utility used for handling packages on (by default) Fedora-based systems, providing functions for installing, updating, upgrading, and removing software along with managing package repositories. Attackers can backdoor Yum to gain persistence by injecting malicious code into plugins that Yum runs, thereby ensuring continued unauthorized access or control each time Yum is used for package management.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 4,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/rapid7/metasploit-framework/blob/master/modules/exploits/linux/local/yum_package_manager_persistence.rb",
          "https://www.elastic.co/security-labs/sequel-on-persistence-mechanisms"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1543",
                "name": "Create or Modify System Process",
                "reference": "https://attack.mitre.org/techniques/T1543/"
              },
              {
                "id": "T1546",
                "name": "Event Triggered Execution",
                "reference": "https://attack.mitre.org/techniques/T1546/",
                "subtechnique": [
                  {
                    "id": "T1546.016",
                    "name": "Installer Packages",
                    "reference": "https://attack.mitre.org/techniques/T1546/016/"
                  }
                ]
              },
              {
                "id": "T1574",
                "name": "Hijack Execution Flow",
                "reference": "https://attack.mitre.org/techniques/T1574/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            }
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.Ext.original.name",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "909c994d-0105-4b2e-988b-9db3a51f649e",
        "rule_id": "0b15bcad-aff1-4250-a5be-5d1b7eb56d07",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:35.419Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:23.645Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"linux\" and event.action in (\"rename\", \"creation\") and\nfile.path : (\"/usr/lib/yum-plugins/*\", \"/etc/yum/pluginconf.d/*\") and not (\n  process.executable in (\n    \"/bin/dockerd\", \"/usr/bin/dockerd\", \"/usr/sbin/dockerd\", \"/bin/microdnf\", \"/usr/bin/microdnf\", \"/bin/rpm\",\n    \"/usr/bin/rpm\", \"/bin/snapd\", \"/usr/bin/snapd\", \"/bin/yum\", \"/usr/bin/yum\", \"/bin/dnf\", \"/usr/bin/dnf\",\n    \"/bin/podman\", \"/usr/bin/podman\", \"/bin/dnf-automatic\", \"/usr/bin/dnf-automatic\", \"/sbin/apk\", \"/usr/sbin/apk\",\n    \"/usr/local/sbin/apk\", \"/bin/podman\", \"/usr/bin/podman\", \"/usr/bin/puppet\", \"/bin/puppet\",\n    \"/opt/puppetlabs/puppet/bin/puppet\", \"/usr/bin/chef-client\", \"/bin/chef-client\", \"/bin/autossl_check\",\n    \"/usr/bin/autossl_check\", \"/proc/self/exe\", \"/dev/fd/*\", \"/usr/lib/snapd/snapd\", \"/usr/local/bin/dockerd\",\n    \"/usr/libexec/netplan/generate\"\n  ) or\n  process.name == \"yumBackend.py\" or\n  file.extension in (\"swp\", \"swpx\", \"swx\") or\n  file.Ext.original.name like \".ansible*\" or\n  file.name like \".ansible_tmp*\" or\n  process.executable : (\n    \"/nix/store/*\", \"/var/lib/dpkg/*\", \"/tmp/vmis.*\", \"/snap/*\", \"/dev/fd/*\", \"/usr/lib/*\", \"/usr/libexec/*\",\n    \"/etc/kernel/*\"\n  ) or\n  process.executable == null or\n  (process.name == \"sed\" and file.name : \"sed*\") or\n  (process.name == \"perl\" and file.name : \"e2scrub_all.tmp*\") \n)",
        "language": "eql",
        "index": [
          "logs-endpoint.events.file*"
        ],
        "filters": []
      },
      {
        "name": "Attempt to Establish VScode Remote Tunnel",
        "description": "Detects the execution of the VScode portable binary with the tunnel command line option indicating an attempt to establish a remote tunnel session to Github or a remote VScode instance.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 104,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Command and Control",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: System",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://badoption.eu/blog/2023/01/31/code_c2.html",
          "https://code.visualstudio.com/docs/remote/tunnels"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            },
            "technique": [
              {
                "id": "T1219",
                "name": "Remote Access Software",
                "reference": "https://attack.mitre.org/techniques/T1219/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "d5d3e5a8-0f79-4487-8fad-773143ee8e80",
        "rule_id": "0b96dfd8-5b8c-4485-9a1c-69ff7839786a",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:35.422Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:23.664Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.args : \"tunnel\" and (process.args : \"--accept-server-license-terms\" or process.name : \"code*.exe\") and \n  not (process.name == \"code-tunnel.exe\" and process.args == \"status\" and process.parent.name == \"Code.exe\")",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "winlogbeat-*",
          "logs-windows.sysmon_operational-*",
          "logs-system.security*",
          "endgame-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-m365_defender.event-*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Unusual Network Activity from a Windows System Binary",
        "description": "Identifies network activity from unexpected system applications. This may indicate adversarial activity as these applications are often leveraged by adversaries to execute code and evade detection.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Unusual Network Activity from a Windows System Binary\n\nAttackers can abuse certain trusted developer utilities to proxy the execution of malicious payloads. Since these utilities are usually signed, they can bypass the security controls that were put in place to prevent or detect direct execution.\n\nThis rule identifies network connections established by trusted developer utilities, which can indicate abuse to execute payloads or process masquerading.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate abnormal behaviors observed by the subject process, such as registry or file modifications, and any spawned child processes.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the process executable using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n\n### False positive analysis\n\n- As trusted developer utilities have dual-use purposes, alerts derived from this rule are not essentially malicious. If these utilities are contacting internal or known trusted domains, review their security and consider creating exceptions if the domain is safe.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n  - If the malicious file was delivered via phishing:\n    - Block the email sender from sending future emails.\n    - Block the malicious web pages.\n    - Remove emails from the sender from mailboxes.\n    - Consider improvements to the security awareness program.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 213,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1036",
                "name": "Masquerading",
                "reference": "https://attack.mitre.org/techniques/T1036/",
                "subtechnique": [
                  {
                    "id": "T1036.005",
                    "name": "Match Legitimate Name or Location",
                    "reference": "https://attack.mitre.org/techniques/T1036/005/"
                  }
                ]
              },
              {
                "id": "T1127",
                "name": "Trusted Developer Utilities Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1127/",
                "subtechnique": [
                  {
                    "id": "T1127.001",
                    "name": "MSBuild",
                    "reference": "https://attack.mitre.org/techniques/T1127/001/"
                  },
                  {
                    "id": "T1218.005",
                    "name": "Mshta",
                    "reference": "https://attack.mitre.org/techniques/T1218/005/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "dns.question.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "51af498a-b22b-43b1-b727-49d6345733b4",
        "rule_id": "1fe3b299-fbb5-4657-a937-1d746f2c711a",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:35.425Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:25.876Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by process.entity_id with maxspan=5m\n  [process where host.os.type == \"windows\" and event.type == \"start\" and\n\n     /* known applocker bypasses */\n     (process.name : \"bginfo.exe\" or\n      process.name : \"cdb.exe\" or\n      process.name : \"control.exe\" or\n      process.name : \"cmstp.exe\" or\n      process.name : \"csi.exe\" or\n      process.name : \"dnx.exe\" or\n      process.name : \"fsi.exe\" or\n      process.name : \"ieexec.exe\" or\n      process.name : \"iexpress.exe\" or\n      process.name : \"installutil.exe\" or\n      process.name : \"Microsoft.Workflow.Compiler.exe\" or\n      process.name : \"MSBuild.exe\" or\n      process.name : \"msdt.exe\" or\n      process.name : \"mshta.exe\" or\n      process.name : \"msiexec.exe\" or\n      process.name : \"msxsl.exe\" or\n      process.name : \"odbcconf.exe\" or\n      process.name : \"rcsi.exe\" or\n      process.name : \"regsvr32.exe\" or\n      process.name : \"xwizard.exe\")]\n  [network where\n     (process.name : \"bginfo.exe\" or\n      process.name : \"cdb.exe\" or\n      process.name : \"control.exe\" or\n      process.name : \"cmstp.exe\" or\n      process.name : \"csi.exe\" or\n      process.name : \"dnx.exe\" or\n      process.name : \"fsi.exe\" or\n      process.name : \"ieexec.exe\" or\n      process.name : \"iexpress.exe\" or\n      process.name : \"installutil.exe\" or\n      process.name : \"Microsoft.Workflow.Compiler.exe\" or\n      (\n        process.name : \"msbuild.exe\" and\n          destination.ip != \"127.0.0.1\"\n      ) or\n      process.name : \"msdt.exe\" or\n      process.name : \"mshta.exe\" or\n      (\n        process.name : \"msiexec.exe\" and not\n        dns.question.name : (\n           \"ocsp.digicert.com\", \"ocsp.verisign.com\", \"ocsp.comodoca.com\", \"ocsp.entrust.net\", \"ocsp.usertrust.com\",\n           \"ocsp.godaddy.com\", \"ocsp.camerfirma.com\", \"ocsp.globalsign.com\", \"ocsp.sectigo.com\", \"*.local\"\n        ) and\n        /* Localhost, DigiCert and Comodo CA IP addresses */\n        not cidrmatch(destination.ip, \"127.0.0.1\", \"192.229.211.108/32\", \"192.229.221.95/32\",\n                      \"152.195.38.76/32\", \"104.18.14.101/32\")\n      ) or\n      process.name : \"msxsl.exe\" or\n      process.name : \"odbcconf.exe\" or\n      process.name : \"rcsi.exe\" or\n      process.name : \"regsvr32.exe\" or\n      process.name : \"xwizard.exe\") and \n      \n      not dns.question.name : (\"localhost\", \"setup.officetimeline.com\", \"us.deployment.endpoint.ingress.rapid7.com\", \n        \"ctldl.windowsupdate.com\", \"crl?.digicert.com\", \"ocsp.digicert.com\", \"addon-cms-asl.eu.goskope.com\", \"crls.ssl.com\", \n        \"evcs-ocsp.ws.symantec.com\", \"s.symcd.com\", \"s?.symcb.com\", \"crl.verisign.com\", \"oneocsp.microsoft.com\", \"crl.verisign.com\", \n        \"aka.ms\", \"crl.comodoca.com\", \"acroipm2.adobe.com\", \"sv.symcd.com\") and \n\n      /* host query itself */\n      not startswith~(dns.question.name, host.name)\n      ]",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "logs-endpoint.events.network-*",
          "winlogbeat-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "Potential Foxmail Exploitation",
        "description": "Identifies the Foxmail client spawning a child process with argument pointing to the Foxmail temp directory. This may indicate the successful exploitation of a Foxmail vulnerability for initial access and execution via a malicious email.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 202,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Initial Access",
          "Tactic: Execution",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: System",
          "Data Source: Elastic Endgame",
          "Data Source: SentinelOne",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://mp.weixin.qq.com/s/F8hNyESBdKhwXkQPgtGpew"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1203",
                "name": "Exploitation for Client Execution",
                "reference": "https://attack.mitre.org/techniques/T1203/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1189",
                "name": "Drive-by Compromise",
                "reference": "https://attack.mitre.org/techniques/T1189/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "c0a99587-33a3-4740-837e-6283b8a21a9d",
        "rule_id": "2c6a6acf-0dcb-404d-89fb-6b0327294cfa",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:35.427Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:26.653Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and \n process.parent.name : \"Foxmail.exe\" and process.args : (\"?:\\\\Users\\\\*\\\\AppData\\\\*\", \"\\\\\\\\*\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-windows.*",
          "endgame-*",
          "logs-system.security*",
          "logs-windows.sysmon_operational-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-m365_defender.event-*",
          "logs-endpoint.events.process-*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious PowerShell Execution via Windows Scripts",
        "description": "Identifies suspicious PowerShell execution spawning from Windows Script Host processes (cscript or wscript.exe).",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 201,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Data Source: System",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Microsoft Defender for Endpoint"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  },
                  {
                    "id": "T1059.005",
                    "name": "Visual Basic",
                    "reference": "https://attack.mitre.org/techniques/T1059/005/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args_count",
            "type": "long",
            "ecs": true
          },
          {
            "name": "process.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "92084d70-76a0-407b-953b-9085684ed472",
        "rule_id": "2d62889e-e758-4c5e-b57e-c735914ee32a",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:35.436Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:28.160Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.action == \"start\" and\n  process.name : (\"powershell.exe\", \"pwsh.exe\") and\n  process.parent.name : (\"wscript.exe\", \"cscript.exe\", \"mshta.exe\") and\n   (\n   process.args_count == 1 or\n   process.command_line :\n             (\"*^*^*^*^*^*^*^*^*^*\",\n              \"*''*''*''*\",\n              \"*`*`*`*`*\",\n              \"*{*{*{*{*{*{*{*{*{*{*{*{*{*{*{*{*{*{*{*\",\n              \"*+*+*+*+*+*\",\n              \"*$*$*$*$*\",\n              \"*[char[]](*)*-join\",\n              \"*Base64String*\",\n              \"*[*Convert]*\",\n              \"*.Text.Encoding*\",\n              \"*.Compression.*\",\n              \"*.replace(*\",\n              \"*MemoryStream*\",\n              \"*WriteAllBytes*\",\n              \"* -en* *\",\n              \"* -ec *\",\n              \"* -e *\",\n              \"* -ep *\",\n              \"* /e *\",\n              \"* /en* *\",\n              \"* /ec *\",\n              \"* /ep *\",\n              \"*WebClient*\",\n              \"*DownloadFile*\",\n              \"*DownloadString*\",\n              \"*BitsTransfer*\",\n              \"*Invoke-Exp*\",\n              \"*invoke-web*\",\n              \"*iex*\",\n              \"*iwr*\",\n              \"*Reflection.Assembly*\",\n              \"*Assembly.GetType*\",\n              \"*.Sockets.*\",\n              \"*Add-MpPreference*ExclusionPath*\",\n              \"*raw.githubusercontent*\")\n   ) and\n\n   /* many legit powershell commands uses those non shortened execution flags excluding Sync-AppvPublishingServer lolbas */\n   not (process.args : (\"-EncodedCommand\", \"Import-Module*\", \"-NonInteractive\") and\n        process.args : \"-ExecutionPolicy\" and not process.args : \"Sync-AppvPublishingServer\") and\n\n   /* third party installation related FPs */\n   not ?process.parent.args : \"?:\\\\Windows\\\\system32\\\\gatherNetworkInfo.vbs\" and\n   not (?process.parent.args : \"Microsoft.SystemCenter.ICMPProbe.WithConsecutiveSamples.vbs\" and process.args : \"Get-SCOMAgent\") and\n   not (process.command_line : \"*WEBLOGIC_ARGS_CURRENT_1.DATA*\" and ?process.parent.command_line : \"*Impact360*\") and\n   not process.args :  \"$package = Get-AppxPackage Microsoft.Office.Desktop -allUsers;*\" and\n   not process.command_line : (\"*.Access.IdentityReference*win32_SID.SID*\", \"*AGIAbQB4AC0AYQBwAC4AcwAzAC4AdQBzAC0AZQBhAHMAd*\") and\n   not (?process.parent.args : \"?:\\\\Users\\\\Prestige\\\\AppData\\\\Local\\\\Temp\\\\Rar$*\\\\KMS_VL_ALL_AIO.cmd  -elevated\" and process.command_line : \"*KMS_VL_ALL_AIO.cmd*\") and\n   not process.args : \"iwr https://*.s3.us-east-1.amazonaws.com/scripts/Start-SpeedTest.ps1 -UserAgent * -UseBasicParsing | invoke-expression\" and\n   not (process.parent.name : \"wscript.exe\" and\n        ?process.parent.args : \"C:\\\\Program Files (x86)\\\\Telivy\\\\Telivy Agent\\\\telivy.js\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-windows.*",
          "logs-system.security*",
          "logs-windows.sysmon_operational-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-m365_defender.event-*"
        ],
        "filters": []
      },
      {
        "name": "Root Certificate Installation",
        "description": "This rule detects the installation of root certificates on a Linux system. Adversaries may install a root certificate on a compromised system to avoid warnings when connecting to their command and control servers. Root certificates are used in public key cryptography to identify a root certificate authority (CA). When a root certificate is installed, the system or application will trust certificates in the root's chain of trust that have been signed by the root certificate.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 2,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1553.004/T1553.004.md"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1553",
                "name": "Subvert Trust Controls",
                "reference": "https://attack.mitre.org/techniques/T1553/",
                "subtechnique": [
                  {
                    "id": "T1553.004",
                    "name": "Install Root Certificate",
                    "reference": "https://attack.mitre.org/techniques/T1553/004/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "60dae6ec-dbe5-465f-a98b-dabfb68d3b7d",
        "rule_id": "6ded0996-7d4b-40f2-bf4a-6913e7591795",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:35.439Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:35.418Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\nprocess.name in (\"update-ca-trust\", \"update-ca-certificates\") and not (\n  process.parent.name like (\n    \"ca-certificates.postinst\", \"ca-certificates-*.trigger\", \"pacman\", \"pamac-daemon\", \"autofirma.postinst\",\n    \"ipa-client-install\", \"su\", \"platform-python\", \"python*\", \"kesl\", \"execd\"\n  ) or\n  process.parent.args like \"/var/tmp/rpm*\" or\n  (process.parent.name in (\"sh\", \"bash\", \"zsh\") and process.args == \"-e\")\n)",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious Windows Powershell Arguments",
        "description": "Identifies the execution of PowerShell with suspicious argument values. This behavior is often observed during malware installation leveraging PowerShell.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 202,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Data Source: System",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "b23e2d33-e4fd-45ae-80e3-8f5b7c40ebd8",
        "rule_id": "83bf249e-4348-47ba-9741-1202a09556ad",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:35.441Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:37.297Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n process.name : \"powershell.exe\" and \n  (\n   process.command_line :\n        (\n          \"*^*^*^*^*^*^*^*^*^*\",\n          \"*`*`*`*`*\",\n          \"*+*+*+*+*+*+*\",\n          \"*[char[]](*)*-join*\",\n          \"*Base64String*\",\n          \"*[*Convert]*\",\n          \"*.Compression.*\",\n          \"*-join($*\",\n          \"*.replace*\",\n          \"*MemoryStream*\",\n          \"*WriteAllBytes*\",\n          \"* -enc *\",\n          \"* -ec *\",\n          \"* /e *\",\n          \"* /enc *\",\n          \"* /ec *\",\n          \"*WebClient*\",\n          \"*DownloadFile*\",\n          \"*DownloadString*\",\n          \"* iex*\",\n          \"* iwr*\",\n          \"*Reflection.Assembly*\",\n          \"*Assembly.GetType*\",\n          \"*$env:temp\\\\*start*\",\n          \"*powercat*\",\n          \"*nslookup -q=txt*\",\n          \"*$host.UI.PromptForCredential*\",\n          \"*Net.Sockets.TCPClient*\",\n          \"*curl *;Start*\",\n          \"powershell.exe \\\"<#*\",\n          \"*ssh -p *\",\n          \"*http*|iex*\",\n          \"*@SSL\\\\DavWWWRoot\\\\*.ps1*\",\n          \"*.lnk*.Seek(0x*\",\n          \"*[string]::join(*\",\n          \"*[Array]::Reverse($*\",\n          \"* hidden $(gc *\",\n          \"*=wscri& set*\",\n          \"*http'+'s://*\",\n          \"*.content|i''Ex*\",\n          \"*//:sptth*\",\n          \"*//:ptth*\",\n          \"*$*=Get-Content*AppData*.SubString(*$*\",\n          \"*=cat *AppData*.substring(*);*$*\"\n        ) or\n\n      (process.args : \"-c\" and process.args : \"&{'*\") or\n\n      (process.args : \"-Outfile\" and process.args : \"Start*\") or\n\n      (process.args : \"-bxor\" and process.args : \"0x*\") or\n\n      process.args : \"$*$*;set-alias\" or\n\n      (process.parent.name : (\"explorer.exe\", \"cmd.exe\") and \n       process.command_line : (\"*-encodedCommand*\", \"*Invoke-webrequest*\", \"*WebClient*\", \"*Reflection.Assembly*\"))\n  )",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-windows.*",
          "logs-system.security*",
          "logs-windows.sysmon_operational-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-m365_defender.event-*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "WPS Office Exploitation via DLL Hijack",
        "description": "Identifies the load of a remote library by the WPS Office promecefpluginhost.exe executable. This may indicate the successful exploitation of CVE-2024-7262 or CVE-2024-7263 via DLL hijack abusing the ksoqing custom protocol handler.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 101,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Initial Access",
          "Tactic: Execution",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.welivesecurity.com/en/eset-research/analysis-of-two-arbitrary-code-execution-vulnerabilities-affecting-wps-office/",
          "https://mp.weixin.qq.com/s/F8hNyESBdKhwXkQPgtGpew"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1203",
                "name": "Exploitation for Client Execution",
                "reference": "https://attack.mitre.org/techniques/T1203/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1189",
                "name": "Drive-by Compromise",
                "reference": "https://attack.mitre.org/techniques/T1189/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "dll.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "fc761683-5056-4a4a-9517-81f93b45177f",
        "rule_id": "ac6bc744-e82b-41ad-b58d-90654fa4ebfb",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:35.444Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:42.845Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "any where host.os.type == \"windows\" and process.name : \"promecefpluginhost.exe\" and \n(\n (event.category == \"library\" and \n  ?dll.path : \n     (\"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\wps\\\\INetCache\\\\*\", \n      \"\\\\Device\\\\Mup\\\\**\", \"\\\\\\\\*\")) or \n\n  ((event.category == \"process\" and event.action : \"Image loaded*\") and \n  ?file.path : \n     (\"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\wps\\\\INetCache\\\\*\", \n      \"\\\\Device\\\\Mup\\\\**\", \"\\\\\\\\*\"))\n)",
        "language": "eql",
        "index": [
          "logs-endpoint.events.library-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "MsiExec Service Child Process With Network Connection",
        "description": "Identifies the execution of an MsiExec service child process followed by network or dns lookup activity. Adversaries may abuse Windows Installers for initial access and delivery of malware.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 201,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: SentinelOne"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1218",
                "name": "System Binary Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1218/",
                "subtechnique": [
                  {
                    "id": "T1218.007",
                    "name": "Msiexec",
                    "reference": "https://attack.mitre.org/techniques/T1218/007/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "6cad10c6-fee9-4626-9db8-d866a411a2c5",
        "rule_id": "65432f4a-e716-4cc1-ab11-931c4966da2d",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:35.446Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:35.202Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by process.entity_id with maxspan=1m\n [process where host.os.type == \"windows\" and event.type : \"start\" and\n  process.parent.name : \"msiexec.exe\" and process.parent.args : \"/v\" and\n  not process.executable :\n        (\"?:\\\\Windows\\\\System32\\\\msiexec.exe\",\n         \"?:\\\\Windows\\\\sysWOW64\\\\msiexec.exe\",\n         \"?:\\\\Windows\\\\system32\\\\srtasks.exe\",\n         \"?:\\\\Windows\\\\syswow64\\\\srtasks.exe\",\n         \"?:\\\\Windows\\\\sys*\\\\taskkill.exe\",\n         \"?:\\\\Program Files\\\\*.exe\",\n         \"?:\\\\Program Files (x86)\\\\*.exe\",\n         \"?:\\\\Windows\\\\Installer\\\\MSI*.tmp\",\n         \"?:\\\\Windows\\\\Microsoft.NET\\\\Framework*\\\\RegSvcs.exe\") and\n not (process.name : (\"rundll32.exe\", \"regsvr32.exe\") and process.args : (\"?:\\\\Program Files\\\\*\", \"?:\\\\Program Files (x86)\\\\*\"))]\n[any where host.os.type == \"windows\" and event.category in (\"network\", \"dns\") and process.name != null]",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "logs-endpoint.events.network-*",
          "logs-windows.sysmon_operational-*",
          "logs-sentinel_one_cloud_funnel.*"
        ],
        "filters": []
      },
      {
        "name": "Execution via Windows Command Debugging Utility",
        "description": "An adversary can use the Windows command line debugging utility cdb.exe to execute commands or shellcode. This rule looks for those instances and where the cdb.exe binary is outside of the normal WindowsKit installation paths.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 102,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://lolbas-project.github.io/lolbas/OtherMSBinaries/Cdb/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1218",
                "name": "System Binary Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1218/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "9a9994c4-3506-4da4-bc35-d016cd913edd",
        "rule_id": "bdfaddc4-4438-48b4-bc43-9f5cf8151c46",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:35.449Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:44.954Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n (?process.pe.original_file_name == \"CDB.Exe\" or process.name : \"cdb.exe\") and\n  process.args : (\"-cf\", \"-c\", \"-pd\") and\n  not process.executable : (\n        \"?:\\\\Program Files (x86)\\\\*\\\\cdb.exe\",\n        \"?:\\\\Program Files\\\\*\\\\cdb.exe\",\n        \"\\\\Device\\\\HarddiskVolume?\\\\Program Files (x86)\\\\*\\\\cdb.exe\",\n        \"\\\\Device\\\\HarddiskVolume?\\\\Program Files\\\\*\\\\cdb.exe\"\n  )",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-m365_defender.event-*",
          "logs-system.security-*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "AWS SSM `SendCommand` with Run Shell Command Parameters",
        "description": "Identifies the use of the AWS Systems Manager (SSM) `SendCommand` API with the either `AWS-RunShellScript` or `AWS-RunPowerShellScript` parameters. The `SendCommand` API call allows users to execute commands on EC2 instances using the SSM service. Adversaries may use this technique to execute commands on EC2 instances without the need for SSH or RDP access. This behavior may indicate an adversary attempting to execute commands on an EC2 instance for malicious purposes. This is a [New Terms](https://www.elastic.co/guide/en/security/current/rules-ui-create.html#create-new-terms-rule) rule that only flags when this behavior is observed for the first time on a host in the last 7 days.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "investigation_fields": {
          "field_names": [
            "@timestamp",
            "process.user.name",
            "process.entry_leader.group.name",
            "process.entry_leader.real_user.name",
            "event.action",
            "event.type",
            "host.os.type",
            "host.os.kernel",
            "process.entry_leader.executable",
            "process.entry_leader.working_directory",
            "process.parent.executable",
            "process.executable",
            "process.hash.sha256",
            "process.parent.command_line",
            "process.command_line",
            "process.args"
          ]
        },
        "version": 3,
        "tags": [
          "Domain: Endpoint",
          "Domain: Cloud",
          "OS: Linux",
          "OS: macOS",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame",
          "Data Source: Auditd Manager"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Legitimate use of the `SendCommand` API call to execute commands on EC2 instances using the SSM service may be done by system administrators or DevOps engineers for legitimate purposes."
        ],
        "references": [
          "https://cloud.hacktricks.xyz/pentesting-cloud/aws-security/aws-privilege-escalation/aws-ssm-privesc",
          "https://securitycafe.ro/2023/01/17/aws-post-explitation-with-ssm-sendcommand/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1651",
                "name": "Cloud Administration Command",
                "reference": "https://attack.mitre.org/techniques/T1651/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "auditd_manager",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "cdbc2ae5-b2d2-47bc-9a64-53764cf035dc",
        "rule_id": "c371e9fc-6a10-11ef-a0ac-f661ea17fbcc",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:35.452Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:45.039Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "event.category: \"process\" and event.type: \"start\" and process.name: \"aws\"\nand (\n    host.os.type: (\"windows\" or \"macos\")\n    or (\n        host.os.type: \"linux\"\n        and event.action: (\"exec\" or \"exec_event\" or \"executed\" or \"process_started\")\n    )\n)\nand process.args: (\n    \"send-command\" and \"--parameters\" and commands=*\n    and (\"AWS-RunShellScript\" or \"AWS-RunPowerShellScript\")\n)",
        "new_terms_fields": [
          "host.id"
        ],
        "history_window_start": "now-7d",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*",
          "auditbeat-*",
          "logs-auditd_manager.auditd-*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Script Execution via Microsoft HTML Application",
        "description": "Identifies the execution of scripts via HTML applications using Windows utilities rundll32.exe or mshta.exe. Adversaries may bypass process and/or signature-based defenses by proxying execution of malicious content with signed binaries.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 201,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: System",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Microsoft Defender for Endpoint"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1218",
                "name": "System Binary Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1218/",
                "subtechnique": [
                  {
                    "id": "T1218.005",
                    "name": "Mshta",
                    "reference": "https://attack.mitre.org/techniques/T1218/005/"
                  },
                  {
                    "id": "T1218.011",
                    "name": "Rundll32",
                    "reference": "https://attack.mitre.org/techniques/T1218/011/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args_count",
            "type": "long",
            "ecs": true
          },
          {
            "name": "process.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "ebb07804-ece3-4852-a1b9-52583501e391",
        "rule_id": "181f6b23-3799-445e-9589-0018328a9e46",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:35.455Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:24.416Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n process.name : (\"rundll32.exe\", \"mshta.exe\") and\n  (\n     (process.command_line :\n        (\n        \"*script*eval(*\",\n         \"*script*GetObject*\",\n         \"*.regread(*\",\n         \"*WScript.Shell*\",\n         \"*.run(*\",\n         \"*).Exec()*\",\n         \"*mshta*http*\",\n         \"*mshtml*RunHTMLApplication*\",\n         \"*mshtml*,#135*\",\n         \"*StrReverse*\",\n         \"*.RegWrite*\",\n         /* Issue #379 */\n         \"*window.close(*\",\n         \"* Chr(*\"\n         )\n     and not process.parent.executable :\n                  (\"?:\\\\Program Files (x86)\\\\Citrix\\\\System32\\\\wfshell.exe\",\n                   \"?:\\\\Program Files (x86)\\\\Microsoft Office\\\\Office*\\\\MSACCESS.EXE\",\n                   \"?:\\\\Program Files\\\\Quokka.Works GTInstaller\\\\GTInstaller.exe\")\n     ) or\n\n    (process.name : \"mshta.exe\" and\n     not process.command_line : (\"*.hta*\", \"*.htm*\", \"-Embedding\") and process.args_count >=2) or\n\n     /* Execution of HTA file downloaded from the internet */\n     (process.name : \"mshta.exe\" and process.command_line : \"*\\\\Users\\\\*\\\\Downloads\\\\*.hta*\") or\n\n     /* Execution of HTA file from archive */\n     (process.name : \"mshta.exe\" and\n      process.args : (\"?:\\\\Users\\\\*\\\\Temp\\\\7z*\", \"?:\\\\Users\\\\*\\\\Temp\\\\Rar$*\", \"?:\\\\Users\\\\*\\\\Temp\\\\Temp?_*\", \"?:\\\\Users\\\\*\\\\Temp\\\\BNZ.*\"))\n   )",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-windows.*",
          "logs-system.security*",
          "logs-windows.sysmon_operational-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-m365_defender.event-*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious Windows Command Shell Arguments",
        "description": "Identifies the execution of the Windows Command Shell process (cmd.exe) with suspicious argument values. This behavior is often observed during malware installation.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 201,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Data Source: System",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Microsoft Defender for Endpoint"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.003",
                    "name": "Windows Command Shell",
                    "reference": "https://attack.mitre.org/techniques/T1059/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "5434a748-240e-44a5-9345-14c68179dc34",
        "rule_id": "d9ffc3d6-9de9-4b29-9395-5757d0695ecf",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:35.458Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:47.282Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n process.name : \"cmd.exe\" and \n (\n\n  process.command_line : (\"*).Run(*\", \"*GetObject*\", \"* curl*regsvr32*\", \"*echo*wscript*\", \"*echo*ZONE.identifier*\",\n  \"*ActiveXObject*\", \"*dir /s /b *echo*\", \"*unescape(*\",  \"*findstr*TVNDRgAAAA*\", \"*findstr*passw*\", \"*start*\\\\\\\\*\\\\DavWWWRoot\\\\*\",\n  \"* explorer*%CD%*\", \"*%cd%\\\\*.js*\", \"*attrib*%CD%*\", \"*/?cMD<*\", \"*/AutoIt3ExecuteScript*..*\", \"*&cls&cls&cls&cls&cls&*\",\n  \"*&#*;&#*;&#*;&#*;*\", \"* &&s^eT*\", \"*& ChrW(*\", \"*&explorer /root*\", \"*start __ & __\\\\*\", \"*findstr /V /L *forfiles*\",\n  \"*=wscri& set *\", \"*http*!COmpUternaME!*\", \"*start *.pdf * start /min cmd.exe /c *\\\\\\\\*\", \"*pip install*System.Net.WebClient*\",\n  \"*Invoke-WebReques*Start-Process*\", \"*-command (Invoke-webrequest*\", \"*copy /b *\\\\\\\\* ping *-n*\", \"*echo*.ToCharArray*\") or\n\n  (process.args : \"echo\" and process.parent.name : (\"wscript.exe\", \"mshta.exe\")) or\n\n  process.args : (\"1>?:\\\\*.vbs\", \"1>?:\\\\*.js\") or\n\n  (process.args : \"explorer.exe\" and process.args : \"type\" and process.args : \">\" and process.args : \"start\") or\n\n  (process.parent.name : \"explorer.exe\" and\n   process.command_line :\n           (\"*&&S^eT *\",\n            \"*&& set *&& set *&& set *&& set *&& set *&& call*\",\n            \"**\\\\u00??\\\\u00??\\\\u00??\\\\u00??\\\\u00??\\\\u00??\\\\u00??\\\\u00??*\")) or\n\n   (process.parent.name : \"explorer.exe\" and process.args : \"copy\" and process.args : \"&&\" and process.args : \"\\\\\\\\*@*\\\\*\")\n  ) and\n\n  /* false positives */\n  not (process.args : \"%TEMP%\\\\Spiceworks\\\\*\" and process.parent.name : \"wmiprvse.exe\") and\n  not process.parent.executable :\n                (\"?:\\\\Perl64\\\\bin\\\\perl.exe\",\n                 \"?:\\\\Program Files\\\\nodejs\\\\node.exe\",\n                 \"?:\\\\Program Files\\\\HP\\\\RS\\\\pgsql\\\\bin\\\\pg_dumpall.exe\",\n                 \"?:\\\\Program Files (x86)\\\\PRTG Network Monitor\\\\64 bit\\\\PRTG Server.exe\",\n                 \"?:\\\\Program Files (x86)\\\\Spiceworks\\\\bin\\\\spiceworks-finder.exe\",\n                 \"?:\\\\Program Files (x86)\\\\Zuercher Suite\\\\production\\\\leds\\\\leds.exe\",\n                 \"?:\\\\Program Files\\\\Tripwire\\\\Agent\\\\Plugins\\\\twexec\\\\twexec.exe\",\n                 \"D:\\\\Agents\\\\?\\\\_work\\\\_tasks\\\\*\\\\SonarScanner.MSBuild.exe\",\n                 \"?:\\\\Program Files\\\\Microsoft VS Code\\\\Code.exe\",\n                 \"?:\\\\programmiweb\\\\NetBeans-*\\\\netbeans\\\\bin\\\\netbeans64.exe\",\n                 \"?:\\\\Program Files (x86)\\\\Public Safety Suite Professional\\\\production\\\\leds\\\\leds.exe\",\n                 \"?:\\\\Program Files (x86)\\\\Tier2Tickets\\\\button_gui.exe\",\n                 \"?:\\\\Program Files\\\\NetBeans-*\\\\netbeans\\\\bin\\\\netbeans*.exe\",\n                 \"?:\\\\Program Files (x86)\\\\Public Safety Suite Professional\\\\production\\\\leds\\\\leds.exe\",\n                 \"?:\\\\Program Files (x86)\\\\Tier2Tickets\\\\button_gui.exe\",\n                 \"?:\\\\Program Files (x86)\\\\Helpdesk Button\\\\button_gui.exe\",\n                 \"?:\\\\VTSPortable\\\\VTS\\\\jre\\\\bin\\\\javaw.exe\",\n                 \"?:\\\\Program Files\\\\Bot Framework Composer\\\\Bot Framework Composer.exe\",\n                 \"?:\\\\Program Files\\\\KMSYS Worldwide\\\\eQuate\\\\*\\\\SessionMgr.exe\",\n                 \"?:\\\\Program Files (x86)\\\\Craneware\\\\Pricing Analyzer\\\\Craneware.Pricing.Shell.exe\",\n                 \"?:\\\\Program Files (x86)\\\\jumpcloud-agent-app\\\\jumpcloud-agent-app.exe\",\n                 \"?:\\\\Program Files\\\\PostgreSQL\\\\*\\\\bin\\\\pg_dumpall.exe\",\n                 \"?:\\\\Program Files (x86)\\\\Vim\\\\vim*\\\\vimrun.exe\") and\n  not (process.args :  \"?:\\\\Program Files\\\\Citrix\\\\Secure Access Client\\\\nsauto.exe\" and process.parent.name : \"userinit.exe\") and\n  not process.args :\n            (\"?:\\\\Program Files (x86)\\\\PCMatic\\\\PCPitstopScheduleService.exe\",\n             \"?:\\\\Program Files (x86)\\\\AllesTechnologyAgent\\\\*\",\n             \"https://auth.axis.com/oauth2/oauth-authorize*\") and\n  not process.command_line :\n               (\"\\\"cmd\\\" /c %NETBEANS_MAVEN_COMMAND_LINE%\",\n                \"?:\\\\Windows\\\\system32\\\\cmd.exe /q /d /s /c \\\"npm.cmd ^\\\"install^\\\" ^\\\"--no-bin-links^\\\" ^\\\"--production^\\\"\\\"\") and\n  not (process.name : \"cmd.exe\" and process.args : \"%TEMP%\\\\Spiceworks\\\\*\" and process.args : \"http*/dataloader/persist_netstat_data\") and \n  not (process.args == \"echo\" and process.args == \"GEQ\" and process.args == \"1073741824\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-windows.*",
          "logs-system.security*",
          "logs-windows.sysmon_operational-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-m365_defender.event-*"
        ],
        "filters": []
      },
      {
        "name": "Potential Escalation via Vulnerable MSI Repair",
        "description": "Identifies when a browser process navigates to the Microsoft Help page followed by spawning an elevated process. This may indicate a successful exploitation for privilege escalation abusing a vulnerable Windows Installer repair setup.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 202,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Microsoft Defender for Endpoint"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://sec-consult.com/blog/detail/msi-installer-repair-to-system-a-detailed-journey/",
          "https://msrc.microsoft.com/update-guide/en-US/advisory/CVE-2024-38014"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1068",
                "name": "Exploitation for Privilege Escalation",
                "reference": "https://attack.mitre.org/techniques/T1068/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1218",
                "name": "System Binary Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1218/",
                "subtechnique": [
                  {
                    "id": "T1218.007",
                    "name": "Msiexec",
                    "reference": "https://attack.mitre.org/techniques/T1218/007/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.domain",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "b9b7095e-f6c0-4015-9b34-866d919792f7",
        "rule_id": "043d80a3-c49e-43ef-9c72-1088f0c7b278",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:35.460Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:22.109Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where event.type == \"start\" and host.os.type == \"windows\" and\n user.domain : (\"NT AUTHORITY\", \"AUTORITE NT\", \"AUTORIDADE NT\") and\n process.parent.name : (\"chrome.exe\", \"msedge.exe\", \"brave.exe\", \"whale.exe\", \"browser.exe\", \"dragon.exe\", \"vivaldi.exe\",\n                        \"opera.exe\", \"iexplore\", \"firefox.exe\", \"waterfox.exe\", \"iexplore.exe\", \"tor.exe\", \"safari.exe\") and\n process.parent.command_line : \"*go.microsoft.com*\"",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "endgame-*",
          "logs-endpoint.events.process-*",
          "logs-windows.sysmon_operational-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-m365_defender.event-*"
        ],
        "filters": []
      },
      {
        "name": "Linux SSH X11 Forwarding",
        "description": "This rule monitors for X11 forwarding via SSH. X11 forwarding is a feature that allows users to run graphical applications on a remote server and display the application's graphical user interface on their local machine. Attackers can abuse X11 forwarding for tunneling their GUI-based tools, pivot through compromised systems, and create covert communication channels, enabling lateral movement and facilitating remote control of systems within a network.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Potential Linux SSH X11 Forwarding\n\nAttackers can leverage SSH X11 forwarding to capture a user's graphical desktop session and potentially execute unauthorized GUI applications remotely.\n\nThis rule looks for the execution of SSH in conjunction with command line arguments that are capable of setting up X11 forwarding. \n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n> This investigation guide uses [placeholder fields](https://www.elastic.co/guide/en/security/current/osquery-placeholder-fields.html) to dynamically pass alert data into Osquery queries. Placeholder fields were introduced in Elastic Stack version 8.7.0. If you're using Elastic Stack version 8.6.0 or earlier, you'll need to manually adjust this investigation guide's queries to ensure they properly run.\n\n#### Possible investigation steps\n\n- Identify any signs of suspicious network activity or anomalies that may indicate network forwarding activity. This could include unexpected traffic patterns or unusual network behavior.\n  - Investigate listening ports and open sockets to look for potential protocol tunneling, reverse shells, or data exfiltration.\n    - !{osquery{\"label\":\"Osquery - Retrieve Listening Ports\",\"query\":\"SELECT pid, address, port, socket, protocol, path FROM listening_ports\"}}\n    - !{osquery{\"label\":\"Osquery - Retrieve Open Sockets\",\"query\":\"SELECT pid, family, remote_address, remote_port, socket, state FROM process_open_sockets\"}}\n- Identify the user account that performed the action, analyze it, and check whether it should perform this kind of action.\n  - !{osquery{\"label\":\"Osquery - Retrieve Information for a Specific User\",\"query\":\"SELECT * FROM users WHERE username = {{user.name}}\"}}\n- Investigate whether the user is currently logged in and active.\n  - !{osquery{\"label\":\"Osquery - Investigate the Account Authentication Status\",\"query\":\"SELECT * FROM logged_in_users WHERE user = {{user.name}}\"}}\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence and whether they are located in expected locations.\n  - !{osquery{\"label\":\"Osquery - Retrieve Running Processes by User\",\"query\":\"SELECT pid, username, name FROM processes p JOIN users u ON u.uid = p.uid ORDER BY username\"}}\n  - !{osquery{\"label\":\"Osquery - Retrieve Process Info\",\"query\":\"SELECT name, cmdline, parent, path, uid FROM processes\"}}\n- Investigate other alerts associated with the user/host during the past 48 hours.\n  - If scripts or executables were dropped, retrieve the files and determine if they are malicious:\n    - Use a private sandboxed malware analysis system to perform analysis.\n      - Observe and collect information about the following activities:\n        - Attempts to contact external domains and addresses.\n          - Check if the domain is newly registered or unexpected.\n          - Check the reputation of the domain or IP address.\n        - File access, modification, and creation activities.\n\n### Related rules\n\n- Potential Linux Tunneling and/or Port Forwarding - 6ee947e9-de7e-4281-a55d-09289bdf947e\n\n### False positive analysis\n\n- If this activity is related to new benign software installation activity, consider adding exceptions — preferably with a combination of user and command line conditions.\n- If this activity is related to a system administrator or developer who uses port tunneling/forwarding for benign purposes, consider adding exceptions for specific user accounts or hosts. \n- Try to understand the context of the execution by thinking about the user, machine, or business purpose. A small number of endpoints, such as servers with unique software, might appear unusual but satisfy a specific business need.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors, such as reverse shells, reverse proxies, or droppers, that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Leverage the incident response data and logging to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 4,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Command and Control",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://book.hacktricks.xyz/generic-methodologies-and-resources/tunneling-and-port-forwarding"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            },
            "technique": [
              {
                "id": "T1572",
                "name": "Protocol Tunneling",
                "reference": "https://attack.mitre.org/techniques/T1572/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args_count",
            "type": "long",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "d5746e62-9679-4610-8ee4-e179cd8f5664",
        "rule_id": "29f0cf93-d17c-4b12-b4f3-a433800539fa",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:35.463Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:26.631Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\") and\nprocess.name in (\"ssh\", \"sshd\") and process.args in (\"-X\", \"-Y\") and process.args_count >= 3 and \nprocess.parent.name in (\"bash\", \"dash\", \"ash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\")",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "Potential Code Execution via Postgresql",
        "description": "This rule monitors for suspicious activities that may indicate an attacker attempting to execute arbitrary code within a PostgreSQL environment. Attackers can execute code via PostgreSQL as a result of gaining unauthorized access to a public facing PostgreSQL database or exploiting vulnerabilities, such as remote command execution and SQL injection attacks, which can result in unauthorized access and malicious actions, and facilitate post-exploitation activities for unauthorized access and malicious actions.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 7,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.004",
                    "name": "Unix Shell",
                    "reference": "https://attack.mitre.org/techniques/T1059/004/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.parent.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "9b14344f-7fb2-4bf2-b931-094a969b923a",
        "rule_id": "2a692072-d78d-42f3-a48a-775677d79c4e",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:35.466Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:26.635Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and\nevent.action in (\"exec\", \"exec_event\", \"fork\", \"fork_event\") and user.name == \"postgres\" and (\n  (process.parent.args : \"*sh\" and process.parent.args : \"echo*\") or \n  (process.args : \"*sh\" and process.args : \"echo*\")\n) and not (\n  process.parent.name == \"puppet\" or\n  process.command_line like \"*BECOME-SUCCESS-*\" or\n  process.parent.command_line like \"*BECOME-SUCCESS-*\"\n)",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "ESXI Discovery via Grep",
        "description": "Identifies instances where a process named 'grep', 'egrep', or 'pgrep' is started on a Linux system with arguments related to virtual machine (VM) files, such as \"vmdk\", \"vmx\", \"vmxf\", \"vmsd\", \"vmsn\", \"vswp\", \"vmss\", \"nvram\", or \"vmem\". These file extensions are associated with VM-related file formats, and their presence in grep command arguments may indicate that a threat actor is attempting to search for, analyze, or manipulate VM files on the system.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 7,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame",
          "Data Source: Auditd Manager"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.bleepingcomputer.com/news/security/massive-esxiargs-ransomware-attack-targets-vmware-esxi-servers-worldwide/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1518",
                "name": "Software Discovery",
                "reference": "https://attack.mitre.org/techniques/T1518/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "auditd_manager",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "459796d3-89a4-495a-8e63-2d2f9a6171a8",
        "rule_id": "2b662e21-dc6e-461e-b5cf-a6eb9b235ec4",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:35.469Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:26.644Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and\nevent.action in (\"exec\", \"exec_event\", \"executed\", \"process_started\") and\nprocess.name in (\"grep\", \"egrep\", \"pgrep\") and\nprocess.args in (\"vmdk\", \"vmx\", \"vmxf\", \"vmsd\", \"vmsn\", \"vswp\", \"vmss\", \"nvram\", \"vmem\") and\nnot process.parent.executable == \"/usr/share/qemu/init/qemu-kvm-init\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*",
          "auditbeat-*",
          "logs-auditd_manager.auditd-*"
        ],
        "filters": []
      },
      {
        "name": "Adobe Hijack Persistence",
        "description": "Detects writing executable files that will be automatically launched by Adobe on launch.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Adobe Hijack Persistence\n\nAttackers can replace the `RdrCEF.exe` executable with their own to maintain their access, which will be launched whenever Adobe Acrobat Reader is executed.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the file using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 414,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Microsoft Defender for Endpoint"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://twitter.com/pabraeken/status/997997818362155008"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1574",
                "name": "Hijack Execution Flow",
                "reference": "https://attack.mitre.org/techniques/T1574/",
                "subtechnique": [
                  {
                    "id": "T1574.010",
                    "name": "Services File Permissions Weakness",
                    "reference": "https://attack.mitre.org/techniques/T1574/010/"
                  }
                ]
              },
              {
                "id": "T1554",
                "name": "Compromise Host Software Binary",
                "reference": "https://attack.mitre.org/techniques/T1554/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "6998fb45-fcea-47d1-89fa-314f109e3b91",
        "rule_id": "2bf78aa2-9c56-48de-b139-f169bf99cf86",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:35.472Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:26.649Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"windows\" and event.type == \"creation\" and\n  file.path : (\"?:\\\\Program Files (x86)\\\\Adobe\\\\Acrobat Reader DC\\\\Reader\\\\AcroCEF\\\\RdrCEF.exe\",\n               \"?:\\\\Program Files\\\\Adobe\\\\Acrobat Reader DC\\\\Reader\\\\AcroCEF\\\\RdrCEF.exe\") and\n  not process.name : \"msiexec.exe\"",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.file-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-m365_defender.event-*"
        ],
        "filters": []
      },
      {
        "name": "Enumeration of Kernel Modules",
        "description": "Loadable Kernel Modules (or LKMs) are pieces of code that can be loaded and unloaded into the kernel upon demand. They extend the functionality of the kernel without the need to reboot the system. This identifies attempts to enumerate information about a kernel module.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 210,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Security tools and device drivers may run these programs in order to enumerate kernel modules. Use of these programs by ordinary users is uncommon. These can be exempted by process name or username."
        ],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1082",
                "name": "System Information Discovery",
                "reference": "https://attack.mitre.org/techniques/T1082/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "79b25990-c03d-485b-b2b4-977abb18f42d",
        "rule_id": "2d8043ed-5bda-4caf-801c-c1feb7410504",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:35.475Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:27.910Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "event.category:process and host.os.type:linux and event.type:start and event.action:(exec or exec_event) and (\n (process.name:(lsmod or modinfo)) or \n (process.name:kmod and process.args:list) or \n (process.name:depmod and process.args:(--all or -a))\n) and\nnot (\n  process.parent.name:(\n    mkinitramfs or cryptroot or framebuffer or dracut or jem or thin-provisioning-tools or readykernel or lvm2 or\n    vz-start or iscsi or mdadm or ovalprobes or bcache or plymouth or dkms or overlayroot or weak-modules or zfs or\n    systemd or whoopsie-upload-all or kdumpctl or apport-gtk or casper or rear or kernel-install\n  )\n)",
        "new_terms_fields": [
          "process.executable",
          "process.parent.executable"
        ],
        "history_window_start": "now-14d",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Suspicious Process Access via Direct System Call",
        "description": "Identifies suspicious process access events from an unknown memory region. Endpoint security solutions usually hook userland Windows APIs in order to decide if the code that is being executed is malicious or not. It's possible to bypass hooked functions by writing malicious functions that call syscalls directly.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Suspicious Process Access via Direct System Call\n\nEndpoint security solutions usually hook userland Windows APIs in order to decide if the code that is being executed is malicious or not. It's possible to bypass hooked functions by writing malicious functions that call syscalls directly.\n\nMore context and technical details can be found in this [research blog](https://outflank.nl/blog/2019/06/19/red-team-tactics-combining-direct-system-calls-and-srdi-to-bypass-av-edr/).\n\nThis rule identifies suspicious process access events from an unknown memory region. Attackers can use direct system calls to bypass security solutions that rely on hooks.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate any abnormal behavior by the subject process such as network connections, registry or file modifications, and any spawned child processes.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the process executable using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n\n### False positive analysis\n\n- This detection may be triggered by certain applications that install root certificates for the purpose of inspecting SSL traffic. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove the malicious certificate from the root certificate store.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 311,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Tactic: Execution",
          "Resources: Investigation Guide",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://twitter.com/SBousseaden/status/1278013896440324096",
          "https://www.ired.team/offensive-security/defense-evasion/using-syscalls-directly-from-visual-studio-to-bypass-avs-edrs"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1055",
                "name": "Process Injection",
                "reference": "https://attack.mitre.org/techniques/T1055/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1106",
                "name": "Native API",
                "reference": "https://attack.mitre.org/techniques/T1106/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.code",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.event_data.CallTrace",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "winlog.event_data.TargetImage",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "376cde86-13f4-489d-9876-40ac1f07037c",
        "rule_id": "2dd480be-1263-4d9c-8672-172928f6789a",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:35.493Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:27.915Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.code == \"10\" and\n length(winlog.event_data.CallTrace) > 0 and\n\n /* Sysmon CallTrace starting with unknown memory module instead of ntdll which host Windows NT Syscalls */\n not winlog.event_data.CallTrace :\n            (\"?:\\\\WINDOWS\\\\SYSTEM32\\\\ntdll.dll*\",\n             \"?:\\\\WINDOWS\\\\SysWOW64\\\\ntdll.dll*\",\n             \"?:\\\\Windows\\\\System32\\\\wow64cpu.dll*\",\n             \"?:\\\\WINDOWS\\\\System32\\\\wow64win.dll*\",\n             \"?:\\\\Windows\\\\System32\\\\win32u.dll*\") and\n\n not winlog.event_data.TargetImage :\n            (\"?:\\\\Program Files (x86)\\\\Malwarebytes Anti-Exploit\\\\mbae-svc.exe\",\n             \"?:\\\\Program Files\\\\Cisco\\\\AMP\\\\*\\\\sfc.exe\",\n             \"?:\\\\Program Files (x86)\\\\Microsoft\\\\EdgeWebView\\\\Application\\\\*\\\\msedgewebview2.exe\",\n             \"?:\\\\Program Files\\\\Adobe\\\\Acrobat DC\\\\Acrobat\\\\*\\\\AcroCEF.exe\") and\n\n not (process.executable : (\"?:\\\\Program Files\\\\Adobe\\\\Acrobat DC\\\\Acrobat\\\\Acrobat.exe\",\n                            \"?:\\\\Program Files (x86)\\\\World of Warcraft\\\\_classic_\\\\WowClassic.exe\") and\n      not winlog.event_data.TargetImage : \"?:\\\\WINDOWS\\\\system32\\\\lsass.exe\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "Accessing Outlook Data Files",
        "description": "Identifies commands containing references to Outlook data files extensions, which can potentially indicate the search, access, or modification of these files.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 105,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Collection",
          "Data Source: Elastic Defend",
          "Rule Type: BBR",
          "Data Source: Sysmon",
          "Data Source: Elastic Endgame",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0009",
              "name": "Collection",
              "reference": "https://attack.mitre.org/tactics/TA0009/"
            },
            "technique": [
              {
                "id": "T1114",
                "name": "Email Collection",
                "reference": "https://attack.mitre.org/techniques/T1114/",
                "subtechnique": [
                  {
                    "id": "T1114.001",
                    "name": "Local Email Collection",
                    "reference": "https://attack.mitre.org/techniques/T1114/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "c46aa8ef-4bc1-41e4-8ac6-3ecc45b93005",
        "rule_id": "2e311539-cd88-4a85-a301-04f38795007c",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:38.402Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:27.929Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and process.args : (\"*.ost\", \"*.pst\") and\n  not process.name : \"outlook.exe\" and\n  not (\n        process.name : \"rundll32.exe\" and\n        process.args : \"*davclnt.dll,DavSetCookie*\"\n  )",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "winlogbeat-*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious MS Outlook Child Process",
        "description": "Identifies suspicious child processes of Microsoft Outlook. These child processes are often associated with spear phishing activity.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Suspicious MS Outlook Child Process\n\nMicrosoft Outlook is an email client that provides contact, email calendar, and task management features. Outlook is widely used, either standalone or as part of the Office suite.\n\nThis rule looks for suspicious processes spawned by MS Outlook, which can be the result of the execution of malicious documents and/or exploitation for initial access.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Retrieve recently opened files received via email and opened by the user that could cause this behavior. Common locations include but are not limited to, the Downloads and Document folders and the folder configured at the email client.\n- Determine if the collected files are malicious:\n  - Use a private sandboxed malware analysis system to perform analysis.\n    - Observe and collect information about the following activities:\n      - Attempts to contact external domains and addresses.\n      - File and registry access, modification, and creation activities.\n      - Service creation and launch activities.\n      - Scheduled task creation.\n  - Use the PowerShell Get-FileHash cmdlet to get the files' SHA-256 hash values.\n    - Search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n  - If the malicious file was delivered via phishing:\n    - Block the email sender from sending future emails.\n    - Block the malicious web pages.\n    - Remove emails from the sender from mailboxes.\n    - Consider improvements to the security awareness program.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 416,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Initial Access",
          "Tactic: Defense Evasion",
          "Tactic: Execution",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: SentinelOne",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: System",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1566",
                "name": "Phishing",
                "reference": "https://attack.mitre.org/techniques/T1566/",
                "subtechnique": [
                  {
                    "id": "T1566.001",
                    "name": "Spearphishing Attachment",
                    "reference": "https://attack.mitre.org/techniques/T1566/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  },
                  {
                    "id": "T1059.003",
                    "name": "Windows Command Shell",
                    "reference": "https://attack.mitre.org/techniques/T1059/003/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1218",
                "name": "System Binary Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1218/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "8059ae4a-85a3-4818-af15-9509e4d83243",
        "rule_id": "32f4675e-6c49-4ace-80f9-97c9259dca2e",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:38.399Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:28.024Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.parent.name : \"outlook.exe\" and\n  process.name : (\"Microsoft.Workflow.Compiler.exe\", \"arp.exe\", \"atbroker.exe\", \"bginfo.exe\", \"bitsadmin.exe\",\n                  \"cdb.exe\", \"certutil.exe\", \"cmd.exe\", \"cmstp.exe\", \"cscript.exe\", \"csi.exe\", \"dnx.exe\", \"dsget.exe\",\n                  \"dsquery.exe\", \"forfiles.exe\", \"fsi.exe\", \"ftp.exe\", \"gpresult.exe\", \"hostname.exe\", \"ieexec.exe\",\n                  \"iexpress.exe\", \"installutil.exe\", \"ipconfig.exe\", \"mshta.exe\", \"msxsl.exe\", \"nbtstat.exe\", \"net.exe\",\n                  \"net1.exe\", \"netsh.exe\", \"netstat.exe\", \"nltest.exe\", \"odbcconf.exe\", \"ping.exe\", \"powershell.exe\",\n                  \"pwsh.exe\", \"qprocess.exe\", \"quser.exe\", \"qwinsta.exe\", \"rcsi.exe\", \"reg.exe\", \"regasm.exe\",\n                  \"regsvcs.exe\", \"regsvr32.exe\", \"sc.exe\", \"schtasks.exe\", \"systeminfo.exe\", \"tasklist.exe\",\n                  \"tracert.exe\", \"whoami.exe\", \"wmic.exe\", \"wscript.exe\", \"xwizard.exe\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.*",
          "endgame-*",
          "logs-system.security*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-m365_defender.event-*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "ESXI Discovery via Find",
        "description": "Identifies instances where the 'find' command is started on a Linux system with arguments targeting specific VM-related paths, such as \"/etc/vmware/\", \"/usr/lib/vmware/\", or \"/vmfs/*\". These paths are associated with VMware virtualization software, and their presence in the find command arguments may indicate that a threat actor is attempting to search for, analyze, or manipulate VM-related files and configurations on the system.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 7,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame",
          "Data Source: Auditd Manager"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.bleepingcomputer.com/news/security/massive-esxiargs-ransomware-attack-targets-vmware-esxi-servers-worldwide/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1518",
                "name": "Software Discovery",
                "reference": "https://attack.mitre.org/techniques/T1518/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "auditd_manager",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "7eb3cab6-ce67-4368-883c-bd3434c93748",
        "rule_id": "33a6752b-da5e-45f8-b13a-5f094c09522f",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:38.410Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:28.033Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and\nevent.action in (\"exec\", \"exec_event\", \"executed\", \"process_started\") and process.name == \"find\" and\nprocess.args : (\"/etc/vmware/*\", \"/usr/lib/vmware/*\", \"/vmfs/*\") and \nnot process.parent.executable == \"/usr/lib/vmware/viewagent/bin/uninstall_viewagent.sh\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*",
          "auditbeat-*",
          "logs-auditd_manager.auditd-*"
        ],
        "filters": []
      },
      {
        "name": "GitHub Repository Deleted",
        "description": "This rule detects when a GitHub repository is deleted within your organization. Repositories are a critical component used within an organization to manage work, collaborate with others and release products to the public. Any delete action against a repository should be investigated to determine it's validity. Unauthorized deletion of organization repositories could cause irreversible loss of intellectual property and indicate compromise within your organization.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 203,
        "tags": [
          "Domain: Cloud",
          "Use Case: Threat Detection",
          "Use Case: UEBA",
          "Tactic: Impact",
          "Data Source: Github"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0040",
              "name": "Impact",
              "reference": "https://attack.mitre.org/tactics/TA0040/"
            },
            "technique": [
              {
                "id": "T1485",
                "name": "Data Destruction",
                "reference": "https://attack.mitre.org/techniques/T1485/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "github",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.module",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "72a55313-bf11-4a9a-8f6c-ecbac12e6fe5",
        "rule_id": "345889c4-23a8-4bc0-b7ca-756bd17ce83b",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:38.412Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:28.046Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "configuration where event.module == \"github\" and event.dataset == \"github.audit\" and event.action == \"repo.destroy\"",
        "language": "eql",
        "index": [
          "logs-github.audit-*"
        ],
        "filters": []
      },
      {
        "name": "First Occurrence of IP Address For GitHub User",
        "description": "Detects a new IP address used for a GitHub user not previously seen in the last 14 days.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 204,
        "tags": [
          "Domain: Cloud",
          "Use Case: Threat Detection",
          "Use Case: UEBA",
          "Tactic: Initial Access",
          "Rule Type: BBR",
          "Data Source: Github"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1078",
                "name": "Valid Accounts",
                "reference": "https://attack.mitre.org/techniques/T1078/",
                "subtechnique": [
                  {
                    "id": "T1078.004",
                    "name": "Cloud Accounts",
                    "reference": "https://attack.mitre.org/techniques/T1078/004/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "github",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "github.actor_ip",
            "type": "ip",
            "ecs": false
          },
          {
            "name": "user.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "aabb37cc-198c-4d88-b920-934d85985536",
        "rule_id": "3af4cb9b-973f-4c54-be2b-7623c0e21b2b",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:38.415Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:28.726Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "event.dataset:\"github.audit\" and event.category:\"configuration\" and\ngithub.actor_ip:* and user.name:*",
        "new_terms_fields": [
          "user.name",
          "github.actor_ip"
        ],
        "history_window_start": "now-14d",
        "index": [
          "logs-github.audit-*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Unusual Parent Process for cmd.exe",
        "description": "Identifies a suspicious parent child process relationship with cmd.exe descending from an unusual process.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 413,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Microsoft Defender for Endpoint"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "52d88d3d-5c4b-494d-afe1-26500dac9f54",
        "rule_id": "3b47900d-e793-49e8-968f-c90dc3526aa1",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:38.418Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:28.741Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.name : \"cmd.exe\" and\n  process.parent.name : (\"lsass.exe\",\n                         \"csrss.exe\",\n                         \"epad.exe\",\n                         \"regsvr32.exe\",\n                         \"dllhost.exe\",\n                         \"LogonUI.exe\",\n                         \"wermgr.exe\",\n                         \"spoolsv.exe\",\n                         \"jucheck.exe\",\n                         \"jusched.exe\",\n                         \"ctfmon.exe\",\n                         \"taskhostw.exe\",\n                         \"GoogleUpdate.exe\",\n                         \"sppsvc.exe\",\n                         \"sihost.exe\",\n                         \"slui.exe\",\n                         \"SIHClient.exe\",\n                         \"SearchIndexer.exe\",\n                         \"SearchProtocolHost.exe\",\n                         \"FlashPlayerUpdateService.exe\",\n                         \"WerFault.exe\",\n                         \"WUDFHost.exe\",\n                         \"unsecapp.exe\",\n                         \"wlanext.exe\" ) and\n  not (process.parent.name : \"dllhost.exe\" and process.parent.args : \"/Processid:{CA8C87C1-929D-45BA-94DB-EF8E6CB346AD}\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-m365_defender.event-*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious Process Creation CallTrace",
        "description": "Identifies when a process is created and immediately accessed from an unknown memory code region and by the same parent process. This may indicate a code injection attempt.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Suspicious Process Creation CallTrace\n\nAttackers may inject code into child processes' memory to hide their actual activity, evade detection mechanisms, and decrease discoverability during forensics. This rule looks for a spawned process by Microsoft Office, scripting, and command line applications, followed by a process access event for an unknown memory region by the parent process, which can indicate a code injection attempt.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate any abnormal behavior by the subject process such as network connections, registry or file modifications, and any spawned child processes.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Inspect the host for suspicious or abnormal behavior in the alert timeframe.\n- Create a memory dump of the child process for analysis.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 308,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Resources: Investigation Guide",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1055",
                "name": "Process Injection",
                "reference": "https://attack.mitre.org/techniques/T1055/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.code",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.event_data.CallTrace",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "winlog.event_data.TargetProcessGUID",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "73c801d4-371f-4272-8561-67f9893dd5cd",
        "rule_id": "3ed032b2-45d8-4406-bc79-7ad1eabb2c72",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:38.421Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:28.776Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by host.id with maxspan=1m\n  [process where host.os.type == \"windows\" and event.code == \"1\" and\n   /* sysmon process creation */\n   process.parent.name : (\"winword.exe\", \"excel.exe\", \"outlook.exe\", \"powerpnt.exe\", \"eqnedt32.exe\", \"fltldr.exe\",\n                          \"mspub.exe\", \"msaccess.exe\",\"cscript.exe\", \"wscript.exe\", \"rundll32.exe\", \"regsvr32.exe\",\n                          \"mshta.exe\", \"wmic.exe\", \"cmstp.exe\", \"msxsl.exe\") and\n\n   /* noisy FP patterns */\n   not (process.parent.name : \"EXCEL.EXE\" and process.executable : \"?:\\\\Program Files\\\\Microsoft Office\\\\root\\\\Office*\\\\ADDINS\\\\*.exe\") and\n   not (process.executable : \"?:\\\\Windows\\\\splwow64.exe\" and process.args in (\"8192\", \"12288\") and process.parent.name : (\"winword.exe\", \"excel.exe\", \"outlook.exe\", \"powerpnt.exe\")) and\n   not (process.parent.name : \"rundll32.exe\" and process.parent.args : (\"?:\\\\WINDOWS\\\\Installer\\\\MSI*.tmp,zzzzInvokeManagedCustomActionOutOfProc\", \"--no-sandbox\")) and\n   not (process.executable :\n            (\"?:\\\\Program Files (x86)\\\\Microsoft\\\\EdgeWebView\\\\Application\\\\*\\\\msedgewebview2.exe\",\n             \"?:\\\\Program Files\\\\Adobe\\\\Acrobat DC\\\\Acrobat\\\\Acrobat.exe\",\n             \"?:\\\\Windows\\\\SysWOW64\\\\DWWIN.EXE\") and\n        process.parent.name : (\"winword.exe\", \"excel.exe\", \"outlook.exe\", \"powerpnt.exe\")) and\n   not (process.parent.name : \"regsvr32.exe\" and process.parent.args : (\"?:\\\\Program Files\\\\*\", \"?:\\\\Program Files (x86)\\\\*\"))\n   ] by process.parent.entity_id, process.entity_id\n  [process where host.os.type == \"windows\" and event.code == \"10\" and\n   /* Sysmon process access event from unknown module */\n   winlog.event_data.CallTrace : \"*UNKNOWN*\"] by process.entity_id, winlog.event_data.TargetProcessGUID",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "Potential Protocol Tunneling via Chisel Client",
        "description": "This rule monitors for common command line flags leveraged by the Chisel client utility followed by a connection attempt. Chisel is a command-line utility used for creating and managing TCP and UDP tunnels, enabling port forwarding and secure communication between machines. Attackers can abuse the Chisel utility to establish covert communication channels, bypass network restrictions, and carry out malicious activities by creating tunnels that allow unauthorized access to internal systems.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Potential Protocol Tunneling via Chisel Client\n\nAttackers can leverage `chisel` to clandestinely tunnel network communications and evade security measures, potentially gaining unauthorized access to sensitive systems.\n\nThis rule looks for a sequence of command line arguments that are consistent with `chisel` client tunneling behavior, followed by a network event by an uncommon process. \n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n> This investigation guide uses [placeholder fields](https://www.elastic.co/guide/en/security/current/osquery-placeholder-fields.html) to dynamically pass alert data into Osquery queries. Placeholder fields were introduced in Elastic Stack version 8.7.0. If you're using Elastic Stack version 8.6.0 or earlier, you'll need to manually adjust this investigation guide's queries to ensure they properly run.\n\n#### Possible investigation steps\n\n- Identify any signs of suspicious network activity or anomalies that may indicate protocol tunneling. This could include unexpected traffic patterns or unusual network behavior.\n  - Investigate listening ports and open sockets to look for potential protocol tunneling, reverse shells, or data exfiltration.\n    - !{osquery{\"label\":\"Osquery - Retrieve Listening Ports\",\"query\":\"SELECT pid, address, port, socket, protocol, path FROM listening_ports\"}}\n    - !{osquery{\"label\":\"Osquery - Retrieve Open Sockets\",\"query\":\"SELECT pid, family, remote_address, remote_port, socket, state FROM process_open_sockets\"}}\n- Identify the user account that performed the action, analyze it, and check whether it should perform this kind of action.\n  - !{osquery{\"label\":\"Osquery - Retrieve Information for a Specific User\",\"query\":\"SELECT * FROM users WHERE username = {{user.name}}\"}}\n- Investigate whether the user is currently logged in and active.\n  - !{osquery{\"label\":\"Osquery - Investigate the Account Authentication Status\",\"query\":\"SELECT * FROM logged_in_users WHERE user = {{user.name}}\"}}\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence and whether they are located in expected locations.\n  - !{osquery{\"label\":\"Osquery - Retrieve Running Processes by User\",\"query\":\"SELECT pid, username, name FROM processes p JOIN users u ON u.uid = p.uid ORDER BY username\"}}\n  - !{osquery{\"label\":\"Osquery - Retrieve Process Info\",\"query\":\"SELECT name, cmdline, parent, path, uid FROM processes\"}}\n- Investigate other alerts associated with the user/host during the past 48 hours.\n  - If scripts or executables were dropped, retrieve the files and determine if they are malicious:\n    - Use a private sandboxed malware analysis system to perform analysis.\n      - Observe and collect information about the following activities:\n        - Attempts to contact external domains and addresses.\n          - Check if the domain is newly registered or unexpected.\n          - Check the reputation of the domain or IP address.\n        - File access, modification, and creation activities.\n\n### Related rules\n\n- Potential Protocol Tunneling via Chisel Server - ac8805f6-1e08-406c-962e-3937057fa86f\n- Potential Linux Tunneling and/or Port Forwarding - 6ee947e9-de7e-4281-a55d-09289bdf947e\n- Potential Protocol Tunneling via EarthWorm - 9f1c4ca3-44b5-481d-ba42-32dc215a2769\n\n### False positive analysis\n\n- If this activity is related to new benign software installation activity, consider adding exceptions — preferably with a combination of user and command line conditions.\n- If this activity is related to a system administrator or developer who uses port tunneling for benign purposes, consider adding exceptions for specific user accounts or hosts. \n- Try to understand the context of the execution by thinking about the user, machine, or business purpose. A small number of endpoints, such as servers with unique software, might appear unusual but satisfy a specific business need.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors, such as reverse shells, reverse proxies, or droppers, that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Leverage the incident response data and logging to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 6,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Command and Control",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://blog.bitsadmin.com/living-off-the-foreign-land-windows-as-offensive-platform",
          "https://book.hacktricks.xyz/generic-methodologies-and-resources/tunneling-and-port-forwarding"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            },
            "technique": [
              {
                "id": "T1572",
                "name": "Protocol Tunneling",
                "reference": "https://attack.mitre.org/techniques/T1572/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args_count",
            "type": "long",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "179b6d51-c7f4-4934-97ab-eb060be12812",
        "rule_id": "3f12325a-4cc6-410b-8d4c-9fbbeb744cfd",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:38.423Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:28.791Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by host.id, process.entity_id with maxspan=3s\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and \n   process.args == \"client\" and process.args : (\"R*\", \"*:*\", \"*socks*\", \"*.*\") and process.args_count >= 4 and \n   process.parent.name in (\"bash\", \"dash\", \"ash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\") and\n   not process.name in (\"velociraptor\", \"nbemmcmd\")]\n  [network where host.os.type == \"linux\" and event.action == \"connection_attempted\" and event.type == \"start\" and \n   destination.ip != null and destination.ip != \"127.0.0.1\" and destination.ip != \"::1\" and \n   not process.name : (\n     \"python*\", \"php*\", \"perl\", \"ruby\", \"lua*\", \"openssl\", \"nc\", \"netcat\", \"ncat\", \"telnet\", \"awk\", \"java\", \"telnet\",\n     \"ftp\", \"socat\", \"curl\", \"wget\", \"dpkg\", \"docker\", \"dockerd\", \"yum\", \"apt\", \"rpm\", \"dnf\", \"ssh\", \"sshd\")]",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "GitHub User Blocked From Organization",
        "description": "A GitHub user was blocked from access to an organization.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 204,
        "tags": [
          "Domain: Cloud",
          "Use Case: Threat Detection",
          "Use Case: UEBA",
          "Tactic: Impact",
          "Rule Type: BBR",
          "Data Source: Github"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0040",
              "name": "Impact",
              "reference": "https://attack.mitre.org/tactics/TA0040/"
            },
            "technique": [
              {
                "id": "T1531",
                "name": "Account Access Removal",
                "reference": "https://attack.mitre.org/techniques/T1531/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "github",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "96f63a40-4e94-4c37-8a79-35c700503c8b",
        "rule_id": "4030c951-448a-4017-a2da-ed60f6d14f4f",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:38.426Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:28.822Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "configuration where event.dataset == \"github.audit\" and event.action == \"org.block_user\"",
        "language": "eql",
        "index": [
          "logs-github.audit-*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious Modprobe File Event",
        "description": "Detects file events involving kernel modules in modprobe configuration files, which may indicate unauthorized access or manipulation of critical kernel modules. Attackers may tamper with the modprobe files to load malicious or unauthorized kernel modules, potentially bypassing security measures, escalating privileges, or hiding their activities within the system.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 108,
        "tags": [
          "Data Source: Auditd Manager",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Rule Type: BBR"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1082",
                "name": "System Information Discovery",
                "reference": "https://attack.mitre.org/techniques/T1082/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires the use of the `auditd_manager` integration. `Auditd_manager` is a tool designed to simplify and enhance the management of the audit subsystem in Linux systems. It provides a user-friendly interface and automation capabilities for configuring and monitoring system auditing through the auditd daemon. With `auditd_manager`, administrators can easily define audit rules, track system events, and generate comprehensive audit reports, improving overall security and compliance in the system. The following steps should be executed in order to install and deploy `auditd_manager` on a Linux system.\n\n```\nKibana -->\nManagement -->\nIntegrations -->\nAuditd Manager -->\nAdd Auditd Manager\n```\n\n`Auditd_manager` subscribes to the kernel and receives events as they occur without any additional configuration. However, if more advanced configuration is required to detect specific behavior, audit rules can be added to the integration in either the \"audit rules\" configuration box or the \"auditd rule files\" box by specifying a file to read the audit rules from.\n\nFor this detection rule to trigger, the following additional audit rules are required to be added to the integration:\n```\n-w /etc/modprobe.conf -p wa -k modprobe\n-w /etc/modprobe.d -p wa -k modprobe\n```\n\nAdd the newly installed `auditd manager` to an agent policy, and deploy the agent on a Linux system from which auditd log files are desirable.\n",
        "related_integrations": [
          {
            "package": "auditd_manager",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "9fcbc899-27b9-4545-89f1-b4717567f22f",
        "rule_id": "40ddbcc8-6561-44d9-afc8-eefdbfe0cccd",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:38.428Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:30.350Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "host.os.type:linux and event.category:file and event.action:\"opened-file\" and\nfile.path : (\"/etc/modprobe.conf\" or \"/etc/modprobe.d\" or /etc/modprobe.d/*) and not process.name:(\n  cp or dpkg or dockerd or lynis or mkinitramfs or snapd or systemd-udevd or borg or auditbeat or lspci or\n  aide or modprobe or python*\n)",
        "new_terms_fields": [
          "process.executable"
        ],
        "history_window_start": "now-14d",
        "index": [
          "auditbeat-*",
          "logs-auditd_manager.auditd-*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Unix Socket Connection",
        "description": "This rule monitors for inter-process communication via Unix sockets. Adversaries may attempt to communicate with local Unix sockets to enumerate application details, find vulnerabilities/configuration mistakes and potentially escalate privileges or set up malicious communication channels via Unix sockets for inter-process communication to attempt to evade detection.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 3,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame",
          "Data Source: Auditd Manager"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1559",
                "name": "Inter-Process Communication",
                "reference": "https://attack.mitre.org/techniques/T1559/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "auditd_manager",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "443b7a01-1552-4d77-a90c-32f6f7ba7aa0",
        "rule_id": "41284ba3-ed1a-4598-bfba-a97f75d9aba2",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:38.431Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:30.100Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\", \"executed\", \"process_started\")\n and (\n  (process.name in (\"nc\", \"ncat\", \"netcat\", \"nc.openbsd\") and \n   process.args == \"-U\" and process.args : (\"/usr/local/*\", \"/run/*\", \"/var/run/*\")) or\n  (process.name == \"socat\" and \n   process.args == \"-\" and process.args : (\"UNIX-CLIENT:/usr/local/*\", \"UNIX-CLIENT:/run/*\", \"UNIX-CLIENT:/var/run/*\"))\n) and\nnot process.args == \"/var/run/libvirt/libvirt-sock\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*",
          "auditbeat-*",
          "logs-auditd_manager.auditd-*"
        ],
        "filters": []
      },
      {
        "name": "First Occurrence of User-Agent For a GitHub User",
        "description": "Detects a new user agent used for a GitHub user not previously seen in the last 14 days.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 204,
        "tags": [
          "Domain: Cloud",
          "Use Case: Threat Detection",
          "Use Case: UEBA",
          "Tactic: Initial Access",
          "Rule Type: BBR",
          "Data Source: Github"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1078",
                "name": "Valid Accounts",
                "reference": "https://attack.mitre.org/techniques/T1078/",
                "subtechnique": [
                  {
                    "id": "T1078.004",
                    "name": "Cloud Accounts",
                    "reference": "https://attack.mitre.org/techniques/T1078/004/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "github",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "github.user_agent",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "user.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "195a3aaf-bb6b-46e7-b0e0-6d105d9990a8",
        "rule_id": "41761cd3-380f-4d4d-89f3-46d6853ee35d",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:38.440Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:30.105Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "event.dataset:\"github.audit\" and event.category:\"configuration\" and\ngithub.user_agent:* and user.name:*",
        "new_terms_fields": [
          "user.name",
          "github.user_agent"
        ],
        "history_window_start": "now-14d",
        "index": [
          "logs-github.audit-*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Process Creation via Secondary Logon",
        "description": "Identifies process creation with alternate credentials. Adversaries may create a new process with a different token to escalate privileges and bypass access controls.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 110,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://attack.mitre.org/techniques/T1134/002/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1134",
                "name": "Access Token Manipulation",
                "reference": "https://attack.mitre.org/techniques/T1134/",
                "subtechnique": [
                  {
                    "id": "T1134.002",
                    "name": "Create Process with Token",
                    "reference": "https://attack.mitre.org/techniques/T1134/002/"
                  },
                  {
                    "id": "T1134.003",
                    "name": "Make and Impersonate Token",
                    "reference": "https://attack.mitre.org/techniques/T1134/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nAudit events 4624 and 4688 are needed to trigger this rule.\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "source.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.computer_name",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "winlog.event_data.LogonProcessName",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "winlog.event_data.TargetLogonId",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "c4a4e991-2b05-4630-a8df-9dcad8695bb6",
        "rule_id": "42eeee3d-947f-46d3-a14d-7036b962c266",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:38.443Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:30.138Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by winlog.computer_name with maxspan=1m\n\n[authentication where event.action:\"logged-in\" and\n event.outcome == \"success\" and user.id : (\"S-1-5-21-*\", \"S-1-12-1-*\") and\n\n /* seclogon service */\n process.name == \"svchost.exe\" and\n winlog.event_data.LogonProcessName : \"seclogo*\" and source.ip == \"::1\" ] by winlog.event_data.TargetLogonId\n\n[process where event.type == \"start\"] by winlog.event_data.TargetLogonId",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-system.*",
          "logs-windows.*"
        ],
        "filters": []
      },
      {
        "name": "Scheduled Task Execution at Scale via GPO",
        "description": "Detects the modification of Group Policy Object attributes to execute a scheduled task in the objects controlled by the GPO.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Scheduled Task Execution at Scale via GPO\n\nGroup Policy Objects (GPOs) can be used by attackers to execute scheduled tasks at scale to compromise objects controlled by a given GPO. This is done by changing the contents of the `<GPOPath>\\Machine\\Preferences\\ScheduledTasks\\ScheduledTasks.xml` file.\n\n#### Possible investigation steps\n\n- This attack abuses a legitimate mechanism of Active Directory, so it is important to determine whether the activity is legitimate and the administrator is authorized to perform this operation.\n- Retrieve the contents of the `ScheduledTasks.xml` file, and check the `<Command>` and `<Arguments>` XML tags for any potentially malicious commands or binaries.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Scope which objects may be compromised by retrieving information about which objects are controlled by the GPO.\n\n### False positive analysis\n\n- Verify if the execution is allowed and done under change management, and if the execution is legitimate.\n\n### Related rules\n\n- Group Policy Abuse for Privilege Addition - b9554892-5e0e-424b-83a0-5aef95aa43bf\n- Startup/Logon Script added to Group Policy Object - 16fac1a1-21ee-4ca6-b720-458e3855d046\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- The investigation and containment must be performed in every computer controlled by the GPO, where necessary.\n- Remove the script from the GPO.\n- Check if other GPOs have suspicious scheduled tasks attached.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 212,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Tactic: Lateral Movement",
          "Data Source: Active Directory",
          "Resources: Investigation Guide",
          "Use Case: Active Directory Monitoring",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/atc-project/atc-data/blob/master/docs/Logging_Policies/LP_0025_windows_audit_directory_service_changes.md",
          "https://github.com/atc-project/atc-data/blob/f2bbb51ecf68e2c9f488e3c70dcdd3df51d2a46b/docs/Logging_Policies/LP_0029_windows_audit_detailed_file_share.md",
          "https://labs.f-secure.com/tools/sharpgpoabuse",
          "https://twitter.com/menasec1/status/1106899890377052160",
          "https://github.com/SigmaHQ/sigma/blob/master/rules/windows/builtin/security/win_gpo_scheduledtasks.yml"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1053",
                "name": "Scheduled Task/Job",
                "reference": "https://attack.mitre.org/techniques/T1053/",
                "subtechnique": [
                  {
                    "id": "T1053.005",
                    "name": "Scheduled Task",
                    "reference": "https://attack.mitre.org/techniques/T1053/005/"
                  }
                ]
              },
              {
                "id": "T1484",
                "name": "Domain or Tenant Policy Modification",
                "reference": "https://attack.mitre.org/techniques/T1484/",
                "subtechnique": [
                  {
                    "id": "T1484.001",
                    "name": "Group Policy Modification",
                    "reference": "https://attack.mitre.org/techniques/T1484/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1570",
                "name": "Lateral Tool Transfer",
                "reference": "https://attack.mitre.org/techniques/T1570/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'Audit Detailed File Share' audit policy must be configured (Success Failure).\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nPolicies >\nWindows Settings >\nSecurity Settings >\nAdvanced Audit Policies Configuration >\nAudit Policies >\nObject Access >\nAudit Detailed File Share (Success,Failure)\n```\n\nThe 'Audit Directory Service Changes' audit policy must be configured (Success Failure).\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nPolicies >\nWindows Settings >\nSecurity Settings >\nAdvanced Audit Policies Configuration >\nAudit Policies >\nDS Access >\nAudit Directory Service Changes (Success,Failure)\n```\n",
        "related_integrations": [
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.code",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.event_data.AccessList",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "winlog.event_data.AttributeLDAPDisplayName",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "winlog.event_data.AttributeValue",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "winlog.event_data.RelativeTargetName",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "winlog.event_data.ShareName",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "440e9c6a-2aa9-40d6-be54-37ccecf537de",
        "rule_id": "15a8ba77-1c13-4274-88fe-6bd14133861e",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:38.448Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:23.828Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "any where host.os.type == \"windows\" and event.code in (\"5136\", \"5145\") and\n(\n  (\n    winlog.event_data.AttributeLDAPDisplayName : (\n      \"gPCMachineExtensionNames\",\n      \"gPCUserExtensionNames\"\n    ) and\n    winlog.event_data.AttributeValue : \"*CAB54552-DEEA-4691-817E-ED4A4D1AFC72*\" and\n    winlog.event_data.AttributeValue : \"*AADCED64-746C-4633-A97C-D61349046527*\"\n  ) or\n  (\n    winlog.event_data.ShareName : \"\\\\\\\\*\\\\SYSVOL\" and\n    winlog.event_data.RelativeTargetName : \"*ScheduledTasks.xml\" and\n    winlog.event_data.AccessList:\"*%%4417*\"\n  )\n)",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-system.*",
          "logs-windows.*"
        ],
        "filters": []
      },
      {
        "name": "Multiple Vault Web Credentials Read",
        "description": "Windows Credential Manager allows you to create, view, or delete saved credentials for signing into websites, connected applications, and networks. An adversary may abuse this to list or dump credentials stored in the Credential Manager for saved usernames and passwords. This may also be performed in preparation of lateral movement.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 111,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventid=5382",
          "https://www.elastic.co/security-labs/detect-credential-access"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1003",
                "name": "OS Credential Dumping",
                "reference": "https://attack.mitre.org/techniques/T1003/"
              },
              {
                "id": "T1555",
                "name": "Credentials from Password Stores",
                "reference": "https://attack.mitre.org/techniques/T1555/",
                "subtechnique": [
                  {
                    "id": "T1555.004",
                    "name": "Windows Credential Manager",
                    "reference": "https://attack.mitre.org/techniques/T1555/004/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.code",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.computer_name",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "winlog.event_data.Resource",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "winlog.event_data.SchemaFriendlyName",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "winlog.event_data.SubjectLogonId",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "winlog.process.pid",
            "type": "long",
            "ecs": false
          }
        ],
        "id": "48da56c1-94e7-4a48-b48d-daaf981af9db",
        "rule_id": "44fc462c-1159-4fa8-b1b7-9b6296ab4f96",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:38.446Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:30.162Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by winlog.computer_name, winlog.process.pid with maxspan=1s\n\n /* 2 consecutive vault reads from same pid for web creds */\n\n [any where event.code : \"5382\" and\n  (winlog.event_data.SchemaFriendlyName : \"Windows Web Password Credential\" and winlog.event_data.Resource : \"http*\") and\n  not winlog.event_data.SubjectLogonId : \"0x3e7\" and \n  not winlog.event_data.Resource : \"http://localhost/\"]\n\n [any where event.code : \"5382\" and\n  (winlog.event_data.SchemaFriendlyName : \"Windows Web Password Credential\" and winlog.event_data.Resource : \"http*\") and\n  not winlog.event_data.SubjectLogonId : \"0x3e7\" and \n  not winlog.event_data.Resource : \"http://localhost/\"]",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-system.*",
          "logs-windows.*"
        ],
        "filters": []
      },
      {
        "name": "File Creation Time Changed",
        "description": "Identifies modification of a file creation time. Adversaries may modify file time attributes to blend malicious content with existing files. Timestomping is a technique that modifies the timestamps of a file often to mimic files that are in trusted directories.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 105,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1070",
                "name": "Indicator Removal",
                "reference": "https://attack.mitre.org/techniques/T1070/",
                "subtechnique": [
                  {
                    "id": "T1070.006",
                    "name": "Timestomp",
                    "reference": "https://attack.mitre.org/techniques/T1070/006/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.code",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "74976593-5fda-4455-a961-22f45d6c1d89",
        "rule_id": "166727ab-6768-4e26-b80c-948b228ffc06",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:38.451Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:24.367Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"windows\" and event.code : \"2\" and\n\n /* Requires Sysmon EventID 2 - File creation time change */\n event.action : \"File creation time changed*\" and \n \n not process.executable : \n          (\"?:\\\\Program Files\\\\*\", \n           \"?:\\\\Program Files (x86)\\\\*\", \n           \"?:\\\\Windows\\\\system32\\\\cleanmgr.exe\",\n           \"?:\\\\Windows\\\\system32\\\\msiexec.exe\", \n           \"?:\\\\Windows\\\\syswow64\\\\msiexec.exe\", \n           \"?:\\\\Windows\\\\system32\\\\svchost.exe\", \n           \"?:\\\\WINDOWS\\\\system32\\\\backgroundTaskHost.exe\",\n           \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Google\\\\Chrome\\\\Application\\\\chrome.exe\", \n           \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Mozilla Firefox\\\\firefox.exe\",\n           \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\slack\\\\app-*\\\\slack.exe\", \n           \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\GitHubDesktop\\\\app-*\\\\GitHubDesktop.exe\",\n           \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Microsoft\\\\Teams\\\\current\\\\Teams.exe\", \n           \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Microsoft\\\\OneDrive\\\\OneDrive.exe\") and \n not file.extension : (\"temp\", \"tmp\", \"~tmp\", \"xml\", \"newcfg\") and not user.name : (\"SYSTEM\", \"Local Service\", \"Network Service\") and\n not file.name : (\"LOG\", \"temp-index\", \"license.rtf\", \"iconcache_*.db\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "Startup/Logon Script added to Group Policy Object",
        "description": "Detects the modification of Group Policy Objects (GPO) to add a startup/logon script to users or computer objects.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Startup/Logon Script added to Group Policy Object\n\nGroup Policy Objects (GPOs) can be used by attackers to instruct arbitrarily large groups of clients to execute specified commands at startup, logon, shutdown, and logoff. This is done by creating or modifying the `scripts.ini` or `psscripts.ini` files. The scripts are stored in the following paths:\n  - `<GPOPath>\\Machine\\Scripts\\`\n  - `<GPOPath>\\User\\Scripts\\`\n\n#### Possible investigation steps\n\n- This attack abuses a legitimate mechanism of Active Directory, so it is important to determine whether the activity is legitimate and the administrator is authorized to perform this operation.\n- Retrieve the contents of the `ScheduledTasks.xml` file, and check the `<Command>` and `<Arguments>` XML tags for any potentially malicious commands or binaries.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Scope which objects may be compromised by retrieving information about which objects are controlled by the GPO.\n\n### False positive analysis\n\n- Verify if the execution is legitimately authorized and executed under a change management process.\n\n### Related rules\n\n- Group Policy Abuse for Privilege Addition - b9554892-5e0e-424b-83a0-5aef95aa43bf\n- Scheduled Task Execution at Scale via GPO - 15a8ba77-1c13-4274-88fe-6bd14133861e\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- The investigation and containment must be performed in every computer controlled by the GPO, where necessary.\n- Remove the script from the GPO.\n- Check if other GPOs have suspicious scripts attached.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 211,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Data Source: Active Directory",
          "Resources: Investigation Guide",
          "Use Case: Active Directory Monitoring",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Legitimate Administrative Activity"
        ],
        "references": [
          "https://github.com/atc-project/atc-data/blob/master/docs/Logging_Policies/LP_0025_windows_audit_directory_service_changes.md",
          "https://github.com/atc-project/atc-data/blob/f2bbb51ecf68e2c9f488e3c70dcdd3df51d2a46b/docs/Logging_Policies/LP_0029_windows_audit_detailed_file_share.md",
          "https://labs.f-secure.com/tools/sharpgpoabuse"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1484",
                "name": "Domain or Tenant Policy Modification",
                "reference": "https://attack.mitre.org/techniques/T1484/",
                "subtechnique": [
                  {
                    "id": "T1484.001",
                    "name": "Group Policy Modification",
                    "reference": "https://attack.mitre.org/techniques/T1484/001/"
                  }
                ]
              },
              {
                "id": "T1547",
                "name": "Boot or Logon Autostart Execution",
                "reference": "https://attack.mitre.org/techniques/T1547/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'Audit Detailed File Share' audit policy must be configured (Success Failure).\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nPolicies >\nWindows Settings >\nSecurity Settings >\nAdvanced Audit Policies Configuration >\nAudit Policies >\nObject Access >\nAudit Detailed File Share (Success,Failure)\n```\n\nThe 'Audit Directory Service Changes' audit policy must be configured (Success Failure).\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nPolicies >\nWindows Settings >\nSecurity Settings >\nAdvanced Audit Policies Configuration >\nAudit Policies >\nDS Access >\nAudit Directory Service Changes (Success,Failure)\n```\n",
        "related_integrations": [
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.code",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.event_data.AccessList",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "winlog.event_data.AttributeLDAPDisplayName",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "winlog.event_data.AttributeValue",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "winlog.event_data.RelativeTargetName",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "winlog.event_data.ShareName",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "a8190501-dd66-4011-b384-450d40c35ea9",
        "rule_id": "16fac1a1-21ee-4ca6-b720-458e3855d046",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:38.454Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:24.385Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "any where host.os.type == \"windows\" and event.code in (\"5136\", \"5145\") and\n(\n  (\n    winlog.event_data.AttributeLDAPDisplayName : (\n      \"gPCMachineExtensionNames\",\n      \"gPCUserExtensionNames\"\n    ) and\n    winlog.event_data.AttributeValue : \"*42B5FAAE-6536-11D2-AE5A-0000F87571E3*\" and\n    winlog.event_data.AttributeValue : (\n      \"*40B66650-4972-11D1-A7CA-0000F87571E3*\",\n      \"*40B6664F-4972-11D1-A7CA-0000F87571E3*\"\n    )\n  ) or\n  (\n    winlog.event_data.ShareName : \"\\\\\\\\*\\\\SYSVOL\" and\n    winlog.event_data.RelativeTargetName : (\"*\\\\scripts.ini\", \"*\\\\psscripts.ini\") and\n    winlog.event_data.AccessList:\"*%%4417*\"\n  )\n)",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-system.*",
          "logs-windows.*"
        ],
        "filters": []
      },
      {
        "name": "Possible Consent Grant Attack via Azure-Registered Application",
        "description": "Detects when a user grants permissions to an Azure-registered application or when an administrator grants tenant-wide permissions to an application. An adversary may create an Azure-registered application that requests access to data such as contact information, email, or documents.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Possible Consent Grant Attack via Azure-Registered Application\n\nIn an illicit consent grant attack, the attacker creates an Azure-registered application that requests access to data such as contact information, email, or documents. The attacker then tricks an end user into granting that application consent to access their data either through a phishing attack, or by injecting illicit code into a trusted website. After the illicit application has been granted consent, it has account-level access to data without the need for an organizational account. Normal remediation steps like resetting passwords for breached accounts or requiring multi-factor authentication (MFA) on accounts are not effective against this type of attack, since these are third-party applications and are external to the organization.\n\nOfficial Microsoft guidance for detecting and remediating this attack can be found [here](https://docs.microsoft.com/en-us/microsoft-365/security/office-365-security/detect-and-remediate-illicit-consent-grants).\n\n#### Possible investigation steps\n\n- From the Azure AD portal, Review the application that was granted permissions:\n  - Click on the `Review permissions` button on the `Permissions` blade of the application.\n  - An app should require only permissions related to the app's purpose. If that's not the case, the app might be risky.\n  - Apps that require high privileges or admin consent are more likely to be risky.\n- Investigate the app and the publisher. The following characteristics can indicate suspicious apps:\n  -  A low number of downloads.\n  -  Low rating or score or bad comments.\n  -  Apps with a suspicious publisher or website.\n  -  Apps whose last update is not recent. This might indicate an app that is no longer supported.\n- Export and examine the [Oauth app auditing](https://docs.microsoft.com/en-us/defender-cloud-apps/manage-app-permissions#oauth-app-auditing) to identify users affected.\n\n### False positive analysis\n\n- This mechanism can be used legitimately. Malicious applications abuse the same workflow used by legitimate apps. Thus, analysts must review each app consent to ensure that only desired apps are granted access.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Identify the possible impact of the incident and prioritize accordingly; the following actions can help you gain context:\n    - Identify the account role in the cloud environment.\n    - Assess the criticality of affected services and servers.\n    - Work with your IT team to identify and minimize the impact on users.\n    - Identify if the attacker is moving laterally and compromising other accounts, servers, or services.\n    - Identify any regulatory or legal ramifications related to this activity.\n- Disable the malicious application to stop user access and the application access to your data.\n- Revoke the application Oauth consent grant. The `Remove-AzureADOAuth2PermissionGrant` cmdlet can be used to complete this task.\n- Remove the service principal application role assignment. The `Remove-AzureADServiceAppRoleAssignment` cmdlet can be used to complete this task.\n- Revoke the refresh token for all users assigned to the application. Azure provides a [playbook](https://github.com/Azure/Azure-Sentinel/tree/master/Playbooks/Revoke-AADSignInSessions) for this task.\n- [Report](https://docs.microsoft.com/en-us/defender-cloud-apps/manage-app-permissions#send-feedback) the application as malicious to Microsoft.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords or delete API keys as needed to revoke the attacker's access to the environment. Work with your IT teams to minimize the impact on business operations during these actions.\n- Investigate the potential for data compromise from the user's email and file sharing services. Activate your Data Loss incident response playbook.\n- Disable the permission for a user to set consent permission on their behalf.\n  - Enable the [Admin consent request](https://docs.microsoft.com/en-us/azure/active-directory/manage-apps/configure-admin-consent-workflow) feature.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).",
        "output_index": "",
        "version": 213,
        "tags": [
          "Domain: Cloud",
          "Data Source: Azure",
          "Data Source: Microsoft 365",
          "Use Case: Identity and Access Audit",
          "Resources: Investigation Guide",
          "Tactic: Initial Access"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-1500s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://docs.microsoft.com/en-us/microsoft-365/security/office-365-security/detect-and-remediate-illicit-consent-grants?view=o365-worldwide",
          "https://www.cloud-architekt.net/detection-and-mitigation-consent-grant-attacks-azuread/",
          "https://docs.microsoft.com/en-us/defender-cloud-apps/investigate-risky-oauth#how-to-detect-risky-oauth-apps"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1566",
                "name": "Phishing",
                "reference": "https://attack.mitre.org/techniques/T1566/",
                "subtechnique": [
                  {
                    "id": "T1566.002",
                    "name": "Spearphishing Link",
                    "reference": "https://attack.mitre.org/techniques/T1566/002/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1528",
                "name": "Steal Application Access Token",
                "reference": "https://attack.mitre.org/techniques/T1528/"
              }
            ]
          }
        ],
        "setup": "The Azure Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "azure",
            "version": "^1.0.0",
            "integration": "activitylogs"
          },
          {
            "package": "azure",
            "version": "^1.0.0"
          },
          {
            "package": "o365",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "azure.activitylogs.operation_name",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "azure.auditlogs.operation_name",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "ad817516-a49e-44c3-aaae-d4371ddc8ef8",
        "rule_id": "1c6a8c7a-5cb6-4a82-ba27-d5a5b8a40a38",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:38.456Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:25.772Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-azure*",
          "logs-o365*"
        ],
        "filters": [],
        "query": "event.dataset:(azure.activitylogs or azure.auditlogs or o365.audit) and\n  (\n    azure.activitylogs.operation_name:\"Consent to application\" or\n    azure.auditlogs.operation_name:\"Consent to application\" or \n    event.action:\"Consent to application.\"\n  ) and\n  event.outcome:(Success or success)",
        "language": "kuery"
      },
      {
        "name": "New GitHub App Installed",
        "description": "This rule detects when a new GitHub App has been installed in your organization account. GitHub Apps extend GitHub's functionality both within and outside of GitHub. When an app is installed it is granted permissions to read or modify your repository and organization data. Only trusted apps should be installed and any newly installed apps should be investigated to verify their legitimacy. Unauthorized app installation could lower your organization's security posture and leave you exposed for future attacks.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 204,
        "tags": [
          "Domain: Cloud",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Data Source: Github"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1072",
                "name": "Software Deployment Tools",
                "reference": "https://attack.mitre.org/techniques/T1072/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "github",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "2454b041-6ef6-49c0-ae8c-ae6f3bea81dd",
        "rule_id": "1ca62f14-4787-4913-b7af-df11745a49da",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:38.459Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:25.786Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "configuration where event.dataset == \"github.audit\" and event.action == \"integration_installation.create\"",
        "language": "eql",
        "index": [
          "logs-github.audit-*"
        ],
        "filters": []
      },
      {
        "name": "Incoming Execution via WinRM Remote Shell",
        "description": "Identifies remote execution via Windows Remote Management (WinRM) remote shell on a target host. This could be an indication of lateral movement.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 208,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Lateral Movement",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "WinRM is a dual-use protocol that can be used for benign or malicious activity. It's important to baseline your environment to determine the amount of noise to expect from this tool."
        ],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1021",
                "name": "Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1021/",
                "subtechnique": [
                  {
                    "id": "T1021.006",
                    "name": "Windows Remote Management",
                    "reference": "https://attack.mitre.org/techniques/T1021/006/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.port",
            "type": "long",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "network.direction",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "network.protocol",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pid",
            "type": "long",
            "ecs": true
          },
          {
            "name": "source.ip",
            "type": "ip",
            "ecs": true
          }
        ],
        "id": "f78f7325-c8c1-4cae-974e-376aa8b2c7c5",
        "rule_id": "1cd01db9-be24-4bef-8e7c-e923f0ff78ab",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:38.462Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:25.791Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by host.id with maxspan=30s\n   [network where host.os.type == \"windows\" and process.pid == 4 and network.direction : (\"incoming\", \"ingress\") and\n    destination.port in (5985, 5986) and network.protocol == \"http\" and source.ip != \"127.0.0.1\" and source.ip != \"::1\"]\n   [process where host.os.type == \"windows\" and \n    event.type == \"start\" and process.parent.name : \"winrshost.exe\" and not process.executable : \"?:\\\\Windows\\\\System32\\\\conhost.exe\"]",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-endpoint.events.network-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "Remote File Download via Script Interpreter",
        "description": "Identifies built-in Windows script interpreters (cscript.exe or wscript.exe) being used to download an executable file from a remote destination.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Remote File Download via Script Interpreter\n\nThe Windows Script Host (WSH) is a Windows automation technology, which is ideal for non-interactive scripting needs, such as logon scripting, administrative scripting, and machine automation.\n\nAttackers commonly use WSH scripts as their initial access method, acting like droppers for second stage payloads, but can also use them to download tools and utilities needed to accomplish their goals.\n\nThis rule looks for DLLs and executables downloaded using `cscript.exe` or `wscript.exe`.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze both the script and the executable involved using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n### False positive analysis\n\n- The usage of these script engines by regular users is unlikely. In the case of authorized benign true positives (B-TPs), exceptions can be added.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 210,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Command and Control",
          "Tactic: Execution",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            },
            "technique": [
              {
                "id": "T1105",
                "name": "Ingress Tool Transfer",
                "reference": "https://attack.mitre.org/techniques/T1105/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.005",
                    "name": "Visual Basic",
                    "reference": "https://attack.mitre.org/techniques/T1059/005/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "network.direction",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "network.protocol",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "network.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "8e4334b6-ba1d-4ad1-a107-6e93cdd5a99e",
        "rule_id": "1d276579-3380-4095-ad38-e596a01bc64f",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:38.464Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:25.806Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by host.id, process.entity_id\n  [network where host.os.type == \"windows\" and process.name : (\"wscript.exe\", \"cscript.exe\") and network.protocol != \"dns\" and\n   network.direction : (\"outgoing\", \"egress\") and network.type == \"ipv4\" and destination.ip != \"127.0.0.1\"\n  ]\n  [file where host.os.type == \"windows\" and event.type == \"creation\" and file.extension : (\"exe\", \"dll\")]",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.network-*",
          "logs-endpoint.events.file-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "Execution of File Written or Modified by PDF Reader",
        "description": "Identifies a suspicious file that was written by a PDF reader application and subsequently executed. These processes are often launched via exploitation of PDF applications.",
        "risk_score": 73,
        "severity": "high",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Execution of File Written or Modified by PDF Reader\n\nPDF is a common file type used in corporate environments and most machines have software to handle these files. This creates a vector where attackers can exploit the engines and technology behind this class of software for initial access or privilege escalation.\n\nThis rule searches for executable files written by PDF reader software and executed in sequence. This is most likely the result of exploitation for privilege escalation or initial access. This rule can also detect suspicious processes masquerading as PDF readers.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Retrieve the PDF documents received and opened by the user that could cause this behavior. Common locations include, but are not limited to, the Downloads and Document folders and the folder configured at the email client.\n- Determine if the collected files are malicious:\n  - Use a private sandboxed malware analysis system to perform analysis.\n    - Observe and collect information about the following activities:\n      - Attempts to contact external domains and addresses.\n      - File and registry access, modification, and creation activities.\n      - Service creation and launch activities.\n      - Scheduled task creation.\n  - Use the PowerShell `Get-FileHash` cmdlet to get the files' SHA-256 hash values.\n    - Search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n  - If the malicious file was delivered via phishing:\n    - Block the email sender from sending future emails.\n    - Block the malicious web pages.\n    - Remove emails from the sender from mailboxes.\n    - Consider improvements to the security awareness program.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 208,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7200s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            }
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1566",
                "name": "Phishing",
                "reference": "https://attack.mitre.org/techniques/T1566/",
                "subtechnique": [
                  {
                    "id": "T1566.001",
                    "name": "Spearphishing Attachment",
                    "reference": "https://attack.mitre.org/techniques/T1566/001/"
                  },
                  {
                    "id": "T1566.002",
                    "name": "Spearphishing Link",
                    "reference": "https://attack.mitre.org/techniques/T1566/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "106c390b-96a5-47ec-b8e4-f9b940138be9",
        "rule_id": "1defdd62-cd8d-426e-a246-81a37751bb2b",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:38.467Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:25.824Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence with maxspan=2h\n  [file where host.os.type == \"windows\" and event.type != \"deletion\" and file.extension : \"exe\" and\n     (process.name : \"AcroRd32.exe\" or\n      process.name : \"rdrcef.exe\" or\n      process.name : \"FoxitPhantomPDF.exe\" or\n      process.name : \"FoxitReader.exe\") and\n     not (file.name : \"FoxitPhantomPDF.exe\" or\n          file.name : \"FoxitPhantomPDFUpdater.exe\" or\n          file.name : \"FoxitReader.exe\" or\n          file.name : \"FoxitReaderUpdater.exe\" or\n          file.name : \"AcroRd32.exe\" or\n          file.name : \"rdrcef.exe\")\n  ] by host.id, file.path\n  [process where host.os.type == \"windows\" and event.type == \"start\"] by host.id, process.executable",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "logs-endpoint.events.file-*",
          "winlogbeat-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "Potential Linux Hack Tool Launched",
        "description": "Monitors for the execution of different processes that might be used by attackers for malicious intent. An alert from this rule should be investigated further, as hack tools are commonly used by blue teamers and system administrators as well.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 4,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Auditd Manager"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            }
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows\nthe Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest to select \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "auditd_manager",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "8eaacda2-0993-4d12-97fe-ddc23b09b117",
        "rule_id": "1df1152b-610a-4f48-9d7a-504f6ee5d9da",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:38.470Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:25.829Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and\nevent.action in (\"exec\", \"exec_event\", \"executed\", \"process_started\") and\nprocess.name in~ (\n  // exploitation frameworks\n  \"crackmapexec\", \"msfconsole\", \"msfvenom\", \"sliver-client\", \"sliver-server\", \"havoc\",\n  // network scanners (nmap left out to reduce noise)\n  \"zenmap\", \"nuclei\", \"netdiscover\", \"legion\",\n  // web enumeration\n  \"gobuster\", \"dirbuster\", \"dirb\", \"wfuzz\", \"ffuf\", \"whatweb\", \"eyewitness\",\n  // web vulnerability scanning\n  \"wpscan\", \"joomscan\", \"droopescan\", \"nikto\", \n  // exploitation tools\n  \"sqlmap\", \"commix\", \"yersinia\",\n  // cracking and brute forcing\n  \"john\", \"hashcat\", \"hydra\", \"ncrack\", \"cewl\", \"fcrackzip\", \"rainbowcrack\",\n  // host and network\n  \"linenum.sh\", \"linpeas.sh\", \"pspy32\", \"pspy32s\", \"pspy64\", \"pspy64s\", \"binwalk\", \"evil-winrm\",\n  \"linux-exploit-suggester-2.pl\", \"linux-exploit-suggester.sh\", \"panix.sh\"\n)",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*",
          "auditbeat-*",
          "logs-auditd_manager.auditd-*"
        ],
        "filters": []
      },
      {
        "name": "Creation of a DNS-Named Record",
        "description": "Active Directory Integrated DNS (ADIDNS) is one of the core components of AD DS, leveraging AD's access control and replication to maintain domain consistency. It stores DNS zones as AD objects, a feature that, while robust, introduces some security issues because of the default permission (Any authenticated users) to create DNS-named records. Attackers can perform Dynamic Spoofing attacks, where they monitor LLMNR/NBT-NS requests and create DNS-named records to target systems that are requested from multiple systems. They can also create specific records to target specific services, such as wpad, for spoofing attacks.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 103,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Data Source: Active Directory",
          "Use Case: Active Directory Monitoring",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.netspi.com/blog/technical/network-penetration-testing/adidns-revisited/",
          "https://www.thehacker.recipes/a-d/movement/mitm-and-coerced-authentications/wpad-spoofing"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1557",
                "name": "Adversary-in-the-Middle",
                "reference": "https://attack.mitre.org/techniques/T1557/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'Audit Directory Service Changes' logging policy must be configured for (Success, Failure).\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nPolicies >\nWindows Settings >\nSecurity Settings >\nAdvanced Audit Policies Configuration >\nAudit Policies >\nDS Access >\nAudit Directory Service Changes (Success,Failure)\n```\n\nThe above policy does not cover the target object by default (we still need it to be configured to generate events), so we need to set up an AuditRule using https://github.com/OTRF/Set-AuditRule.\n\n```\nSet-AuditRule -AdObjectPath 'AD:\\CN=MicrosoftDNS,DC=DomainDNSZones,DC=Domain,DC=com' -WellKnownSidType WorldSid -Rights CreateChild -InheritanceFlags Descendents -AttributeGUID e0fa1e8c-9b45-11d0-afdd-00c04fd930c9 -AuditFlags Success\n```\n",
        "related_integrations": [
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.code",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.event_data.ObjectClass",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "winlog.event_data.SubjectUserName",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "5368b485-53c3-4809-8ecc-54e462490407",
        "rule_id": "1e1b2e7e-b8f5-45e5-addc-66cc1224ffbc",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:38.472Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:25.838Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "any where host.os.type == \"windows\" and event.action in (\"Directory Service Changes\", \"directory-service-object-modified\") and\n    event.code == \"5137\" and winlog.event_data.ObjectClass == \"dnsNode\" and\n    not winlog.event_data.SubjectUserName : \"*$\"",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-system.*",
          "logs-windows.*"
        ],
        "filters": []
      },
      {
        "name": "Creation of SettingContent-ms Files",
        "description": "Identifies the suspicious creation of SettingContents-ms files, which have been used in attacks to achieve code execution while evading defenses.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 106,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Data Source: Elastic Defend",
          "Rule Type: BBR",
          "Data Source: Sysmon",
          "Data Source: Elastic Endgame"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://posts.specterops.io/the-tale-of-settingcontent-ms-files-f1ea253e4d39"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1204",
                "name": "User Execution",
                "reference": "https://attack.mitre.org/techniques/T1204/",
                "subtechnique": [
                  {
                    "id": "T1204.002",
                    "name": "Malicious File",
                    "reference": "https://attack.mitre.org/techniques/T1204/002/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1566",
                "name": "Phishing",
                "reference": "https://attack.mitre.org/techniques/T1566/",
                "subtechnique": [
                  {
                    "id": "T1566.001",
                    "name": "Spearphishing Attachment",
                    "reference": "https://attack.mitre.org/techniques/T1566/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "303cc523-7cca-48f4-a434-2081a1e49701",
        "rule_id": "1e6363a6-3af5-41d4-b7ea-d475389c0ceb",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:38.475Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:25.843Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"windows\" and event.type == \"creation\" and\n  file.extension : \"settingcontent-ms\" and\n  not file.path : (\n    \"?:\\\\*\\\\AppData\\\\Local\\\\Packages\\\\windows.immersivecontrolpanel_*\\\\LocalState\\\\Indexed\\\\Settings\\\\*\",\n    \"\\\\Device\\\\HarddiskVolume*\\\\Windows\\\\WinSxS\\\\amd64_microsoft-windows-s..*\\\\*.settingcontent-ms\"\n  )",
        "language": "eql",
        "index": [
          "logs-endpoint.events.file-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "winlogbeat-*"
        ],
        "filters": []
      },
      {
        "name": "First Occurrence of Private Repo Event from Specific GitHub Personal Access Token (PAT)",
        "description": "Detects a new private repo interaction for a GitHub PAT not seen in the last 14 days.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 204,
        "tags": [
          "Domain: Cloud",
          "Use Case: Threat Detection",
          "Use Case: UEBA",
          "Tactic: Execution",
          "Rule Type: BBR",
          "Data Source: Github"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1648",
                "name": "Serverless Execution",
                "reference": "https://attack.mitre.org/techniques/T1648/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "github",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "github.hashed_token",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "github.programmatic_access_type",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "github.repo",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "github.repository_public",
            "type": "boolean",
            "ecs": false
          }
        ],
        "id": "6a8b0caa-5248-4ba9-8e5e-d87dbe3d2e0a",
        "rule_id": "1e9b271c-8caa-4e20-aed8-e91e34de9283",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:38.478Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:25.847Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "event.dataset:\"github.audit\" and event.category:\"configuration\" and\ngithub.repo:* and github.hashed_token:* and\ngithub.programmatic_access_type:(\"OAuth access token\" or \"Fine-grained personal access token\") and \ngithub.repository_public:false",
        "new_terms_fields": [
          "github.hashed_token",
          "github.repo"
        ],
        "history_window_start": "now-14d",
        "index": [
          "logs-github.audit-*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Unusual Process Execution on WBEM Path",
        "description": "Identifies unusual processes running from the WBEM path, uncommon outside WMI-related Windows processes.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 104,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend",
          "Rule Type: BBR",
          "Data Source: Elastic Endgame",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1036",
                "name": "Masquerading",
                "reference": "https://attack.mitre.org/techniques/T1036/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "8025169f-ffbf-41a5-acff-003ec945ea00",
        "rule_id": "1f460f12-a3cf-4105-9ebb-f788cc63f365",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:38.480Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:25.866Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.executable : (\"?:\\\\Windows\\\\System32\\\\wbem\\\\*\", \"?:\\\\Windows\\\\SysWow64\\\\wbem\\\\*\") and\n  not process.name : (\n    \"mofcomp.exe\",\n    \"scrcons.exe\",\n    \"unsecapp.exe\",\n    \"wbemtest.exe\",\n    \"winmgmt.exe\",\n    \"wmiadap.exe\",\n    \"wmiapsrv.exe\",\n    \"wmic.exe\",\n    \"wmiprvse.exe\"\n  )",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "logs-system.security*",
          "winlogbeat-*",
          "logs-windows.*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "LSASS Memory Dump Handle Access",
        "description": "Identifies handle requests for the Local Security Authority Subsystem Service (LSASS) object access with specific access masks that many tools with a capability to dump memory to disk use (0x1fffff, 0x1010, 0x120089). This rule is tool agnostic as it has been validated against a host of various LSASS dump tools such as SharpDump, Procdump, Mimikatz, Comsvcs etc. It detects this behavior at a low level and does not depend on a specific tool or dump file name.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating LSASS Memory Dump Handle Access\n\nLocal Security Authority Server Service (LSASS) is a process in Microsoft Windows operating systems that is responsible for enforcing security policy on the system. It verifies users logging on to a Windows computer or server, handles password changes, and creates access tokens.\n\nAdversaries may attempt to access credential material stored in LSASS process memory. After a user logs on, the system generates and stores a variety of credential materials in LSASS process memory. This is meant to facilitate single sign-on (SSO) ensuring a user isn’t prompted each time resource access is requested. These credential materials can be harvested by an adversary using administrative user or SYSTEM privileges to conduct lateral movement using [alternate authentication material](https://attack.mitre.org/techniques/T1550/).\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the process executable using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n\n### False positive analysis\n\n- There should be very few or no false positives for this rule. If this activity is expected or noisy in your environment, consider adding exceptions — preferably with a combination of user and command line conditions.\n- If the process is related to antivirus or endpoint detection and response solutions, validate that it is installed on the correct path and signed with the company's valid digital signature.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Scope compromised credentials and disable the accounts.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 211,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Resources: Investigation Guide",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4656",
          "https://twitter.com/jsecurity101/status/1227987828534956033?s=20",
          "https://attack.mitre.org/techniques/T1003/001/",
          "https://threathunterplaybook.com/notebooks/windows/06_credential_access/WIN-170105221010.html",
          "http://findingbad.blogspot.com/2017/",
          "https://www.elastic.co/security-labs/detect-credential-access"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1003",
                "name": "OS Credential Dumping",
                "reference": "https://attack.mitre.org/techniques/T1003/",
                "subtechnique": [
                  {
                    "id": "T1003.001",
                    "name": "LSASS Memory",
                    "reference": "https://attack.mitre.org/techniques/T1003/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nEnsure advanced audit policies for Windows are enabled, specifically:\nObject Access policies [Event ID 4656](https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4656) (Handle to an Object was Requested)\n\n```\nComputer Configuration >\nPolicies >\nWindows Settings >\nSecurity Settings >\nAdvanced Audit Policies Configuration >\nSystem Audit Policies >\nObject Access >\nAudit File System (Success,Failure)\nAudit Handle Manipulation (Success,Failure)\n```\n\nAlso, this event generates only if the object’s [SACL](https://docs.microsoft.com/en-us/windows/win32/secauthz/access-control-lists) has the required access control entry (ACE) to handle the use of specific access rights.\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.code",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.event_data.AccessMask",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "winlog.event_data.AccessMaskDescription",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "winlog.event_data.ObjectName",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "winlog.event_data.ProcessName",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "78e2c48b-bb55-45ec-be49-658c5563cd07",
        "rule_id": "208dbe77-01ed-4954-8d44-1e5751cb20de",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:38.483Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:25.898Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "any where event.action == \"File System\" and event.code == \"4656\" and\n\n    winlog.event_data.ObjectName : (\n        \"?:\\\\Windows\\\\System32\\\\lsass.exe\",\n        \"\\\\Device\\\\HarddiskVolume?\\\\Windows\\\\System32\\\\lsass.exe\",\n        \"\\\\Device\\\\HarddiskVolume??\\\\Windows\\\\System32\\\\lsass.exe\") and\n\n    /* The right to perform an operation controlled by an extended access right. */\n\n    (winlog.event_data.AccessMask : (\"0x1fffff\" , \"0x1010\", \"0x120089\", \"0x1F3FFF\") or\n     winlog.event_data.AccessMaskDescription : (\"READ_CONTROL\", \"Read from process memory\"))\n\n     /* Common Noisy False Positives */\n\n    and not winlog.event_data.ProcessName : (\n        \"?:\\\\Program Files\\\\*.exe\",\n        \"?:\\\\Program Files (x86)\\\\*.exe\",\n        \"?:\\\\Windows\\\\system32\\\\wbem\\\\WmiPrvSE.exe\",\n        \"?:\\\\Windows\\\\System32\\\\dllhost.exe\",\n        \"?:\\\\Windows\\\\System32\\\\svchost.exe\",\n        \"?:\\\\Windows\\\\System32\\\\msiexec.exe\",\n        \"?:\\\\ProgramData\\\\Microsoft\\\\Windows Defender\\\\*.exe\",\n        \"?:\\\\Windows\\\\explorer.exe\",\n        \"?:\\\\Windows\\\\System32\\\\poqexec.exe\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-system.*",
          "logs-windows.*"
        ],
        "filters": []
      },
      {
        "name": "New GitHub Owner Added",
        "description": "Detects when a new member is added to a GitHub organization as an owner. This role provides admin level privileges. Any new owner roles should be investigated to determine it's validity. Unauthorized owner roles could indicate compromise within your organization and provide unlimited access to data and settings.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Cloud",
          "Use Case: Threat Detection",
          "Use Case: UEBA",
          "Tactic: Persistence",
          "Data Source: Github"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1136",
                "name": "Create Account",
                "reference": "https://attack.mitre.org/techniques/T1136/",
                "subtechnique": [
                  {
                    "id": "T1136.003",
                    "name": "Cloud Account",
                    "reference": "https://attack.mitre.org/techniques/T1136/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "github",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "github.permission",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "fc3d97ee-5e41-45dd-9829-099beb216125",
        "rule_id": "24401eca-ad0b-4ff9-9431-487a8e183af9",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:38.488Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:25.950Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "iam where event.dataset == \"github.audit\" and event.action == \"org.add_member\" and github.permission == \"admin\"",
        "language": "eql",
        "index": [
          "logs-github.audit-*"
        ],
        "filters": []
      },
      {
        "name": "Kernel Module Load via insmod",
        "description": "Detects the use of the insmod binary to load a Linux kernel object file. Threat actors can use this binary, given they have root privileges, to load a rootkit on a system providing them with complete control and the ability to hide from security products. Manually loading a kernel module in this manner should not be at all common and can indicate suspcious or malicious behavior.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Kernel module load via insmod\n\nThe insmod binary is a Linux utility that allows users with root privileges to load kernel modules, which are object files that extend the functionality of the kernel. \n\nThreat actors can abuse this utility to load rootkits, granting them full control over the system and the ability to evade security products.\n\nThe detection rule 'Kernel module load via insmod' is designed to identify instances where the insmod binary is used to load a kernel object file (with a .ko extension) on a Linux system. This activity is uncommon and may indicate suspicious or malicious behavior.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n> This investigation guide uses [placeholder fields](https://www.elastic.co/guide/en/security/current/osquery-placeholder-fields.html) to dynamically pass alert data into Osquery queries. Placeholder fields were introduced in Elastic Stack version 8.7.0. If you're using Elastic Stack version 8.6.0 or earlier, you'll need to manually adjust this investigation guide's queries to ensure they properly run.\n\n### Possible investigation steps\n\n- Investigate the kernel object file that was loaded via insmod.\n  - !{osquery{\"label\":\"Osquery - Retrieve Running Processes by User\",\"query\":\"SELECT pid, username, name FROM processes p JOIN users u ON u.uid = p.uid ORDER BY username\"}}\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence and whether they are located in expected locations.\n  - !{osquery{\"label\":\"Osquery - Retrieve Listening Ports\",\"query\":\"SELECT pid, address, port, socket, protocol, path FROM listening_ports\"}}\n- Investigate the kernel ring buffer for any warnings or messages, such as tainted or out-of-tree kernel module loads through `dmesg`.\n- Investigate syslog for any unusual segfaults or other messages. Rootkits may be installed on targets with different architecture as expected, and could potentially cause segmentation faults. \n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Validate the activity is not related to planned patches, updates, network administrator activity, or legitimate software installations.\n- Investigate whether the altered scripts call other malicious scripts elsewhere on the file system. \n  - If scripts or executables were dropped, retrieve the files and determine if they are malicious:\n    - Use a private sandboxed malware analysis system to perform analysis.\n      - Observe and collect information about the following activities:\n        - Attempts to contact external domains and addresses.\n          - Check if the domain is newly registered or unexpected.\n          - Check the reputation of the domain or IP address.\n        - File access, modification, and creation activities.\n- Investigate abnormal behaviors by the subject process/user such as network connections, file modifications, and any other spawned child processes.\n  - Investigate listening ports and open sockets to look for potential command and control traffic or data exfiltration.\n    - !{osquery{\"label\":\"Osquery - Retrieve Open Sockets\",\"query\":\"SELECT pid, family, remote_address, remote_port, socket, state FROM process_open_sockets\"}}\n    - !{osquery{\"label\":\"Osquery - Retrieve Information for a Specific User\",\"query\":\"SELECT * FROM users WHERE username = {{user.name}}\"}}\n  - Identify the user account that performed the action, analyze it, and check whether it should perform this kind of action.\n    - !{osquery{\"label\":\"Osquery - Investigate the Account Authentication Status\",\"query\":\"SELECT * FROM logged_in_users WHERE user = {{user.name}}\"}}\n- Investigate whether the user is currently logged in and active.\n    - $osquery_6\n\n### False positive analysis\n\n- If this activity is related to new benign software installation activity, consider adding exceptions — preferably with a combination of user and command line conditions.\n- If this activity is related to a system administrator who uses cron jobs for administrative purposes, consider adding exceptions for this specific administrator user account. \n- Try to understand the context of the execution by thinking about the user, machine, or business purpose. A small number of endpoints, such as servers with unique software, might appear unusual but satisfy a specific business need.\n\n### Related Rules\n\n- Kernel Driver Load - 3e12a439-d002-4944-bc42-171c0dcb9b96\n- Tainted Out-Of-Tree Kernel Module Load - 51a09737-80f7-4551-a3be-dac8ef5d181a\n- Tainted Kernel Module Load - 05cad2fb-200c-407f-b472-02ea8c9e5e4a\n- Attempt to Clear Kernel Ring Buffer - 2724808c-ba5d-48b2-86d2-0002103df753\n- Enumeration of Kernel Modules via Proc - 80084fa9-8677-4453-8680-b891d3c0c778\n- Suspicious Modprobe File Event - 40ddbcc8-6561-44d9-afc8-eefdbfe0cccd\n- Kernel Module Removal - cd66a5af-e34b-4bb0-8931-57d0a043f2ef\n- Enumeration of Kernel Modules - 2d8043ed-5bda-4caf-801c-c1feb7410504\n\n### Response and Remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Leverage the incident response data and logging to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 110,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Threat: Rootkit",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Auditd Manager"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://decoded.avast.io/davidalvarez/linux-threat-hunting-syslogk-a-kernel-rootkit-found-under-development-in-the-wild/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1547",
                "name": "Boot or Logon Autostart Execution",
                "reference": "https://attack.mitre.org/techniques/T1547/",
                "subtechnique": [
                  {
                    "id": "T1547.006",
                    "name": "Kernel Modules and Extensions",
                    "reference": "https://attack.mitre.org/techniques/T1547/006/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "auditd_manager",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "b356b279-0ab5-459f-a7c5-34f8d9baa452",
        "rule_id": "2339f03c-f53f-40fa-834b-40c5983fc41f",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:38.486Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:25.936Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and process.name == \"insmod\" and process.args : \"*.ko\" and\nnot process.parent.executable like (\n  \"/opt/ds_agent/*\", \"/usr/sbin/veeamsnap-loader\", \"/opt/TrendMicro/vls_agent/*\", \"/opt/intel/oneapi/*\",\n  \"/opt/commvault/Base/linux_drv\", \"/bin/falcoctl\"\n)",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*",
          "auditbeat-*",
          "logs-auditd_manager.auditd-*"
        ],
        "filters": []
      },
      {
        "name": "Network Activity Detected via Kworker",
        "description": "This rule monitors for network connections from a kworker process. kworker, or kernel worker, processes are part of the kernel's workqueue mechanism. They are responsible for executing work that has been scheduled to be done in kernel space, which might include tasks like handling interrupts, background activities, and other kernel-related tasks. Attackers may attempt to evade detection by masquerading as a kernel worker process.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 6,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Command and Control",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            }
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1014",
                "name": "Rootkit",
                "reference": "https://attack.mitre.org/techniques/T1014/"
              },
              {
                "id": "T1036",
                "name": "Masquerading",
                "reference": "https://attack.mitre.org/techniques/T1036/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0010",
              "name": "Exfiltration",
              "reference": "https://attack.mitre.org/tactics/TA0010/"
            },
            "technique": [
              {
                "id": "T1041",
                "name": "Exfiltration Over C2 Channel",
                "reference": "https://attack.mitre.org/techniques/T1041/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows\nthe Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest to select \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "destination.port",
            "type": "long",
            "ecs": true
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "1b8d4308-52fe-4950-9a64-212a4152eb34",
        "rule_id": "25d917c4-aa3c-4111-974c-286c0312ff95",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:38.491Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:25.959Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "host.os.type:linux and event.category:network and event.action:(connection_attempted or connection_accepted) and \nprocess.name:kworker* and not destination.ip:(\n  10.0.0.0/8 or\n  127.0.0.0/8 or\n  169.254.0.0/16 or\n  172.16.0.0/12 or\n  192.168.0.0/16 or\n  224.0.0.0/4 or\n  \"::1\" or\n  \"FE80::/10\" or\n  \"FF00::/8\"\n) and not destination.port:(\"2049\" or \"111\" or \"892\" or \"597\")",
        "new_terms_fields": [
          "process.name",
          "host.id"
        ],
        "history_window_start": "now-14d",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Potential Relay Attack against a Domain Controller",
        "description": "Identifies potential relay attacks against a domain controller (DC) by identifying authentication events using the domain controller computer account coming from other hosts to the DC that owns the account. Attackers may relay the DC hash after capturing it using forced authentication.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 102,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Data Source: Elastic Defend",
          "Data Source: Active Directory",
          "Use Case: Active Directory Monitoring",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/p0dalirius/windows-coerced-authentication-methods",
          "https://www.thehacker.recipes/a-d/movement/mitm-and-coerced-authentications",
          "https://attack.mitre.org/techniques/T1187/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1187",
                "name": "Forced Authentication",
                "reference": "https://attack.mitre.org/techniques/T1187/"
              },
              {
                "id": "T1557",
                "name": "Adversary-in-the-Middle",
                "reference": "https://attack.mitre.org/techniques/T1557/",
                "subtechnique": [
                  {
                    "id": "T1557.001",
                    "name": "LLMNR/NBT-NS Poisoning and SMB Relay",
                    "reference": "https://attack.mitre.org/techniques/T1557/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.code",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "host.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "source.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "user.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.event_data.AuthenticationPackageName",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "winlog.logon.type",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "64ea58f1-73f4-45c5-b989-6b8146e45c44",
        "rule_id": "263481c8-1e9b-492e-912d-d1760707f810",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:38.494Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:25.977Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "authentication where host.os.type == \"windows\" and event.code in (\"4624\", \"4625\") and endswith~(user.name, \"$\") and\n    winlog.event_data.AuthenticationPackageName : \"NTLM\" and winlog.logon.type : \"network\" and\n\n    /* Filter for a machine account that matches the hostname */\n    startswith~(host.name, substring(user.name, 0, -1)) and\n    \n    /* Verify if the Source IP belongs to the host */\n    not endswith(string(source.ip), string(host.ip)) and\n    source.ip != null and source.ip != \"::1\" and source.ip != \"127.0.0.1\"",
        "language": "eql",
        "index": [
          "logs-system.security-*",
          "logs-windows.forwarded*",
          "winlogbeat-*"
        ],
        "filters": []
      },
      {
        "name": "Incoming Execution via PowerShell Remoting",
        "description": "Identifies remote execution via Windows PowerShell remoting. Windows PowerShell remoting allows a user to run any Windows PowerShell command on one or more remote computers. This could be an indication of lateral movement.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 209,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Lateral Movement",
          "Tactic: Execution",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "PowerShell remoting is a dual-use protocol that can be used for benign or malicious activity. It's important to baseline your environment to determine the amount of noise to expect from this tool."
        ],
        "references": [
          "https://docs.microsoft.com/en-us/powershell/scripting/learn/remoting/running-remote-commands?view=powershell-7.1"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1021",
                "name": "Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1021/",
                "subtechnique": [
                  {
                    "id": "T1021.006",
                    "name": "Windows Remote Management",
                    "reference": "https://attack.mitre.org/techniques/T1021/006/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.port",
            "type": "long",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "network.direction",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "network.protocol",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "source.ip",
            "type": "ip",
            "ecs": true
          }
        ],
        "id": "9dada186-c52c-46e1-ad11-2e2b40e04f34",
        "rule_id": "2772264c-6fb9-4d9d-9014-b416eed21254",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:38.497Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:26.561Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by host.id with maxspan = 30s\n   [network where host.os.type == \"windows\" and network.direction : (\"incoming\", \"ingress\") and destination.port in (5985, 5986) and\n    network.protocol == \"http\" and source.ip != \"127.0.0.1\" and source.ip != \"::1\"]\n   [process where host.os.type == \"windows\" and \n    event.type == \"start\" and process.parent.name : \"wsmprovhost.exe\" and not process.executable : \"?:\\\\Windows\\\\System32\\\\conhost.exe\"]",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-endpoint.events.network-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "Account Password Reset Remotely",
        "description": "Identifies an attempt to reset a potentially privileged account password remotely. Adversaries may manipulate account passwords to maintain access or evade password duration policies and preserve compromised credentials.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "## Performance\nThis rule may cause medium to high performance impact due to logic scoping all remote Windows logon activity.\n",
        "output_index": "",
        "version": 216,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Tactic: Impact",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Legitimate remote account administration."
        ],
        "references": [
          "https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4724",
          "https://stealthbits.com/blog/manipulating-user-passwords-with-mimikatz/",
          "https://github.com/sbousseaden/EVTX-ATTACK-SAMPLES/blob/master/Credential%20Access/remote_pwd_reset_rpc_mimikatz_postzerologon_target_DC.evtx",
          "https://www.elastic.co/security-labs/detect-credential-access"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1098",
                "name": "Account Manipulation",
                "reference": "https://attack.mitre.org/techniques/T1098/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0040",
              "name": "Impact",
              "reference": "https://attack.mitre.org/tactics/TA0040/"
            },
            "technique": [
              {
                "id": "T1531",
                "name": "Account Access Removal",
                "reference": "https://attack.mitre.org/techniques/T1531/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "source.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "winlog.computer_name",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "winlog.event_data.SubjectLogonId",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "winlog.event_data.TargetLogonId",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "winlog.event_data.TargetSid",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "winlog.event_data.TargetUserName",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "winlog.logon.type",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "9b4a09c4-6af5-45a5-9f97-4113bd60416c",
        "rule_id": "2820c9c2-bcd7-4d6e-9eba-faf3891ba450",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:38.506Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:26.575Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by winlog.computer_name with maxspan=1m\n  [authentication where event.action == \"logged-in\" and\n    /* event 4624 need to be logged */\n    winlog.logon.type : \"Network\" and event.outcome == \"success\" and source.ip != null and\n    source.ip != \"127.0.0.1\" and source.ip != \"::1\" and\n    not winlog.event_data.TargetUserName : (\"svc*\", \"PIM_*\", \"_*_\", \"*-*-*\", \"*$\")] by winlog.event_data.TargetLogonId\n   /* event 4724 need to be logged */\n  [iam where event.action == \"reset-password\" and\n   (\n    /*\n       This rule is very noisy if not scoped to privileged accounts, duplicate the\n       rule and add your own naming convention and accounts of interest here.\n     */\n    winlog.event_data.TargetUserName: (\"*Admin*\", \"*super*\", \"*SVC*\", \"*DC0*\", \"*service*\", \"*DMZ*\", \"*ADM*\") or\n    winlog.event_data.TargetSid : (\"S-1-5-21-*-500\", \"S-1-12-1-*-500\")\n    )\n  ] by winlog.event_data.SubjectLogonId",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-system.security*",
          "logs-windows.forwarded*"
        ],
        "filters": []
      },
      {
        "name": "Account Discovery Command via SYSTEM Account",
        "description": "Identifies when the SYSTEM account uses an account discovery utility. This could be a sign of discovery activity after an adversary has achieved privilege escalation.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Account Discovery Command via SYSTEM Account\n\nAfter successfully compromising an environment, attackers may try to gain situational awareness to plan their next steps. This can happen by running commands to enumerate network resources, users, connections, files, and installed security software.\n\nThis rule looks for the execution of account discovery utilities using the SYSTEM account, which is commonly observed after attackers successfully perform privilege escalation or exploit web applications.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n  - If the process tree includes a web-application server process such as w3wp, httpd.exe, nginx.exe and alike, investigate any suspicious file creation or modification in the last 48 hours to assess the presence of any potential webshell backdoor.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Determine how the SYSTEM account is being used. For example, users with administrator privileges can spawn a system shell using Windows services, scheduled tasks or other third party utilities.\n\n### False positive analysis\n\n- Discovery activities are not inherently malicious if they occur in isolation. As long as the analyst did not identify suspicious activity related to the user or host, such alerts can be dismissed.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection via the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n- Use the data collected through the analysis to investigate other machines affected in the environment.\n",
        "output_index": "",
        "version": 211,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Tactic: Privilege Escalation",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1033",
                "name": "System Owner/User Discovery",
                "reference": "https://attack.mitre.org/techniques/T1033/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1078",
                "name": "Valid Accounts",
                "reference": "https://attack.mitre.org/techniques/T1078/",
                "subtechnique": [
                  {
                    "id": "T1078.003",
                    "name": "Local Accounts",
                    "reference": "https://attack.mitre.org/techniques/T1078/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.Ext.token.integrity_level_name",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.event_data.IntegrityLevel",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "b40d0acd-3042-4b0e-a28c-3372ccbbaf19",
        "rule_id": "2856446a-34e6-435b-9fb5-f8f040bfa7ed",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:38.509Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:26.584Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (?process.Ext.token.integrity_level_name : \"System\" or\n  ?winlog.event_data.IntegrityLevel : \"System\") and\n  (\n    process.name : \"whoami.exe\" or\n    (\n      process.name : \"net1.exe\" and not process.parent.name : \"net.exe\" and not process.args : (\"start\", \"stop\", \"/active:*\")\n    )\n  )",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "Sudo Command Enumeration Detected",
        "description": "This rule monitors for the usage of the sudo -l command, which is used to list the allowed and forbidden commands for the invoking user. Attackers may execute this command to enumerate commands allowed to be executed with sudo permissions, potentially allowing to escalate privileges to root.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 6,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1033",
                "name": "System Owner/User Discovery",
                "reference": "https://attack.mitre.org/techniques/T1033/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args_count",
            "type": "long",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "906bd9d8-49b2-47b7-9dce-b119f7e935d1",
        "rule_id": "28d39238-0c01-420a-b77a-24e5a7378663",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:38.512Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:26.598Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and \nprocess.name == \"sudo\" and process.args == \"-l\" and process.args_count == 2 and\nprocess.parent.name in (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\") and \nnot process.args == \"dpkg\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "AWS EC2 Security Group Configuration Change",
        "description": "Identifies a change to an AWS Security Group Configuration. A security group is like a virtual firewall, and modifying configurations may allow unauthorized access. Threat actors may abuse this to establish persistence, exfiltrate data, or pivot in an AWS environment.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "### Investigating AWS EC2 Security Group Configuration Change\n\nThis rule identifies any changes to an AWS Security Group, which functions as a virtual firewall controlling inbound and outbound traffic for resources like EC2 instances. Modifications to a security group configuration could expose critical assets to unauthorized access. Threat actors may exploit such changes to establish persistence, exfiltrate data, or pivot within an AWS environment.\n\n#### Possible Investigation Steps\n\n1. **Identify the Modified Security Group**:\n   - **Security Group ID**: Check the `aws.cloudtrail.flattened.request_parameters.groupId` field to identify the specific security group affected.\n   - **Rule Changes**: Review `aws.cloudtrail.flattened.response_elements.securityGroupRuleSet` to determine the new rules or configurations, including any added or removed IP ranges, protocol changes, and port specifications.\n\n2. **Review User Context**:\n   - **User Identity**: Inspect the `aws.cloudtrail.user_identity.arn` field to determine which user or role made the modification. Verify if this is an authorized administrator or a potentially compromised account.\n   - **Access Patterns**: Analyze whether this user regularly interacts with security group configurations or if this event is out of the ordinary for their account.\n\n3. **Analyze the Configuration Change**:\n   - **Egress vs. Ingress**: Determine if the change affected inbound (ingress) or outbound (egress) traffic by reviewing fields like `isEgress` in the `securityGroupRuleSet`. Unauthorized changes to outbound traffic can indicate data exfiltration attempts.\n   - **IP Ranges and Ports**: Assess any added IP ranges, especially `0.0.0.0/0`, which exposes resources to the internet. Port changes should also be evaluated to ensure only necessary ports are open.\n\n4. **Check User Agent and Source IP**:\n   - **User Agent Analysis**: Examine the `user_agent.original` field to identify the tool or application used, such as `AWS Console` or `Terraform`, which may reveal if the action was automated or manual.\n   - **Source IP and Geolocation**: Use `source.address` and `source.geo` fields to verify if the IP address and geolocation match expected locations for your organization. Unexpected IPs or regions may indicate unauthorized access.\n\n5. **Evaluate for Persistence Indicators**:\n   - **Repeated Changes**: Investigate if similar changes were recently made across multiple security groups, which may suggest an attempt to maintain or expand access.\n   - **Permissions Review**: Confirm that the user’s IAM policies are configured to limit changes to security groups only as necessary.\n\n6. **Correlate with Other CloudTrail Events**:\n   - **Cross-Reference Other Security Events**: Look for related actions like `AuthorizeSecurityGroupIngress`, `CreateSecurityGroup`, or `RevokeSecurityGroupIngress` that may indicate additional or preparatory steps for unauthorized access.\n   - **Monitor for IAM or Network Changes**: Check for IAM modifications, network interface changes, or other configuration updates in the same timeframe to detect broader malicious activities.\n\n### False Positive Analysis\n\n- **Routine Security Changes**: Security group modifications may be part of regular infrastructure maintenance. Verify if this action aligns with known, scheduled administrative activities.\n- **Automated Configuration Management**: If you are using automated tools like `Terraform` or `CloudFormation`, confirm if the change matches expected configuration drift corrections or deployments.\n\n### Response and Remediation\n\n- **Revert Unauthorized Changes**: If unauthorized, revert the security group configuration to its previous state to secure the environment.\n- **Restrict Security Group Permissions**: Remove permissions to modify security groups from any compromised or unnecessary accounts to limit future access.\n- **Quarantine Affected Resources**: If necessary, isolate any affected instances or resources to prevent further unauthorized activity.\n- **Audit IAM and Security Group Policies**: Regularly review permissions related to security groups to ensure least privilege access and prevent excessive access.\n\n### Additional Information\n\nFor more details on managing AWS Security Groups and best practices, refer to the [AWS EC2 Security Groups Documentation](https://docs.aws.amazon.com/AWSEC2/latest/WindowsGuide/ec2-security-groups.html) and AWS security best practices.\n",
        "output_index": "",
        "investigation_fields": {
          "field_names": [
            "@timestamp",
            "user.name",
            "aws.cloudtrail.user_identity.arn",
            "aws.cloudtrail.user_identity.type",
            "user_agent.original",
            "aws.cloudtrail.flattened.request_parameters.instanceId",
            "event.action",
            "event.outcome",
            "cloud.region",
            "event.provider",
            "aws.cloudtrail.request_parameters",
            "aws.cloudtrail.response_elements"
          ]
        },
        "version": 207,
        "tags": [
          "Domain: Cloud",
          "Data Source: AWS",
          "Data Source: Amazon Web Services",
          "Data Source: AWS EC2",
          "Use Case: Network Security Monitoring",
          "Resources: Investigation Guide",
          "Tactic: Persistence",
          "Tactic: Defense Evasion"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic",
          "Austin Songer"
        ],
        "false_positives": [
          "A security group may be created by a system or network administrator. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. Security group creations by unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule."
        ],
        "references": [
          "https://docs.aws.amazon.com/AWSEC2/latest/WindowsGuide/ec2-security-groups.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            }
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.007",
                    "name": "Disable or Modify Cloud Firewall",
                    "reference": "https://attack.mitre.org/techniques/T1562/007/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "aws",
            "version": "^2.0.0",
            "integration": "cloudtrail"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "15f77df9-edd4-4666-949d-ba01fb07f5a1",
        "rule_id": "29052c19-ff3e-42fd-8363-7be14d7c5469",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:38.515Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:26.617Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-aws.cloudtrail-*"
        ],
        "filters": [],
        "query": "event.dataset: \"aws.cloudtrail\"\n    and event.provider: \"ec2.amazonaws.com\"\n    and event.action:(\n            \"AuthorizeSecurityGroupEgress\" or\n            \"CreateSecurityGroup\" or\n            \"ModifyInstanceAttribute\" or\n            \"ModifySecurityGroupRules\" or\n            \"RevokeSecurityGroupEgress\" or\n            \"RevokeSecurityGroupIngress\")\n    and event.outcome: \"success\"",
        "language": "kuery"
      },
      {
        "name": "System Shells via Services",
        "description": "Windows services typically run as SYSTEM and can be used as a privilege escalation opportunity. Malware or penetration testers may run a shell as a service to gain SYSTEM permissions.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating System Shells via Services\n\nAttackers may configure existing services or create new ones to execute system shells to elevate their privileges from administrator to SYSTEM. They can also configure services to execute these shells with persistence payloads.\n\nThis rule looks for system shells being spawned by `services.exe`, which is compatible with the above behavior.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify how the service was created or modified. Look for registry changes events or Windows events related to service activities (for example, 4697 and/or 7045).\n  - Examine the created and existent services, the executables or drivers referenced, and command line arguments for suspicious entries.\n    - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n    - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n    - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the referenced files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n- Check for commands executed under the spawned shell.\n\n### False positive analysis\n\n- This activity should not happen legitimately. The security team should address any potential benign true positive (B-TP), as this configuration can put the user and the domain at risk.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Delete the service or restore it to the original configuration.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 415,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Tactic: Execution",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: SentinelOne",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: System",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1543",
                "name": "Create or Modify System Process",
                "reference": "https://attack.mitre.org/techniques/T1543/",
                "subtechnique": [
                  {
                    "id": "T1543.003",
                    "name": "Windows Service",
                    "reference": "https://attack.mitre.org/techniques/T1543/003/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  },
                  {
                    "id": "T1059.003",
                    "name": "Windows Command Shell",
                    "reference": "https://attack.mitre.org/techniques/T1059/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "9c74bd6a-287c-4a03-975f-b8e1aad1eaab",
        "rule_id": "0022d47d-39c7-4f69-a232-4fe9dc7a3acd",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:38.517Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:21.632Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.parent.name : \"services.exe\" and\n  process.name : (\"cmd.exe\", \"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\") and\n\n  /* Third party FP's */\n  not process.args : \"NVDisplay.ContainerLocalSystem\"",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.*",
          "endgame-*",
          "logs-system.security*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-m365_defender.event-*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "First Occurrence of GitHub User Interaction with Private Repo",
        "description": "Detects a new private repo interaction for a GitHub user not seen in the last 14 days.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 204,
        "tags": [
          "Domain: Cloud",
          "Use Case: Threat Detection",
          "Use Case: UEBA",
          "Tactic: Execution",
          "Rule Type: BBR",
          "Data Source: Github"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1648",
                "name": "Serverless Execution",
                "reference": "https://attack.mitre.org/techniques/T1648/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "github",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "github.repo",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "github.repository_public",
            "type": "boolean",
            "ecs": false
          },
          {
            "name": "user.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "d8af6a19-4d33-419a-b2e0-68499284bea7",
        "rule_id": "01c49712-25bc-49d2-a27d-d7ce52f5dc49",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:38.520Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:21.656Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "event.dataset:\"github.audit\" and event.category:\"configuration\" and\ngithub.repo:* and user.name:* and \ngithub.repository_public:false",
        "new_terms_fields": [
          "user.name",
          "github.repo"
        ],
        "history_window_start": "now-14d",
        "index": [
          "logs-github.audit-*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "First Occurrence of GitHub Repo Interaction From a New IP",
        "description": "Detects an interaction with a private GitHub repository from a new IP address not seen in the last 14 days.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 204,
        "tags": [
          "Domain: Cloud",
          "Use Case: Threat Detection",
          "Use Case: UEBA",
          "Tactic: Execution",
          "Rule Type: BBR",
          "Data Source: Github"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1648",
                "name": "Serverless Execution",
                "reference": "https://attack.mitre.org/techniques/T1648/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "github",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "github.actor_ip",
            "type": "ip",
            "ecs": false
          },
          {
            "name": "github.repo",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "github.repository_public",
            "type": "boolean",
            "ecs": false
          }
        ],
        "id": "38009e0d-342d-43cf-8096-a3fe9b0686e9",
        "rule_id": "0294f105-d7af-4a02-ae90-35f56763ffa2",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:38.523Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:21.668Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "event.dataset:\"github.audit\" and event.category:\"configuration\" and\ngithub.actor_ip:* and github.repo:* and \ngithub.repository_public:false",
        "new_terms_fields": [
          "github.repo",
          "github.actor_ip"
        ],
        "history_window_start": "now-14d",
        "index": [
          "logs-github.audit-*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Potential Credential Access via DuplicateHandle in LSASS",
        "description": "Identifies suspicious access to an LSASS handle via DuplicateHandle from an unknown call trace module. This may indicate an attempt to bypass the NtOpenProcess API to evade detection and dump LSASS memory for credential access.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 308,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/CCob/MirrorDump"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1003",
                "name": "OS Credential Dumping",
                "reference": "https://attack.mitre.org/techniques/T1003/",
                "subtechnique": [
                  {
                    "id": "T1003.001",
                    "name": "LSASS Memory",
                    "reference": "https://attack.mitre.org/techniques/T1003/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.code",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.event_data.CallTrace",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "winlog.event_data.GrantedAccess",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "991651ad-3007-444e-9d9b-a6cfb1c16d70",
        "rule_id": "02a4576a-7480-4284-9327-548a806b5e48",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:38.526Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:21.679Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.code == \"10\" and\n\n /* LSASS requesting DuplicateHandle access right to another process */\n process.name : \"lsass.exe\" and winlog.event_data.GrantedAccess == \"0x40\" and\n\n /* call is coming from an unknown executable region */\n winlog.event_data.CallTrace : \"*UNKNOWN*\"",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "Potential Memory Seeking Activity",
        "description": "Monitors for the execution of Unix utilities that may be leveraged as memory address seekers. Attackers may leverage built-in utilities to seek specific memory addresses, allowing for potential future manipulation/exploitation.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 3,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Rule Type: BBR",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/arget13/DDexec"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1057",
                "name": "Process Discovery",
                "reference": "https://attack.mitre.org/techniques/T1057/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "f335ccfd-c500-4a0c-aa7a-52c11b80eda0",
        "rule_id": "035a6f21-4092-471d-9cda-9e379f459b1e",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:38.529Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:21.698Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\") and (\n  (process.name == \"tail\" and process.args in (\"-c\", \"--bytes\")) or\n  (process.name == \"cmp\" and process.args == \"-i\") or\n  (process.name in (\"hexdump\", \"xxd\") and process.args == \"-s\") or\n  (process.name == \"dd\" and process.args : (\"skip*\", \"seek*\"))\n) and not (\n  process.parent.args like (\"/opt/error_monitor/error_monitor.sh\", \"printf*\") or\n  process.parent.name in (\"acme.sh\", \"dracut\", \"leapp\") or\n  process.parent.executable like (\n    \"/bin/cagefs_enter\", \"/opt/nessus_agent/sbin/nessus-service\", \"/usr/libexec/platform-python*\",\n    \"/usr/libexec/vdsm/vdsmd\", \"/usr/local/bin/docker-entrypoint.sh\", \"/usr/lib/module-init-tools/lsinitrd-quick\"\n  ) or\n  process.parent.command_line like \"sh*acme.sh*\" or\n  process.args like \"/var/tmp/dracut*\"\n)",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "Modification of OpenSSH Binaries",
        "description": "Adversaries may modify SSH related binaries for persistence or credential access by patching sensitive functions to enable unauthorized access or by logging SSH credentials for exfiltration.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Modification of OpenSSH Binaries\n\nOpenSSH is a widely used suite of secure networking utilities based on the Secure Shell (SSH) protocol, which provides encrypted communication sessions over a computer network.\n\nAdversaries may exploit OpenSSH by modifying its binaries, such as `/usr/bin/scp`, `/usr/bin/sftp`, `/usr/bin/ssh`, `/usr/sbin/sshd`, or `libkeyutils.so`, to gain unauthorized access or exfiltrate SSH credentials.\n\nThe detection rule 'Modification of OpenSSH Binaries' is designed to identify such abuse by monitoring file changes in the Linux environment. It triggers an alert when a process, modifies any of the specified OpenSSH binaries or libraries. This helps security analysts detect potential malicious activities and take appropriate action.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n> This investigation guide uses [placeholder fields](https://www.elastic.co/guide/en/security/current/osquery-placeholder-fields.html) to dynamically pass alert data into Osquery queries. Placeholder fields were introduced in Elastic Stack version 8.7.0. If you're using Elastic Stack version 8.6.0 or earlier, you'll need to manually adjust this investigation guide's queries to ensure they properly run.\n\n### Possible investigation steps\n\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence and whether they are located in expected locations.\n  - !{osquery{\"label\":\"Osquery - Retrieve Running Processes by User\",\"query\":\"SELECT pid, username, name FROM processes p JOIN users u ON u.uid = p.uid ORDER BY username\"}}\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Validate the activity is not related to planned patches, updates, network administrator activity, or legitimate software installations.\n- Investigate whether the altered scripts call other malicious scripts elsewhere on the file system. \n  - If scripts or executables were dropped, retrieve the files and determine if they are malicious:\n    - Use a private sandboxed malware analysis system to perform analysis.\n      - Observe and collect information about the following activities:\n        - Attempts to contact external domains and addresses.\n          - Check if the domain is newly registered or unexpected.\n          - Check the reputation of the domain or IP address.\n        - File access, modification, and creation activities.\n        - Cron jobs, services and other persistence mechanisms.\n            - !{osquery{\"label\":\"Osquery - Retrieve Crontab Information\",\"query\":\"SELECT * FROM crontab\"}}\n- Investigate abnormal behaviors by the subject process/user such as network connections, file modifications, and any other spawned child processes.\n  - Investigate listening ports and open sockets to look for potential command and control traffic or data exfiltration.\n    - !{osquery{\"label\":\"Osquery - Retrieve Listening Ports\",\"query\":\"SELECT pid, address, port, socket, protocol, path FROM listening_ports\"}}\n    - !{osquery{\"label\":\"Osquery - Retrieve Open Sockets\",\"query\":\"SELECT pid, family, remote_address, remote_port, socket, state FROM process_open_sockets\"}}\n  - Identify the user account that performed the action, analyze it, and check whether it should perform this kind of action.\n    - !{osquery{\"label\":\"Osquery - Retrieve Information for a Specific User\",\"query\":\"SELECT * FROM users WHERE username = {{user.name}}\"}}\n- Investigate whether the user is currently logged in and active.\n    - !{osquery{\"label\":\"Osquery - Investigate the Account Authentication Status\",\"query\":\"SELECT * FROM logged_in_users WHERE user = {{user.name}}\"}}\n\n### False positive analysis\n\n- Regular users should not need to modify OpenSSH binaries, which makes false positives unlikely. In the case of authorized benign true positives (B-TPs), exceptions can be added.\n- If this activity is related to new benign software installation activity, consider adding exceptions — preferably with a combination of user and command line conditions.\n- If this activity is related to a system administrator that performed these actions for administrative purposes, consider adding exceptions for this specific administrator user account. \n- Try to understand the context of the execution by thinking about the user, machine, or business purpose. A small number of endpoints, such as servers with unique software, might appear unusual but satisfy a specific business need.\n\n### Response and Remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Leverage the incident response data and logging to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 110,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Tactic: Persistence",
          "Tactic: Lateral Movement",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Trusted OpenSSH executable updates. It's recommended to verify the integrity of OpenSSH binary changes."
        ],
        "references": [
          "https://blog.angelalonso.es/2016/09/anatomy-of-real-linux-intrusion-part-ii.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1543",
                "name": "Create or Modify System Process",
                "reference": "https://attack.mitre.org/techniques/T1543/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1556",
                "name": "Modify Authentication Process",
                "reference": "https://attack.mitre.org/techniques/T1556/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1021",
                "name": "Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1021/",
                "subtechnique": [
                  {
                    "id": "T1021.004",
                    "name": "SSH",
                    "reference": "https://attack.mitre.org/techniques/T1021/004/"
                  }
                ]
              },
              {
                "id": "T1563",
                "name": "Remote Service Session Hijacking",
                "reference": "https://attack.mitre.org/techniques/T1563/",
                "subtechnique": [
                  {
                    "id": "T1563.001",
                    "name": "SSH Hijacking",
                    "reference": "https://attack.mitre.org/techniques/T1563/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from one of the following integrations:\n- Elastic Defend\n- Auditbeat\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n### Auditbeat Setup\nAuditbeat is a lightweight shipper that you can install on your servers to audit the activities of users and processes on your systems. For example, you can use Auditbeat to collect and centralize audit events from the Linux Audit Framework. You can also use Auditbeat to detect changes to critical files, like binaries and configuration files, and identify potential security policy violations.\n\n#### The following steps should be executed in order to add the Auditbeat on a Linux System:\n- Elastic provides repositories available for APT and YUM-based distributions. Note that we provide binary packages, but no source packages.\n- To install the APT and YUM repositories follow the setup instructions in this [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/setup-repositories.html).\n- To run Auditbeat on Docker follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/running-on-docker.html).\n- To run Auditbeat on Kubernetes follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/running-on-kubernetes.html).\n- For complete “Setup and Run Auditbeat” information refer to the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/setting-up-and-running.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "4bc210ef-ad5d-422c-b752-863d45c7dbaf",
        "rule_id": "0415f22a-2336-45fa-ba07-618a5942e22c",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:38.532Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:22.102Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": [],
        "query": "event.category:file and host.os.type:linux and event.type:change and \n  process.name:(* and not (dnf or dnf-automatic or dpkg or yum or rpm or yum-cron or anacron or platform-python)) and \n  (file.path:(/usr/bin/scp or \n                /usr/bin/sftp or \n                /usr/bin/ssh or \n                /usr/sbin/sshd) or \n  file.name:libkeyutils.so) and\n  not (\n    process.executable:/usr/share/elasticsearch/* or\n    process.name : (apk or ansible-admin or systemd or dnf or python*)\n  )",
        "language": "kuery"
      },
      {
        "name": "Potential Evasion via Filter Manager",
        "description": "The Filter Manager Control Program (fltMC.exe) binary may be abused by adversaries to unload a filter driver and evade defenses.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Potential Evasion via Filter Manager\n\nA file system filter driver, or minifilter, is a specialized type of filter driver designed to intercept and modify I/O requests sent to a file system or another filter driver. Minifilters are used by a wide range of security software, including EDR, antivirus, backup agents, encryption products, etc.\n\nAttackers may try to unload minifilters to avoid protections such as malware detection, file system monitoring, and behavior-based detections.\n\nThis rule identifies the attempt to unload a minifilter using the `fltmc.exe` command-line utility, a tool used to manage and query the filter drivers loaded on Windows systems.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Examine the command line event to identify the target driver.\n  - Identify the minifilter's role in the environment and if it is security-related. Microsoft provides a [list](https://learn.microsoft.com/en-us/windows-hardware/drivers/ifs/allocated-altitudes) of allocated altitudes that may provide more context, such as the manufacturer.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Observe and collect information about the following activities in the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n\n### False positive analysis\n\n- This mechanism can be used legitimately. Analysts can dismiss the alert if the administrator is aware of the activity and there are justifications for the action.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 213,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Endgame",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.001",
                    "name": "Disable or Modify Tools",
                    "reference": "https://attack.mitre.org/techniques/T1562/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "7b6e0d71-92ff-44c8-bdfe-ac240ba4b513",
        "rule_id": "06dceabf-adca-48af-ac79-ffdf4c3b1e9a",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:38.535Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:22.157Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.name : \"fltMC.exe\" and process.args : \"unload\" and\n  not\n  (\n    (\n      process.executable : \"?:\\\\Program Files (x86)\\\\ManageEngine\\\\UEMS_Agent\\\\bin\\\\DCFAService64.exe\" and\n      process.args : (\"DFMFilter\", \"DRMFilter\")\n    ) or\n    (\n      process.executable : \"?:\\\\Windows\\\\SysWOW64\\\\msiexec.exe\" and\n      process.args : (\"BrFilter_*\", \"BrCow_*\") and\n      user.id : \"S-1-5-18\"\n    )\n  )",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*"
        ],
        "filters": []
      },
      {
        "name": "GitHub Protected Branch Settings Changed",
        "description": "This rule detects setting modifications for protected branches of a GitHub repository. Branch protection rules can be used to enforce certain workflows or requirements before a contributor can push changes to a branch in your repository. Changes to these protected branch settings should be investigated and verified as legitimate activity. Unauthorized changes could be used to lower your organization's security posture and leave you exposed for future attacks.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Cloud",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Github"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.001",
                    "name": "Disable or Modify Tools",
                    "reference": "https://attack.mitre.org/techniques/T1562/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "github",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "github.category",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "b18690bf-0081-4c17-9654-6e3494a3e2a8",
        "rule_id": "07639887-da3a-4fbf-9532-8ce748ff8c50",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:38.538Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:22.210Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "configuration where event.dataset == \"github.audit\"\n  and github.category == \"protected_branch\" and event.type == \"change\"",
        "language": "eql",
        "index": [
          "logs-github.audit-*"
        ],
        "filters": []
      },
      {
        "name": "Local Account TokenFilter Policy Disabled",
        "description": "Identifies registry modification to the LocalAccountTokenFilterPolicy policy. If this value exists (which doesn't by default) and is set to 1, then remote connections from all local members of Administrators are granted full high-integrity tokens during negotiation.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 312,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Tactic: Lateral Movement",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Microsoft Defender for Endpoint"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.stigviewer.com/stig/windows_server_2008_r2_member_server/2014-04-02/finding/V-36439",
          "https://posts.specterops.io/pass-the-hash-is-dead-long-live-localaccounttokenfilterpolicy-506c25a7c167",
          "https://www.welivesecurity.com/wp-content/uploads/2018/01/ESET_Turla_Mosquito.pdf"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1112",
                "name": "Modify Registry",
                "reference": "https://attack.mitre.org/techniques/T1112/"
              },
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1550",
                "name": "Use Alternate Authentication Material",
                "reference": "https://attack.mitre.org/techniques/T1550/",
                "subtechnique": [
                  {
                    "id": "T1550.002",
                    "name": "Pass the Hash",
                    "reference": "https://attack.mitre.org/techniques/T1550/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.data.strings",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "registry.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.value",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "8c0c3956-050d-4b68-abc7-8e142feb17d3",
        "rule_id": "07b1ef73-1fde-4a49-a34a-5dd40011b076",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:38.541Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:23.832Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n  registry.value : \"LocalAccountTokenFilterPolicy\" and\n  registry.path : (\n    \"HKLM\\\\*\\\\LocalAccountTokenFilterPolicy\",\n    \"\\\\REGISTRY\\\\MACHINE\\\\*\\\\LocalAccountTokenFilterPolicy\",\n    \"MACHINE\\\\*\\\\LocalAccountTokenFilterPolicy\"\n  ) and registry.data.strings : (\"1\", \"0x00000001\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.registry-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-m365_defender.event-*"
        ],
        "filters": []
      },
      {
        "name": "Process Termination followed by Deletion",
        "description": "Identifies a process termination event quickly followed by the deletion of its executable file. Malware tools and other non-native files dropped or created on a system by an adversary may leave traces to indicate to what occurred. Removal of these files can occur during an intrusion, or as part of a post-intrusion process to minimize the adversary's footprint.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Process Termination followed by Deletion\n\nThis rule identifies an unsigned process termination event quickly followed by the deletion of its executable file. Attackers can delete programs after their execution in an attempt to cover their tracks in a host.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate any abnormal behavior by the subject process such as network connections, registry or file modifications, command line and any spawned child processes.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the process executable using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately, as programs that exhibit this behavior, such as installers and similar utilities, should be signed. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 110,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Endgame",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1036",
                "name": "Masquerading",
                "reference": "https://attack.mitre.org/techniques/T1036/",
                "subtechnique": [
                  {
                    "id": "T1036.001",
                    "name": "Invalid Code Signature",
                    "reference": "https://attack.mitre.org/techniques/T1036/001/"
                  }
                ]
              },
              {
                "id": "T1070",
                "name": "Indicator Removal",
                "reference": "https://attack.mitre.org/techniques/T1070/",
                "subtechnique": [
                  {
                    "id": "T1070.004",
                    "name": "File Deletion",
                    "reference": "https://attack.mitre.org/techniques/T1070/004/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.code_signature.subject_name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.code_signature.trusted",
            "type": "boolean",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.code_signature.status",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.code_signature.subject_name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "62d12abb-0feb-43d5-823d-63c8f5b5ccc9",
        "rule_id": "09443c92-46b3-45a4-8f25-383b028b258d",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:38.544Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:23.617Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by host.id with maxspan=5s\n   [process where host.os.type == \"windows\" and event.type == \"end\" and\n    process.code_signature.trusted != true and\n    not process.executable like\n             (\"C:\\\\Windows\\\\SoftwareDistribution\\\\*.exe\",\n              \"C:\\\\Windows\\\\WinSxS\\\\*.exe\",\n              \"?:\\\\Windows\\\\Postillion\\\\Office\\\\*.exe\") and\n    not (\n      process.name : \"infinst.exe\" and process.parent.name: \"dxsetup.exe\" and\n      process.parent.code_signature.subject_name == \"NVIDIA Corporation\" and\n      process.parent.code_signature.status == \"trusted\"\n    )\n   ] by process.executable\n   [file where host.os.type == \"windows\" and event.type == \"deletion\" and file.extension in~ (\"exe\", \"scr\", \"com\") and\n    not process.executable like\n             (\"?:\\\\Program Files\\\\*.exe\",\n              \"?:\\\\Program Files (x86)\\\\*.exe\",\n              \"?:\\\\Windows\\\\System32\\\\svchost.exe\",\n              \"?:\\\\Windows\\\\System32\\\\drvinst.exe\",\n              \"?:\\\\Windows\\\\Postillion\\\\Office\\\\*.exe\") and\n    not file.path like (\n          \"?:\\\\Program Files\\\\*.exe\",\n          \"?:\\\\Program Files (x86)\\\\*.exe\",\n          \"?:\\\\Windows\\\\Temp\\\\*\\\\DismHost.exe\",\n          \"?:\\\\$WINDOWS.~BT\\\\Work\\\\*\\\\DismHost.exe\",\n          \"?:\\\\$WinREAgent\\\\Scratch\\\\*\\\\DismHost.exe\",\n          \"?:\\\\Windows\\\\tenable_mw_scan_*.exe\",\n          \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\LogiUI\\\\Pak\\\\uninstall.exe\",\n          \"?:\\\\ProgramData\\\\chocolatey\\\\*.exe\"\n    ) and\n    not (process.name : \"OktaVerifySetup-*.exe\" and process.code_signature.subject_name == \"Okta, Inc.\") and\n    not (\n      process.executable : \"?:\\\\Windows\\\\SysWOW64\\\\config\\\\systemprofile\\\\Citrix\\\\UpdaterBinaries\\\\CitrixReceiver\\\\*\" and\n      process.code_signature.subject_name == \"Citrix Systems, Inc.\" and\n      file.path : \"?:\\\\Windows\\\\SysWOW64\\\\config\\\\systemprofile\\\\Citrix\\\\UpdaterBinaries\\\\CitrixReceiver\\\\*\\\\bootstrapperhelper.exe\"\n    )\n   ] by file.path",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "logs-endpoint.events.file-*"
        ],
        "filters": []
      },
      {
        "name": "Member Removed From GitHub Organization",
        "description": "A member was removed or their invitation to join was removed from a GitHub Organization.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 204,
        "tags": [
          "Domain: Cloud",
          "Use Case: Threat Detection",
          "Use Case: UEBA",
          "Tactic: Impact",
          "Rule Type: BBR",
          "Data Source: Github"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0040",
              "name": "Impact",
              "reference": "https://attack.mitre.org/tactics/TA0040/"
            },
            "technique": [
              {
                "id": "T1531",
                "name": "Account Access Removal",
                "reference": "https://attack.mitre.org/techniques/T1531/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "github",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "1d088334-09e3-41c3-abc9-85ff6b0a3e02",
        "rule_id": "095b6a58-8f88-4b59-827c-ab584ad4e759",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:38.547Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:23.621Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "configuration where event.dataset == \"github.audit\" and event.action == \"org.remove_member\"",
        "language": "eql",
        "index": [
          "logs-github.audit-*"
        ],
        "filters": []
      },
      {
        "name": "File Creation, Execution and Self-Deletion in Suspicious Directory",
        "description": "This rule monitors for the creation of a file, followed by its execution and self-deletion in a short timespan within a directory often used for malicious purposes by threat actors. This behavior is often used by malware to execute malicious code and delete itself to hide its tracks.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 5,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.004",
                    "name": "Unix Shell",
                    "reference": "https://attack.mitre.org/techniques/T1059/004/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "bd95b977-d974-4f99-a501-20ccf1b44204",
        "rule_id": "09bc6c90-7501-494d-b015-5d988dc3f233",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:38.550Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:23.626Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by host.id, user.id with maxspan=1m\n  [file where host.os.type == \"linux\" and event.action == \"creation\" and \n   process.name in (\"curl\", \"wget\", \"fetch\", \"ftp\", \"sftp\", \"scp\", \"rsync\", \"ld\") and \n   file.path : (\"/dev/shm/*\", \"/run/shm/*\", \"/tmp/*\", \"/var/tmp/*\",\n     \"/run/*\", \"/var/run/*\", \"/var/www/*\", \"/proc/*/fd/*\")] by file.name\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and \n   process.parent.name in (\"bash\", \"dash\", \"ash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\") and\n   not process.parent.executable like (\n     \"/tmp/VeeamApp*\", \"/tmp/rajh/spack-stage/*\", \"plz-out/bin/vault/bridge/test/e2e/base/bridge-dev\",\n     \"/usr/bin/ranlib\", \"/usr/bin/ar\", \"plz-out/bin/vault/bridge/test/e2e/base/local-k8s\"  \n   )] by process.name\n  [file where host.os.type == \"linux\" and event.action == \"deletion\" and not process.name in (\"rm\", \"ld\") and \n   file.path : (\"/dev/shm/*\", \"/run/shm/*\", \"/tmp/*\", \"/var/tmp/*\",\n     \"/run/*\", \"/var/run/*\", \"/var/www/*\", \"/proc/*/fd/*\")] by file.name",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "First Occurrence of User Agent For a GitHub Personal Access Token (PAT)",
        "description": "Detects a new user agent used for a GitHub PAT not previously seen in the last 14 days.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 204,
        "tags": [
          "Domain: Cloud",
          "Use Case: Threat Detection",
          "Use Case: UEBA",
          "Tactic: Initial Access",
          "Rule Type: BBR",
          "Data Source: Github"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1078",
                "name": "Valid Accounts",
                "reference": "https://attack.mitre.org/techniques/T1078/",
                "subtechnique": [
                  {
                    "id": "T1078.004",
                    "name": "Cloud Accounts",
                    "reference": "https://attack.mitre.org/techniques/T1078/004/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "github",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "github.hashed_token",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "github.programmatic_access_type",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "github.user_agent",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "3001539f-001a-4b07-9f07-f0ff3ef0e722",
        "rule_id": "0e4367a0-a483-439d-ad2e-d90500b925fd",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:38.758Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:23.701Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "event.dataset:\"github.audit\" and event.category:\"configuration\" and\ngithub.user_agent:* and github.hashed_token:* and\ngithub.programmatic_access_type:(\"OAuth access token\" or \"Fine-grained personal access token\")",
        "new_terms_fields": [
          "github.hashed_token",
          "github.user_agent"
        ],
        "history_window_start": "now-14d",
        "index": [
          "logs-github.audit-*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Suspicious Access to LDAP Attributes",
        "description": "Identify read access to a high number of Active Directory object attributes. The knowledge of objects properties can help adversaries find vulnerabilities, elevate privileges or collect sensitive information.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 102,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Data Source: System",
          "Data Source: Active Directory",
          "Data Source: Windows"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1069",
                "name": "Permission Groups Discovery",
                "reference": "https://attack.mitre.org/techniques/T1069/"
              }
            ]
          }
        ],
        "setup": "The 'Audit Directory Service Changes' logging policy must be configured for (Success, Failure).\nSteps to implement the logging policy with Advanced Audit Configuration:\n\nComputer Configuration >\nPolicies >\nWindows Settings >\nSecurity Settings >\nAdvanced Audit Policies Configuration >\nAudit Policies >\nDS Access >\nAudit Directory Service Changes (Success,Failure)\n",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.code",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.event_data.AccessMaskDescription",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "winlog.event_data.Properties",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "winlog.event_data.SubjectUserSid",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "a7f667fc-7294-4664-ada7-e30c80184bb5",
        "rule_id": "68ad737b-f90a-4fe5-bda6-a68fa460044e",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:41.879Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:35.328Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "any where event.action in (\"Directory Service Access\", \"object-operation-performed\") and\n event.code == \"4662\" and not winlog.event_data.SubjectUserSid : \"S-1-5-18\" and\n winlog.event_data.AccessMaskDescription == \"Read Property\" and length(winlog.event_data.Properties) >= 2000",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-system.security*",
          "logs-windows.forwarded*"
        ],
        "filters": []
      },
      {
        "name": "Remote Computer Account DnsHostName Update",
        "description": "Identifies the remote update to a computer account's DnsHostName attribute. If the new value set is a valid domain controller DNS hostname and the subject computer name is not a domain controller, then it's highly likely a preparation step to exploit CVE-2022-26923 in an attempt to elevate privileges from a standard domain user to domain admin privileges.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 208,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Use Case: Active Directory Monitoring",
          "Data Source: Active Directory",
          "Use Case: Vulnerability",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://research.ifcr.dk/certifried-active-directory-domain-privilege-escalation-cve-2022-26923-9e098fe298f4",
          "https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2022-26923"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1068",
                "name": "Exploitation for Privilege Escalation",
                "reference": "https://attack.mitre.org/techniques/T1068/"
              },
              {
                "id": "T1078",
                "name": "Valid Accounts",
                "reference": "https://attack.mitre.org/techniques/T1078/",
                "subtechnique": [
                  {
                    "id": "T1078.002",
                    "name": "Domain Accounts",
                    "reference": "https://attack.mitre.org/techniques/T1078/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.event_data.DnsHostName",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "winlog.event_data.TargetUserName",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "ec3c6905-d339-4971-9a3d-7b9d2f20d8d8",
        "rule_id": "6bed021a-0afb-461c-acbe-ffdb9574d3f3",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:41.882Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:35.390Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "iam where event.action == \"changed-computer-account\" and user.id : (\"S-1-5-21-*\", \"S-1-12-1-*\") and\n\n    /* if DnsHostName value equal a DC DNS hostname then it's highly suspicious */\n    winlog.event_data.DnsHostName : \"??*\" and\n\n    /* exclude FPs where DnsHostName starts with the ComputerName that was changed */\n    not startswith~(winlog.event_data.DnsHostName, substring(winlog.event_data.TargetUserName, 0, length(winlog.event_data.TargetUserName) - 1))",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-system.*",
          "logs-windows.*"
        ],
        "filters": []
      },
      {
        "name": "Network Connection via Signed Binary",
        "description": "Binaries signed with trusted digital certificates can execute on Windows systems protected by digital signature validation. Adversaries may use these binaries to 'live off the land' and execute malicious files that could bypass application allowlists and signature validation.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Network Connection via Signed Binary\n\nBy examining the specific traits of Windows binaries (such as process trees, command lines, network connections, registry modifications, and so on) it's possible to establish a baseline of normal activity. Deviations from this baseline can indicate malicious activity, such as masquerading and deserve further investigation.\n\nThis rule looks for the execution of `expand.exe`, `extrac32.exe`, `ieexec.exe`, or `makecab.exe` utilities, followed by a network connection to an external address. Attackers can abuse utilities to execute malicious files or masquerade as those utilities to bypass detections and evade defenses.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n  - Investigate any abnormal behavior by the subject process such as network connections, registry or file modifications, and any spawned child processes.\n  - Investigate the file digital signature and process original filename, if suspicious, treat it as potential malware.\n- Investigate the target host that the signed binary is communicating with.\n  - Check if the domain is newly registered or unexpected.\n  - Check the reputation of the domain or IP address.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the process executable using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n\n### False positive analysis\n\n- If this activity is expected and noisy in your environment, consider adding exceptions — preferably with a combination of destination IP address and command line conditions.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 208,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.iana.org/assignments/iana-ipv4-special-registry/iana-ipv4-special-registry.xhtml"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1218",
                "name": "System Binary Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1218/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "79953330-94cf-4860-9359-bb1c457dee2d",
        "rule_id": "63e65ec3-43b1-45b0-8f2d-45b34291dc44",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:41.890Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:35.159Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by process.entity_id\n  [process where host.os.type == \"windows\" and (process.name : \"expand.exe\" or process.name : \"extrac32.exe\" or\n                 process.name : \"ieexec.exe\" or process.name : \"makecab.exe\") and\n                 event.type == \"start\"]\n  [network where host.os.type == \"windows\" and (process.name : \"expand.exe\" or process.name : \"extrac32.exe\" or\n                 process.name : \"ieexec.exe\" or process.name : \"makecab.exe\") and\n    not cidrmatch(destination.ip,\n      \"10.0.0.0/8\", \"127.0.0.0/8\", \"169.254.0.0/16\", \"172.16.0.0/12\", \"192.0.0.0/24\", \"192.0.0.0/29\", \"192.0.0.8/32\",\n      \"192.0.0.9/32\", \"192.0.0.10/32\", \"192.0.0.170/32\", \"192.0.0.171/32\", \"192.0.2.0/24\", \"192.31.196.0/24\",\n      \"192.52.193.0/24\", \"192.168.0.0/16\", \"192.88.99.0/24\", \"224.0.0.0/4\", \"100.64.0.0/10\", \"192.175.48.0/24\",\n      \"198.18.0.0/15\", \"198.51.100.0/24\", \"203.0.113.0/24\", \"240.0.0.0/4\", \"::1\", \"FE80::/10\", \"FF00::/8\")]",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-endpoint.events.network-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious Lsass Process Access",
        "description": "Identifies access attempts to LSASS handle, this may indicate an attempt to dump credentials from Lsass memory.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 208,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/redcanaryco/atomic-red-team/blob/master/atomics/T1003.001/T1003.001.md"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1003",
                "name": "OS Credential Dumping",
                "reference": "https://attack.mitre.org/techniques/T1003/",
                "subtechnique": [
                  {
                    "id": "T1003.001",
                    "name": "LSASS Memory",
                    "reference": "https://attack.mitre.org/techniques/T1003/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.code",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.event_data.CallTrace",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "winlog.event_data.GrantedAccess",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "winlog.event_data.TargetImage",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "c754b383-69e3-4e7c-93c0-59de60f91d03",
        "rule_id": "128468bf-cab1-4637-99ea-fdf3780a4609",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:41.893Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:23.771Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.code == \"10\" and\n  winlog.event_data.TargetImage : \"?:\\\\WINDOWS\\\\system32\\\\lsass.exe\" and\n  not winlog.event_data.GrantedAccess :\n                (\"0x1000\", \"0x1400\", \"0x101400\", \"0x101000\", \"0x101001\", \"0x100000\", \"0x100040\", \"0x3200\", \"0x40\", \"0x3200\") and\n  not process.name : (\"procexp64.exe\", \"procmon.exe\", \"procexp.exe\", \"Microsoft.Identity.AadConnect.Health.AadSync.Host.ex\") and\n  not process.executable : (\n        \"?:\\\\ProgramData\\\\Microsoft\\\\Windows Defender\\\\platform\\\\*\",\n        \"?:\\\\ProgramData\\\\WebEx\\\\webex\\\\*\",\n        \"?:\\\\Program Files (x86)\\\\*\",\n        \"?:\\\\Program Files\\\\*\",\n        \"?:\\\\Windows\\\\CCM\\\\CcmExec.exe\",\n        \"?:\\\\Windows\\\\LTSvc\\\\LTSVC.exe\",\n        \"?:\\\\Windows\\\\Sysmon.exe\",\n        \"?:\\\\Windows\\\\Sysmon64.exe\",\n        \"C:\\\\Windows\\\\CynetMS.exe\",\n        \"?:\\\\Windows\\\\system32\\\\csrss.exe\",\n        \"?:\\\\Windows\\\\System32\\\\lsm.exe\",\n        \"?:\\\\Windows\\\\system32\\\\MRT.exe\",\n        \"?:\\\\Windows\\\\System32\\\\msiexec.exe\",\n        \"?:\\\\Windows\\\\system32\\\\wbem\\\\wmiprvse.exe\",\n        \"?:\\\\Windows\\\\system32\\\\wininit.exe\",\n        \"?:\\\\Windows\\\\SystemTemp\\\\GUM*.tmp\\\\GoogleUpdate.exe\",\n        \"?:\\\\Windows\\\\sysWOW64\\\\wbem\\\\wmiprvse.exe\", \n        \"C:\\\\oracle\\\\64\\\\02\\\\instantclient_19_13\\\\sqlplus.exe\", \n        \"C:\\\\oracle\\\\64\\\\02\\\\instantclient_19_13\\\\sqlldr.exe\",\n        \"d:\\\\oracle\\\\product\\\\19\\\\dbhome1\\\\bin\\\\ORACLE.EXE\",\n        \"C:\\\\wamp\\\\bin\\\\apache\\\\apache*\\\\bin\\\\httpd.exe\",\n        \"C:\\\\Windows\\\\system32\\\\netstat.exe\", \n        \"C:\\\\PROGRA~1\\\\INFORM~1\\\\apps\\\\jdk\\\\*\\\\jre\\\\bin\\\\java.exe\", \n        \"C:\\\\PROGRA~2\\\\CyberCNSAgentV2\\\\osqueryi.exe\",\n        \"C:\\\\Utilityw2k19\\\\packetbeat\\\\packetbeat.exe\",\n        \"C:\\\\ProgramData\\\\Cisco\\\\Cisco AnyConnect Secure Mobility Client\\\\Temp\\\\CloudUpdate\\\\vpndownloader.exe\", \n        \"C:\\\\ProgramData\\\\Cisco\\\\Cisco Secure Client\\\\Temp\\\\CloudUpdate\\\\vpndownloader.exe\"\n  ) and\n  not winlog.event_data.CallTrace : (\"*mpengine.dll*\", \"*appresolver.dll*\", \"*sysmain.dll*\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "Network Connection via Recently Compiled Executable",
        "description": "This rule monitors a sequence involving a program compilation event followed by its execution and a subsequent network connection event. This behavior can indicate the set up of a reverse tcp connection to a command-and-control server. Attackers may spawn reverse shells to establish persistence onto a target system.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 6,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.004",
                    "name": "Unix Shell",
                    "reference": "https://attack.mitre.org/techniques/T1059/004/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            },
            "technique": [
              {
                "id": "T1071",
                "name": "Application Layer Protocol",
                "reference": "https://attack.mitre.org/techniques/T1071/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "23b0babc-a6ba-41ba-83dc-4183d59bb712",
        "rule_id": "64cfca9e-0f6f-4048-8251-9ec56a055e9e",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:41.896Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:35.191Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by host.id with maxspan=1m\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and \n   process.name in (\"gcc\", \"g++\", \"cc\")] by process.args\n  [file where host.os.type == \"linux\" and event.action == \"creation\" and process.name == \"ld\"] by file.name\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\"] by process.name\n  [network where host.os.type == \"linux\" and event.action == \"connection_attempted\" and destination.ip != null and not (\n     cidrmatch(destination.ip, \"127.0.0.0/8\", \"169.254.0.0/16\", \"224.0.0.0/4\", \"::1\") or\n     process.name in (\"simpleX\", \"conftest\", \"ssh\", \"python\", \"ispnull\", \"pvtui\")\n   )] by process.name",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Scheduled Task Created by a Windows Script",
        "description": "A scheduled task was created by a Windows script via cscript.exe, wscript.exe or powershell.exe. This can be abused by an adversary to establish persistence.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\nDecode the base64 encoded Tasks Actions registry value to investigate the task's configured action.",
        "output_index": "",
        "version": 208,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Tactic: Execution",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Legitimate scheduled tasks may be created during installation of new software."
        ],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1053",
                "name": "Scheduled Task/Job",
                "reference": "https://attack.mitre.org/techniques/T1053/",
                "subtechnique": [
                  {
                    "id": "T1053.005",
                    "name": "Scheduled Task",
                    "reference": "https://attack.mitre.org/techniques/T1053/005/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  },
                  {
                    "id": "T1059.005",
                    "name": "Visual Basic",
                    "reference": "https://attack.mitre.org/techniques/T1059/005/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "dll.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.value",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "b6c8d8eb-d280-43e0-b39d-56572d30dbe5",
        "rule_id": "689b9d57-e4d5-4357-ad17-9c334609d79a",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:41.899Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:35.319Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by host.id with maxspan = 30s\n  [any where host.os.type == \"windows\" and \n    (event.category : (\"library\", \"driver\") or (event.category == \"process\" and event.action : \"Image loaded*\")) and\n    (?dll.name : \"taskschd.dll\" or file.name : \"taskschd.dll\") and\n    process.name : (\"cscript.exe\", \"wscript.exe\", \"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\")]\n  [registry where host.os.type == \"windows\" and event.type == \"change\" and registry.value : \"Actions\" and\n    registry.path : (\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Schedule\\\\TaskCache\\\\Tasks\\\\*\\\\Actions\",\n      \"\\\\REGISTRY\\\\MACHINE\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Schedule\\\\TaskCache\\\\Tasks\\\\*\\\\Actions\"\n  )]",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.registry-*",
          "logs-endpoint.events.library-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "MsBuild Making Network Connections",
        "description": "Identifies MsBuild.exe making outbound network connections. This may indicate adversarial activity as MsBuild is often leveraged by adversaries to execute code and evade detection.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Performance\n\nThe performance impact of this rule is expected to be low to medium because of the first sequence, which looks for MsBuild.exe process execution. The events for this first sequence may be noisy, consider adding exceptions.\n\n### Investigating MsBuild Making Network Connections\n\nBy examining the specific traits of Windows binaries (such as process trees, command lines, network connections, registry modifications, and so on) it's possible to establish a baseline of normal activity. Deviations from this baseline can indicate malicious activity, such as masquerading and deserve further investigation.\n\nThe Microsoft Build Engine, also known as MSBuild, is a platform for building applications. This engine provides an XML schema for a project file that controls how the build platform processes and builds software, and can be abused to proxy code execution.\n\nThis rule looks for the `Msbuild.exe` utility execution, followed by a network connection to an external address. Attackers can abuse MsBuild to execute malicious files or masquerade as those utilities in order to bypass detections and evade defenses.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n  - Investigate any abnormal behavior by the subject process such as network connections, registry or file modifications, and any spawned child processes.\n  - Investigate the file digital signature and process original filename, if suspicious, treat it as potential malware.\n- Investigate the target host that the signed binary is communicating with.\n  - Check if the domain is newly registered or unexpected.\n  - Check the reputation of the domain or IP address.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the process executable using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n\n### False positive analysis\n\n- If this activity is expected and noisy in your environment, consider adding exceptions — preferably with a combination of destination IP address and command line conditions.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 210,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://riccardoancarani.github.io/2019-10-19-hunting-covenant-msbuild/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1127",
                "name": "Trusted Developer Utilities Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1127/",
                "subtechnique": [
                  {
                    "id": "T1127.001",
                    "name": "MSBuild",
                    "reference": "https://attack.mitre.org/techniques/T1127/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "dns.question.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "4c9d82cd-fa67-4901-9e7b-8d909d723d6e",
        "rule_id": "0e79980b-4250-4a50-a509-69294c14e84b",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:41.901Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:23.722Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by process.entity_id with maxspan=30s\n\n  /* Look for MSBuild.exe process execution */\n  /* The events for this first sequence may be noisy, consider adding exceptions */\n  [process where host.os.type == \"windows\"\n    and (\n          process.pe.original_file_name: \"MSBuild.exe\" or\n          process.name: \"MSBuild.exe\"\n        )\n    and event.type == \"start\" and user.id != \"S-1-5-18\"]\n\n  /* Followed by a network connection to an external address */\n  /* Exclude domains that are known to be benign */\n  [network where host.os.type == \"windows\"\n    and event.action: (\"connection_attempted\", \"lookup_requested\")\n    and (\n          process.pe.original_file_name: \"MSBuild.exe\" or\n          process.name: \"MSBuild.exe\"\n        )\n    and not user.id != \"S-1-5-18\" and\n    not cidrmatch(destination.ip, \"127.0.0.1\", \"::1\") and\n    not dns.question.name : (\n      \"localhost\",\n      \"dc.services.visualstudio.com\",\n      \"vortex.data.microsoft.com\",\n      \"api.nuget.org\")]",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-endpoint.events.network-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "GitHub Repo Created",
        "description": "A new GitHub repository was created.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 204,
        "tags": [
          "Domain: Cloud",
          "Use Case: Threat Detection",
          "Use Case: UEBA",
          "Tactic: Execution",
          "Rule Type: BBR",
          "Data Source: Github"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1648",
                "name": "Serverless Execution",
                "reference": "https://attack.mitre.org/techniques/T1648/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "github",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "c70ea2a1-aa3e-43b1-b177-0a6f44d8037a",
        "rule_id": "6cea88e4-6ce2-4238-9981-a54c140d6336",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:41.907Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:35.399Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "configuration where event.dataset == \"github.audit\" and event.action == \"repo.create\"",
        "language": "eql",
        "index": [
          "logs-github.audit-*"
        ],
        "filters": []
      },
      {
        "name": "Process Discovery Using Built-in Tools",
        "description": "This rule identifies the execution of commands that can be used to enumerate running processes. Adversaries may enumerate processes to identify installed applications and security solutions.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 106,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Rule Type: BBR",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1057",
                "name": "Process Discovery",
                "reference": "https://attack.mitre.org/techniques/T1057/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "08b4a8bc-c29e-4ae5-98d1-8adae9448019",
        "rule_id": "4982ac3e-d0ee-4818-b95d-d9522d689259",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:41.904Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:30.263Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (\n    process.name :(\"PsList.exe\", \"qprocess.exe\") or \n   (process.name : \"powershell.exe\" and process.args : (\"*get-process*\", \"*Win32_Process*\")) or \n   (process.name : \"wmic.exe\" and process.args : (\"process\", \"*Win32_Process*\")) or\n   (process.name : \"tasklist.exe\" and not process.args : (\"pid eq*\")) or\n   (process.name : \"query.exe\" and process.args : \"process\")\n  ) and not user.id : \"S-1-5-18\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "logs-system.security*",
          "winlogbeat-*",
          "logs-windows.*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "Multiple Logon Failure from the same Source Address",
        "description": "Identifies multiple consecutive logon failures from the same source address and within a short time interval. Adversaries will often brute force login attempts across multiple users with a common or known password, in an attempt to gain access to accounts.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Multiple Logon Failure from the same Source Address\n\nAdversaries with no prior knowledge of legitimate credentials within the system or environment may guess passwords to attempt access to accounts. Without knowledge of the password for an account, an adversary may opt to guess the password using a repetitive or iterative mechanism systematically. More details can be found [here](https://attack.mitre.org/techniques/T1110/001/).\n\nThis rule identifies potential password guessing/brute force activity from a single address.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the logon failure reason code and the targeted user names.\n  - Prioritize the investigation if the account is critical or has administrative privileges over the domain.\n- Investigate the source IP address of the failed Network Logon attempts.\n  - Identify whether these attempts are coming from the internet or are internal.\n- Investigate other alerts associated with the involved users and source host during the past 48 hours.\n- Identify the source and the target computer and their roles in the IT environment.\n- Check whether the involved credentials are used in automation or scheduled tasks.\n- If this activity is suspicious, contact the account owner and confirm whether they are aware of it.\n- Examine the source host for derived artifacts that indicate compromise:\n  - Observe and collect information about the following activities in the alert source host:\n    - Attempts to contact external domains and addresses.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the host which is the source of this activity\n\n### False positive analysis\n\n- Understand the context of the authentications by contacting the asset owners. This activity can be related to a new or existing automation or business process that is in a failing state.\n- Authentication misconfiguration or obsolete credentials.\n- Service account password expired.\n- Domain trust relationship issues.\n- Infrastructure or availability issues.\n\n### Related rules\n\n- Multiple Logon Failure Followed by Logon Success - 4e85dc8a-3e41-40d8-bc28-91af7ac6cf60\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the source host to prevent further post-compromise behavior.\n- If the asset is exposed to the internet with RDP or other remote services available, take the necessary measures to restrict access to the asset. If not possible, limit the access via the firewall to only the needed IP addresses. Also, ensure the system uses robust authentication mechanisms and is patched regularly.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 110,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Resources: Investigation Guide",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4625",
          "https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventid=4624",
          "https://social.technet.microsoft.com/Forums/ie/en-US/c82ac4f3-a235-472c-9fd3-53aa646cfcfd/network-information-missing-in-event-id-4624?forum=winserversecurity",
          "https://serverfault.com/questions/379092/remote-desktop-failed-logon-event-4625-not-logging-ip-address-on-2008-terminal-s/403638#403638"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1110",
                "name": "Brute Force",
                "reference": "https://attack.mitre.org/techniques/T1110/",
                "subtechnique": [
                  {
                    "id": "T1110.001",
                    "name": "Password Guessing",
                    "reference": "https://attack.mitre.org/techniques/T1110/001/"
                  },
                  {
                    "id": "T1110.003",
                    "name": "Password Spraying",
                    "reference": "https://attack.mitre.org/techniques/T1110/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\n- In some cases the source network address in Windows events 4625/4624 is not populated due to Microsoft logging limitations (examples in the references links). This edge case will break the rule condition and it won't trigger an alert.\n",
        "related_integrations": [
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "source.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "user.domain",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.computer_name",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "winlog.event_data.Status",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "winlog.logon.type",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "c9d2920c-c5d8-486d-96eb-9449b60bcc77",
        "rule_id": "48b6edfc-079d-4907-b43c-baffa243270d",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:41.909Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:30.231Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by winlog.computer_name, source.ip with maxspan=10s\n  [authentication where event.action == \"logon-failed\" and\n    /* event 4625 need to be logged */\n    winlog.logon.type : \"Network\" and\n    source.ip != null and source.ip != \"127.0.0.1\" and source.ip != \"::1\" and\n    not user.name : (\"ANONYMOUS LOGON\", \"-\", \"*$\") and not user.domain == \"NT AUTHORITY\" and\n\n    /*\n    noisy failure status codes often associated to authentication misconfiguration :\n     0xC000015B - The user has not been granted the requested logon type (also called the logon right) at this machine.\n     0XC000005E\t- There are currently no logon servers available to service the logon request.\n     0XC0000133\t- Clocks between DC and other computer too far out of sync.\n     0XC0000192\tAn attempt was made to logon, but the Netlogon service was not started.\n    */\n    not winlog.event_data.Status : (\"0xC000015B\", \"0XC000005E\", \"0XC0000133\", \"0XC0000192\")] with runs=10",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-system.security*",
          "logs-windows.forwarded*"
        ],
        "filters": []
      },
      {
        "name": "Dynamic Linker Creation or Modification",
        "description": "Detects the creation or modification of files related to the dynamic linker on Linux systems. The dynamic linker is a shared library that is used by the Linux kernel to load and execute programs. Attackers may attempt to hijack the execution flow of a program by modifying the dynamic linker configuration files.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 2,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Tactic: Persistence",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1574",
                "name": "Hijack Execution Flow",
                "reference": "https://attack.mitre.org/techniques/T1574/",
                "subtechnique": [
                  {
                    "id": "T1574.006",
                    "name": "Dynamic Linker Hijacking",
                    "reference": "https://attack.mitre.org/techniques/T1574/006/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1574",
                "name": "Hijack Execution Flow",
                "reference": "https://attack.mitre.org/techniques/T1574/",
                "subtechnique": [
                  {
                    "id": "T1574.006",
                    "name": "Dynamic Linker Hijacking",
                    "reference": "https://attack.mitre.org/techniques/T1574/006/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.Ext.original.extension",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "415b7160-17f9-4f8d-baea-0618eb221d96",
        "rule_id": "640f79d1-571d-4f96-a9af-1194fc8cf763",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:41.914Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:35.168Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"linux\" and event.action in (\"creation\", \"rename\") and\nfile.path : (\"/etc/ld.so.preload\", \"/etc/ld.so.conf.d/*\", \"/etc/ld.so.conf\") and\nnot (\n  process.executable in (\n    \"/bin/dpkg\", \"/usr/bin/dpkg\", \"/bin/dockerd\", \"/usr/bin/dockerd\", \"/usr/sbin/dockerd\", \"/bin/microdnf\",\n    \"/usr/bin/microdnf\", \"/bin/rpm\", \"/usr/bin/rpm\", \"/bin/snapd\", \"/usr/bin/snapd\", \"/bin/yum\", \"/usr/bin/yum\",\n    \"/bin/dnf\", \"/usr/bin/dnf\", \"/bin/podman\", \"/usr/bin/podman\", \"/bin/dnf-automatic\", \"/usr/bin/dnf-automatic\",\n    \"/bin/pacman\", \"/usr/bin/pacman\", \"/usr/bin/dpkg-divert\", \"/bin/dpkg-divert\", \"/sbin/apk\", \"/usr/sbin/apk\",\n    \"/usr/local/sbin/apk\", \"/usr/bin/apt\", \"/usr/sbin/pacman\", \"/bin/podman\", \"/usr/bin/podman\", \"/usr/bin/puppet\",\n    \"/bin/puppet\", \"/opt/puppetlabs/puppet/bin/puppet\", \"/usr/bin/chef-client\", \"/bin/chef-client\",\n    \"/bin/autossl_check\", \"/usr/bin/autossl_check\", \"/proc/self/exe\", \"/dev/fd/*\",  \"/usr/bin/pamac-daemon\",\n    \"/bin/pamac-daemon\", \"/usr/lib/snapd/snapd\", \"/usr/local/bin/dockerd\", \"/usr/libexec/platform-python\",\n    \"/usr/lib/snapd/snap-update-ns\", \"/usr/bin/vmware-config-tools.pl\"\n  ) or\n  file.extension in (\"swp\", \"swpx\", \"swx\", \"dpkg-remove\") or\n  file.Ext.original.extension == \"dpkg-new\" or\n  process.executable : (\n    \"/nix/store/*\", \"/var/lib/dpkg/*\", \"/snap/*\", \"/dev/fd/*\", \"/usr/lib/virtualbox/*\", \"/opt/dynatrace/oneagent/*\"\n  ) or\n  process.executable == null or\n  process.name == \"java\" or\n  (process.name == \"sed\" and file.name : \"sed*\") or\n  (process.name == \"perl\" and file.name : \"e2scrub_all.tmp*\")\n)",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Network Connection Initiated by SSHD Child Process",
        "description": "This rule identifies an egress internet connection initiated by an SSH Daemon child process. This behavior is indicative of the alteration of a shell configuration file or other mechanism that launches a process when a new SSH login occurs. Attackers can also backdoor the SSH daemon to allow for persistence, call out to a C2 or to steal credentials.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 3,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://hadess.io/the-art-of-linux-persistence/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1546",
                "name": "Event Triggered Execution",
                "reference": "https://attack.mitre.org/techniques/T1546/",
                "subtechnique": [
                  {
                    "id": "T1546.004",
                    "name": "Unix Shell Configuration Modification",
                    "reference": "https://attack.mitre.org/techniques/T1546/004/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1021",
                "name": "Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1021/",
                "subtechnique": [
                  {
                    "id": "T1021.004",
                    "name": "SSH",
                    "reference": "https://attack.mitre.org/techniques/T1021/004/"
                  }
                ]
              },
              {
                "id": "T1563",
                "name": "Remote Service Session Hijacking",
                "reference": "https://attack.mitre.org/techniques/T1563/",
                "subtechnique": [
                  {
                    "id": "T1563.001",
                    "name": "SSH Hijacking",
                    "reference": "https://attack.mitre.org/techniques/T1563/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            }
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "54ed61cc-982e-43b9-9683-5da5068a0f5d",
        "rule_id": "63431796-f813-43af-820b-492ee2efec8e",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:41.912Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:33.559Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by host.id with maxspan=1s\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\n   process.parent.executable == \"/usr/sbin/sshd\"] by process.entity_id\n  [network where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"connection_attempted\" and not (\n     destination.ip == null or destination.ip == \"0.0.0.0\" or cidrmatch(\n     destination.ip, \"10.0.0.0/8\", \"127.0.0.0/8\", \"169.254.0.0/16\", \"172.16.0.0/12\", \"192.0.0.0/24\", \"192.0.0.0/29\",\n     \"192.0.0.8/32\", \"192.0.0.9/32\", \"192.0.0.10/32\", \"192.0.0.170/32\", \"192.0.0.171/32\", \"192.0.2.0/24\",\n     \"192.31.196.0/24\", \"192.52.193.0/24\", \"192.168.0.0/16\", \"192.88.99.0/24\", \"224.0.0.0/4\", \"100.64.0.0/10\",\n     \"192.175.48.0/24\",\"198.18.0.0/15\", \"198.51.100.0/24\", \"203.0.113.0/24\", \"240.0.0.0/4\", \"::1\", \"FE80::/10\",\n     \"FF00::/8\", \"172.31.0.0/16\"\n     )\n    ) and not (\n      process.executable in (\"/bin/yum\", \"/usr/bin/yum\") or\n      process.name in (\"login_duo\", \"ssh\", \"sshd\", \"sshd-session\")\n    )\n  ] by process.parent.entity_id",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious Remote Registry Access via SeBackupPrivilege",
        "description": "Identifies remote access to the registry using an account with Backup Operators group membership. This may indicate an attempt to exfiltrate credentials by dumping the Security Account Manager (SAM) registry hive in preparation for credential access and privileges elevation.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Suspicious Remote Registry Access via SeBackupPrivilege\n\nSeBackupPrivilege is a privilege that allows file content retrieval, designed to enable users to create backup copies of the system. Since it is impossible to make a backup of something you cannot read, this privilege comes at the cost of providing the user with full read access to the file system. This privilege must bypass any access control list (ACL) placed in the system.\n\nThis rule identifies remote access to the registry using an account with Backup Operators group membership. This may indicate an attempt to exfiltrate credentials by dumping the Security Account Manager (SAM) registry hive in preparation for credential access and privileges elevation.\n\n#### Possible investigation steps\n\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Investigate the activities done by the subject user the login session. The field `winlog.event_data.SubjectLogonId` can be used to get this data.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate abnormal behaviors observed by the subject user such as network connections, registry or file modifications, and processes created.\n- Investigate if the registry file was retrieved or exfiltrated.\n\n### False positive analysis\n\n- If this activity is expected and noisy in your environment, benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Limit or disable the involved user account to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 211,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Lateral Movement",
          "Tactic: Credential Access",
          "Resources: Investigation Guide",
          "Use Case: Active Directory Monitoring",
          "Data Source: Active Directory",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/mpgn/BackupOperatorToDA",
          "https://raw.githubusercontent.com/Wh04m1001/Random/main/BackupOperators.cpp",
          "https://www.elastic.co/security-labs/detect-credential-access"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1003",
                "name": "OS Credential Dumping",
                "reference": "https://attack.mitre.org/techniques/T1003/",
                "subtechnique": [
                  {
                    "id": "T1003.002",
                    "name": "Security Account Manager",
                    "reference": "https://attack.mitre.org/techniques/T1003/002/"
                  },
                  {
                    "id": "T1003.004",
                    "name": "LSA Secrets",
                    "reference": "https://attack.mitre.org/techniques/T1003/004/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1021",
                "name": "Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1021/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'Audit Detailed File Share' audit policy is required be configured (Success) on Domain Controllers and Sensitive Windows Servers.\nSteps to implement the logging policy with Advanced Audit Configuration:\n```\nComputer Configuration >\nPolicies >\nWindows Settings >\nSecurity Settings >\nAdvanced Audit Policies Configuration >\nAudit Policies >\nObject Access >\nAudit Detailed File Share (Success)\n```\n\nThe 'Special Logon' audit policy must be configured (Success).\nSteps to implement the logging policy with Advanced Audit Configuration:\n```\nComputer Configuration >\nPolicies >\nWindows Settings >\nSecurity Settings >\nAdvanced Audit Policies Configuration >\nAudit Policies >\nLogon/Logoff >\nSpecial Logon (Success)\n```\n",
        "related_integrations": [
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.computer_name",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "winlog.event_data.PrivilegeList",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "winlog.event_data.RelativeTargetName",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "winlog.event_data.SubjectLogonId",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "e889bd04-c365-430b-98fc-457ddaee295d",
        "rule_id": "47e22836-4a16-4b35-beee-98f6c4ee9bf2",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:41.917Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:30.204Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by winlog.computer_name, winlog.event_data.SubjectLogonId with maxspan=1m\n [iam where event.action == \"logged-in-special\"  and\n  winlog.event_data.PrivilegeList : \"SeBackupPrivilege\" and\n\n  /* excluding accounts with existing privileged access */\n  not winlog.event_data.PrivilegeList : \"SeDebugPrivilege\"]\n [any where event.action == \"Detailed File Share\" and winlog.event_data.RelativeTargetName : \"winreg\"]",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-system.*",
          "logs-windows.*"
        ],
        "filters": []
      },
      {
        "name": "Active Directory Group Modification by SYSTEM",
        "description": "Identifies a user being added to an active directory group by the SYSTEM (S-1-5-18) user. This behavior can indicate that the attacker has achieved SYSTEM privileges in a domain controller, which attackers can obtain by exploiting vulnerabilities or abusing default group privileges (e.g., Server Operators), and is attempting to pivot to a domain account.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 102,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Use Case: Active Directory Monitoring",
          "Data Source: Active Directory",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1098",
                "name": "Account Manipulation",
                "reference": "https://attack.mitre.org/techniques/T1098/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1098",
                "name": "Account Manipulation",
                "reference": "https://attack.mitre.org/techniques/T1098/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.code",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "group.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.api",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "winlog.event_data.SubjectUserSid",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "3d31f8fd-3c7a-4c10-bd50-f0c4d74bc9e2",
        "rule_id": "6f024bde-7085-489b-8250-5957efdf1caf",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:41.920Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:35.437Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "iam where winlog.api == \"wineventlog\" and event.code == \"4728\" and\nwinlog.event_data.SubjectUserSid : \"S-1-5-18\" and\n\n/* DOMAIN_USERS and local groups */\nnot group.id : \"S-1-5-21-*-513\"",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-system.security*",
          "logs-windows.forwarded*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious Execution via MSIEXEC",
        "description": "Identifies suspicious execution of the built-in Windows Installer, msiexec.exe, to install a package from usual paths or parent process. Adversaries may abuse msiexec.exe to launch malicious local MSI files.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 103,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Rule Type: BBR",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://lolbas-project.github.io/lolbas/Binaries/Msiexec/",
          "https://www.guardicore.com/labs/purple-fox-rootkit-now-propagates-as-a-worm/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1218",
                "name": "System Binary Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1218/",
                "subtechnique": [
                  {
                    "id": "T1218.007",
                    "name": "Msiexec",
                    "reference": "https://attack.mitre.org/techniques/T1218/007/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args_count",
            "type": "long",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.args_count",
            "type": "long",
            "ecs": true
          },
          {
            "name": "process.parent.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.working_directory",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "1ae24b69-6d10-4d35-8a9e-39dcf95cef87",
        "rule_id": "708c9d92-22a3-4fe0-b6b9-1f861c55502d",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:41.925Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:36.618Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.action == \"start\" and\n  process.name : \"msiexec.exe\" and user.id : (\"S-1-5-21*\", \"S-1-12-*\") and process.parent.executable != null and\n  (\n    (process.args : \"/i\" and process.args : (\"/q\", \"/quiet\") and process.args_count == 4 and\n     process.args : (\"?:\\\\Users\\\\*\", \"?:\\\\ProgramData\\\\*\") and\n     not process.parent.executable : (\"?:\\\\Program Files (x86)\\\\*.exe\",\n                                      \"?:\\\\Program Files\\\\*.exe\",\n                                      \"?:\\\\Windows\\\\explorer.exe\",\n                                      \"?:\\\\Users\\\\*\\\\Desktop\\\\*\",\n                                      \"?:\\\\Users\\\\*\\\\Downloads\\\\*\",\n                                      \"?:\\\\programdata\\\\*\")) or\n\n    (process.args_count == 1 and not process.parent.executable : (\"?:\\\\Windows\\\\explorer.exe\", \"?:\\\\Windows\\\\SysWOW64\\\\explorer.exe\")) or\n\n    (process.args : \"/i\" and process.args : (\"/q\", \"/quiet\") and process.args_count == 4 and\n     (process.parent.args : \"Schedule\" or process.parent.name : \"wmiprvse.exe\" or\n     process.parent.executable : \"?:\\\\Users\\\\*\\\\AppData\\\\*\" or\n     (process.parent.name : (\"powershell.exe\", \"cmd.exe\") and length(process.parent.command_line) >= 200))) or\n\n    (process.args : \"/i\" and process.args : (\"/q\", \"/quiet\") and process.args_count == 4 and\n     ?process.working_directory : \"?:\\\\\" and process.parent.name : (\"cmd.exe\", \"powershell.exe\"))\n  ) and\n\n  /* noisy pattern */\n  not (process.parent.executable : \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\*\" and ?process.parent.args_count >= 2 and\n       process.args : \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\*\\\\*.msi\") and\n\n  not process.args : (\"?:\\\\Program Files (x86)\\\\*\", \"?:\\\\Program Files\\\\*\")",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "winlogbeat-*",
          "logs-windows.*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "AWS CloudTrail Log Deleted",
        "description": "Identifies the deletion of an AWS log trail. An adversary may delete trails in an attempt to evade defenses.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating AWS CloudTrail Log Deleted\n\nAmazon CloudTrail is a service that enables governance, compliance, operational auditing, and risk auditing of your Amazon Web Services account. With CloudTrail, you can log, continuously monitor, and retain account activity related to actions across your Amazon Web Services infrastructure. CloudTrail provides event history of your Amazon Web Services account activity, including actions taken through the Amazon Management Console, Amazon SDKs, command line tools, and other Amazon Web Services services. This event history simplifies security analysis, resource change tracking, and troubleshooting.\n\nThis rule identifies the deletion of an AWS log trail using the API `DeleteTrail` action. Attackers can do this to cover their tracks and impact security monitoring that relies on this source.\n\n#### Possible investigation steps\n\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Investigate other alerts associated with the user account during the past 48 hours.\n- Contact the account and resource owners and confirm whether they are aware of this activity.\n- Check if this operation was approved and performed according to the organization's change management policy.\n- Considering the source IP address and geolocation of the user who issued the command:\n    - Do they look normal for the user?\n    - If the source is an EC2 IP address, is it associated with an EC2 instance in one of your accounts or is the source IP from an EC2 instance that's not under your control?\n    - If it is an authorized EC2 instance, is the activity associated with normal behavior for the instance role or roles? Are there any other alerts or signs of suspicious activity involving this instance?\n- Investigate the deleted log trail's criticality and whether the responsible team is aware of the deletion.\n- If you suspect the account has been compromised, scope potentially compromised assets by tracking servers, services, and data accessed by the account in the last 24 hours.\n\n### False positive analysis\n\n- If this rule is noisy in your environment due to expected activity, consider adding exceptions — preferably with a combination of user and IP address conditions.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Disable or limit the account during the investigation and response.\n- Identify the possible impact of the incident and prioritize accordingly; the following actions can help you gain context:\n    - Identify the account role in the cloud environment.\n    - Assess the criticality of affected services and servers.\n    - Work with your IT team to identify and minimize the impact on users.\n    - Identify if the attacker is moving laterally and compromising other accounts, servers, or services.\n    - Identify any regulatory or legal ramifications related to this activity.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords or delete API keys as needed to revoke the attacker's access to the environment. Work with your IT teams to minimize the impact on business operations during these actions.\n- Check if unauthorized new users were created, remove unauthorized new accounts, and request password resets for other IAM users.\n- Consider enabling multi-factor authentication for users.\n- Review the permissions assigned to the implicated user to ensure that the least privilege principle is being followed.\n- Implement security best practices [outlined](https://aws.amazon.com/premiumsupport/knowledge-center/security-best-practices/) by AWS.\n- Take the actions needed to return affected systems, data, or services to their normal operational levels.\n- Identify the initial vector abused by the attacker and take action to prevent reinfection via the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).",
        "output_index": "",
        "investigation_fields": {
          "field_names": [
            "@timestamp",
            "user.name",
            "aws.cloudtrail.user_identity.arn",
            "aws.cloudtrail.user_identity.type",
            "source.address",
            "user_agent.original",
            "aws.cloudtrail.flattened.request_parameters.name",
            "event.action",
            "event.outcome",
            "cloud.region",
            "aws.cloudtrail.request_parameters"
          ]
        },
        "version": 210,
        "tags": [
          "Domain: Cloud",
          "Data Source: AWS",
          "Data Source: Amazon Web Services",
          "Use Case: Log Auditing",
          "Resources: Investigation Guide",
          "Tactic: Defense Evasion"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-3600s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Trail deletions may be made by a system or network administrator. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. Trail deletions by unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule."
        ],
        "references": [
          "https://docs.aws.amazon.com/awscloudtrail/latest/APIReference/API_DeleteTrail.html",
          "https://awscli.amazonaws.com/v2/documentation/api/latest/reference/cloudtrail/delete-trail.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.001",
                    "name": "Disable or Modify Tools",
                    "reference": "https://attack.mitre.org/techniques/T1562/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The AWS Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "aws",
            "version": "^2.0.0",
            "integration": "cloudtrail"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "e7acf5b2-53c0-4274-9528-ab8aa3d73aac",
        "rule_id": "7024e2a0-315d-4334-bb1a-441c593e16ab",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:41.922Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:35.451Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-aws.cloudtrail-*"
        ],
        "filters": [],
        "query": "event.dataset:aws.cloudtrail\n    and event.provider:cloudtrail.amazonaws.com\n    and event.action:DeleteTrail\n    and event.outcome:success",
        "language": "kuery"
      },
      {
        "name": "Suspicious Sysctl File Event",
        "description": "Monitors file events on sysctl configuration files (e.g., /etc/sysctl.conf, /etc/sysctl.d/*.conf) to identify potential unauthorized access or manipulation of system-level configuration settings. Attackers may tamper with the sysctl configuration files to modify kernel parameters, potentially compromising system stability, performance, or security.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 108,
        "tags": [
          "Data Source: Auditd Manager",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Rule Type: BBR"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1082",
                "name": "System Information Discovery",
                "reference": "https://attack.mitre.org/techniques/T1082/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires the use of the `auditd_manager` integration. `Auditd_manager` is a tool designed to simplify and enhance the management of the audit subsystem in Linux systems. It provides a user-friendly interface and automation capabilities for configuring and monitoring system auditing through the auditd daemon. With `auditd_manager`, administrators can easily define audit rules, track system events, and generate comprehensive audit reports, improving overall security and compliance in the system. The following steps should be executed in order to install and deploy `auditd_manager` on a Linux system.\n\n```\nKibana -->\nManagement -->\nIntegrations -->\nAuditd Manager -->\nAdd Auditd Manager\n```\n\n`Auditd_manager` subscribes to the kernel and receives events as they occur without any additional configuration. However, if more advanced configuration is required to detect specific behavior, audit rules can be added to the integration in either the \"audit rules\" configuration box or the \"auditd rule files\" box by specifying a file to read the audit rules from.\n\nFor this detection rule to trigger, the following additional audit rules are required to be added to the integration:\n\n```\n-w /etc/sysctl.conf -p wa -k sysctl\n-w /etc/sysctl.d -p wa -k sysctl\n```\n\nAdd the newly installed `auditd manager` to an agent policy, and deploy the agent on a Linux system from which auditd log files are desirable.\n",
        "related_integrations": [
          {
            "package": "auditd_manager",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "63ed108f-0c80-4b9a-8e29-81415968d185",
        "rule_id": "7592c127-89fb-4209-a8f6-f9944dfd7e02",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:41.928Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:36.443Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "host.os.type:linux and event.category:file and event.action:(\"opened-file\" or \"read-file\" or \"wrote-to-file\") and\nfile.path : (\"/etc/sysctl.conf\" or \"/etc/sysctl.d\" or /etc/sysctl.d/*) and not process.name:(\n  dpkg or dockerd or unattended-upg or systemd-sysctl or python* or auditbeat or dpkg or pool*\n)",
        "new_terms_fields": [
          "process.executable"
        ],
        "history_window_start": "now-14d",
        "index": [
          "auditbeat-*",
          "logs-auditd_manager.auditd-*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Access to a Sensitive LDAP Attribute",
        "description": "Identify access to sensitive Active Directory object attributes that contains credentials and decryption keys such as unixUserPassword, ms-PKI-AccountCredentials and msPKI-CredentialRoamingTokens.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 112,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Tactic: Privilege Escalation",
          "Use Case: Active Directory Monitoring",
          "Data Source: Active Directory",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.mandiant.com/resources/blog/apt29-windows-credential-roaming",
          "https://social.technet.microsoft.com/wiki/contents/articles/11483.windows-credential-roaming.aspx",
          "https://learn.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4662"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1003",
                "name": "OS Credential Dumping",
                "reference": "https://attack.mitre.org/techniques/T1003/"
              },
              {
                "id": "T1552",
                "name": "Unsecured Credentials",
                "reference": "https://attack.mitre.org/techniques/T1552/",
                "subtechnique": [
                  {
                    "id": "T1552.004",
                    "name": "Private Keys",
                    "reference": "https://attack.mitre.org/techniques/T1552/004/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1078",
                "name": "Valid Accounts",
                "reference": "https://attack.mitre.org/techniques/T1078/",
                "subtechnique": [
                  {
                    "id": "T1078.002",
                    "name": "Domain Accounts",
                    "reference": "https://attack.mitre.org/techniques/T1078/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'Audit Directory Service Access' logging policy must be configured for (Success, Failure).\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nPolicies >\nWindows Settings >\nSecurity Settings >\nAdvanced Audit Policies Configuration >\nAudit Policies >\nDS Access >\nAudit Directory Service Access (Success,Failure)\n```\n",
        "related_integrations": [
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.code",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.event_data.AccessMask",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "winlog.event_data.Properties",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "winlog.event_data.SubjectUserSid",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "a4429a32-51e9-47e9-813d-8ed171cddee9",
        "rule_id": "764c9fcd-4c4c-41e6-a0c7-d6c46c2eff66",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:41.930Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:36.467Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "any where event.action in (\"Directory Service Access\", \"object-operation-performed\") and event.code == \"4662\" and\n\n  not winlog.event_data.SubjectUserSid : \"S-1-5-18\" and\n\n  winlog.event_data.Properties : (\n   /* unixUserPassword */\n  \"*612cb747-c0e8-4f92-9221-fdd5f15b550d*\",\n\n  /* ms-PKI-AccountCredentials */\n  \"*b8dfa744-31dc-4ef1-ac7c-84baf7ef9da7*\",\n\n  /*  ms-PKI-DPAPIMasterKeys */\n  \"*b3f93023-9239-4f7c-b99c-6745d87adbc2*\",\n\n  /* msPKI-CredentialRoamingTokens */\n  \"*b7ff5a38-0818-42b0-8110-d3d154c97f24*\"\n  ) and\n\n  /*\n   Excluding noisy AccessMasks\n   0x0 undefined and 0x100 Control Access\n   https://learn.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4662\n   */\n  not winlog.event_data.AccessMask in (\"0x0\", \"0x100\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-system.*",
          "logs-windows.*"
        ],
        "filters": []
      },
      {
        "name": "Privilege Escalation via Rogue Named Pipe Impersonation",
        "description": "Identifies a privilege escalation attempt via rogue named pipe impersonation. An adversary may abuse this technique by masquerading as a known named pipe and manipulating a privileged process to connect to it.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://itm4n.github.io/printspoofer-abusing-impersonate-privileges/",
          "https://github.com/zcgonvh/EfsPotato",
          "https://twitter.com/SBousseaden/status/1429530155291193354"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1134",
                "name": "Access Token Manipulation",
                "reference": "https://attack.mitre.org/techniques/T1134/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nNamed Pipe Creation Events need to be enabled within the Sysmon configuration by including the following settings:\n`condition equal \"contains\" and keyword equal \"pipe\"`\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "f62be172-6620-4ffe-9be1-b0c0f779760d",
        "rule_id": "76ddb638-abf7-42d5-be22-4a70b0bf7241",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:41.933Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:36.482Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"windows\" and event.action : \"Pipe Created*\" and\n /* normal sysmon named pipe creation events truncate the pipe keyword */\n  file.name : \"\\\\*\\\\Pipe\\\\*\"",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "Potential Remote Desktop Tunneling Detected",
        "description": "Identifies potential use of an SSH utility to establish RDP over a reverse SSH Tunnel. This can be used by attackers to enable routing of network packets that would otherwise not reach their intended destination.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Potential Remote Desktop Tunneling Detected\n\nProtocol Tunneling is a mechanism that involves explicitly encapsulating a protocol within another for various use cases, ranging from providing an outer layer of encryption (similar to a VPN) to enabling traffic that network appliances would filter to reach their destination.\n\nAttackers may tunnel Remote Desktop Protocol (RDP) traffic through other protocols like Secure Shell (SSH) to bypass network restrictions that block incoming RDP connections but may be more permissive to other protocols.\n\nThis rule looks for command lines involving the `3389` port, which RDP uses by default and options commonly associated with tools that perform tunneling.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account and system owners and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n- Examine network data to determine if the host communicated with external servers using the tunnel.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n- Investigate the command line for the execution of programs that are unrelated to tunneling, like Remote Desktop clients.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Take the necessary actions to disable the tunneling, which can be a process kill, service deletion, registry key modification, etc. Inspect the host to learn which method was used and to determine a response for the case.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 416,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Command and Control",
          "Tactic: Lateral Movement",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: SentinelOne",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: System",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://blog.netspi.com/how-to-access-rdp-over-a-reverse-ssh-tunnel/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            },
            "technique": [
              {
                "id": "T1572",
                "name": "Protocol Tunneling",
                "reference": "https://attack.mitre.org/techniques/T1572/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1021",
                "name": "Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1021/",
                "subtechnique": [
                  {
                    "id": "T1021.004",
                    "name": "SSH",
                    "reference": "https://attack.mitre.org/techniques/T1021/004/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "cdc66ecd-3adb-43cd-82df-8aef3b553216",
        "rule_id": "76fd43b7-3480-4dd9-8ad7-8bd36bfad92f",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:41.936Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:36.491Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  /* RDP port and usual SSH tunneling related switches in command line */\n  process.args : \"*:3389\" and\n  process.args : (\"-L\", \"-P\", \"-R\", \"-pw\", \"-ssh\")",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "winlogbeat-*",
          "logs-windows.*",
          "endgame-*",
          "logs-system.security*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-m365_defender.event-*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "UID Elevation from Previously Unknown Executable",
        "description": "Monitors for the elevation of regular user permissions to root permissions through a previously unknown executable. Attackers may attempt to evade detection by hijacking the execution flow and hooking certain functions/syscalls through a rootkit in order to provide easy access to root via a special modified command.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 4,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1574",
                "name": "Hijack Execution Flow",
                "reference": "https://attack.mitre.org/techniques/T1574/",
                "subtechnique": [
                  {
                    "id": "T1574.013",
                    "name": "KernelCallbackTable",
                    "reference": "https://attack.mitre.org/techniques/T1574/013/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1014",
                "name": "Rootkit",
                "reference": "https://attack.mitre.org/techniques/T1014/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows\nthe Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click Add integrations.\n- In the query bar, search for Elastic Defend and select the integration to see more details about it.\n- Click Add Elastic Defend.\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either Traditional Endpoints or Cloud Workloads.\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest to select \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in New agent policy name. If other agent policies already exist, you can click the Existing hosts tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click Save and Continue.\n- To complete the integration, select Add Elastic Agent to your hosts and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "b4ad9324-a715-45b8-9872-8d82bb49c19f",
        "rule_id": "7787362c-90ff-4b1a-b313-8808b1020e64",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:41.944Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:36.500Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "host.os.type:\"linux\" and event.category:\"process\" and event.action:\"uid_change\" and event.type:\"change\" and user.id:\"0\"\nand process.parent.name:(\"bash\" or \"dash\" or \"sh\" or \"tcsh\" or \"csh\" or \"zsh\" or \"ksh\" or \"fish\") and not (\n  process.executable:(\n    /bin/* or /usr/bin/* or /sbin/* or /usr/sbin/* or /snap/* or /tmp/newroot/* or /var/lib/docker/* or /usr/local/* or\n    /opt/psa/admin/* or /usr/lib/snapd/snap-confine or /opt/dynatrace/* or /opt/microsoft/* or\n    /var/lib/snapd/snap/bin/node or /opt/gitlab/embedded/sbin/logrotate or /etc/apt/universal-hooks/* or\n    /opt/puppetlabs/puppet/bin/puppet or /opt/cisco/* or /run/k3s/containerd/* or /usr/lib/postfix/sbin/master or\n    /usr/libexec/postfix/local or /var/lib/snapd/snap/bin/postgresql* or /opt/puppetlabs/puppet/bin/ruby\n  ) or\n  process.name:(\n    \"bash\" or \"dash\" or \"sh\" or \"tcsh\" or \"csh\" or \"zsh\" or \"ksh\" or \"fish\" or \"sudo\" or \"su\" or \"apt\" or \"apt-get\" or\n    \"aptitude\" or \"squid\" or \"snap\" or \"fusermount\" or \"pkexec\" or \"umount\" or \"master\" or \"omsbaseline\" or \"dzdo\" or\n    \"sandfly\" or \"logrotate\"\n  ) or\n  process.args:/usr/bin/python*\n)",
        "new_terms_fields": [
          "process.executable"
        ],
        "history_window_start": "now-14d",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Suspicious ScreenConnect Client Child Process",
        "description": "Identifies suspicious processes being spawned by the ScreenConnect client processes. This activity may indicate execution abusing unauthorized access to the ScreenConnect remote access software.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 307,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Command and Control",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: System",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.huntress.com/blog/slashandgrab-screen-connect-post-exploitation-in-the-wild-cve-2024-1709-cve-2024-1708"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            },
            "technique": [
              {
                "id": "T1219",
                "name": "Remote Access Software",
                "reference": "https://attack.mitre.org/techniques/T1219/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "7c0eab8f-65f6-4b08-bd5a-7e478a9eea7c",
        "rule_id": "78de1aeb-5225-4067-b8cc-f4a1de8a8546",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:41.946Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:36.538Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.parent.name :\n                (\"ScreenConnect.ClientService.exe\",\n                 \"ScreenConnect.WindowsClient.exe\",\n                 \"ScreenConnect.WindowsBackstageShell.exe\",\n                 \"ScreenConnect.WindowsFileManager.exe\") and\n  (\n   (process.name : \"powershell.exe\" and\n    process.args : (\"-enc\", \"-ec\", \"-e\", \"*downloadstring*\", \"*Reflection.Assembly*\", \"*http*\")) or\n   (process.name : \"cmd.exe\" and process.args : \"/c\") or\n   (process.name : \"net.exe\" and process.args : \"/add\") or\n   (process.name : \"schtasks.exe\" and process.args : (\"/create\", \"-create\")) or\n   (process.name : \"sc.exe\" and process.args : \"create\") or\n   (process.name : \"rundll32.exe\" and not process.args : \"url.dll,FileProtocolHandler\") or\n   (process.name : \"msiexec.exe\" and process.args : (\"/i\", \"-i\") and\n    process.args : (\"/q\", \"/quiet\", \"/qn\", \"-q\", \"-quiet\", \"-qn\", \"-Q+\")) or\n   process.name : (\"mshta.exe\", \"certutil.exe\", \"bistadmin.exe\", \"certreq.exe\", \"wscript.exe\", \"cscript.exe\", \"curl.exe\",\n                   \"ssh.exe\", \"scp.exe\", \"wevtutil.exe\", \"wget.exe\", \"wmic.exe\")\n   )",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "winlogbeat-*",
          "logs-windows.sysmon_operational-*",
          "logs-system.security*",
          "endgame-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-m365_defender.event-*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious LSASS Access via MalSecLogon",
        "description": "Identifies suspicious access to LSASS handle from a call trace pointing to seclogon.dll and with a suspicious access rights value. This may indicate an attempt to leak an LSASS handle via abusing the Secondary Logon service in preparation for credential access.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 308,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://splintercod3.blogspot.com/p/the-hidden-side-of-seclogon-part-3.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1003",
                "name": "OS Credential Dumping",
                "reference": "https://attack.mitre.org/techniques/T1003/",
                "subtechnique": [
                  {
                    "id": "T1003.001",
                    "name": "LSASS Memory",
                    "reference": "https://attack.mitre.org/techniques/T1003/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.code",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.event_data.CallTrace",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "winlog.event_data.GrantedAccess",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "winlog.event_data.TargetImage",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "c2fd9987-7d4f-4643-9a8b-84d2657f2a99",
        "rule_id": "7ba58110-ae13-439b-8192-357b0fcfa9d7",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:41.949Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:36.599Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.code == \"10\" and\n  winlog.event_data.TargetImage : \"?:\\\\WINDOWS\\\\system32\\\\lsass.exe\" and\n\n   /* seclogon service accessing lsass */\n  winlog.event_data.CallTrace : \"*seclogon.dll*\" and process.name : \"svchost.exe\" and\n\n   /* PROCESS_CREATE_PROCESS & PROCESS_DUP_HANDLE & PROCESS_QUERY_INFORMATION */\n  winlog.event_data.GrantedAccess == \"0x14c0\"",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "Microsoft Management Console File from Unusual Path",
        "description": "Identifies attempts to open a Microsoft Management Console File from untrusted paths. Adversaries may use MSC files for initial access and execution.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 307,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: SentinelOne",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: System",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/security-labs/grimresource"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.005",
                    "name": "Visual Basic",
                    "reference": "https://attack.mitre.org/techniques/T1059/005/"
                  },
                  {
                    "id": "T1059.007",
                    "name": "JavaScript",
                    "reference": "https://attack.mitre.org/techniques/T1059/007/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1218",
                "name": "System Binary Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1218/",
                "subtechnique": [
                  {
                    "id": "T1218.014",
                    "name": "MMC",
                    "reference": "https://attack.mitre.org/techniques/T1218/014/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "4c915ade-c730-460c-9597-11b7df950037",
        "rule_id": "7e23dfef-da2c-4d64-b11d-5f285b638853",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:41.952Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:37.211Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.executable : (\n    \"?:\\\\Windows\\\\System32\\\\mmc.exe\",\n    \"\\\\Device\\\\HarddiskVolume?\\\\Windows\\\\System32\\\\mmc.exe\"\n  ) and\n  process.args : \"*.msc\" and\n  not process.args : (\n        \"?:\\\\Windows\\\\System32\\\\*.msc\",\n        \"?:\\\\Windows\\\\SysWOW64\\\\*.msc\",\n        \"?:\\\\Program files\\\\*.msc\",\n        \"?:\\\\Program Files (x86)\\\\*.msc\"\n  )",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "winlogbeat-*",
          "logs-windows.*",
          "endgame-*",
          "logs-system.security*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-m365_defender.event-*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious WMIC XSL Script Execution",
        "description": "Identifies WMIC allowlist bypass techniques by alerting on suspicious execution of scripts. When WMIC loads scripting libraries it may be indicative of an allowlist bypass.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 209,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Tactic: Execution",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1220",
                "name": "XSL Script Processing",
                "reference": "https://attack.mitre.org/techniques/T1220/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1047",
                "name": "Windows Management Instrumentation",
                "reference": "https://attack.mitre.org/techniques/T1047/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "dll.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "da073300-d75c-4023-985e-0c51b8b560f4",
        "rule_id": "7f370d54-c0eb-4270-ac5a-9a6020585dc6",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:41.955Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:37.216Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by process.entity_id with maxspan = 2m\n[process where host.os.type == \"windows\" and event.type == \"start\" and\n   (process.name : \"WMIC.exe\" or process.pe.original_file_name : \"wmic.exe\") and\n   process.args : (\"format*:*\", \"/format*:*\", \"*-format*:*\") and\n   not process.command_line : (\"* /format:table *\", \"* /format:table\")]\n[any where host.os.type == \"windows\" and (event.category == \"library\" or (event.category == \"process\" and event.action : \"Image loaded*\")) and\n (?dll.name : (\"jscript.dll\", \"vbscript.dll\") or file.name : (\"jscript.dll\", \"vbscript.dll\"))]",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-endpoint.events.library-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "Enumeration of Kernel Modules via Proc",
        "description": "Loadable Kernel Modules (or LKMs) are pieces of code that can be loaded and unloaded into the kernel upon demand. They extend the functionality of the kernel without the need to reboot the system. This identifies attempts to enumerate information about a kernel module using the /proc/modules filesystem. This filesystem is used by utilities such as lsmod and kmod to list the available kernel modules.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 107,
        "tags": [
          "Data Source: Auditd Manager",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Rule Type: BBR"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Security tools and device drivers may run these programs in order to enumerate kernel modules. Use of these programs by ordinary users is uncommon. These can be exempted by process name or username."
        ],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1082",
                "name": "System Information Discovery",
                "reference": "https://attack.mitre.org/techniques/T1082/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires the use of the `auditd_manager` integration. `Auditd_manager` is a tool designed to simplify and enhance the management of the audit subsystem in Linux systems. It provides a user-friendly interface and automation capabilities for configuring and monitoring system auditing through the auditd daemon. With `auditd_manager`, administrators can easily define audit rules, track system events, and generate comprehensive audit reports, improving overall security and compliance in the system. The following steps should be executed in order to install and deploy `auditd_manager` on a Linux system.\n```\nKibana -->\nManagement -->\nIntegrations -->\nAuditd Manager -->\nAdd Auditd Manager\n```\n`Auditd_manager` subscribes to the kernel and receives events as they occur without any additional configuration. However, if more advanced configuration is required to detect specific behavior, audit rules can be added to the integration in either the \"audit rules\" configuration box or the \"auditd rule files\" box by specifying a file to read the audit rules from.\nFor this detection rule to trigger, the following additional audit rules are required to be added to the integration:\n```\n-w /proc/ -p r -k audit_proc\n```\nAdd the newly installed `auditd manager` to an agent policy, and deploy the agent on a Linux system from which auditd log files are desirable.\n",
        "related_integrations": [
          {
            "package": "auditd_manager",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "fe3e97cd-5d5a-417e-9c10-4dff4611aa28",
        "rule_id": "80084fa9-8677-4453-8680-b891d3c0c778",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:41.957Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:37.237Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "host.os.type:linux and event.category:file and event.action:\"opened-file\" and file.path:\"/proc/modules\" and\nnot process.name:(python* or chef-client)",
        "new_terms_fields": [
          "process.executable"
        ],
        "history_window_start": "now-14d",
        "index": [
          "auditbeat-*",
          "logs-auditd_manager.auditd-*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Connection to Commonly Abused Free SSL Certificate Providers",
        "description": "Identifies unusual processes connecting to domains using known free SSL certificates. Adversaries may employ a known encryption algorithm to conceal command and control traffic.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 207,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Command and Control",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            },
            "technique": [
              {
                "id": "T1573",
                "name": "Encrypted Channel",
                "reference": "https://attack.mitre.org/techniques/T1573/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "dns.question.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "network.protocol",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "f030da7a-c9f3-4afe-bbfb-82b99394108d",
        "rule_id": "e3cf38fa-d5b8-46cc-87f9-4a7513e4281d",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:41.960Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:49.319Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "network where host.os.type == \"windows\" and network.protocol == \"dns\" and\n  /* Add new free SSL certificate provider domains here */\n  dns.question.name : (\"*letsencrypt.org\", \"*.sslforfree.com\", \"*.zerossl.com\", \"*.freessl.org\") and\n\n  /* Native Windows process paths that are unlikely to have network connections to domains secured using free SSL certificates */\n  process.executable : (\"C:\\\\Windows\\\\System32\\\\*.exe\",\n                        \"C:\\\\Windows\\\\System\\\\*.exe\",\n\t                  \"C:\\\\Windows\\\\SysWOW64\\\\*.exe\",\n\t\t          \"C:\\\\Windows\\\\Microsoft.NET\\\\Framework*\\\\*.exe\",\n\t\t          \"C:\\\\Windows\\\\explorer.exe\",\n\t\t          \"C:\\\\Windows\\\\notepad.exe\") and\n\n  /* Insert noisy false positives here */\n  not process.name : (\"svchost.exe\", \"MicrosoftEdge*.exe\", \"msedge.exe\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.network-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "Service Creation via Local Kerberos Authentication",
        "description": "Identifies a suspicious local successful logon event where the Logon Package is Kerberos, the remote address is set to localhost, followed by a sevice creation from the same LogonId. This may indicate an attempt to leverage a Kerberos relay attack variant that can be used to elevate privilege locally from a domain joined user to local System privileges.",
        "risk_score": 73,
        "severity": "high",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Tactic: Credential Access",
          "Use Case: Active Directory Monitoring",
          "Data Source: Active Directory",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/Dec0ne/KrbRelayUp",
          "https://googleprojectzero.blogspot.com/2021/10/using-kerberos-for-authentication-relay.html",
          "https://github.com/cube0x0/KrbRelay",
          "https://gist.github.com/tyranid/c24cfd1bd141d14d4925043ee7e03c82"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1543",
                "name": "Create or Modify System Process",
                "reference": "https://attack.mitre.org/techniques/T1543/",
                "subtechnique": [
                  {
                    "id": "T1543.003",
                    "name": "Windows Service",
                    "reference": "https://attack.mitre.org/techniques/T1543/003/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1558",
                "name": "Steal or Forge Kerberos Tickets",
                "reference": "https://attack.mitre.org/techniques/T1558/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "source.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "source.port",
            "type": "long",
            "ecs": true
          },
          {
            "name": "winlog.computer_name",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "winlog.event_data.AuthenticationPackageName",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "winlog.event_data.SubjectLogonId",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "winlog.event_data.TargetLogonId",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "winlog.logon.type",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "7142e495-04b8-4358-b639-800c747bb783",
        "rule_id": "e4e31051-ee01-4307-a6ee-b21b186958f4",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:41.963Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:49.333Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by winlog.computer_name with maxspan=5m\n [authentication where\n\n  /* event 4624 need to be logged */\n  event.action == \"logged-in\" and event.outcome == \"success\" and\n\n  /* authenticate locally using relayed kerberos Ticket */\n  winlog.event_data.AuthenticationPackageName :\"Kerberos\" and winlog.logon.type == \"Network\" and\n  cidrmatch(source.ip, \"127.0.0.0/8\", \"::1\") and source.port > 0] by winlog.event_data.TargetLogonId\n\n  [any where\n   /* event 4697 need to be logged */\n   event.action : \"service-installed\"] by winlog.event_data.SubjectLogonId",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-system.*",
          "logs-windows.*"
        ],
        "filters": []
      },
      {
        "name": "Execution of Persistent Suspicious Program",
        "description": "Identifies execution of suspicious persistent programs (scripts, rundll32, etc.) by looking at process lineage and command line usage.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 207,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1547",
                "name": "Boot or Logon Autostart Execution",
                "reference": "https://attack.mitre.org/techniques/T1547/",
                "subtechnique": [
                  {
                    "id": "T1547.001",
                    "name": "Registry Run Keys / Startup Folder",
                    "reference": "https://attack.mitre.org/techniques/T1547/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "732a45b3-825d-4dd9-9d7e-e620627c06bd",
        "rule_id": "e7125cea-9fe1-42a5-9a05-b0792cf86f5a",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:41.966Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:49.377Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "/* userinit followed by explorer followed by early child process of explorer (unlikely to be launched interactively) within 1m */\nsequence by host.id, user.name with maxspan=1m\n  [process where host.os.type == \"windows\" and event.type == \"start\" and process.name : \"userinit.exe\" and process.parent.name : \"winlogon.exe\"]\n  [process where host.os.type == \"windows\" and event.type == \"start\" and process.name : \"explorer.exe\"]\n  [process where host.os.type == \"windows\" and event.type == \"start\" and process.parent.name : \"explorer.exe\" and\n   /* add suspicious programs here */\n   process.pe.original_file_name in (\"cscript.exe\",\n                                     \"wscript.exe\",\n                                     \"PowerShell.EXE\",\n                                     \"MSHTA.EXE\",\n                                     \"RUNDLL32.EXE\",\n                                     \"REGSVR32.EXE\",\n                                     \"RegAsm.exe\",\n                                     \"MSBuild.exe\",\n                                     \"InstallUtil.exe\") and\n    /* add potential suspicious paths here */\n    process.args : (\"C:\\\\Users\\\\*\", \"C:\\\\ProgramData\\\\*\", \"C:\\\\Windows\\\\Temp\\\\*\", \"C:\\\\Windows\\\\Tasks\\\\*\", \"C:\\\\PerfLogs\\\\*\", \"C:\\\\Intel\\\\*\")\n   ]",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious WMI Event Subscription Created",
        "description": "Detects the creation of a WMI Event Subscription. Attackers can abuse this mechanism for persistence or to elevate to SYSTEM privileges.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.blackhat.com/docs/us-15/materials/us-15-Graeber-Abusing-Windows-Management-Instrumentation-WMI-To-Build-A-Persistent%20Asynchronous-And-Fileless-Backdoor-wp.pdf",
          "https://medium.com/threatpunter/detecting-removing-wmi-persistence-60ccbb7dff96"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1546",
                "name": "Event Triggered Execution",
                "reference": "https://attack.mitre.org/techniques/T1546/",
                "subtechnique": [
                  {
                    "id": "T1546.003",
                    "name": "Windows Management Instrumentation Event Subscription",
                    "reference": "https://attack.mitre.org/techniques/T1546/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.code",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.event_data.Consumer",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "winlog.event_data.Operation",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "ca7b5df5-703c-4057-9fd8-aca733684385",
        "rule_id": "e72f87d0-a70e-4f8d-8443-a6407bc34643",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:41.969Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:49.382Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "any where event.dataset == \"windows.sysmon_operational\" and event.code == \"21\" and\n    winlog.event_data.Operation : \"Created\" and winlog.event_data.Consumer : (\"*subscription:CommandLineEventConsumer*\", \"*subscription:ActiveScriptEventConsumer*\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "Host Files System Changes via Windows Subsystem for Linux",
        "description": "Detects files creation and modification on the host system from the the Windows Subsystem for Linux. Adversaries may enable and use WSL for Linux to avoid detection.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 107,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/microsoft/WSL"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1202",
                "name": "Indirect Command Execution",
                "reference": "https://attack.mitre.org/techniques/T1202/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "aaa6e8df-090d-4ac8-b165-5b96d288afd1",
        "rule_id": "e88d1fe9-b2f4-48d4-bace-a026dc745d4b",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:41.972Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:49.416Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by process.entity_id with maxspan=5m\n [process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.name : \"dllhost.exe\" and \n   /* Plan9FileSystem CLSID - WSL Host File System Worker */\n  process.command_line : \"*{DFB65C4C-B34F-435D-AFE9-A86218684AA8}*\"]\n [file where host.os.type == \"windows\" and process.name : \"dllhost.exe\" and not file.path : \"?:\\\\Users\\\\*\\\\Downloads\\\\*\"]",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-endpoint.events.file-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious System Commands Executed by Previously Unknown Executable",
        "description": "This rule monitors for the execution of several commonly used system commands executed by a previously unknown executable located in commonly abused directories. An alert from this rule can indicate the presence of potentially malicious activity, such as the execution of unauthorized or suspicious processes attempting to run malicious code. Detecting and investigating such behavior can help identify and mitigate potential security threats, protecting the system and its data from potential compromise.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 107,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.004",
                    "name": "Unix Shell",
                    "reference": "https://attack.mitre.org/techniques/T1059/004/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "0da64b8d-97bc-4241-8eb7-ddcb31b134aa",
        "rule_id": "e9001ee6-2d00-4d2f-849e-b8b1fb05234c",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:41.975Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:49.425Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "host.os.type:linux and event.category:process and event.action:(exec or exec_event or fork or fork_event) and\nprocess.executable:(* and (\n  /etc/crontab or /bin/* or /boot/* or /dev/shm/* or /etc/cron.*/* or /etc/init.d/* or /etc/rc*.d/* or /etc/update-motd.d/* or\n  /home/*/.* or /tmp/* or /usr/bin/* or /usr/lib/update-notifier/* or /usr/share/* or /var/tmp/*\n) and not /tmp/go-build*) and\nprocess.args:(hostname or id or ifconfig or ls or netstat or ps or pwd or route or top or uptime or whoami) and\nnot (process.name:\n  (apt or dnf or docker or dockerd or dpkg or hostname or id or ls or netstat or ps or pwd or rpm or snap or\n  snapd or sudo or top or uptime or which or whoami or yum) or\nprocess.parent.executable:(\n  /opt/cassandra/bin/cassandra or /opt/nessus/sbin/nessusd or /opt/nessus_agent/sbin/nessus-agent-module or /opt/puppetlabs/puppet/bin/puppet or\n  /opt/puppetlabs/puppet/bin/ruby or /usr/libexec/platform-python or /usr/local/cloudamize/bin/CCAgent or /usr/sbin/sshd or /bin/* or\n  /etc/network/* or /opt/Elastic/* or /opt/TrendMicro* or /opt/aws/* or /opt/eset/* or /opt/rapid7/* or /run/containerd/* or /run/k3s/* or\n  /snap/* or /tmp/dpkg-licenses* or /tmp/newroot/* or /usr/bin/* or /var/lib/amagent/* or /var/lib/docker/* or /vz/*\n  ) or\n  process.executable:(/run/containerd/* or /srv/snp/docker/* or /tmp/.criu*)\n)",
        "new_terms_fields": [
          "process.parent.executable"
        ],
        "history_window_start": "now-14d",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Unusual Print Spooler Child Process",
        "description": "Detects unusual Print Spooler service (spoolsv.exe) child processes. This may indicate an attempt to exploit privilege escalation vulnerabilities related to the Printing Service on Windows.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 209,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Use Case: Vulnerability",
          "Data Source: Elastic Defend",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Install or update of a legitimate printing driver. Verify the printer driver file metadata such as manufacturer and signature information."
        ],
        "references": [
          "https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34527"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1068",
                "name": "Exploitation for Privilege Escalation",
                "reference": "https://attack.mitre.org/techniques/T1068/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.Ext.token.integrity_level_name",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "process.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.event_data.IntegrityLevel",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "2c88b609-af5b-4ef6-9bf4-d6c91c354b55",
        "rule_id": "ee5300a7-7e31-4a72-a258-250abb8b3aa1",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:41.978Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:49.529Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n process.parent.name : \"spoolsv.exe\" and process.command_line != null and \n (?process.Ext.token.integrity_level_name : \"System\" or ?winlog.event_data.IntegrityLevel : \"System\") and\n\n /* exclusions for FP control below */\n not process.name : (\"splwow64.exe\", \"PDFCreator.exe\", \"acrodist.exe\", \"spoolsv.exe\", \"msiexec.exe\", \"route.exe\", \"WerFault.exe\") and\n not process.command_line : \"*\\\\WINDOWS\\\\system32\\\\spool\\\\DRIVERS*\" and\n not (process.name : \"net.exe\" and process.command_line : (\"*stop*\", \"*start*\")) and\n not (process.name : (\"cmd.exe\", \"powershell.exe\") and process.command_line : (\"*.spl*\", \"*\\\\program files*\", \"*route add*\")) and\n not (process.name : \"netsh.exe\" and process.command_line : (\"*add portopening*\", \"*rule name*\")) and\n not (process.name : \"regsvr32.exe\" and process.command_line : \"*PrintConfig.dll*\") and\n not process.executable : (\n    \"?:\\\\Program Files (x86)\\\\CutePDF Writer\\\\CPWriter2.exe\",\n    \"?:\\\\Program Files (x86)\\\\GPLGS\\\\gswin32c.exe\"\n )",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.*",
          "logs-system.security*"
        ],
        "filters": []
      },
      {
        "name": "Whoami Process Activity",
        "description": "Identifies suspicious use of whoami.exe which displays user, group, and privileges information for the user who is currently logged on to the local system.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Whoami Process Activity\n\nAfter successfully compromising an environment, attackers may try to gain situational awareness to plan their next steps. This can happen by running commands to enumerate network resources, users, connections, files, and installed security software.\n\nThis rule looks for the execution of the `whoami` utility. Attackers commonly use this utility to measure their current privileges, discover the current user, determine if a privilege escalation was successful, etc.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate any abnormal account behavior, such as command executions, file creations or modifications, and network connections.\n\n### False positive analysis\n\n- Discovery activities are not inherently malicious if they occur in isolation. As long as the analyst did not identify suspicious activity related to the user or host, such alerts can be dismissed.\n\n### Related rules\n\n- Account Discovery Command via SYSTEM Account - 2856446a-34e6-435b-9fb5-f8f040bfa7ed\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 213,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Some normal use of this program, at varying levels of frequency, may originate from scripts, automation tools and frameworks. Usage by non-engineers and ordinary users is unusual."
        ],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1033",
                "name": "System Owner/User Discovery",
                "reference": "https://attack.mitre.org/techniques/T1033/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.domain",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.event_data.SubjectUserName",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "9f228bef-b2d1-4d24-af05-b42c3d965dfa",
        "rule_id": "ef862985-3f13-4262-a686-5f357bbb9bc2",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:41.981Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:49.973Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and process.name : \"whoami.exe\" and\n(\n  (\n    /* scoped for whoami execution under system privileges */\n    (\n      user.domain : (\"NT *\", \"* NT\", \"IIS APPPOOL\") and\n      user.id : (\"S-1-5-18\", \"S-1-5-19\", \"S-1-5-20\", \"S-1-5-82-*\") and\n      not ?winlog.event_data.SubjectUserName : \"*$\"\n    ) and\n    not (\n      process.parent.name : \"cmd.exe\" and\n      process.parent.args : (\n          \"chcp 437>nul 2>&1 & C:\\\\WINDOWS\\\\System32\\\\whoami.exe  /groups\",\n          \"chcp 437>nul 2>&1 & %systemroot%\\\\system32\\\\whoami /user\",\n          \"C:\\\\WINDOWS\\\\System32\\\\whoami.exe /groups\",\n          \"*WINDOWS\\\\system32\\\\config\\\\systemprofile*\"\n      )\n    ) and\n    not (process.parent.executable : \"C:\\\\Windows\\\\system32\\\\inetsrv\\\\appcmd.exe\" and process.parent.args : \"LIST\") and\n    not process.parent.executable : (\n        \"C:\\\\Program Files\\\\Microsoft Monitoring Agent\\\\Agent\\\\MonitoringHost.exe\",\n        \"C:\\\\Program Files\\\\Cohesity\\\\cohesity_windows_agent_service.exe\"\n    )\n  ) or\n  process.parent.name : (\"wsmprovhost.exe\", \"w3wp.exe\", \"wmiprvse.exe\", \"rundll32.exe\", \"regsvr32.exe\")\n)",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.*",
          "logs-system.*",
          "endgame-*",
          "logs-m365_defender.event-*"
        ],
        "filters": []
      },
      {
        "name": "Service Path Modification",
        "description": "Identifies attempts to modify a service path by an unusual process. Attackers may attempt to modify existing services for persistence or privilege escalation.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 105,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Rule Type: BBR",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1112",
                "name": "Modify Registry",
                "reference": "https://attack.mitre.org/techniques/T1112/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1543",
                "name": "Create or Modify System Process",
                "reference": "https://attack.mitre.org/techniques/T1543/",
                "subtechnique": [
                  {
                    "id": "T1543.003",
                    "name": "Windows Service",
                    "reference": "https://attack.mitre.org/techniques/T1543/003/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1543",
                "name": "Create or Modify System Process",
                "reference": "https://attack.mitre.org/techniques/T1543/",
                "subtechnique": [
                  {
                    "id": "T1543.003",
                    "name": "Windows Service",
                    "reference": "https://attack.mitre.org/techniques/T1543/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.path",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "c43c4e75-5a84-4c5b-909f-e01c30e51377",
        "rule_id": "f243fe39-83a4-46f3-a3b6-707557a102df",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:41.988Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:51.638Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n  registry.path : (\n    \"HKLM\\\\SYSTEM\\\\*ControlSet*\\\\Services\\\\*\\\\ImagePath\",\n    \"\\\\REGISTRY\\\\MACHINE\\\\SYSTEM\\\\*ControlSet*\\\\Services\\\\*\\\\ImagePath\"\n  ) and not (\n    process.executable : (\n      \"?:\\\\Program Files\\\\*.exe\",\n      \"?:\\\\Program Files (x86)\\\\*.exe\",\n      \"?:\\\\Windows\\\\System32\\\\services.exe\",\n      \"?:\\\\Windows\\\\WinSxS\\\\*\"\n    )\n  )",
        "language": "eql",
        "index": [
          "logs-endpoint.events.registry-*",
          "endgame-*",
          "logs-windows.sysmon_operational-*",
          "winlogbeat-*"
        ],
        "filters": []
      },
      {
        "name": "Unusual Child Processes of RunDLL32",
        "description": "Identifies child processes of unusual instances of RunDLL32 where the command line parameters were suspicious. Misuse of RunDLL32 could indicate malicious activity.",
        "risk_score": 73,
        "severity": "high",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Unusual Child Processes of RunDLL32\n\nBy examining the specific traits of Windows binaries -- such as process trees, command lines, network connections, registry modifications, and so on -- it's possible to establish a baseline of normal activity. Deviations from this baseline can indicate malicious activity, such as masquerading and deserve further investigation.\n\nRunDLL32 is a legitimate Windows utility used to load and execute functions within dynamic-link libraries (DLLs). However, adversaries may abuse RunDLL32 to execute malicious code, bypassing security measures and evading detection. This rule identifies potential abuse by looking for an unusual process creation with no arguments followed by the creation of a child process.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate any abnormal behavior by the subject process, such as network connections, registry or file modifications, and any spawned child processes.\n- Investigate the behavior of child processes, such as network connections, registry or file modifications, and any spawned processes.\n- Inspect the host for suspicious or abnormal behavior in the alert timeframe.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the process executable using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Related Rules\n\n- Unusual Network Connection via RunDLL32 - 52aaab7b-b51c-441a-89ce-4387b3aea886\n\n### Response and Remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 208,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "30m",
        "from": "now-3600s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1218",
                "name": "System Binary Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1218/",
                "subtechnique": [
                  {
                    "id": "T1218.011",
                    "name": "Rundll32",
                    "reference": "https://attack.mitre.org/techniques/T1218/011/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args_count",
            "type": "long",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "c6cf9f5c-a862-4a58-b6cf-7183ee5037a5",
        "rule_id": "f036953a-4615-4707-a1ca-dc53bf69dcd5",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:41.984Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:49.984Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence with maxspan=1h\n  [process where host.os.type == \"windows\" and event.type == \"start\" and\n     (process.name : \"rundll32.exe\" or process.pe.original_file_name == \"RUNDLL32.EXE\") and\n      process.args_count == 1\n  ] by process.entity_id\n  [process where host.os.type == \"windows\" and event.type == \"start\" and process.parent.name : \"rundll32.exe\"\n  ] by process.parent.entity_id",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "winlogbeat-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "WMI Incoming Lateral Movement",
        "description": "Identifies processes executed via Windows Management Instrumentation (WMI) on a remote host. This could be indicative of adversary lateral movement, but could be noisy if administrators use WMI to remotely manage hosts.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 210,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Lateral Movement",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1021",
                "name": "Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1021/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1047",
                "name": "Windows Management Instrumentation",
                "reference": "https://attack.mitre.org/techniques/T1047/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.port",
            "type": "long",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "network.direction",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.Ext.token.integrity_level_name",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "source.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "source.port",
            "type": "long",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.event_data.IntegrityLevel",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "3c9a12bc-2c2a-4272-b14d-c42f98e41fb4",
        "rule_id": "f3475224-b179-4f78-8877-c2bd64c26b88",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:41.991Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:51.694Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by host.id with maxspan = 2s\n\n /* Accepted Incoming RPC connection by Winmgmt service */\n\n  [network where host.os.type == \"windows\" and process.name : \"svchost.exe\" and network.direction : (\"incoming\", \"ingress\") and\n   source.ip != \"127.0.0.1\" and source.ip != \"::1\" and source.port >= 49152 and destination.port >= 49152\n  ]\n\n  /* Excluding Common FPs Nessus and SCCM */\n\n  [process where host.os.type == \"windows\" and event.type == \"start\" and process.parent.name : \"WmiPrvSE.exe\" and\n   not (?process.Ext.token.integrity_level_name : \"System\" or ?winlog.event_data.IntegrityLevel : \"System\") and\n   not user.id : (\"S-1-5-18\", \"S-1-5-19\", \"S-1-5-20\") and\n   not process.executable :\n               (\"?:\\\\Program Files\\\\HPWBEM\\\\Tools\\\\hpsum_swdiscovery.exe\",\n                \"?:\\\\Windows\\\\CCM\\\\Ccm32BitLauncher.exe\",\n                \"?:\\\\Windows\\\\System32\\\\wbem\\\\mofcomp.exe\",\n                \"?:\\\\Windows\\\\Microsoft.NET\\\\Framework*\\\\csc.exe\",\n                \"?:\\\\Windows\\\\System32\\\\powercfg.exe\") and\n   not (process.executable : \"?:\\\\Windows\\\\System32\\\\msiexec.exe\" and process.args : \"REBOOT=ReallySuppress\") and\n   not (process.executable : \"?:\\\\Windows\\\\System32\\\\inetsrv\\\\appcmd.exe\" and process.args : \"uninstall\")\n   ]",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "logs-endpoint.events.network-*",
          "winlogbeat-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious Network Connection via systemd",
        "description": "Detects suspicious network events executed by systemd, potentially indicating persistence through a systemd backdoor. Systemd is a system and service manager for Linux operating systems, used to initialize and manage system processes. Attackers can backdoor systemd for persistence by creating or modifying systemd unit files to execute malicious scripts or commands, or by replacing legitimate systemd binaries with compromised ones, ensuring that their malicious code is automatically executed at system startup or during certain system events.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 3,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Tactic: Command and Control",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1543",
                "name": "Create or Modify System Process",
                "reference": "https://attack.mitre.org/techniques/T1543/",
                "subtechnique": [
                  {
                    "id": "T1543.002",
                    "name": "Systemd Service",
                    "reference": "https://attack.mitre.org/techniques/T1543/002/"
                  }
                ]
              },
              {
                "id": "T1574",
                "name": "Hijack Execution Flow",
                "reference": "https://attack.mitre.org/techniques/T1574/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            }
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            }
          }
        ],
        "setup": "## Setup\n\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "39a95c75-0395-4e75-bfc8-3b975321db40",
        "rule_id": "f3818c85-2207-4b51-8a28-d70fb156ee87",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:41.993Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:51.710Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by host.id with maxspan=5s\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\n   process.parent.name == \"systemd\" and process.name in (\n     \"python*\", \"php*\", \"perl\", \"ruby\", \"lua*\", \"openssl\", \"nc\", \"netcat\", \"ncat\", \"telnet\", \"awk\"\n   )\n  ] by process.entity_id\n  [network where host.os.type == \"linux\" and event.action == \"connection_attempted\" and event.type == \"start\" and\n   not process.executable == \"/tmp/newroot/bin/curl\"] by process.parent.entity_id",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Potential curl CVE-2023-38545 Exploitation",
        "description": "Detects potential exploitation of curl CVE-2023-38545 by monitoring for vulnerable command line arguments in conjunction with an unusual command line length. A flaw in curl version <= 8.3 makes curl vulnerable to a heap based buffer overflow during the SOCKS5 proxy handshake. Upgrade to curl version >= 8.4 to patch this vulnerability. This exploit can be executed with and without the use of environment variables. For increased visibility, enable the collection of http_proxy, HTTPS_PROXY and ALL_PROXY environment variables based on the instructions provided in the setup guide of this rule.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 6,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Use Case: Vulnerability",
          "Tactic: Execution",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://curl.se/docs/CVE-2023-38545.html",
          "https://daniel.haxx.se/blog/2023/10/11/curl-8-4-0/",
          "https://twitter.com/_JohnHammond/status/1711986412554531015"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1203",
                "name": "Exploitation for Client Execution",
                "reference": "https://attack.mitre.org/techniques/T1203/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\nElastic Defend integration does not collect environment variable logging by default.\nIn order to capture this behavior, this rule requires a specific configuration option set within the advanced settings of the Elastic Defend integration.\n #### To set up environment variable capture for an Elastic Agent policy:\n- Go to “Security → Manage → Policies”.\n- Select an “Elastic Agent policy”.\n- Click “Show advanced settings”.\n- Scroll down or search for “linux.advanced.capture_env_vars”.\n- Enter the names of environment variables you want to capture, separated by commas.\n- For this rule the linux.advanced.capture_env_vars variable should be set to \"http_proxy,HTTPS_PROXY,ALL_PROXY\".\n- Click “Save”.\nAfter saving the integration change, the Elastic Agents running this policy will be updated and the rule will function properly.\nFor more information on capturing environment variables refer to the [helper guide](https://www.elastic.co/guide/en/security/current/environment-variable-capture.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.env_vars",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "b9e2d482-6bd1-4abc-ba9f-4d2840b22dff",
        "rule_id": "f41296b4-9975-44d6-9486-514c6f635b2d",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:41.996Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:51.733Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and process.name == \"curl\" \nand (\n  process.args like (\"--socks5-hostname\", \"--proxy\", \"--preproxy\", \"socks5*\") or \n  process.env_vars like (\"http_proxy=socks5h://*\", \"HTTPS_PROXY=socks5h://*\", \"ALL_PROXY=socks5h://*\")\n) and length(process.command_line) > 255 and not (\n  process.parent.name in (\"cf-agent\", \"agent-run\", \"agent-check\", \"rudder\", \"agent-inventory\", \"cf-execd\") or\n  process.args like \"/opt/rudder/*\" or\n  process.parent.executable like (\"/vz/root/*\", \"/var/rudder/*\")\n)",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "DPKG Package Installed by Unusual Parent Process",
        "description": "This rule detects the installation of a Debian package (dpkg) by an unusual parent process. The dpkg command is used to install, remove, and manage Debian packages on a Linux system. Attackers can abuse the dpkg command to install malicious packages on a system.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 2,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.makeuseof.com/how-deb-packages-are-backdoored-how-to-detect-it/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1543",
                "name": "Create or Modify System Process",
                "reference": "https://attack.mitre.org/techniques/T1543/"
              },
              {
                "id": "T1546",
                "name": "Event Triggered Execution",
                "reference": "https://attack.mitre.org/techniques/T1546/",
                "subtechnique": [
                  {
                    "id": "T1546.016",
                    "name": "Installer Packages",
                    "reference": "https://attack.mitre.org/techniques/T1546/016/"
                  }
                ]
              },
              {
                "id": "T1574",
                "name": "Hijack Execution Flow",
                "reference": "https://attack.mitre.org/techniques/T1574/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1195",
                "name": "Supply Chain Compromise",
                "reference": "https://attack.mitre.org/techniques/T1195/",
                "subtechnique": [
                  {
                    "id": "T1195.002",
                    "name": "Compromise Software Supply Chain",
                    "reference": "https://attack.mitre.org/techniques/T1195/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "bb922bea-ca1d-4cbf-8414-de693f2fda0a",
        "rule_id": "f4d1c0ac-aedb-4063-9fa6-cc651eb5e6ee",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:41.999Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:51.754Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "host.os.type:linux and event.category:process and event.type:start and event.action:exec and process.name:dpkg and\nprocess.args:(\"-i\" or \"--install\")",
        "new_terms_fields": [
          "process.parent.executable"
        ],
        "history_window_start": "now-7d",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "WMIC Remote Command",
        "description": "Identifies the use of wmic.exe to run commands on remote hosts. While this can be used by administrators legitimately, attackers can abuse this built-in utility to achieve lateral movement.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 107,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Lateral Movement",
          "Data Source: Elastic Defend",
          "Rule Type: BBR",
          "Data Source: Sysmon",
          "Data Source: Elastic Endgame",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1021",
                "name": "Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1021/",
                "subtechnique": [
                  {
                    "id": "T1021.006",
                    "name": "Windows Remote Management",
                    "reference": "https://attack.mitre.org/techniques/T1021/006/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1047",
                "name": "Windows Management Instrumentation",
                "reference": "https://attack.mitre.org/techniques/T1047/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "ee299407-c921-44d3-9fd5-4f2fe67bdbdf",
        "rule_id": "f59668de-caa0-4b84-94c1-3a1549e1e798",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:42.007Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:51.777Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.name : \"WMIC.exe\" and\n  process.args : \"*node:*\" and\n  process.args : (\"call\", \"set\", \"get\") and\n  not process.args : (\"*/node:localhost*\", \"*/node:\\\"127.0.0.1\\\"*\", \"/node:127.0.0.1\")",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "winlogbeat-*"
        ],
        "filters": []
      },
      {
        "name": "Setcap setuid/setgid Capability Set",
        "description": "This rule monitors for the addition of the cap_setuid+ep or cap_setgid+ep capabilities via setcap. Setuid (Set User ID) and setgid (Set Group ID) are Unix-like OS features that enable processes to run with elevated privileges, based on the file owner or group. Threat actors can exploit these attributes to achieve persistence by creating malicious binaries, allowing them to maintain control over a compromised system with elevated permissions.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Setcap setuid/setgid Capability Set\n\nSetuid (Set User ID) and setgid (Set Group ID) are Unix-like OS features that enable processes to run with elevated privileges, based on the file owner or group.\n\nThreat actors can exploit these attributes to achieve persistence by creating malicious binaries, allowing them to maintain control over a compromised system with elevated permissions.\n\nThis rule monitors for the addition of the cap_setuid+ep or cap_setgid+ep capabilities via setcap.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n> This investigation guide uses [placeholder fields](https://www.elastic.co/guide/en/security/current/osquery-placeholder-fields.html) to dynamically pass alert data into Osquery queries. Placeholder fields were introduced in Elastic Stack version 8.7.0. If you're using Elastic Stack version 8.6.0 or earlier, you'll need to manually adjust this investigation guide's queries to ensure they properly run.\n\n#### Possible Investigation Steps\n\n- Investigate the file that was targeted by the addition of the setuid/setgid capability through OSQuery.\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence and whether they are located in expected locations.\n  - !{osquery{\"label\":\"Osquery - Retrieve Running Processes by User\",\"query\":\"SELECT pid, username, name FROM processes p JOIN users u ON u.uid = p.uid ORDER BY username\"}}\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Validate the activity is not related to planned patches, updates, network administrator activity, or legitimate software installations.\n- Investigate whether the altered scripts call other malicious scripts elsewhere on the file system. \n  - If scripts or executables were dropped, retrieve the files and determine if they are malicious:\n    - Use a private sandboxed malware analysis system to perform analysis.\n      - Observe and collect information about the following activities:\n        - Attempts to contact external domains and addresses.\n          - Check if the domain is newly registered or unexpected.\n          - Check the reputation of the domain or IP address.\n        - File access, modification, and creation activities.\n        - Cron jobs, services and other persistence mechanisms.\n            - !{osquery{\"label\":\"Osquery - Retrieve Crontab Information\",\"query\":\"SELECT * FROM crontab\"}}\n- Investigate abnormal behaviors by the subject process/user such as network connections, file modifications, and any other spawned child processes.\n  - Investigate listening ports and open sockets to look for potential command and control traffic or data exfiltration.\n    - !{osquery{\"label\":\"Osquery - Retrieve Listening Ports\",\"query\":\"SELECT pid, address, port, socket, protocol, path FROM listening_ports\"}}\n    - !{osquery{\"label\":\"Osquery - Retrieve Open Sockets\",\"query\":\"SELECT pid, family, remote_address, remote_port, socket, state FROM process_open_sockets\"}}\n  - Identify the user account that performed the action, analyze it, and check whether it should perform this kind of action.\n    - !{osquery{\"label\":\"Osquery - Retrieve Information for a Specific User\",\"query\":\"SELECT * FROM users WHERE username = {{user.name}}\"}}\n- Investigate whether the user is currently logged in and active.\n    - !{osquery{\"label\":\"Osquery - Investigate the Account Authentication Status\",\"query\":\"SELECT * FROM logged_in_users WHERE user = {{user.name}}\"}}\n\n### False Positive Analysis\n\n- If this activity is related to new benign software installation activity, consider adding exceptions — preferably with a combination of user and command line conditions.\n- If this activity is related to a system administrator that performed these actions for administrative purposes, consider adding exceptions for this specific administrator user account. \n- Try to understand the context of the execution by thinking about the user, machine, or business purpose. A small number of endpoints, such as servers with unique software, might appear unusual but satisfy a specific business need.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Leverage the incident response data and logging to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 6,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            }
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1548",
                "name": "Abuse Elevation Control Mechanism",
                "reference": "https://attack.mitre.org/techniques/T1548/",
                "subtechnique": [
                  {
                    "id": "T1548.001",
                    "name": "Setuid and Setgid",
                    "reference": "https://attack.mitre.org/techniques/T1548/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "8f86e768-9066-44c7-9e53-fd7219ac0062",
        "rule_id": "f5c005d3-4e17-48b0-9cd7-444d48857f97",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:42.010Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:51.784Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\") and \nprocess.name == \"setcap\" and process.args : \"cap_set?id+ep\" and not (\n  process.parent.name in (\"jem\", \"vzctl\") or\n  process.args like \"/usr/bin/new?idmap\"\n)",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "Masquerading Space After Filename",
        "description": "This rules identifies a process created from an executable with a space appended to the end of the filename. This may indicate an attempt to masquerade a malicious file as benign to gain user execution. When a space is added to the end of certain files, the OS will execute the file according to it's true filetype instead of it's extension. Adversaries can hide a program's true filetype by changing the extension of the file. They can then add a space to the end of the name so that the OS automatically executes the file when it's double-clicked.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 7,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "OS: macOS",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.picussecurity.com/resource/blog/picus-10-critical-mitre-attck-techniques-t1036-masquerading"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1036",
                "name": "Masquerading",
                "reference": "https://attack.mitre.org/techniques/T1036/",
                "subtechnique": [
                  {
                    "id": "T1036.006",
                    "name": "Space after Filename",
                    "reference": "https://attack.mitre.org/techniques/T1036/006/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.args",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "52817dd8-f331-41a6-a55f-3d1f3a2318cb",
        "rule_id": "f5fb4598-4f10-11ed-bdc3-0242ac120002",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:42.013Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:51.791Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type:(\"linux\",\"macos\") and event.type == \"start\" and\nprocess.executable regex~ \"\"\"/[a-z0-9\\s_\\-\\\\./]+\\s\"\"\" and not (\n  process.name in (\"ls\", \"find\", \"grep\", \"xkbcomp\") or\n  process.executable like (\"/opt/nessus_agent/*\", \"/opt/gitlab/sv/gitlab-exporter/*\", \"/tmp/ansible-admin/*\") or\n  process.parent.args in (\n    \"./check_rubrik\", \"/usr/bin/check_mk_agent\", \"/etc/rubrik/start_stop_bootstrap.sh\", \"/etc/rubrik/start_stop_agent.sh\"\n  )\n)",
        "language": "eql",
        "index": [
          "auditbeat-*",
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Potential Privilege Escalation via Linux DAC permissions",
        "description": "Identifies potential privilege escalation exploitation of DAC (Discretionary access control) file permissions. The rule identifies exploitation of DAC checks on sensitive file paths via suspicious processes whose capabilities include CAP_DAC_OVERRIDE (where a process can bypass all read write and execution checks) or CAP_DAC_READ_SEARCH (where a process can read any file or perform any executable permission on the directories).",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 3,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1068",
                "name": "Exploitation for Privilege Escalation",
                "reference": "https://attack.mitre.org/techniques/T1068/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.thread.capabilities.effective",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.thread.capabilities.permitted",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "9023bdcd-ef6f-4c50-893c-76ed8bbc9463",
        "rule_id": "f7c70f2e-4616-439c-85ac-5b98415042fe",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:42.016Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:51.914Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "event.category:process and host.os.type:linux and event.type:start and event.action:exec and\n(process.thread.capabilities.permitted:CAP_DAC_* or process.thread.capabilities.effective: CAP_DAC_*) and\nprocess.command_line:(*sudoers* or *passwd* or *shadow* or */root/*) and not (\n  user.id : \"0\" or\n  process.name : (\n    \"tar\" or \"getent\" or \"su\" or \"stat\" or \"dirname\" or \"chown\" or \"sudo\" or \"dpkg-split\" or \"dpkg-deb\" or \"dpkg\" or\n    \"podman\" or \"awk\" or \"passwd\" or \"dpkg-maintscript-helper\" or \"mutt_dotlock\" or \"nscd\" or \"logger\" or \"gpasswd\"\n  ) or\n  process.executable : /usr/lib/*/lxc/rootfs/* or\n  process.parent.name : (\n    \"dpkg\" or \"java\" or *postinst or \"dpkg-preconfigure\" or \"gnome-shell\"\n  )\n)",
        "new_terms_fields": [
          "process.executable"
        ],
        "history_window_start": "now-10d",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "First Occurrence of Personal Access Token (PAT) Use For a GitHub User",
        "description": "A new PAT was used for a GitHub user not previously seen in the last 14 days.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 204,
        "tags": [
          "Domain: Cloud",
          "Use Case: Threat Detection",
          "Use Case: UEBA",
          "Tactic: Persistence",
          "Rule Type: BBR",
          "Data Source: Github"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1098",
                "name": "Account Manipulation",
                "reference": "https://attack.mitre.org/techniques/T1098/",
                "subtechnique": [
                  {
                    "id": "T1098.001",
                    "name": "Additional Cloud Credentials",
                    "reference": "https://attack.mitre.org/techniques/T1098/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "github",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "github.hashed_token",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "github.programmatic_access_type",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "user.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "34626b70-d73d-4d01-8c87-ab0ef5301b11",
        "rule_id": "f94e898e-94f1-4545-8923-03e4b2866211",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:42.019Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:51.935Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "event.dataset:\"github.audit\" and event.category:\"configuration\" and\ngithub.hashed_token:* and user.name:* and\ngithub.programmatic_access_type:(\"OAuth access token\" or \"Fine-grained personal access token\")",
        "new_terms_fields": [
          "user.name",
          "github.hashed_token"
        ],
        "history_window_start": "now-14d",
        "index": [
          "logs-github.audit-*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Abnormal Process ID or Lock File Created",
        "description": "Identifies the creation of a Process ID (PID), lock or reboot file created in temporary file storage paradigm (tmpfs) directory /var/run. On Linux, the PID files typically hold the process ID to track previous copies running and manage other tasks. Certain Linux malware use the /var/run directory for holding data, executables and other tasks, disguising itself or these files as legitimate PID files.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Abnormal Process ID or Lock File Created\n\nLinux applications may need to save their process identification number (PID) for various purposes: from signaling that a program is running to serving as a signal that a previous instance of an application didn't exit successfully. PID files contain its creator process PID in an integer value.\n\nLinux lock files are used to coordinate operations in files so that conflicts and race conditions are prevented.\n\nThis rule identifies the creation of PID, lock, or reboot files in the /var/run/ directory. Attackers can masquerade malware, payloads, staged data for exfiltration, and more as legitimate PID files.\n\n#### Possible investigation steps\n\n- Retrieve the file and determine if it is malicious:\n    - Check the contents of the PID files. They should only contain integer strings.\n    - Check the file type of the lock and PID files to determine if they are executables. This is only observed in     malicious files.\n    - Check the size of the subject file. Legitimate PID files should be under 10 bytes.\n    - Check if the lock or PID file has high entropy. This typically indicates an encrypted payload.\n        - Analysts can use tools like `ent` to measure entropy.\n    - Examine the reputation of the SHA-256 hash in the PID file. Use a database like VirusTotal to identify additional pivots and artifacts for investigation.\n- Trace the file's creation to ensure it came from a legitimate or authorized process.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate any abnormal account behavior, such as command executions, file creations or modifications, and network connections.\n- Investigate any abnormal behavior by the subject process such as network connections, file modifications, and any spawned child processes.\n\n### False positive analysis\n\n- False positives can appear if the PID file is legitimate and holding a process ID as intended. If the PID file is an executable or has a file size that's larger than 10 bytes, it should be ruled suspicious.\n- If this activity is expected and noisy in your environment, consider adding exceptions — preferably with a combination of file name and process executable conditions.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Block the identified indicators of compromise (IoCs).\n- Take actions to terminate processes and connections used by the attacker.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 214,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Threat: BPFDoor",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "False-Positives (FP) can appear if the PID file is legitimate and holding a process ID as intended. To differentiate, if the PID file is an executable or larger than 10 bytes, it should be ruled suspicious."
        ],
        "references": [
          "https://www.sandflysecurity.com/blog/linux-file-masquerading-and-malicious-pids-sandfly-1-2-6-update/",
          "https://twitter.com/GossiTheDog/status/1522964028284411907",
          "https://exatrack.com/public/Tricephalic_Hellkeeper.pdf",
          "https://www.elastic.co/security-labs/a-peek-behind-the-bpfdoor"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1106",
                "name": "Native API",
                "reference": "https://attack.mitre.org/techniques/T1106/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "b9251041-5423-45f5-b5de-dc16588fc367",
        "rule_id": "cac91072-d165-11ec-a764-f661ea17fbce",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:42.030Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:45.683Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "host.os.type:linux and event.category:file and event.action:(creation or file_create_event) and\nfile.extension:(pid or lock or reboot) and file.path:(/var/run/* or /run/*) and (\n  (process.name : (\n    bash or dash or sh or tcsh or csh or zsh or ksh or fish or ash or touch or nano or vim or vi or editor or mv or cp)\n  ) or (\n  process.executable : (\n    ./* or /tmp/* or /var/tmp/* or /dev/shm/* or /var/run/* or /boot/* or /srv/* or /run/*\n  ))\n) and not (\n  process.executable : (\n  /tmp/newroot/* or /run/containerd/* or /run/k3s/containerd/* or /run/k0s/container* or /snap/* or /vz/* or\n  /var/lib/docker/* or /etc/*/universal-hooks/pkgs/mysql-community-server/* or /var/lib/snapd/* or /etc/rubrik/* or\n  /run/udev/data/*\n  ) or\n  process.name : (\n    go or git or containerd* or snap-confine or cron or crond or sshd or unattended-upgrade or vzctl or ifup or\n    rpcbind or runc or gitlab-runner-helper or elastic-agent or metricbeat or redis-server or\n    s6-ipcserver-socketbinder or xinetd\n  ) or\n  file.name : (\n    jem.*.pid or lynis.pid or redis.pid or yum.pid or MFS.pid or jenkins.pid or nvmupdate.pid or openlitespeed.pid or\n    rhnsd.pid\n  ) or\n  file.path : (/run/containerd/* or /var/run/docker/containerd/* or /var/run/jem*.pid)\n)",
        "new_terms_fields": [
          "process.executable",
          "file.name"
        ],
        "history_window_start": "now-14d",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Kernel Module Removal",
        "description": "Kernel modules are pieces of code that can be loaded and unloaded into the kernel upon demand. They extend the functionality of the kernel without the need to reboot the system. This rule identifies attempts to remove a kernel module.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 110,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "There is usually no reason to remove modules, but some buggy modules require it. These can be exempted by username. Note that some Linux distributions are not built to support the removal of modules at all."
        ],
        "references": [
          "http://man7.org/linux/man-pages/man8/modprobe.8.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.001",
                    "name": "Disable or Modify Tools",
                    "reference": "https://attack.mitre.org/techniques/T1562/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1547",
                "name": "Boot or Logon Autostart Execution",
                "reference": "https://attack.mitre.org/techniques/T1547/",
                "subtechnique": [
                  {
                    "id": "T1547.006",
                    "name": "Kernel Modules and Extensions",
                    "reference": "https://attack.mitre.org/techniques/T1547/006/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "880127e2-ca0b-4477-bd0b-59fc0546e4ff",
        "rule_id": "cd66a5af-e34b-4bb0-8931-57d0a043f2ef",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:42.232Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:45.740Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\") and (\n  process.name == \"rmmod\" or\n  (process.name == \"modprobe\" and process.args in (\"--remove\", \"-r\"))\n) and process.parent.name in (\"sudo\", \"bash\", \"dash\", \"ash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\")",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious Antimalware Scan Interface DLL",
        "description": "Identifies the creation of the Antimalware Scan Interface (AMSI) DLL in an unusual location. This may indicate an attempt to bypass AMSI by loading a rogue AMSI module instead of the legit one.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Suspicious Antimalware Scan Interface DLL\n\nThe Windows Antimalware Scan Interface (AMSI) is a versatile interface standard that allows your applications and services to integrate with any antimalware product on a machine. AMSI integrates with multiple Windows components, ranging from User Account Control (UAC) to VBA macros and PowerShell.\n\nAttackers might copy a rogue AMSI DLL to an unusual location to prevent the process from loading the legitimate module, achieving a bypass to execute malicious code.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Identify the process that created the DLL and which account was used.\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate the execution of scripts and macros after the registry modification.\n- Investigate other processes launched from the directory that the DLL was created.\n- Inspect the host for suspicious or abnormal behavior in the alert timeframe:\n  - Observe and collect information about the following activities in the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n\n### False positive analysis\n\n- This modification should not happen legitimately. Any potential benign true positive (B-TP) should be mapped and monitored by the security team as these modifications expose the host to malware infections.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 313,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Endgame",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Microsoft Defender for Endpoint"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/S3cur3Th1sSh1t/Amsi-Bypass-Powershell"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.001",
                    "name": "Disable or Modify Tools",
                    "reference": "https://attack.mitre.org/techniques/T1562/001/"
                  }
                ]
              },
              {
                "id": "T1574",
                "name": "Hijack Execution Flow",
                "reference": "https://attack.mitre.org/techniques/T1574/",
                "subtechnique": [
                  {
                    "id": "T1574.001",
                    "name": "DLL Search Order Hijacking",
                    "reference": "https://attack.mitre.org/techniques/T1574/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "30784159-76c0-4865-a375-ec9b8cc6abe6",
        "rule_id": "fa488440-04cc-41d7-9279-539387bf2a17",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:42.024Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:51.981Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"windows\" and event.type != \"deletion\" and file.path != null and\n  file.name : (\"amsi.dll\", \"amsi\") and\n  not file.path : (\n    \"?:\\\\Windows\\\\system32\\\\amsi.dll\",\n    \"?:\\\\Windows\\\\Syswow64\\\\amsi.dll\",\n    \"?:\\\\$WINDOWS.~BT\\\\DUImageSandbox\\\\*\",\n    \"?:\\\\$WINDOWS.~BT\\\\NewOS\\\\Windows\\\\WinSXS\\\\*\",\n    \"?:\\\\$WINDOWS.~BT\\\\NewOS\\\\Windows\\\\servicing\\\\LCU\\\\*\",\n    \"?:\\\\$WINDOWS.~BT\\\\Work\\\\*\\\\*\",\n    \"?:\\\\Windows\\\\SoftwareDistribution\\\\Download\\\\*\",\n    \"?:\\\\Windows\\\\WinSxS\\\\amd64_microsoft-antimalware-scan-interface_*\\\\amsi.dll\"\n  ) and\n  not\n  (\n    process.executable : \"C:\\\\Windows\\\\System32\\\\wbengine.exe\" and\n    file.path : (\n      \"\\\\Device\\\\HarddiskVolume??\\\\Windows\\\\system32\\\\amsi.dll\",\n      \"\\\\Device\\\\HarddiskVolume??\\\\Windows\\\\syswow64\\\\amsi.dll\",\n      \"\\\\Device\\\\HarddiskVolume??\\\\Windows\\\\WinSxS\\\\*\\\\amsi.dll\"\n    )\n  )",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.file-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-m365_defender.event-*"
        ],
        "filters": []
      },
      {
        "name": "Potential Linux Ransomware Note Creation Detected",
        "description": "This rule identifies a sequence of a mass file encryption event in conjunction with the creation of a .txt file with a file name containing ransomware keywords executed by the same process in a 1 second timespan. Ransomware is a type of malware that encrypts a victim's files or systems and demands payment (usually in cryptocurrency) in exchange for the decryption key. One important indicator of a ransomware attack is the mass encryption of the file system, after which a new file extension is added to the file.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 10,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Impact",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0040",
              "name": "Impact",
              "reference": "https://attack.mitre.org/tactics/TA0040/"
            },
            "technique": [
              {
                "id": "T1486",
                "name": "Data Encrypted for Impact",
                "reference": "https://attack.mitre.org/techniques/T1486/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "19ca33d3-d8c9-4bbb-b38c-7c97baab9f74",
        "rule_id": "c8935a8b-634a-4449-98f7-bb24d3b2c0af",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:42.027Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:45.777Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by process.entity_id, host.id with maxspan=1s \n  [file where host.os.type == \"linux\" and event.type == \"change\" and event.action == \"rename\" and file.extension : \"?*\" \n   and process.executable : (\"./*\", \"/tmp/*\", \"/var/tmp/*\", \"/dev/shm/*\", \"/var/run/*\", \"/boot/*\") and\n   file.path : (\n     \"/home/*/Downloads/*\", \"/home/*/Documents/*\", \"/root/*\", \"/bin/*\", \"/usr/bin/*\", \"/var/log/*\", \"/var/lib/log/*\",\n     \"/var/backup/*\", \"/var/www/*\") and\n   not process.name : (\n     \"dpkg\", \"yum\", \"dnf\", \"rpm\", \"dockerd\", \"go\", \"java\", \"pip*\", \"python*\", \"node\", \"containerd\", \"php\", \"p4d\",\n     \"conda\", \"chrome\", \"imap\", \"cmake\", \"firefox\", \"semanage\", \"semodule\", \"ansible-galaxy\", \"fc-cache\", \"jammy\", \"git\",\n     \"systemsettings\", \"vmis-launcher\", \"bundle\", \"kudu-tserver\", \"suldownloader\", \"rustup-init\"\n    )\n  ] with runs=25\n  [file where host.os.type == \"linux\" and event.action == \"creation\" and\n   file.name : (\"*restore*\", \"*lock*\", \"*recovery*\", \"*read*\", \"*instruction*\", \"*how_to*\", \"*ransom*\")\n  ]",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Privileged Account Brute Force",
        "description": "Identifies multiple consecutive logon failures targeting an Admin account from the same source address and within a short time interval. Adversaries will often brute force login attempts across multiple users with a common or known password, in an attempt to gain access to accounts.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Privileged Account Brute Force\n\nAdversaries with no prior knowledge of legitimate credentials within the system or environment may guess passwords to attempt access to accounts. Without knowledge of the password for an account, an adversary may opt to guess the password using a repetitive or iterative mechanism systematically. More details can be found [here](https://attack.mitre.org/techniques/T1110/001/).\n\nThis rule identifies potential password guessing/brute force activity from a single address against an account that contains the `admin` pattern on its name, which is likely a highly privileged account.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the logon failure reason code and the targeted user name.\n  - Prioritize the investigation if the account is critical or has administrative privileges over the domain.\n- Investigate the source IP address of the failed Network Logon attempts.\n  - Identify whether these attempts are coming from the internet or are internal.\n- Investigate other alerts associated with the involved users and source host during the past 48 hours.\n- Identify the source and the target computer and their roles in the IT environment.\n- Check whether the involved credentials are used in automation or scheduled tasks.\n- If this activity is suspicious, contact the account owner and confirm whether they are aware of it.\n- Examine the source host for derived artifacts that indicate compromise:\n  - Observe and collect information about the following activities in the alert source host:\n    - Attempts to contact external domains and addresses.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the host which is the source of this activity.\n\n### False positive analysis\n\n- Authentication misconfiguration or obsolete credentials.\n- Service account password expired.\n- Domain trust relationship issues.\n- Infrastructure or availability issues.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the source host to prevent further post-compromise behavior.\n- If the asset is exposed to the internet with RDP or other remote services available, take the necessary measures to restrict access to the asset. If not possible, limit the access via the firewall to only the needed IP addresses. Also, ensure the system uses robust authentication mechanisms and is patched regularly.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 110,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Resources: Investigation Guide",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4625"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1110",
                "name": "Brute Force",
                "reference": "https://attack.mitre.org/techniques/T1110/",
                "subtechnique": [
                  {
                    "id": "T1110.001",
                    "name": "Password Guessing",
                    "reference": "https://attack.mitre.org/techniques/T1110/001/"
                  },
                  {
                    "id": "T1110.003",
                    "name": "Password Spraying",
                    "reference": "https://attack.mitre.org/techniques/T1110/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "source.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "user.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.computer_name",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "winlog.event_data.Status",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "winlog.logon.type",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "7d8081cd-178f-473b-bc89-c53c1445f26a",
        "rule_id": "f9790abf-bd0c-45f9-8b5f-d0b74015e029",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:42.021Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:51.952Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by winlog.computer_name, source.ip with maxspan=10s\n  [authentication where event.action == \"logon-failed\" and winlog.logon.type : \"Network\" and\n    source.ip != null and source.ip != \"127.0.0.1\" and source.ip != \"::1\" and user.name : \"*admin*\" and\n\n    /* noisy failure status codes often associated to authentication misconfiguration */\n    not winlog.event_data.Status : (\"0xC000015B\", \"0XC000005E\", \"0XC0000133\", \"0XC0000192\")] with runs=5",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-system.security*",
          "logs-windows.forwarded*"
        ],
        "filters": []
      },
      {
        "name": "Service Command Lateral Movement",
        "description": "Identifies use of sc.exe to create, modify, or start services on remote hosts. This could be indicative of adversary lateral movement but will be noisy if commonly done by admins.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 207,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Lateral Movement",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1021",
                "name": "Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1021/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1543",
                "name": "Create or Modify System Process",
                "reference": "https://attack.mitre.org/techniques/T1543/",
                "subtechnique": [
                  {
                    "id": "T1543.003",
                    "name": "Windows Service",
                    "reference": "https://attack.mitre.org/techniques/T1543/003/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1569",
                "name": "System Services",
                "reference": "https://attack.mitre.org/techniques/T1569/",
                "subtechnique": [
                  {
                    "id": "T1569.002",
                    "name": "Service Execution",
                    "reference": "https://attack.mitre.org/techniques/T1569/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "f01ac02b-cb27-4b99-a5b7-6b754c2e7872",
        "rule_id": "d61cbcf8-1bc1-4cff-85ba-e7b21c5beedc",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:44.470Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:47.209Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by process.entity_id with maxspan = 1m\n  [process where host.os.type == \"windows\" and event.type == \"start\" and\n     (process.name : \"sc.exe\" or process.pe.original_file_name : \"sc.exe\") and\n      process.args : \"\\\\\\\\*\" and process.args : (\"binPath=*\", \"binpath=*\") and\n      process.args : (\"create\", \"config\", \"failure\", \"start\")]\n  [network where host.os.type == \"windows\" and process.name : \"sc.exe\" and destination.ip != \"127.0.0.1\"]",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "logs-endpoint.events.network-*",
          "winlogbeat-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "WMI WBEMTEST Utility Execution",
        "description": "Adversaries may abuse the WMI diagnostic tool, wbemtest.exe, to enumerate WMI object instances or invoke methods against local or remote endpoints.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 104,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Data Source: Elastic Defend",
          "Rule Type: BBR",
          "Data Source: Elastic Endgame",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1047",
                "name": "Windows Management Instrumentation",
                "reference": "https://attack.mitre.org/techniques/T1047/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "aaa06d97-4a6a-4dfa-b0fd-87fe884d7931",
        "rule_id": "d3551433-782f-4e22-bbea-c816af2d41c6",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:44.473Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:47.151Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and process.name : \"wbemtest.exe\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "winlogbeat-*",
          "logs-windows.*",
          "endgame-*",
          "logs-system.security*"
        ],
        "filters": []
      },
      {
        "name": "Remote Windows Service Installed",
        "description": "Identifies a network logon followed by Windows service creation with same LogonId. This could be indicative of lateral movement, but will be noisy if commonly done by administrators.\"",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 107,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Lateral Movement",
          "Tactic: Persistence",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1021",
                "name": "Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1021/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1543",
                "name": "Create or Modify System Process",
                "reference": "https://attack.mitre.org/techniques/T1543/",
                "subtechnique": [
                  {
                    "id": "T1543.003",
                    "name": "Windows Service",
                    "reference": "https://attack.mitre.org/techniques/T1543/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "source.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "winlog.computer_name",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "winlog.event_data.ServiceFileName",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "winlog.event_data.SubjectLogonId",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "winlog.logon.id",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "winlog.logon.type",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "079baa0a-7b4c-458f-9026-6fc69f48b396",
        "rule_id": "d33ea3bf-9a11-463e-bd46-f648f2a0f4b1",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:44.476Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:47.146Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by winlog.logon.id, winlog.computer_name with maxspan=1m\n[authentication where event.action == \"logged-in\" and winlog.logon.type : \"Network\" and\nevent.outcome==\"success\" and source.ip != null and source.ip != \"127.0.0.1\" and source.ip != \"::1\"]\n[iam where event.action == \"service-installed\" and\n not winlog.event_data.SubjectLogonId : \"0x3e7\" and\n not winlog.event_data.ServiceFileName :\n               (\"?:\\\\Windows\\\\ADCR_Agent\\\\adcrsvc.exe\",\n                \"?:\\\\Windows\\\\System32\\\\VSSVC.exe\",\n                \"?:\\\\Windows\\\\servicing\\\\TrustedInstaller.exe\",\n                \"?:\\\\Windows\\\\System32\\\\svchost.exe\",\n                \"?:\\\\Program Files (x86)\\\\*.exe\",\n                \"?:\\\\Program Files\\\\*.exe\",\n                \"?:\\\\Windows\\\\PSEXESVC.EXE\",\n                \"?:\\\\Windows\\\\System32\\\\sppsvc.exe\",\n                \"?:\\\\Windows\\\\System32\\\\wbem\\\\WmiApSrv.exe\",\n                \"?:\\\\WINDOWS\\\\RemoteAuditService.exe\",\n                \"?:\\\\Windows\\\\VeeamVssSupport\\\\VeeamGuestHelper.exe\",\n                \"?:\\\\Windows\\\\VeeamLogShipper\\\\VeeamLogShipper.exe\",\n                \"?:\\\\Windows\\\\CAInvokerService.exe\",\n                \"?:\\\\Windows\\\\System32\\\\upfc.exe\",\n                \"?:\\\\Windows\\\\AdminArsenal\\\\PDQ*.exe\",\n                \"?:\\\\Windows\\\\System32\\\\vds.exe\",\n                \"?:\\\\Windows\\\\Veeam\\\\Backup\\\\VeeamDeploymentSvc.exe\",\n                \"?:\\\\Windows\\\\ProPatches\\\\Scheduler\\\\STSchedEx.exe\",\n                \"?:\\\\Windows\\\\System32\\\\certsrv.exe\",\n                \"?:\\\\Windows\\\\eset-remote-install-service.exe\",\n                \"?:\\\\Pella Corporation\\\\Pella Order Management\\\\GPAutoSvc.exe\",\n                \"?:\\\\Pella Corporation\\\\OSCToGPAutoService\\\\OSCToGPAutoSvc.exe\",\n                \"?:\\\\Pella Corporation\\\\Pella Order Management\\\\GPAutoSvc.exe\",\n                \"?:\\\\Windows\\\\SysWOW64\\\\NwxExeSvc\\\\NwxExeSvc.exe\",\n                \"?:\\\\Windows\\\\System32\\\\taskhostex.exe\")]",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-system.*",
          "logs-windows.*"
        ],
        "filters": []
      },
      {
        "name": "First Occurrence GitHub Event for a Personal Access Token (PAT)",
        "description": "Detects a first occurrence event for a personal access token (PAT) not seen in the last 14 days.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 204,
        "tags": [
          "Domain: Cloud",
          "Use Case: Threat Detection",
          "Use Case: UEBA",
          "Tactic: Execution",
          "Rule Type: BBR",
          "Data Source: Github"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1648",
                "name": "Serverless Execution",
                "reference": "https://attack.mitre.org/techniques/T1648/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "github",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "github.hashed_token",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "github.programmatic_access_type",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "94270db9-b3c2-4b2d-896f-11df2035d2cc",
        "rule_id": "ce08b55a-f67d-4804-92b5-617b0fe5a5b5",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:44.479Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:45.766Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "event.dataset:\"github.audit\" and event.category:\"configuration\" and\nevent.action:* and github.hashed_token:* and \ngithub.programmatic_access_type:(\"OAuth access token\" or \"Fine-grained personal access token\")",
        "new_terms_fields": [
          "github.hashed_token",
          "event.action"
        ],
        "history_window_start": "now-14d",
        "index": [
          "logs-github.audit-*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Unusual DPKG Execution",
        "description": "This rule detects the execution of the DPKG command by processes not associated with the DPKG package manager. The DPKG command is used to install, remove, and manage Debian packages on a Linux system. Attackers can abuse the DPKG command to install malicious packages on a system.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 2,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.makeuseof.com/how-deb-packages-are-backdoored-how-to-detect-it/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1546",
                "name": "Event Triggered Execution",
                "reference": "https://attack.mitre.org/techniques/T1546/",
                "subtechnique": [
                  {
                    "id": "T1546.016",
                    "name": "Installer Packages",
                    "reference": "https://attack.mitre.org/techniques/T1546/016/"
                  }
                ]
              },
              {
                "id": "T1543",
                "name": "Create or Modify System Process",
                "reference": "https://attack.mitre.org/techniques/T1543/"
              },
              {
                "id": "T1574",
                "name": "Hijack Execution Flow",
                "reference": "https://attack.mitre.org/techniques/T1574/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1195",
                "name": "Supply Chain Compromise",
                "reference": "https://attack.mitre.org/techniques/T1195/",
                "subtechnique": [
                  {
                    "id": "T1195.002",
                    "name": "Compromise Software Supply Chain",
                    "reference": "https://attack.mitre.org/techniques/T1195/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.group_leader.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.session_leader.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "4e5c8f27-7322-4c72-8301-c3cfeaf587e2",
        "rule_id": "d6241c90-99f2-44db-b50f-299b6ebd7ee9",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:44.499Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:47.214Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\nprocess.executable : \"/var/lib/dpkg/info/*\" and process.session_leader.name != null and\nprocess.group_leader.name != null and not (\n  process.parent.name in (\"dpkg\", \"dpkg-reconfigure\") or\n  process.session_leader.name == \"dpkg\" or\n  process.group_leader.name == \"dpkg\" or\n  process.parent.executable in (\"/usr/share/debconf/frontend\", \"/usr/bin/unattended-upgrade\")\n)",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious Memory grep Activity",
        "description": "Monitors for grep activity related to memory mapping. The /proc/*/maps file in Linux provides a memory map for a specific process, detailing the memory segments, permissions, and what files are mapped to these segments. Attackers may read a process's memory map to identify memory addresses for code injection or process hijacking.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 3,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/arget13/DDexec"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1057",
                "name": "Process Discovery",
                "reference": "https://attack.mitre.org/techniques/T1057/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "71828790-9b84-46f3-b7be-793e34127b32",
        "rule_id": "d74d6506-427a-4790-b170-0c2a6ddac799",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:44.502Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:47.238Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\") and\nprocess.name in (\"grep\", \"egrep\", \"fgrep\", \"rgrep\") and process.args in (\"[stack]\", \"[vdso]\", \"[heap]\")",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "AWS IAM Deactivation of MFA Device",
        "description": "Identifies the deactivation of a specified multi-factor authentication (MFA) device and removes it from association with the user name for which it was originally enabled. In AWS Identity and Access Management (IAM), a device must be deactivated before it can be deleted.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating AWS IAM Deactivation of MFA Device\n\nMulti-factor authentication (MFA) in AWS is a simple best practice that adds an extra layer of protection on top of your user name and password. With MFA enabled, when a user signs in to an AWS Management Console, they will be prompted for their user name and password (the first factor—what they know), as well as for an authentication code from their AWS MFA device (the second factor—what they have). Taken together, these multiple factors provide increased security for your AWS account settings and resources.\n\nFor more information about using MFA in AWS, access the [official documentation](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_mfa.html).\n\nThis rule looks for the deactivation or deletion of AWS MFA devices. These modifications weaken account security and can lead to the compromise of accounts and other assets.\n\n#### Possible investigation steps\n\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Investigate other alerts associated with the user account during the past 48 hours.\n- Contact the account and resource owners and confirm whether they are aware of this activity.\n- Check if this operation was approved and performed according to the organization's change management policy.\n- If you suspect the account has been compromised, scope potentially compromised assets by tracking servers, services, and data accessed by the account in the last 24 hours.\n\n### False positive analysis\n\n- While this activity can be done by administrators, all users must use MFA. The security team should address any potential benign true positive (B-TP), as this configuration can risk the user and domain.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Disable or limit the account during the investigation and response.\n- Identify the possible impact of the incident and prioritize accordingly; the following actions can help you gain context:\n    - Identify the account role in the cloud environment.\n    - Assess the criticality of affected services and servers.\n    - Work with your IT team to identify and minimize the impact on users.\n    - Identify if the attacker is moving laterally and compromising other accounts, servers, or services.\n    - Identify any regulatory or legal ramifications related to this activity.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords or delete API keys as needed to revoke the attacker's access to the environment. Work with your IT teams to minimize the impact on business operations during these actions.\n- Reactivate multi-factor authentication for the user.\n- Review the permissions assigned to the implicated user to ensure that the least privilege principle is being followed.\n- Implement security best practices [outlined](https://aws.amazon.com/premiumsupport/knowledge-center/security-best-practices/) by AWS.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection via the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).",
        "output_index": "",
        "version": 210,
        "tags": [
          "Domain: Cloud",
          "Data Source: AWS",
          "Data Source: Amazon Web Services",
          "Data Source: AWS IAM",
          "Resources: Investigation Guide",
          "Tactic: Impact",
          "Tactic: Persistence"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-3600s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic",
          "Austin Songer"
        ],
        "false_positives": [
          "A MFA device may be deactivated by a system or network administrator. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. MFA device deactivations from unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule."
        ],
        "references": [
          "https://awscli.amazonaws.com/v2/documentation/api/latest/reference/iam/deactivate-mfa-device.html",
          "https://docs.aws.amazon.com/IAM/latest/APIReference/API_DeactivateMFADevice.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0040",
              "name": "Impact",
              "reference": "https://attack.mitre.org/tactics/TA0040/"
            },
            "technique": [
              {
                "id": "T1531",
                "name": "Account Access Removal",
                "reference": "https://attack.mitre.org/techniques/T1531/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1556",
                "name": "Modify Authentication Process",
                "reference": "https://attack.mitre.org/techniques/T1556/",
                "subtechnique": [
                  {
                    "id": "T1556.006",
                    "name": "Multi-Factor Authentication",
                    "reference": "https://attack.mitre.org/techniques/T1556/006/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The AWS Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "aws",
            "version": "^2.0.0",
            "integration": "cloudtrail"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "4d96389d-ef73-4ab1-8bd3-6fd11ab6d96c",
        "rule_id": "d8fc1cca-93ed-43c1-bbb6-c0dd3eff2958",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:44.505Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:47.278Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-aws.cloudtrail-*"
        ],
        "filters": [],
        "query": "event.dataset:aws.cloudtrail and event.provider:iam.amazonaws.com and event.action:(DeactivateMFADevice or DeleteVirtualMFADevice) and event.outcome:success",
        "language": "kuery"
      },
      {
        "name": "Suspicious Service was Installed in the System",
        "description": "Identifies the creation of a new Windows service with suspicious Service command values. Windows services typically run as SYSTEM and can be used for privilege escalation and persistence.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Suspicious Service was Installed in the System\n\nAttackers may create new services to execute system shells and other command execution utilities to elevate their privileges from administrator to SYSTEM. They can also configure services to execute these utilities with persistence payloads.\n\nThis rule looks for suspicious services being created with suspicious traits compatible with the above behavior.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify how the service was created or modified. Look for registry changes events or Windows events related to service activities (for example, 4697 and/or 7045).\n  - Examine the created and existent services, the executables or drivers referenced, and command line arguments for suspicious entries.\n    - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n    - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n    - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n    - !{osquery{\"label\":\"Osquery - Retrieve All Non-Microsoft Drivers with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, class, description, directory, image,\\nissuer_name, manufacturer, service, signed, subject_name FROM drivers JOIN authenticode ON drivers.image =\\nauthenticode.path JOIN hash ON drivers.image = hash.path WHERE NOT (provider == \\\"Microsoft\\\" AND signed == \\\"1\\\")\\n\"}}\n    - !{osquery{\"label\":\"Osquery - Retrieve All Unsigned Drivers with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, class, description, directory, image,\\nissuer_name, manufacturer, service, signed, subject_name FROM drivers JOIN authenticode ON drivers.image =\\nauthenticode.path JOIN hash ON drivers.image = hash.path WHERE signed == \\\"0\\\"\\n\"}}\n  - Retrieve the referenced files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n\n\n### False positive analysis\n\n- Certain services such as PSEXECSVC may happen legitimately. The security team should address any potential benign true positive (B-TP) by excluding the relevant FP by pattern.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Delete the service.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 110,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Resources: Investigation Guide",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1543",
                "name": "Create or Modify System Process",
                "reference": "https://attack.mitre.org/techniques/T1543/",
                "subtechnique": [
                  {
                    "id": "T1543.003",
                    "name": "Windows Service",
                    "reference": "https://attack.mitre.org/techniques/T1543/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.code",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.event_data.ImagePath",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "winlog.event_data.ServiceFileName",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "5d9187ce-8aba-41c3-8aea-394f8cdf3883",
        "rule_id": "da87eee1-129c-4661-a7aa-57d0b9645fad",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:44.508Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:47.291Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "any where\n  (event.code : \"4697\" and\n   (winlog.event_data.ServiceFileName : \n           (\"*COMSPEC*\", \"*\\\\127.0.0.1*\", \"*Admin$*\", \"*powershell*\", \"*rundll32*\", \"*cmd.exe*\", \"*PSEXESVC*\", \n            \"*echo*\", \"*RemComSvc*\", \"*.bat*\", \"*.cmd*\", \"*certutil*\", \"*vssadmin*\", \"*certmgr*\", \"*bitsadmin*\", \n            \"*\\\\Users\\\\*\", \"*\\\\Windows\\\\Temp\\\\*\", \"*\\\\Windows\\\\Tasks\\\\*\", \"*\\\\PerfLogs\\\\*\", \"*\\\\Windows\\\\Debug\\\\*\",\n            \"*regsvr32*\", \"*msbuild*\") or\n   winlog.event_data.ServiceFileName regex~ \"\"\"%systemroot%\\\\[a-z0-9]+\\.exe\"\"\")) or\n\n  (event.code : \"7045\" and\n   winlog.event_data.ImagePath : (\n       \"*COMSPEC*\", \"*\\\\127.0.0.1*\", \"*Admin$*\", \"*powershell*\", \"*rundll32*\", \"*cmd.exe*\", \"*PSEXESVC*\",\n       \"*echo*\", \"*RemComSvc*\", \"*.bat*\", \"*.cmd*\", \"*certutil*\", \"*vssadmin*\", \"*certmgr*\", \"*bitsadmin*\",\n       \"*\\\\Users\\\\*\", \"*\\\\Windows\\\\Temp\\\\*\", \"*\\\\Windows\\\\Tasks\\\\*\", \"*\\\\PerfLogs\\\\*\", \"*\\\\Windows\\\\Debug\\\\*\",\n       \"*regsvr32*\", \"*msbuild*\"))",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-system.*",
          "logs-windows.*"
        ],
        "filters": []
      },
      {
        "name": "Potential Hidden Process via Mount Hidepid",
        "description": "Identifies the execution of mount process with hidepid parameter, which can make processes invisible to other users from the system. Adversaries using Linux kernel version 3.2+ (or RHEL/CentOS v6.5+ above) can hide the process from other users. When hidepid=2 option is executed to mount the /proc filesystem, only the root user can see all processes and the logged-in user can only see their own process. This provides a defense evasion mechanism for the adversaries to hide their process executions from all other commands such as ps, top, pgrep and more. With the Linux kernel hardening hidepid option all the user has to do is remount the /proc filesystem with the option, which can now be monitored and detected.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 9,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Auditd Manager"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.cyberciti.biz/faq/linux-hide-processes-from-other-users/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1564",
                "name": "Hide Artifacts",
                "reference": "https://attack.mitre.org/techniques/T1564/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "auditd_manager",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.command_line",
            "type": "wildcard",
            "ecs": true
          }
        ],
        "id": "6a4d0757-7f76-4bc7-8f20-2b99ba813f8e",
        "rule_id": "dc71c186-9fe4-4437-a4d0-85ebb32b8204",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:44.510Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:47.316Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and\nevent.action in (\"exec\", \"exec_event\", \"executed\", \"process_started\") and\nprocess.name == \"mount\" and process.args == \"/proc\" and process.args == \"-o\" and process.args : \"*hidepid=2*\" and\nnot process.parent.command_line like \"/opt/cloudlinux/*\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*",
          "auditbeat-*",
          "logs-auditd_manager.auditd-*"
        ],
        "filters": []
      },
      {
        "name": "KRBTGT Delegation Backdoor",
        "description": "Identifies the modification of the msDS-AllowedToDelegateTo attribute to KRBTGT. Attackers can use this technique to maintain persistence to the domain by having the ability to request tickets for the KRBTGT service.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 208,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Use Case: Active Directory Monitoring",
          "Data Source: Active Directory",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://skyblue.team/posts/delegate-krbtgt",
          "https://github.com/atc-project/atomic-threat-coverage/blob/master/Atomic_Threat_Coverage/Logging_Policies/LP_0026_windows_audit_user_account_management.md"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1098",
                "name": "Account Manipulation",
                "reference": "https://attack.mitre.org/techniques/T1098/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1558",
                "name": "Steal or Forge Kerberos Tickets",
                "reference": "https://attack.mitre.org/techniques/T1558/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'Audit User Account Management' logging policy must be configured for (Success, Failure).\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nPolicies >\nWindows Settings >\nSecurity Settings >\nAdvanced Audit Policies Configuration >\nAudit Policies >\nAccount Management >\nAudit User Account Management (Success,Failure)\n```\n",
        "related_integrations": [
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.code",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.event_data.AllowedToDelegateTo",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "d4125594-bfa8-45d8-a9a6-39f61fb43997",
        "rule_id": "e052c845-48d0-4f46-8a13-7d0aba05df82",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:44.513Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:47.850Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "iam where event.action == \"modified-user-account\" and event.code == \"4738\" and\n  winlog.event_data.AllowedToDelegateTo : \"*krbtgt*\"",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-system.*",
          "logs-windows.*"
        ],
        "filters": []
      },
      {
        "name": "Potentially Suspicious Process Started via tmux or screen",
        "description": "This rule monitors for the execution of suspicious commands via screen and tmux. When launching a command and detaching directly, the commands will be executed in the background via its parent process. Attackers may leverage screen or tmux to execute commands while attempting to evade detection.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 5,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1218",
                "name": "System Binary Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1218/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "8e92db58-76a8-4d16-b4e6-79a898ce51f3",
        "rule_id": "e0cc3807-e108-483c-bf66-5a4fbe0d7e89",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:44.516Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:47.859Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\") and \nprocess.parent.name in (\"screen\", \"tmux\") and process.name like (\n  \"nmap\", \"nc\", \"ncat\", \"netcat\", \"socat\", \"nc.openbsd\", \"ngrok\", \"ping\", \"java\", \"php*\", \"perl\", \"ruby\", \"lua*\",\n  \"openssl\", \"telnet\", \"wget\", \"curl\", \"id\"\n)",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "Network Traffic Capture via CAP_NET_RAW",
        "description": "Identifies the ability of a process to be able to create RAW and PACKET socket types for the available network namespaces by a non-root user. A malicious process with this capability may exploit routing between hosts, bypass network access controls, and otherwise tamper with host networking if a firewall is not in place to limit the packet types and contents. The CAP_NET_RAW capability allows the process to bind to any address within the available namespaces, which allows network traffic sniffing by a non root user. The rule identifies previously unknown processes executing with CAP_NET_RAW capabilities through the use of the new terms rule type.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 4,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Data Source: Elastic Defend",
          "Rule Type: BBR"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1040",
                "name": "Network Sniffing",
                "reference": "https://attack.mitre.org/techniques/T1040/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.thread.capabilities.effective",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.thread.capabilities.permitted",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "7bb33c65-e1b1-4bba-9a10-ba59bc09ccbf",
        "rule_id": "e28b8093-833b-4eda-b877-0873d134cf3c",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:44.518Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:49.544Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "event.category:\"process\" and host.os.type:\"linux\" and event.type:\"start\" and event.action:\"exec\" and process.name:* and\n(process.thread.capabilities.effective:\"CAP_NET_RAW\" or process.thread.capabilities.permitted:\"CAP_NET_RAW\") and\nnot user.id:\"0\"",
        "new_terms_fields": [
          "process.executable"
        ],
        "history_window_start": "now-14d",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Suspicious Zoom Child Process",
        "description": "A suspicious Zoom child process was detected, which may indicate an attempt to run unnoticed. Verify process details such as command line, network connections, file writes and associated file signature details as well.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Suspicious Zoom Child Process\n\nBy examining the specific traits of Windows binaries -- such as process trees, command lines, network connections, registry modifications, and so on -- it's possible to establish a baseline of normal activity. Deviations from this baseline can indicate malicious activity, such as masquerading, and deserve further investigation.\n\nThis rule identifies a potential malicious process masquerading as `Zoom.exe` or exploiting a vulnerability in the application causing it to execute code.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate any abnormal behavior by the subject process such as network connections, registry or file modifications, and any spawned child processes.\n- Examine the command line of the child process to determine which commands or scripts were executed.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the process executable using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 416,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Tactic: Execution",
          "Data Source: Elastic Endgame",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend",
          "Data Source: SentinelOne",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: System",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1036",
                "name": "Masquerading",
                "reference": "https://attack.mitre.org/techniques/T1036/"
              },
              {
                "id": "T1055",
                "name": "Process Injection",
                "reference": "https://attack.mitre.org/techniques/T1055/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1203",
                "name": "Exploitation for Client Execution",
                "reference": "https://attack.mitre.org/techniques/T1203/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "40647900-185b-4e54-820b-5d93473f693d",
        "rule_id": "97aba1ef-6034-4bd3-8c1a-1e0996b27afa",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:44.521Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:40.710Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n process.parent.name : \"Zoom.exe\" and process.name : (\"cmd.exe\", \"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.*",
          "endgame-*",
          "logs-system.security*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-m365_defender.event-*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Indirect Command Execution via Forfiles/Pcalua",
        "description": "Identifies indirect command execution via Program Compatibility Assistant (pcalua.exe) or forfiles.exe.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 104,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend",
          "Rule Type: BBR",
          "Data Source: Elastic Endgame",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1202",
                "name": "Indirect Command Execution",
                "reference": "https://attack.mitre.org/techniques/T1202/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "20d78ee5-92ff-472d-b229-0599031c1479",
        "rule_id": "98843d35-645e-4e66-9d6a-5049acd96ce1",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:44.524Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:40.745Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.parent.name : (\"pcalua.exe\", \"forfiles.exe\")",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "logs-system.security*",
          "winlogbeat-*",
          "logs-windows.*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "Access Control List Modification via setfacl",
        "description": "This rule detects Linux Access Control List (ACL) modification via the setfacl command.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 2,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame",
          "Data Source: Auditd Manager"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.uptycs.com/blog/threat-research-report-team/evasive-techniques-used-by-malicious-linux-shell-scripts"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1222",
                "name": "File and Directory Permissions Modification",
                "reference": "https://attack.mitre.org/techniques/T1222/",
                "subtechnique": [
                  {
                    "id": "T1222.002",
                    "name": "Linux and Mac File and Directory Permissions Modification",
                    "reference": "https://attack.mitre.org/techniques/T1222/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "auditd_manager",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "dbaf198a-93f4-4053-93fd-9cec46b29d06",
        "rule_id": "999565a2-fc52-4d72-91e4-ba6712c0377e",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:44.526Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:40.779Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and\nevent.action in (\"exec\", \"exec_event\", \"executed\", \"process_started\") and\nprocess.name == \"setfacl\" and not (\n  process.command_line == \"/bin/setfacl --restore=-\" or\n  process.args == \"/var/log/journal/\"\n)",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*",
          "auditbeat-*",
          "logs-auditd_manager.auditd-*"
        ],
        "filters": []
      },
      {
        "name": "Potential Shadow File Read via Command Line Utilities",
        "description": "Identifies access to the /etc/shadow file via the commandline using standard system utilities. After elevating privileges to root, threat actors may attempt to read or dump this file in order to gain valid credentials. They may utilize these to move laterally undetected and access additional resources.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 209,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Tactic: Credential Access",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.cyberciti.biz/faq/unix-linux-password-cracking-john-the-ripper/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1068",
                "name": "Exploitation for Privilege Escalation",
                "reference": "https://attack.mitre.org/techniques/T1068/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1003",
                "name": "OS Credential Dumping",
                "reference": "https://attack.mitre.org/techniques/T1003/",
                "subtechnique": [
                  {
                    "id": "T1003.008",
                    "name": "/etc/passwd and /etc/shadow",
                    "reference": "https://attack.mitre.org/techniques/T1003/008/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.working_directory",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "e42f6b4e-a943-44f9-a7a0-c222bbf0378a",
        "rule_id": "9a3a3689-8ed1-4cdb-83fb-9506db54c61f",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:44.529Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:40.799Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "host.os.type : \"linux\" and event.category : \"process\" and event.action : (\"exec\" or \"exec_event\") and\n(process.args : \"/etc/shadow\" or (process.working_directory: \"/etc\" and process.args: \"shadow\")) and not (\n  (process.executable : (\"/bin/chown\" or \"/usr/bin/chown\") and process.args : \"root:shadow\") or\n  (process.executable : (\"/bin/chmod\" or \"/usr/bin/chmod\") and process.args : \"640\") or\n  process.executable:(/vz/* or /var/lib/docker/* or /run/containerd/* or /tmp/.criu* or /tmp/newroot/*) or\n  process.parent.name:(gen_passwd_sets or scc_* or wazuh-modulesd)\n)",
        "new_terms_fields": [
          "process.executable"
        ],
        "history_window_start": "now-10d",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "GitHub Owner Role Granted To User",
        "description": "This rule detects when a member is granted the organization owner role of a GitHub organization. This role provides admin level privileges. Any new owner role should be investigated to determine its validity. Unauthorized owner roles could indicate compromise within your organization and provide unlimited access to data and settings.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Cloud",
          "Use Case: Threat Detection",
          "Use Case: UEBA",
          "Tactic: Persistence",
          "Data Source: Github"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1098",
                "name": "Account Manipulation",
                "reference": "https://attack.mitre.org/techniques/T1098/",
                "subtechnique": [
                  {
                    "id": "T1098.003",
                    "name": "Additional Cloud Roles",
                    "reference": "https://attack.mitre.org/techniques/T1098/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "github",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "github.permission",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "ab47826b-95c8-4a33-86b6-b94966a36342",
        "rule_id": "9b343b62-d173-4cfd-bd8b-e6379f964ca4",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:44.532Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:40.808Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "iam where event.dataset == \"github.audit\" and event.action == \"org.update_member\" and github.permission == \"admin\"",
        "language": "eql",
        "index": [
          "logs-github.audit-*"
        ],
        "filters": []
      },
      {
        "name": "Privilege Escalation via CAP_SETUID/SETGID Capabilities",
        "description": "Identifies instances where a process (granted CAP_SETUID and/or CAP_SETGID capabilities) is executed, after which the user's access is elevated to UID/GID 0 (root). In Linux, the CAP_SETUID and CAP_SETGID capabilities allow a process to change its UID and GID, respectively, providing control over user and group identity management. Attackers may leverage a misconfiguration for exploitation in order to escalate their privileges to root.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 4,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1068",
                "name": "Exploitation for Privilege Escalation",
                "reference": "https://attack.mitre.org/techniques/T1068/"
              },
              {
                "id": "T1548",
                "name": "Abuse Elevation Control Mechanism",
                "reference": "https://attack.mitre.org/techniques/T1548/",
                "subtechnique": [
                  {
                    "id": "T1548.001",
                    "name": "Setuid and Setgid",
                    "reference": "https://attack.mitre.org/techniques/T1548/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.thread.capabilities.effective",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.thread.capabilities.permitted",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "1210cd54-e798-44f1-9f53-045b273ab84c",
        "rule_id": "9b80cb26-9966-44b5-abbf-764fbdbc3586",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:44.534Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:40.813Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by host.id, process.entity_id with maxspan=1s\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and process.name != null and\n   (process.thread.capabilities.effective : \"CAP_SET?ID\" or process.thread.capabilities.permitted : \"CAP_SET?ID\") and \n   user.id != \"0\" and not (\n     process.parent.executable : (\"/tmp/newroot/*\", \"/opt/carbonblack*\") or\n     process.parent.executable in (\n       \"/opt/SolarWinds/Agent/bin/Plugins/JobEngine/SolarWinds.Agent.JobEngine.Plugin\", \"/usr/bin/vmware-toolbox-cmd\",\n       \"/usr/bin/dbus-daemon\", \"/usr/bin/update-notifier\", \"/usr/share/language-tools/language-options\",\n       \"/opt/SolarWinds/Agent/*\", \"/usr/local/sbin/lynis.sh\"\n     ) or\n     process.executable : (\"/opt/dynatrace/*\", \"/tmp/newroot/*\", \"/opt/SolarWinds/Agent/*\") or\n     process.executable in (\n       \"/bin/fgrep\", \"/usr/bin/sudo\", \"/usr/bin/pkexec\", \"/usr/lib/cockpit/cockpit-session\", \"/usr/sbin/suexec\"\n     ) or\n     process.parent.name in (\"update-notifier\", \"language-options\", \"osqueryd\", \"saposcol\", \"dbus-daemon\", \"osqueryi\", \"sdbrun\") or\n     process.command_line like (\"sudo*BECOME-SUCCESS*\", \"/bin/sh*sapsysinfo.sh*\", \"sudo su\", \"sudo su -\") or\n     process.name == \"sudo\" or\n     process.parent.command_line like \"/usr/bin/python*ansible*\"\n   )]\n  [process where host.os.type == \"linux\" and event.action == \"uid_change\" and event.type == \"change\" and \n   (process.thread.capabilities.effective : \"CAP_SET?ID\" or process.thread.capabilities.permitted : \"CAP_SET?ID\")\n   and user.id == \"0\"]",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Remote Scheduled Task Creation via RPC",
        "description": "Identifies scheduled task creation from a remote source. This could be indicative of adversary lateral movement.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Remote Scheduled Task Creation\n\n[Scheduled tasks](https://docs.microsoft.com/en-us/windows/win32/taskschd/about-the-task-scheduler) are a great mechanism for persistence and program execution. These features can be used remotely for a variety of legitimate reasons, but at the same time used by malware and adversaries. When investigating scheduled tasks that were set up remotely, one of the first steps should be to determine the original intent behind the configuration and to verify if the activity is tied to benign behavior such as software installation or any kind of network administrator work. One objective for these alerts is to understand the configured action within the scheduled task. This is captured within the registry event data for this rule and can be base64 decoded to view the value.\n\n#### Possible investigation steps\n\n- Review the TaskContent value to investigate the task configured action.\n- Validate if the activity is not related to planned patches, updates, network administrator activity, or legitimate software installations.\n- Further examination should include review of host-based artifacts and network logs from around when the scheduled task was created, on both the source and target machines.\n\n### False positive analysis\n\n- There is a high possibility of benign activity tied to the creation of remote scheduled tasks as it is a general feature within Windows and used for legitimate purposes for a wide range of activity. Any kind of context should be found to further understand the source of the activity and determine the intent based on the scheduled task's contents.\n\n### Related rules\n\n- Service Command Lateral Movement - d61cbcf8-1bc1-4cff-85ba-e7b21c5beedc\n- Remotely Started Services via RPC - aa9a274d-6b53-424d-ac5e-cb8ca4251650\n- Remote Scheduled Task Creation - 954ee7c8-5437-49ae-b2d6-2960883898e9\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Remove scheduled task and any other related artifacts.\n- Review privileged account management and user account management settings. Consider implementing group policy object (GPO) policies to further restrict activity, or configuring settings that only allow administrators to create remote scheduled tasks.\n",
        "output_index": "",
        "version": 109,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Lateral Movement",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1021",
                "name": "Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1021/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1053",
                "name": "Scheduled Task/Job",
                "reference": "https://attack.mitre.org/techniques/T1053/",
                "subtechnique": [
                  {
                    "id": "T1053.005",
                    "name": "Scheduled Task",
                    "reference": "https://attack.mitre.org/techniques/T1053/005/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.event_data.ClientProcessId",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "winlog.event_data.RpcCallClientLocality",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "65725659-15db-4efd-97c8-5ffeab40d0ca",
        "rule_id": "9c865691-5599-447a-bac9-b3f2df5f9a9d",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:44.537Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:40.817Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "iam where event.action == \"scheduled-task-created\" and \n winlog.event_data.RpcCallClientLocality : \"0\" and winlog.event_data.ClientProcessId : \"0\"",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-system.security*",
          "logs-windows.forwarded*"
        ],
        "filters": []
      },
      {
        "name": "Potential Credential Access via Trusted Developer Utility",
        "description": "An instance of MSBuild, the Microsoft Build Engine, loaded DLLs (dynamically linked libraries) responsible for Windows credential management. This technique is sometimes used for credential dumping.",
        "risk_score": 73,
        "severity": "high",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Potential Credential Access via Trusted Developer Utility\n\nThe Microsoft Build Engine is a platform for building applications. This engine, also known as MSBuild, provides an XML schema for a project file that controls how the build platform processes and builds software.\n\nAdversaries can abuse MSBuild to proxy the execution of malicious code. The inline task capability of MSBuild that was introduced in .NET version 4 allows for C# or Visual Basic code to be inserted into an XML project file. MSBuild will compile and execute the inline task. `MSBuild.exe` is a signed Microsoft binary, and the execution of code using it can bypass application control defenses that are configured to allow `MSBuild.exe` execution.\n\nThis rule looks for the MSBuild process loading `vaultcli.dll` or `SAMLib.DLL`, which indicates the execution of credential access activities.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate abnormal behaviors observed by the subject process, such as network connections, registry or file modifications, and any spawned child processes.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Examine the command line to identify the `.csproj` file location.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the file using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 210,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Tactic: Defense Evasion",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "The Build Engine is commonly used by Windows developers but use by non-engineers is unusual."
        ],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1003",
                "name": "OS Credential Dumping",
                "reference": "https://attack.mitre.org/techniques/T1003/",
                "subtechnique": [
                  {
                    "id": "T1003.002",
                    "name": "Security Account Manager",
                    "reference": "https://attack.mitre.org/techniques/T1003/002/"
                  }
                ]
              },
              {
                "id": "T1555",
                "name": "Credentials from Password Stores",
                "reference": "https://attack.mitre.org/techniques/T1555/",
                "subtechnique": [
                  {
                    "id": "T1555.004",
                    "name": "Windows Credential Manager",
                    "reference": "https://attack.mitre.org/techniques/T1555/004/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1127",
                "name": "Trusted Developer Utilities Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1127/",
                "subtechnique": [
                  {
                    "id": "T1127.001",
                    "name": "MSBuild",
                    "reference": "https://attack.mitre.org/techniques/T1127/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "dll.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "404507ef-07a5-4fa1-a2d7-0121b4308129",
        "rule_id": "9d110cb3-5f4b-4c9a-b9f5-53f0a1707ae5",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:44.540Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:40.826Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by process.entity_id\n [process where host.os.type == \"windows\" and event.type == \"start\" and (process.name : \"MSBuild.exe\" or process.pe.original_file_name == \"MSBuild.exe\")]\n [any where host.os.type == \"windows\" and (event.category == \"library\" or (event.category == \"process\" and event.action : \"Image loaded*\")) and\n  (?dll.name : (\"vaultcli.dll\", \"SAMLib.DLL\") or file.name : (\"vaultcli.dll\", \"SAMLib.DLL\"))]",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-endpoint.events.library-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "Process Injection by the Microsoft Build Engine",
        "description": "An instance of MSBuild, the Microsoft Build Engine, created a thread in another process. This technique is sometimes used to evade detection or elevate privileges.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 207,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Tactic: Privilege Escalation",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "The Build Engine is commonly used by Windows developers but use by non-engineers is unusual."
        ],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1055",
                "name": "Process Injection",
                "reference": "https://attack.mitre.org/techniques/T1055/"
              },
              {
                "id": "T1127",
                "name": "Trusted Developer Utilities Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1127/",
                "subtechnique": [
                  {
                    "id": "T1127.001",
                    "name": "MSBuild",
                    "reference": "https://attack.mitre.org/techniques/T1127/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1055",
                "name": "Process Injection",
                "reference": "https://attack.mitre.org/techniques/T1055/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "7ac0789d-8497-4f68-8f75-b638321b72c0",
        "rule_id": "9d110cb3-5f4b-4c9a-b9f5-53f0a1707ae9",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:44.542Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:40.831Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and process.name: \"MSBuild.exe\" and\n    event.action:(\"CreateRemoteThread detected (rule: CreateRemoteThread)\", \"CreateRemoteThread\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "File Permission Modification in Writable Directory",
        "description": "Identifies file permission modifications in common writable directories by a non-root user. Adversaries often drop files or payloads into a writable directory and change permissions prior to execution.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 211,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Certain programs or applications may modify files or change ownership in writable directories. These can be exempted by username."
        ],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1222",
                "name": "File and Directory Permissions Modification",
                "reference": "https://attack.mitre.org/techniques/T1222/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from one of the following integrations:\n- Elastic Defend\n- Auditbeat\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n### Auditbeat Setup\nAuditbeat is a lightweight shipper that you can install on your servers to audit the activities of users and processes on your systems. For example, you can use Auditbeat to collect and centralize audit events from the Linux Audit Framework. You can also use Auditbeat to detect changes to critical files, like binaries and configuration files, and identify potential security policy violations.\n\n#### The following steps should be executed in order to add the Auditbeat on a Linux System:\n- Elastic provides repositories available for APT and YUM-based distributions. Note that we provide binary packages, but no source packages.\n- To install the APT and YUM repositories follow the setup instructions in this [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/setup-repositories.html).\n- To run Auditbeat on Docker follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/running-on-docker.html).\n- To run Auditbeat on Kubernetes follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/running-on-kubernetes.html).\n- For complete “Setup and Run Auditbeat” information refer to the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/setting-up-and-running.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.working_directory",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "39bd8f3e-d3b9-44af-9b2d-5b602cb1c64c",
        "rule_id": "9f9a2a82-93a8-4b1a-8778-1780895626d4",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:44.545Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:41.373Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "host.os.type:linux and event.category:process and event.type:start and\nprocess.name:(chattr or chgrp or chmod or chown) and process.working_directory:(/dev/shm or /tmp or /var/tmp) and\nnot process.parent.name:(apt-key or update-motd-updates-available or apt-get)",
        "new_terms_fields": [
          "host.id",
          "process.parent.executable",
          "process.command_line"
        ],
        "history_window_start": "now-14d",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "A scheduled task was updated",
        "description": "Indicates the update of a scheduled task using Windows event logs. Adversaries can use these to establish persistence, by changing the configuration of a legit scheduled task. Some changes such as disabling or enabling a scheduled task are common and may may generate noise.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 109,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Legitimate scheduled tasks may be created during installation of new software."
        ],
        "references": [
          "https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4698"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1053",
                "name": "Scheduled Task/Job",
                "reference": "https://attack.mitre.org/techniques/T1053/",
                "subtechnique": [
                  {
                    "id": "T1053.005",
                    "name": "Scheduled Task",
                    "reference": "https://attack.mitre.org/techniques/T1053/005/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.event_data.SubjectUserSid",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "winlog.event_data.TaskName",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "6a06beb9-b486-42a2-a75c-b58a64fb8439",
        "rule_id": "a02cb68e-7c93-48d1-93b2-2c39023308eb",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:44.547Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:41.382Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "iam where event.action == \"scheduled-task-updated\" and\n\n /* excluding tasks created by the computer account */\n not user.name : \"*$\" and \n not winlog.event_data.TaskName : \"*Microsoft*\" and \n not winlog.event_data.TaskName :\n          (\"\\\\User_Feed_Synchronization-*\",\n           \"\\\\OneDrive Reporting Task-S-1-5-21*\",\n           \"\\\\OneDrive Reporting Task-S-1-12-1-*\",\n           \"\\\\Hewlett-Packard\\\\HP Web Products Detection\",\n           \"\\\\Hewlett-Packard\\\\HPDeviceCheck\", \n           \"\\\\Microsoft\\\\Windows\\\\UpdateOrchestrator\\\\UpdateAssistant\", \n           \"\\\\IpamDnsProvisioning\",  \n           \"\\\\Microsoft\\\\Windows\\\\UpdateOrchestrator\\\\UpdateAssistantAllUsersRun\", \n           \"\\\\Microsoft\\\\Windows\\\\UpdateOrchestrator\\\\UpdateAssistantCalendarRun\", \n           \"\\\\Microsoft\\\\Windows\\\\UpdateOrchestrator\\\\UpdateAssistantWakeupRun\", \n           \"\\\\Microsoft\\\\Windows\\\\.NET Framework\\\\.NET Framework NGEN v*\", \n           \"\\\\Microsoft\\\\VisualStudio\\\\Updates\\\\BackgroundDownload\") and \n  not winlog.event_data.SubjectUserSid :  (\"S-1-5-18\", \"S-1-5-19\", \"S-1-5-20\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-system.*",
          "logs-windows.*"
        ],
        "filters": []
      },
      {
        "name": "InstallUtil Process Making Network Connections",
        "description": "Identifies InstallUtil.exe making outbound network connections. This may indicate adversarial activity as InstallUtil is often leveraged by adversaries to execute code and evade detection.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 207,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1218",
                "name": "System Binary Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1218/",
                "subtechnique": [
                  {
                    "id": "T1218.004",
                    "name": "InstallUtil",
                    "reference": "https://attack.mitre.org/techniques/T1218/004/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "network.direction",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "d449df27-e2e6-4f37-b1bd-c995791c0eb6",
        "rule_id": "a13167f1-eec2-4015-9631-1fee60406dcf",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:44.550Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:41.401Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "/* the benefit of doing this as an eql sequence vs kql is this will limit to alerting only on the first network connection */\n\nsequence by process.entity_id\n  [process where host.os.type == \"windows\" and event.type == \"start\" and process.name : \"installutil.exe\"]\n  [network where host.os.type == \"windows\" and process.name : \"installutil.exe\" and network.direction : (\"outgoing\", \"egress\")]",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "logs-endpoint.events.network-*",
          "winlogbeat-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "Potential LSASS Clone Creation via PssCaptureSnapShot",
        "description": "Identifies the creation of an LSASS process clone via PssCaptureSnapShot where the parent process is the initial LSASS process instance. This may indicate an attempt to evade detection and dump LSASS memory for credential access.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 208,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Data Source: Sysmon",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.matteomalvica.com/blog/2019/12/02/win-defender-atp-cred-bypass/",
          "https://medium.com/@Achilles8284/the-birth-of-a-process-part-2-97c6fb9c42a2"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1003",
                "name": "OS Credential Dumping",
                "reference": "https://attack.mitre.org/techniques/T1003/",
                "subtechnique": [
                  {
                    "id": "T1003.001",
                    "name": "LSASS Memory",
                    "reference": "https://attack.mitre.org/techniques/T1003/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis is meant to run only on datasources using Windows security event 4688 that captures the process clone creation.\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.code",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "469a6de3-0126-4e19-8fbd-53101e5de415",
        "rule_id": "a16612dd-b30e-4d41-86a0-ebe70974ec00",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:44.553Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:41.411Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.code:\"4688\" and\n  process.executable : \"?:\\\\Windows\\\\System32\\\\lsass.exe\" and\n  process.parent.executable : \"?:\\\\Windows\\\\System32\\\\lsass.exe\"",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-system.*",
          "logs-windows.*"
        ],
        "filters": []
      },
      {
        "name": "AWS EC2 Instance Interaction with IAM Service",
        "description": "Identifies when an EC2 instance interacts with the AWS IAM service via an assumed role. This is uncommon behavior and could indicate an attacker using compromised credentials to further exploit an environment. For example, an assumed role could be used to create new users for persistence or add permissions for privilege escalation. An EC2 instance assumes a role using their EC2 ID as the session name. This rule looks for the pattern \"i-\" which is the beginning pattern for assumed role sessions started by an EC2 instance. This is a [building block](https://www.elastic.co/guide/en/security/current/building-block-rule.html) rule and does not generate alerts on its own. It is meant to be used for correlation with other rules to detect suspicious activity.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "investigation_fields": {
          "field_names": [
            "@timestamp",
            "source.address",
            "user.name",
            "user.id",
            "aws.cloudtrail.user_identity.arn",
            "aws.cloudtrail.user_identity.type",
            "user_agent.original",
            "user.target.name",
            "event.action",
            "event.outcome",
            "cloud.region",
            "event.provider",
            "aws.cloudtrail.request_parameters",
            "aws.cloudtrail.response_elements"
          ]
        },
        "version": 2,
        "tags": [
          "Domain: Cloud",
          "Data Source: AWS",
          "Data Source: Amazon Web Services",
          "Data Source: AWS EC2",
          "Data Source: AWS IAM",
          "Use Case: Identity and Access Audit",
          "Tactic: Privilege Escalation",
          "Tactic: Persistence",
          "Rule Type: BBR"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Administrators may use EC2 instances to interact with IAM services as part of an automation workflow, ensure validity of the triggered event and include exceptions where necessary."
        ],
        "references": [
          "https://redcanary.com/blog/aws-sts/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1078",
                "name": "Valid Accounts",
                "reference": "https://attack.mitre.org/techniques/T1078/",
                "subtechnique": [
                  {
                    "id": "T1078.004",
                    "name": "Cloud Accounts",
                    "reference": "https://attack.mitre.org/techniques/T1078/004/"
                  }
                ]
              },
              {
                "id": "T1098",
                "name": "Account Manipulation",
                "reference": "https://attack.mitre.org/techniques/T1098/",
                "subtechnique": [
                  {
                    "id": "T1098.001",
                    "name": "Additional Cloud Credentials",
                    "reference": "https://attack.mitre.org/techniques/T1098/001/"
                  },
                  {
                    "id": "T1098.003",
                    "name": "Additional Cloud Roles",
                    "reference": "https://attack.mitre.org/techniques/T1098/003/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            }
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "aws",
            "version": "^2.0.0",
            "integration": "cloudtrail"
          }
        ],
        "required_fields": [
          {
            "name": "aws.cloudtrail.user_identity.type",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "2bca248f-a377-4db4-8dd0-f0baf11c0067",
        "rule_id": "a44bcb58-5109-4870-a7c6-11f5fe7dd4b1",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:44.555Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:41.438Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "any where event.dataset == \"aws.cloudtrail\"\n    and event.provider == \"iam.amazonaws.com\"\n    and aws.cloudtrail.user_identity.type == \"AssumedRole\"\n    and stringContains(user.id, \":i-\")\n    and (\n            startsWith(event.action, \"Update\")\n            or startsWith(event.action, \"Attach\")\n            or startsWith(event.action, \"Detach\")\n            or startsWith(event.action, \"Create\")\n            or startsWith(event.action, \"Delete\")\n            or startsWith(event.action, \"Add\")\n            or startsWith(event.action, \"Remove\")\n            or startsWith(event.action, \"Put\")\n            or startsWith(event.action, \"Tag\")\n    )",
        "language": "eql",
        "index": [
          "filebeat-*",
          "logs-aws.cloudtrail-*"
        ],
        "filters": []
      },
      {
        "name": "Privileged Docker Container Creation",
        "description": "This rule leverages the new_terms rule type to identify the creation of a potentially unsafe docker container from an unusual parent process. Attackers can use the `--privileged` flag to create containers with escalated privileges, which can lead to trivial privilege escalation, docker escaping and persistence. access.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 2,
        "tags": [
          "Domain: Endpoint",
          "Domain: Container",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.004",
                    "name": "Unix Shell",
                    "reference": "https://attack.mitre.org/techniques/T1059/004/"
                  }
                ]
              },
              {
                "id": "T1609",
                "name": "Container Administration Command",
                "reference": "https://attack.mitre.org/techniques/T1609/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1611",
                "name": "Escape to Host",
                "reference": "https://attack.mitre.org/techniques/T1611/"
              }
            ]
          }
        ],
        "setup": "## Setup\nThis rule requires data coming in from Elastic Defend.\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "354187dc-4e58-4b3f-8609-0a4bd5561526",
        "rule_id": "a80d96cd-1164-41b3-9852-ef58724be496",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:44.558Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:42.741Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "host.os.type:linux and event.category:process and event.type:start and event.action:exec and process.name:docker and\nprocess.args:(run and --privileged)",
        "new_terms_fields": [
          "process.parent.executable"
        ],
        "history_window_start": "now-14d",
        "index": [
          "logs-endpoint.events.process*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Persistence via Hidden Run Key Detected",
        "description": "Identifies a persistence mechanism that utilizes the NtSetValueKey native API to create a hidden (null terminated) registry key. An adversary may use this method to hide from system utilities such as the Registry Editor (regedit).",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 209,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Tactic: Defense Evasion",
          "Tactic: Execution",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/outflanknl/SharpHide",
          "https://github.com/ewhitehats/InvisiblePersistence/blob/master/InvisibleRegValues_Whitepaper.pdf"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1547",
                "name": "Boot or Logon Autostart Execution",
                "reference": "https://attack.mitre.org/techniques/T1547/",
                "subtechnique": [
                  {
                    "id": "T1547.001",
                    "name": "Registry Run Keys / Startup Folder",
                    "reference": "https://attack.mitre.org/techniques/T1547/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1106",
                "name": "Native API",
                "reference": "https://attack.mitre.org/techniques/T1106/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1112",
                "name": "Modify Registry",
                "reference": "https://attack.mitre.org/techniques/T1112/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.data.strings",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "registry.path",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "d1b689bc-1cf2-4a21-aa40-87eb9cc9eb9c",
        "rule_id": "a9b05c3b-b304-4bf9-970d-acdfaef2944c",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:44.567Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:42.787Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "/* Registry Path ends with backslash */\nregistry where host.os.type == \"windows\" and event.type == \"change\" and length(registry.data.strings) > 0 and\n registry.path : (\"HKEY_USERS\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\\\\\",\n                  \"HKU\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\\\\\",\n                  \"HKLM\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\\\\\",\n                  \"HKLM\\\\Software\\\\WOW6432Node\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\\\\\",\n                  \"HKEY_USERS\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\Explorer\\\\Run\\\\\",\n                  \"HKU\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\Explorer\\\\Run\\\\\",\n                  \"\\\\REGISTRY\\\\MACHINE\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\Explorer\\\\Run\\\\\",\n                  \"\\\\REGISTRY\\\\USER\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\\\\\",\n                  \"\\\\REGISTRY\\\\MACHINE\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\\\\\",\n                  \"\\\\REGISTRY\\\\MACHINE\\\\Software\\\\WOW6432Node\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\\\\\",\n                  \"\\\\REGISTRY\\\\USER\\\\*\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\Explorer\\\\Run\\\\\",\n                  \"\\\\REGISTRY\\\\MACHINE\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\Explorer\\\\Run\\\\\")",
        "language": "eql",
        "index": [
          "logs-endpoint.events.registry-*",
          "winlogbeat-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "Openssl Client or Server Activity",
        "description": "This rule identifies when the openssl client or server is used to establish a connection. Attackers may use openssl to establish a secure connection to a remote server or to create a secure server to receive connections. This activity may be used to exfiltrate data or establish a command and control channel.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 2,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://gtfobins.github.io/gtfobins/openssl/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.004",
                    "name": "Unix Shell",
                    "reference": "https://attack.mitre.org/techniques/T1059/004/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            },
            "technique": [
              {
                "id": "T1071",
                "name": "Application Layer Protocol",
                "reference": "https://attack.mitre.org/techniques/T1071/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "ef40d935-69e3-46a6-93e5-b7f315bf012b",
        "rule_id": "ad5a3757-c872-4719-8c72-12d3f08db655",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:44.571Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:42.877Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\") and\nprocess.name == \"openssl\" and (\n  (process.args == \"s_client\" and process.args : (\"-connect\", \"*:*\") and not process.args == \"-showcerts\") or\n  (process.args == \"s_server\" and process.args == \"-port\")\n) and\nnot process.parent.executable in (\"/pro/xymon/client/ext/awsXymonCheck.sh\", \"/opt/antidot-svc/nrpe/plugins/check_cert\")",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "Shared Object Created or Changed by Previously Unknown Process",
        "description": "This rule monitors the creation of shared object files by previously unknown processes. The creation of a shared object file involves compiling code into a dynamically linked library that can be loaded by other programs at runtime. While this process is typically used for legitimate purposes, malicious actors can leverage shared object files to execute unauthorized code, inject malicious functionality into legitimate processes, or bypass security controls. This allows malware to persist on the system, evade detection, and potentially compromise the integrity and confidentiality of the affected system and its data.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Shared Object Created or Changed by Previously Unknown Process\n\nA shared object file is a compiled library file (typically with a .so extension) that can be dynamically linked to executable programs at runtime, allowing for code reuse and efficient memory usage. The creation of a shared object file involves compiling code into a dynamically linked library that can be loaded by other programs at runtime.\n\nMalicious actors can leverage shared object files to execute unauthorized code, inject malicious functionality into legitimate processes, or bypass security controls. This allows malware to persist on the system, evade detection, and potentially compromise the integrity and confidentiality of the affected system and its data.\n\nThis rule monitors the creation of shared object files by previously unknown processes through the usage of the new terms rule type.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n> This investigation guide uses [placeholder fields](https://www.elastic.co/guide/en/security/current/osquery-placeholder-fields.html) to dynamically pass alert data into Osquery queries. Placeholder fields were introduced in Elastic Stack version 8.7.0. If you're using Elastic Stack version 8.6.0 or earlier, you'll need to manually adjust this investigation guide's queries to ensure they properly run.\n\n#### Possible Investigation Steps\n\n- Investigate the shared object that was created or modified through OSQuery.\n  - !{osquery{\"label\":\"Osquery - Retrieve File Listing Information\",\"query\":\"SELECT * FROM file WHERE path = {{file.path}}\\n\"}}\n  - !{osquery{\"label\":\"Osquery - Retrieve Additional File Listing Information\",\"query\":\"SELECT f.path, u.username AS file_owner, g.groupname AS group_owner, datetime(f.atime, 'unixepoch') AS\\nfile_last_access_time, datetime(f.mtime, 'unixepoch') AS file_last_modified_time, datetime(f.ctime, 'unixepoch') AS\\nfile_last_status_change_time, datetime(f.btime, 'unixepoch') AS file_created_time, f.size AS size_bytes FROM file f LEFT\\nJOIN users u ON f.uid = u.uid LEFT JOIN groups g ON f.gid = g.gid WHERE path = {{file.path}}\\n\"}}\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence and whether they are located in expected locations.\n  - !{osquery{\"label\":\"Osquery - Retrieve Running Processes by User\",\"query\":\"SELECT pid, username, name FROM processes p JOIN users u ON u.uid = p.uid ORDER BY username\"}}\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Validate the activity is not related to planned patches, updates, network administrator activity, or legitimate software installations.\n- Investigate whether the altered scripts call other malicious scripts elsewhere on the file system. \n  - If scripts or executables were dropped, retrieve the files and determine if they are malicious:\n    - Use a private sandboxed malware analysis system to perform analysis.\n      - Observe and collect information about the following activities:\n        - Attempts to contact external domains and addresses.\n          - Check if the domain is newly registered or unexpected.\n          - Check the reputation of the domain or IP address.\n        - File access, modification, and creation activities.\n        - Cron jobs, services and other persistence mechanisms.\n            - !{osquery{\"label\":\"Osquery - Retrieve Crontab Information\",\"query\":\"SELECT * FROM crontab\"}}\n- Investigate abnormal behaviors by the subject process/user such as network connections, file modifications, and any other spawned child processes.\n  - Investigate listening ports and open sockets to look for potential command and control traffic or data exfiltration.\n    - !{osquery{\"label\":\"Osquery - Retrieve Listening Ports\",\"query\":\"SELECT pid, address, port, socket, protocol, path FROM listening_ports\"}}\n    - !{osquery{\"label\":\"Osquery - Retrieve Open Sockets\",\"query\":\"SELECT pid, family, remote_address, remote_port, socket, state FROM process_open_sockets\"}}\n  - Identify the user account that performed the action, analyze it, and check whether it should perform this kind of action.\n    - !{osquery{\"label\":\"Osquery - Retrieve Information for a Specific User\",\"query\":\"SELECT * FROM users WHERE username = {{user.name}}\"}}\n- Investigate whether the user is currently logged in and active.\n    - !{osquery{\"label\":\"Osquery - Investigate the Account Authentication Status\",\"query\":\"SELECT * FROM logged_in_users WHERE user = {{user.name}}\"}}\n\n### False Positive Analysis\n\n- If this activity is related to new benign software installation activity, consider adding exceptions — preferably with a combination of user and command line conditions.\n- If this activity is related to a system administrator that performed these actions for administrative purposes, consider adding exceptions for this specific administrator user account. \n- Try to understand the context of the execution by thinking about the user, machine, or business purpose. A small number of endpoints, such as servers with unique software, might appear unusual but satisfy a specific business need.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Leverage the incident response data and logging to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 9,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://threatpost.com/sneaky-malware-backdoors-linux/180158/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1574",
                "name": "Hijack Execution Flow",
                "reference": "https://attack.mitre.org/techniques/T1574/",
                "subtechnique": [
                  {
                    "id": "T1574.006",
                    "name": "Dynamic Linker Hijacking",
                    "reference": "https://attack.mitre.org/techniques/T1574/006/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "1481f871-c96b-4f03-89df-81c54210bfac",
        "rule_id": "aebaa51f-2a91-4f6a-850b-b601db2293f4",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:44.573Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:42.911Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "host.os.type:linux and event.action:(creation or file_create_event or file_rename_event or rename) and \nfile.path:(/dev/shm/* or /usr/lib/*) and file.extension:so and process.name:* and not (\n  process.name:(\n    \"dockerd\" or \"dpkg\" or \"rpm\" or \"snapd\" or \"yum\" or \"vmis-launcher\" or \"pacman\" or \"apt-get\" or \"dnf\" or \"podman\" or\n    platform-python* or \"dnf-automatic\" or \"unattended-upgrade\" or \"apk\" or \"snap-update-ns\" or \"install\" or \"exe\" or\n    \"systemd\" or \"root\" or \"sshd\" or \"pip\" or \"jlink\" or python* or \"update-alternatives\" or pip* or\n    \"installer.bin.inst\" or \"uninstall-bin\" or \"linux_agent.inst\"\n  ) or \n  (process.name:vmware-install.pl and file.path:/usr/lib/vmware-tools/*) or\n  process.executable : (/dev/fd/* or \"/\" or \"/kaniko/executor\" or \"/usr/bin/buildah\")\n)",
        "new_terms_fields": [
          "file.path",
          "process.executable"
        ],
        "history_window_start": "now-10d",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Kernel Load or Unload via Kexec Detected",
        "description": "This detection rule identifies the usage of kexec, helping to uncover unauthorized kernel replacements and potential compromise of the system's integrity. Kexec is a Linux feature that enables the loading and execution of a different kernel without going through the typical boot process. Malicious actors can abuse kexec to bypass security measures, escalate privileges, establish persistence or hide their activities by loading a malicious kernel, enabling them to tamper with the system's trusted state, allowing e.g. a VM Escape.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 7,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Tactic: Privilege Escalation",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame",
          "Data Source: Auditd Manager"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.crowdstrike.com/blog/venom-vulnerability-details/",
          "https://www.makeuseof.com/what-is-venom-vulnerability/",
          "https://madaidans-insecurities.github.io/guides/linux-hardening.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1611",
                "name": "Escape to Host",
                "reference": "https://attack.mitre.org/techniques/T1611/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1547",
                "name": "Boot or Logon Autostart Execution",
                "reference": "https://attack.mitre.org/techniques/T1547/",
                "subtechnique": [
                  {
                    "id": "T1547.006",
                    "name": "Kernel Modules and Extensions",
                    "reference": "https://attack.mitre.org/techniques/T1547/006/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1601",
                "name": "Modify System Image",
                "reference": "https://attack.mitre.org/techniques/T1601/",
                "subtechnique": [
                  {
                    "id": "T1601.001",
                    "name": "Patch System Image",
                    "reference": "https://attack.mitre.org/techniques/T1601/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "auditd_manager",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "c242c791-2836-4ab8-b8d6-646a5028af41",
        "rule_id": "4d4c35f4-414e-4d0c-bb7e-6db7c80a6957",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:44.576Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:30.297Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\", \"executed\", \"process_started\")\n and process.name == \"kexec\" and process.args in (\"--exec\", \"-e\", \"--load\", \"-l\", \"--unload\", \"-u\") and not\n process.parent.name in (\"kdumpctl\", \"unload.sh\")",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*",
          "auditbeat-*",
          "logs-auditd_manager.auditd-*"
        ],
        "filters": []
      },
      {
        "name": "Multiple Logon Failure Followed by Logon Success",
        "description": "Identifies multiple logon failures followed by a successful one from the same source address. Adversaries will often brute force login attempts across multiple users with a common or known password, in an attempt to gain access to accounts.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Multiple Logon Failure Followed by Logon Success\n\nAdversaries with no prior knowledge of legitimate credentials within the system or environment may guess passwords to attempt access to accounts. Without knowledge of the password for an account, an adversary may opt to guess the password using a repetitive or iterative mechanism systematically. More details can be found [here](https://attack.mitre.org/techniques/T1110/001/).\n\nThis rule identifies potential password guessing/brute force activity from a single address, followed by a successful logon, indicating that an attacker potentially successfully compromised the account.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the logon failure reason code and the targeted user name.\n  - Prioritize the investigation if the account is critical or has administrative privileges over the domain.\n- Investigate the source IP address of the failed Network Logon attempts.\n  - Identify whether these attempts are coming from the internet or are internal.\n- Investigate other alerts associated with the involved users and source host during the past 48 hours.\n- Identify the source and the target computer and their roles in the IT environment.\n- Check whether the involved credentials are used in automation or scheduled tasks.\n- If this activity is suspicious, contact the account owner and confirm whether they are aware of it.\n- Examine the source host for derived artifacts that indicate compromise:\n  - Observe and collect information about the following activities in the alert source host:\n    - Attempts to contact external domains and addresses.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the host which is the source of this activity.\n\n### False positive analysis\n\n- Authentication misconfiguration or obsolete credentials.\n- Service account password expired.\n- Domain trust relationship issues.\n- Infrastructure or availability issues.\n\n### Related rules\n\n- Multiple Logon Failure from the same Source Address - 48b6edfc-079d-4907-b43c-baffa243270d\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the source host to prevent further post-compromise behavior.\n- If the asset is exposed to the internet with RDP or other remote services available, take the necessary measures to restrict access to the asset. If not possible, limit the access via the firewall to only the needed IP addresses. Also, ensure the system uses robust authentication mechanisms and is patched regularly.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 111,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Resources: Investigation Guide",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4625"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1110",
                "name": "Brute Force",
                "reference": "https://attack.mitre.org/techniques/T1110/",
                "subtechnique": [
                  {
                    "id": "T1110.001",
                    "name": "Password Guessing",
                    "reference": "https://attack.mitre.org/techniques/T1110/001/"
                  },
                  {
                    "id": "T1110.003",
                    "name": "Password Spraying",
                    "reference": "https://attack.mitre.org/techniques/T1110/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "source.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "user.domain",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.computer_name",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "winlog.event_data.Status",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "winlog.event_data.TargetUserSid",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "winlog.logon.type",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "b8fcfc02-eefa-42f2-b10a-49a2b9515e7c",
        "rule_id": "4e85dc8a-3e41-40d8-bc28-91af7ac6cf60",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:44.579Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:30.311Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by winlog.computer_name, source.ip with maxspan=5s\n  [authentication where event.action == \"logon-failed\" and\n    /* event 4625 need to be logged */\n    winlog.logon.type : \"Network\" and user.id != null and \n    source.ip != null and source.ip != \"127.0.0.1\" and source.ip != \"::1\" and \n    not winlog.event_data.TargetUserSid : \"S-1-0-0\" and not user.id : \"S-1-0-0\" and \n    not user.name : (\"ANONYMOUS LOGON\", \"-\", \"*$\") and not user.domain == \"NT AUTHORITY\" and\n\n    /* noisy failure status codes often associated to authentication misconfiguration */\n    not winlog.event_data.Status : (\"0xC000015B\", \"0XC000005E\", \"0XC0000133\", \"0XC0000192\")] with runs=5\n  [authentication where event.action == \"logged-in\" and\n    /* event 4624 need to be logged */\n    winlog.logon.type : \"Network\" and\n    source.ip != null and source.ip != \"127.0.0.1\" and source.ip != \"::1\" and\n    not user.name : (\"ANONYMOUS LOGON\", \"-\", \"*$\") and not user.domain == \"NT AUTHORITY\"]",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-system.security*",
          "logs-windows.forwarded*"
        ],
        "filters": []
      },
      {
        "name": "Hidden Files and Directories via Hidden Flag",
        "description": "Identify activity related where adversaries can add the 'hidden' flag to files to hide them from the user in an attempt to evade detection.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 3,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "OS: macOS",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame",
          "Data Source: Auditd Manager"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1564",
                "name": "Hide Artifacts",
                "reference": "https://attack.mitre.org/techniques/T1564/",
                "subtechnique": [
                  {
                    "id": "T1564.001",
                    "name": "Hidden Files and Directories",
                    "reference": "https://attack.mitre.org/techniques/T1564/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "auditd_manager",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "df15a04f-87bc-47cf-91bc-cd0f5b68a55e",
        "rule_id": "5124e65f-df97-4471-8dcb-8e3953b3ea97",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:44.581Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:30.334Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"linux\" and event.type == \"creation\" and process.name == \"chflags\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*",
          "auditbeat-*",
          "logs-auditd_manager.auditd-*"
        ],
        "filters": []
      },
      {
        "name": "Registry Persistence via AppCert DLL",
        "description": "Detects attempts to maintain persistence by creating registry keys using AppCert DLLs. AppCert DLLs are loaded by every process using the common API functions to create processes.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 412,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Tactic: Privilege Escalation",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Microsoft Defender for Endpoint"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1546",
                "name": "Event Triggered Execution",
                "reference": "https://attack.mitre.org/techniques/T1546/",
                "subtechnique": [
                  {
                    "id": "T1546.009",
                    "name": "AppCert DLLs",
                    "reference": "https://attack.mitre.org/techniques/T1546/009/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1546",
                "name": "Event Triggered Execution",
                "reference": "https://attack.mitre.org/techniques/T1546/",
                "subtechnique": [
                  {
                    "id": "T1546.009",
                    "name": "AppCert DLLs",
                    "reference": "https://attack.mitre.org/techniques/T1546/009/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.path",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "9b77aa20-4c76-4191-b68f-d394c5346ca4",
        "rule_id": "513f0ffd-b317-4b9c-9494-92ce861f22c7",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:44.584Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:30.345Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n  registry.path : (\n    \"HKLM\\\\SYSTEM\\\\*ControlSet*\\\\Control\\\\Session Manager\\\\AppCertDLLs\\\\*\",\n    \"\\\\REGISTRY\\\\MACHINE\\\\SYSTEM\\\\*ControlSet*\\\\Control\\\\Session Manager\\\\AppCertDLLs\\\\*\",\n    \"MACHINE\\\\SYSTEM\\\\*ControlSet*\\\\Control\\\\Session Manager\\\\AppCertDLLs\\\\*\"\n  )",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.registry-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-m365_defender.event-*"
        ],
        "filters": []
      },
      {
        "name": "Service DACL Modification via sc.exe",
        "description": "Identifies DACL modifications to deny access to a service, making it unstoppable, or hide it from system and users.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 204,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://blogs.jpcert.or.jp/en/2024/07/mirrorface-attack-against-japanese-organisations.html",
          "https://github.com/SigmaHQ/sigma/blob/master/rules/windows/process_creation/proc_creation_win_sc_sdset_deny_service_access.yml",
          "https://learn.microsoft.com/en-us/windows/win32/secauthz/sid-strings",
          "https://www.sans.org/blog/red-team-tactics-hiding-windows-services/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1564",
                "name": "Hide Artifacts",
                "reference": "https://attack.mitre.org/techniques/T1564/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1543",
                "name": "Create or Modify System Process",
                "reference": "https://attack.mitre.org/techniques/T1543/",
                "subtechnique": [
                  {
                    "id": "T1543.003",
                    "name": "Windows Service",
                    "reference": "https://attack.mitre.org/techniques/T1543/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "5d85e886-dca0-4570-9a6a-d8a6a430678e",
        "rule_id": "5188c68e-d3de-4e96-994d-9e242269446f",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:44.587Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:31.368Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (process.name : \"sc.exe\" or ?process.pe.original_file_name : \"sc.exe\") and\n  process.args : \"sdset\" and process.args : \"*D;*\" and\n  process.args : (\"*;IU*\", \"*;SU*\", \"*;BA*\", \"*;SY*\", \"*;WD*\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-m365_defender.event-*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Incoming DCOM Lateral Movement with MMC",
        "description": "Identifies the use of Distributed Component Object Model (DCOM) to run commands from a remote host, which are launched via the MMC20 Application COM Object. This behavior may indicate an attacker abusing a DCOM application to move laterally.",
        "risk_score": 73,
        "severity": "high",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 208,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Lateral Movement",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://enigma0x3.net/2017/01/05/lateral-movement-using-the-mmc20-application-com-object/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1021",
                "name": "Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1021/",
                "subtechnique": [
                  {
                    "id": "T1021.003",
                    "name": "Distributed Component Object Model",
                    "reference": "https://attack.mitre.org/techniques/T1021/003/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1218",
                "name": "System Binary Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1218/",
                "subtechnique": [
                  {
                    "id": "T1218.014",
                    "name": "MMC",
                    "reference": "https://attack.mitre.org/techniques/T1218/014/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.port",
            "type": "long",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "network.direction",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "network.transport",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "source.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "source.port",
            "type": "long",
            "ecs": true
          }
        ],
        "id": "0751ece8-4df7-4a46-8139-d13ae8d43c29",
        "rule_id": "51ce96fb-9e52-4dad-b0ba-99b54440fc9a",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:44.589Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:31.386Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by host.id with maxspan=1m\n [network where host.os.type == \"windows\" and event.type == \"start\" and process.name : \"mmc.exe\" and source.port >= 49152 and\n destination.port >= 49152 and source.ip != \"127.0.0.1\" and source.ip != \"::1\" and\n  network.direction : (\"incoming\", \"ingress\") and network.transport == \"tcp\"\n ] by process.entity_id\n [process where host.os.type == \"windows\" and event.type == \"start\" and process.parent.name : \"mmc.exe\"\n ] by process.parent.entity_id",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-endpoint.events.network-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "Unusual Network Connection via RunDLL32",
        "description": "Identifies unusual instances of rundll32.exe making outbound network connections. This may indicate adversarial Command and Control activity.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Unusual Network Connection via RunDLL32\n\nRunDLL32 is a built-in Windows utility and also a vital component used by the operating system itself. The functionality provided by RunDLL32 to execute Dynamic Link Libraries (DLLs) is widely abused by attackers, because it makes it hard to differentiate malicious activity from normal operations.\n\nThis rule looks for external network connections established using RunDLL32 when the utility is being executed with no arguments, which can potentially indicate command and control activity.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate the target host that RunDLL32 is communicating with.\n  - Check if the domain is newly registered or unexpected.\n  - Check the reputation of the domain or IP address.\n- Identify the target computer and its role in the IT environment.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Review the privileges assigned to the user to ensure that the least privilege principle is being followed.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 209,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Tactic: Command and Control",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.iana.org/assignments/iana-ipv4-special-registry/iana-ipv4-special-registry.xhtml",
          "https://redcanary.com/threat-detection-report/techniques/rundll32/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1218",
                "name": "System Binary Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1218/",
                "subtechnique": [
                  {
                    "id": "T1218.011",
                    "name": "Rundll32",
                    "reference": "https://attack.mitre.org/techniques/T1218/011/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            },
            "technique": [
              {
                "id": "T1071",
                "name": "Application Layer Protocol",
                "reference": "https://attack.mitre.org/techniques/T1071/",
                "subtechnique": [
                  {
                    "id": "T1071.001",
                    "name": "Web Protocols",
                    "reference": "https://attack.mitre.org/techniques/T1071/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args_count",
            "type": "long",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "67fb1308-a17b-4631-a3ca-f63bbe53c489",
        "rule_id": "52aaab7b-b51c-441a-89ce-4387b3aea886",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:44.592Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:31.429Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by host.id, process.entity_id with maxspan=1m\n  [process where host.os.type == \"windows\" and event.type == \"start\" and process.name : \"rundll32.exe\" and process.args_count == 1]\n  [network where host.os.type == \"windows\" and process.name : \"rundll32.exe\" and\n   not cidrmatch(destination.ip, \"10.0.0.0/8\", \"127.0.0.0/8\", \"169.254.0.0/16\", \"172.16.0.0/12\", \"192.0.0.0/24\",\n       \"192.0.0.0/29\", \"192.0.0.8/32\", \"192.0.0.9/32\", \"192.0.0.10/32\", \"192.0.0.170/32\", \"192.0.0.171/32\",\n       \"192.0.2.0/24\", \"192.31.196.0/24\", \"192.52.193.0/24\", \"192.168.0.0/16\", \"192.88.99.0/24\", \"224.0.0.0/4\",\n       \"100.64.0.0/10\", \"192.175.48.0/24\",\"198.18.0.0/15\", \"198.51.100.0/24\", \"203.0.113.0/24\", \"240.0.0.0/4\", \"::1\",\n       \"FE80::/10\", \"FF00::/8\")]",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-endpoint.events.network-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious Network Activity to the Internet by Previously Unknown Executable",
        "description": "This rule monitors for network connectivity to the internet from a previously unknown executable located in a suspicious directory. An alert from this rule can indicate the presence of potentially malicious activity, such as the execution of unauthorized or suspicious processes attempting to establish connections to unknown or suspicious destinations such as a command and control server. Detecting and investigating such behavior can help identify and mitigate potential security threats, protecting the system and its data from potential compromise.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Suspicious Network Activity to the Internet by Previously Unknown Executable\n\nAfter being installed, malware will often call out to its command and control server to receive further instructions by its operators.\n\nThis rule leverages the new terms rule type to detect previously unknown processes, initiating network connections to external IP-addresses. \n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n> This investigation guide uses [placeholder fields](https://www.elastic.co/guide/en/security/current/osquery-placeholder-fields.html) to dynamically pass alert data into Osquery queries. Placeholder fields were introduced in Elastic Stack version 8.7.0. If you're using Elastic Stack version 8.6.0 or earlier, you'll need to manually adjust this investigation guide's queries to ensure they properly run.\n\n#### Possible investigation steps\n\n- Identify any signs of suspicious network activity or anomalies that may indicate malicious behavior. This could include unexpected traffic patterns or unusual network behavior.\n  - Investigate listening ports and open sockets to look for potential malicious processes, reverse shells or data exfiltration.\n    - !{osquery{\"label\":\"Osquery - Retrieve Listening Ports\",\"query\":\"SELECT pid, address, port, socket, protocol, path FROM listening_ports\"}}\n    - !{osquery{\"label\":\"Osquery - Retrieve Open Sockets\",\"query\":\"SELECT pid, family, remote_address, remote_port, socket, state FROM process_open_sockets\"}}\n- Identify the user account that performed the action, analyze it, and check whether it should perform this kind of action.\n  - !{osquery{\"label\":\"Osquery - Retrieve Information for a Specific User\",\"query\":\"SELECT * FROM users WHERE username = {{user.name}}\"}}\n- Investigate whether the user is currently logged in and active.\n  - !{osquery{\"label\":\"Osquery - Investigate the Account Authentication Status\",\"query\":\"SELECT * FROM logged_in_users WHERE user = {{user.name}}\"}}\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence and whether they are located in expected locations.\n  - !{osquery{\"label\":\"Osquery - Retrieve Running Processes by User\",\"query\":\"SELECT pid, username, name FROM processes p JOIN users u ON u.uid = p.uid ORDER BY username\"}}\n  - !{osquery{\"label\":\"Osquery - Retrieve Process Info\",\"query\":\"SELECT name, cmdline, parent, path, uid FROM processes\"}}\n- Investigate other alerts associated with the user/host during the past 48 hours.\n  - If scripts or executables were dropped, retrieve the files and determine if they are malicious:\n    - Use a private sandboxed malware analysis system to perform analysis.\n      - Observe and collect information about the following activities:\n        - Attempts to contact external domains and addresses.\n          - Check if the domain is newly registered or unexpected.\n          - Check the reputation of the domain or IP address.\n        - File access, modification, and creation activities.\n\n### Related rules\n\n- Network Activity Detected via cat - afd04601-12fc-4149-9b78-9c3f8fe45d39\n\n### False positive analysis\n\n- If this activity is related to new benign software installation activity, consider adding exceptions — preferably with a combination of user and command line conditions.\n- Try to understand the context of the execution by thinking about the user, machine, or business purpose. A small number of endpoints, such as servers with unique software, might appear unusual but satisfy a specific business need.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors, such as reverse shells, reverse proxies, or droppers, that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Leverage the incident response data and logging to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 11,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Command and Control",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-3540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            },
            "technique": [
              {
                "id": "T1071",
                "name": "Application Layer Protocol",
                "reference": "https://attack.mitre.org/techniques/T1071/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from one of the following integrations:\n- Elastic Defend\n- Auditbeat\n- Filebeat\n- Packetbeat\n\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows\nthe Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest to select \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n### Auditbeat Setup\nAuditbeat is a lightweight shipper that you can install on your servers to audit the activities of users and processes on your systems. For example, you can use Auditbeat to collect and centralize audit events from the Linux Audit Framework. You can also use Auditbeat to detect changes to critical files, like binaries and configuration files, and identify potential security policy violations.\n\n#### The following steps should be executed in order to add the Auditbeat on a Linux System:\n- Elastic provides repositories available for APT and YUM-based distributions. Note that we provide binary packages, but no source packages.\n- To install the APT and YUM repositories follow the setup instructions in this [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/setup-repositories.html).\n- To run Auditbeat on Docker follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/running-on-docker.html).\n- To run Auditbeat on Kubernetes follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/running-on-kubernetes.html).\n- For complete “Setup and Run Auditbeat” information refer to the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/setting-up-and-running.html).\n\n### Filebeat Setup\nFilebeat is a lightweight shipper for forwarding and centralizing log data. Installed as an agent on your servers, Filebeat monitors the log files or locations that you specify, collects log events, and forwards them either to Elasticsearch or Logstash for indexing.\n\n#### The following steps should be executed in order to add the Filebeat on a Linux System:\n- Elastic provides repositories available for APT and YUM-based distributions. Note that we provide binary packages, but no source packages.\n- To install the APT and YUM repositories follow the setup instructions in this [helper guide](https://www.elastic.co/guide/en/beats/filebeat/current/setup-repositories.html).\n- To run Filebeat on Docker follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/filebeat/current/running-on-docker.html).\n- To run Filebeat on Kubernetes follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/filebeat/current/running-on-kubernetes.html).\n- For quick start information for Filebeat refer to the [helper guide](https://www.elastic.co/guide/en/beats/filebeat/8.11/filebeat-installation-configuration.html).\n- For complete “Setup and Run Filebeat” information refer to the [helper guide](https://www.elastic.co/guide/en/beats/filebeat/current/setting-up-and-running.html).\n\n### Packetbeat Setup\nPacketbeat is a real-time network packet analyzer that you can use for application monitoring, performance analytics, and threat detection. Packetbeat works by capturing the network traffic between your application servers, decoding the application layer protocols (HTTP, MySQL, Redis, and so on), correlating the requests with the responses, and recording the interesting fields for each transaction.\n\n#### The following steps should be executed in order to add the Packetbeat on a  Linux System:\n- Elastic provides repositories available for APT and YUM-based distributions. Note that we provide binary packages, but no source packages.\n- To install the APT and YUM repositories follow the setup instructions in this [helper guide](https://www.elastic.co/guide/en/beats/packetbeat/current/setup-repositories.html).\n- To run Packetbeat on Docker follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/packetbeat/current/running-on-docker.html).\n- For quick start information for Packetbeat refer to the [helper guide](https://www.elastic.co/guide/en/beats/packetbeat/current/packetbeat-installation-configuration.html).\n- For complete “Setup and Run Packetbeat” information refer to the [helper guide](https://www.elastic.co/guide/en/beats/packetbeat/current/setting-up-and-running.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "source.ip",
            "type": "ip",
            "ecs": true
          }
        ],
        "id": "43657ac4-918c-4837-87ad-1bd01a358439",
        "rule_id": "53617418-17b4-4e9c-8a2c-8deb8086ca4b",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:44.595Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:31.451Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "host.os.type:linux and event.category:network and event.action:(connection_attempted or ipv4_connection_attempt_event) and\nprocess.executable : (\n  /etc/crontab or /etc/rc.local or ./* or /boot/* or /dev/shm/* or /etc/cron.*/* or /etc/init.d/* or /etc/rc*.d/* or\n  /etc/update-motd.d/* or /home/*/.* or /tmp/* or /usr/lib/update-notifier/* or /var/log/* or /var/tmp/*\n) and process.name : * and\nnot (\n  process.executable : (\n    /tmp/newroot/* or /tmp/snap.rootfs* or /etc/cron.hourly/BitdefenderRedline or /tmp/go-build* or /srv/snp/docker/* or\n    /run/containerd/* or /tmp/.mount* or /run/k3s/containerd/* or /tmp/selenium* or /tmp/tmp.*/juliainstaller or\n    /tmp/.criu.mntns* or /home/*/.local/share/containers/* or /etc/update-motd.d/*\n  ) or\n  source.ip:(10.0.0.0/8 or 127.0.0.0/8 or 172.16.0.0/12 or 192.168.0.0/16) or\n  process.name : (\n    apt or chrome or curl or dnf or dockerd or dpkg or firefox-bin or git-remote-https or java or kite-update or\n    kited or node or rpm or saml2aws or selenium-manager or solana-validator or wget or yum or ansible* or aws* or\n    php* or pip* or python* or steam* or terraform*\n  ) or\n  destination.ip:(\n    0.0.0.0 or 10.0.0.0/8 or 100.64.0.0/10 or 127.0.0.0/8 or 169.254.0.0/16 or 172.16.0.0/12 or 192.0.0.0/24 or\n    192.0.0.0/29 or 192.0.0.10/32 or 192.0.0.170/32 or 192.0.0.171/32 or 192.0.0.8/32 or 192.0.0.9/32 or 192.0.2.0/24 or\n    192.168.0.0/16 or 192.175.48.0/24 or 192.31.196.0/24 or 192.52.193.0/24 or 192.88.99.0/24 or 198.18.0.0/15 or\n    198.51.100.0/24 or 203.0.113.0/24 or 224.0.0.0/4 or 240.0.0.0/4 or \"::1\" or \"FE80::/10\" or \"FF00::/8\"\n  )\n)",
        "new_terms_fields": [
          "process.executable"
        ],
        "history_window_start": "now-20d",
        "index": [
          "auditbeat-*",
          "filebeat-*",
          "packetbeat-*",
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Binary Content Copy via Cmd.exe",
        "description": "Attackers may abuse cmd.exe commands to reassemble binary fragments into a malicious payload.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 106,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Tactic: Execution",
          "Data Source: Elastic Defend",
          "Rule Type: BBR",
          "Data Source: Sysmon",
          "Data Source: Elastic Endgame",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1140",
                "name": "Deobfuscate/Decode Files or Information",
                "reference": "https://attack.mitre.org/techniques/T1140/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.003",
                    "name": "Windows Command Shell",
                    "reference": "https://attack.mitre.org/techniques/T1059/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "65bb6237-5140-4512-8d68-2a3f0795afff",
        "rule_id": "53dedd83-1be7-430f-8026-363256395c8b",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:44.597Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:31.480Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.name : \"cmd.exe\" and (\n    (process.args : \"type\" and process.args : (\">\", \">>\")) or\n    (process.args : \"copy\" and process.args : \"/b\"))",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "winlogbeat-*"
        ],
        "filters": []
      },
      {
        "name": "Uncommon Registry Persistence Change",
        "description": "Detects changes to registry persistence keys that are not commonly used or modified by legitimate programs. This could be an indication of an adversary's attempt to persist in a stealthy manner.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "timeline_id": "3e47ef71-ebfc-4520-975c-cb27fc090799",
        "timeline_title": "Comprehensive Registry Timeline",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 211,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.microsoftpressstore.com/articles/article.aspx?p=2762082&seqNum=2"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1546",
                "name": "Event Triggered Execution",
                "reference": "https://attack.mitre.org/techniques/T1546/",
                "subtechnique": [
                  {
                    "id": "T1546.002",
                    "name": "Screensaver",
                    "reference": "https://attack.mitre.org/techniques/T1546/002/"
                  }
                ]
              },
              {
                "id": "T1547",
                "name": "Boot or Logon Autostart Execution",
                "reference": "https://attack.mitre.org/techniques/T1547/",
                "subtechnique": [
                  {
                    "id": "T1547.001",
                    "name": "Registry Run Keys / Startup Folder",
                    "reference": "https://attack.mitre.org/techniques/T1547/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1112",
                "name": "Modify Registry",
                "reference": "https://attack.mitre.org/techniques/T1112/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.data.strings",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "registry.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.value",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "0eb39ca8-0b2b-4d8d-8867-ab0d135b1b86",
        "rule_id": "54902e45-3467-49a4-8abc-529f2c8cfb80",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:44.600Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:31.485Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n length(registry.data.strings) > 0 and\n registry.path : (\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Terminal Server\\\\Install\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\\\\*\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Terminal Server\\\\Install\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Runonce\\\\*\",\n      \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Windows\\\\Load\",\n      \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Windows\\\\Run\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Windows\\\\IconServiceLib\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Winlogon\\\\Shell\",\n      \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Winlogon\\\\Shell\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Winlogon\\\\AppSetup\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Winlogon\\\\Taskman\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Winlogon\\\\Userinit\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Winlogon\\\\VmApplet\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\Explorer\\\\Run\\\\*\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\System\\\\Shell\",\n      \"HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\\\System\\\\Scripts\\\\Logoff\\\\Script\",\n      \"HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\\\System\\\\Scripts\\\\Logon\\\\Script\",\n      \"HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\\\System\\\\Scripts\\\\Shutdown\\\\Script\",\n      \"HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\\\System\\\\Scripts\\\\Startup\\\\Script\",\n      \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\Explorer\\\\Run\\\\*\",\n      \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\System\\\\Shell\",\n      \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\\\System\\\\Scripts\\\\Logoff\\\\Script\",\n      \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\\\System\\\\Scripts\\\\Logon\\\\Script\",\n      \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\\\System\\\\Scripts\\\\Shutdown\\\\Script\",\n      \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\\\System\\\\Scripts\\\\Startup\\\\Script\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Active Setup\\\\Installed Components\\\\*\\\\ShellComponent\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows CE Services\\\\AutoStartOnConnect\\\\MicrosoftActiveSync\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows CE Services\\\\AutoStartOnDisconnect\\\\MicrosoftActiveSync\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Ctf\\\\LangBarAddin\\\\*\\\\FilePath\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Internet Explorer\\\\Extensions\\\\*\\\\Exec\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Internet Explorer\\\\Extensions\\\\*\\\\Script\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Command Processor\\\\Autorun\",\n      \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Ctf\\\\LangBarAddin\\\\*\\\\FilePath\",\n      \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Internet Explorer\\\\Extensions\\\\*\\\\Exec\",\n      \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Internet Explorer\\\\Extensions\\\\*\\\\Script\",\n      \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Command Processor\\\\Autorun\",\n      \"HKEY_USERS\\\\*\\\\Control Panel\\\\Desktop\\\\scrnsave.exe\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Image File Execution Options\\\\*\\\\VerifierDlls\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Winlogon\\\\GpExtensions\\\\*\\\\DllName\",\n      \"HKLM\\\\SYSTEM\\\\ControlSet*\\\\Control\\\\SafeBoot\\\\AlternateShell\",\n      \"HKLM\\\\SYSTEM\\\\ControlSet*\\\\Control\\\\Terminal Server\\\\Wds\\\\rdpwd\\\\StartupPrograms\",\n      \"HKLM\\\\SYSTEM\\\\ControlSet*\\\\Control\\\\Terminal Server\\\\WinStations\\\\RDP-Tcp\\\\InitialProgram\",\n      \"HKLM\\\\SYSTEM\\\\ControlSet*\\\\Control\\\\Session Manager\\\\BootExecute\",\n      \"HKLM\\\\SYSTEM\\\\ControlSet*\\\\Control\\\\Session Manager\\\\SetupExecute\",\n      \"HKLM\\\\SYSTEM\\\\ControlSet*\\\\Control\\\\Session Manager\\\\Execute\",\n      \"HKLM\\\\SYSTEM\\\\ControlSet*\\\\Control\\\\Session Manager\\\\S0InitialCommand\",\n      \"HKLM\\\\SYSTEM\\\\ControlSet*\\\\Control\\\\ServiceControlManagerExtension\",\n      \"HKLM\\\\SYSTEM\\\\ControlSet*\\\\Control\\\\BootVerificationProgram\\\\ImagePath\",\n      \"HKLM\\\\SYSTEM\\\\Setup\\\\CmdLine\",\n      \"HKEY_USERS\\\\*\\\\Environment\\\\UserInitMprLogonScript\") and\n\n not registry.data.strings : (\"C:\\\\Windows\\\\system32\\\\userinit.exe\", \"cmd.exe\", \"C:\\\\Program Files (x86)\\\\*.exe\",\n                              \"C:\\\\Program Files\\\\*.exe\") and\n not (process.name : \"rundll32.exe\" and registry.path : \"*\\\\Software\\\\Microsoft\\\\Internet Explorer\\\\Extensions\\\\*\\\\Script\") and\n not process.executable : (\"C:\\\\Windows\\\\System32\\\\msiexec.exe\",\n                           \"C:\\\\Windows\\\\SysWOW64\\\\msiexec.exe\",\n                           \"C:\\\\ProgramData\\\\Microsoft\\\\Windows Defender\\\\Platform\\\\*\\\\MsMpEng.exe\",\n                           \"C:\\\\Program Files\\\\*.exe\",\n                           \"C:\\\\Program Files (x86)\\\\*.exe\") and\n not (process.name : (\"TiWorker.exe\", \"poqexec.exe\") and registry.value : \"SetupExecute\" and\n      registry.data.strings : (\n        \"C:\\\\windows\\\\System32\\\\poqexec.exe /display_progress \\\\SystemRoot\\\\WinSxS\\\\pending.xml\",\n        \"C:\\\\Windows\\\\System32\\\\poqexec.exe /skip_critical_poq /display_progress \\\\SystemRoot\\\\WinSxS\\\\pending.xml\"\n      )\n     ) and\n not (process.name : \"svchost.exe\" and registry.value : \"SCRNSAVE.EXE\" and\n      registry.data.strings : (\n        \"%windir%\\\\system32\\\\rundll32.exe user32.dll,LockWorkStation\",\n        \"scrnsave.scr\",\n        \"%windir%\\\\system32\\\\Ribbons.scr\"\n      )\n     )",
        "language": "eql",
        "index": [
          "logs-endpoint.events.registry-*",
          "logs-windows.sysmon_operational-*",
          "winlogbeat-*"
        ],
        "filters": []
      },
      {
        "name": "PsExec Network Connection",
        "description": "Identifies use of the SysInternals tool PsExec.exe making a network connection. This could be an indication of lateral movement.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating PsExec Network Connection\n\nPsExec is a remote administration tool that enables the execution of commands with both regular and SYSTEM privileges on Windows systems. Microsoft develops it as part of the Sysinternals Suite. Although commonly used by administrators, PsExec is frequently used by attackers to enable lateral movement and execute commands as SYSTEM to disable defenses and bypass security protections.\n\nThis rule identifies PsExec execution by looking for the creation of `PsExec.exe`, the default name for the utility, followed by a network connection done by the process.\n\n#### Possible investigation steps\n\n- Check if the usage of this tool complies with the organization's administration policy.\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Identify the target computer and its role in the IT environment.\n- Investigate what commands were run, and assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n\n### False positive analysis\n\n- This mechanism can be used legitimately. As long as the analyst did not identify suspicious activity related to the user or involved hosts, and the tool is allowed by the organization's policy, such alerts can be dismissed.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n  - Prioritize cases involving critical servers and users.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Review the privileges assigned to the user to ensure that the least privilege principle is being followed.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 209,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Tactic: Lateral Movement",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "PsExec is a dual-use tool that can be used for benign or malicious activity. It's important to baseline your environment to determine the amount of noise to expect from this tool."
        ],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1569",
                "name": "System Services",
                "reference": "https://attack.mitre.org/techniques/T1569/",
                "subtechnique": [
                  {
                    "id": "T1569.002",
                    "name": "Service Execution",
                    "reference": "https://attack.mitre.org/techniques/T1569/002/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1021",
                "name": "Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1021/",
                "subtechnique": [
                  {
                    "id": "T1021.002",
                    "name": "SMB/Windows Admin Shares",
                    "reference": "https://attack.mitre.org/techniques/T1021/002/"
                  }
                ]
              },
              {
                "id": "T1570",
                "name": "Lateral Tool Transfer",
                "reference": "https://attack.mitre.org/techniques/T1570/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "529f82bb-2ad1-41c0-831d-264ec2ac0331",
        "rule_id": "55d551c6-333b-4665-ab7e-5d14a59715ce",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:44.603Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:32.285Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by process.entity_id\n  [process where host.os.type == \"windows\" and process.name : \"PsExec.exe\" and event.type == \"start\" and\n\n   /* This flag suppresses the display of the license dialog and may\n      indicate that psexec executed for the first time in the machine */\n   process.args : \"-accepteula\" and\n\n   not process.executable : (\"?:\\\\ProgramData\\\\Docusnap\\\\Discovery\\\\discovery\\\\plugins\\\\17\\\\Bin\\\\psexec.exe\",\n                             \"?:\\\\Docusnap 11\\\\Bin\\\\psexec.exe\",\n                             \"?:\\\\Program Files\\\\Docusnap X\\\\Bin\\\\psexec.exe\",\n                             \"?:\\\\Program Files\\\\Docusnap X\\\\Tools\\\\dsDNS.exe\") and\n   not process.parent.executable : \"?:\\\\Program Files (x86)\\\\Cynet\\\\Cynet Scanner\\\\CynetScanner.exe\"]\n  [network where host.os.type == \"windows\" and process.name : \"PsExec.exe\"]",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-endpoint.events.network-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "File Staged in Root Folder of Recycle Bin",
        "description": "Identifies files written to the root of the Recycle Bin folder instead of subdirectories. Adversaries may place files in the root of the Recycle Bin in preparation for exfiltration or to evade defenses.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 106,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Collection",
          "Data Source: Elastic Defend",
          "Rule Type: BBR",
          "Data Source: Elastic Endgame",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0009",
              "name": "Collection",
              "reference": "https://attack.mitre.org/tactics/TA0009/"
            },
            "technique": [
              {
                "id": "T1074",
                "name": "Data Staged",
                "reference": "https://attack.mitre.org/techniques/T1074/",
                "subtechnique": [
                  {
                    "id": "T1074.001",
                    "name": "Local Data Staging",
                    "reference": "https://attack.mitre.org/techniques/T1074/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "6aa1bf3d-a1d7-4372-a927-44380f4adb44",
        "rule_id": "57bccf1d-daf5-4e1a-9049-ff79b5254704",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:44.605Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:32.477Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"windows\" and event.type == \"creation\" and\n  file.path : \"?:\\\\$RECYCLE.BIN\\\\*\" and\n  not file.path : \"?:\\\\$RECYCLE.BIN\\\\*\\\\*\" and\n  not file.name : \"desktop.ini\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.file-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "winlogbeat-*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious which Enumeration",
        "description": "This rule monitors for the usage of the which command with an unusual amount of process arguments. Attackers may leverage the which command to enumerate the system for useful installed utilities that may be used after compromising a system to escalate privileges or move latteraly across the network.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 7,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1082",
                "name": "System Information Discovery",
                "reference": "https://attack.mitre.org/techniques/T1082/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args_count",
            "type": "long",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "b2a24a58-f31b-4195-8101-39fc528fd71d",
        "rule_id": "5b18eef4-842c-4b47-970f-f08d24004bde",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:44.608Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:32.719Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\") and \nprocess.name == \"which\" and process.args_count >= 10 and not (\n  process.parent.name == \"jem\" or\n  process.parent.executable like (\"/vz/root/*\", \"/var/lib/docker/*\") or\n  process.args == \"--tty-only\"\n)\n\n/* potential tuning if rule would turn out to be noisy\nand process.args in (\"nmap\", \"nc\", \"ncat\", \"netcat\", nc.traditional\", \"gcc\", \"g++\", \"socat\") and \nprocess.parent.name in (\"bash\", \"dash\", \"ash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\")\n*/",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "User Added to Privileged Group",
        "description": "Identifies a user being added to a privileged group in Active Directory. Privileged accounts and groups in Active Directory are those to which powerful rights, privileges, and permissions are granted that allow them to perform nearly any action in Active Directory and on domain-joined systems.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating User Added to Privileged Group in Active Directory\n\nPrivileged accounts and groups in Active Directory are those to which powerful rights, privileges, and permissions are granted that allow them to perform nearly any action in Active Directory and on domain-joined systems.\n\nAttackers can add users to privileged groups to maintain a level of access if their other privileged accounts are uncovered by the security team. This allows them to keep operating after the security team discovers abused accounts.\n\nThis rule monitors events related to a user being added to a privileged group.\n\n#### Possible investigation steps\n\n- Identify the user account that performed the action and whether it should manage members of this group.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n\n### False positive analysis\n\n- This attack abuses a legitimate Active Directory mechanism, so it is important to determine whether the activity is legitimate, if the administrator is authorized to perform this operation, and if there is a need to grant the account this level of privilege.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- If the admin is not aware of the operation, activate your Active Directory incident response plan.\n- If the user does not need the administrator privileges, remove the account from the privileged group.\n- Review the privileges of the administrator account that performed the action.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 211,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Resources: Investigation Guide",
          "Use Case: Active Directory Monitoring",
          "Data Source: Active Directory",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic",
          "Skoetting"
        ],
        "false_positives": [],
        "references": [
          "https://docs.microsoft.com/en-us/windows-server/identity/ad-ds/plan/security-best-practices/appendix-b--privileged-accounts-and-groups-in-active-directory"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1098",
                "name": "Account Manipulation",
                "reference": "https://attack.mitre.org/techniques/T1098/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "group.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "group.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.api",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "aba5a276-d55e-419c-b60a-bf878a53e5d8",
        "rule_id": "5cd8e1f7-0050-4afc-b2df-904e40b2f5ae",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:44.611Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:32.864Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "iam where winlog.api == \"wineventlog\" and event.action == \"added-member-to-group\" and\n(\n    (\n        group.name : (\n            \"Admin*\",\n            \"Local Administrators\",\n            \"Domain Admins\",\n            \"Enterprise Admins\",\n            \"Backup Admins\",\n            \"Schema Admins\",\n            \"DnsAdmins\",\n            \"Exchange Organization Administrators\",\n            \"Print Operators\",\n            \"Server Operators\",\n            \"Account Operators\"\n        )\n    ) or\n    (\n        group.id : (\n            \"S-1-5-32-544\",\n            \"S-1-5-21-*-544\",\n            \"S-1-5-21-*-512\",\n            \"S-1-5-21-*-519\",\n            \"S-1-5-21-*-551\",\n            \"S-1-5-21-*-518\",\n            \"S-1-5-21-*-1101\",\n            \"S-1-5-21-*-1102\",\n            \"S-1-5-21-*-550\",\n            \"S-1-5-21-*-549\",\n            \"S-1-5-21-*-548\"\n        )\n    )\n)",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-system.*",
          "logs-windows.*"
        ],
        "filters": []
      },
      {
        "name": "Unsigned DLL loaded by DNS Service",
        "description": "Identifies unusual DLLs loaded by the DNS Server process, potentially indicating the abuse of the ServerLevelPluginDll functionality. This can lead to privilege escalation and remote code execution with SYSTEM privileges.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 103,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://cube0x0.github.io/Pocing-Beyond-DA/",
          "https://adsecurity.org/?p=4064",
          "https://github.com/gtworek/PSBits/tree/master/ServerLevelPluginDll"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1068",
                "name": "Exploitation for Privilege Escalation",
                "reference": "https://attack.mitre.org/techniques/T1068/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "dll.code_signature.trusted",
            "type": "boolean",
            "ecs": true
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.code_signature.status",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "4cfe7b26-f72d-4399-af7c-9665eff2d340",
        "rule_id": "5d676480-9655-4507-adc6-4eec311efff8",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:44.613Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:32.909Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "any where host.os.type == \"windows\" and event.category : (\"library\", \"process\") and\n  event.type : (\"start\", \"change\") and event.action : (\"load\", \"Image loaded*\") and\n  process.executable : \"?:\\\\windows\\\\system32\\\\dns.exe\" and \n  not ?dll.code_signature.trusted == true and\n  not file.code_signature.status == \"Valid\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.library-*",
          "logs-windows.sysmon_operational-*",
          "winlogbeat-*"
        ],
        "filters": []
      },
      {
        "name": "Interactive Logon by an Unusual Process",
        "description": "Identifies interactive logon attempt with alternate credentials and by an unusual process. Adversaries may create a new token to escalate privileges and bypass access controls.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 104,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://attack.mitre.org/techniques/T1134/002/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1134",
                "name": "Access Token Manipulation",
                "reference": "https://attack.mitre.org/techniques/T1134/",
                "subtechnique": [
                  {
                    "id": "T1134.002",
                    "name": "Create Process with Token",
                    "reference": "https://attack.mitre.org/techniques/T1134/002/"
                  },
                  {
                    "id": "T1134.003",
                    "name": "Make and Impersonate Token",
                    "reference": "https://attack.mitre.org/techniques/T1134/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nAudit event 4624 is needed to trigger this rule.\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.event_data.LogonProcessName",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "winlog.event_data.SubjectUserSid",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "winlog.event_data.TargetUserSid",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "winlog.logon.type",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "9c35727a-2dfb-40ad-8868-f8070419a762",
        "rule_id": "61766ef9-48a5-4247-ad74-3349de7eb2ad",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:44.913Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:33.533Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "authentication where \n host.os.type : \"windows\" and winlog.event_data.LogonProcessName : \"Advapi*\" and \n winlog.logon.type == \"Interactive\" and winlog.event_data.SubjectUserSid : (\"S-1-5-21*\", \"S-1-12-*\") and \n winlog.event_data.TargetUserSid : (\"S-1-5-21*\", \"S-1-12-*\")  and process.executable : \"C:\\\\*\" and \n not startswith~(winlog.event_data.SubjectUserSid, winlog.event_data.TargetUserSid) and \n not process.executable : \n            (\"?:\\\\Windows\\\\System32\\\\winlogon.exe\", \n             \"?:\\\\Windows\\\\System32\\\\wininit.exe\", \n             \"?:\\\\Program Files\\\\*.exe\", \n             \"?:\\\\Program Files (x86)\\\\*.exe\", \n             \"?:\\\\Windows\\\\SysWOW64\\\\inetsrv\\\\w3wp.exe\", \n             \"?:\\\\Windows\\\\System32\\\\inetsrv\\\\w3wp.exe\", \n             \"?:\\\\Windows\\\\SysWOW64\\\\msiexec.exe\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-system.*",
          "logs-windows.*"
        ],
        "filters": []
      },
      {
        "name": "AdminSDHolder SDProp Exclusion Added",
        "description": "Identifies a modification on the dsHeuristics attribute on the bit that holds the configuration of groups excluded from the SDProp process. The SDProp compares the permissions on protected objects with those defined on the AdminSDHolder object. If the permissions on any of the protected accounts and groups do not match, the permissions on the protected accounts and groups are reset to match those of the domain's AdminSDHolder object, meaning that groups excluded will remain unchanged. Attackers can abuse this misconfiguration to maintain long-term access to privileged accounts in these groups.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating AdminSDHolder SDProp Exclusion Added\n\nThe SDProp process compares the permissions on protected objects with those defined on the AdminSDHolder object. If the permissions on any of the protected accounts and groups do not match, it resets the permissions on the protected accounts and groups to match those defined in the domain AdminSDHolder object.\n\nThe dSHeuristics is a Unicode string attribute, in which each character in the string represents a heuristic that is used to determine the behavior of Active Directory.\n\nAdministrators can use the dSHeuristics attribute to exclude privilege groups from the SDProp process by setting the 16th bit (dwAdminSDExMask) of the string to a certain value, which represents the group(s):\n\n- For example, to exclude the Account Operators group, an administrator would modify the string, so the 16th character is set to 1 (i.e., 0000000001000001).\n\nThe usage of this exclusion can leave the accounts unprotected and facilitate the misconfiguration of privileges for the excluded groups, enabling attackers to add accounts to these groups to maintain long-term persistence with high privileges.\n\nThis rule matches changes of the dsHeuristics object where the 16th bit is set to a value other than zero.\n\n#### Possible investigation steps\n\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account and system owners and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Check the value assigned to the 16th bit of the string on the `winlog.event_data.AttributeValue` field:\n    - Account Operators eq 1\n    - Server Operators eq 2\n    - Print Operators eq 4\n    - Backup Operators eq 8\n    The field value can range from 0 to f (15). If more than one group is specified, the values will be summed together; for example, Backup Operators and Print Operators will set the `c` value on the bit.\n\n### False positive analysis\n\n- While this modification can be done legitimately, it is not a best practice. Any potential benign true positive (B-TP) should be mapped and reviewed by the security team for alternatives as this weakens the security of the privileged group.\n\n### Response and remediation\n\n- The change can be reverted by setting the dwAdminSDExMask (16th bit) to 0 in dSHeuristics.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 212,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Data Source: Active Directory",
          "Resources: Investigation Guide",
          "Use Case: Active Directory Monitoring",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.cert.ssi.gouv.fr/uploads/guide-ad.html#dsheuristics_bad",
          "https://petri.com/active-directory-security-understanding-adminsdholder-object"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1078",
                "name": "Valid Accounts",
                "reference": "https://attack.mitre.org/techniques/T1078/",
                "subtechnique": [
                  {
                    "id": "T1078.002",
                    "name": "Domain Accounts",
                    "reference": "https://attack.mitre.org/techniques/T1078/002/"
                  }
                ]
              },
              {
                "id": "T1098",
                "name": "Account Manipulation",
                "reference": "https://attack.mitre.org/techniques/T1098/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'Audit Directory Service Changes' logging policy must be configured for (Success).\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nPolicies >\nWindows Settings >\nSecurity Settings >\nAdvanced Audit Policies Configuration >\nAudit Policies >\nDS Access >\nAudit Directory Service Changes (Success)\n```\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.code",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.event_data.AttributeLDAPDisplayName",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "winlog.event_data.AttributeValue",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "ea68737c-7edb-4e48-9fd1-16ccb5d13c46",
        "rule_id": "61d29caf-6c15-4d1e-9ccb-7ad12ccc0bc7",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:44.926Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:33.538Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "any where event.action in (\"Directory Service Changes\", \"directory-service-object-modified\") and\n  event.code == \"5136\" and\n  winlog.event_data.AttributeLDAPDisplayName : \"dSHeuristics\" and\n  length(winlog.event_data.AttributeValue) > 15 and\n  winlog.event_data.AttributeValue regex~ \"[0-9]{15}([1-9a-f]).*\"",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-system.*",
          "logs-windows.*"
        ],
        "filters": []
      },
      {
        "name": "Unusual Process Network Connection",
        "description": "Identifies network activity from unexpected system applications. This may indicate adversarial activity as these applications are often leveraged by adversaries to execute code and evade detection.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Unusual Process Network Connection\n\nThis rule identifies network activity from unexpected system utilities and applications. These applications are commonly abused by attackers to execute code, evade detections, and bypass security protections.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate the target host that the process is communicating with.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Review the privileges assigned to the user to ensure that the least privilege principle is being followed.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 208,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1127",
                "name": "Trusted Developer Utilities Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1127/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "0c1f4495-04e1-4938-a765-1593f35bc575",
        "rule_id": "610949a1-312f-4e04-bb55-3a79b8c95267",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:44.949Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:33.042Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by process.entity_id\n  [process where host.os.type == \"windows\" and (process.name : \"Microsoft.Workflow.Compiler.exe\" or\n                  process.name : \"bginfo.exe\" or\n                  process.name : \"cdb.exe\" or\n                  process.name : \"cmstp.exe\" or\n                  process.name : \"csi.exe\" or\n                  process.name : \"dnx.exe\" or\n                  process.name : \"fsi.exe\" or\n                  process.name : \"ieexec.exe\" or\n                  process.name : \"iexpress.exe\" or\n                  process.name : \"odbcconf.exe\" or\n                  process.name : \"rcsi.exe\" or\n                  process.name : \"xwizard.exe\") and\n     event.type == \"start\"]\n  [network where host.os.type == \"windows\" and (process.name : \"Microsoft.Workflow.Compiler.exe\" or\n                  process.name : \"bginfo.exe\" or\n                  process.name : \"cdb.exe\" or\n                  process.name : \"cmstp.exe\" or\n                  process.name : \"csi.exe\" or\n                  process.name : \"dnx.exe\" or\n                  process.name : \"fsi.exe\" or\n                  process.name : \"ieexec.exe\" or\n                  process.name : \"iexpress.exe\" or\n                  process.name : \"odbcconf.exe\" or\n                  process.name : \"rcsi.exe\" or\n                  process.name : \"xwizard.exe\")]",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-endpoint.events.network-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "Incoming DCOM Lateral Movement via MSHTA",
        "description": "Identifies the use of Distributed Component Object Model (DCOM) to execute commands from a remote host, which are launched via the HTA Application COM Object. This behavior may indicate an attacker abusing a DCOM application to move laterally while attempting to evade detection.",
        "risk_score": 73,
        "severity": "high",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 207,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Lateral Movement",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://codewhitesec.blogspot.com/2018/07/lethalhta.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1021",
                "name": "Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1021/",
                "subtechnique": [
                  {
                    "id": "T1021.003",
                    "name": "Distributed Component Object Model",
                    "reference": "https://attack.mitre.org/techniques/T1021/003/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1218",
                "name": "System Binary Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1218/",
                "subtechnique": [
                  {
                    "id": "T1218.005",
                    "name": "Mshta",
                    "reference": "https://attack.mitre.org/techniques/T1218/005/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.port",
            "type": "long",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "network.direction",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "network.transport",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "source.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "source.port",
            "type": "long",
            "ecs": true
          }
        ],
        "id": "7e4df6d2-2fd0-4515-9e9a-13a2f7291107",
        "rule_id": "622ecb68-fa81-4601-90b5-f8cd661e4520",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:44.952Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:33.549Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence with maxspan=1m\n  [process where host.os.type == \"windows\" and event.type == \"start\" and\n     process.name : \"mshta.exe\" and process.args : \"-Embedding\"\n  ] by host.id, process.entity_id\n  [network where host.os.type == \"windows\" and event.type == \"start\" and process.name : \"mshta.exe\" and\n     network.direction : (\"incoming\", \"ingress\") and network.transport == \"tcp\" and\n     source.port > 49151 and destination.port > 49151 and source.ip != \"127.0.0.1\" and source.ip != \"::1\"\n  ] by host.id, process.entity_id",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-endpoint.events.network-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "New User Added To GitHub Organization",
        "description": "A new user was added to a GitHub organization.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 204,
        "tags": [
          "Domain: Cloud",
          "Use Case: Threat Detection",
          "Use Case: UEBA",
          "Tactic: Persistence",
          "Rule Type: BBR",
          "Data Source: Github"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1098",
                "name": "Account Manipulation",
                "reference": "https://attack.mitre.org/techniques/T1098/",
                "subtechnique": [
                  {
                    "id": "T1098.001",
                    "name": "Additional Cloud Credentials",
                    "reference": "https://attack.mitre.org/techniques/T1098/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "github",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "a6ee565d-5e31-4b8a-bf3d-e8c2eeaa4ca1",
        "rule_id": "61336fe6-c043-4743-ab6e-41292f439603",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:44.928Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:33.527Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "configuration where event.dataset == \"github.audit\" and event.action == \"org.add_member\"",
        "language": "eql",
        "index": [
          "logs-github.audit-*"
        ],
        "filters": []
      },
      {
        "name": "Network Connection via Compiled HTML File",
        "description": "Compiled HTML files (.chm) are commonly distributed as part of the Microsoft HTML Help system. Adversaries may conceal malicious code in a CHM file and deliver it to a victim for execution. CHM content is loaded by the HTML Help executable program (hh.exe).",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Network Connection via Compiled HTML File\n\nCHM (Compiled HTML) files are a format for delivering online help files on Windows. CHM files are compressed compilations of various content, such as HTML documents, images, and scripting/web-related programming languages such as VBA, JScript, Java, and ActiveX.\n\nWhen users double-click CHM files, the HTML Help executable program (`hh.exe`) will execute them. `hh.exe` also can be used to execute code embedded in those files, PowerShell scripts, and executables. This makes it useful for attackers not only to proxy the execution of malicious payloads via a signed binary that could bypass security controls, but also to gain initial access to environments via social engineering methods.\n\nThis rule identifies network connections done by `hh.exe`, which can potentially indicate abuse to download malicious files or tooling, or masquerading.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n  - Examine the command lines for suspicious activities.\n  - Retrieve `.chm`, `.ps1`, and other files that were involved for further examination.\n  - Investigate any abnormal behavior by the subject process such as network connections, registry or file modifications, and any spawned child processes.\n  - Investigate the file digital signature and process original filename, if suspicious, treat it as potential malware.\n- Investigate the target host that the signed binary is communicating with.\n  - Check if the domain is newly registered or unexpected.\n  - Check the reputation of the domain or IP address.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the process executables, scripts and help files retrieved from the system using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n\n### False positive analysis\n\n- If this activity is expected and noisy in your environment, consider adding exceptions — preferably with a combination of user and command line conditions.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- If the malicious file was delivered via phishing:\n  - Block the email sender from sending future emails.\n  - Block the malicious web pages.\n  - Remove emails from the sender from mailboxes.\n  - Consider improvements to the security awareness program.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 208,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.iana.org/assignments/iana-ipv4-special-registry/iana-ipv4-special-registry.xhtml"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1204",
                "name": "User Execution",
                "reference": "https://attack.mitre.org/techniques/T1204/",
                "subtechnique": [
                  {
                    "id": "T1204.002",
                    "name": "Malicious File",
                    "reference": "https://attack.mitre.org/techniques/T1204/002/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1218",
                "name": "System Binary Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1218/",
                "subtechnique": [
                  {
                    "id": "T1218.001",
                    "name": "Compiled HTML File",
                    "reference": "https://attack.mitre.org/techniques/T1218/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "dns.question.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "b16ad355-6aa0-4d00-9740-59c51d9069aa",
        "rule_id": "b29ee2be-bf99-446c-ab1a-2dc0183394b8",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:47.606Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:42.964Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by process.entity_id\n  [process where host.os.type == \"windows\" and process.name : \"hh.exe\" and event.type == \"start\"]\n  [network where host.os.type == \"windows\" and process.name : \"hh.exe\" and\n     not cidrmatch(destination.ip, \"10.0.0.0/8\", \"127.0.0.0/8\", \"169.254.0.0/16\", \"172.16.0.0/12\", \"192.0.0.0/24\",\n       \"192.0.0.0/29\", \"192.0.0.8/32\", \"192.0.0.9/32\", \"192.0.0.10/32\", \"192.0.0.170/32\", \"192.0.0.171/32\",\n       \"192.0.2.0/24\", \"192.31.196.0/24\", \"192.52.193.0/24\", \"192.168.0.0/16\", \"192.88.99.0/24\", \"224.0.0.0/4\",\n       \"100.64.0.0/10\", \"192.175.48.0/24\",\"198.18.0.0/15\", \"198.51.100.0/24\", \"203.0.113.0/24\", \"240.0.0.0/4\", \"::1\",\n       \"FE80::/10\", \"FF00::/8\") and\n     not dns.question.name : \"localhost\"]",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-endpoint.events.network-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "At.exe Command Lateral Movement",
        "description": "Identifies use of at.exe to interact with the task scheduler on remote hosts. Remote task creations, modifications or execution could be indicative of adversary lateral movement.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 105,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Lateral Movement",
          "Data Source: Elastic Defend",
          "Rule Type: BBR",
          "Data Source: Elastic Endgame",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1021",
                "name": "Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1021/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1053",
                "name": "Scheduled Task/Job",
                "reference": "https://attack.mitre.org/techniques/T1053/",
                "subtechnique": [
                  {
                    "id": "T1053.002",
                    "name": "At",
                    "reference": "https://attack.mitre.org/techniques/T1053/002/"
                  },
                  {
                    "id": "T1053.005",
                    "name": "Scheduled Task",
                    "reference": "https://attack.mitre.org/techniques/T1053/005/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "2874378f-1f2c-48e1-a9e8-dd1ba35ba2fc",
        "rule_id": "b483365c-98a8-40c0-92d8-0458ca25058a",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:47.609Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:43.581Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and process.name : \"at.exe\" and process.args : \"\\\\\\\\*\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "winlogbeat-*",
          "logs-windows.*",
          "endgame-*",
          "logs-system.security*"
        ],
        "filters": []
      },
      {
        "name": "Elastic Agent Service Terminated",
        "description": "Identifies the Elastic endpoint agent has stopped and is no longer running on the host. Adversaries may attempt to disable security monitoring tools in an attempt to evade detection or prevention capabilities during an intrusion. This may also indicate an issue with the agent itself and should be addressed to ensure defensive measures are back in a stable state.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 107,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "OS: Windows",
          "OS: macOS",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.001",
                    "name": "Disable or Modify Tools",
                    "reference": "https://attack.mitre.org/techniques/T1562/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "32c9b4b9-a244-4dcf-a420-c2ba3800edb1",
        "rule_id": "b627cd12-dac4-11ec-9582-f661ea17fbcd",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:47.617Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:43.606Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where\n/* net, sc or wmic stopping or deleting Elastic Agent on Windows */\n(event.type == \"start\" and\n  process.name : (\"net.exe\", \"sc.exe\", \"wmic.exe\",\"powershell.exe\",\"taskkill.exe\",\"PsKill.exe\",\"ProcessHacker.exe\") and\n  process.args : (\"stopservice\",\"uninstall\", \"stop\", \"disabled\",\"Stop-Process\",\"terminate\",\"suspend\") and\n  process.args : (\"elasticendpoint\", \"Elastic Agent\",\"elastic-agent\",\"elastic-endpoint\"))\nor\n/* service or systemctl used to stop Elastic Agent on Linux */\n(event.type == \"end\" and\n  (process.name : (\"systemctl\", \"service\") and\n    process.args : \"elastic-agent\" and\n    process.args : (\"stop\", \"disable\"))\n  or\n  /* pkill , killall used to stop Elastic Agent on Linux */\n  ( event.type == \"end\" and process.name : (\"pkill\", \"killall\") and process.args: \"elastic-agent\")\n  or\n  /* Unload Elastic Agent extension on MacOS */\n  (process.name : \"kextunload\" and\n    process.args : \"com.apple.iokit.EndpointSecurity\" and\n    event.action : \"end\"))",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Windows Script Interpreter Executing Process via WMI",
        "description": "Identifies use of the built-in Windows script interpreters (cscript.exe or wscript.exe) being used to execute a process via Windows Management Instrumentation (WMI). This may be indicative of malicious activity.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 210,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Initial Access",
          "Tactic: Execution",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1566",
                "name": "Phishing",
                "reference": "https://attack.mitre.org/techniques/T1566/",
                "subtechnique": [
                  {
                    "id": "T1566.001",
                    "name": "Spearphishing Attachment",
                    "reference": "https://attack.mitre.org/techniques/T1566/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1047",
                "name": "Windows Management Instrumentation",
                "reference": "https://attack.mitre.org/techniques/T1047/"
              },
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.005",
                    "name": "Visual Basic",
                    "reference": "https://attack.mitre.org/techniques/T1059/005/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "dll.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.domain",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "5a90f3b1-5bec-4e5e-97f7-0eae3e6e8a1e",
        "rule_id": "b64b183e-1a76-422d-9179-7b389513e74d",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:47.620Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:43.611Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by host.id with maxspan = 5s\n    [any where host.os.type == \"windows\" and \n     (event.category : (\"library\", \"driver\") or (event.category == \"process\" and event.action : \"Image loaded*\")) and\n     (?dll.name : \"wmiutils.dll\" or file.name : \"wmiutils.dll\") and process.name : (\"wscript.exe\", \"cscript.exe\")]\n    [process where host.os.type == \"windows\" and event.type == \"start\" and\n     process.parent.name : \"wmiprvse.exe\" and\n     user.domain != \"NT AUTHORITY\" and\n     (process.pe.original_file_name :\n        (\n          \"cscript.exe\",\n          \"wscript.exe\",\n          \"PowerShell.EXE\",\n          \"Cmd.Exe\",\n          \"MSHTA.EXE\",\n          \"RUNDLL32.EXE\",\n          \"REGSVR32.EXE\",\n          \"MSBuild.exe\",\n          \"InstallUtil.exe\",\n          \"RegAsm.exe\",\n          \"RegSvcs.exe\",\n          \"msxsl.exe\",\n          \"CONTROL.EXE\",\n          \"EXPLORER.EXE\",\n          \"Microsoft.Workflow.Compiler.exe\",\n          \"msiexec.exe\"\n        ) or\n      process.executable : (\"C:\\\\Users\\\\*.exe\", \"C:\\\\ProgramData\\\\*.exe\")\n     )\n    ]",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-endpoint.events.library-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "Potential Privilege Escalation via Service ImagePath Modification",
        "description": "Identifies registry modifications to default services that could enable privilege escalation to SYSTEM. Attackers with privileges from groups like Server Operators may change the ImagePath of services to executables under their control or to execute commands.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 102,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Tactic: Privilege Escalation",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://cube0x0.github.io/Pocing-Beyond-DA/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1543",
                "name": "Create or Modify System Process",
                "reference": "https://attack.mitre.org/techniques/T1543/",
                "subtechnique": [
                  {
                    "id": "T1543.003",
                    "name": "Windows Service",
                    "reference": "https://attack.mitre.org/techniques/T1543/003/"
                  }
                ]
              },
              {
                "id": "T1574",
                "name": "Hijack Execution Flow",
                "reference": "https://attack.mitre.org/techniques/T1574/",
                "subtechnique": [
                  {
                    "id": "T1574.011",
                    "name": "Services Registry Permissions Weakness",
                    "reference": "https://attack.mitre.org/techniques/T1574/011/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1569",
                "name": "System Services",
                "reference": "https://attack.mitre.org/techniques/T1569/",
                "subtechnique": [
                  {
                    "id": "T1569.002",
                    "name": "Service Execution",
                    "reference": "https://attack.mitre.org/techniques/T1569/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.data.strings",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "registry.key",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.value",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "1d8ae83f-6d17-4a51-9ea8-6f490074fef8",
        "rule_id": "b66b7e2b-d50a-49b9-a6fc-3a383baedc6b",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:47.623Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:43.616Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "registry where host.os.type == \"windows\" and event.type == \"change\" and process.executable != null and \n  event.action == \"modification\" and registry.value == \"ImagePath\" and\n  registry.key : (\n    \"*\\\\ADWS\", \"*\\\\AppHostSvc\", \"*\\\\AppReadiness\", \"*\\\\AudioEndpointBuilder\", \"*\\\\AxInstSV\", \"*\\\\camsvc\", \"*\\\\CertSvc\",\n    \"*\\\\COMSysApp\", \"*\\\\CscService\", \"*\\\\defragsvc\", \"*\\\\DeviceAssociationService\", \"*\\\\DeviceInstall\", \"*\\\\DevQueryBroker\",\n    \"*\\\\Dfs\", \"*\\\\DFSR\", \"*\\\\diagnosticshub.standardcollector.service\", \"*\\\\DiagTrack\", \"*\\\\DmEnrollmentSvc\", \"*\\\\DNS\",\n    \"*\\\\dot3svc\", \"*\\\\Eaphost\", \"*\\\\GraphicsPerfSvc\", \"*\\\\hidserv\", \"*\\\\HvHost\", \"*\\\\IISADMIN\", \"*\\\\IKEEXT\",\n    \"*\\\\InstallService\", \"*\\\\iphlpsvc\", \"*\\\\IsmServ\", \"*\\\\LanmanServer\", \"*\\\\MSiSCSI\", \"*\\\\NcbService\", \"*\\\\Netlogon\",\n    \"*\\\\Netman\", \"*\\\\NtFrs\", \"*\\\\PlugPlay\", \"*\\\\Power\", \"*\\\\PrintNotify\", \"*\\\\ProfSvc\", \"*\\\\PushToInstall\", \"*\\\\RSoPProv\",\n    \"*\\\\sacsvr\", \"*\\\\SENS\", \"*\\\\SensorDataService\", \"*\\\\SgrmBroker\", \"*\\\\ShellHWDetection\", \"*\\\\shpamsvc\", \"*\\\\StorSvc\",\n    \"*\\\\svsvc\", \"*\\\\swprv\", \"*\\\\SysMain\", \"*\\\\Themes\", \"*\\\\TieringEngineService\", \"*\\\\TokenBroker\", \"*\\\\TrkWks\",\n    \"*\\\\UALSVC\", \"*\\\\UserManager\", \"*\\\\vm3dservice\", \"*\\\\vmicguestinterface\", \"*\\\\vmicheartbeat\", \"*\\\\vmickvpexchange\",\n    \"*\\\\vmicrdv\", \"*\\\\vmicshutdown\", \"*\\\\vmicvmsession\", \"*\\\\vmicvss\", \"*\\\\vmvss\", \"*\\\\VSS\", \"*\\\\w3logsvc\", \"*\\\\W3SVC\",\n    \"*\\\\WalletService\", \"*\\\\WAS\", \"*\\\\wercplsupport\", \"*\\\\WerSvc\", \"*\\\\Winmgmt\", \"*\\\\wisvc\", \"*\\\\wmiApSrv\",\n    \"*\\\\WPDBusEnum\", \"*\\\\WSearch\"\n  ) and\n  not (\n    registry.data.strings : (\n        \"?:\\\\Windows\\\\system32\\\\*.exe\",\n        \"%systemroot%\\\\system32\\\\*.exe\",\n        \"%windir%\\\\system32\\\\*.exe\",\n        \"%SystemRoot%\\\\system32\\\\svchost.exe -k *\",\n        \"%windir%\\\\system32\\\\svchost.exe -k *\"\n    ) and\n        not registry.data.strings : (\n            \"*\\\\cmd.exe\",\n            \"*\\\\cscript.exe\",\n            \"*\\\\ieexec.exe\",\n            \"*\\\\iexpress.exe\",\n            \"*\\\\installutil.exe\",\n            \"*\\\\Microsoft.Workflow.Compiler.exe\",\n            \"*\\\\msbuild.exe\",\n            \"*\\\\mshta.exe\",\n            \"*\\\\msiexec.exe\",\n            \"*\\\\msxsl.exe\",\n            \"*\\\\net.exe\",\n            \"*\\\\powershell.exe\",\n            \"*\\\\pwsh.exe\",\n            \"*\\\\reg.exe\",\n            \"*\\\\RegAsm.exe\",\n            \"*\\\\RegSvcs.exe\",\n            \"*\\\\regsvr32.exe\",\n            \"*\\\\rundll32.exe\",\n            \"*\\\\vssadmin.exe\",\n            \"*\\\\wbadmin.exe\",\n            \"*\\\\wmic.exe\",\n            \"*\\\\wscript.exe\"\n        )\n  )",
        "language": "eql",
        "index": [
          "logs-endpoint.events.registry-*",
          "logs-windows.sysmon_operational-*",
          "winlogbeat-*"
        ],
        "filters": []
      },
      {
        "name": "Creation or Modification of Domain Backup DPAPI private key",
        "description": "Identifies the creation or modification of Domain Backup private keys. Adversaries may extract the Data Protection API (DPAPI) domain backup key from a Domain Controller (DC) to be able to decrypt any domain user master key file.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\nDomain DPAPI Backup keys are stored on domain controllers and can be dumped remotely with tools such as Mimikatz. The resulting .pvk private key can be used to decrypt ANY domain user masterkeys, which then can be used to decrypt any secrets protected by those keys.\n",
        "output_index": "",
        "version": 412,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.dsinternals.com/en/retrieving-dpapi-backup-keys-from-active-directory/",
          "https://posts.specterops.io/operational-guidance-for-offensive-user-dpapi-abuse-1fb7fac8b107"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1552",
                "name": "Unsecured Credentials",
                "reference": "https://attack.mitre.org/techniques/T1552/",
                "subtechnique": [
                  {
                    "id": "T1552.004",
                    "name": "Private Keys",
                    "reference": "https://attack.mitre.org/techniques/T1552/004/"
                  }
                ]
              },
              {
                "id": "T1555",
                "name": "Credentials from Password Stores",
                "reference": "https://attack.mitre.org/techniques/T1555/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "091d9d61-072b-4cdb-b76e-ac3df214d0bf",
        "rule_id": "b83a7e96-2eb3-4edf-8346-427b6858d3bd",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:47.626Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:43.645Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"windows\" and event.type != \"deletion\" and file.name : (\"ntds_capi_*.pfx\", \"ntds_capi_*.pvk\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.file-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-m365_defender.event-*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Network Connection via MsXsl",
        "description": "Identifies msxsl.exe making a network connection. This may indicate adversarial activity as msxsl.exe is often leveraged by adversaries to execute malicious scripts and evade detection.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.iana.org/assignments/iana-ipv4-special-registry/iana-ipv4-special-registry.xhtml"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1220",
                "name": "XSL Script Processing",
                "reference": "https://attack.mitre.org/techniques/T1220/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "996daa40-6884-44ee-adda-901adc2c961d",
        "rule_id": "b86afe07-0d98-4738-b15d-8d7465f95ff5",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:47.629Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:43.650Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by process.entity_id\n  [process where host.os.type == \"windows\" and process.name : \"msxsl.exe\" and event.type == \"start\"]\n  [network where host.os.type == \"windows\" and process.name : \"msxsl.exe\" and\n     not cidrmatch(destination.ip, \"10.0.0.0/8\", \"127.0.0.0/8\", \"169.254.0.0/16\", \"172.16.0.0/12\", \"192.0.0.0/24\",\n       \"192.0.0.0/29\", \"192.0.0.8/32\", \"192.0.0.9/32\", \"192.0.0.10/32\", \"192.0.0.170/32\", \"192.0.0.171/32\",\n       \"192.0.2.0/24\", \"192.31.196.0/24\", \"192.52.193.0/24\", \"192.168.0.0/16\", \"192.88.99.0/24\", \"224.0.0.0/4\",\n       \"100.64.0.0/10\", \"192.175.48.0/24\",\"198.18.0.0/15\", \"198.51.100.0/24\", \"203.0.113.0/24\", \"240.0.0.0/4\", \"::1\",\n       \"FE80::/10\", \"FF00::/8\")]",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-endpoint.events.network-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "Chkconfig Service Add",
        "description": "Detects the use of the chkconfig binary to manually add a service for management by chkconfig. Threat actors may utilize this technique to maintain persistence on a system. When a new service is added, chkconfig ensures that the service has either a start or a kill entry in every runlevel and when the system is rebooted the service file added will run providing long-term persistence.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Chkconfig Service Add\nService files are configuration files in Linux systems used to define and manage system services. The `Chkconfig` binary can be used to manually add, delete or modify a service. \n\nMalicious actors can leverage services to achieve persistence by creating or modifying service files to execute malicious commands or payloads during system startup. This allows them to maintain unauthorized access, execute additional malicious activities, or evade detection.\n\nThis rule monitors the usage of the `chkconfig` binary to manually add a service for management by `chkconfig`, potentially indicating the creation of a persistence mechanism.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n> This investigation guide uses [placeholder fields](https://www.elastic.co/guide/en/security/current/osquery-placeholder-fields.html) to dynamically pass alert data into Osquery queries. Placeholder fields were introduced in Elastic Stack version 8.7.0. If you're using Elastic Stack version 8.6.0 or earlier, you'll need to manually adjust this investigation guide's queries to ensure they properly run.\n\n#### Possible Investigation Steps\n\n- Investigate the service that was created or modified.\n- Investigate the currently enabled system services through the following commands `sudo chkconfig --list | grep on` and `sudo systemctl list-unit-files`.\n- Investigate the status of potentially suspicious services through the `chkconfig --list service_name` command. \n- Search for the `rc.d` or `init.d` service files that were created or modified, and analyze their contents.\n- Investigate whether any other files in any of the available `rc.d` or `init.d` directories have been altered through OSQuery.\n  - !{osquery{\"label\":\"Osquery - Retrieve File Listing Information\",\"query\":\"SELECT * FROM file WHERE (path LIKE '/etc/init.d/%' OR path LIKE '/etc/rc%.d/%')\"}}\n  - !{osquery{\"label\":\"Osquery - Retrieve Additional File Listing Information\",\"query\":\"SELECT f.path, u.username AS file_owner, g.groupname AS group_owner, datetime(f.atime, 'unixepoch') AS\\nfile_last_access_time, datetime(f.mtime, 'unixepoch') AS file_last_modified_time, datetime(f.ctime, 'unixepoch') AS\\nfile_last_status_change_time, datetime(f.btime, 'unixepoch') AS file_created_time, f.size AS size_bytes FROM file f LEFT\\nJOIN users u ON f.uid = u.uid LEFT JOIN groups g ON f.gid = g.gid WHERE (path LIKE '/etc/init.d/%' OR path LIKE\\n'/etc/rc%.d/%')\\n\"}}\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence and whether they are located in expected locations.\n  - !{osquery{\"label\":\"Osquery - Retrieve Running Processes by User\",\"query\":\"SELECT pid, username, name FROM processes p JOIN users u ON u.uid = p.uid ORDER BY username\"}}\n- Investigate syslog through the `sudo cat /var/log/syslog | grep 'LSB'` command to find traces of the LSB header of the script (if present). If syslog is being ingested into Elasticsearch, the same can be accomplished through Kibana.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Validate the activity is not related to planned patches, updates, network administrator activity, or legitimate software installations.\n- Investigate whether the altered scripts call other malicious scripts elsewhere on the file system. \n  - If scripts or executables were dropped, retrieve the files and determine if they are malicious:\n    - Use a private sandboxed malware analysis system to perform analysis.\n      - Observe and collect information about the following activities:\n        - Attempts to contact external domains and addresses.\n          - Check if the domain is newly registered or unexpected.\n          - Check the reputation of the domain or IP address.\n        - File access, modification, and creation activities.\n        - Cron jobs, services and other persistence mechanisms.\n            - !{osquery{\"label\":\"Osquery - Retrieve Crontab Information\",\"query\":\"SELECT * FROM crontab\"}}\n- Investigate abnormal behaviors by the subject process/user such as network connections, file modifications, and any other spawned child processes.\n  - Investigate listening ports and open sockets to look for potential command and control traffic or data exfiltration.\n    - !{osquery{\"label\":\"Osquery - Retrieve Listening Ports\",\"query\":\"SELECT pid, address, port, socket, protocol, path FROM listening_ports\"}}\n    - !{osquery{\"label\":\"Osquery - Retrieve Open Sockets\",\"query\":\"SELECT pid, family, remote_address, remote_port, socket, state FROM process_open_sockets\"}}\n  - Identify the user account that performed the action, analyze it, and check whether it should perform this kind of action.\n    - !{osquery{\"label\":\"Osquery - Retrieve Information for a Specific User\",\"query\":\"SELECT * FROM users WHERE username = {{user.name}}\"}}\n- Investigate whether the user is currently logged in and active.\n    - !{osquery{\"label\":\"Osquery - Investigate the Account Authentication Status\",\"query\":\"SELECT * FROM logged_in_users WHERE user = {{user.name}}\"}}\n\n### False Positive Analysis\n\n- If this activity is related to new benign software installation activity, consider adding exceptions — preferably with a combination of user and command line conditions.\n- If this activity is related to a system administrator who uses the `chkconfig` binary for administrative purposes, consider adding exceptions for this specific administrator user account. \n- Try to understand the context of the execution by thinking about the user, machine, or business purpose. A small number of endpoints, such as servers with unique software, might appear unusual but satisfy a specific business need.\n\n### Related Rules\n\n- Suspicious File Creation in /etc for Persistence - 1c84dd64-7e6c-4bad-ac73-a5014ee37042\n- Potential Persistence Through Run Control Detected - 0f4d35e4-925e-4959-ab24-911be207ee6f\n- Potential Persistence Through init.d Detected - 474fd20e-14cc-49c5-8160-d9ab4ba16c8b\n- New Systemd Timer Created - 7fb500fa-8e24-4bd1-9480-2a819352602c\n- New Systemd Service Created by Previously Unknown Process - 17b0a495-4d9f-414c-8ad0-92f018b8e001\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Delete the service/timer or restore its original configuration.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Leverage the incident response data and logging to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 113,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Threat: Lightning Framework",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.intezer.com/blog/research/lightning-framework-new-linux-threat/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1037",
                "name": "Boot or Logon Initialization Scripts",
                "reference": "https://attack.mitre.org/techniques/T1037/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "4bfb0d36-cded-4f3f-881a-cad50dc14c86",
        "rule_id": "b910f25a-2d44-47f2-a873-aabdc0d355e6",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:47.631Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:43.655Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.action in (\"exec\", \"exec_event\") and\n( \n  (process.executable : \"/usr/sbin/chkconfig\" and process.args : \"--add\") or\n  (process.args : \"*chkconfig\" and process.args : \"--add\")\n) and not (\n  process.parent.name in (\"rpm\", \"qualys-scan-util\", \"qualys-cloud-agent\", \"update-alternatives\") or\n  process.parent.args : (\"/var/tmp/rpm*\", \"/var/lib/waagent/*\") or\n  process.args in (\"jexec\", \"sapinit\", \"httpd\", \"dbora\")\n)",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "Group Policy Abuse for Privilege Addition",
        "description": "Detects the first occurrence of a modification to Group Policy Object Attributes to add privileges to user accounts or use them to add users as local admins.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Group Policy Abuse for Privilege Addition\n\nGroup Policy Objects (GPOs) can be used to add rights and/or modify Group Membership on GPOs by changing the contents of an INF file named GptTmpl.inf, which is responsible for storing every setting under the Security Settings container in the GPO. This file is unique for each GPO, and only exists if the GPO contains security settings. Example Path: \"\\\\DC.com\\SysVol\\DC.com\\Policies\\{PolicyGUID}\\Machine\\Microsoft\\Windows NT\\SecEdit\\GptTmpl.inf\"\n\n#### Possible investigation steps\n\n- This attack abuses a legitimate mechanism of Active Directory, so it is important to determine whether the activity is legitimate and the administrator is authorized to perform this operation.\n- Retrieve the contents of the `GptTmpl.inf` file, and under the `Privilege Rights` section, look for potentially dangerous high privileges, for example: SeTakeOwnershipPrivilege, SeEnableDelegationPrivilege, etc.\n- Inspect the user security identifiers (SIDs) associated with these privileges, and if they should have these privileges.\n\n### False positive analysis\n\n- Inspect whether the user that has done the modifications should be allowed to. The user name can be found in the `winlog.event_data.SubjectUserName` field.\n\n### Related rules\n\n- Scheduled Task Execution at Scale via GPO - 15a8ba77-1c13-4274-88fe-6bd14133861e\n- Startup/Logon Script added to Group Policy Object - 16fac1a1-21ee-4ca6-b720-458e3855d046\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- The investigation and containment must be performed in every computer controlled by the GPO, where necessary.\n- Remove the script from the GPO.\n- Check if other GPOs have suspicious scripts attached.\n",
        "output_index": "",
        "version": 211,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Data Source: Active Directory",
          "Resources: Investigation Guide",
          "Use Case: Active Directory Monitoring",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/atc-project/atc-data/blob/master/docs/Logging_Policies/LP_0025_windows_audit_directory_service_changes.md",
          "https://labs.f-secure.com/tools/sharpgpoabuse"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1484",
                "name": "Domain or Tenant Policy Modification",
                "reference": "https://attack.mitre.org/techniques/T1484/",
                "subtechnique": [
                  {
                    "id": "T1484.001",
                    "name": "Group Policy Modification",
                    "reference": "https://attack.mitre.org/techniques/T1484/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'Audit Directory Service Changes' audit policy must be configured (Success Failure).\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nPolicies >\nWindows Settings >\nSecurity Settings >\nAdvanced Audit Policies Configuration >\nAudit Policies >\nDS Access >\nAudit Directory Service Changes (Success,Failure)\n```\n",
        "related_integrations": [
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.code",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.event_data.AttributeLDAPDisplayName",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "winlog.event_data.AttributeValue",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "fd9364a5-2b65-4ef2-9c27-c2656bdfd830",
        "rule_id": "b9554892-5e0e-424b-83a0-5aef95aa43bf",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:47.634Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:43.674Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "any where host.os.type == \"windows\" and event.code: \"5136\" and\n  winlog.event_data.AttributeLDAPDisplayName: \"gPCMachineExtensionNames\" and\n  winlog.event_data.AttributeValue: \"*827D319E-6EAC-11D2-A4EA-00C04F79F83A*\" and\n  winlog.event_data.AttributeValue: \"*803E14A0-B4FB-11D0-A0D0-00A0C90F574B*\"",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-system.*",
          "logs-windows.*"
        ],
        "filters": []
      },
      {
        "name": "Creation of Hidden Files and Directories via CommandLine",
        "description": "Users can mark specific files as hidden simply by putting a \".\" as the first character in the file or folder name. Adversaries can use this to their advantage to hide files and folders on the system for persistence and defense evasion. This rule looks for hidden files or folders in common writable directories.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 111,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Certain tools may create hidden temporary files or directories upon installation or as part of their normal behavior. These events can be filtered by the process arguments, username, or process name values."
        ],
        "references": [],
        "max_signals": 33,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1564",
                "name": "Hide Artifacts",
                "reference": "https://attack.mitre.org/techniques/T1564/",
                "subtechnique": [
                  {
                    "id": "T1564.001",
                    "name": "Hidden Files and Directories",
                    "reference": "https://attack.mitre.org/techniques/T1564/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            }
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from one of the following integrations:\n- Elastic Defend\n- Auditbeat\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n### Auditbeat Setup\nAuditbeat is a lightweight shipper that you can install on your servers to audit the activities of users and processes on your systems. For example, you can use Auditbeat to collect and centralize audit events from the Linux Audit Framework. You can also use Auditbeat to detect changes to critical files, like binaries and configuration files, and identify potential security policy violations.\n\n#### The following steps should be executed in order to add the Auditbeat on a Linux System:\n- Elastic provides repositories available for APT and YUM-based distributions. Note that we provide binary packages, but no source packages.\n- To install the APT and YUM repositories follow the setup instructions in this [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/setup-repositories.html).\n- To run Auditbeat on Docker follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/running-on-docker.html).\n- To run Auditbeat on Kubernetes follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/running-on-kubernetes.html).\n- For complete “Setup and Run Auditbeat” information refer to the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/setting-up-and-running.html).\n\n#### Custom Ingest Pipeline\nFor versions <8.2, you need to add a custom ingest pipeline to populate `event.ingested` with @timestamp for non-elastic-agent indexes, like auditbeats/filebeat/winlogbeat etc. For more details to add a custom ingest pipeline refer to the [guide](https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.working_directory",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "b68fc6cc-a8d3-4b5a-ad27-4f3c81c23481",
        "rule_id": "b9666521-4742-49ce-9ddc-b8e84c35acae",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:47.637Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:43.679Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\nprocess.working_directory in (\"/tmp\", \"/var/tmp\", \"/dev/shm\") and\nprocess.args regex~ \"\"\"\\.[a-z0-9_\\-][a-z0-9_\\-\\.]{1,254}\"\"\" and\nnot process.name in (\n  \"ls\", \"find\", \"grep\", \"git\", \"jq\", \"basename\", \"check_snmp\", \"snmpget\", \"snmpwalk\", \"cc1plus\", \"snap\",\n  \"command-not-found\"\n)",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious Image Load (taskschd.dll) from MS Office",
        "description": "Identifies a suspicious image load (taskschd.dll) from Microsoft Office processes. This behavior may indicate adversarial activity where a scheduled task is configured via Windows Component Object Model (COM). This technique can be used to configure persistence and evade monitoring by avoiding the usage of the traditional Windows binary (schtasks.exe) used to manage scheduled tasks.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Suspicious Image Load (taskschd.dll) from MS Office\n\nMicrosoft Office, a widely used suite of productivity applications, is frequently targeted by attackers due to its popularity in corporate environments. These attackers exploit its extensive capabilities, like macro scripts in Word and Excel, to gain initial access to systems. They often use Office documents as delivery mechanisms for malware or phishing attempts, taking advantage of their trusted status in professional settings.\n\n`taskschd.dll` provides Command Object Model (COM) interfaces for the Windows Task Scheduler service, allowing developers to programmatically manage scheduled tasks.\n\nThis rule looks for an MS Office process loading `taskschd.dll`, which may indicate an adversary abusing COM to configure a scheduled task. This can happen as part of a phishing attack, when a malicious office document registers the scheduled task to download the malware \"stage 2\" or to establish persistent access.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n### Possible investigation steps\n\n- Analyze the host's scheduled tasks and explore the related Windows events to determine if tasks were created or deleted (Event IDs 4698 and 4699).\n- Investigate any abnormal behavior by the subject process, such as network connections, registry or file modifications, and spawned child processes.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Inspect the host for suspicious or abnormal behavior in the alert timeframe.\n- Examine the files downloaded during the past 24 hours.\n  - Identify files that are related or can be executed in MS Office.\n  - Identify and analyze macros that these documents contain.\n    - Identify suspicious traits in the office macros, such as encoded or encrypted sections.\n- Retrieve the suspicious files identified in the previous step and determine if they are malicious:\n  - Analyze the file using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Any activity that triggered the alert and is not inherently malicious must be monitored by the security team.\n\n### Related Rules\n\n- Suspicious WMI Image Load from MS Office - 891cb88e-441a-4c3e-be2d-120d99fe7b0d\n\n### Response and Remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n  - If the malicious file was delivered via phishing:\n    - Block the email sender from sending future emails.\n    - Block the malicious web pages.\n    - Remove emails from the sender from mailboxes.\n    - Consider improvements to the security awareness program.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 209,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Tactic: Execution",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://medium.com/threatpunter/detecting-adversary-tradecraft-with-image-load-event-logging-and-eql-8de93338c16",
          "https://www.clearskysec.com/wp-content/uploads/2020/10/Operation-Quicksand.pdf"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1053",
                "name": "Scheduled Task/Job",
                "reference": "https://attack.mitre.org/techniques/T1053/",
                "subtechnique": [
                  {
                    "id": "T1053.005",
                    "name": "Scheduled Task",
                    "reference": "https://attack.mitre.org/techniques/T1053/005/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1053",
                "name": "Scheduled Task/Job",
                "reference": "https://attack.mitre.org/techniques/T1053/",
                "subtechnique": [
                  {
                    "id": "T1053.005",
                    "name": "Scheduled Task",
                    "reference": "https://attack.mitre.org/techniques/T1053/005/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "dll.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "1cf8dddc-eaaf-4936-96cf-667f6d57d897",
        "rule_id": "baa5d22c-5e1c-4f33-bfc9-efa73bb53022",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:47.639Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:43.693Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "any where host.os.type == \"windows\" and\n (event.category : (\"library\", \"driver\") or (event.category == \"process\" and event.action : \"Image loaded*\")) and\n  process.name : (\"WINWORD.EXE\", \"EXCEL.EXE\", \"POWERPNT.EXE\", \"MSPUB.EXE\", \"MSACCESS.EXE\") and\n  (?dll.name : \"taskschd.dll\" or file.name : \"taskschd.dll\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.library-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "Potential Non-Standard Port SSH connection",
        "description": "Identifies potentially malicious processes communicating via a port paring typically not associated with SSH. For example, SSH over port 2200 or port 2222 as opposed to the traditional port 22. Adversaries may make changes to the standard port a protocol uses to bypass filtering or muddle analysis/parsing of network data.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 6,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Command and Control",
          "OS: macOS",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "SSH over ports apart from the traditional port 22 is highly uncommon. This rule alerts the usage of the such uncommon ports by the ssh service. Tuning is needed to have higher confidence. If this activity is expected and noisy in your environment, consider adding exceptions — preferably with a combination whitelisted ports for such legitimate ssh activities."
        ],
        "references": [
          "https://attack.mitre.org/techniques/T1571/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            },
            "technique": [
              {
                "id": "T1571",
                "name": "Non-Standard Port",
                "reference": "https://attack.mitre.org/techniques/T1571/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "destination.port",
            "type": "long",
            "ecs": true
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "network.transport",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "3c5cb591-fa1e-49a9-8b56-ed5292121f42",
        "rule_id": "bc8ca7e0-92fd-4b7c-b11e-ee0266b8d9c9",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:47.642Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:44.909Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by process.entity_id with maxspan=1m\n  [process where event.action == \"exec\" and process.name in (\"ssh\", \"sshd\") and not process.parent.name in (\n   \"rsync\", \"pyznap\", \"git\", \"ansible-playbook\", \"scp\", \"pgbackrest\", \"git-lfs\", \"expect\", \"Sourcetree\", \"ssh-copy-id\",\n   \"run\"\n   )\n  ]\n  [network where process.name:\"ssh\" and event.action in (\"connection_attempted\", \"connection_accepted\") and \n   destination.port != 22 and network.transport == \"tcp\" and not (\n     destination.ip == null or destination.ip == \"0.0.0.0\" or cidrmatch(\n       destination.ip, \"10.0.0.0/8\", \"127.0.0.0/8\", \"169.254.0.0/16\", \"172.16.0.0/12\", \"192.0.0.0/24\", \"192.0.0.0/29\",\n       \"192.0.0.8/32\", \"192.0.0.9/32\", \"192.0.0.10/32\", \"192.0.0.170/32\", \"192.0.0.171/32\", \"192.0.2.0/24\",\n       \"192.31.196.0/24\", \"192.52.193.0/24\", \"192.168.0.0/16\", \"192.88.99.0/24\", \"224.0.0.0/4\", \"100.64.0.0/10\",\n       \"192.175.48.0/24\",\"198.18.0.0/15\", \"198.51.100.0/24\", \"203.0.113.0/24\", \"240.0.0.0/4\", \"::1\", \"FE80::/10\",\n       \"FF00::/8\"\n     )\n   )\n  ]",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Potential Defense Evasion via CMSTP.exe",
        "description": "The Microsoft Connection Manager Profile Installer (CMSTP.exe) is a command-line program to install Connection Manager service profiles, which accept installation information file (INF) files. Adversaries may abuse CMSTP to proxy the execution of malicious code by supplying INF files that contain malicious commands.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 105,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend",
          "Rule Type: BBR",
          "Data Source: Sysmon",
          "Data Source: Elastic Endgame",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://attack.mitre.org/techniques/T1218/003/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1218",
                "name": "System Binary Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1218/",
                "subtechnique": [
                  {
                    "id": "T1218.003",
                    "name": "CMSTP",
                    "reference": "https://attack.mitre.org/techniques/T1218/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "d82be874-4920-45fb-bab7-a8ef69991802",
        "rule_id": "bd3d058d-5405-4cee-b890-337f09366ba2",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:47.645Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:44.928Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.name : \"cmstp.exe\" and process.args == \"/s\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "winlogbeat-*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious Print Spooler Point and Print DLL",
        "description": "Detects attempts to exploit a privilege escalation vulnerability (CVE-2020-1030) related to the print spooler service. Exploitation involves chaining multiple primitives to load an arbitrary DLL into the print spooler process running as SYSTEM.",
        "risk_score": 73,
        "severity": "high",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 208,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Data Source: Elastic Endgame",
          "Use Case: Vulnerability",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.accenture.com/us-en/blogs/cyber-defense/discovering-exploiting-shutting-down-dangerous-windows-print-spooler-vulnerability",
          "https://github.com/sbousseaden/EVTX-ATTACK-SAMPLES/blob/master/Privilege%20Escalation/privesc_sysmon_cve_20201030_spooler.evtx",
          "https://msrc.microsoft.com/update-guide/en-US/vulnerability/CVE-2020-1030"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1068",
                "name": "Exploitation for Privilege Escalation",
                "reference": "https://attack.mitre.org/techniques/T1068/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.data.strings",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "registry.path",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "6fee9bbe-45a3-456f-84bb-998e642d70bc",
        "rule_id": "bd7eefee-f671-494e-98df-f01daf9e5f17",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:47.647Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:44.940Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by host.id with maxspan=30s\n[registry where host.os.type == \"windows\" and\n registry.path : (\n    \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Print\\\\Printers\\\\*\\\\SpoolDirectory\",\n    \"\\\\REGISTRY\\\\MACHINE\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Print\\\\Printers\\\\*\\\\SpoolDirectory\"\n    ) and\n registry.data.strings : \"C:\\\\Windows\\\\System32\\\\spool\\\\drivers\\\\x64\\\\4\"]\n[registry where host.os.type == \"windows\" and\n registry.path : (\n    \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Print\\\\Printers\\\\*\\\\CopyFiles\\\\Payload\\\\Module\",\n    \"\\\\REGISTRY\\\\MACHINE\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Print\\\\Printers\\\\*\\\\CopyFiles\\\\Payload\\\\Module\"\n    ) and\n registry.data.strings : \"C:\\\\Windows\\\\System32\\\\spool\\\\drivers\\\\x64\\\\4\\\\*\"]",
        "language": "eql",
        "index": [
          "logs-endpoint.events.registry-*",
          "endgame-*",
          "logs-windows.sysmon_operational-*",
          "winlogbeat-*"
        ],
        "filters": []
      },
      {
        "name": "Potential Pspy Process Monitoring Detected",
        "description": "This rule leverages auditd to monitor for processes scanning different processes within the /proc directory using the openat syscall. This is a strong indication for the usage of the pspy utility. Attackers may leverage the pspy process monitoring utility to monitor system processes without requiring root permissions, in order to find potential privilege escalation vectors.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 8,
        "tags": [
          "Data Source: Auditd Manager",
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Discovery"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/DominicBreuker/pspy"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1057",
                "name": "Process Discovery",
                "reference": "https://attack.mitre.org/techniques/T1057/"
              },
              {
                "id": "T1082",
                "name": "System Information Discovery",
                "reference": "https://attack.mitre.org/techniques/T1082/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Auditd Manager.\n\n### Auditd Manager Integration Setup\nThe Auditd Manager Integration receives audit events from the Linux Audit Framework which is a part of the Linux kernel.\nAuditd Manager provides a user-friendly interface and automation capabilities for configuring and monitoring system auditing through the auditd daemon. With `auditd_manager`, administrators can easily define audit rules, track system events, and generate comprehensive audit reports, improving overall security and compliance in the system.\n\n#### The following steps should be executed in order to add the Elastic Agent System integration \"auditd_manager\" on a Linux System:\n- Go to the Kibana home page and click “Add integrations”.\n- In the query bar, search for “Auditd Manager” and select the integration to see more details about it.\n- Click “Add Auditd Manager”.\n- Configure the integration name and optionally add a description.\n- Review optional and advanced settings accordingly.\n- Add the newly installed “auditd manager” to an existing or a new agent policy, and deploy the agent on a Linux system from which auditd log files are desirable.\n- Click “Save and Continue”.\n- For more details on the integration refer to the [helper guide](https://docs.elastic.co/integrations/auditd_manager).\n\n#### Rule Specific Setup Note\nAuditd Manager subscribes to the kernel and receives events as they occur without any additional configuration.\nHowever, if more advanced configuration is required to detect specific behavior, audit rules can be added to the integration in either the \"audit rules\" configuration box or the \"auditd rule files\" box by specifying a file to read the audit rules from.\n- For this detection rule the following additional audit rules are required to be added to the integration:\n  -- \"-w /proc/ -p r -k audit_proc\"\n",
        "related_integrations": [
          {
            "package": "auditd_manager",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "auditd.data.a0",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "auditd.data.a2",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "auditd.data.syscall",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pid",
            "type": "long",
            "ecs": true
          }
        ],
        "id": "9374228f-5397-4c50-bc9f-48bf51841982",
        "rule_id": "bdb04043-f0e3-4efa-bdee-7d9d13fa9edc",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:47.650Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:44.945Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by process.pid, host.id with maxspan=5s\n  [file where host.os.type == \"linux\" and auditd.data.syscall == \"openat\" and file.path == \"/proc\" and\n   auditd.data.a0 : (\"ffffffffffffff9c\", \"ffffff9c\") and auditd.data.a2 : (\"80000\", \"88000\") and\n   not process.name == \"agentbeat\"\n  ] with runs=10",
        "language": "eql",
        "index": [
          "logs-auditd_manager.auditd-*"
        ],
        "filters": []
      },
      {
        "name": "Potential Privileged Escalation via SamAccountName Spoofing",
        "description": "Identifies a suspicious computer account name rename event, which may indicate an attempt to exploit CVE-2021-42278 to elevate privileges from a standard domain user to a user with domain admin privileges. CVE-2021-42278 is a security vulnerability that allows potential attackers to impersonate a domain controller via samAccountName attribute spoofing.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 209,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Tactic: Privilege Escalation",
          "Use Case: Active Directory Monitoring",
          "Data Source: Active Directory",
          "Use Case: Vulnerability",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://support.microsoft.com/en-us/topic/kb5008102-active-directory-security-accounts-manager-hardening-changes-cve-2021-42278-5975b463-4c95-45e1-831a-d120004e258e",
          "https://cloudbrothers.info/en/exploit-kerberos-samaccountname-spoofing/",
          "https://github.com/cube0x0/noPac",
          "https://twitter.com/exploitph/status/1469157138928914432",
          "https://exploit.ph/cve-2021-42287-cve-2021-42278-weaponisation.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1068",
                "name": "Exploitation for Privilege Escalation",
                "reference": "https://attack.mitre.org/techniques/T1068/"
              },
              {
                "id": "T1078",
                "name": "Valid Accounts",
                "reference": "https://attack.mitre.org/techniques/T1078/",
                "subtechnique": [
                  {
                    "id": "T1078.002",
                    "name": "Domain Accounts",
                    "reference": "https://attack.mitre.org/techniques/T1078/002/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1098",
                "name": "Account Manipulation",
                "reference": "https://attack.mitre.org/techniques/T1098/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.event_data.NewTargetUserName",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "winlog.event_data.OldTargetUserName",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "184aac34-6713-49a5-b7d1-25d153f99b6f",
        "rule_id": "bdcf646b-08d4-492c-870a-6c04e3700034",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:47.653Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:44.949Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "iam where event.action == \"renamed-user-account\" and\n  /* machine account name renamed to user like account name */\n  winlog.event_data.OldTargetUserName : \"*$\" and not winlog.event_data.NewTargetUserName : \"*$\"",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-system.*",
          "logs-windows.*"
        ],
        "filters": []
      },
      {
        "name": "Attempted Private Key Access",
        "description": "Attackers may try to access private keys, e.g. ssh, in order to gain further authenticated access to the environment.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 106,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Data Source: Elastic Defend",
          "Rule Type: BBR",
          "Data Source: Sysmon",
          "Data Source: Elastic Endgame",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1552",
                "name": "Unsecured Credentials",
                "reference": "https://attack.mitre.org/techniques/T1552/",
                "subtechnique": [
                  {
                    "id": "T1552.004",
                    "name": "Private Keys",
                    "reference": "https://attack.mitre.org/techniques/T1552/004/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "fe0dc654-b1ea-4a90-aebe-5eb190dcc350",
        "rule_id": "c55badd3-3e61-4292-836f-56209dc8a601",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:47.655Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:45.054Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.args : (\"*.pem *\", \"*.pem\", \"*.id_rsa*\") and\n  not process.args: (\"--tls-cert\", \"--ssl-cert\") and\n  not process.executable : (\n    \"?:\\\\ProgramData\\\\Logishrd\\\\LogiOptions\\\\Software\\\\*\\\\LogiLuUpdater.exe\",\n    \"?:\\\\Program Files\\\\Elastic\\\\Agent\\\\data\\\\*\\\\osqueryd.exe\",\n    \"?:\\\\Program Files\\\\Guardicore\\\\gc-controller.exe\",\n    \"?:\\\\Program Files\\\\Guardicore\\\\gc-deception-agent.exe\",\n    \"?:\\\\Program Files\\\\Guardicore\\\\gc-detection-agent.exe\",\n    \"?:\\\\Program Files\\\\Guardicore\\\\gc-enforcement-agent.exe\",\n    \"?:\\\\Program Files\\\\Guardicore\\\\gc-guest-agent.exe\",\n    \"?:\\\\Program Files\\\\Logi\\\\LogiBolt\\\\LogiBoltUpdater.exe\",\n    \"?:\\\\Program Files (x86)\\\\Schneider Electric EcoStruxure\\\\Building Operation 5.0\\\\Device Administrator\\\\Python\\\\python.exe\",\n    \"?:\\\\Program Files\\\\Splunk\\\\bin\\\\openssl.exe\",\n    \"?:\\\\Program Files\\\\SplunkUniversalForwarder\\\\bin\\\\openssl.exe\",\n    \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Logi\\\\LogiBolt\\\\LogiBoltUpdater.exe\",\n    \"?:\\\\Windows\\\\system32\\\\icacls.exe\",\n    \"?:\\\\Windows\\\\System32\\\\OpenSSH\\\\*\"\n  )",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "winlogbeat-*"
        ],
        "filters": []
      },
      {
        "name": "Service Path Modification via sc.exe",
        "description": "Identifies attempts to modify a service path setting using sc.exe. Attackers may attempt to modify existing services for persistence or privilege escalation.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 106,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Rule Type: BBR",
          "Data Source: Sysmon",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1112",
                "name": "Modify Registry",
                "reference": "https://attack.mitre.org/techniques/T1112/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1543",
                "name": "Create or Modify System Process",
                "reference": "https://attack.mitre.org/techniques/T1543/",
                "subtechnique": [
                  {
                    "id": "T1543.003",
                    "name": "Windows Service",
                    "reference": "https://attack.mitre.org/techniques/T1543/003/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1543",
                "name": "Create or Modify System Process",
                "reference": "https://attack.mitre.org/techniques/T1543/",
                "subtechnique": [
                  {
                    "id": "T1543.003",
                    "name": "Windows Service",
                    "reference": "https://attack.mitre.org/techniques/T1543/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "e55164c8-2575-42c4-a946-698ec167ca6a",
        "rule_id": "c5677997-f75b-4cda-b830-a75920514096",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:47.658Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:45.065Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where event.type == \"start\" and process.name : \"sc.exe\" and\n  process.args : \"*config*\" and process.args : \"*binPath*\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "winlogbeat-*"
        ],
        "filters": []
      },
      {
        "name": "Potential Credential Access via Renamed COM+ Services DLL",
        "description": "Identifies suspicious renamed COMSVCS.DLL Image Load, which exports the MiniDump function that can be used to dump a process memory. This may indicate an attempt to dump LSASS memory while bypassing command-line based detection in preparation for credential access.",
        "risk_score": 73,
        "severity": "high",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Potential Credential Access via Renamed COM+ Services DLL\n\nCOMSVCS.DLL is a Windows library that exports the MiniDump function, which can be used to dump a process memory. Adversaries may attempt to dump LSASS memory using a renamed COMSVCS.DLL to bypass command-line based detection and gain unauthorized access to credentials.\n\nThis rule identifies suspicious instances of rundll32.exe loading a renamed COMSVCS.DLL image, which can indicate potential abuse of the MiniDump function for credential theft.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate any abnormal behavior by the subject process, such as network connections, registry or file modifications, and any spawned child processes.\n- Identify the process that created the DLL using file creation events.\n   - Inspect the file for useful metadata, such as file size and creation or modification time.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the process executable and DLL using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process's `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n- Look for the presence of relevant artifacts on other systems. Identify commonalities and differences between potentially compromised systems.\n\n### False positive analysis\n\n- False positives may include legitimate instances of rundll32.exe loading a renamed COMSVCS.DLL image for non-malicious purposes, such as during software development, testing, or troubleshooting.\n\n### Related Rules\n\n- Potential Credential Access via LSASS Memory Dump - 9960432d-9b26-409f-972b-839a959e79e2\n- Suspicious Module Loaded by LSASS - 3a6001a0-0939-4bbe-86f4-47d8faeb7b97\n- Suspicious Lsass Process Access - 128468bf-cab1-4637-99ea-fdf3780a4609\n- LSASS Process Access via Windows API - ff4599cb-409f-4910-a239-52e4e6f532ff\n\n### Response and Remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n  - If malicious activity is confirmed, perform a broader investigation to identify the scope of the compromise and determine the appropriate remediation steps.\n- Implement Elastic Endpoint Security to detect and prevent further post exploitation activities in the environment.\n   - Contain the affected system by isolating it from the network to prevent further spread of the attack.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Restore the affected system to its operational state by applying any necessary patches, updates, or configuration changes.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 208,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Tactic: Defense Evasion",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://modexp.wordpress.com/2019/08/30/minidumpwritedump-via-com-services-dll/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1003",
                "name": "OS Credential Dumping",
                "reference": "https://attack.mitre.org/techniques/T1003/",
                "subtechnique": [
                  {
                    "id": "T1003.001",
                    "name": "LSASS Memory",
                    "reference": "https://attack.mitre.org/techniques/T1003/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1218",
                "name": "System Binary Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1218/",
                "subtechnique": [
                  {
                    "id": "T1218.011",
                    "name": "Rundll32",
                    "reference": "https://attack.mitre.org/techniques/T1218/011/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nYou will need to enable logging of ImageLoads in your Sysmon configuration to include COMSVCS.DLL by Imphash or Original\nFile Name.\n",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.code",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.pe.imphash",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "cae949ff-a4fc-4152-a57f-a1e35679f223",
        "rule_id": "c5c9f591-d111-4cf8-baec-c26a39bc31ef",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:47.661Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:45.074Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by process.entity_id with maxspan=1m\n [process where host.os.type == \"windows\" and event.category == \"process\" and\n    process.name : \"rundll32.exe\"]\n [process where host.os.type == \"windows\" and event.category == \"process\" and event.dataset : \"windows.sysmon_operational\" and event.code == \"7\" and\n   (file.pe.original_file_name : \"COMSVCS.DLL\" or file.pe.imphash : \"EADBCCBB324829ACB5F2BBE87E5549A8\") and\n    /* renamed COMSVCS */\n    not file.name : \"COMSVCS.DLL\"]",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "Unusual Network Connection via DllHost",
        "description": "Identifies unusual instances of dllhost.exe making outbound network connections. This may indicate adversarial Command and Control activity.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 207,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.microsoft.com/security/blog/2021/05/27/new-sophisticated-email-based-attack-from-nobelium/",
          "https://www.volexity.com/blog/2021/05/27/suspected-apt29-operation-launches-election-fraud-themed-phishing-campaigns/",
          "https://www.iana.org/assignments/iana-ipv4-special-registry/iana-ipv4-special-registry.xhtml"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1218",
                "name": "System Binary Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1218/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args_count",
            "type": "long",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "534b70a7-7606-46e5-b0f0-e353bf496395",
        "rule_id": "c7894234-7814-44c2-92a9-f7d851ea246a",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:47.663Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:45.102Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by host.id, process.entity_id with maxspan=1m\n  [process where host.os.type == \"windows\" and event.type == \"start\" and process.name : \"dllhost.exe\" and process.args_count == 1]\n  [network where host.os.type == \"windows\" and process.name : \"dllhost.exe\" and\n   not cidrmatch(destination.ip, \"10.0.0.0/8\", \"127.0.0.0/8\", \"169.254.0.0/16\", \"172.16.0.0/12\", \"192.0.0.0/24\",\n    \"192.0.0.0/29\", \"192.0.0.8/32\", \"192.0.0.9/32\", \"192.0.0.10/32\", \"192.0.0.170/32\", \"192.0.0.171/32\", \"192.0.2.0/24\",\n    \"192.31.196.0/24\", \"192.52.193.0/24\", \"192.168.0.0/16\", \"192.88.99.0/24\", \"224.0.0.0/4\", \"100.64.0.0/10\",\n    \"192.175.48.0/24\", \"198.18.0.0/15\", \"198.51.100.0/24\", \"203.0.113.0/24\", \"240.0.0.0/4\", \"::1\", \"FE80::/10\",\n    \"FF00::/8\")]",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-endpoint.events.network-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "Unusual File Modification by dns.exe",
        "description": "Identifies an unexpected file being modified by dns.exe, the process responsible for Windows DNS Server services, which may indicate activity related to remote code execution or other forms of exploitation.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Unusual File Write\nDetection alerts from this rule indicate potential unusual/abnormal file writes from the DNS Server service process (`dns.exe`) after exploitation from CVE-2020-1350 (SigRed) has occurred. Here are some possible avenues of investigation:\n- Post-exploitation, adversaries may write additional files or payloads to the system as additional discovery/exploitation/persistence mechanisms.\n- Any suspicious or abnormal files written from `dns.exe` should be reviewed and investigated with care.\n",
        "output_index": "",
        "version": 211,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Lateral Movement",
          "Data Source: Elastic Endgame",
          "Use Case: Vulnerability",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://research.checkpoint.com/2020/resolving-your-way-into-domain-admin-exploiting-a-17-year-old-bug-in-windows-dns-servers/",
          "https://msrc-blog.microsoft.com/2020/07/14/july-2020-security-update-cve-2020-1350-vulnerability-in-windows-domain-name-system-dns-server/",
          "https://www.elastic.co/security-labs/detection-rules-for-sigred-vulnerability"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1210",
                "name": "Exploitation of Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1210/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.Ext.header_bytes",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "084b1c04-d113-496d-9278-c5adbc648e4a",
        "rule_id": "c7ce36c0-32ff-4f9a-bfc2-dcb242bf99f9",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:47.666Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:45.111Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"windows\" and process.name : \"dns.exe\" and event.type in (\"creation\", \"deletion\", \"change\") and\n  not file.name : \"dns.log\" and not\n  (file.extension : (\"old\", \"temp\", \"bak\", \"dns\", \"arpa\") and file.path : \"C:\\\\Windows\\\\System32\\\\dns\\\\*\") and\n\n  /* DNS logs with custom names, header converts to \"DNS Server log\" */\n  not ?file.Ext.header_bytes : \"444e5320536572766572206c6f67*\"",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.file-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious Troubleshooting Pack Cabinet Execution",
        "description": "Identifies the execution of the Microsoft Diagnostic Wizard to open a diagcab file from a suspicious path and with an unusual parent process. This may indicate an attempt to execute malicious Troubleshooting Pack Cabinet files.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 104,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Rule Type: BBR",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://irsl.medium.com/the-trouble-with-microsofts-troubleshooters-6e32fc80b8bd"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1218",
                "name": "System Binary Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1218/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "4c801089-f57d-4cbc-b072-e5de0f2ffaf6",
        "rule_id": "808291d3-e918-4a3a-86cd-73052a0c9bdc",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:47.669Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:37.255Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.action == \"start\" and\n  (process.name : \"msdt.exe\" or ?process.pe.original_file_name == \"msdt.exe\") and process.args : \"/cab\" and\n  process.parent.name : (\n    \"firefox.exe\", \"chrome.exe\", \"msedge.exe\", \"explorer.exe\", \"brave.exe\", \"whale.exe\", \"browser.exe\",\n    \"dragon.exe\", \"vivaldi.exe\", \"opera.exe\", \"iexplore\", \"firefox.exe\", \"waterfox.exe\", \"iexplore.exe\",\n    \"winrar.exe\", \"winrar.exe\", \"7zFM.exe\", \"outlook.exe\", \"winword.exe\", \"excel.exe\"\n  ) and\n  process.args : (\n    \"?:\\\\Users\\\\*\",\n    \"\\\\\\\\*\",\n    \"http*\",\n    \"ftp://*\"\n  )",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "logs-system.security*",
          "winlogbeat-*",
          "logs-windows.*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "Temporarily Scheduled Task Creation",
        "description": "Indicates the creation and deletion of a scheduled task within a short time interval. Adversaries can use these to proxy malicious execution via the schedule service and perform clean up.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 108,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Tactic: Execution",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Legitimate scheduled tasks may be created during installation of new software."
        ],
        "references": [
          "https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4698"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1053",
                "name": "Scheduled Task/Job",
                "reference": "https://attack.mitre.org/techniques/T1053/",
                "subtechnique": [
                  {
                    "id": "T1053.005",
                    "name": "Scheduled Task",
                    "reference": "https://attack.mitre.org/techniques/T1053/005/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1053",
                "name": "Scheduled Task/Job",
                "reference": "https://attack.mitre.org/techniques/T1053/",
                "subtechnique": [
                  {
                    "id": "T1053.005",
                    "name": "Scheduled Task",
                    "reference": "https://attack.mitre.org/techniques/T1053/005/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.computer_name",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "winlog.event_data.TaskName",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "761a7d4c-3b22-402e-80ad-ce72bd34c5f6",
        "rule_id": "81ff45f8-f8c2-4e28-992e-5a0e8d98e0fe",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:47.671Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:37.279Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by winlog.computer_name, winlog.event_data.TaskName with maxspan=5m\n   [iam where event.action == \"scheduled-task-created\" and not user.name : \"*$\"]\n   [iam where event.action == \"scheduled-task-deleted\" and not user.name : \"*$\"]",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-system.*",
          "logs-windows.*"
        ],
        "filters": []
      },
      {
        "name": "Potential Linux Local Account Brute Force Detected",
        "description": "Identifies multiple consecutive login attempts executed by one process targeting a local linux user account within a short time interval. Adversaries might brute force login attempts across different users with a default wordlist or a set of customly crafted passwords in an attempt to gain access to these accounts.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 7,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1110",
                "name": "Brute Force",
                "reference": "https://attack.mitre.org/techniques/T1110/",
                "subtechnique": [
                  {
                    "id": "T1110.001",
                    "name": "Password Guessing",
                    "reference": "https://attack.mitre.org/techniques/T1110/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "cef7de75-d556-4a56-8608-803c0117409e",
        "rule_id": "835c0622-114e-40b5-a346-f843ea5d01f1",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:47.674Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:37.288Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by host.id, process.parent.executable, user.id with maxspan=1s\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and process.name == \"su\" and \n   not process.parent.name in (\n     \"bash\", \"dash\", \"ash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\", \"clickhouse-server\", \"ma\", \"gitlab-runner\",\n     \"updatedb.findutils\", \"cron\", \"perl\", \"sudo\", \"java\", \"cloud-app-identify\", \"ambari-sudo.sh\"\n   )\n  ] with runs=10",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Security Software Discovery via Grep",
        "description": "Identifies the use of the grep command to discover known third-party macOS and Linux security tools, such as Antivirus or Host Firewall details.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Security Software Discovery via Grep\n\nAfter successfully compromising an environment, attackers may try to gain situational awareness to plan their next steps. This can happen by running commands to enumerate network resources, users, connections, files, and installed security software.\n\nThis rule looks for the execution of the `grep` utility with arguments compatible to the enumeration of the security software installed on the host. Attackers can use this information to decide whether or not to infect a system, disable protections, use bypasses, etc.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence and whether they are located in expected locations.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate any abnormal account behavior, such as command executions, file creations or modifications, and network connections.\n- Investigate any abnormal behavior by the subject process such as network connections, file modifications, and any spawned child processes.\n- Inspect the host for suspicious or abnormal behavior in the alert timeframe.\n- Validate the activity is not related to planned patches, updates, network administrator activity, or legitimate software installations.\n\n### False positive analysis\n\n- Discovery activities are not inherently malicious if they occur in isolation. As long as the analyst did not identify suspicious activity related to the user or host, such alerts can be dismissed.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection via the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 110,
        "tags": [
          "Domain: Endpoint",
          "OS: macOS",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Endpoint Security installers, updaters and post installation verification scripts."
        ],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1518",
                "name": "Software Discovery",
                "reference": "https://attack.mitre.org/techniques/T1518/",
                "subtechnique": [
                  {
                    "id": "T1518.001",
                    "name": "Security Software Discovery",
                    "reference": "https://attack.mitre.org/techniques/T1518/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "671bfa92-a51c-4eb2-96d4-8a2cbb662cf4",
        "rule_id": "870aecc0-cea4-4110-af3f-e02e9b373655",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:47.677Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:38.575Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where event.type == \"start\" and\nprocess.name : \"grep\" and user.id != \"0\" and\n not process.parent.executable : (\"/Library/Application Support/*\", \"/opt/McAfee/agent/scripts/ma\") and\n   process.args :\n         (\"Little Snitch*\",\n          \"Avast*\",\n          \"Avira*\",\n          \"ESET*\",\n          \"BlockBlock*\",\n          \"360Sec*\",\n          \"LuLu*\",\n          \"KnockKnock*\",\n          \"kav\",\n          \"KIS\",\n          \"RTProtectionDaemon*\",\n          \"Malware*\",\n          \"VShieldScanner*\",\n          \"WebProtection*\",\n          \"webinspectord*\",\n          \"McAfee*\",\n          \"isecespd*\",\n          \"macmnsvc*\",\n          \"masvc*\",\n          \"kesl*\",\n          \"avscan*\",\n          \"guard*\",\n          \"rtvscand*\",\n          \"symcfgd*\",\n          \"scmdaemon*\",\n          \"symantec*\",\n          \"sophos*\",\n          \"osquery*\",\n          \"elastic-endpoint*\"\n          ) and\n   not (\n     (process.args : \"Avast\" and process.args : \"Passwords\") or\n     (process.args == \"osquery.conf\") or \n     (process.parent.args : \"/opt/McAfee/agent/scripts/ma\" and process.parent.args : \"checkhealth\") or\n     (process.command_line : (\n       \"grep ESET Command-line scanner, version %s -A2\",\n       \"grep -i McAfee Web Gateway Core version:\",\n       \"grep --color=auto ESET Command-line scanner, version %s -A2\"\n       )\n     ) or\n     (process.parent.command_line : (\n       \"\"\"sh -c printf \"command_start_%s\"*; perl -pe 's/[^ -~]/\\n/g' < /opt/eset/esets/sbin/esets_scan | grep 'ESET Command-line scanner, version %s' -A2 | tail -1; printf \"command_done_%s*\"\"\",\n       \"\"\"bash -c perl -pe 's/[^ -~]/\\n/g' < /opt/eset/esets/sbin/esets_scan | grep 'ESET Command-line scanner, version %s' -A2 | tail -1\"\"\"\n       )\n     )\n    )",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "auditbeat-*"
        ],
        "filters": []
      },
      {
        "name": "Linux Clipboard Activity Detected",
        "description": "This rule monitors for the usage of the most common clipboard utilities on unix systems by an uncommon process group leader. Adversaries may collect data stored in the clipboard from users copying information within or between applications.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 5,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Collection",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame",
          "Data Source: Auditd Manager"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0009",
              "name": "Collection",
              "reference": "https://attack.mitre.org/tactics/TA0009/"
            },
            "technique": [
              {
                "id": "T1115",
                "name": "Clipboard Data",
                "reference": "https://attack.mitre.org/techniques/T1115/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "auditd_manager",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "32231443-bbc2-4da1-8a55-b0413a110422",
        "rule_id": "884e87cc-c67b-4c90-a4ed-e1e24a940c82",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:47.680Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:38.603Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "event.category:process and host.os.type:\"linux\" and event.type:\"start\" and\nevent.action:(\"exec\" or \"exec_event\" or \"executed\" or \"process_started\") and\nprocess.name:(\"xclip\" or \"xsel\" or \"wl-clipboard\" or \"clipman\" or \"copyq\") and\nnot process.parent.name:(\"bwrap\" or \"micro\")",
        "new_terms_fields": [
          "host.id",
          "process.group_leader.executable"
        ],
        "history_window_start": "now-7d",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*",
          "auditbeat-*",
          "logs-auditd_manager.auditd-*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Suspicious WMI Image Load from MS Office",
        "description": "Identifies a suspicious image load (wmiutils.dll) from Microsoft Office processes. This behavior may indicate adversarial activity where child processes are spawned via Windows Management Instrumentation (WMI). This technique can be used to execute code and evade traditional parent/child processes spawned from Microsoft Office products.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 208,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://medium.com/threatpunter/detecting-adversary-tradecraft-with-image-load-event-logging-and-eql-8de93338c16"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1047",
                "name": "Windows Management Instrumentation",
                "reference": "https://attack.mitre.org/techniques/T1047/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "dll.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "64eb32e5-4e9c-4bb6-8429-a34ca7ea5445",
        "rule_id": "891cb88e-441a-4c3e-be2d-120d99fe7b0d",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:47.688Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:38.632Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "any where host.os.type == \"windows\" and\n (event.category : (\"library\", \"driver\") or (event.category == \"process\" and event.action : \"Image loaded*\")) and\n  process.name : (\"WINWORD.EXE\", \"EXCEL.EXE\", \"POWERPNT.EXE\", \"MSPUB.EXE\", \"MSACCESS.EXE\") and\n  (?dll.name : \"wmiutils.dll\" or file.name : \"wmiutils.dll\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.library-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "Potential WPAD Spoofing via DNS Record Creation",
        "description": "Identifies the creation of a DNS record that is potentially meant to enable WPAD spoofing. Attackers can disable the Global Query Block List (GQBL) and create a \"wpad\" record to exploit hosts running WPAD with default settings for privilege escalation and lateral movement.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 103,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Data Source: Active Directory",
          "Use Case: Active Directory Monitoring",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.thehacker.recipes/ad/movement/mitm-and-coerced-authentications/wpad-spoofing#through-adidns-spoofing",
          "https://cube0x0.github.io/Pocing-Beyond-DA/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1557",
                "name": "Adversary-in-the-Middle",
                "reference": "https://attack.mitre.org/techniques/T1557/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'Audit Directory Service Changes' logging policy must be configured for (Success, Failure).\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nPolicies >\nWindows Settings >\nSecurity Settings >\nAdvanced Audit Policies Configuration >\nAudit Policies >\nDS Access >\nAudit Directory Service Changes (Success,Failure)\n```\n\nThe above policy does not cover the target object by default (we still need it to be configured to generate events), so we need to set up an AuditRule using https://github.com/OTRF/Set-AuditRule.\n\n```\nSet-AuditRule -AdObjectPath 'AD:\\CN=MicrosoftDNS,DC=DomainDNSZones,DC=Domain,DC=com' -WellKnownSidType WorldSid -Rights CreateChild -InheritanceFlags Descendents -AttributeGUID e0fa1e8c-9b45-11d0-afdd-00c04fd930c9 -AuditFlags Success\n```\n",
        "related_integrations": [
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.code",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.event_data.ObjectDN",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "874c25c0-8a36-4e06-b383-6b930c02fab9",
        "rule_id": "894326d2-56c0-4342-b553-4abfaf421b5b",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:47.691Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:38.639Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "any where host.os.type == \"windows\" and event.action in (\"Directory Service Changes\", \"directory-service-object-modified\") and\n    event.code == \"5137\" and winlog.event_data.ObjectDN : \"DC=wpad,*\"",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-system.*",
          "logs-windows.*"
        ],
        "filters": []
      },
      {
        "name": "Command Prompt Network Connection",
        "description": "Identifies cmd.exe making a network connection. Adversaries could abuse cmd.exe to download or execute malware from a remote URL.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Command Prompt Network Connection\n\nAttackers commonly transfer tooling or malware from external systems into a compromised environment using a command and control channel. However, they can also abuse signed utilities to drop these files.\n\nThis rule looks for a network connection to an external address from the `cmd.exe` utility, which can indicate the abuse of the utility to download malicious files and tools.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n  - Investigate any abnormal behavior by the subject process such as network connections, registry or file modifications, and any spawned child processes.\n  - Investigate the file digital signature and process original filename, if suspicious, treat it as potential malware.\n- Investigate the target host that the signed binary is communicating with.\n  - Check if the domain is newly registered or unexpected.\n  - Check the reputation of the domain or IP address.\n- Examine if any file was downloaded and check if it is an executable or script.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the downloaded file using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n\n### False positive analysis\n\n- If this activity is expected and noisy in your environment, consider adding exceptions — preferably with a combination of destination IP address and file name conditions.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 208,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Administrators may use the command prompt for regular administrative tasks. It's important to baseline your environment for network connections being made from the command prompt to determine any abnormal use of this tool."
        ],
        "references": [
          "https://www.iana.org/assignments/iana-ipv4-special-registry/iana-ipv4-special-registry.xhtml"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            },
            "technique": [
              {
                "id": "T1105",
                "name": "Ingress Tool Transfer",
                "reference": "https://attack.mitre.org/techniques/T1105/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "dns.question.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "957b7a0d-ca3c-4d8e-951c-9acfe62e6bdf",
        "rule_id": "89f9a4b0-9f8f-4ee0-8823-c4751a6d6696",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:47.693Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:38.646Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by process.entity_id\n  [process where host.os.type == \"windows\" and process.name : \"cmd.exe\" and event.type == \"start\"]\n  [network where host.os.type == \"windows\" and process.name : \"cmd.exe\" and\n     not cidrmatch(destination.ip, \"10.0.0.0/8\", \"127.0.0.0/8\", \"169.254.0.0/16\", \"172.16.0.0/12\", \"192.0.0.0/24\",\n                                  \"192.0.0.0/29\", \"192.0.0.8/32\", \"192.0.0.9/32\", \"192.0.0.10/32\", \"192.0.0.170/32\",\n                                  \"192.0.0.171/32\", \"192.0.2.0/24\", \"192.31.196.0/24\", \"192.52.193.0/24\",\n                                  \"192.168.0.0/16\", \"192.88.99.0/24\", \"224.0.0.0/4\", \"100.64.0.0/10\", \"192.175.48.0/24\",\n                                  \"198.18.0.0/15\", \"198.51.100.0/24\", \"203.0.113.0/24\", \"240.0.0.0/4\", \"::1\",\n                                  \"FE80::/10\", \"FF00::/8\") and\n    not dns.question.name : (\n          \"wpad\", \"localhost\", \"ocsp.comodoca.com\", \"ocsp.digicert.com\", \"ocsp.sectigo.com\", \"crl.comodoca.com\"\n    )]",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-endpoint.events.network-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "GitHub PAT Access Revoked",
        "description": "Access to private GitHub organization resources was revoked for a PAT.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 204,
        "tags": [
          "Domain: Cloud",
          "Use Case: Threat Detection",
          "Use Case: UEBA",
          "Tactic: Impact",
          "Rule Type: BBR",
          "Data Source: Github"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0040",
              "name": "Impact",
              "reference": "https://attack.mitre.org/tactics/TA0040/"
            },
            "technique": [
              {
                "id": "T1531",
                "name": "Account Access Removal",
                "reference": "https://attack.mitre.org/techniques/T1531/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "github",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "269f340a-64d0-4b37-b20d-6e5c28d55786",
        "rule_id": "8a0fd93a-7df8-410d-8808-4cc5e340f2b9",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:47.696Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:38.675Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "configuration where event.dataset == \"github.audit\" and event.action == \"personal_access_token.access_revoked\"",
        "language": "eql",
        "index": [
          "logs-github.audit-*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious Execution from a Mounted Device",
        "description": "Identifies when a script interpreter or signed binary is launched via a non-standard working directory. An attacker may use this technique to evade defenses.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 208,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Tactic: Execution",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.microsoft.com/security/blog/2021/05/27/new-sophisticated-email-based-attack-from-nobelium/",
          "https://www.volexity.com/blog/2021/05/27/suspected-apt29-operation-launches-election-fraud-themed-phishing-campaigns/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1218",
                "name": "System Binary Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1218/",
                "subtechnique": [
                  {
                    "id": "T1218.005",
                    "name": "Mshta",
                    "reference": "https://attack.mitre.org/techniques/T1218/005/"
                  },
                  {
                    "id": "T1218.010",
                    "name": "Regsvr32",
                    "reference": "https://attack.mitre.org/techniques/T1218/010/"
                  },
                  {
                    "id": "T1218.011",
                    "name": "Rundll32",
                    "reference": "https://attack.mitre.org/techniques/T1218/011/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  },
                  {
                    "id": "T1059.003",
                    "name": "Windows Command Shell",
                    "reference": "https://attack.mitre.org/techniques/T1059/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.working_directory",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "31203d55-9a6b-4246-9dcc-9daf87a534e2",
        "rule_id": "8a1d4831-3ce6-4859-9891-28931fa6101d",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:47.699Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:38.701Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and process.executable : \"C:\\\\*\" and\n  (process.working_directory : \"?:\\\\\" and not process.working_directory: \"C:\\\\\") and\n  process.parent.name : \"explorer.exe\" and\n  process.name : (\"rundll32.exe\", \"mshta.exe\", \"powershell.exe\", \"pwsh.exe\", \"cmd.exe\", \"regsvr32.exe\",\n                  \"cscript.exe\", \"wscript.exe\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "Deprecated - Suspicious JAVA Child Process",
        "description": "Identifies suspicious child processes of the Java interpreter process. This may indicate an attempt to execute a malicious JAR file or an exploitation attempt via a JAVA specific vulnerability.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Suspicious Java Child Process\n\nThis rule identifies a suspicious child process of the Java interpreter process. It may indicate an attempt to execute a malicious JAR file or an exploitation attempt via a Java specific vulnerability.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence and whether they are located in expected locations.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate any abnormal account behavior, such as command executions, file creations or modifications, and network connections.\n- Investigate any abnormal behavior by the subject process such as network connections, file modifications, and any spawned child processes.\n- Examine the command line to determine if the command executed is potentially harmful or malicious.\n- Inspect the host for suspicious or abnormal behavior in the alert timeframe.\n\n### False positive analysis\n\n- If this activity is expected and noisy in your environment, consider adding exceptions — preferably with a combination of process and command line conditions.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Remove and block malicious artifacts identified during triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 209,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "OS: macOS",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Resources: Investigation Guide",
          "Use Case: Vulnerability",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.lunasec.io/docs/blog/log4j-zero-day/",
          "https://github.com/christophetd/log4shell-vulnerable-app",
          "https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE.pdf",
          "https://www.elastic.co/security-labs/detecting-log4j2-with-elastic-security",
          "https://www.elastic.co/security-labs/analysis-of-log4shell-cve-2021-45046"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.007",
                    "name": "JavaScript",
                    "reference": "https://attack.mitre.org/techniques/T1059/007/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "c5d93a45-5ad0-4682-881e-4be5911f6314",
        "rule_id": "8acb7614-1d92-4359-bfcf-478b6d9de150",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:47.701Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:38.716Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "event.category:process and event.type:(\"start\" or \"process_started\") and process.parent.name:\"java\" and process.name:(\n  bash or dash or sh or tcsh or csh or zsh or ksh or fish or python* or php* or perl or ruby or lua* or openssl or\n  nc or netcat or ncat or telnet or awk or socat or wget or curl\n) and process.args :(\n  whoami or id or uname or cat or hostname or ip or curl or wget or pwd or ls or cd or python* or php* or perl or\n  ruby or lua* or openssl or nc or netcat or ncat or telnet or awk or socat\n)",
        "new_terms_fields": [
          "host.id",
          "process.command_line"
        ],
        "history_window_start": "now-14d",
        "index": [
          "auditbeat-*",
          "logs-endpoint.events.*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "RPM Package Installed by Unusual Parent Process",
        "description": "This rule leverages the new_terms rule type to identify the installation of RPM packages by an unusual parent process. RPM is a package management system used in Linux systems such as Red Hat, CentOS and Fedora. Attacks may backdoor RPM packages to gain initial access or install malicious RPM packages to maintain persistence.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 2,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1543",
                "name": "Create or Modify System Process",
                "reference": "https://attack.mitre.org/techniques/T1543/"
              },
              {
                "id": "T1546",
                "name": "Event Triggered Execution",
                "reference": "https://attack.mitre.org/techniques/T1546/",
                "subtechnique": [
                  {
                    "id": "T1546.016",
                    "name": "Installer Packages",
                    "reference": "https://attack.mitre.org/techniques/T1546/016/"
                  }
                ]
              },
              {
                "id": "T1574",
                "name": "Hijack Execution Flow",
                "reference": "https://attack.mitre.org/techniques/T1574/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1195",
                "name": "Supply Chain Compromise",
                "reference": "https://attack.mitre.org/techniques/T1195/",
                "subtechnique": [
                  {
                    "id": "T1195.002",
                    "name": "Compromise Software Supply Chain",
                    "reference": "https://attack.mitre.org/techniques/T1195/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\nThis rule requires data coming in from Elastic Defend.\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "0b1e343a-b4c7-4d3b-8367-adc5f76eec00",
        "rule_id": "8cc72fa3-70ae-4ea1-bee2-8e6aaf3c1fcf",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:47.704Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:38.767Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "host.os.type:linux and event.category:process and event.type:start and event.action:exec and process.name:rpm and\nprocess.args:(\"-i\" or \"--install\")",
        "new_terms_fields": [
          "process.parent.executable"
        ],
        "history_window_start": "now-7d",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Potential WSUS Abuse for Lateral Movement",
        "description": "Identifies a potential Windows Server Update Services (WSUS) abuse to execute psexec to enable for lateral movement. WSUS is limited to executing Microsoft signed binaries, which limits the executables that can be used to tools published by Microsoft.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 205,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Lateral Movement",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: System",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.thehacker.recipes/a-d/movement/mitm-and-coerced-authentications/wsus-spoofing"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1210",
                "name": "Exploitation of Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1210/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "eb502c81-8014-4a42-9baf-8c95a7dd0a0c",
        "rule_id": "8e2485b6-a74f-411b-bf7f-38b819f3a846",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:47.707Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:38.812Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and process.parent.name : \"wuauclt.exe\" and\nprocess.executable : (\n    \"?:\\\\Windows\\\\SoftwareDistribution\\\\Download\\\\Install\\\\*\",\n    \"\\\\Device\\\\HarddiskVolume?\\\\Windows\\\\SoftwareDistribution\\\\Download\\\\Install\\\\*\"\n) and\n(process.name : \"psexec64.exe\" or ?process.pe.original_file_name : \"psexec.c\")",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-m365_defender.event-*",
          "logs-system.security-*",
          "winlogbeat-*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Bitsadmin Activity",
        "description": "Windows Background Intelligent Transfer Service (BITS) is a low-bandwidth, asynchronous file transfer mechanism. Adversaries may abuse BITS to persist, download, execute, and even clean up after running malicious code.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 105,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Command and Control",
          "Data Source: Elastic Defend",
          "Rule Type: BBR",
          "Data Source: Sysmon",
          "Data Source: Elastic Endgame",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            },
            "technique": [
              {
                "id": "T1105",
                "name": "Ingress Tool Transfer",
                "reference": "https://attack.mitre.org/techniques/T1105/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1197",
                "name": "BITS Jobs",
                "reference": "https://attack.mitre.org/techniques/T1197/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1197",
                "name": "BITS Jobs",
                "reference": "https://attack.mitre.org/techniques/T1197/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "424cb28b-bfad-4950-81b3-f9db35aff2a1",
        "rule_id": "8eec4df1-4b4b-4502-b6c3-c788714604c9",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:47.709Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:38.826Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (\n   (process.name : \"bitsadmin.exe\" and process.args : (\n        \"*Transfer*\", \"*Create*\", \"AddFile\", \"*SetNotifyFlags*\", \"*SetNotifyCmdLine*\",\n        \"*SetMinRetryDelay*\", \"*SetCustomHeaders*\", \"*Resume*\")\n   ) or\n   (process.name : \"powershell.exe\" and process.args : (\n        \"*Start-BitsTransfer*\", \"*Add-BitsFile*\",\n        \"*Resume-BitsTransfer*\", \"*Set-BitsTransfer*\", \"*BITS.Manager*\")\n   )\n  )",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "winlogbeat-*"
        ],
        "filters": []
      },
      {
        "name": "Potential ADIDNS Poisoning via Wildcard Record Creation",
        "description": "Active Directory Integrated DNS (ADIDNS) is one of the core components of AD DS, leveraging AD's access control and replication to maintain domain consistency. It stores DNS zones as AD objects, a feature that, while robust, introduces some security issues, such as wildcard records, mainly because of the default permission (Any authenticated users) to create DNS-named records. Attackers can create wildcard records to redirect traffic that doesn't explicitly match records contained in the zone, becoming the Man-in-the-Middle and being able to abuse DNS similarly to LLMNR/NBNS spoofing.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 103,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Data Source: Active Directory",
          "Use Case: Active Directory Monitoring",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.netspi.com/blog/technical/network-penetration-testing/exploiting-adidns/",
          "https://www.thehacker.recipes/a-d/movement/mitm-and-coerced-authentications/adidns-spoofing"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1557",
                "name": "Adversary-in-the-Middle",
                "reference": "https://attack.mitre.org/techniques/T1557/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'Audit Directory Service Changes' logging policy must be configured for (Success, Failure).\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nPolicies >\nWindows Settings >\nSecurity Settings >\nAdvanced Audit Policies Configuration >\nAudit Policies >\nDS Access >\nAudit Directory Service Changes (Success,Failure)\n```\n\nThe above policy does not cover the target object by default (we still need it to be configured to generate events), so we need to set up an AuditRule using https://github.com/OTRF/Set-AuditRule.\n\n```\nSet-AuditRule -AdObjectPath 'AD:\\CN=MicrosoftDNS,DC=DomainDNSZones,DC=Domain,DC=com' -WellKnownSidType WorldSid -Rights CreateChild -InheritanceFlags Descendents -AttributeGUID e0fa1e8c-9b45-11d0-afdd-00c04fd930c9 -AuditFlags Success\n```\n",
        "related_integrations": [
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.code",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.event_data.ObjectDN",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "ef505b44-caee-4c9c-b969-d75482ecd8bc",
        "rule_id": "8f242ffb-b191-4803-90ec-0f19942e17fd",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:47.712Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:38.833Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "any where host.os.type == \"windows\" and event.action in (\"Directory Service Changes\", \"directory-service-object-modified\") and\n    event.code == \"5137\" and startsWith(winlog.event_data.ObjectDN, \"DC=*,\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-system.*",
          "logs-windows.*"
        ],
        "filters": []
      },
      {
        "name": "Incoming DCOM Lateral Movement with ShellBrowserWindow or ShellWindows",
        "description": "Identifies use of Distributed Component Object Model (DCOM) to run commands from a remote host, which are launched via the ShellBrowserWindow or ShellWindows Application COM Object. This behavior may indicate an attacker abusing a DCOM application to stealthily move laterally.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 207,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Lateral Movement",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://enigma0x3.net/2017/01/23/lateral-movement-via-dcom-round-2/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1021",
                "name": "Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1021/",
                "subtechnique": [
                  {
                    "id": "T1021.003",
                    "name": "Distributed Component Object Model",
                    "reference": "https://attack.mitre.org/techniques/T1021/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.port",
            "type": "long",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "network.direction",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "network.transport",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "source.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "source.port",
            "type": "long",
            "ecs": true
          }
        ],
        "id": "1cbd27eb-5078-467d-805a-f23748bc626c",
        "rule_id": "8f919d4b-a5af-47ca-a594-6be59cd924a4",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:47.715Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:38.840Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by host.id with maxspan=5s\n [network where host.os.type == \"windows\" and event.type == \"start\" and process.name : \"explorer.exe\" and\n  network.direction : (\"incoming\", \"ingress\") and network.transport == \"tcp\" and\n  source.port > 49151 and destination.port > 49151 and source.ip != \"127.0.0.1\" and source.ip != \"::1\"\n ] by process.entity_id\n [process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.parent.name : \"explorer.exe\"\n ] by process.parent.entity_id",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-endpoint.events.network-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "InstallUtil Activity",
        "description": "InstallUtil is a command-line utility that allows for installation and uninstallation of resources by executing specific installer components specified in .NET binaries. Adversaries may use InstallUtil to proxy the execution of code through a trusted Windows utility.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 104,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend",
          "Rule Type: BBR",
          "Data Source: Elastic Endgame",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1218",
                "name": "System Binary Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1218/",
                "subtechnique": [
                  {
                    "id": "T1218.004",
                    "name": "InstallUtil",
                    "reference": "https://attack.mitre.org/techniques/T1218/004/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "9dcf0d9c-cf0e-409e-b1c2-218597904278",
        "rule_id": "90babaa8-5216-4568-992d-d4a01a105d98",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:47.717Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:38.882Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.name : \"installutil.exe\" and not user.id : \"S-1-5-18\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "logs-system.security*",
          "winlogbeat-*",
          "logs-windows.*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "GitHub UEBA - Multiple Alerts from a GitHub Account",
        "description": "This rule is part of the \"GitHub UEBA - Unusual Activity from Account Pack\", and leverages alert data to determine when multiple alerts are executed by the same user in a timespan of one hour. Analysts can use this to prioritize triage and response, as these alerts are a higher indicator of compromised user accounts or PATs.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 101,
        "tags": [
          "Domain: Cloud",
          "Use Case: Threat Detection",
          "Use Case: UEBA",
          "Tactic: Execution",
          "Rule Type: Higher-Order Rule",
          "Data Source: Github"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-3600s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            }
          }
        ],
        "setup": "",
        "related_integrations": [],
        "required_fields": [
          {
            "name": "kibana.alert.workflow_status",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "signal.rule.tags",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "edd9ba41-bcf7-425c-9135-be6454579e5f",
        "rule_id": "929223b4-fba3-4a1c-a943-ec4716ad23ec",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:47.720Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:38.924Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "threshold",
        "query": "signal.rule.tags:(\"Use Case: UEBA\" and \"Data Source: Github\") and kibana.alert.workflow_status:\"open\"",
        "threshold": {
          "field": [
            "user.name"
          ],
          "value": 1,
          "cardinality": [
            {
              "field": "signal.rule.name",
              "value": 5
            }
          ]
        },
        "index": [
          ".alerts-security.*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "A scheduled task was created",
        "description": "Indicates the creation of a scheduled task using Windows event logs. Adversaries can use these to establish persistence, move laterally, and/or escalate privileges.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 109,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Legitimate scheduled tasks may be created during installation of new software."
        ],
        "references": [
          "https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4698"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1053",
                "name": "Scheduled Task/Job",
                "reference": "https://attack.mitre.org/techniques/T1053/",
                "subtechnique": [
                  {
                    "id": "T1053.005",
                    "name": "Scheduled Task",
                    "reference": "https://attack.mitre.org/techniques/T1053/005/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.event_data.TaskName",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "515bee04-cd31-4bef-8c6b-6c29188f1aa4",
        "rule_id": "92a6faf5-78ec-4e25-bea1-73bacc9b59d9",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:47.723Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:40.578Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "iam where event.action == \"scheduled-task-created\" and\n\n /* excluding tasks created by the computer account */\n not user.name : \"*$\" and\n\n /* TaskContent is not parsed, exclude by full taskname noisy ones */\n not winlog.event_data.TaskName : (\n              \"\\\\CreateExplorerShellUnelevatedTask\",\n              \"\\\\Hewlett-Packard\\\\HPDeviceCheck\",\n              \"\\\\Hewlett-Packard\\\\HP Support Assistant\\\\WarrantyChecker\",\n              \"\\\\Hewlett-Packard\\\\HP Support Assistant\\\\WarrantyChecker_backup\",\n              \"\\\\Hewlett-Packard\\\\HP Web Products Detection\",\n              \"\\\\Microsoft\\\\VisualStudio\\\\Updates\\\\BackgroundDownload\",\n              \"\\\\OneDrive Standalone Update Task-S-1-5-21*\",\n              \"\\\\OneDrive Standalone Update Task-S-1-12-1-*\"\n )",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-system.*",
          "logs-windows.*"
        ],
        "filters": []
      },
      {
        "name": "Potential Evasion via Windows Filtering Platform",
        "description": "Identifies multiple Windows Filtering Platform block events and where the process name is related to an endpoint security software. Adversaries may add malicious WFP rules to prevent Endpoint security from sending telemetry.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 104,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/dsnezhkov/shutter/tree/main",
          "https://github.com/netero1010/EDRSilencer/tree/main",
          "https://www.mdsec.co.uk/2023/09/nighthawk-0-2-6-three-wise-monkeys/",
          "https://learn.microsoft.com/en-us/windows/security/threat-protection/auditing/event-5157",
          "https://learn.microsoft.com/en-us/windows/security/threat-protection/auditing/event-5152"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.004",
                    "name": "Disable or Modify System Firewall",
                    "reference": "https://attack.mitre.org/techniques/T1562/004/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'Filtering Platform Connection' logging policy must be configured for (Success, Failure).\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nPolicies >\nWindows Settings >\nSecurity Settings >\nAdvanced Audit Policies Configuration >\nAudit Policies >\nObject Access >\nFiltering Platform Connection (Success,Failure)\n```\n",
        "related_integrations": [
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.computer_name",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "d12aed71-4fc5-44f9-b02b-ef7c4f911617",
        "rule_id": "92d3a04e-6487-4b62-892d-70e640a590dc",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:47.725Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:40.593Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by winlog.computer_name with maxspan=1m\n [network where host.os.type == \"windows\" and \n  event.action : (\"windows-firewall-packet-block\", \"windows-firewall-packet-drop\") and \n  process.name : (\n        \"bdagent.exe\", \"bdreinit.exe\", \"pdscan.exe\", \"pdiface.exe\", \"BDSubWiz.exe\", \"ProductAgentService.exe\",\n        \"ProductAgentUI.exe\", \"WatchDog.exe\", \"CarbonBlackClientSetup.exe\", \"TrGUI.exe\", \"TracCAPI.exe\", \"cpmsi_tool.exe\",\n        \"trac.exe\", \"vna_install64.exe\", \"vna_utils.exe\", \"TracSrvWrapper.exe\", \"vsmon.exe\", \"p95tray.exe\",\n        \"CybereasonRansomFreeServiceHost.exe\", \"CrAmTray.exe\", \"minionhost.exe\", \"CybereasonSensor.exe\", \"CylanceUI.exe\",\n        \"CylanceProtectSetup.exe\", \"cylancesvc.exe\", \"cyupdate.exe\", \"elastic-agent.exe\", \"elastic-endpoint.exe\",\n        \"egui.exe\", \"minodlogin.exe\", \"emu-rep.exe\", \"emu_install.exe\", \"emu-cci.exe\", \"emu-gui.exe\", \"emu-uninstall.exe\",\n        \"ndep.exe\", \"spike.exe\", \"ecls.exe\", \"ecmd.exe\", \"ecomserver.exe\", \"eeclnt.exe\", \"eh64.exe\", \"EHttpSrv.exe\",\n        \"xagt.exe\", \"collectoragent.exe\", \"FSAEConfig.exe\", \"uninstalldcagent.exe\", \"rmon.exe\", \"fccomint.exe\",\n        \"fclanguageselector.exe\", \"fortifw.exe\", \"fcreg.exe\", \"fortitray.exe\", \"fcappdb.exe\", \"fcwizard.exe\", \"submitv.exe\",\n        \"av_task.exe\", \"fortiwf.exe\", \"fortiwadbd.exe\", \"fcauth.exe\", \"fcdblog.exe\", \"fcmgr.exe\", \"fortiwad.exe\",\n        \"fortiproxy.exe\", \"fortiscand.exe\", \"fortivpnst.exe\", \"ipsec.exe\", \"fcwscd7.exe\", \"fcasc.exe\", \"fchelper.exe\",\n        \"forticlient.exe\",\"fcwsc.exe\", \"FortiClient.exe\", \"fmon.exe\", \"FSSOMA.exe\", \"FCVbltScan.exe\", \"FortiESNAC.exe\",\n        \"EPCUserAvatar.exe\", \"FortiAvatar.exe\", \"FortiClient_Diagnostic_Tool.exe\", \"FortiSSLVPNdaemon.exe\", \"avp.exe\",\n        \"FCConfig.exe\", \"avpsus.exe\", \"klnagent.exe\", \"klnsacwsrv.exe\", \"kl_platf.exe\", \"stpass.exe\", \"klnagwds.exe\",\n        \"mbae.exe\", \"mbae64.exe\", \"mbae-svc.exe\", \"mbae-uninstaller.exe\", \"mbaeLoader32.exe\", \"mbaeloader64.exe\",\n        \"mbam-dor.exe\", \"mbamgui.exe\", \"mbamservice.exe\", \"mbamtrayctrl.exe\", \"mbampt.exe\", \"mbamscheduler.exe\",\n        \"Coreinst.exe\", \"mbae-setup.exe\", \"mcupdate.exe\", \"ProtectedModuleHost.exe\", \"ESConfigTool.exe\", \"FWInstCheck.exe\",\n        \"FwWindowsFirewallHandler.exe\", \"mfeesp.exe\", \"mfefw.exe\", \"mfeProvisionModeUtility.exe\", \"mfetp.exe\", \"avpui.exe\", \n        \"WscAVExe.exe\", \"mcshield.exe\", \"McChHost.exe\", \"mfewc.exe\", \"mfewch.exe\", \"mfewcui.exe\", \"fwinfo.exe\",\n        \"mfecanary.exe\", \"mfefire.exe\", \"mfehidin.exe\", \"mfemms.exe\", \"mfevtps.exe\", \"mmsinfo.exe\", \"vtpinfo.exe\",\n        \"MarSetup.exe\", \"mctray.exe\", \"masvc.exe\", \"macmnsvc.exe\", \"McAPExe.exe\", \"McPvTray.exe\", \"mcods.exe\",\n        \"mcuicnt.exe\", \"mcuihost.exe\", \"xtray.exe\", \"McpService.exe\", \"epefprtrainer.exe\", \"mfeffcoreservice.exe\",\n        \"MfeEpeSvc.exe\", \"qualysagent.exe\", \"QualysProxy.exe\", \"QualysAgentUI.exe\", \"SVRTgui.exe\", \"SVRTcli.exe\",\n        \"SVRTcli.exe\", \"SVRTgui.exe\", \"SCTCleanupService.exe\", \"SVRTservice.exe\", \"native.exe\", \"SCTBootTasks.exe\",\n        \"ALMon.exe\", \"SAA.exe\", \"SUMService.exe\", \"ssp.exe\", \"SCFService.exe\", \"SCFManager.exe\", \"spa.exe\", \"cabarc.exe\",\n        \"sargui.exe\", \"sntpservice.exe\", \"McsClient.exe\", \"McsAgent.exe\", \"McsHeartbeat.exe\", \"SAVAdminService.exe\",\n        \"sav32cli.exe\", \"ForceUpdateAlongSideSGN.exe\", \"SAVCleanupService.exe\", \"SavMain.exe\", \"SavProgress.exe\", \n        \"SavProxy.exe\", \"SavService.exe\", \"swc_service.exe\", \"swi_di.exe\", \"swi_service.exe\", \"swi_filter.exe\",\n        \"ALUpdate.exe\", \"SophosUpdate.exe\", \"ALsvc.exe\", \"SophosAlert.exe\", \"osCheck.exe\", \"N360Downloader.exe\",\n        \"InstWrap.exe\", \"symbos.exe\", \"nss.exe\", \"symcorpui.exe\", \"isPwdSvc.exe\", \"ccsvchst.exe\", \"ntrmv.exe\",\n        \"pccntmon.exe\", \"AosUImanager.exe\", \"NTRTScan.exe\", \"TMAS_OL.exe\", \"TMAS_OLImp.exe\", \"TMAS_OLSentry.exe\",\n        \"ufnavi.exe\", \"Clnrbin.exe\", \"vizorhtmldialog.exe\", \"pwmConsole.exe\", \"PwmSvc.exe\", \"coreServiceShell.exe\",\n        \"ds_agent.exe\", \"SfCtlCom.exe\", \"MBAMHelper.exe\", \"cb.exe\", \"smc.exe\", \"tda.exe\", \"xagtnotif.exe\", \"ekrn.exe\",\n        \"dsa.exe\", \"Notifier.exe\", \"rphcp.exe\", \"lc_sensor.exe\", \"CSFalconService.exe\", \"CSFalconController.exe\",\n        \"SenseSampleUploader.exe\", \"windefend.exe\", \"MSASCui.exe\", \"MSASCuiL.exe\", \"msmpeng.exe\", \"msmpsvc.exe\",\n        \"MsSense.exe\", \"esensor.exe\", \"sentinelone.exe\", \"tmccsf.exe\", \"csfalconcontainer.exe\", \"sensecncproxy.exe\",\n        \"splunk.exe\", \"sysmon.exe\", \"sysmon64.exe\", \"taniumclient.exe\"\n    )] with runs=5",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-windows.network-*",
          "logs-system.security*"
        ],
        "filters": []
      },
      {
        "name": "AWS STS Role Assumption by Service",
        "description": "Identifies when a service has assumed a role in AWS Security Token Service (STS). Services can assume a role to obtain temporary credentials and access AWS resources. Adversaries can use this technique for credential access and privilege escalation. This is a [New Terms](https://www.elastic.co/guide/en/security/current/rules-ui-create.html#create-new-terms-rule) rule that identifies when a service assumes a role in AWS Security Token Service (STS) to obtain temporary credentials and access AWS resources. While often legitimate, adversaries may use this technique for unauthorized access, privilege escalation, or lateral movement within an AWS environment.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and Analysis\n\n### Investigating AWS STS Role Assumption by Service\n\nThis rule identifies instances where AWS STS (Security Token Service) is used to assume a role, granting temporary credentials for AWS resource access. While this action is often legitimate, it can be exploited by adversaries to obtain unauthorized access, escalate privileges, or move laterally within an AWS environment.\n\n#### Possible Investigation Steps\n\n- **Identify the Actor and Assumed Role**:\n  - **User Identity**: Review the `aws.cloudtrail.user_identity.arn` and `aws.cloudtrail.user_identity.type` fields to determine who initiated the `AssumeRole` action.\n  - **Role Assumed**: Check the `aws.cloudtrail.flattened.request_parameters.roleArn` field to confirm the assumed role and ensure it aligns with expected responsibilities.\n  - **Session Name**: Observe the `aws.cloudtrail.flattened.request_parameters.roleSessionName` for context on the session's intended purpose, if available.\n\n- **Analyze the Role Session and Duration**:\n  - **Session Context**: Look at the `aws.cloudtrail.user_identity.session_context.creation_date` to understand when the session began and check if multi-factor authentication (MFA) was used, indicated by the `aws.cloudtrail.user_identity.session_context.mfa_authenticated` field.\n  - **Credential Validity**: Examine the `aws.cloudtrail.flattened.request_parameters.durationSeconds` for the credential's validity period.\n  - **Expiration Time**: Verify `aws.cloudtrail.flattened.response_elements.credentials.expiration` to determine when the credentials expire or expired.\n\n- **Inspect the User Agent for Tooling Identification**:\n  - **User Agent Details**: Review the `user_agent.original` field to identify the tool or SDK used for the role assumption. Indicators include:\n    - **AWS SDKs (e.g., Boto3)**: Often used in automated workflows or scripts.\n    - **AWS CLI**: Suggests command-line access, potentially indicating direct user interaction.\n    - **Custom Tooling**: Unusual user agents may signify custom or suspicious tools.\n  - **Source IP and Location**: Evaluate the `source.address` and `source.geo` fields to confirm if the access source aligns with typical access locations for your environment.\n\n- **Contextualize with Related Events**:\n  - **Review Event Patterns**: Check surrounding CloudTrail events to see if other actions coincide with this `AssumeRole` activity, such as attempts to access sensitive resources.\n  - **Identify High-Volume Exceptions**: Due to the potential volume of `AssumeRole` events, determine common, legitimate `roleArn` values or `user_agent` patterns, and consider adding these as exceptions to reduce noise.\n\n- **Evaluate the Privilege Level of the Assumed Role**:\n  - **Permissions**: Inspect permissions associated with the assumed role to understand its access level.\n  - **Authorized Usage**: Confirm whether the role is typically used for administrative purposes and if the assuming entity frequently accesses it as part of regular responsibilities.\n\n### False Positive Analysis\n\n- **Automated Workflows and Applications**: Many applications or scheduled tasks may assume roles for standard operations. Check user agents and ARNs for consistency with known workflows.\n- **Routine IAM Policy Actions**: Historical data may reveal if the same user or application assumes this specific role regularly as part of authorized operations.\n\n### Response and Remediation\n\n- **Revoke Unauthorized Sessions**: If unauthorized, consider revoking the session by adjusting IAM policies or permissions associated with the assumed role.\n- **Enhance Monitoring and Alerts**: Set up enhanced monitoring for high-risk roles, especially those with elevated privileges.\n- **Manage Exceptions**: Regularly review and manage high-frequency roles and user agent patterns, adding trusted ARNs and user agents to exception lists to minimize alert fatigue.\n- **Incident Response**: If malicious behavior is identified, follow incident response protocols, including containment, investigation, and remediation.\n\n### Additional Information\n\nFor more information on managing and securing AWS STS, refer to the [AWS STS documentation](https://docs.aws.amazon.com/STS/latest/APIReference/API_AssumeRole.html) and AWS security best practices.\n",
        "output_index": "",
        "investigation_fields": {
          "field_names": [
            "@timestamp",
            "aws.cloudtrail.user_identity.type",
            "aws.cloudtrail.resources.arn",
            "aws.cloudtrail.resources.type",
            "source.address",
            "aws.cloudtrail.user_identity.invoked_by",
            "aws.cloudtrail.flattened.request_parameters.roleArn",
            "aws.cloudtrail.flattened.request_parameters.roleSessionName",
            "event.action",
            "event.outcome",
            "cloud.region",
            "aws.cloudtrail.request_parameters",
            "aws.cloudtrail.response_elements"
          ]
        },
        "version": 209,
        "tags": [
          "Domain: Cloud",
          "Data Source: AWS",
          "Data Source: Amazon Web Services",
          "Data Source: AWS STS",
          "Resources: Investigation Guide",
          "Use Case: Identity and Access Audit",
          "Tactic: Privilege Escalation"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic",
          "Austin Songer"
        ],
        "false_positives": [
          "AWS administrators or automated processes might regularly assume roles for legitimate administrative purposes.",
          "AWS services might assume roles to access AWS resources as part of their standard operations.",
          "Automated workflows might assume roles to perform periodic tasks such as data backups, updates, or deployments."
        ],
        "references": [
          "https://docs.aws.amazon.com/STS/latest/APIReference/API_AssumeRole.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1548",
                "name": "Abuse Elevation Control Mechanism",
                "reference": "https://attack.mitre.org/techniques/T1548/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1550",
                "name": "Use Alternate Authentication Material",
                "reference": "https://attack.mitre.org/techniques/T1550/",
                "subtechnique": [
                  {
                    "id": "T1550.001",
                    "name": "Application Access Token",
                    "reference": "https://attack.mitre.org/techniques/T1550/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "aws",
            "version": "^2.0.0",
            "integration": "cloudtrail"
          }
        ],
        "required_fields": [
          {
            "name": "aws.cloudtrail.user_identity.invoked_by",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "aws.cloudtrail.user_identity.type",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "4eaa44dd-cb4a-4428-9d17-76f16d754937",
        "rule_id": "93075852-b0f5-4b8b-89c3-a226efae5726",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:47.728Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:40.597Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "event.dataset: \"aws.cloudtrail\"\n    and event.provider: \"sts.amazonaws.com\"\n    and event.action: \"AssumeRole\"\n    and event.outcome: \"success\"\n    and aws.cloudtrail.user_identity.type: \"AWSService\"\n    and not aws.cloudtrail.user_identity.invoked_by: (\n              \"config.amazonaws.com\" or\n              \"securityhub.amazonaws.com\" or\n              \"sso.amazonaws.com\"\n            )",
        "new_terms_fields": [
          "aws.cloudtrail.resources.arn",
          "aws.cloudtrail.user_identity.invoked_by"
        ],
        "history_window_start": "now-14d",
        "index": [
          "filebeat-*",
          "logs-aws.cloudtrail-*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "File made Immutable by Chattr",
        "description": "Detects a file being made immutable using the chattr binary. Making a file immutable means it cannot be deleted or renamed, no link can be created to this file, most of the file's metadata can not be modified, and the file can not be opened in write mode. Threat actors will commonly utilize this to prevent tampering or modification of their malicious files or any system files they have modified for purposes of persistence (e.g .ssh, /etc/passwd, etc.).",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 112,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 33,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1222",
                "name": "File and Directory Permissions Modification",
                "reference": "https://attack.mitre.org/techniques/T1222/",
                "subtechnique": [
                  {
                    "id": "T1222.002",
                    "name": "Linux and Mac File and Directory Permissions Modification",
                    "reference": "https://attack.mitre.org/techniques/T1222/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from one of the following integrations:\n- Elastic Defend\n- Auditbeat\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n### Auditbeat Setup\nAuditbeat is a lightweight shipper that you can install on your servers to audit the activities of users and processes on your systems. For example, you can use Auditbeat to collect and centralize audit events from the Linux Audit Framework. You can also use Auditbeat to detect changes to critical files, like binaries and configuration files, and identify potential security policy violations.\n\n#### The following steps should be executed in order to add the Auditbeat on a Linux System:\n- Elastic provides repositories available for APT and YUM-based distributions. Note that we provide binary packages, but no source packages.\n- To install the APT and YUM repositories follow the setup instructions in this [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/setup-repositories.html).\n- To run Auditbeat on Docker follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/running-on-docker.html).\n- To run Auditbeat on Kubernetes follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/running-on-kubernetes.html).\n- For complete “Setup and Run Auditbeat” information refer to the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/setting-up-and-running.html).\n\n#### Custom Ingest Pipeline\nFor versions <8.2, you need to add a custom ingest pipeline to populate `event.ingested` with @timestamp for non-elastic-agent indexes, like auditbeats/filebeat/winlogbeat etc. For more details to add a custom ingest pipeline refer to the [guide](https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "5ef20972-c91e-46c5-bb67-23ad2c808b81",
        "rule_id": "968ccab9-da51-4a87-9ce2-d3c9782fd759",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:47.731Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:40.658Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and process.parent.executable != null and\nprocess.executable : \"/usr/bin/chattr\" and process.args : (\"-*i*\", \"+*i*\") and not (\n  process.parent.executable: (\"/lib/systemd/systemd\", \"/usr/local/uems_agent/bin/*\", \"/usr/lib/systemd/systemd\") or\n  process.parent.name in (\n    \"systemd\", \"cf-agent\", \"ntpdate\", \"xargs\", \"px\", \"preinst\", \"auth\", \"cf-agent\", \"dcservice\", \"dcagentupgrader\",\n    \"sudo\", \"ephemeral-disk-warning\"\n  )\n)",
        "language": "eql",
        "index": [
          "auditbeat-*",
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "SeDebugPrivilege Enabled by a Suspicious Process",
        "description": "Identifies the creation of a process running as SYSTEM and impersonating a Windows core binary privileges. Adversaries may create a new process with a different token to escalate privileges and bypass access controls.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 108,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://learn.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4703",
          "https://blog.palantir.com/windows-privilege-abuse-auditing-detection-and-defense-3078a403d74e"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1134",
                "name": "Access Token Manipulation",
                "reference": "https://attack.mitre.org/techniques/T1134/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nWindows Event 4703 logs Token Privileges changes and need to be configured (Enable).\n\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nPolicies >\nWindows Settings >\nSecurity Settings >\nAdvanced Audit Policies Configuration >\nAudit Policies >\nDetailed Tracking >\nToken Right Adjusted Events (Success)\n```\n",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.event_data.EnabledPrivilegeList",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "winlog.event_data.ProcessName",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "winlog.event_data.SubjectUserSid",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "9ea53bea-ffc1-48fa-a8ed-d58b24a4b4d1",
        "rule_id": "97020e61-e591-4191-8a3b-2861a2b887cd",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:47.733Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:40.682Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "any where host.os.type == \"windows\" and event.provider: \"Microsoft-Windows-Security-Auditing\" and\n event.action : \"Token Right Adjusted Events\" and\n\n winlog.event_data.EnabledPrivilegeList : \"SeDebugPrivilege\" and\n\n /* exclude processes with System Integrity  */\n not winlog.event_data.SubjectUserSid : (\"S-1-5-18\", \"S-1-5-19\", \"S-1-5-20\") and\n\n not winlog.event_data.ProcessName :\n         (\"?:\\\\Windows\\\\System32\\\\msiexec.exe\",\n          \"?:\\\\Windows\\\\SysWOW64\\\\msiexec.exe\",\n          \"?:\\\\Windows\\\\System32\\\\lsass.exe\",\n          \"?:\\\\Windows\\\\WinSxS\\\\*\",\n          \"?:\\\\Program Files\\\\*\",\n          \"?:\\\\Program Files (x86)\\\\*\",\n          \"?:\\\\Windows\\\\System32\\\\MRT.exe\",\n          \"?:\\\\Windows\\\\System32\\\\cleanmgr.exe\",\n          \"?:\\\\Windows\\\\System32\\\\taskhostw.exe\",\n          \"?:\\\\Windows\\\\System32\\\\mmc.exe\",\n          \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\*-*\\\\DismHost.exe\",\n          \"?:\\\\Windows\\\\System32\\\\auditpol.exe\",\n          \"?:\\\\Windows\\\\System32\\\\wbem\\\\WmiPrvSe.exe\",\n          \"?:\\\\Windows\\\\SysWOW64\\\\wbem\\\\WmiPrvSe.exe\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-windows.*",
          "logs-system.security*"
        ],
        "filters": []
      },
      {
        "name": "Network Connection via Registration Utility",
        "description": "Identifies the native Windows tools regsvr32.exe, regsvr64.exe, RegSvcs.exe, or RegAsm.exe making a network connection. This may be indicative of an attacker bypassing allowlists or running arbitrary scripts via a signed Microsoft binary.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Network Connection via Registration Utility\n\nBy examining the specific traits of Windows binaries -- such as process trees, command lines, network connections, registry modifications, and so on -- it's possible to establish a baseline of normal activity. Deviations from this baseline can indicate malicious activity such as masquerading, and deserve further investigation.\n\nThis rule looks for the execution of `regsvr32.exe`, `RegAsm.exe`, or `RegSvcs.exe` utilities followed by a network connection to an external address. Attackers can abuse utilities to execute malicious files or masquerade as those utilities in order to bypass detections and evade defenses.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n  - Investigate any abnormal behavior by the subject process such as network connections, registry or file modifications, and any spawned child processes.\n  - Investigate the file digital signature and process original filename, if suspicious, treat it as potential malware.\n- Investigate the target host that the signed binary is communicating with.\n  - Check if the domain is newly registered or unexpected.\n  - Check the reputation of the domain or IP address.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the process executable using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n\n### False positive analysis\n\n- If this activity is expected and noisy in your environment, consider adding exceptions — preferably with a combination of destination IP address and command line conditions.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 208,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Tactic: Defense Evasion",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Security testing may produce events like this. Activity of this kind performed by non-engineers and ordinary users is unusual."
        ],
        "references": [
          "https://www.iana.org/assignments/iana-ipv4-special-registry/iana-ipv4-special-registry.xhtml"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            }
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1218",
                "name": "System Binary Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1218/",
                "subtechnique": [
                  {
                    "id": "T1218.009",
                    "name": "Regsvcs/Regasm",
                    "reference": "https://attack.mitre.org/techniques/T1218/009/"
                  },
                  {
                    "id": "T1218.010",
                    "name": "Regsvr32",
                    "reference": "https://attack.mitre.org/techniques/T1218/010/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "network.protocol",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.Ext.token.integrity_level_name",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.event_data.IntegrityLevel",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "efac9e95-21ca-4e35-a75b-4f22e81410c4",
        "rule_id": "fb02b8d3-71ee-4af1-bacd-215d23f17efa",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:47.736Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:51.997Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by process.entity_id\n  [process where host.os.type == \"windows\" and event.type == \"start\" and\n   process.name : (\"regsvr32.exe\", \"RegAsm.exe\", \"RegSvcs.exe\") and\n   not (\n         (?process.Ext.token.integrity_level_name : \"System\" or ?winlog.event_data.IntegrityLevel : \"System\") and\n         (process.parent.name : \"msiexec.exe\" or process.parent.executable : (\"C:\\\\Program Files (x86)\\\\*.exe\", \"C:\\\\Program Files\\\\*.exe\"))\n       )\n   ]\n  [network where host.os.type == \"windows\" and process.name : (\"regsvr32.exe\", \"RegAsm.exe\", \"RegSvcs.exe\")  and\n   not cidrmatch(destination.ip, \"10.0.0.0/8\", \"127.0.0.0/8\", \"169.254.0.0/16\", \"172.16.0.0/12\", \"192.0.0.0/24\",\n       \"192.0.0.0/29\", \"192.0.0.8/32\", \"192.0.0.9/32\", \"192.0.0.10/32\", \"192.0.0.170/32\", \"192.0.0.171/32\",\n       \"192.0.2.0/24\", \"192.31.196.0/24\", \"192.52.193.0/24\", \"192.168.0.0/16\", \"192.88.99.0/24\", \"224.0.0.0/4\",\n       \"100.64.0.0/10\", \"192.175.48.0/24\",\"198.18.0.0/15\", \"198.51.100.0/24\", \"203.0.113.0/24\", \"240.0.0.0/4\", \"::1\",\n       \"FE80::/10\", \"FF00::/8\") and network.protocol != \"dns\"]",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-endpoint.events.network-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "High Number of Cloned GitHub Repos From PAT",
        "description": "Detects a high number of unique private repo clone events originating from a single personal access token within a short time period.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 204,
        "tags": [
          "Domain: Cloud",
          "Use Case: Threat Detection",
          "Use Case: UEBA",
          "Tactic: Execution",
          "Data Source: Github"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1648",
                "name": "Serverless Execution",
                "reference": "https://attack.mitre.org/techniques/T1648/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "github",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "github.programmatic_access_type",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "github.repository_public",
            "type": "boolean",
            "ecs": false
          }
        ],
        "id": "d282d43a-0c86-43ff-ad2d-25b5b1885bb8",
        "rule_id": "fb0afac5-bbd6-49b0-b4f8-44e5381e1587",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:47.739Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:52.001Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "threshold",
        "query": "event.dataset:\"github.audit\" and event.category:\"configuration\" and event.action:\"git.clone\" and\ngithub.programmatic_access_type:(\"OAuth access token\" or \"Fine-grained personal access token\") and\ngithub.repository_public:false",
        "threshold": {
          "field": [
            "github.hashed_token"
          ],
          "value": 1,
          "cardinality": [
            {
              "field": "github.repo",
              "value": 10
            }
          ]
        },
        "index": [
          "logs-github.audit-*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "First Occurrence of IP Address For GitHub Personal Access Token (PAT)",
        "description": "Detects a new IP address used for a GitHub PAT not previously seen in the last 14 days.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 204,
        "tags": [
          "Domain: Cloud",
          "Use Case: Threat Detection",
          "Use Case: UEBA",
          "Tactic: Initial Access",
          "Rule Type: BBR",
          "Data Source: Github"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1078",
                "name": "Valid Accounts",
                "reference": "https://attack.mitre.org/techniques/T1078/",
                "subtechnique": [
                  {
                    "id": "T1078.004",
                    "name": "Cloud Accounts",
                    "reference": "https://attack.mitre.org/techniques/T1078/004/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "github",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "github.actor_ip",
            "type": "ip",
            "ecs": false
          },
          {
            "name": "github.hashed_token",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "github.programmatic_access_type",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "0312f9ec-7ccb-4122-8a76-25df0cbcdad0",
        "rule_id": "fc909baa-fb34-4c46-9691-be276ef4234c",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:47.747Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:52.010Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "event.dataset:\"github.audit\" and event.category:\"configuration\" and\ngithub.actor_ip:* and github.hashed_token:* and\ngithub.programmatic_access_type:(\"OAuth access token\" or \"Fine-grained personal access token\")",
        "new_terms_fields": [
          "github.hashed_token",
          "github.actor_ip"
        ],
        "history_window_start": "now-14d",
        "index": [
          "logs-github.audit-*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "GitHub App Deleted",
        "description": "Detects the deletion of a GitHub app either from a repo or an organization.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 204,
        "tags": [
          "Domain: Cloud",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Data Source: Github"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1648",
                "name": "Serverless Execution",
                "reference": "https://attack.mitre.org/techniques/T1648/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "github",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "github.category",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "cb2385b8-0022-4427-a324-0225183f4227",
        "rule_id": "fd01b949-81be-46d5-bcf8-284395d5f56d",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:47.750Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:52.020Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "configuration where event.dataset == \"github.audit\" and github.category == \"integration_installation\" and event.type == \"deletion\"",
        "language": "eql",
        "index": [
          "logs-github.audit-*"
        ],
        "filters": []
      },
      {
        "name": "Potential Sudo Token Manipulation via Process Injection",
        "description": "This rule detects potential sudo token manipulation attacks through process injection by monitoring the use of a debugger (gdb) process followed by a successful uid change event during the execution of the sudo process. A sudo token manipulation attack is performed by injecting into a process that has a valid sudo token, which can then be used by attackers to activate their own sudo token. This attack requires ptrace to be enabled in conjunction with the existence of a living process that has a valid sudo token with the same uid as the current user.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 107,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/nongiach/sudo_inject"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1055",
                "name": "Process Injection",
                "reference": "https://attack.mitre.org/techniques/T1055/",
                "subtechnique": [
                  {
                    "id": "T1055.008",
                    "name": "Ptrace System Calls",
                    "reference": "https://attack.mitre.org/techniques/T1055/008/"
                  }
                ]
              },
              {
                "id": "T1548",
                "name": "Abuse Elevation Control Mechanism",
                "reference": "https://attack.mitre.org/techniques/T1548/",
                "subtechnique": [
                  {
                    "id": "T1548.003",
                    "name": "Sudo and Sudo Caching",
                    "reference": "https://attack.mitre.org/techniques/T1548/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.group.id",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.session_leader.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "9a935bda-64cd-4b5f-954e-86b70d6f311e",
        "rule_id": "ff9bc8b9-f03b-4283-be58-ee0a16f5a11b",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:47.753Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:53.086Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by host.id, process.session_leader.entity_id with maxspan=15s\n[ process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and \n  process.name == \"gdb\" and process.user.id != \"0\" and process.group.id != \"0\" ]\n[ process where host.os.type == \"linux\" and event.action == \"uid_change\" and event.type == \"change\" and \n  process.name == \"sudo\" and process.user.id == \"0\" and process.group.id == \"0\" ]",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Unusual Instance Metadata Service (IMDS) API Request",
        "description": "This rule identifies potentially malicious processes attempting to access the cloud service provider's instance metadata service (IMDS) API endpoint, which can be used to retrieve sensitive instance-specific information such as instance ID, public IP address, and even temporary security credentials if role's are assumed by that instance. The rule monitors for various tools and scripts like curl, wget, python, and perl that might be used to interact with the metadata API.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 2,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Tactic: Discovery",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://hackingthe.cloud/aws/general-knowledge/intro_metadata_service/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1552",
                "name": "Unsecured Credentials",
                "reference": "https://attack.mitre.org/techniques/T1552/",
                "subtechnique": [
                  {
                    "id": "T1552.005",
                    "name": "Cloud Instance Metadata API",
                    "reference": "https://attack.mitre.org/techniques/T1552/005/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1580",
                "name": "Cloud Infrastructure Discovery",
                "reference": "https://attack.mitre.org/techniques/T1580/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.working_directory",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "befb2511-adae-4ca7-a05a-9cbd53bc3701",
        "rule_id": "ecc0cd54-608e-11ef-ab6d-f661ea17fbce",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:47.755Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:49.491Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by host.id,  process.parent.entity_id with maxspan=1s\n[process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and process.name : (\n    \"curl\", \"wget\", \"python*\", \"perl*\", \"php*\", \"ruby*\", \"lua*\", \"telnet\", \"pwsh\",\n    \"openssl\", \"nc\", \"ncat\", \"netcat\", \"awk\", \"gawk\", \"mawk\", \"nawk\", \"socat\", \"node\"\n    ) or process.executable : (\n      \"./*\", \"/tmp/*\", \"/var/tmp/*\", \"/var/www/*\", \"/dev/shm/*\", \"/etc/init.d/*\", \"/etc/rc*.d/*\",\n      \"/etc/cron*\", \"/etc/update-motd.d/*\", \"/boot/*\", \"/srv/*\", \"/run/*\", \"/etc/rc.local\"\n    ) or\n    process.command_line: \"*169.254.169.254*\" and\n    not (process.working_directory: (\n          \"/opt/rapid7*\",\n          \"/opt/nessus*\",\n          \"/snap/amazon-ssm-agent*\",\n          \"/var/snap/amazon-ssm-agent/*\",\n          \"/var/log/amazon/ssm/*\",\n          \"/srv/snp/docker/overlay2*\",\n          \"/opt/nessus_agent/var/nessus/*\") or\n        process.executable: (\n          \"/opt/rumble/bin/rumble-agent*\",\n          \"/opt/aws/inspector/bin/inspectorssmplugin\") or\n        process.parent.executable: (\n          \"/usr/bin/setup-policy-routes\",\n          \"/usr/share/ec2-instance-connect/*\",\n          \"/var/lib/amazon/ssm/*\")\n        )\n]\n[network where host.os.type == \"linux\"\n  and event.action == \"connection_attempted\"\n  and destination.ip == \"169.254.169.254\"]",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "System Binary Moved or Copied",
        "description": "This rule monitors for the copying or moving of a system binary. Adversaries may copy/move and rename system binaries to evade detection. Copying a system binary to a different location should not occur often, so if it does, the activity should be investigated.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 13,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://intezer.com/blog/research/kaiji-new-chinese-linux-malware-turning-to-golang/",
          "https://www.elastic.co/security-labs/sequel-on-persistence-mechanisms"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1036",
                "name": "Masquerading",
                "reference": "https://attack.mitre.org/techniques/T1036/",
                "subtechnique": [
                  {
                    "id": "T1036.003",
                    "name": "Rename System Utilities",
                    "reference": "https://attack.mitre.org/techniques/T1036/003/"
                  }
                ]
              },
              {
                "id": "T1564",
                "name": "Hide Artifacts",
                "reference": "https://attack.mitre.org/techniques/T1564/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.Ext.original.extension",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "file.Ext.original.path",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "d6395c1f-75c9-431d-8031-0bfee4eff63d",
        "rule_id": "fda1d332-5e08-4f27-8a9b-8c802e3292a6",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:48.727Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:52.046Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"linux\" and event.type == \"change\" and event.action == \"rename\" and process.name != null and\nfile.Ext.original.path : (\n  \"/bin/*\", \"/usr/bin/*\", \"/usr/local/bin/*\", \"/sbin/*\", \"/usr/sbin/*\", \"/usr/local/sbin/*\"\n) and not (\n  process.executable in (\n    \"/bin/dpkg\", \"/usr/bin/dpkg\", \"/bin/dockerd\", \"/usr/bin/dockerd\", \"/usr/sbin/dockerd\", \"/bin/microdnf\",\n    \"/usr/bin/microdnf\", \"/bin/rpm\", \"/usr/bin/rpm\", \"/bin/snapd\", \"/usr/bin/snapd\", \"/bin/yum\", \"/usr/bin/yum\",\n    \"/bin/dnf\", \"/usr/bin/dnf\", \"/bin/podman\", \"/usr/bin/podman\", \"/bin/dnf-automatic\", \"/usr/bin/dnf-automatic\",\n    \"/bin/pacman\", \"/usr/bin/pacman\", \"/usr/bin/dpkg-divert\", \"/bin/dpkg-divert\", \"/sbin/apk\", \"/usr/sbin/apk\",\n    \"/usr/local/sbin/apk\", \"/usr/bin/apt\", \"/usr/sbin/pacman\", \"/bin/podman\", \"/usr/bin/podman\", \"/usr/bin/puppet\",\n    \"/bin/puppet\", \"/opt/puppetlabs/puppet/bin/puppet\", \"/usr/bin/chef-client\", \"/bin/chef-client\",\n    \"/bin/autossl_check\", \"/usr/bin/autossl_check\", \"/proc/self/exe\", \"/dev/fd/*\",  \"/usr/bin/pamac-daemon\",\n    \"/bin/pamac-daemon\", \"/usr/lib/snapd/snapd\", \"/usr/local/bin/dockerd\", \"/usr/libexec/netplan/generate\",\n    \"/usr/bin/update-alternatives\", \"/bin/update-alternatives\", \"/usr/sbin/update-alternatives\",\n    \"/sbin/update-alternatives\", \"/usr/bin/pip3\", \"/bin/pip3\", \"/usr/local/bin/pip3\", \"/usr/local/bin/node\",\n    \"/bin/node\", \"/usr/bin/node\", \"/sbin/apk\", \"/usr/sbin/apk\", \"/usr/local/sbin/apk\", \"/usr/bin/pip\", \"/bin/pip\",\n    \"/usr/local/bin/pip\", \"/usr/libexec/platform-python\", \"/usr/bin/platform-python\", \"/bin/platform-python\",\n    \"/usr/lib/systemd/systemd\", \"/usr/sbin/sshd\", \"/sbin/sshd\", \"/usr/local/sbin/sshd\", \"/usr/sbin/crond\", \"/sbin/crond\",\n    \"/usr/local/sbin/crond\", \"/usr/sbin/gdm\"\n  ) or\n  process.name like (\n    \"python*\", \"packagekitd\", \"systemd\", \"ln\", \"platform-python\", \"dnf_install\", \"runc\", \"apt-get\", \"ssm-agent-worker\",\n    \"convert-usrmerge\", \"updatenow.static-cpanelsync\", \"apk\", \"exe\", \"php\", \"containerd-shim-runc-v2\", \"dpkg\", \"sed\",\n    \"platform-python*\", \"gedit\", \"crond\", \"sshd\", \"ruby\", \"sudo\", \"chainctl\", \"update-alternatives\", \"pip*\"\n  ) or\n  file.Ext.original.path : (\n    \"/bin/*.tmp\", \"/usr/bin/*.tmp\", \"/usr/local/bin/*.tmp\", \"/sbin/*.tmp\", \"/usr/sbin/*.tmp\", \"/usr/local/sbin/*.tmp\"\n  ) or\n  file.extension in (\"swp\", \"swpx\", \"swx\", \"dpkg-remove\") or\n  file.Ext.original.extension == \"dpkg-new\" or\n  process.executable : (\"/nix/store/*\", \"/var/lib/dpkg/*\", \"/tmp/vmis.*\", \"/snap/*\", \"/dev/fd/*\") or\n  process.executable == null or\n  (process.name == \"sed\" and file.name : \"sed*\") or\n  (process.name == \"perl\" and file.name : \"e2scrub_all.tmp*\") \n)",
        "language": "eql",
        "index": [
          "logs-endpoint.events.file*"
        ],
        "filters": []
      },
      {
        "name": "Attempt to Modify an Okta Policy Rule",
        "description": "Detects attempts to modify a rule within an Okta policy. An adversary may attempt to modify an Okta policy rule in order to weaken an organization's security controls.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Attempt to Modify an Okta Policy Rule\n\nThe modification of an Okta policy rule can be an indication of malicious activity as it may aim to weaken an organization's security controls.\n\n#### Possible investigation steps:\n\n- Identify the actor related to the alert by reviewing `okta.actor.id`, `okta.actor.type`, `okta.actor.alternate_id`, or `okta.actor.display_name` fields in the alert.\n- Review the `okta.client.user_agent.raw_user_agent` field to understand the device and software used by the actor.\n- Examine the `okta.outcome.reason` field for additional context around the modification attempt.\n- Check the `okta.outcome.result` field to confirm the rule modification attempt.\n- Check if there are multiple rule modification attempts from the same actor or IP address (`okta.client.ip`).\n- Check for successful logins immediately following the modification attempt.\n- Verify whether the actor's activity aligns with typical behavior or if any unusual activity took place around the time of the modification attempt.\n\n### False positive analysis:\n\n- Check if there were issues with the Okta system at the time of the modification attempt. This could indicate a system error rather than a genuine threat activity.\n- Check the geographical location (`okta.request.ip_chain.geographical_context`) and time of the modification attempt. If these match the actor's normal behavior, it might be a false positive.\n- Verify the actor's administrative rights to ensure they are correctly configured.\n\n### Response and remediation:\n\n- If unauthorized modification is confirmed, initiate the incident response process.\n- Immediately lock the affected actor account and require a password change.\n- Consider resetting MFA tokens for the actor and require re-enrollment.\n- Check if the compromised account was used to access or alter any sensitive data or systems.\n- If a specific modification technique was used, ensure your systems are patched or configured to prevent such techniques.\n- Assess the criticality of affected services and servers.\n- Work with your IT team to minimize the impact on users and maintain business continuity.\n- If multiple accounts are affected, consider a broader reset or audit of MFA tokens.\n- Implement security best practices [outlined](https://www.okta.com/blog/2019/10/9-admin-best-practices-to-keep-your-org-secure/) by Okta.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).",
        "output_index": "",
        "version": 411,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Tactic: Defense Evasion",
          "Data Source: Okta"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Consider adding exceptions to this rule to filter false positives if Okta MFA rules are regularly modified in your organization."
        ],
        "references": [
          "https://help.okta.com/en/prod/Content/Topics/Security/Security_Policies.htm",
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.007",
                    "name": "Disable or Modify Cloud Firewall",
                    "reference": "https://attack.mitre.org/techniques/T1562/007/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "314ea313-f5ea-4717-b993-2cf2d5de0ef6",
        "rule_id": "000047bb-b27a-47ec-8b62-ef1a5d2c9e19",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:48.730Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:21.627Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset:okta.system and event.action:policy.rule.update",
        "language": "kuery"
      },
      {
        "name": "Printer User (lp) Shell Execution",
        "description": "This detection rule addresses multiple vulnerabilities in the CUPS printing system, including CVE-2024-47176, CVE-2024-47076, CVE-2024-47175, and CVE-2024-47177. Specifically, this rule detects shell executions from the foomatic-rip parent process through the default printer user (lp). These flaws impact components like cups-browsed, libcupsfilters, libppd, and foomatic-rip, allowing remote unauthenticated attackers to manipulate IPP URLs or inject malicious data through crafted UDP packets or network spoofing. This can result in arbitrary command execution when a print job is initiated.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Printer User (lp) Shell Execution\n\nThis rule identifies potential exploitation attempts of several vulnerabilities in the CUPS printing system (CVE-2024-47176, CVE-2024-47076, CVE-2024-47175, CVE-2024-47177). These vulnerabilities allow attackers to send crafted IPP requests or manipulate UDP packets to execute arbitrary commands or modify printer configurations. Attackers can exploit these flaws to inject malicious data, leading to Remote Code Execution (RCE) on affected systems.\n\n#### Possible Investigation Steps\n\n- Investigate the incoming IPP requests or UDP packets targeting port 631.\n- Examine the printer configurations on the system to determine if any unauthorized printers or URLs have been added.\n- Investigate the process tree to check if any unexpected processes were triggered as a result of IPP activity. Review the executable files for legitimacy.\n- Check for additional alerts related to the compromised system or user within the last 48 hours.\n- Investigate network traffic logs for suspicious outbound connections to unrecognized domains or IP addresses.\n- Check if any of the contacted domains or addresses are newly registered or have a suspicious reputation.\n- Retrieve any scripts or executables dropped by the attack for further analysis in a private sandbox environment:\n- Analyze potential malicious activity, including:\n  - Attempts to communicate with external servers.\n  - File access or creation of unauthorized executables.\n  - Cron jobs, services, or other persistence mechanisms.\n\n### Related Rules\n- Cupsd or Foomatic-rip Shell Execution - 476267ff-e44f-476e-99c1-04c78cb3769d\n- Network Connection by Cups or Foomatic-rip Child - e80ee207-9505-49ab-8ca8-bc57d80e2cab\n- File Creation by Cups or Foomatic-rip Child - b9b14be7-b7f4-4367-9934-81f07d2f63c4\n- Suspicious Execution from Foomatic-rip or Cupsd Parent - 986361cd-3dac-47fe-afa1-5c5dd89f2fb4\n\n### False Positive Analysis\n\n- This activity is rarely legitimate. However, verify the context to rule out non-malicious printer configuration changes or legitimate IPP requests.\n\n### Response and Remediation\n\n- Initiate the incident response process based on the triage outcome.\n- Isolate the compromised host to prevent further exploitation.\n- If the investigation confirms malicious activity, search the environment for additional compromised hosts.\n- Implement network segmentation or restrictions to contain the attack.\n- Stop suspicious processes or services tied to CUPS exploitation.\n- Block identified Indicators of Compromise (IoCs), including IP addresses, domains, or hashes of involved files.\n- Review compromised systems for backdoors, such as reverse shells or persistence mechanisms like cron jobs.\n- Investigate potential credential exposure on compromised systems and reset passwords for any affected accounts.\n- Restore the original printer configurations or uninstall unauthorized printer entries.\n- Perform a thorough antimalware scan to identify any lingering threats or artifacts from the attack.\n- Investigate how the attacker gained initial access and address any weaknesses to prevent future exploitation.\n- Use insights from the incident to improve detection and response times in future incidents (MTTD and MTTR).\n",
        "output_index": "",
        "version": 2,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Use Case: Vulnerability",
          "Tactic: Execution",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/security-labs/cups-overflow",
          "https://www.evilsocket.net/2024/09/26/Attacking-UNIX-systems-via-CUPS-Part-I/",
          "https://gist.github.com/stong/c8847ef27910ae344a7b5408d9840ee1",
          "https://github.com/RickdeJager/cupshax/blob/main/cupshax.py"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1203",
                "name": "Exploitation for Client Execution",
                "reference": "https://attack.mitre.org/techniques/T1203/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "4177881a-fb32-4e61-acba-4e424c0484b8",
        "rule_id": "f86cd31c-5c7e-4481-99d7-6875a3e31309",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:48.753Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:51.924Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and user.name == \"lp\" and\nprocess.parent.name in (\"cupsd\", \"foomatic-rip\", \"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\") and\nprocess.name in (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\") and not (\n  process.command_line like (\n    \"*/tmp/foomatic-*\", \"*-sDEVICE=ps2write*\", \"*printf*\", \"/bin/sh -e -c cat\", \"/bin/bash -c cat\",\n    \"/bin/bash -e -c cat\"\n  ) or\n  process.args like \"gs*\"\n)",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious Activity Reported by Okta User",
        "description": "Detects when a user reports suspicious activity for their Okta account. These events should be investigated, as they can help security teams identify when an adversary is attempting to gain access to their network.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 409,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Data Source: Okta",
          "Tactic: Initial Access"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "A user may report suspicious activity on their Okta account in error."
        ],
        "references": [
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1078",
                "name": "Valid Accounts",
                "reference": "https://attack.mitre.org/techniques/T1078/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1078",
                "name": "Valid Accounts",
                "reference": "https://attack.mitre.org/techniques/T1078/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1078",
                "name": "Valid Accounts",
                "reference": "https://attack.mitre.org/techniques/T1078/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1078",
                "name": "Valid Accounts",
                "reference": "https://attack.mitre.org/techniques/T1078/"
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "17d7115d-7e6b-4b6c-85f0-ae37cfb29460",
        "rule_id": "f994964f-6fce-4d75-8e79-e16ccc412588",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:48.743Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:51.957Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset:okta.system and event.action:user.account.report_suspicious_activity_by_enduser",
        "language": "kuery"
      },
      {
        "name": "Cron Job Created or Modified",
        "description": "This rule monitors for (ana)cron jobs being created or renamed. Linux cron jobs are scheduled tasks that can be leveraged by system administrators to set up scheduled tasks, but may be abused by malicious actors for persistence, privilege escalation and command execution. By creating or modifying cron job configurations, attackers can execute malicious commands or scripts at predefined intervals, ensuring their continued presence and enabling unauthorized activities.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Cron Job Created or Modified\nLinux cron jobs are scheduled tasks that run at specified intervals or times, managed by the cron daemon. \n\nBy creating or modifying cron job configurations, attackers can execute malicious commands or scripts at predefined intervals, ensuring their continued presence and enabling unauthorized activities.\n\nThis rule monitors the creation of cron jobs by monitoring for file creation and rename events in the most common cron job task location directories.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n> This investigation guide uses [placeholder fields](https://www.elastic.co/guide/en/security/current/osquery-placeholder-fields.html) to dynamically pass alert data into Osquery queries. Placeholder fields were introduced in Elastic Stack version 8.7.0. If you're using Elastic Stack version 8.6.0 or earlier, you'll need to manually adjust this investigation guide's queries to ensure they properly run.\n\n#### Possible Investigation Steps\n\n- Investigate the cron job file that was created or modified.\n- Investigate whether any other files in any of the available cron job directories have been altered through OSQuery.\n  - !{osquery{\"label\":\"Osquery - Retrieve File Listing Information\",\"query\":\"SELECT * FROM file WHERE (path LIKE '/etc/cron.allow.d/%' OR path LIKE '/etc/cron.d/%' OR path LIKE '/etc/cron.hourly/%'\\nOR path LIKE '/etc/cron.daily/%' OR path LIKE '/etc/cron.weekly/%' OR path LIKE '/etc/cron.monthly/%' OR path LIKE\\n'/var/spool/cron/crontabs/%')\\n\"}}\n  - !{osquery{\"label\":\"Osquery - Retrieve Cron File Information\",\"query\":\"SELECT * FROM file WHERE (path = '/etc/cron.allow' OR path = '/etc/cron.deny' OR path = '/etc/crontab')\\n\"}}\n  - !{osquery{\"label\":\"Osquery - Retrieve Additional File Listing Information\",\"query\":\"SELECT f.path, u.username AS file_owner, g.groupname AS group_owner, datetime(f.atime, 'unixepoch') AS\\nfile_last_access_time, datetime(f.mtime, 'unixepoch') AS file_last_modified_time, datetime(f.ctime, 'unixepoch') AS\\nfile_last_status_change_time, datetime(f.btime, 'unixepoch') AS file_created_time, f.size AS size_bytes FROM file f LEFT\\nJOIN users u ON f.uid = u.uid LEFT JOIN groups g ON f.gid = g.gid WHERE ( path LIKE '/etc/cron.allow.d/%' OR path LIKE\\n'/etc/cron.d/%' OR path LIKE '/etc/cron.hourly/%' OR path LIKE '/etc/cron.daily/%' OR path LIKE '/etc/cron.weekly/%' OR\\npath LIKE '/etc/cron.monthly/%' OR path LIKE '/var/spool/cron/crontabs/%')\\n\"}}\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence and whether they are located in expected locations.\n  - !{osquery{\"label\":\"Osquery - Retrieve Running Processes by User\",\"query\":\"SELECT pid, username, name FROM processes p JOIN users u ON u.uid = p.uid ORDER BY username\"}}\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Validate the activity is not related to planned patches, updates, network administrator activity, or legitimate software installations.\n- Investigate whether the altered scripts call other malicious scripts elsewhere on the file system. \n  - If scripts or executables were dropped, retrieve the files and determine if they are malicious:\n    - Use a private sandboxed malware analysis system to perform analysis.\n      - Observe and collect information about the following activities:\n        - Attempts to contact external domains and addresses.\n          - Check if the domain is newly registered or unexpected.\n          - Check the reputation of the domain or IP address.\n        - File access, modification, and creation activities.\n- Investigate abnormal behaviors by the subject process/user such as network connections, file modifications, and any other spawned child processes.\n  - Investigate listening ports and open sockets to look for potential command and control traffic or data exfiltration.\n    - !{osquery{\"label\":\"Osquery - Retrieve Listening Ports\",\"query\":\"SELECT pid, address, port, socket, protocol, path FROM listening_ports\"}}\n    - !{osquery{\"label\":\"Osquery - Retrieve Open Sockets\",\"query\":\"SELECT pid, family, remote_address, remote_port, socket, state FROM process_open_sockets\"}}\n  - Identify the user account that performed the action, analyze it, and check whether it should perform this kind of action.\n    - !{osquery{\"label\":\"Osquery - Retrieve Information for a Specific User\",\"query\":\"SELECT * FROM users WHERE username = {{user.name}}\"}}\n- Investigate whether the user is currently logged in and active.\n    - !{osquery{\"label\":\"Osquery - Investigate the Account Authentication Status\",\"query\":\"SELECT * FROM logged_in_users WHERE user = {{user.name}}\"}}\n\n### False Positive Analysis\n\n- If this activity is related to new benign software installation activity, consider adding exceptions — preferably with a combination of user and command line conditions.\n- If this activity is related to a system administrator who uses cron jobs for administrative purposes, consider adding exceptions for this specific administrator user account. \n- Try to understand the context of the execution by thinking about the user, machine, or business purpose. A small number of endpoints, such as servers with unique software, might appear unusual but satisfy a specific business need.\n\n### Related Rules\n\n- Suspicious File Creation in /etc for Persistence - 1c84dd64-7e6c-4bad-ac73-a5014ee37042\n- Potential Persistence Through Run Control Detected - 0f4d35e4-925e-4959-ab24-911be207ee6f\n- Potential Persistence Through init.d Detected - 474fd20e-14cc-49c5-8160-d9ab4ba16c8b\n- Systemd Timer Created - 7fb500fa-8e24-4bd1-9480-2a819352602c\n- Systemd Service Created - 17b0a495-4d9f-414c-8ad0-92f018b8e001\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Delete the service/timer or restore its original configuration.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Leverage the incident response data and logging to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 14,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Tactic: Privilege Escalation",
          "Tactic: Execution",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://pberba.github.io/security/2022/01/30/linux-threat-hunting-for-persistence-systemd-timers-cron/",
          "https://www.elastic.co/security-labs/primer-on-persistence-mechanisms"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1053",
                "name": "Scheduled Task/Job",
                "reference": "https://attack.mitre.org/techniques/T1053/",
                "subtechnique": [
                  {
                    "id": "T1053.003",
                    "name": "Cron",
                    "reference": "https://attack.mitre.org/techniques/T1053/003/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1053",
                "name": "Scheduled Task/Job",
                "reference": "https://attack.mitre.org/techniques/T1053/",
                "subtechnique": [
                  {
                    "id": "T1053.003",
                    "name": "Cron",
                    "reference": "https://attack.mitre.org/techniques/T1053/003/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1053",
                "name": "Scheduled Task/Job",
                "reference": "https://attack.mitre.org/techniques/T1053/",
                "subtechnique": [
                  {
                    "id": "T1053.003",
                    "name": "Cron",
                    "reference": "https://attack.mitre.org/techniques/T1053/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.Ext.original.extension",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "3c23eb86-724a-4326-8168-be34f48e1b23",
        "rule_id": "ff10d4d8-fea7-422d-afb1-e5a2702369a9",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T14:22:48.777Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T14:21:53.062Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"linux\" and\nevent.action in (\"rename\", \"creation\") and file.path : (\n  \"/etc/cron.allow\", \"/etc/cron.deny\", \"/etc/cron.d/*\", \"/etc/cron.hourly/*\", \"/etc/cron.daily/*\", \"/etc/cron.weekly/*\",\n  \"/etc/cron.monthly/*\", \"/etc/crontab\", \"/var/spool/cron/crontabs/*\", \"/var/spool/anacron/*\"\n) and not (\n  process.executable in (\n    \"/bin/dpkg\", \"/usr/bin/dpkg\", \"/bin/dockerd\", \"/usr/bin/dockerd\", \"/usr/sbin/dockerd\", \"/bin/microdnf\",\n    \"/usr/bin/microdnf\", \"/bin/rpm\", \"/usr/bin/rpm\", \"/bin/snapd\", \"/usr/bin/snapd\", \"/bin/yum\", \"/usr/bin/yum\",\n    \"/bin/dnf\", \"/usr/bin/dnf\", \"/bin/podman\", \"/usr/bin/podman\", \"/bin/dnf-automatic\", \"/usr/bin/dnf-automatic\",\n    \"/bin/pacman\", \"/usr/bin/pacman\", \"/usr/bin/dpkg-divert\", \"/bin/dpkg-divert\", \"/sbin/apk\", \"/usr/sbin/apk\",\n    \"/usr/local/sbin/apk\", \"/usr/bin/apt\", \"/usr/sbin/pacman\", \"/bin/podman\", \"/usr/bin/podman\", \"/usr/bin/puppet\",\n    \"/bin/puppet\", \"/opt/puppetlabs/puppet/bin/puppet\", \"/usr/bin/chef-client\", \"/bin/chef-client\",\n    \"/bin/autossl_check\", \"/usr/bin/autossl_check\", \"/proc/self/exe\", \"/dev/fd/*\",  \"/usr/bin/pamac-daemon\",\n    \"/bin/pamac-daemon\", \"/usr/local/bin/dockerd\", \"/opt/elasticbeanstalk/bin/platform-engine\",\n    \"/opt/puppetlabs/puppet/bin/ruby\", \"/usr/libexec/platform-python\", \"/opt/imunify360/venv/bin/python3\",\n    \"/opt/eset/efs/lib/utild\", \"/usr/sbin/anacron\", \"/usr/bin/podman\", \"/kaniko/kaniko-executor\"\n  ) or\n  file.path like (\"/var/spool/cron/crontabs/tmp.*\", \"/etc/cron.d/jumpcloud-updater\") or\n  file.extension in (\"swp\", \"swpx\", \"swx\", \"dpkg-remove\") or\n  file.Ext.original.extension == \"dpkg-new\" or\n  process.executable : (\n    \"/nix/store/*\", \"/var/lib/dpkg/*\", \"/tmp/vmis.*\", \"/snap/*\", \"/dev/fd/*\", \"/usr/libexec/platform-python*\"\n  ) or\n  process.executable == null or\n  process.name in (\n    \"crond\", \"executor\", \"puppet\", \"droplet-agent.postinst\", \"cf-agent\", \"schedd\", \"imunify-notifier\", \"perl\",\n    \"jumpcloud-agent\", \"crio\", \"dnf_install\", \"utild\"\n  ) or\n  (process.name == \"sed\" and file.name : \"sed*\") or\n  (process.name == \"perl\" and file.name : \"e2scrub_all.tmp*\") \n)",
        "language": "eql",
        "index": [
          "logs-endpoint.events.file*"
        ],
        "filters": []
      }
    ],
    "skipped": []
  },
  "errors": [
    {
      "message": "Rule update for rule 37b211e8-4e2f-440f-86d8-06cc8f158cfa has a rule type change. All 'pick_version' values for rule must match 'TARGET'",
      "rules": [
        {
          "rule_id": "37b211e8-4e2f-440f-86d8-06cc8f158cfa"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'fd7a6052-58fa-4397-93c3-4795249ccfa2' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "fd7a6052-58fa-4397-93c3-4795249ccfa2"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '290aca65-e94d-403b-ba0f-62f320e63f51' for fields: tags, related_integrations, data_source. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "290aca65-e94d-403b-ba0f-62f320e63f51"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '2917d495-59bd-4250-b395-c29409b76086' for fields: tags, related_integrations, data_source. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "2917d495-59bd-4250-b395-c29409b76086"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '291a0de9-937a-4189-94c0-3e847c8b13e4' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "291a0de9-937a-4189-94c0-3e847c8b13e4"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '31b4c719-f2b4-41f6-a9bd-fce93c2eaf62' for fields: tags, related_integrations, eql_query, data_source. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "31b4c719-f2b4-41f6-a9bd-fce93c2eaf62"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '3bc6deaa-fbd4-433a-ae21-3e892f95624f' for fields: tags, related_integrations, data_source. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "3bc6deaa-fbd4-433a-ae21-3e892f95624f"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'e26f042e-c590-4e82-8e05-41e81bd822ad' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "e26f042e-c590-4e82-8e05-41e81bd822ad"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '00140285-b827-4aee-aa09-8113f58a08f3' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "00140285-b827-4aee-aa09-8113f58a08f3"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '12f07955-1674-44f7-86b5-c35da0a6f41a' for fields: tags, related_integrations, data_source. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "12f07955-1674-44f7-86b5-c35da0a6f41a"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '15c0b7a7-9c34-4869-b25b-fa6518414899' for fields: tags, related_integrations, data_source. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "15c0b7a7-9c34-4869-b25b-fa6518414899"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '2ffa1f1e-b6db-47fa-994b-1512743847eb' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "2ffa1f1e-b6db-47fa-994b-1512743847eb"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '35df0dd8-092d-4a83-88c1-5151a804f31b' for fields: tags, related_integrations, data_source. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "35df0dd8-092d-4a83-88c1-5151a804f31b"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '3838e0e3-1850-4850-a411-2e8c5ba40ba8' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "3838e0e3-1850-4850-a411-2e8c5ba40ba8"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '4630d948-40d4-4cef-ac69-4002e29bc3db' for fields: tags, related_integrations, data_source. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "4630d948-40d4-4cef-ac69-4002e29bc3db"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '4fe9d835-40e1-452d-8230-17c147cafad8' for fields: tags, related_integrations, data_source. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "4fe9d835-40e1-452d-8230-17c147cafad8"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '581add16-df76-42bb-af8e-c979bfb39a59' for fields: tags, related_integrations, data_source. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "581add16-df76-42bb-af8e-c979bfb39a59"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '5c6f4c58-b381-452a-8976-f1b1c6aa0def' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "5c6f4c58-b381-452a-8976-f1b1c6aa0def"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '61ac3638-40a3-44b2-855a-985636ca985e' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "61ac3638-40a3-44b2-855a-985636ca985e"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '71bccb61-e19b-452f-b104-79a60e546a95' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "71bccb61-e19b-452f-b104-79a60e546a95"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '770e0c4d-b998-41e5-a62e-c7901fd7f470' for fields: tags, related_integrations, data_source. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "770e0c4d-b998-41e5-a62e-c7901fd7f470"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '9d110cb3-5f4b-4c9a-b9f5-53f0a1707ae6' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "9d110cb3-5f4b-4c9a-b9f5-53f0a1707ae6"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'c6453e73-90eb-4fe7-a98c-cde7bbfc504a' for fields: tags, related_integrations, data_source. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "c6453e73-90eb-4fe7-a98c-cde7bbfc504a"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'cde1bafa-9f01-4f43-a872-605b678968b0' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "cde1bafa-9f01-4f43-a872-605b678968b0"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'd331bbe2-6db4-4941-80a5-8270db72eb61' for fields: tags, related_integrations, eql_query, data_source. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "d331bbe2-6db4-4941-80a5-8270db72eb61"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'd68e95ad-1c82-4074-a12a-125fe10ac8ba' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "d68e95ad-1c82-4074-a12a-125fe10ac8ba"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'eda499b8-a073-4e35-9733-22ec71f57f3a' for fields: tags, related_integrations, eql_query, data_source. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "eda499b8-a073-4e35-9733-22ec71f57f3a"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'edf8ee23-5ea7-4123-ba19-56b41e424ae3' for fields: tags, related_integrations, data_source. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "edf8ee23-5ea7-4123-ba19-56b41e424ae3"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'fe794edd-487f-4a90-b285-3ee54f2af2d3' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "fe794edd-487f-4a90-b285-3ee54f2af2d3"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '0564fb9d-90b9-4234-a411-82a546dc1343' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "0564fb9d-90b9-4234-a411-82a546dc1343"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '11dd9713-0ec6-4110-9707-32daae1ee68c' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "11dd9713-0ec6-4110-9707-32daae1ee68c"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '14ed1aa9-ebfd-4cf9-a463-0ac59ec55204' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "14ed1aa9-ebfd-4cf9-a463-0ac59ec55204"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '1dcc51f6-ba26-49e7-9ef4-2655abb2361e' for fields: tags, related_integrations, eql_query, data_source. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "1dcc51f6-ba26-49e7-9ef4-2655abb2361e"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '2c17e5d7-08b9-43b2-b58a-0270d65ac85b' for fields: tags, related_integrations, data_source. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "2c17e5d7-08b9-43b2-b58a-0270d65ac85b"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '32c5cf9c-2ef8-4e87-819e-5ccb7cd18b14' for fields: tags, related_integrations, required_fields, eql_query, data_source. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "32c5cf9c-2ef8-4e87-819e-5ccb7cd18b14"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '3ecbdc9e-e4f2-43fa-8cca-63802125e582' for fields: tags, related_integrations, data_source. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "3ecbdc9e-e4f2-43fa-8cca-63802125e582"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '416697ae-e468-4093-a93d-59661fa619ec' for fields: tags, setup, related_integrations, required_fields, eql_query, data_source. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "416697ae-e468-4093-a93d-59661fa619ec"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '483c4daf-b0c6-49e0-adf3-0bfa93231d6b' for fields: tags, related_integrations, eql_query, data_source. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "483c4daf-b0c6-49e0-adf3-0bfa93231d6b"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '4de76544-f0e5-486a-8f84-eae0b6063cdc' for fields: tags, related_integrations, eql_query, data_source. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "4de76544-f0e5-486a-8f84-eae0b6063cdc"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '4ed493fc-d637-4a36-80ff-ac84937e5461' for fields: tags, related_integrations, data_source. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "4ed493fc-d637-4a36-80ff-ac84937e5461"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '53a26770-9cbd-40c5-8b57-61d01a325e14' for fields: tags, related_integrations, data_source. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "53a26770-9cbd-40c5-8b57-61d01a325e14"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '54c3d186-0461-4dc3-9b33-2dc5c7473936' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "54c3d186-0461-4dc3-9b33-2dc5c7473936"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '5bb4a95d-5a08-48eb-80db-4c3a63ec78a8' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "5bb4a95d-5a08-48eb-80db-4c3a63ec78a8"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '68921d85-d0dc-48b3-865f-43291ca2c4f2' for fields: tags, related_integrations, data_source. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "68921d85-d0dc-48b3-865f-43291ca2c4f2"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '6ea55c81-e2ba-42f2-a134-bccf857ba922' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "6ea55c81-e2ba-42f2-a134-bccf857ba922"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '7b8bfc26-81d2-435e-965c-d722ee397ef1' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "7b8bfc26-81d2-435e-965c-d722ee397ef1"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '81fe9dc6-a2d7-4192-a2d8-eed98afc766a' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "81fe9dc6-a2d7-4192-a2d8-eed98afc766a"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '84da2554-e12a-11ec-b896-f661ea17fbcd' for fields: tags, related_integrations, data_source. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "84da2554-e12a-11ec-b896-f661ea17fbcd"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '871ea072-1b71-4def-b016-6278b505138d' for fields: tags, related_integrations, data_source. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "871ea072-1b71-4def-b016-6278b505138d"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '8c37dc0e-e3ac-4c97-8aa0-cf6a9122de45' for fields: tags, related_integrations, data_source. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "8c37dc0e-e3ac-4c97-8aa0-cf6a9122de45"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '9b6813a1-daf1-457e-b0e6-0bb4e55b8a4c' for fields: tags, related_integrations, data_source. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "9b6813a1-daf1-457e-b0e6-0bb4e55b8a4c"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'a624863f-a70d-417f-a7d2-7a404638d47f' for fields: tags, related_integrations, data_source. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "a624863f-a70d-417f-a7d2-7a404638d47f"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'ac5012b8-8da8-440b-aaaf-aedafdea2dff' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "ac5012b8-8da8-440b-aaaf-aedafdea2dff"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'b41a13c6-ba45-4bab-a534-df53d0cfed6a' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "b41a13c6-ba45-4bab-a534-df53d0cfed6a"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'b5877334-677f-4fb9-86d5-a9721274223b' for fields: tags, setup, related_integrations, eql_query, data_source. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "b5877334-677f-4fb9-86d5-a9721274223b"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'b8f8da2d-a9dc-48c0-90e4-955c0aa1259a' for fields: tags, related_integrations, data_source. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "b8f8da2d-a9dc-48c0-90e4-955c0aa1259a"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'bd2c86a0-8b61-4457-ab38-96943984e889' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "bd2c86a0-8b61-4457-ab38-96943984e889"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'c8b150f0-0164-475b-a75e-74b47800a9ff' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "c8b150f0-0164-475b-a75e-74b47800a9ff"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'c8cccb06-faf2-4cd5-886e-2c9636cfcb87' for fields: tags, related_integrations, data_source. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "c8cccb06-faf2-4cd5-886e-2c9636cfcb87"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'cff92c41-2225-4763-b4ce-6f71e5bda5e6' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "cff92c41-2225-4763-b4ce-6f71e5bda5e6"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'd0e159cf-73e9-40d1-a9ed-077e3158a855' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "d0e159cf-73e9-40d1-a9ed-077e3158a855"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'd117cbb4-7d56-41b4-b999-bdf8c25648a0' for fields: tags, related_integrations, data_source. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "d117cbb4-7d56-41b4-b999-bdf8c25648a0"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'd72e33fc-6e91-42ff-ac8b-e573268c5a87' for fields: tags, related_integrations, data_source. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "d72e33fc-6e91-42ff-ac8b-e573268c5a87"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'd99a037b-c8e2-47a5-97b9-170d076827c4' for fields: tags, related_integrations, data_source. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "d99a037b-c8e2-47a5-97b9-170d076827c4"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'da7733b1-fe08-487e-b536-0a04c6d8b0cd' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "da7733b1-fe08-487e-b536-0a04c6d8b0cd"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'dc9c1f74-dac3-48e3-b47f-eb79db358f57' for fields: tags, related_integrations, data_source. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "dc9c1f74-dac3-48e3-b47f-eb79db358f57"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'e8571d5f-bea1-46c2-9f56-998de2d3ed95' for fields: tags, related_integrations, data_source. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "e8571d5f-bea1-46c2-9f56-998de2d3ed95"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'ebfe1448-7fac-4d59-acea-181bd89b1f7f' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "ebfe1448-7fac-4d59-acea-181bd89b1f7f"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'fa01341d-6662-426b-9d0c-6d81e33c8a9d' for fields: tags, related_integrations, data_source. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "fa01341d-6662-426b-9d0c-6d81e33c8a9d"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '0635c542-1b96-4335-9b47-126582d2c19a' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "0635c542-1b96-4335-9b47-126582d2c19a"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '06a7a03c-c735-47a6-a313-51c354aef6c3' for fields: tags, related_integrations, data_source. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "06a7a03c-c735-47a6-a313-51c354aef6c3"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '074464f9-f30d-4029-8c03-0ed237fffec7' for fields: tags, related_integrations, data_source. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "074464f9-f30d-4029-8c03-0ed237fffec7"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '1178ae09-5aff-460a-9f2f-455cd0ac4d8e' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "1178ae09-5aff-460a-9f2f-455cd0ac4d8e"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '1327384f-00f3-44d5-9a8c-2373ba071e92' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "1327384f-00f3-44d5-9a8c-2373ba071e92"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '1a6075b0-7479-450e-8fe7-b8b8438ac570' for fields: tags, related_integrations, eql_query, data_source. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "1a6075b0-7479-450e-8fe7-b8b8438ac570"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '1e0a3f7c-21e7-4bb1-98c7-2036612fb1be' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "1e0a3f7c-21e7-4bb1-98c7-2036612fb1be"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '201200f1-a99b-43fb-88ed-f65a45c4972c' for fields: tags, setup, related_integrations, data_source. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "201200f1-a99b-43fb-88ed-f65a45c4972c"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '265db8f5-fc73-4d0d-b434-6483b56372e2' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "265db8f5-fc73-4d0d-b434-6483b56372e2"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '3535c8bb-3bd5-40f4-ae32-b7cd589d5372' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "3535c8bb-3bd5-40f4-ae32-b7cd589d5372"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '403ef0d3-8259-40c9-a5b6-d48354712e49' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "403ef0d3-8259-40c9-a5b6-d48354712e49"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '4b438734-3793-4fda-bd42-ceeada0be8f9' for fields: tags, related_integrations, data_source. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "4b438734-3793-4fda-bd42-ceeada0be8f9"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '54a81f68-5f2a-421e-8eed-f888278bb712' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "54a81f68-5f2a-421e-8eed-f888278bb712"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '56f2e9b5-4803-4e44-a0a4-a52dc79d57fe' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "56f2e9b5-4803-4e44-a0a4-a52dc79d57fe"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '58aa72ca-d968-4f34-b9f7-bea51d75eb50' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "58aa72ca-d968-4f34-b9f7-bea51d75eb50"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '670b3b5a-35e5-42db-bd36-6c5b9b4b7313' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "670b3b5a-35e5-42db-bd36-6c5b9b4b7313"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '79f0a1f7-ed6b-471c-8eb1-23abd6470b1c' for fields: tags, related_integrations, data_source. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "79f0a1f7-ed6b-471c-8eb1-23abd6470b1c"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '92984446-aefb-4d5e-ad12-598042ca80ba' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "92984446-aefb-4d5e-ad12-598042ca80ba"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '94a401ba-4fa2-455c-b7ae-b6e037afc0b7' for fields: tags, related_integrations, data_source. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "94a401ba-4fa2-455c-b7ae-b6e037afc0b7"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '994e40aa-8c85-43de-825e-15f665375ee8' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "994e40aa-8c85-43de-825e-15f665375ee8"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '9d110cb3-5f4b-4c9a-b9f5-53f0a1707ae2' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "9d110cb3-5f4b-4c9a-b9f5-53f0a1707ae2"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '9d110cb3-5f4b-4c9a-b9f5-53f0a1707ae3' for fields: tags, related_integrations, data_source. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "9d110cb3-5f4b-4c9a-b9f5-53f0a1707ae3"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '9d110cb3-5f4b-4c9a-b9f5-53f0a1707ae4' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "9d110cb3-5f4b-4c9a-b9f5-53f0a1707ae4"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'a22a09c2-2162-4df0-a356-9aacbeb56a04' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "a22a09c2-2162-4df0-a356-9aacbeb56a04"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'a7e7bfa3-088e-4f13-b29e-3986e0e756b8' for fields: tags, related_integrations, data_source. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "a7e7bfa3-088e-4f13-b29e-3986e0e756b8"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'b43570de-a908-4f7f-8bdb-b2df6ffd8c80' for fields: tags, related_integrations, data_source. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "b43570de-a908-4f7f-8bdb-b2df6ffd8c80"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'b5ea4bfe-a1b2-421f-9d47-22a75a6f2921' for fields: tags, related_integrations, eql_query, data_source. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "b5ea4bfe-a1b2-421f-9d47-22a75a6f2921"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'b9960fef-82c6-4816-befa-44745030e917' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "b9960fef-82c6-4816-befa-44745030e917"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'be8afaed-4bcd-4e0a-b5f9-5562003dde81' for fields: tags, setup, related_integrations, data_source. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "be8afaed-4bcd-4e0a-b5f9-5562003dde81"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'bfeaf89b-a2a7-48a3-817f-e41829dc61ee' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "bfeaf89b-a2a7-48a3-817f-e41829dc61ee"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'c25e9c87-95e1-4368-bfab-9fd34cf867ec' for fields: tags, related_integrations, data_source. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "c25e9c87-95e1-4368-bfab-9fd34cf867ec"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'c5dc3223-13a2-44a2-946c-e9dc0aa0449c' for fields: tags, related_integrations, data_source. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "c5dc3223-13a2-44a2-946c-e9dc0aa0449c"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'ce64d965-6cb0-466d-b74f-8d2c76f47f05' for fields: tags, related_integrations, data_source. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "ce64d965-6cb0-466d-b74f-8d2c76f47f05"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'd31f183a-e5b1-451b-8534-ba62bca0b404' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "d31f183a-e5b1-451b-8534-ba62bca0b404"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'de9bd7e0-49e9-4e92-a64d-53ade2e66af1' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "de9bd7e0-49e9-4e92-a64d-53ade2e66af1"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'e3343ab9-4245-4715-b344-e11c56b0a47f' for fields: tags, related_integrations, data_source. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "e3343ab9-4245-4715-b344-e11c56b0a47f"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'ebf1adea-ccf2-4943-8b96-7ab11ca173a5' for fields: tags, related_integrations, data_source. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "ebf1adea-ccf2-4943-8b96-7ab11ca173a5"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'f2f46686-6f3c-4724-bd7d-24e31c70f98f' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "f2f46686-6f3c-4724-bd7d-24e31c70f98f"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'f545ff26-3c94-4fd0-bd33-3c7f95a3a0fc' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "f545ff26-3c94-4fd0-bd33-3c7f95a3a0fc"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'f7c4dc5a-a58d-491d-9f14-9b66507121c0' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "f7c4dc5a-a58d-491d-9f14-9b66507121c0"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'f874315d-5188-4b4a-8521-d1c73093a7e4' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "f874315d-5188-4b4a-8521-d1c73093a7e4"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'fd4a992d-6130-4802-9ff8-829b89ae801f' for fields: tags, related_integrations, data_source. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "fd4a992d-6130-4802-9ff8-829b89ae801f"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'fd70c98a-c410-42dc-a2e3-761c71848acf' for fields: tags, related_integrations, data_source. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "fd70c98a-c410-42dc-a2e3-761c71848acf"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '035889c4-2686-4583-a7df-67f89c292f2c' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "035889c4-2686-4583-a7df-67f89c292f2c"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '06568a02-af29-4f20-929c-f3af281e41aa' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "06568a02-af29-4f20-929c-f3af281e41aa"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '0abf0c5b-62dd-48d2-ac4e-6b43fe3a6e83' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "0abf0c5b-62dd-48d2-ac4e-6b43fe3a6e83"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '0b2f3da5-b5ec-47d1-908b-6ebb74814289' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "0b2f3da5-b5ec-47d1-908b-6ebb74814289"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '0c7ca5c2-728d-4ad9-b1c5-bbba83ecb1f4' for fields: tags, related_integrations, data_source. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "0c7ca5c2-728d-4ad9-b1c5-bbba83ecb1f4"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '1160dcdb-0a0a-4a79-91d8-9b84616edebd' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "1160dcdb-0a0a-4a79-91d8-9b84616edebd"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '1aa9181a-492b-4c01-8b16-fa0735786b2b' for fields: tags, related_integrations, eql_query, data_source. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "1aa9181a-492b-4c01-8b16-fa0735786b2b"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '1f0a69c0-3392-4adf-b7d5-6012fd292da8' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "1f0a69c0-3392-4adf-b7d5-6012fd292da8"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '203ab79b-239b-4aa5-8e54-fc50623ee8e4' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "203ab79b-239b-4aa5-8e54-fc50623ee8e4"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '25224a80-5a4a-4b8a-991e-6ab390465c4f' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "25224a80-5a4a-4b8a-991e-6ab390465c4f"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '27071ea3-e806-4697-8abc-e22c92aa4293' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "27071ea3-e806-4697-8abc-e22c92aa4293"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '2de87d72-ee0c-43e2-b975-5f0b029ac600' for fields: tags, related_integrations, data_source. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "2de87d72-ee0c-43e2-b975-5f0b029ac600"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '2e29e96a-b67c-455a-afe4-de6183431d0d' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "2e29e96a-b67c-455a-afe4-de6183431d0d"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '2edc8076-291e-41e9-81e4-e3fcbc97ae5e' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "2edc8076-291e-41e9-81e4-e3fcbc97ae5e"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '36a8e048-d888-4f61-a8b9-0f9e2e40f317' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "36a8e048-d888-4f61-a8b9-0f9e2e40f317"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '3a59fc81-99d3-47ea-8cd6-d48d561fca20' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "3a59fc81-99d3-47ea-8cd6-d48d561fca20"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '3d3aa8f9-12af-441f-9344-9f31053e316d' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "3d3aa8f9-12af-441f-9344-9f31053e316d"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '440e2db4-bc7f-4c96-a068-65b78da59bde' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "440e2db4-bc7f-4c96-a068-65b78da59bde"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '4682fd2c-cfae-47ed-a543-9bed37657aa6' for fields: tags, related_integrations, data_source. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "4682fd2c-cfae-47ed-a543-9bed37657aa6"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '4bd1c1af-79d4-4d37-9efa-6e0240640242' for fields: tags, related_integrations, data_source. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "4bd1c1af-79d4-4d37-9efa-6e0240640242"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '6839c821-011d-43bd-bd5b-acff00257226' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "6839c821-011d-43bd-bd5b-acff00257226"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '69c251fb-a5d6-4035-b5ec-40438bd829ff' for fields: tags, related_integrations, data_source. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "69c251fb-a5d6-4035-b5ec-40438bd829ff"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '6a8ab9cc-4023-4d17-b5df-1a3e16882ce7' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "6a8ab9cc-4023-4d17-b5df-1a3e16882ce7"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '7405ddf1-6c8e-41ce-818f-48bea6bcaed8' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "7405ddf1-6c8e-41ce-818f-48bea6bcaed8"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '79f97b31-480e-4e63-a7f4-ede42bf2c6de' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "79f97b31-480e-4e63-a7f4-ede42bf2c6de"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '8b4f0816-6a65-4630-86a6-c21c179c0d09' for fields: tags, related_integrations, data_source. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "8b4f0816-6a65-4630-86a6-c21c179c0d09"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '93c1ce76-494c-4f01-8167-35edfb52f7b1' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "93c1ce76-494c-4f01-8167-35edfb52f7b1"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '9aa0e1f6-52ce-42e1-abb3-09657cee2698' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "9aa0e1f6-52ce-42e1-abb3-09657cee2698"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'acf738b5-b5b2-4acc-bad9-1e18ee234f40' for fields: tags, related_integrations, data_source. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "acf738b5-b5b2-4acc-bad9-1e18ee234f40"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'c0429aa8-9974-42da-bfb6-53a0a515a145' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "c0429aa8-9974-42da-bfb6-53a0a515a145"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'c3b915e0-22f3-4bf7-991d-b643513c722f' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "c3b915e0-22f3-4bf7-991d-b643513c722f"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'c4210e1c-64f2-4f48-b67e-b5a8ffe3aa14' for fields: tags, related_integrations, data_source. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "c4210e1c-64f2-4f48-b67e-b5a8ffe3aa14"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'dd34b062-b9e3-4a6b-8c0c-6c8ca6dd450e' for fields: tags, related_integrations, eql_query, data_source. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "dd34b062-b9e3-4a6b-8c0c-6c8ca6dd450e"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'ddab1f5f-7089-44f5-9fda-de5b11322e77' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "ddab1f5f-7089-44f5-9fda-de5b11322e77"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'e2e0537d-7d8f-4910-a11d-559bcf61295a' for fields: tags, related_integrations, data_source. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "e2e0537d-7d8f-4910-a11d-559bcf61295a"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'e2f9fdf5-8076-45ad-9427-41e0e03dc9c2' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "e2f9fdf5-8076-45ad-9427-41e0e03dc9c2"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'e514d8cd-ed15-4011-84e2-d15147e059f1' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "e514d8cd-ed15-4011-84e2-d15147e059f1"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'e86da94d-e54b-4fb5-b96c-cecff87e8787' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "e86da94d-e54b-4fb5-b96c-cecff87e8787"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'e94262f2-c1e9-4d3f-a907-aeab16712e1a' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "e94262f2-c1e9-4d3f-a907-aeab16712e1a"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'eb610e70-f9e6-4949-82b9-f1c5bcd37c39' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "eb610e70-f9e6-4949-82b9-f1c5bcd37c39"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'ebb200e8-adf0-43f8-a0bb-4ee5b5d852c6' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "ebb200e8-adf0-43f8-a0bb-4ee5b5d852c6"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'f2c7b914-eda3-40c2-96ac-d23ef91776ca' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "f2c7b914-eda3-40c2-96ac-d23ef91776ca"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'f494c678-3c33-43aa-b169-bb3d5198c41d' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "f494c678-3c33-43aa-b169-bb3d5198c41d"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'f63c8e3c-d396-404f-b2ea-0379d3942d73' for fields: tags, related_integrations, required_fields, eql_query, data_source. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "f63c8e3c-d396-404f-b2ea-0379d3942d73"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'f675872f-6d85-40a3-b502-c0d2ef101e92' for fields: tags, related_integrations, data_source. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "f675872f-6d85-40a3-b502-c0d2ef101e92"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'f81ee52c-297e-46d9-9205-07e66931df26' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "f81ee52c-297e-46d9-9205-07e66931df26"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '053a0387-f3b5-4ba5-8245-8002cca2bd08' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "053a0387-f3b5-4ba5-8245-8002cca2bd08"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '05b358de-aa6d-4f6c-89e6-78f74018b43b' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "05b358de-aa6d-4f6c-89e6-78f74018b43b"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '0f93cb9a-1931-48c2-8cd0-f173fd3e5283' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "0f93cb9a-1931-48c2-8cd0-f173fd3e5283"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '1d9aeb0b-9549-46f6-a32d-05e2a001b7fd' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "1d9aeb0b-9549-46f6-a32d-05e2a001b7fd"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '2e1e835d-01e5-48ca-b9fc-7a61f7f11902' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "2e1e835d-01e5-48ca-b9fc-7a61f7f11902"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '2f2f4939-0b34-40c2-a0a3-844eb7889f43' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "2f2f4939-0b34-40c2-a0a3-844eb7889f43"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '4ed678a9-3a4f-41fb-9fea-f85a6e0a0dff' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "4ed678a9-3a4f-41fb-9fea-f85a6e0a0dff"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '51176ed2-2d90-49f2-9f3d-17196428b169' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "51176ed2-2d90-49f2-9f3d-17196428b169"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '5a14d01d-7ac8-4545-914c-b687c2cf66b3' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "5a14d01d-7ac8-4545-914c-b687c2cf66b3"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '5aee924b-6ceb-4633-980e-1bde8cdb40c5' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "5aee924b-6ceb-4633-980e-1bde8cdb40c5"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '5cf6397e-eb91-4f31-8951-9f0eaa755a31' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "5cf6397e-eb91-4f31-8951-9f0eaa755a31"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '68d56fdc-7ffa-4419-8e95-81641bd6f845' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "68d56fdc-7ffa-4419-8e95-81641bd6f845"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '6cd1779c-560f-4b68-a8f1-11009b27fe63' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "6cd1779c-560f-4b68-a8f1-11009b27fe63"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '6d448b96-c922-4adb-b51c-b767f1ea5b76' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "6d448b96-c922-4adb-b51c-b767f1ea5b76"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '6e1a2cc4-d260-11ed-8829-f661ea17fbcc' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "6e1a2cc4-d260-11ed-8829-f661ea17fbcc"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '6e9130a5-9be6-48e5-943a-9628bfc74b18' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "6e9130a5-9be6-48e5-943a-9628bfc74b18"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '818e23e6-2094-4f0e-8c01-22d30f3506c6' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "818e23e6-2094-4f0e-8c01-22d30f3506c6"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '8b2b3a62-a598-4293-bc14-3d5fa22bb98f' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "8b2b3a62-a598-4293-bc14-3d5fa22bb98f"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '9a5b4e31-6cde-4295-9ff7-6be1b8567e1b' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "9a5b4e31-6cde-4295-9ff7-6be1b8567e1b"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '9c260313-c811-4ec8-ab89-8f6530e0246c' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "9c260313-c811-4ec8-ab89-8f6530e0246c"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '9ccf3ce0-0057-440a-91f5-870c6ad39093' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "9ccf3ce0-0057-440a-91f5-870c6ad39093"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'a1699af0-8e1e-4ed0-8ec1-89783538a061' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "a1699af0-8e1e-4ed0-8ec1-89783538a061"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'a2d04374-187c-4fd9-b513-3ad4e7fdd67a' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "a2d04374-187c-4fd9-b513-3ad4e7fdd67a"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'ad0d2742-9a49-11ec-8d6b-acde48001122' for fields: tags, related_integrations, eql_query, data_source. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "ad0d2742-9a49-11ec-8d6b-acde48001122"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'ad84d445-b1ce-4377-82d9-7c633f28bf9a' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "ad84d445-b1ce-4377-82d9-7c633f28bf9a"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'b90cdde7-7e0d-4359-8bf0-2c112ce2008a' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "b90cdde7-7e0d-4359-8bf0-2c112ce2008a"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'c57f8579-e2a5-4804-847f-f2732edc5156' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "c57f8579-e2a5-4804-847f-f2732edc5156"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'c5ce48a6-7f57-4ee8-9313-3d0024caee10' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "c5ce48a6-7f57-4ee8-9313-3d0024caee10"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'd563aaba-2e72-462b-8658-3e5ea22db3a6' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "d563aaba-2e72-462b-8658-3e5ea22db3a6"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'd703a5af-d5b0-43bd-8ddb-7a5d500b7da5' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "d703a5af-d5b0-43bd-8ddb-7a5d500b7da5"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'db7dbad5-08d2-4d25-b9b1-d3a1e4a15efd' for fields: tags, related_integrations, required_fields, eql_query, data_source. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "db7dbad5-08d2-4d25-b9b1-d3a1e4a15efd"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'e0881d20-54ac-457f-8733-fe0bc5d44c55' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "e0881d20-54ac-457f-8733-fe0bc5d44c55"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'f44fa4b6-524c-4e87-8d9e-a32599e4fb7c' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "f44fa4b6-524c-4e87-8d9e-a32599e4fb7c"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'fc7c0fa4-8f03-4b3e-8336-c5feab0be022' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "fc7c0fa4-8f03-4b3e-8336-c5feab0be022"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '027ff9ea-85e7-42e3-99d2-bbb7069e02eb' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "027ff9ea-85e7-42e3-99d2-bbb7069e02eb"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '0859355c-0f08-4b43-8ff5-7d2a4789fc08' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "0859355c-0f08-4b43-8ff5-7d2a4789fc08"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '0b29cab4-dbbd-4a3f-9e8e-1287c7c11ae5' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "0b29cab4-dbbd-4a3f-9e8e-1287c7c11ae5"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '1224da6c-0326-4b4f-8454-68cdc5ae542b' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "1224da6c-0326-4b4f-8454-68cdc5ae542b"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '17c7f6a5-5bc9-4e1f-92bf-13632d24384d' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "17c7f6a5-5bc9-4e1f-92bf-13632d24384d"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '2c3c29a4-f170-42f8-a3d8-2ceebc18eb6a' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "2c3c29a4-f170-42f8-a3d8-2ceebc18eb6a"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '397945f3-d39a-4e6f-8bcb-9656c2031438' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "397945f3-d39a-4e6f-8bcb-9656c2031438"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '3e0eeb75-16e8-4f2f-9826-62461ca128b7' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "3e0eeb75-16e8-4f2f-9826-62461ca128b7"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '40155ee4-1e6a-4e4d-a63b-e8ba16980cfb' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "40155ee4-1e6a-4e4d-a63b-e8ba16980cfb"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '45ac4800-840f-414c-b221-53dd36a5aaf7' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "45ac4800-840f-414c-b221-53dd36a5aaf7"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '4c59cff1-b78a-41b8-a9f1-4231984d1fb6' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "4c59cff1-b78a-41b8-a9f1-4231984d1fb6"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '56004189-4e69-4a39-b4a9-195329d226e9' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "56004189-4e69-4a39-b4a9-195329d226e9"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '62a70f6f-3c37-43df-a556-f64fa475fba2' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "62a70f6f-3c37-43df-a556-f64fa475fba2"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '665e7a4f-c58e-4fc6-bc83-87a7572670ac' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "665e7a4f-c58e-4fc6-bc83-87a7572670ac"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '6e40d56f-5c0e-4ac6-aece-bee96645b172' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "6e40d56f-5c0e-4ac6-aece-bee96645b172"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '846fe13f-6772-4c83-bd39-9d16d4ad1a81' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "846fe13f-6772-4c83-bd39-9d16d4ad1a81"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'a3ea12f3-0d4e-4667-8b44-4230c63f3c75' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "a3ea12f3-0d4e-4667-8b44-4230c63f3c75"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'b8386923-b02c-4b94-986a-d223d9b01f88' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "b8386923-b02c-4b94-986a-d223d9b01f88"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'bdfebe11-e169-42e3-b344-c5d2015533d3' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "bdfebe11-e169-42e3-b344-c5d2015533d3"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'c4818812-d44f-47be-aaef-4cfb2f9cc799' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "c4818812-d44f-47be-aaef-4cfb2f9cc799"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'ea09ff26-3902-4c53-bb8e-24b7a5d029dd' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "ea09ff26-3902-4c53-bb8e-24b7a5d029dd"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'f5861570-e39a-4b8a-9259-abd39f84cb97' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "f5861570-e39a-4b8a-9259-abd39f84cb97"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'f5d9d36d-7c30-4cdb-a856-9f653c13d4e0' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "f5d9d36d-7c30-4cdb-a856-9f653c13d4e0"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'fddff193-48a3-484d-8d35-90bb3d323a56' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "fddff193-48a3-484d-8d35-90bb3d323a56"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'fe25d5bc-01fa-494a-95ff-535c29cc4c96' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "fe25d5bc-01fa-494a-95ff-535c29cc4c96"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '1781d055-5c66-4adf-9c59-fc0fa58336a5' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "1781d055-5c66-4adf-9c59-fc0fa58336a5"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '1781d055-5c66-4adf-9c71-fc0fa58338c7' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "1781d055-5c66-4adf-9c71-fc0fa58338c7"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '1781d055-5c66-4adf-9d60-fc0fa58337b6' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "1781d055-5c66-4adf-9d60-fc0fa58337b6"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '1781d055-5c66-4adf-9d82-fc0fa58449c8' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "1781d055-5c66-4adf-9d82-fc0fa58449c8"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '1781d055-5c66-4adf-9e93-fc0fa69550c9' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "1781d055-5c66-4adf-9e93-fc0fa69550c9"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '220be143-5c67-4fdb-b6ce-dd6826d024fd' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "220be143-5c67-4fdb-b6ce-dd6826d024fd"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '445a342e-03fb-42d0-8656-0367eb2dead5' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "445a342e-03fb-42d0-8656-0367eb2dead5"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '56557cde-d923-4b88-adee-c61b3f3b5dc3' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "56557cde-d923-4b88-adee-c61b3f3b5dc3"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '577ec21e-56fe-4065-91d8-45eb8224fe77' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "577ec21e-56fe-4065-91d8-45eb8224fe77"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '959a7353-1129-4aa7-9084-30746b256a70' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "959a7353-1129-4aa7-9084-30746b256a70"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'abae61a8-c560-4dbd-acca-1e1438bff36b' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "abae61a8-c560-4dbd-acca-1e1438bff36b"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'ac96ceb8-4399-4191-af1d-4feeac1f1f46' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "ac96ceb8-4399-4191-af1d-4feeac1f1f46"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'ae8a142c-6a1d-4918-bea7-0b617e99ecfa' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "ae8a142c-6a1d-4918-bea7-0b617e99ecfa"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'b2318c71-5959-469a-a3ce-3a0768e63b9c' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "b2318c71-5959-469a-a3ce-3a0768e63b9c"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'ba342eb2-583c-439f-b04d-1fdd7c1417cc' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "ba342eb2-583c-439f-b04d-1fdd7c1417cc"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'daafdf96-e7b1-4f14-b494-27e0d24b11f6' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "daafdf96-e7b1-4f14-b494-27e0d24b11f6"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'df197323-72a8-46a9-a08e-3f5b04a4a97a' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "df197323-72a8-46a9-a08e-3f5b04a4a97a"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'eb44611f-62a8-4036-a5ef-587098be6c43' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "eb44611f-62a8-4036-a5ef-587098be6c43"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'f580bf0a-2d23-43bb-b8e1-17548bb947ec' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "f580bf0a-2d23-43bb-b8e1-17548bb947ec"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'feeed87c-5e95-4339-aef1-47fd79bcfbe3' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "feeed87c-5e95-4339-aef1-47fd79bcfbe3"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '1397e1b9-0c90-4d24-8d7b-80598eb9bc9a' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "1397e1b9-0c90-4d24-8d7b-80598eb9bc9a"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'dca6b4b0-ae70-44eb-bb7a-ce6db502ee78' for fields: tags, related_integrations, eql_query, data_source. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "dca6b4b0-ae70-44eb-bb7a-ce6db502ee78"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'e468f3f6-7c4c-45bb-846a-053738b3fe5d' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "e468f3f6-7c4c-45bb-846a-053738b3fe5d"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '12de29d4-bbb0-4eef-b687-857e8a163870' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "12de29d4-bbb0-4eef-b687-857e8a163870"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '2553a9af-52a4-4a05-bb03-85b2a479a0a0' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "2553a9af-52a4-4a05-bb03-85b2a479a0a0"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '3d00feab-e203-4acc-a463-c3e15b7e9a73' for fields: tags, related_integrations, data_source. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "3d00feab-e203-4acc-a463-c3e15b7e9a73"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '57bfa0a9-37c0-44d6-b724-54bf16787492' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "57bfa0a9-37c0-44d6-b724-54bf16787492"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '5f2f463e-6997-478c-8405-fb41cc283281' for fields: tags, related_integrations, data_source. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "5f2f463e-6997-478c-8405-fb41cc283281"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '730ed57d-ae0f-444f-af50-78708b57edd5' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "730ed57d-ae0f-444f-af50-78708b57edd5"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '951779c2-82ad-4a6c-82b8-296c1f691449' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "951779c2-82ad-4a6c-82b8-296c1f691449"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'b661f86d-1c23-4ce7-a59e-2edbdba28247' for fields: tags, related_integrations, data_source. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "b661f86d-1c23-4ce7-a59e-2edbdba28247"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'd93e61db-82d6-4095-99aa-714988118064' for fields: tags, related_integrations, data_source. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "d93e61db-82d6-4095-99aa-714988118064"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'db65f5ba-d1ef-4944-b9e8-7e51060c2b42' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "db65f5ba-d1ef-4944-b9e8-7e51060c2b42"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'dffbd37c-d4c5-46f8-9181-5afdd9172b4c' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "dffbd37c-d4c5-46f8-9181-5afdd9172b4c"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'f8822053-a5d2-46db-8c96-d460b12c36ac' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "f8822053-a5d2-46db-8c96-d460b12c36ac"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '205b52c4-9c28-4af4-8979-935f3278d61a' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "205b52c4-9c28-4af4-8979-935f3278d61a"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '5c602cba-ae00-4488-845d-24de2b6d8055' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "5c602cba-ae00-4488-845d-24de2b6d8055"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule '8025db49-c57c-4fc0-bd86-7ccd6d10a35a' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "8025db49-c57c-4fc0-bd86-7ccd6d10a35a"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'b0638186-4f12-48ac-83d2-47e686d08e82' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "b0638186-4f12-48ac-83d2-47e686d08e82"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'f97504ac-1053-498f-aeaa-c6d01e76b379' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "f97504ac-1053-498f-aeaa-c6d01e76b379"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'ac5a2759-5c34-440a-b0c4-51fe674611d6' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "ac5a2759-5c34-440a-b0c4-51fe674611d6"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'c124dc1b-cef2-4d01-8d74-ff6b0d5096b6' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "c124dc1b-cef2-4d01-8d74-ff6b0d5096b6"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'e760c72b-bb1f-44f0-9f0d-37d51744ee75' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "e760c72b-bb1f-44f0-9f0d-37d51744ee75"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'ff6cf8b9-b76c-4cc1-ac1b-4935164d1029' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "ff6cf8b9-b76c-4cc1-ac1b-4935164d1029"
        }
      ]
    },
    {
      "message": "Merge conflicts found in rule 'f909075d-afc7-42d7-b399-600b94352fd9' for fields: related_integrations. Please resolve the conflict manually or choose another value for 'pick_version'",
      "rules": [
        {
          "rule_id": "f909075d-afc7-42d7-b399-600b94352fd9"
        }
      ]
    }
  ]
}