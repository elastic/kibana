{
  "summary": {
    "total": 383,
    "skipped": 0,
    "succeeded": 382,
    "failed": 1
  },
  "results": {
    "updated": [
      {
        "name": "PowerShell Suspicious Script with Audio Capture Capabilities",
        "description": "Detects PowerShell scripts that can record audio, a common feature in popular post-exploitation tooling.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating PowerShell Suspicious Script with Audio Capture Capabilities\n\nPowerShell is one of the main tools system administrators use for automation, report routines, and other tasks. This makes it available for use in various environments, and creates an attractive way for attackers to execute code.\n\nAttackers can use PowerShell to interact with the Windows API with the intent of capturing audio from input devices connected to the victim's computer.\n\n#### Possible investigation steps\n\n- Examine the script content that triggered the detection; look for suspicious DLL imports, collection or exfiltration capabilities, suspicious functions, encoded or compressed data, and other potentially malicious characteristics.\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Examine file or network events from the involved PowerShell process for suspicious behavior.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Evaluate whether the user needs to use PowerShell to complete tasks.\n- Investigate if the script stores the recorded data locally and determine if anything was recorded.\n- Investigate whether the script contains exfiltration capabilities and identify the exfiltration server.\n- Assess network data to determine if the host communicated with the exfiltration server.\n\n### False positive analysis\n\n- Regular users should not need scripts to capture audio, which makes false positives unlikely. In the case of authorized benign true positives (B-TPs), exceptions can be added.\n\n### Related rules\n\n- PowerShell PSReflect Script - 56f2e9b5-4803-4e44-a0a4-a52dc79d57fe\n- Potential Process Injection via PowerShell - 2e29e96a-b67c-455a-afe4-de6183431d0d\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Prioritize the response if this alert involves key executives or potentially valuable targets for espionage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Restrict PowerShell usage outside of IT and engineering business units using GPOs, AppLocker, Intune, or similar software.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 212,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Collection",
          "Resources: Investigation Guide",
          "Data Source: PowerShell Logs"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/PowerShellMafia/PowerSploit/blob/master/Exfiltration/Get-MicrophoneAudio.ps1"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0009",
              "name": "Collection",
              "reference": "https://attack.mitre.org/tactics/TA0009/"
            },
            "technique": [
              {
                "id": "T1123",
                "name": "Audio Capture",
                "reference": "https://attack.mitre.org/techniques/T1123/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              },
              {
                "id": "T1106",
                "name": "Native API",
                "reference": "https://attack.mitre.org/techniques/T1106/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'PowerShell Script Block Logging' logging policy must be enabled.\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nAdministrative Templates >\nWindows PowerShell >\nTurn on PowerShell Script Block Logging (Enable)\n```\n\nSteps to implement the logging policy via registry:\n\n```\nreg add \"hklm\\SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\ScriptBlockLogging\" /v EnableScriptBlockLogging /t REG_DWORD /d 1\n```\n",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "powershell.file.script_block_text",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "e8dc4b5a-bf71-4d72-b364-c4ad4e3e135c",
        "rule_id": "2f2f4939-0b34-40c2-a0a3-844eb7889f43",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:55.015Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:25.619Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-windows.powershell*"
        ],
        "filters": [],
        "query": "event.category:process and host.os.type:windows and\n  powershell.file.script_block_text : (\n    \"Get-MicrophoneAudio\" or\n    \"WindowsAudioDevice-Powershell-Cmdlet\" or\n    (waveInGetNumDevs and mciSendStringA)\n  )\n  and not powershell.file.script_block_text : (\n    \"sentinelbreakpoints\" and \"Set-PSBreakpoint\" and \"PowerSploitIndicators\"\n  )\n  and not user.id : \"S-1-5-18\"",
        "language": "kuery"
      },
      {
        "name": "Potential Process Injection via PowerShell",
        "description": "Detects the use of Windows API functions that are commonly abused by malware and security tools to load malicious code or inject it into remote processes.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Potential Process Injection via PowerShell\n\nPowerShell is one of the main tools system administrators use for automation, report routines, and other tasks. This makes it available for use in various environments, and creates an attractive way for attackers to execute code.\n\nPowerShell also has solid capabilities to make the interaction with the Win32 API in an uncomplicated and reliable way, like the execution of inline C# code, PSReflect, Get-ProcAddress, etc.\n\nRed Team tooling and malware developers take advantage of these capabilities to develop stagers and loaders that inject payloads directly into the memory without touching the disk to circumvent file-based security protections.\n\n#### Possible investigation steps\n\n- Examine the script content that triggered the detection; look for suspicious DLL imports, collection or exfiltration capabilities, suspicious functions, encoded or compressed data, and other potentially malicious characteristics.\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Examine file or network events from the involved PowerShell process for suspicious behavior.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Evaluate whether the user needs to use PowerShell to complete tasks.\n- Check if the imported function was executed and which process it targeted.\n- Check if the injected code can be retrieved (hardcoded in the script or on command line logs).\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Related rules\n\n- PowerShell PSReflect Script - 56f2e9b5-4803-4e44-a0a4-a52dc79d57fe\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Restrict PowerShell usage outside of IT and engineering business units using GPOs, AppLocker, Intune, or similar software.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 213,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Tactic: Execution",
          "Resources: Investigation Guide",
          "Data Source: PowerShell Logs"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Legitimate PowerShell scripts that make use of these functions."
        ],
        "references": [
          "https://github.com/EmpireProject/Empire/blob/master/data/module_source/management/Invoke-PSInject.ps1",
          "https://github.com/EmpireProject/Empire/blob/master/data/module_source/management/Invoke-ReflectivePEInjection.ps1",
          "https://github.com/BC-SECURITY/Empire/blob/master/empire/server/data/module_source/credentials/Invoke-Mimikatz.ps1",
          "https://www.elastic.co/security-labs/detect-credential-access"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1055",
                "name": "Process Injection",
                "reference": "https://attack.mitre.org/techniques/T1055/",
                "subtechnique": [
                  {
                    "id": "T1055.001",
                    "name": "Dynamic-link Library Injection",
                    "reference": "https://attack.mitre.org/techniques/T1055/001/"
                  },
                  {
                    "id": "T1055.002",
                    "name": "Portable Executable Injection",
                    "reference": "https://attack.mitre.org/techniques/T1055/002/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              },
              {
                "id": "T1106",
                "name": "Native API",
                "reference": "https://attack.mitre.org/techniques/T1106/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'PowerShell Script Block Logging' logging policy must be enabled.\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nAdministrative Templates >\nWindows PowerShell >\nTurn on PowerShell Script Block Logging (Enable)\n```\n\nSteps to implement the logging policy via registry:\n\n```\nreg add \"hklm\\SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\ScriptBlockLogging\" /v EnableScriptBlockLogging /t REG_DWORD /d 1\n```\n",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.directory",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "powershell.file.script_block_text",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "6e493be2-1a00-4c73-8a84-76ed5f2a5930",
        "rule_id": "2e29e96a-b67c-455a-afe4-de6183431d0d",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:55.019Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:25.609Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-windows.powershell*"
        ],
        "filters": [],
        "query": "event.category:process and host.os.type:windows and\n  powershell.file.script_block_text : (\n   (VirtualAlloc or VirtualAllocEx or VirtualProtect or LdrLoadDll or LoadLibrary or LoadLibraryA or\n      LoadLibraryEx or GetProcAddress or OpenProcess or OpenProcessToken or AdjustTokenPrivileges) and\n   (WriteProcessMemory or CreateRemoteThread or NtCreateThreadEx or CreateThread or QueueUserAPC or\n      SuspendThread or ResumeThread or GetDelegateForFunctionPointer)\n  ) and not \n  file.directory: (\n    \"C:\\ProgramData\\Microsoft\\Windows Defender Advanced Threat Protection\\SenseCM\" or\n    \"C:\\ProgramData\\Microsoft\\Windows Defender Advanced Threat Protection\\Downloads\"\n  )",
        "language": "kuery"
      },
      {
        "name": "Enumeration of Privileged Local Groups Membership",
        "description": "Identifies instances of an unusual process enumerating built-in Windows privileged local groups membership like Administrators or Remote Desktop users.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Enumeration of Privileged Local Groups Membership\n\nAfter successfully compromising an environment, attackers may try to gain situational awareness to plan their next steps. This can happen by running commands to enumerate network resources, users, connections, files, and installed security software.\n\nThis rule looks for the enumeration of privileged local groups' membership by suspicious processes, and excludes known legitimate utilities and programs installed. Attackers can use this information to decide the next steps of the attack, such as mapping targets for credential compromise and other post-exploitation activities.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Identify the process, host and user involved on the event.\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate any abnormal account behavior, such as command executions, file creations or modifications, and network connections.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the process executable using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n### False positive analysis\n\n- Discovery activities are not inherently malicious if they occur in isolation. As long as the analyst did not identify suspicious activity related to the user or host, such alerts can be dismissed.\n- If this rule is noisy in your environment due to expected activity, consider adding exceptions â€” preferably with a combination of user and command line conditions.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 415,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Resources: Investigation Guide",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1069",
                "name": "Permission Groups Discovery",
                "reference": "https://attack.mitre.org/techniques/T1069/",
                "subtechnique": [
                  {
                    "id": "T1069.001",
                    "name": "Local Groups",
                    "reference": "https://attack.mitre.org/techniques/T1069/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'Audit Security Group Management' audit policy must be configured (Success).\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nPolicies >\nWindows Settings >\nSecurity Settings >\nAdvanced Audit Policies Configuration >\nAudit Policies >\nAccount Management >\nAudit Security Group Management (Success)\n```\n\nMicrosoft introduced the [event used](https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4799) in this detection rule on Windows 10 and Windows Server 2016 or later operating systems.\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "group.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.event_data.CallerProcessName",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "winlog.event_data.SubjectUserName",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "winlog.event_data.SubjectUserSid",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "winlog.event_data.TargetSid",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "d662a783-c26a-4728-89fc-52b2b470eee7",
        "rule_id": "291a0de9-937a-4189-94c0-3e847c8b13e4",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:55.022Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:25.557Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "host.os.type:windows and event.category:iam and event.action:user-member-enumerated and \n  (\n    group.name:(*Admin* or \"RemoteDesktopUsers\") or\n    winlog.event_data.TargetSid:(\"S-1-5-32-544\" or \"S-1-5-32-555\")\n  ) and \n  not (\n    winlog.event_data.SubjectUserName: *$ or\n    winlog.event_data.SubjectUserSid: (\"S-1-5-19\" or \"S-1-5-20\") or \n    winlog.event_data.CallerProcessName:(\"-\" or \n                                       C\\:\\\\Windows\\\\System32\\\\VSSVC.exe or \n                                       C\\:\\\\Windows\\\\System32\\\\SearchIndexer.exe or \n                                       C\\:\\\\Windows\\\\System32\\\\CompatTelRunner.exe or \n                                       C\\:\\\\Windows\\\\System32\\\\oobe\\\\msoobe.exe or\n                                       C\\:\\\\Windows\\\\System32\\\\net1.exe or \n                                       C\\:\\\\Windows\\\\System32\\\\svchost.exe or \n                                       C\\:\\\\Windows\\\\System32\\\\Netplwiz.exe or \n                                       C\\:\\\\Windows\\\\System32\\\\msiexec.exe or\n                                       C\\:\\\\Windows\\\\System32\\\\CloudExperienceHostBroker.exe or\n                                       C\\:\\\\Windows\\\\System32\\\\RuntimeBroker.exe or\n                                       C\\:\\\\Windows\\\\System32\\\\wbem\\\\WmiPrvSE.exe or\n                                       C\\:\\\\Windows\\\\System32\\\\SrTasks.exe or\n                                       C\\:\\\\Windows\\\\System32\\\\diskshadow.exe or\n                                       C\\:\\\\Windows\\\\System32\\\\dfsrs.exe or\n                                       C\\:\\\\Windows\\\\System32\\\\vssadmin.exe or\n                                       C\\:\\\\Windows\\\\System32\\\\dllhost.exe or\n                                       C\\:\\\\Windows\\\\System32\\\\mmc.exe or\n                                       C\\:\\\\Windows\\\\System32\\\\SettingSyncHost.exe or\n                                       C\\:\\\\Windows\\\\System32\\\\inetsrv\\\\w3wp.exe or\n                                       C\\:\\\\Windows\\\\System32\\\\wsmprovhost.exe or\n                                       C\\:\\\\Windows\\\\System32\\\\mstsc.exe or\n                                       C\\:\\\\Windows\\\\System32\\\\esentutl.exe or\n                                       C\\:\\\\Windows\\\\System32\\\\RecoveryDrive.exe or\n                                       C\\:\\\\Windows\\\\System32\\\\SystemPropertiesComputerName.exe or\n                                       C\\:\\\\Windows\\\\SysWOW64\\\\msiexec.exe or\n                                       C\\:\\\\Windows\\\\System32\\\\taskhostw.exe or\n                                       C\\:\\\\Windows\\\\ImmersiveControlPanel\\\\SystemSettings.exe or\n                                       C\\:\\\\Windows\\\\Temp\\\\rubrik_vmware*\\\\snaptool.exe or\n                                       C\\:\\\\Windows\\\\VeeamVssSupport\\\\VeeamGuestHelper.exe or\n                                       C\\:\\\\WindowsAzure\\\\*WaAppAgent.exe or\n                                       C\\:\\\\$WINDOWS.~BT\\\\Sources\\\\*.exe\n                                      )\n  )",
        "new_terms_fields": [
          "host.id",
          "winlog.event_data.SubjectUserName",
          "winlog.event_data.CallerProcessName"
        ],
        "history_window_start": "now-14d",
        "index": [
          "winlogbeat-*",
          "logs-system.*",
          "logs-windows.*"
        ],
        "filters": [
          {
            "meta": {
              "negate": true
            },
            "query": {
              "wildcard": {
                "winlog.event_data.CallerProcessName": {
                  "case_insensitive": true,
                  "value": "C:\\\\Program Files (x86)\\\\*.exe"
                }
              }
            }
          },
          {
            "meta": {
              "negate": true
            },
            "query": {
              "wildcard": {
                "winlog.event_data.CallerProcessName": {
                  "case_insensitive": true,
                  "value": "C:\\\\Program Files\\\\*.exe"
                }
              }
            }
          }
        ],
        "language": "kuery"
      },
      {
        "name": "Web Shell Detection: Script Process Child of Common Web Processes",
        "description": "Identifies suspicious commands executed via a web server, which may suggest a vulnerability and remote shell access.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Web Shell Detection: Script Process Child of Common Web Processes\n\nAdversaries may backdoor web servers with web shells to establish persistent access to systems. A web shell is a web script that is placed on an openly accessible web server to allow an adversary to use the web server as a gateway into a network. A web shell may provide a set of functions to execute or a command-line interface on the system that hosts the web server.\n\nThis rule detects a web server process spawning script and command-line interface programs, potentially indicating attackers executing commands using the web shell.\n\n#### Possible investigation steps\n\n- Investigate abnormal behaviors observed by the subject process such as network connections, registry or file modifications, and any other spawned child processes.\n- Examine the command line to determine which commands or scripts were executed.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n- If scripts or executables were dropped, retrieve the files and determine if they are malicious:\n  - Use a private sandboxed malware analysis system to perform analysis.\n    - Observe and collect information about the following activities:\n      - Attempts to contact external domains and addresses.\n      - File and registry access, modification, and creation activities.\n      - Service creation and launch activities.\n      - Scheduled task creation.\n  - Use the PowerShell Get-FileHash cmdlet to get the files' SHA-256 hash values.\n    - Search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Any activity that triggered the alert and is not inherently malicious must be monitored by the security team.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 416,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Tactic: Initial Access",
          "Tactic: Execution",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: SentinelOne",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Security audits, maintenance, and network administrative scripts may trigger this alert when run under web processes."
        ],
        "references": [
          "https://www.microsoft.com/security/blog/2020/02/04/ghost-in-the-shell-investigating-web-shell-attacks/",
          "https://www.elastic.co/security-labs/elastic-response-to-the-the-spring4shell-vulnerability-cve-2022-22965",
          "https://www.elastic.co/security-labs/hunting-for-persistence-using-elastic-security-part-1"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1505",
                "name": "Server Software Component",
                "reference": "https://attack.mitre.org/techniques/T1505/",
                "subtechnique": [
                  {
                    "id": "T1505.003",
                    "name": "Web Shell",
                    "reference": "https://attack.mitre.org/techniques/T1505/003/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1190",
                "name": "Exploit Public-Facing Application",
                "reference": "https://attack.mitre.org/techniques/T1190/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  },
                  {
                    "id": "T1059.003",
                    "name": "Windows Command Shell",
                    "reference": "https://attack.mitre.org/techniques/T1059/003/"
                  },
                  {
                    "id": "T1059.005",
                    "name": "Visual Basic",
                    "reference": "https://attack.mitre.org/techniques/T1059/005/"
                  }
                ]
              },
              {
                "id": "T1047",
                "name": "Windows Management Instrumentation",
                "reference": "https://attack.mitre.org/techniques/T1047/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "17b3163c-ecfe-4f9b-8b0a-d188f1306a40",
        "rule_id": "2917d495-59bd-4250-b395-c29409b76086",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:55.025Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:25.551Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.parent.name : (\"w3wp.exe\", \"httpd.exe\", \"nginx.exe\", \"php.exe\", \"php-cgi.exe\", \"tomcat.exe\") and\n  process.name : (\"cmd.exe\", \"cscript.exe\", \"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\", \"wmic.exe\", \"wscript.exe\") and\n  not\n  (\n    process.parent.name : (\"php.exe\", \"httpd.exe\") and process.name : \"cmd.exe\" and\n    process.command_line : (\n      \"cmd.exe /c mode CON\",\n      \"cmd.exe /s /c \\\"mode CON\\\"\",\n      \"cmd.exe /c \\\"mode\\\"\",\n      \"cmd.exe /s /c \\\"tput colors 2>&1\\\"\"\n    )\n  )",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-m365_defender.event-*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "UAC Bypass Attempt via Windows Directory Masquerading",
        "description": "Identifies an attempt to bypass User Account Control (UAC) by masquerading as a Microsoft trusted Windows directory. Attackers may bypass UAC to stealthily execute code with elevated permissions.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating UAC Bypass Attempt via Windows Directory Masquerading\n\nWindows User Account Control (UAC) allows a program to elevate its privileges (tracked as low to high integrity levels) to perform a task under administrator-level permissions, possibly by prompting the user for confirmation. UAC can deny an operation under high-integrity enforcement, or allow the user to perform the action if they are in the local administrators group and enter an administrator password when prompted.\n\nFor more information about the UAC and how it works, check the [official Microsoft docs page](https://docs.microsoft.com/en-us/windows/security/identity-protection/user-account-control/how-user-account-control-works).\n\nThis rule identifies an attempt to bypass User Account Control (UAC) by masquerading as a Microsoft trusted Windows directory. Attackers may bypass UAC to stealthily execute code with elevated permissions.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Inspect the host for suspicious or abnormal behavior in the alert timeframe.\n- Investigate any abnormal behavior by the subject process such as network connections, registry or file modifications, and any spawned child processes.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze any suspicious spawned processes using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 315,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Tactic: Defense Evasion",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://medium.com/tenable-techblog/uac-bypass-by-mocking-trusted-directories-24a96675f6e"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1548",
                "name": "Abuse Elevation Control Mechanism",
                "reference": "https://attack.mitre.org/techniques/T1548/",
                "subtechnique": [
                  {
                    "id": "T1548.002",
                    "name": "Bypass User Account Control",
                    "reference": "https://attack.mitre.org/techniques/T1548/002/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1036",
                "name": "Masquerading",
                "reference": "https://attack.mitre.org/techniques/T1036/",
                "subtechnique": [
                  {
                    "id": "T1036.005",
                    "name": "Match Legitimate Name or Location",
                    "reference": "https://attack.mitre.org/techniques/T1036/005/"
                  }
                ]
              },
              {
                "id": "T1548",
                "name": "Abuse Elevation Control Mechanism",
                "reference": "https://attack.mitre.org/techniques/T1548/",
                "subtechnique": [
                  {
                    "id": "T1548.002",
                    "name": "Bypass User Account Control",
                    "reference": "https://attack.mitre.org/techniques/T1548/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "6a98b1cd-d89a-4543-89d8-b615fe0b9d19",
        "rule_id": "290aca65-e94d-403b-ba0f-62f320e63f51",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:55.028Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:25.546Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.args : (\"C:\\\\Windows \\\\system32\\\\*.exe\", \"C:\\\\Windows \\\\SysWOW64\\\\*.exe\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Windows Defender Exclusions Added via PowerShell",
        "description": "Identifies modifications to the Windows Defender configuration settings using PowerShell to add exclusions at the folder directory or process level.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Windows Defender Exclusions Added via PowerShell\n\nMicrosoft Windows Defender is an antivirus product built into Microsoft Windows. Since this software product is used to prevent and stop malware, it's important to monitor what specific exclusions are made to the product's configuration settings. These can often be signs of an adversary or malware trying to bypass Windows Defender's capabilities. One of the more notable [examples](https://www.cyberbit.com/blog/endpoint-security/latest-trickbot-variant-has-new-tricks-up-its-sleeve/) was observed in 2018 where Trickbot incorporated mechanisms to disable Windows Defender to avoid detection.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Examine the exclusion in order to determine the intent behind it.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n- If the exclusion specifies a suspicious file or path, retrieve the file(s) and determine if malicious:\n  - Use a private sandboxed malware analysis system to perform analysis.\n    - Observe and collect information about the following activities:\n      - Attempts to contact external domains and addresses.\n      - File and registry access, modification, and creation activities.\n      - Service creation and launch activities.\n      - Scheduled task creation.\n  - Use the PowerShell Get-FileHash cmdlet to get the files' SHA-256 hash values.\n    - Search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n\n### False positive analysis\n\n- This rule has a high chance to produce false positives due to how often network administrators legitimately configure exclusions. In order to validate the activity further, review the specific exclusion and its intent. There are many legitimate reasons for exclusions, so it's important to gain context.\n\n### Related rules\n\n- Windows Defender Disabled via Registry Modification - 2ffa1f1e-b6db-47fa-994b-1512743847eb\n- Disabling Windows Defender Security Settings via PowerShell - c8cccb06-faf2-4cd5-886e-2c9636cfcb87\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Exclusion lists for antimalware capabilities should always be routinely monitored for review.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 313,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.bitdefender.com/files/News/CaseStudies/study/400/Bitdefender-PR-Whitepaper-MosaicLoader-creat5540-en-EN.pdf",
          "https://www.elastic.co/security-labs/elastic-security-uncovers-blister-malware-campaign",
          "https://www.elastic.co/security-labs/operation-bleeding-bear",
          "https://www.elastic.co/security-labs/invisible-miners-unveiling-ghostengine"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.001",
                    "name": "Disable or Modify Tools",
                    "reference": "https://attack.mitre.org/techniques/T1562/001/"
                  },
                  {
                    "id": "T1562.006",
                    "name": "Indicator Blocking",
                    "reference": "https://attack.mitre.org/techniques/T1562/006/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "631e2755-d785-47a8-a3c5-8ed378925753",
        "rule_id": "2c17e5d7-08b9-43b2-b58a-0270d65ac85b",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:55.040Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:25.575Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n (process.name : (\"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\") or ?process.pe.original_file_name in (\"powershell.exe\", \"pwsh.dll\", \"powershell_ise.exe\")) and\n  process.args : (\"*Add-MpPreference*\", \"*Set-MpPreference*\") and\n  process.args : (\"*-Exclusion*\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Potential Foxmail Exploitation",
        "description": "Identifies the Foxmail client spawning a child process with argument pointing to the Foxmail temp directory. This may indicate the successful exploitation of a Foxmail vulnerability for initial access and execution via a malicious email.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 202,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Initial Access",
          "Tactic: Execution",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: System",
          "Data Source: Elastic Endgame",
          "Data Source: SentinelOne",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://mp.weixin.qq.com/s/F8hNyESBdKhwXkQPgtGpew"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1203",
                "name": "Exploitation for Client Execution",
                "reference": "https://attack.mitre.org/techniques/T1203/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1189",
                "name": "Drive-by Compromise",
                "reference": "https://attack.mitre.org/techniques/T1189/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "e9bd297c-92af-4045-b57b-4a4b9283244f",
        "rule_id": "2c6a6acf-0dcb-404d-89fb-6b0327294cfa",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:55.056Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:25.585Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and \n process.parent.name : \"Foxmail.exe\" and process.args : (\"?:\\\\Users\\\\*\\\\AppData\\\\*\", \"\\\\\\\\*\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-windows.*",
          "endgame-*",
          "logs-system.security*",
          "logs-windows.sysmon_operational-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-m365_defender.event-*",
          "logs-endpoint.events.process-*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "NTDS or SAM Database File Copied",
        "description": "Identifies a copy operation of the Active Directory Domain Database (ntds.dit) or Security Account Manager (SAM) files. Those files contain sensitive information including hashed domain and/or local credentials.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating NTDS or SAM Database File Copied\n\nThe Active Directory Domain Database (ntds.dit) and Security Account Manager (SAM) files are critical components in Windows environments, containing sensitive information such as hashed domain and local credentials.\n\nThis rule identifies copy operations of these files using specific command-line tools, such as Cmd.Exe, PowerShell.EXE, XCOPY.EXE, and esentutl.exe. By monitoring for the presence of these tools and their associated arguments, the rule aims to detect potential credential access activities.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, command lines, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Check for any recent changes in user account privileges or group memberships that may have allowed the unauthorized access.\n- Determine whether the file was potentially exfiltrated from the subject host.\n- Scope compromised credentials and disable the accounts.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the process executable using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process's `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Look for the presence of relevant artifacts on other systems. Identify commonalities and differences between potentially compromised systems.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and Remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n  - If malicious activity is confirmed, perform a broader investigation to identify the scope of the compromise and determine the appropriate remediation steps.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Restore the affected system to its operational state by applying any necessary patches, updates, or configuration changes.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 315,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: SentinelOne",
          "Data Source: Sysmon",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic",
          "Austin Songer"
        ],
        "false_positives": [],
        "references": [
          "https://thedfirreport.com/2020/11/23/pysa-mespinoza-ransomware/",
          "https://github.com/redcanaryco/atomic-red-team/blob/master/atomics/T1003.002/T1003.002.md#atomic-test-3---esentutlexe-sam-copy",
          "https://www.elastic.co/security-labs/detect-credential-access",
          "https://www.elastic.co/security-labs/siestagraph-new-implant-uncovered-in-asean-member-foreign-ministry"
        ],
        "max_signals": 33,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1003",
                "name": "OS Credential Dumping",
                "reference": "https://attack.mitre.org/techniques/T1003/",
                "subtechnique": [
                  {
                    "id": "T1003.002",
                    "name": "Security Account Manager",
                    "reference": "https://attack.mitre.org/techniques/T1003/002/"
                  },
                  {
                    "id": "T1003.003",
                    "name": "NTDS",
                    "reference": "https://attack.mitre.org/techniques/T1003/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "18e11f98-93d6-497a-9bf3-d2d5eae2266c",
        "rule_id": "3bc6deaa-fbd4-433a-ae21-3e892f95624f",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:55.060Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:25.693Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (\n    ((?process.pe.original_file_name in (\"Cmd.Exe\", \"PowerShell.EXE\", \"XCOPY.EXE\") or process.name : (\"Cmd.Exe\", \"PowerShell.EXE\", \"XCOPY.EXE\")) and\n       process.args : (\"copy\", \"xcopy\", \"Copy-Item\", \"move\", \"cp\", \"mv\")\n    ) or\n    ((?process.pe.original_file_name : \"esentutl.exe\" or process.name : \"esentutl.exe\") and process.args : (\"*/y*\", \"*/vss*\", \"*/d*\"))\n  ) and\n  process.command_line : (\"*\\\\ntds.dit*\", \"*\\\\config\\\\SAM*\", \"*\\\\*\\\\GLOBALROOT\\\\Device\\\\HarddiskVolumeShadowCopy*\\\\*\", \"*/system32/config/SAM*\", \"*\\\\User Data\\\\*\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Uncommon Registry Persistence Change",
        "description": "Detects changes to registry persistence keys that are not commonly used or modified by legitimate programs. This could be an indication of an adversary's attempt to persist in a stealthy manner.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "timeline_id": "3e47ef71-ebfc-4520-975c-cb27fc090799",
        "timeline_title": "Comprehensive Registry Timeline",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 211,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.microsoftpressstore.com/articles/article.aspx?p=2762082&seqNum=2"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1546",
                "name": "Event Triggered Execution",
                "reference": "https://attack.mitre.org/techniques/T1546/",
                "subtechnique": [
                  {
                    "id": "T1546.002",
                    "name": "Screensaver",
                    "reference": "https://attack.mitre.org/techniques/T1546/002/"
                  }
                ]
              },
              {
                "id": "T1547",
                "name": "Boot or Logon Autostart Execution",
                "reference": "https://attack.mitre.org/techniques/T1547/",
                "subtechnique": [
                  {
                    "id": "T1547.001",
                    "name": "Registry Run Keys / Startup Folder",
                    "reference": "https://attack.mitre.org/techniques/T1547/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1112",
                "name": "Modify Registry",
                "reference": "https://attack.mitre.org/techniques/T1112/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.data.strings",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "registry.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.value",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "6464720b-9abb-4ce5-acee-89db2d3ff5df",
        "rule_id": "54902e45-3467-49a4-8abc-529f2c8cfb80",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:55.102Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:27.699Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n length(registry.data.strings) > 0 and\n registry.path : (\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Terminal Server\\\\Install\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\\\\*\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Terminal Server\\\\Install\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Runonce\\\\*\",\n      \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Windows\\\\Load\",\n      \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Windows\\\\Run\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Windows\\\\IconServiceLib\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Winlogon\\\\Shell\",\n      \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Winlogon\\\\Shell\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Winlogon\\\\AppSetup\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Winlogon\\\\Taskman\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Winlogon\\\\Userinit\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Winlogon\\\\VmApplet\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\Explorer\\\\Run\\\\*\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\System\\\\Shell\",\n      \"HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\\\System\\\\Scripts\\\\Logoff\\\\Script\",\n      \"HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\\\System\\\\Scripts\\\\Logon\\\\Script\",\n      \"HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\\\System\\\\Scripts\\\\Shutdown\\\\Script\",\n      \"HKLM\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\\\System\\\\Scripts\\\\Startup\\\\Script\",\n      \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\Explorer\\\\Run\\\\*\",\n      \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\System\\\\Shell\",\n      \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\\\System\\\\Scripts\\\\Logoff\\\\Script\",\n      \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\\\System\\\\Scripts\\\\Logon\\\\Script\",\n      \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\\\System\\\\Scripts\\\\Shutdown\\\\Script\",\n      \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\\\System\\\\Scripts\\\\Startup\\\\Script\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Active Setup\\\\Installed Components\\\\*\\\\ShellComponent\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows CE Services\\\\AutoStartOnConnect\\\\MicrosoftActiveSync\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows CE Services\\\\AutoStartOnDisconnect\\\\MicrosoftActiveSync\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Ctf\\\\LangBarAddin\\\\*\\\\FilePath\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Internet Explorer\\\\Extensions\\\\*\\\\Exec\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Internet Explorer\\\\Extensions\\\\*\\\\Script\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Command Processor\\\\Autorun\",\n      \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Ctf\\\\LangBarAddin\\\\*\\\\FilePath\",\n      \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Internet Explorer\\\\Extensions\\\\*\\\\Exec\",\n      \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Internet Explorer\\\\Extensions\\\\*\\\\Script\",\n      \"HKEY_USERS\\\\*\\\\SOFTWARE\\\\Microsoft\\\\Command Processor\\\\Autorun\",\n      \"HKEY_USERS\\\\*\\\\Control Panel\\\\Desktop\\\\scrnsave.exe\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Image File Execution Options\\\\*\\\\VerifierDlls\",\n      \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Winlogon\\\\GpExtensions\\\\*\\\\DllName\",\n      \"HKLM\\\\SYSTEM\\\\ControlSet*\\\\Control\\\\SafeBoot\\\\AlternateShell\",\n      \"HKLM\\\\SYSTEM\\\\ControlSet*\\\\Control\\\\Terminal Server\\\\Wds\\\\rdpwd\\\\StartupPrograms\",\n      \"HKLM\\\\SYSTEM\\\\ControlSet*\\\\Control\\\\Terminal Server\\\\WinStations\\\\RDP-Tcp\\\\InitialProgram\",\n      \"HKLM\\\\SYSTEM\\\\ControlSet*\\\\Control\\\\Session Manager\\\\BootExecute\",\n      \"HKLM\\\\SYSTEM\\\\ControlSet*\\\\Control\\\\Session Manager\\\\SetupExecute\",\n      \"HKLM\\\\SYSTEM\\\\ControlSet*\\\\Control\\\\Session Manager\\\\Execute\",\n      \"HKLM\\\\SYSTEM\\\\ControlSet*\\\\Control\\\\Session Manager\\\\S0InitialCommand\",\n      \"HKLM\\\\SYSTEM\\\\ControlSet*\\\\Control\\\\ServiceControlManagerExtension\",\n      \"HKLM\\\\SYSTEM\\\\ControlSet*\\\\Control\\\\BootVerificationProgram\\\\ImagePath\",\n      \"HKLM\\\\SYSTEM\\\\Setup\\\\CmdLine\",\n      \"HKEY_USERS\\\\*\\\\Environment\\\\UserInitMprLogonScript\") and\n\n not registry.data.strings : (\"C:\\\\Windows\\\\system32\\\\userinit.exe\", \"cmd.exe\", \"C:\\\\Program Files (x86)\\\\*.exe\",\n                              \"C:\\\\Program Files\\\\*.exe\") and\n not (process.name : \"rundll32.exe\" and registry.path : \"*\\\\Software\\\\Microsoft\\\\Internet Explorer\\\\Extensions\\\\*\\\\Script\") and\n not process.executable : (\"C:\\\\Windows\\\\System32\\\\msiexec.exe\",\n                           \"C:\\\\Windows\\\\SysWOW64\\\\msiexec.exe\",\n                           \"C:\\\\ProgramData\\\\Microsoft\\\\Windows Defender\\\\Platform\\\\*\\\\MsMpEng.exe\",\n                           \"C:\\\\Program Files\\\\*.exe\",\n                           \"C:\\\\Program Files (x86)\\\\*.exe\") and\n not (process.name : (\"TiWorker.exe\", \"poqexec.exe\") and registry.value : \"SetupExecute\" and\n      registry.data.strings : (\n        \"C:\\\\windows\\\\System32\\\\poqexec.exe /display_progress \\\\SystemRoot\\\\WinSxS\\\\pending.xml\",\n        \"C:\\\\Windows\\\\System32\\\\poqexec.exe /skip_critical_poq /display_progress \\\\SystemRoot\\\\WinSxS\\\\pending.xml\"\n      )\n     ) and\n not (process.name : \"svchost.exe\" and registry.value : \"SCRNSAVE.EXE\" and\n      registry.data.strings : (\n        \"%windir%\\\\system32\\\\rundll32.exe user32.dll,LockWorkStation\",\n        \"scrnsave.scr\",\n        \"%windir%\\\\system32\\\\Ribbons.scr\"\n      )\n     )",
        "language": "eql",
        "index": [
          "logs-endpoint.events.registry-*",
          "logs-windows.sysmon_operational-*",
          "winlogbeat-*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious MS Outlook Child Process",
        "description": "Identifies suspicious child processes of Microsoft Outlook. These child processes are often associated with spear phishing activity.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Suspicious MS Outlook Child Process\n\nMicrosoft Outlook is an email client that provides contact, email calendar, and task management features. Outlook is widely used, either standalone or as part of the Office suite.\n\nThis rule looks for suspicious processes spawned by MS Outlook, which can be the result of the execution of malicious documents and/or exploitation for initial access.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Retrieve recently opened files received via email and opened by the user that could cause this behavior. Common locations include but are not limited to, the Downloads and Document folders and the folder configured at the email client.\n- Determine if the collected files are malicious:\n  - Use a private sandboxed malware analysis system to perform analysis.\n    - Observe and collect information about the following activities:\n      - Attempts to contact external domains and addresses.\n      - File and registry access, modification, and creation activities.\n      - Service creation and launch activities.\n      - Scheduled task creation.\n  - Use the PowerShell Get-FileHash cmdlet to get the files' SHA-256 hash values.\n    - Search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n  - If the malicious file was delivered via phishing:\n    - Block the email sender from sending future emails.\n    - Block the malicious web pages.\n    - Remove emails from the sender from mailboxes.\n    - Consider improvements to the security awareness program.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 416,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Initial Access",
          "Tactic: Defense Evasion",
          "Tactic: Execution",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: SentinelOne",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: System",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1566",
                "name": "Phishing",
                "reference": "https://attack.mitre.org/techniques/T1566/",
                "subtechnique": [
                  {
                    "id": "T1566.001",
                    "name": "Spearphishing Attachment",
                    "reference": "https://attack.mitre.org/techniques/T1566/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  },
                  {
                    "id": "T1059.003",
                    "name": "Windows Command Shell",
                    "reference": "https://attack.mitre.org/techniques/T1059/003/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1218",
                "name": "System Binary Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1218/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "9aa7a3da-ad5b-4603-ba6f-8ebf47b424f8",
        "rule_id": "32f4675e-6c49-4ace-80f9-97c9259dca2e",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:55.157Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:25.649Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.parent.name : \"outlook.exe\" and\n  process.name : (\"Microsoft.Workflow.Compiler.exe\", \"arp.exe\", \"atbroker.exe\", \"bginfo.exe\", \"bitsadmin.exe\",\n                  \"cdb.exe\", \"certutil.exe\", \"cmd.exe\", \"cmstp.exe\", \"cscript.exe\", \"csi.exe\", \"dnx.exe\", \"dsget.exe\",\n                  \"dsquery.exe\", \"forfiles.exe\", \"fsi.exe\", \"ftp.exe\", \"gpresult.exe\", \"hostname.exe\", \"ieexec.exe\",\n                  \"iexpress.exe\", \"installutil.exe\", \"ipconfig.exe\", \"mshta.exe\", \"msxsl.exe\", \"nbtstat.exe\", \"net.exe\",\n                  \"net1.exe\", \"netsh.exe\", \"netstat.exe\", \"nltest.exe\", \"odbcconf.exe\", \"ping.exe\", \"powershell.exe\",\n                  \"pwsh.exe\", \"qprocess.exe\", \"quser.exe\", \"qwinsta.exe\", \"rcsi.exe\", \"reg.exe\", \"regasm.exe\",\n                  \"regsvcs.exe\", \"regsvr32.exe\", \"sc.exe\", \"schtasks.exe\", \"systeminfo.exe\", \"tasklist.exe\",\n                  \"tracert.exe\", \"whoami.exe\", \"wmic.exe\", \"wscript.exe\", \"xwizard.exe\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.*",
          "endgame-*",
          "logs-system.security*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-m365_defender.event-*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Network Connection via Certutil",
        "description": "Identifies certutil.exe making a network connection. Adversaries could abuse certutil.exe to download a certificate, or malware, from a remote URL.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Network Connection via Certutil\n\nAttackers can abuse `certutil.exe` to download malware, offensive security tools, and certificates from external sources in order to take the next steps in a compromised environment.\n\nThis rule looks for network events where `certutil.exe` contacts IP ranges other than the ones specified in [IANA IPv4 Special-Purpose Address Registry](https://www.iana.org/assignments/iana-ipv4-special-registry/iana-ipv4-special-registry.xhtml)\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n> This investigation guide uses the [Investigate Markdown Plugin](https://www.elastic.co/guide/en/security/master/interactive-investigation-guides.html) introduced in Elastic Stack version 8.8.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n  - !{investigate{\"label\":\"Alerts associated with the user in the last 48h\",\"providers\":[[{\"excluded\":false,\"field\":\"event.kind\",\"queryType\":\"phrase\",\"value\":\"signal\",\"valueType\":\"string\"},{\"excluded\":false,\"field\":\"user.id\",\"queryType\":\"phrase\",\"value\":\"{{user.id}}\",\"valueType\":\"string\"}]],\"relativeFrom\":\"now-48h/h\",\"relativeTo\":\"now\"}}\n  - !{investigate{\"label\":\"Alerts associated with the host in the last 48h\",\"providers\":[[{\"excluded\":false,\"field\":\"event.kind\",\"queryType\":\"phrase\",\"value\":\"signal\",\"valueType\":\"string\"},{\"excluded\":false,\"field\":\"host.name\",\"queryType\":\"phrase\",\"value\":\"{{host.name}}\",\"valueType\":\"string\"}]],\"relativeFrom\":\"now-48h/h\",\"relativeTo\":\"now\"}}\n- Investigate if the downloaded file was executed.\n- Determine the context in which `certutil.exe` and the file were run.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the downloaded file using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n        - !{investigate{\"label\":\"Investigate the Subject Process Network Events\",\"providers\":[[{\"excluded\":false,\"field\":\"process.entity_id\",\"queryType\":\"phrase\",\"value\":\"{{process.entity_id}}\",\"valueType\":\"string\"},{\"excluded\":false,\"field\":\"event.category\",\"queryType\":\"phrase\",\"value\":\"network\",\"valueType\":\"string\"}]]}}\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n\n### False positive analysis\n\n- This mechanism can be used legitimately. If trusted software uses this command and the triage has not identified anything suspicious, this alert can be closed as a false positive.\n- If this rule is noisy in your environment due to expected activity, consider adding exceptions â€” preferably with a combination of user and command line conditions.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "building_block_type": "default",
        "output_index": "",
        "version": 215,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Command and Control",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: Elastic Endgame",
          "Rule Type: BBR"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.iana.org/assignments/iana-ipv4-special-registry/iana-ipv4-special-registry.xhtml",
          "https://frsecure.com/malware-incident-response-playbook/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            },
            "technique": [
              {
                "id": "T1105",
                "name": "Ingress Tool Transfer",
                "reference": "https://attack.mitre.org/techniques/T1105/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "dns.question.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "6e1a4120-c4b6-4b66-9966-e672c3eed671",
        "rule_id": "3838e0e3-1850-4850-a411-2e8c5ba40ba8",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:55.160Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:25.668Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "network where host.os.type == \"windows\" and process.name : \"certutil.exe\" and\n  not cidrmatch(destination.ip, \"10.0.0.0/8\", \"127.0.0.0/8\", \"169.254.0.0/16\", \"172.16.0.0/12\", \"192.0.0.0/24\",\n                                \"192.0.0.0/29\", \"192.0.0.8/32\", \"192.0.0.9/32\", \"192.0.0.10/32\", \"192.0.0.170/32\",\n                                \"192.0.0.171/32\", \"192.0.2.0/24\", \"192.31.196.0/24\", \"192.52.193.0/24\",\n                                \"192.168.0.0/16\", \"192.88.99.0/24\", \"224.0.0.0/4\", \"100.64.0.0/10\", \"192.175.48.0/24\",\n                                \"198.18.0.0/15\", \"198.51.100.0/24\", \"203.0.113.0/24\", \"240.0.0.0/4\", \"::1\",\n                                \"FE80::/10\", \"FF00::/8\") and\n  not dns.question.name in (\"localhost\", \"*.digicert.com\", \"ctldl.windowsupdate.com\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.network-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "Wireless Credential Dumping using Netsh Command",
        "description": "Identifies attempts to dump Wireless saved access keys in clear text using the Windows built-in utility Netsh.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Wireless Credential Dumping using Netsh Command\n\nNetsh is a Windows command line tool used for network configuration and troubleshooting. It enables the management of network settings and adapters, wireless network profiles, and other network-related tasks.\n\nThis rule looks for patterns used to dump credentials from wireless network profiles using Netsh, which can enable attackers to bring their own devices to the network.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Inspect the host for suspicious or abnormal behavior in the alert timeframe:\n  - Observe and collect information about the following activities in the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Review the privileges assigned to the user to ensure that the least privilege principle is being followed.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 210,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Tactic: Discovery",
          "Data Source: Elastic Endgame",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://learn.microsoft.com/en-us/windows-server/networking/technologies/netsh/netsh-contexts",
          "https://www.geeksforgeeks.org/how-to-find-the-wi-fi-password-using-cmd-in-windows/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1003",
                "name": "OS Credential Dumping",
                "reference": "https://attack.mitre.org/techniques/T1003/"
              },
              {
                "id": "T1555",
                "name": "Credentials from Password Stores",
                "reference": "https://attack.mitre.org/techniques/T1555/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1082",
                "name": "System Information Discovery",
                "reference": "https://attack.mitre.org/techniques/T1082/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "46a34529-a148-441d-8420-4c0a98e44368",
        "rule_id": "2de87d72-ee0c-43e2-b975-5f0b029ac600",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:55.163Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:25.600Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n (process.name : \"netsh.exe\" or ?process.pe.original_file_name == \"netsh.exe\") and\n  process.args : \"wlan\" and process.args : \"key*clear\"",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "PowerShell Script with Log Clear Capabilities",
        "description": "Identifies the use of Cmdlets and methods related to Windows event log deletion activities. This is often done by attackers in an attempt to evade detection or destroy forensic evidence on a system.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 208,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: PowerShell Logs",
          "Rule Type: BBR"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://learn.microsoft.com/en-us/dotnet/api/system.diagnostics.eventlog.clear",
          "https://learn.microsoft.com/en-us/dotnet/api/system.diagnostics.eventing.reader.eventlogsession.clearlog"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1070",
                "name": "Indicator Removal",
                "reference": "https://attack.mitre.org/techniques/T1070/",
                "subtechnique": [
                  {
                    "id": "T1070.001",
                    "name": "Clear Windows Event Logs",
                    "reference": "https://attack.mitre.org/techniques/T1070/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'PowerShell Script Block Logging' logging policy must be enabled.\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nAdministrative Templates >\nWindows PowerShell >\nTurn on PowerShell Script Block Logging (Enable)\n```\n\nSteps to implement the logging policy via registry:\n\n```\nreg add \"hklm\\SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\ScriptBlockLogging\" /v EnableScriptBlockLogging /t REG_DWORD /d 1\n```\n",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.directory",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "powershell.file.script_block_text",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "b75c41d4-48d1-44b7-a883-f4ca7e1e1b4b",
        "rule_id": "3d3aa8f9-12af-441f-9344-9f31053e316d",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:55.167Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:25.711Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-windows.powershell*"
        ],
        "filters": [
          {
            "meta": {
              "negate": true
            },
            "query": {
              "wildcard": {
                "file.path": {
                  "case_insensitive": true,
                  "value": "?:\\\\Windows\\\\system32\\\\WindowsPowerShell\\\\v1.0\\\\Modules\\\\Microsoft.PowerShell.Management\\\\*.psd1"
                }
              }
            }
          },
          {
            "meta": {
              "negate": true
            },
            "query": {
              "wildcard": {
                "file.path": {
                  "case_insensitive": true,
                  "value": "?:\\\\Program Files\\\\Microsoft Monitoring Agent\\\\Agent\\\\Health Service State\\\\Resources\\\\*\\\\M365Library.ps1"
                }
              }
            }
          }
        ],
        "query": "event.category:process and host.os.type:windows and\n  powershell.file.script_block_text : (\n    \"Clear-EventLog\" or\n    \"Remove-EventLog\" or\n    (\"Eventing.Reader.EventLogSession\" and \".ClearLog\") or\n    (\"Diagnostics.EventLog\" and \".Clear\")\n  ) and\n  not powershell.file.script_block_text : (\n    \"CmdletsToExport=@(\\\"Add-Content\\\"\"\n  ) and\n  not file.directory : \"C:\\Program Files\\WindowsAdminCenter\\PowerShellModules\\Microsoft.WindowsAdminCenter.Configuration\"",
        "language": "kuery"
      },
      {
        "name": "Potential PowerShell Pass-the-Hash/Relay Script",
        "description": "Detects PowerShell scripts that can execute pass-the-hash (PtH) attacks, intercept and relay NTLM challenges, and carry out other man-in-the-middle (MitM) attacks.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 104,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Resources: Investigation Guide",
          "Data Source: PowerShell Logs"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/Kevin-Robertson/Invoke-TheHash/blob/master/Invoke-WMIExec.ps1",
          "https://github.com/Kevin-Robertson/Invoke-TheHash/blob/master/Invoke-SMBExec.ps1",
          "https://github.com/dafthack/Check-LocalAdminHash/blob/master/Check-LocalAdminHash.ps1",
          "https://github.com/nettitude/PoshC2/blob/master/resources/modules/Invoke-Tater.ps1",
          "https://github.com/Kevin-Robertson/Inveigh/blob/master/Inveigh.ps1"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1557",
                "name": "Adversary-in-the-Middle",
                "reference": "https://attack.mitre.org/techniques/T1557/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1550",
                "name": "Use Alternate Authentication Material",
                "reference": "https://attack.mitre.org/techniques/T1550/",
                "subtechnique": [
                  {
                    "id": "T1550.002",
                    "name": "Pass the Hash",
                    "reference": "https://attack.mitre.org/techniques/T1550/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'PowerShell Script Block Logging' logging policy must be enabled.\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nAdministrative Templates >\nWindows PowerShell >\nTurn on PowerShell Script Block Logging (Enable)\n```\n\nSteps to implement the logging policy via registry:\n\n```\nreg add \"hklm\\SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\ScriptBlockLogging\" /v EnableScriptBlockLogging /t REG_DWORD /d 1\n```\n",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.directory",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "powershell.file.script_block_text",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "c80b4127-15cf-4ea3-bdff-9d6dc5a2d1ab",
        "rule_id": "951779c2-82ad-4a6c-82b8-296c1f691449",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:55.169Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:30.535Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-windows.powershell*"
        ],
        "filters": [],
        "query": "event.category:process and host.os.type:windows and\n  powershell.file.script_block_text : (\n    (\"NTLMSSPNegotiate\" and (\"NegotiateSMB\" or \"NegotiateSMB2\")) or\n    \"4E544C4D53535000\" or\n    \"0x4e,0x54,0x4c,0x4d,0x53,0x53,0x50\" or\n    \"0x4e,0x54,0x20,0x4c,0x4d\" or\n    \"0x53,0x4d,0x42,0x20,0x32\" or\n    \"0x81,0xbb,0x7a,0x36,0x44,0x98,0xf1,0x35,0xad,0x32,0x98,0xf0,0x38\"\n  ) and\n  not file.directory : \"C:\\ProgramData\\Microsoft\\Windows Defender Advanced Threat Protection\\Downloads\"",
        "language": "kuery"
      },
      {
        "name": "Program Files Directory Masquerading",
        "description": "Identifies execution from a directory masquerading as the Windows Program Files directories. These paths are trusted and usually host trusted third party programs. An adversary may leverage masquerading, along with low privileges to bypass detections allowlisting those folders.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 312,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1036",
                "name": "Masquerading",
                "reference": "https://attack.mitre.org/techniques/T1036/",
                "subtechnique": [
                  {
                    "id": "T1036.005",
                    "name": "Match Legitimate Name or Location",
                    "reference": "https://attack.mitre.org/techniques/T1036/005/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "a0e42411-6f98-4e6f-8e53-e82136da76be",
        "rule_id": "32c5cf9c-2ef8-4e87-819e-5ccb7cd18b14",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:55.172Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:25.644Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.executable : (\n    \"C:\\\\*Program*Files*\\\\*.exe\",\n    \"\\\\Device\\\\HarddiskVolume?\\\\*Program*Files*\\\\*.exe\"\n  ) and\n  not process.executable : (\n        \"?:\\\\Program Files\\\\*.exe\",\n        \"?:\\\\Program Files (x86)\\\\*.exe\",\n        \"?:\\\\Users\\\\*.exe\",\n        \"?:\\\\ProgramData\\\\*.exe\",\n        \"?:\\\\Windows\\\\Downloaded Program Files\\\\*.exe\",\n        \"?:\\\\Windows\\\\Temp\\\\.opera\\\\????????????\\\\CProgram?FilesOpera*\\\\*.exe\",\n        \"?:\\\\Windows\\\\Temp\\\\.opera\\\\????????????\\\\CProgram?Files?(x86)Opera*\\\\*.exe\"\n  ) and\n  not (\n    event.dataset == \"crowdstrike.fdr\" and\n      process.executable : (\n        \"\\\\Device\\\\HarddiskVolume?\\\\Program Files\\\\*.exe\",\n        \"\\\\Device\\\\HarddiskVolume?\\\\Program Files (x86)\\\\*.exe\",\n        \"\\\\Device\\\\HarddiskVolume?\\\\Users\\\\*.exe\",\n        \"\\\\Device\\\\HarddiskVolume?\\\\ProgramData\\\\*.exe\",\n        \"\\\\Device\\\\HarddiskVolume?\\\\Windows\\\\Downloaded Program Files\\\\*.exe\",\n        \"\\\\Device\\\\HarddiskVolume?\\\\Windows\\\\Temp\\\\.opera\\\\????????????\\\\CProgram?FilesOpera*\\\\*.exe\",\n        \"\\\\Device\\\\HarddiskVolume?\\\\Windows\\\\Temp\\\\.opera\\\\????????????\\\\CProgram?Files?(x86)Opera*\\\\*.exe\"\n      )\n  )",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Potential LSASS Clone Creation via PssCaptureSnapShot",
        "description": "Identifies the creation of an LSASS process clone via PssCaptureSnapShot where the parent process is the initial LSASS process instance. This may indicate an attempt to evade detection and dump LSASS memory for credential access.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 208,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Data Source: Sysmon",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.matteomalvica.com/blog/2019/12/02/win-defender-atp-cred-bypass/",
          "https://medium.com/@Achilles8284/the-birth-of-a-process-part-2-97c6fb9c42a2"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1003",
                "name": "OS Credential Dumping",
                "reference": "https://attack.mitre.org/techniques/T1003/",
                "subtechnique": [
                  {
                    "id": "T1003.001",
                    "name": "LSASS Memory",
                    "reference": "https://attack.mitre.org/techniques/T1003/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis is meant to run only on datasources using Windows security event 4688 that captures the process clone creation.\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.code",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "7f6e809a-d333-4940-b063-4679493af211",
        "rule_id": "a16612dd-b30e-4d41-86a0-ebe70974ec00",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:55.176Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:31.919Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.code:\"4688\" and\n  process.executable : \"?:\\\\Windows\\\\System32\\\\lsass.exe\" and\n  process.parent.executable : \"?:\\\\Windows\\\\System32\\\\lsass.exe\"",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-system.*",
          "logs-windows.*"
        ],
        "filters": []
      },
      {
        "name": "Hosts File Modified",
        "description": "The hosts file on endpoints is used to control manual IP address to hostname resolutions. The hosts file is the first point of lookup for DNS hostname resolution so if adversaries can modify the endpoint hosts file, they can route traffic to malicious infrastructure. This rule detects modifications to the hosts file on Microsoft Windows, Linux (Ubuntu or RHEL) and macOS systems.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "timeline_id": "4d4c0b59-ea83-483f-b8c1-8c360ee53c5c",
        "timeline_title": "Comprehensive File Timeline",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Hosts File Modified\n\nOperating systems use the hosts file to map a connection between an IP address and domain names before going to domain name servers. Attackers can abuse this mechanism to route traffic to malicious infrastructure or disrupt security that depends on server communications. For example, Russian threat actors modified this file on a domain controller to redirect Duo MFA calls to localhost instead of the Duo server, which prevented the MFA service from contacting its server to validate MFA login. This effectively disabled MFA for active domain accounts because the default policy of Duo for Windows is to \"Fail open\" if the MFA server is unreachable. This can happen in any MFA implementation and is not exclusive to Duo. Find more details in this [CISA Alert](https://www.cisa.gov/uscert/ncas/alerts/aa22-074a).\n\nThis rule identifies modifications in the hosts file across multiple operating systems using process creation events for Linux and file events in Windows and macOS.\n\n#### Possible investigation steps\n\n- Identify the specifics of the involved assets, such as role, criticality, and associated users.\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Examine the changes to the hosts file by comparing it against file backups, volume shadow copies, and other restoration mechanisms.\n\n### False positive analysis\n\n- This mechanism can be used legitimately. Analysts can dismiss the alert if the administrator is aware of the activity and the configuration was justified.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Consider isolating the involved host to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Review the privileges of the administrator account that performed the action.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 210,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "OS: Windows",
          "OS: macOS",
          "Use Case: Threat Detection",
          "Tactic: Impact",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/guide/en/beats/auditbeat/current/auditbeat-reference-yml.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0040",
              "name": "Impact",
              "reference": "https://attack.mitre.org/tactics/TA0040/"
            },
            "technique": [
              {
                "id": "T1565",
                "name": "Data Manipulation",
                "reference": "https://attack.mitre.org/techniques/T1565/",
                "subtechnique": [
                  {
                    "id": "T1565.001",
                    "name": "Stored Data Manipulation",
                    "reference": "https://attack.mitre.org/techniques/T1565/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nFor Windows systems using Auditbeat, this rule requires adding `C:/Windows/System32/drivers/etc` as an additional path in the 'file_integrity' module of auditbeat.yml.\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "a4d9b649-f6f3-439d-8d40-e6a361a6c696",
        "rule_id": "9c260313-c811-4ec8-ab89-8f6530e0246c",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:55.179Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:31.847Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "any where\n\n  /* file events for creation; file change events are not captured by some of the included sources for linux and so may\n     miss this, which is the purpose of the process + command line args logic below */\n  (\n   event.category == \"file\" and event.type in (\"change\", \"creation\") and\n     file.path : (\"/private/etc/hosts\", \"/etc/hosts\", \"?:\\\\Windows\\\\System32\\\\drivers\\\\etc\\\\hosts\") and \n     not process.name in (\"dockerd\", \"rootlesskit\", \"podman\", \"crio\")\n  )\n  or\n\n  /* process events for change targeting linux only */\n  (\n   event.category == \"process\" and event.type in (\"start\") and\n     process.name in (\"nano\", \"vim\", \"vi\", \"emacs\", \"echo\", \"sed\") and\n     process.args : (\"/etc/hosts\") and \n     not process.parent.name in (\"dhclient-script\", \"google_set_hostname\")\n  )",
        "language": "eql",
        "index": [
          "auditbeat-*",
          "winlogbeat-*",
          "logs-endpoint.events.*",
          "logs-windows.*"
        ],
        "filters": []
      },
      {
        "name": "Bypass UAC via Event Viewer",
        "description": "Identifies User Account Control (UAC) bypass via eventvwr.exe. Attackers bypass UAC to stealthily execute code with elevated permissions.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Bypass UAC via Event Viewer\n\nWindows User Account Control (UAC) allows a program to elevate its privileges (tracked as low to high integrity levels) to perform a task under administrator-level permissions, possibly by prompting the user for confirmation. UAC can deny an operation under high-integrity enforcement, or allow the user to perform the action if they are in the local administrators group and enter an administrator password when prompted.\n\nFor more information about the UAC and how it works, check the [official Microsoft docs page](https://docs.microsoft.com/en-us/windows/security/identity-protection/user-account-control/how-user-account-control-works).\n\nDuring startup, `eventvwr.exe` checks the registry value of the `HKCU\\Software\\Classes\\mscfile\\shell\\open\\command` registry key for the location of `mmc.exe`, which is used to open the `eventvwr.msc` saved console file. If the location of another binary or script is added to this registry value, it will be executed as a high-integrity process without a UAC prompt being displayed to the user. This rule detects this UAC bypass by monitoring processes spawned by `eventvwr.exe` other than `mmc.exe` and `werfault.exe`.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Inspect the host for suspicious or abnormal behavior in the alert timeframe.\n- Investigate any abnormal behavior by the subject process such as network connections, registry or file modifications, and any spawned child processes.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the process executable using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 315,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Tactic: Defense Evasion",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: System",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1548",
                "name": "Abuse Elevation Control Mechanism",
                "reference": "https://attack.mitre.org/techniques/T1548/",
                "subtechnique": [
                  {
                    "id": "T1548.002",
                    "name": "Bypass User Account Control",
                    "reference": "https://attack.mitre.org/techniques/T1548/002/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1548",
                "name": "Abuse Elevation Control Mechanism",
                "reference": "https://attack.mitre.org/techniques/T1548/",
                "subtechnique": [
                  {
                    "id": "T1548.002",
                    "name": "Bypass User Account Control",
                    "reference": "https://attack.mitre.org/techniques/T1548/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "e1a70d56-335f-4d3b-8197-a57bd541adec",
        "rule_id": "31b4c719-f2b4-41f6-a9bd-fce93c2eaf62",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:55.238Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:25.638Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.parent.name : \"eventvwr.exe\" and\n  not process.executable : (\n        \"?:\\\\Windows\\\\SysWOW64\\\\mmc.exe\",\n        \"?:\\\\Windows\\\\System32\\\\mmc.exe\",\n        \"?:\\\\Windows\\\\SysWOW64\\\\WerFault.exe\",\n        \"?:\\\\Windows\\\\System32\\\\WerFault.exe\",\n        \"?\\\\Device\\\\HarddiskVolume?\\\\Windows\\\\Sys?????\\\\mmc.exe\",\n        \"?\\\\Device\\\\HarddiskVolume?\\\\Windows\\\\Sys?????\\\\WerFault.exe\"\n  )",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "ScreenConnect Server Spawning Suspicious Processes",
        "description": "Identifies suspicious processes being spawned by the ScreenConnect server process (ScreenConnect.Service.exe). This activity may indicate exploitation activity or access to an existing web shell backdoor.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 203,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Initial Access",
          "Tactic: Execution",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://blackpointcyber.com/resources/blog/breaking-through-the-screen/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1190",
                "name": "Exploit Public-Facing Application",
                "reference": "https://attack.mitre.org/techniques/T1190/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  },
                  {
                    "id": "T1059.003",
                    "name": "Windows Command Shell",
                    "reference": "https://attack.mitre.org/techniques/T1059/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "da0e6584-eaa2-4ec5-a7fb-a3361765f2cf",
        "rule_id": "3d00feab-e203-4acc-a463-c3e15b7e9a73",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:55.241Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:25.706Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.parent.name : \"ScreenConnect.Service.exe\" and\n  (process.name : (\"cmd.exe\", \"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\", \"csc.exe\") or\n  ?process.pe.original_file_name in (\"cmd.exe\", \"powershell.exe\", \"pwsh.dll\", \"powershell_ise.exe\"))",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "winlogbeat-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Windows Event Logs Cleared",
        "description": "Identifies attempts to clear Windows event log stores. This is often done by attackers in an attempt to evade detection or destroy forensic evidence on a system.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Windows Event Logs Cleared\n\nWindows event logs are a fundamental data source for security monitoring, forensics, and incident response. Adversaries can tamper, clear, and delete this data to break SIEM detections, cover their tracks, and slow down incident response.\n\nThis rule looks for the occurrence of clear actions on the `security` event log.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n  - Verify if any other anti-forensics behaviors were observed.\n- Investigate the event logs prior to the action for suspicious behaviors that an attacker may be trying to cover up.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n  - This activity is potentially done after the adversary achieves its objectives on the host. Ensure that previous actions, if any, are investigated accordingly with their response playbooks.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 211,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Resources: Investigation Guide",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic",
          "Anabella Cristaldi"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1070",
                "name": "Indicator Removal",
                "reference": "https://attack.mitre.org/techniques/T1070/",
                "subtechnique": [
                  {
                    "id": "T1070.001",
                    "name": "Clear Windows Event Logs",
                    "reference": "https://attack.mitre.org/techniques/T1070/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.api",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "winlog.provider_name",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "aaca305b-e773-4bee-893f-d533075c361c",
        "rule_id": "45ac4800-840f-414c-b221-53dd36a5aaf7",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:55.244Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:26.044Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-system.*",
          "logs-windows.*"
        ],
        "filters": [],
        "query": "event.action:(\"audit-log-cleared\" or \"Log clear\") and winlog.api:\"wineventlog\" and\n  not winlog.provider_name:\"AD FS Auditing\"",
        "language": "kuery"
      },
      {
        "name": "PowerShell Mailbox Collection Script",
        "description": "Detects PowerShell scripts that can be used to collect data from mailboxes. Adversaries may target user email to collect sensitive information.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating PowerShell Mailbox Collection Script\n\nPowerShell is one of the main tools system administrators use for automation, report routines, and other tasks. This makes it available for use in various environments, and creates an attractive way for attackers to execute code.\n\nEmail mailboxes and their information can be valuable assets for attackers. Company mailboxes often contain sensitive information such as login credentials, intellectual property, financial data, and personal information, making them high-value targets for malicious actors.\n\nThis rule identifies scripts that contains methods and classes that can be abused to collect emails from local and remote mailboxes.\n\n#### Possible investigation steps\n\n- Examine the script content that triggered the detection; look for suspicious DLL imports, collection or exfiltration capabilities, suspicious functions, encoded or compressed data, and other potentially malicious characteristics.\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Determine whether the script was executed and capture relevant information, such as arguments that reveal intent or are indicators of compromise (IoCs).\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Evaluate whether the user needs to use PowerShell to complete tasks.\n- Determine whether the script stores the captured data locally.\n- Investigate whether the script contains exfiltration capabilities and identify the exfiltration server.\n  - Assess network data to determine if the host communicated with the exfiltration server.\n\n### False positive analysis\n\n- This mechanism can be used legitimately. Analysts can dismiss the alert if the administrator is aware of the activity and it is done with proper approval.\n\n### Related rules\n\n- Exporting Exchange Mailbox via PowerShell - 6aace640-e631-4870-ba8e-5fdda09325db\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- If the involved host is not the Exchange server, isolate the host to prevent further post-compromise behavior.\n- Prioritize cases that involve personally identifiable information (PII) or other classified data.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 109,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Collection",
          "Data Source: PowerShell Logs",
          "Resources: Investigation Guide"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/dafthack/MailSniper/blob/master/MailSniper.ps1",
          "https://github.com/center-for-threat-informed-defense/adversary_emulation_library/blob/master/apt29/Archive/CALDERA_DIY/evals/payloads/stepSeventeen_email.ps1"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0009",
              "name": "Collection",
              "reference": "https://attack.mitre.org/tactics/TA0009/"
            },
            "technique": [
              {
                "id": "T1114",
                "name": "Email Collection",
                "reference": "https://attack.mitre.org/techniques/T1114/",
                "subtechnique": [
                  {
                    "id": "T1114.001",
                    "name": "Local Email Collection",
                    "reference": "https://attack.mitre.org/techniques/T1114/001/"
                  },
                  {
                    "id": "T1114.002",
                    "name": "Remote Email Collection",
                    "reference": "https://attack.mitre.org/techniques/T1114/002/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'PowerShell Script Block Logging' logging policy must be enabled.\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nAdministrative Templates >\nWindows PowerShell >\nTurn on PowerShell Script Block Logging (Enable)\n```\n\nSteps to implement the logging policy via registry:\n\n```\nreg add \"hklm\\SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\ScriptBlockLogging\" /v EnableScriptBlockLogging /t REG_DWORD /d 1\n```\n",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "powershell.file.script_block_text",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "97068a14-b3b9-46d1-8417-17cf0c63e8d4",
        "rule_id": "a2d04374-187c-4fd9-b513-3ad4e7fdd67a",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:55.258Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:31.943Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-windows.powershell*"
        ],
        "filters": [],
        "query": "event.category:process and host.os.type:windows and\n  (\n   powershell.file.script_block_text : (\n      \"Microsoft.Office.Interop.Outlook\" or\n      \"Interop.Outlook.olDefaultFolders\" or\n      \"::olFolderInBox\"\n   ) or\n   powershell.file.script_block_text : (\n      \"Microsoft.Exchange.WebServices.Data.Folder\" or\n      \"Microsoft.Exchange.WebServices.Data.FileAttachment\"\n   )\n  ) and not user.id : \"S-1-5-18\"",
        "language": "kuery"
      },
      {
        "name": "Disable Windows Firewall Rules via Netsh",
        "description": "Identifies use of the netsh.exe to disable or weaken the local firewall. Attackers will use this command line tool to disable the firewall during troubleshooting or to enable network mobility.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Disable Windows Firewall Rules via Netsh\n\nThe Windows Defender Firewall is a native component which provides host-based, two-way network traffic filtering for a device, and blocks unauthorized network traffic flowing into or out of the local device.\n\nAttackers can disable the Windows firewall or its rules to enable lateral movement and command and control activity.\n\nThis rule identifies patterns related to disabling the Windows firewall or its rules using the `netsh.exe` utility.\n\n#### Possible investigation steps\n\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the user to check if they are aware of the operation.\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n\n### False positive analysis\n\n- This mechanism can be used legitimately. Check whether the user is an administrator and is legitimately performing troubleshooting.\n- In case of an allowed benign true positive (B-TP), assess adding rules to allow needed traffic and re-enable the firewall.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Review the privileges assigned to the involved users to ensure that the least privilege principle is being followed.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 312,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.004",
                    "name": "Disable or Modify System Firewall",
                    "reference": "https://attack.mitre.org/techniques/T1562/004/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "68abe3ff-477b-4c90-99ba-2fdb12659c5c",
        "rule_id": "4b438734-3793-4fda-bd42-ceeada0be8f9",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:55.261Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:27.620Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.name : \"netsh.exe\" and\n  (\n    (process.args : \"disable\" and process.args : \"firewall\" and process.args : \"set\") or\n    (process.args : \"advfirewall\" and process.args : \"off\" and process.args : \"state\")\n  )",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Microsoft Build Engine Started an Unusual Process",
        "description": "An instance of MSBuild, the Microsoft Build Engine, started a PowerShell script or the Visual C# Command Line Compiler. This technique is sometimes used to deploy a malicious payload using the Build Engine.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 314,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Tactic: Execution",
          "Data Source: Elastic Defend",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "The Build Engine is commonly used by Windows developers but use by non-engineers is unusual. If a build system triggers this rule it can be exempted by process, user or host name."
        ],
        "references": [
          "https://blog.talosintelligence.com/2020/02/building-bypass-with-msbuild.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1027",
                "name": "Obfuscated Files or Information",
                "reference": "https://attack.mitre.org/techniques/T1027/",
                "subtechnique": [
                  {
                    "id": "T1027.004",
                    "name": "Compile After Delivery",
                    "reference": "https://attack.mitre.org/techniques/T1027/004/"
                  }
                ]
              },
              {
                "id": "T1127",
                "name": "Trusted Developer Utilities Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1127/",
                "subtechnique": [
                  {
                    "id": "T1127.001",
                    "name": "MSBuild",
                    "reference": "https://attack.mitre.org/techniques/T1127/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "ff914237-82bc-47e9-a958-dbd285de45e0",
        "rule_id": "9d110cb3-5f4b-4c9a-b9f5-53f0a1707ae6",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:55.264Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:31.892Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "host.os.type:windows and event.category:process and event.type:start and process.parent.name:(\"MSBuild.exe\" or \"msbuild.exe\") and\nprocess.name:(\"csc.exe\" or \"iexplore.exe\" or \"powershell.exe\")",
        "new_terms_fields": [
          "host.id",
          "user.name"
        ],
        "history_window_start": "now-14d",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.*",
          "logs-system.security*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Suspicious Zoom Child Process",
        "description": "A suspicious Zoom child process was detected, which may indicate an attempt to run unnoticed. Verify process details such as command line, network connections, file writes and associated file signature details as well.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Suspicious Zoom Child Process\n\nBy examining the specific traits of Windows binaries -- such as process trees, command lines, network connections, registry modifications, and so on -- it's possible to establish a baseline of normal activity. Deviations from this baseline can indicate malicious activity, such as masquerading, and deserve further investigation.\n\nThis rule identifies a potential malicious process masquerading as `Zoom.exe` or exploiting a vulnerability in the application causing it to execute code.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate any abnormal behavior by the subject process such as network connections, registry or file modifications, and any spawned child processes.\n- Examine the command line of the child process to determine which commands or scripts were executed.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the process executable using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 416,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Tactic: Execution",
          "Data Source: Elastic Endgame",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend",
          "Data Source: SentinelOne",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: System",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1036",
                "name": "Masquerading",
                "reference": "https://attack.mitre.org/techniques/T1036/"
              },
              {
                "id": "T1055",
                "name": "Process Injection",
                "reference": "https://attack.mitre.org/techniques/T1055/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1203",
                "name": "Exploitation for Client Execution",
                "reference": "https://attack.mitre.org/techniques/T1203/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "625fce27-ebdd-4b9a-9437-0dbcfd9874f9",
        "rule_id": "97aba1ef-6034-4bd3-8c1a-1e0996b27afa",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:55.268Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:32.103Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n process.parent.name : \"Zoom.exe\" and process.name : (\"cmd.exe\", \"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.*",
          "endgame-*",
          "logs-system.security*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-m365_defender.event-*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Unusual Process Execution Path - Alternate Data Stream",
        "description": "Identifies processes running from an Alternate Data Stream. This is uncommon for legitimate processes and sometimes done by adversaries to hide malware.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 310,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1564",
                "name": "Hide Artifacts",
                "reference": "https://attack.mitre.org/techniques/T1564/",
                "subtechnique": [
                  {
                    "id": "T1564.004",
                    "name": "NTFS File Attributes",
                    "reference": "https://attack.mitre.org/techniques/T1564/004/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args_count",
            "type": "long",
            "ecs": true
          }
        ],
        "id": "42c23e17-5a02-41f8-8023-1ef5ccbced47",
        "rule_id": "4bd1c1af-79d4-4d37-9efa-6e0240640242",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:55.271Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:27.626Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.args : \"?:\\\\*:*\" and process.args_count == 1",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "winlogbeat-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Microsoft Build Engine Started by a Script Process",
        "description": "An instance of MSBuild, the Microsoft Build Engine, was started by a script or the Windows command interpreter. This behavior is unusual and is sometimes used by malicious payloads.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 311,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Tactic: Execution",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "The Build Engine is commonly used by Windows developers but use by non-engineers is unusual."
        ],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1127",
                "name": "Trusted Developer Utilities Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1127/",
                "subtechnique": [
                  {
                    "id": "T1127.001",
                    "name": "MSBuild",
                    "reference": "https://attack.mitre.org/techniques/T1127/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  },
                  {
                    "id": "T1059.003",
                    "name": "Windows Command Shell",
                    "reference": "https://attack.mitre.org/techniques/T1059/003/"
                  },
                  {
                    "id": "T1059.005",
                    "name": "Visual Basic",
                    "reference": "https://attack.mitre.org/techniques/T1059/005/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name.caseless",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "275f4a56-83e8-4c6c-a07f-796ef24355c9",
        "rule_id": "9d110cb3-5f4b-4c9a-b9f5-53f0a1707ae2",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:55.274Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:31.872Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "host.os.type:windows and event.category:process and event.type:start and (\n  process.name.caseless:\"msbuild.exe\" or process.pe.original_file_name:\"MSBuild.exe\") and \n  process.parent.name:(\"cmd.exe\" or \"powershell.exe\" or \"pwsh.exe\" or \"powershell_ise.exe\" or \"cscript.exe\" or\n    \"wscript.exe\" or \"mshta.exe\")",
        "new_terms_fields": [
          "host.id",
          "user.name",
          "process.command_line"
        ],
        "history_window_start": "now-14d",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "PowerShell Suspicious Script with Screenshot Capabilities",
        "description": "Detects PowerShell scripts that can take screenshots, which is a common feature in post-exploitation kits and remote access tools (RATs).",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating PowerShell Suspicious Script with Screenshot Capabilities\n\nPowerShell is one of the main tools system administrators use for automation, report routines, and other tasks, which makes it available for use in various environments and creates an attractive way for attackers to execute code.\n\nAttackers can abuse PowerShell capabilities and take screen captures of desktops to gather information over the course of an operation.\n\n#### Possible investigation steps\n\n- Examine the script content that triggered the detection; look for suspicious DLL imports, collection or exfiltration capabilities, suspicious functions, encoded or compressed data, and other potentially malicious characteristics.\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Examine file or network events from the involved PowerShell process for suspicious behavior.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Evaluate whether the user needs to use PowerShell to complete tasks.\n- Determine whether the script stores the captured data locally.\n- Investigate whether the script contains exfiltration capabilities and identify the exfiltration server.\n- Assess network data to determine if the host communicated with the exfiltration server.\n\n### False positive analysis\n\n- Regular users do not have a business justification for using scripting utilities to take screenshots, which makes false positives unlikely. In the case of authorized benign true positives (B-TPs), exceptions can be added.\n\n### Related rules\n\n- PowerShell Keylogging Script - bd2c86a0-8b61-4457-ab38-96943984e889\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Restrict PowerShell usage outside of IT and engineering business units using GPOs, AppLocker, Intune, or similar software.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 210,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Collection",
          "Resources: Investigation Guide",
          "Data Source: PowerShell Logs"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://docs.microsoft.com/en-us/dotnet/api/system.drawing.graphics.copyfromscreen"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0009",
              "name": "Collection",
              "reference": "https://attack.mitre.org/tactics/TA0009/"
            },
            "technique": [
              {
                "id": "T1113",
                "name": "Screen Capture",
                "reference": "https://attack.mitre.org/techniques/T1113/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'PowerShell Script Block Logging' logging policy must be enabled.\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nAdministrative Templates >\nWindows PowerShell >\nTurn on PowerShell Script Block Logging (Enable)\n```\n\nSteps to implement the logging policy via registry:\n\n```\nreg add \"hklm\\SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\ScriptBlockLogging\" /v EnableScriptBlockLogging /t REG_DWORD /d 1\n```\n",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "powershell.file.script_block_text",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "8d6a6f8d-3f79-4ff1-bb0d-2c17d445f6ae",
        "rule_id": "959a7353-1129-4aa7-9084-30746b256a70",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:55.277Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:30.545Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-windows.powershell*"
        ],
        "filters": [],
        "query": "event.category:process and host.os.type:windows and\n  powershell.file.script_block_text : (\n    CopyFromScreen and\n    (\"System.Drawing.Bitmap\" or \"Drawing.Bitmap\")\n  ) and not user.id : \"S-1-5-18\"",
        "language": "kuery"
      },
      {
        "name": "Credential Acquisition via Registry Hive Dumping",
        "description": "Identifies attempts to export a registry hive which may contain credentials using the Windows reg.exe tool.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Credential Acquisition via Registry Hive Dumping\n\nDumping registry hives is a common way to access credential information as some hives store credential material.\n\nFor example, the SAM hive stores locally cached credentials (SAM Secrets), and the SECURITY hive stores domain cached credentials (LSA secrets).\n\nDumping these hives in combination with the SYSTEM hive enables the attacker to decrypt these secrets.\n\nThis rule identifies the usage of `reg.exe` to dump SECURITY and/or SAM hives, which potentially indicates the compromise of the credentials stored in the host.\n\n#### Possible investigation steps\n\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate if the credential material was exfiltrated or processed locally by other tools.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (e.g., 4624) to the target host.\n\n### False positive analysis\n\n- Administrators can export registry hives for backup purposes using command line tools like `reg.exe`. Check whether the user is legitamitely performing this kind of activity.\n\n### Related rules\n\n- Registry Hive File Creation via SMB - a4c7473a-5cb4-4bc1-9d06-e4a75adbc494\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Reimage the host operating system and restore compromised files to clean versions.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 312,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: SentinelOne",
          "Data Source: Sysmon",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://medium.com/threatpunter/detecting-attempts-to-steal-passwords-from-the-registry-7512674487f8",
          "https://www.elastic.co/security-labs/detect-credential-access"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1003",
                "name": "OS Credential Dumping",
                "reference": "https://attack.mitre.org/techniques/T1003/",
                "subtechnique": [
                  {
                    "id": "T1003.002",
                    "name": "Security Account Manager",
                    "reference": "https://attack.mitre.org/techniques/T1003/002/"
                  },
                  {
                    "id": "T1003.004",
                    "name": "LSA Secrets",
                    "reference": "https://attack.mitre.org/techniques/T1003/004/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "7b57fe6b-f4af-47f4-844e-cfdab94a69fd",
        "rule_id": "a7e7bfa3-088e-4f13-b29e-3986e0e756b8",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:55.280Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:31.964Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n (?process.pe.original_file_name == \"reg.exe\" or process.name : \"reg.exe\") and\n process.args : (\"save\", \"export\") and\n process.args : (\"hklm\\\\sam\", \"hklm\\\\security\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Adding Hidden File Attribute via Attrib",
        "description": "Adversaries can add the 'hidden' attribute to files to hide them from the user in an attempt to evade detection.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "timeline_id": "e70679c2-6cde-4510-9764-4823df18f7db",
        "timeline_title": "Comprehensive Process Timeline",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Adding Hidden File Attribute via Attrib\n\nThe `Hidden` attribute is a file or folder attribute that makes the file or folder invisible to regular directory listings when the attribute is set. \n\nAttackers can use this attribute to conceal tooling and malware to prevent administrators and users from finding it, even if they are looking specifically for it.\n\nThis rule looks for the execution of the `attrib.exe` utility with a command line that indicates the modification of the `Hidden` attribute.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Examine the command line to identify the target file or folder.\n  - Examine the file, which process created it, header, etc.\n  - If suspicious, retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Observe and collect information about the following activities in the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 314,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Tactic: Persistence",
          "Data Source: Elastic Endgame",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1222",
                "name": "File and Directory Permissions Modification",
                "reference": "https://attack.mitre.org/techniques/T1222/",
                "subtechnique": [
                  {
                    "id": "T1222.001",
                    "name": "Windows File and Directory Permissions Modification",
                    "reference": "https://attack.mitre.org/techniques/T1222/001/"
                  }
                ]
              },
              {
                "id": "T1564",
                "name": "Hide Artifacts",
                "reference": "https://attack.mitre.org/techniques/T1564/",
                "subtechnique": [
                  {
                    "id": "T1564.001",
                    "name": "Hidden Files and Directories",
                    "reference": "https://attack.mitre.org/techniques/T1564/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            }
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "442ccdca-e8e5-48a3-8e63-b84692c2ae8a",
        "rule_id": "4630d948-40d4-4cef-ac69-4002e29bc3db",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:55.284Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:27.584Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (process.name : \"attrib.exe\" or ?process.pe.original_file_name == \"ATTRIB.EXE\") and process.args : \"+h\" and\n  not (process.parent.name: \"cmd.exe\" and process.command_line: \"attrib  +R +H +S +A *.cui\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Machine Learning Detected a Suspicious Windows Event with a High Malicious Probability Score",
        "description": "A supervised machine learning model (ProblemChild) has identified a suspicious Windows process event with high probability of it being malicious activity. Alternatively, the model's blocklist identified the event as being malicious.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 110,
        "tags": [
          "OS: Windows",
          "Data Source: Elastic Endgame",
          "Use Case: Living off the Land Attack Detection",
          "Rule Type: ML",
          "Rule Type: Machine Learning",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-600s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/guide/en/security/current/prebuilt-ml-jobs.html",
          "https://docs.elastic.co/en/integrations/problemchild",
          "https://www.elastic.co/security-labs/detecting-living-off-the-land-attacks-with-new-elastic-integration"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1036",
                "name": "Masquerading",
                "reference": "https://attack.mitre.org/techniques/T1036/",
                "subtechnique": [
                  {
                    "id": "T1036.004",
                    "name": "Masquerade Task or Service",
                    "reference": "https://attack.mitre.org/techniques/T1036/004/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe rule requires the Living off the Land (LotL) Attack Detection integration assets to be installed, as well as Windows process events collected by integrations such as Elastic Defend or Winlogbeat.  \n\n### LotL Attack Detection Setup\nThe LotL Attack Detection integration detects living-off-the-land activity in Windows process events.\n\n#### Prerequisite Requirements:\n- Fleet is required for LotL Attack Detection.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n- Windows process events collected by the [Elastic Defend](https://docs.elastic.co/en/integrations/endpoint) integration or Winlogbeat(https://www.elastic.co/guide/en/beats/winlogbeat/current/_winlogbeat_overview.html).\n- To install Elastic Defend, refer to the [documentation](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n- To set up and run Winlogbeat, follow [this](https://www.elastic.co/guide/en/beats/winlogbeat/current/winlogbeat-installation-configuration.html) guide.\n\n#### The following steps should be executed to install assets associated with the LotL Attack Detection integration:\n- Go to the Kibana homepage. Under Management, click Integrations.\n- In the query bar, search for Living off the Land Attack Detection and select the integration to see more details about it.\n- Follow the instructions under the **Installation** section.\n- For this rule to work, complete the instructions through **Configure the ingest pipeline**.\n",
        "related_integrations": [
          {
            "package": "problemchild",
            "version": "^2.0.0"
          },
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "blocklist_label",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "problemchild.prediction",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "problemchild.prediction_probability",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "ff4955ba-2a7d-4457-b057-96dac035b202",
        "rule_id": "994e40aa-8c85-43de-825e-15f665375ee8",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:55.287Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:31.820Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where ((problemchild.prediction == 1 and problemchild.prediction_probability > 0.98) or\nblocklist_label == 1) and not process.args : (\"*C:\\\\WINDOWS\\\\temp\\\\nessus_*.txt*\", \"*C:\\\\WINDOWS\\\\temp\\\\nessus_*.tmp*\")",
        "language": "eql",
        "index": [
          "endgame-*",
          "logs-endpoint.events.process-*",
          "winlogbeat-*"
        ],
        "filters": []
      },
      {
        "name": "Execution via TSClient Mountpoint",
        "description": "Identifies execution from the Remote Desktop Protocol (RDP) shared mountpoint tsclient on the target host. This may indicate a lateral movement attempt.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 313,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Lateral Movement",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://posts.specterops.io/revisiting-remote-desktop-lateral-movement-8fb905cb46c3",
          "https://www.elastic.co/security-labs/hunting-for-lateral-movement-using-event-query-language"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1021",
                "name": "Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1021/",
                "subtechnique": [
                  {
                    "id": "T1021.001",
                    "name": "Remote Desktop Protocol",
                    "reference": "https://attack.mitre.org/techniques/T1021/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "dd832895-4c79-4773-9443-ccec4e79f0aa",
        "rule_id": "4fe9d835-40e1-452d-8230-17c147cafad8",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:55.291Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:27.655Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and process.executable : \"\\\\Device\\\\Mup\\\\tsclient\\\\*.exe\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "winlogbeat-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Service DACL Modification via sc.exe",
        "description": "Identifies DACL modifications to deny access to a service, making it unstoppable, or hide it from system and users.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 204,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://blogs.jpcert.or.jp/en/2024/07/mirrorface-attack-against-japanese-organisations.html",
          "https://github.com/SigmaHQ/sigma/blob/master/rules/windows/process_creation/proc_creation_win_sc_sdset_deny_service_access.yml",
          "https://learn.microsoft.com/en-us/windows/win32/secauthz/sid-strings",
          "https://www.sans.org/blog/red-team-tactics-hiding-windows-services/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1564",
                "name": "Hide Artifacts",
                "reference": "https://attack.mitre.org/techniques/T1564/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1543",
                "name": "Create or Modify System Process",
                "reference": "https://attack.mitre.org/techniques/T1543/",
                "subtechnique": [
                  {
                    "id": "T1543.003",
                    "name": "Windows Service",
                    "reference": "https://attack.mitre.org/techniques/T1543/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "5465ad0a-f8dd-42d7-9c6f-d440930c0890",
        "rule_id": "5188c68e-d3de-4e96-994d-9e242269446f",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:55.295Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:27.670Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (process.name : \"sc.exe\" or ?process.pe.original_file_name : \"sc.exe\") and\n  process.args : \"sdset\" and process.args : \"*D;*\" and\n  process.args : (\"*;IU*\", \"*;SU*\", \"*;BA*\", \"*;SY*\", \"*;WD*\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-m365_defender.event-*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Microsoft Build Engine Started by a System Process",
        "description": "An instance of MSBuild, the Microsoft Build Engine, was started by Explorer or the WMI (Windows Management Instrumentation) subsystem. This behavior is unusual and is sometimes used by malicious payloads.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 312,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Tactic: Execution",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "The Build Engine is commonly used by Windows developers but use by non-engineers is unusual."
        ],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1127",
                "name": "Trusted Developer Utilities Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1127/",
                "subtechnique": [
                  {
                    "id": "T1127.001",
                    "name": "MSBuild",
                    "reference": "https://attack.mitre.org/techniques/T1127/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            }
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "1be8b7bf-1908-4bee-b38a-efcf971a1792",
        "rule_id": "9d110cb3-5f4b-4c9a-b9f5-53f0a1707ae3",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:55.298Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:31.877Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.name : \"MSBuild.exe\" and\n  process.parent.name : (\"explorer.exe\", \"wmiprvse.exe\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Control Panel Process with Unusual Arguments",
        "description": "Identifies unusual instances of Control Panel with suspicious keywords or paths in the process command line value. Adversaries may abuse control.exe to proxy execution of malicious code.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 313,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Tactic: Execution",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.joesandbox.com/analysis/476188/1/html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1218",
                "name": "System Binary Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1218/",
                "subtechnique": [
                  {
                    "id": "T1218.002",
                    "name": "Control Panel",
                    "reference": "https://attack.mitre.org/techniques/T1218/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "00d562d7-fcca-42fa-b750-b2b423a4eb40",
        "rule_id": "416697ae-e468-4093-a93d-59661fa619ec",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:55.301Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:25.742Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.name : \"control.exe\" and \n  process.command_line : (\n    \"*.jpg*\", \"*.png*\",\n    \"*.gif*\", \"*.bmp*\",\n    \"*.jpeg*\", \"*.TIFF*\",\n    \"*.inf*\", \"*.cpl:*/*\",\n    \"*../../..*\",\n    \"*/AppData/Local/*\",\n    \"*:\\\\Users\\\\Public\\\\*\",\n    \"*\\\\AppData\\\\Local\\\\*\"\n)",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "winlogbeat-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Encrypting Files with WinRar or 7z",
        "description": "Identifies use of WinRar or 7z to create an encrypted files. Adversaries will often compress and encrypt data in preparation for exfiltration.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Encrypting Files with WinRar or 7z\n\nAttackers may compress and/or encrypt data collected before exfiltration. Compressing the data can help obfuscate the collected data and minimize the amount of data sent over the network. Encryption can be used to hide information that is being exfiltrated from detection or make exfiltration less apparent upon inspection by a defender.\n\nThese steps are usually done in preparation for exfiltration, meaning the attack may be in its final stages.\n\n#### Possible investigation steps\n\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Retrieve the encrypted file.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Check if the password used in the encryption was included in the command line.\n- Decrypt the `.rar`/`.zip` and check if the information is sensitive.\n- If the password is not available, and the format is `.zip` or the option used in WinRAR is not the `-hp`, list the file names included in the encrypted file.\n- Investigate if the file was transferred to an attacker-controlled server.\n\n### False positive analysis\n\n- Backup software can use these utilities. Check the `process.parent.executable` and `process.parent.command_line` fields to determine what triggered the encryption.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Prioritize cases that involve personally identifiable information (PII) or other classified data.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 214,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Collection",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: SentinelOne"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.welivesecurity.com/2020/12/02/turla-crutch-keeping-back-door-open/",
          "https://www.elastic.co/security-labs/siestagraph-new-implant-uncovered-in-asean-member-foreign-ministry"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0009",
              "name": "Collection",
              "reference": "https://attack.mitre.org/tactics/TA0009/"
            },
            "technique": [
              {
                "id": "T1005",
                "name": "Data from Local System",
                "reference": "https://attack.mitre.org/techniques/T1005/"
              },
              {
                "id": "T1560",
                "name": "Archive Collected Data",
                "reference": "https://attack.mitre.org/techniques/T1560/",
                "subtechnique": [
                  {
                    "id": "T1560.001",
                    "name": "Archive via Utility",
                    "reference": "https://attack.mitre.org/techniques/T1560/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.code_signature.subject_name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "b21fe96b-7b21-42b6-9c06-dbda71060d8b",
        "rule_id": "45d273fb-1dca-457d-9855-bcb302180c21",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:55.305Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:27.568Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n(\n  (\n    (\n      process.name:\"rar.exe\" or ?process.code_signature.subject_name == \"win.rar GmbH\" or\n      ?process.pe.original_file_name == \"Command line RAR\"\n    ) and\n    process.args == \"a\" and process.args : (\"-hp*\", \"-p*\", \"/hp*\", \"/p*\")\n  ) or\n  (\n    (process.name : (\"7z.exe\", \"7za.exe\") or ?process.pe.original_file_name in (\"7z.exe\", \"7za.exe\")) and\n    process.args == \"a\" and process.args : \"-p*\"\n  )\n) and\n  not process.parent.executable : (\n        \"C:\\\\Program Files\\\\*.exe\",\n        \"C:\\\\Program Files (x86)\\\\*.exe\",\n        \"?:\\\\ManageEngine\\\\*\\\\jre\\\\bin\\\\java.exe\",\n        \"?:\\\\Nox\\\\bin\\\\Nox.exe\",\n        \"\\\\Device\\\\HarddiskVolume?\\\\Program Files\\\\*.exe\",\n        \"\\\\Device\\\\HarddiskVolume?\\\\Program Files (x86)\\\\*.exe\",\n        \"\\\\Device\\\\HarddiskVolume?\\\\ManageEngine\\\\*\\\\jre\\\\bin\\\\java.exe\",\n        \"\\\\Device\\\\HarddiskVolume?\\\\Nox\\\\bin\\\\Nox.exe\"\n      )",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "winlogbeat-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*"
        ],
        "filters": []
      },
      {
        "name": "Unusual Parent-Child Relationship",
        "description": "Identifies Windows programs run from unexpected parent processes. This could indicate masquerading or other strange activity on a system.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Unusual Parent-Child Relationship\n\nWindows internal/system processes have some characteristics that can be used to spot suspicious activities. One of these characteristics is parent-child relationships. These relationships can be used to baseline the typical behavior of the system and then alert on occurrences that don't comply with the baseline.\n\nThis rule uses this information to spot suspicious parent and child processes.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate any abnormal behavior by the subject process such as network connections, registry or file modifications, and any spawned child processes.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the process executable using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 314,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/sbousseaden/Slides/blob/master/Hunting%20MindMaps/PNG/Windows%20Processes%20TH.map.png",
          "https://www.andreafortuna.org/2017/06/15/standard-windows-processes-a-brief-reference/",
          "https://www.elastic.co/security-labs/elastic-security-labs-steps-through-the-r77-rootkit"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1055",
                "name": "Process Injection",
                "reference": "https://attack.mitre.org/techniques/T1055/",
                "subtechnique": [
                  {
                    "id": "T1055.012",
                    "name": "Process Hollowing",
                    "reference": "https://attack.mitre.org/techniques/T1055/012/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "b1aed1d7-fd7f-4fe6-bc7e-0720d1ae4b43",
        "rule_id": "35df0dd8-092d-4a83-88c1-5151a804f31b",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:55.309Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:25.658Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\nprocess.parent.name != null and\n (\n   /* suspicious parent processes */\n   (process.name:\"autochk.exe\" and not process.parent.name:\"smss.exe\") or\n   (process.name:(\"fontdrvhost.exe\", \"dwm.exe\") and not process.parent.name:(\"wininit.exe\", \"winlogon.exe\")) or\n   (process.name:(\"consent.exe\", \"RuntimeBroker.exe\", \"TiWorker.exe\") and not process.parent.name:\"svchost.exe\") or\n   (process.name:\"SearchIndexer.exe\" and not process.parent.name:\"services.exe\") or\n   (process.name:\"SearchProtocolHost.exe\" and not process.parent.name:(\"SearchIndexer.exe\", \"dllhost.exe\")) or\n   (process.name:\"dllhost.exe\" and not process.parent.name:(\"services.exe\", \"svchost.exe\")) or\n   (process.name:\"smss.exe\" and not process.parent.name:(\"System\", \"smss.exe\")) or\n   (process.name:\"csrss.exe\" and not process.parent.name:(\"smss.exe\", \"svchost.exe\")) or\n   (process.name:\"wininit.exe\" and not process.parent.name:\"smss.exe\") or\n   (process.name:\"winlogon.exe\" and not process.parent.name:\"smss.exe\") or\n   (process.name:(\"lsass.exe\", \"LsaIso.exe\") and not process.parent.name:\"wininit.exe\") or\n   (process.name:\"LogonUI.exe\" and not process.parent.name:(\"wininit.exe\", \"winlogon.exe\")) or\n   (process.name:\"services.exe\" and not process.parent.name:\"wininit.exe\") or\n   (process.name:\"svchost.exe\" and not process.parent.name:(\"MsMpEng.exe\", \"services.exe\", \"svchost.exe\")) or\n   (process.name:\"spoolsv.exe\" and not process.parent.name:\"services.exe\") or\n   (process.name:\"taskhost.exe\" and not process.parent.name:(\"services.exe\", \"svchost.exe\", \"ngentask.exe\")) or\n   (process.name:\"taskhostw.exe\" and not process.parent.name:(\"services.exe\", \"svchost.exe\")) or\n   (process.name:\"userinit.exe\" and not process.parent.name:(\"dwm.exe\", \"winlogon.exe\")) or\n   (process.name:(\"wmiprvse.exe\", \"wsmprovhost.exe\", \"winrshost.exe\") and not process.parent.name:\"svchost.exe\") or\n   /* suspicious child processes */\n   (process.parent.name:(\"SearchProtocolHost.exe\", \"taskhost.exe\", \"csrss.exe\") and not process.name:(\"werfault.exe\", \"wermgr.exe\", \"WerFaultSecure.exe\", \"conhost.exe\")) or\n   (process.parent.name:\"autochk.exe\" and not process.name:(\"chkdsk.exe\", \"doskey.exe\", \"WerFault.exe\")) or\n   (process.parent.name:\"smss.exe\" and not process.name:(\"autochk.exe\", \"smss.exe\", \"csrss.exe\", \"wininit.exe\", \"winlogon.exe\", \"setupcl.exe\", \"WerFault.exe\")) or\n   (process.parent.name:\"wermgr.exe\" and not process.name:(\"WerFaultSecure.exe\", \"wermgr.exe\", \"WerFault.exe\")) or\n   (process.parent.name:\"conhost.exe\" and not process.name:(\"mscorsvw.exe\", \"wermgr.exe\", \"WerFault.exe\", \"WerFaultSecure.exe\"))\n  )",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Persistence via WMI Event Subscription",
        "description": "An adversary can use Windows Management Instrumentation (WMI) to install event filters, providers, consumers, and bindings that execute code when a defined event occurs. Adversaries may use the capabilities of WMI to subscribe to an event and execute arbitrary code when that event occurs, providing persistence on a system.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 313,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Tactic: Execution",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/security-labs/hunting-for-persistence-using-elastic-security-part-1"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1546",
                "name": "Event Triggered Execution",
                "reference": "https://attack.mitre.org/techniques/T1546/",
                "subtechnique": [
                  {
                    "id": "T1546.003",
                    "name": "Windows Management Instrumentation Event Subscription",
                    "reference": "https://attack.mitre.org/techniques/T1546/003/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1047",
                "name": "Windows Management Instrumentation",
                "reference": "https://attack.mitre.org/techniques/T1047/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "c619753a-347c-4cf3-b978-86f9cb88ff26",
        "rule_id": "9b6813a1-daf1-457e-b0e6-0bb4e55b8a4c",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:55.312Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:31.841Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (process.name : \"wmic.exe\" or ?process.pe.original_file_name == \"wmic.exe\") and\n  process.args : \"create\" and\n  process.args : (\"ActiveScriptEventConsumer\", \"CommandLineEventConsumer\")",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "winlogbeat-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Windows System Information Discovery",
        "description": "Detects the execution of commands used to discover information about the system, which attackers may use after compromising a system to gain situational awareness.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 108,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Rule Type: BBR",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1082",
                "name": "System Information Discovery",
                "reference": "https://attack.mitre.org/techniques/T1082/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "852f094c-50e4-48aa-aadd-309c4dfdc3cc",
        "rule_id": "51176ed2-2d90-49f2-9f3d-17196428b169",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:55.315Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:27.660Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n(\n  (\n    process.name : \"cmd.exe\" and process.args : \"ver*\" and not\n    process.parent.executable : (\n        \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Keybase\\\\upd.exe\",\n        \"?:\\\\Users\\\\*\\\\python*.exe\"\n    )\n  ) or \n  process.name : (\"systeminfo.exe\", \"hostname.exe\") or \n  (process.name : \"wmic.exe\" and process.args : \"os\" and process.args : \"get\")\n) and not\nprocess.parent.executable : (\n    \"?:\\\\Program Files\\\\*\",\n    \"?:\\\\Program Files (x86)\\\\*\",\n    \"?:\\\\ProgramData\\\\*\"\n) and not user.id : \"S-1-5-18\"",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.*",
          "endgame-*",
          "logs-system.security*"
        ],
        "filters": []
      },
      {
        "name": "Execution via MSSQL xp_cmdshell Stored Procedure",
        "description": "Identifies execution via MSSQL xp_cmdshell stored procedure. Malicious users may attempt to elevate their privileges by using xp_cmdshell, which is disabled by default, thus, it's important to review the context of it's use.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Execution via MSSQL xp_cmdshell Stored Procedure\n\nMicrosoft SQL Server (MSSQL) has procedures meant to extend its functionality, the Extended Stored Procedures. These procedures are external functions written in C/C++; some provide interfaces for external programs. This is the case for xp_cmdshell, which spawns a Windows command shell and passes in a string for execution. Attackers can use this to execute commands on the system running the SQL server, commonly to escalate their privileges and establish persistence.\n\nThe xp_cmdshell procedure is disabled by default, but when used, it has the same security context as the MSSQL Server service account, which is often privileged.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate any abnormal account behavior, such as command executions, file creations or modifications, and network connections.\n- Investigate any abnormal behavior by the subject process such as network connections, registry or file modifications, and any spawned child processes.\n- Examine the command line to determine if the command executed is potentially harmful or malicious.\n- Inspect the host for suspicious or abnormal behavior in the alert timeframe.\n\n### False positive analysis\n\n- This mechanism can be used legitimately, but it brings inherent risk. The security team must monitor any activity of it. If recurrent tasks are being executed using this mechanism, consider adding exceptions â€” preferably with a full command line.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Remove and block malicious artifacts identified during triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Ensure that SQL servers are not directly exposed to the internet. If there is a business justification for such, use an allowlist to allow only connections from known legitimate sources.\n- Disable the xp_cmdshell stored procedure.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 313,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://thedfirreport.com/2022/07/11/select-xmrig-from-sqlserver/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1505",
                "name": "Server Software Component",
                "reference": "https://attack.mitre.org/techniques/T1505/",
                "subtechnique": [
                  {
                    "id": "T1505.001",
                    "name": "SQL Stored Procedures",
                    "reference": "https://attack.mitre.org/techniques/T1505/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.003",
                    "name": "Windows Command Shell",
                    "reference": "https://attack.mitre.org/techniques/T1059/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "206950b7-55c3-44ab-b0f7-ce79ac380135",
        "rule_id": "4ed493fc-d637-4a36-80ff-ac84937e5461",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:55.317Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:27.646Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and process.parent.name : \"sqlservr.exe\" and \n  (\n   (process.name : \"cmd.exe\" and \n    not process.args : (\"\\\\\\\\*\", \"diskfree\", \"rmdir\", \"mkdir\", \"dir\", \"del\", \"rename\", \"bcp\", \"*XMLNAMESPACES*\", \n                        \"?:\\\\MSSQL\\\\Backup\\\\Jobs\\\\sql_agent_backup_job.ps1\", \"K:\\\\MSSQL\\\\Backup\\\\msdb\", \"K:\\\\MSSQL\\\\Backup\\\\Logins\")) or \n                        \n   (process.name : \"vpnbridge.exe\" or ?process.pe.original_file_name : \"vpnbridge.exe\") or \n\n   (process.name : \"certutil.exe\" or ?process.pe.original_file_name == \"CertUtil.exe\") or \n\n   (process.name : \"bitsadmin.exe\" or ?process.pe.original_file_name == \"bitsadmin.exe\")\n  )",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Microsoft Exchange Server UM Spawning Suspicious Processes",
        "description": "Identifies suspicious processes being spawned by the Microsoft Exchange Server Unified Messaging (UM) service. This activity has been observed exploiting CVE-2021-26857.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 311,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Initial Access",
          "Tactic: Lateral Movement",
          "Data Source: Elastic Endgame",
          "Use Case: Vulnerability",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic",
          "Austin Songer"
        ],
        "false_positives": [
          "Legitimate processes may be spawned from the Microsoft Exchange Server Unified Messaging (UM) service. If known processes are causing false positives, they can be exempted from the rule."
        ],
        "references": [
          "https://www.microsoft.com/security/blog/2021/03/02/hafnium-targeting-exchange-servers",
          "https://www.volexity.com/blog/2021/03/02/active-exploitation-of-microsoft-exchange-zero-day-vulnerabilities"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1190",
                "name": "Exploit Public-Facing Application",
                "reference": "https://attack.mitre.org/techniques/T1190/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1210",
                "name": "Exploitation of Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1210/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "cae7741a-e719-4123-ba1d-a46271e0b905",
        "rule_id": "483c4daf-b0c6-49e0-adf3-0bfa93231d6b",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:55.321Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:27.600Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.parent.name : (\"UMService.exe\", \"UMWorkerProcess.exe\") and\n    not process.executable : (\n          \"?:\\\\Windows\\\\System32\\\\werfault.exe\",\n          \"?:\\\\Windows\\\\System32\\\\wermgr.exe\",\n          \"?:\\\\Program Files\\\\Microsoft\\\\Exchange Server\\\\V??\\\\Bin\\\\UMWorkerProcess.exe\",\n          \"?:\\\\Program Files\\\\Microsoft\\\\Exchange Server\\\\Bin\\\\UMWorkerProcess.exe\",\n          \"D:\\\\Exchange 2016\\\\Bin\\\\UMWorkerProcess.exe\",\n          \"E:\\\\ExchangeServer\\\\Bin\\\\UMWorkerProcess.exe\",\n          \"D:\\\\Exchange\\\\Bin\\\\UMWorkerProcess.exe\",\n          \"D:\\\\Exchange Server\\\\Bin\\\\UMWorkerProcess.exe\",\n          \"E:\\\\Exchange Server\\\\V15\\\\Bin\\\\UMWorkerProcess.exe\",\n          \"\\\\Device\\\\HarddiskVolume?\\\\Windows\\\\System32\\\\werfault.exe\",\n          \"\\\\Device\\\\HarddiskVolume?\\\\Windows\\\\System32\\\\wermgr.exe\",\n          \"\\\\Device\\\\HarddiskVolume?\\\\Program Files\\\\Microsoft\\\\Exchange Server\\\\V??\\\\Bin\\\\UMWorkerProcess.exe\",\n          \"\\\\Device\\\\HarddiskVolume?\\\\Program Files\\\\Microsoft\\\\Exchange Server\\\\Bin\\\\UMWorkerProcess.exe\",\n          \"\\\\Device\\\\HarddiskVolume?\\\\Exchange 2016\\\\Bin\\\\UMWorkerProcess.exe\",\n          \"\\\\Device\\\\HarddiskVolume?\\\\ExchangeServer\\\\Bin\\\\UMWorkerProcess.exe\",\n          \"\\\\Device\\\\HarddiskVolume?\\\\Exchange\\\\Bin\\\\UMWorkerProcess.exe\",\n          \"\\\\Device\\\\HarddiskVolume?\\\\Exchange Server\\\\Bin\\\\UMWorkerProcess.exe\",\n          \"\\\\Device\\\\HarddiskVolume?\\\\Exchange Server\\\\V15\\\\Bin\\\\UMWorkerProcess.exe\"\n    )",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "winlogbeat-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Potential Local NTLM Relay via HTTP",
        "description": "Identifies attempt to coerce a local NTLM authentication via HTTP using the Windows Printer Spooler service as a target. An adversary may use this primitive in combination with other techniques to elevate privileges on a compromised system.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 311,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/med0x2e/NTLMRelay2Self",
          "https://github.com/topotam/PetitPotam",
          "https://github.com/dirkjanm/krbrelayx/blob/master/printerbug.py"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1212",
                "name": "Exploitation for Credential Access",
                "reference": "https://attack.mitre.org/techniques/T1212/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1218",
                "name": "System Binary Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1218/",
                "subtechnique": [
                  {
                    "id": "T1218.011",
                    "name": "Rundll32",
                    "reference": "https://attack.mitre.org/techniques/T1218/011/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "e545b7c2-ac01-4c66-917b-92cce594af63",
        "rule_id": "4682fd2c-cfae-47ed-a543-9bed37657aa6",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:55.334Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:27.589Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.name : \"rundll32.exe\" and\n\n  /* Rundll32 WbeDav Client  */\n  process.args : (\"?:\\\\Windows\\\\System32\\\\davclnt.dll,DavSetCookie\", \"?:\\\\Windows\\\\SysWOW64\\\\davclnt.dll,DavSetCookie\") and\n\n  /* Access to named pipe via http */\n  process.args : (\"http*/print/pipe/*\", \"http*/pipe/spoolss\", \"http*/pipe/srvsvc\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "PowerShell Share Enumeration Script",
        "description": "Detects scripts that contain PowerShell functions, structures, or Windows API functions related to windows share enumeration activities. Attackers, mainly ransomware groups, commonly identify and inspect network shares, looking for critical information for encryption and/or exfiltration.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating PowerShell Share Enumeration Script\n\nPowerShell is one of the main tools system administrators use for automation, report routines, and other tasks. This makes it available for use in various environments, and creates an attractive way for attackers to execute code.\n\nAttackers can use PowerShell to enumerate shares to search for sensitive data like documents, scripts, and other kinds of valuable data for encryption, exfiltration, and lateral movement.\n\n#### Possible investigation steps\n\n- Examine the script content that triggered the detection; look for suspicious DLL imports, collection or exfiltration capabilities, suspicious functions, encoded or compressed data, and other potentially malicious characteristics.\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Evaluate whether the user needs to use PowerShell to complete tasks.\n- Check for additional PowerShell and command line logs that indicate that imported functions were run.\n  - Evaluate which information was potentially mapped and accessed by the attacker.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Restrict PowerShell usage outside of IT and engineering business units using GPOs, AppLocker, Intune, or similar software.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 111,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Tactic: Collection",
          "Tactic: Execution",
          "Resources: Investigation Guide",
          "Data Source: PowerShell Logs"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.advintel.io/post/hunting-for-corporate-insurance-policies-indicators-of-ransom-exfiltrations",
          "https://thedfirreport.com/2022/04/04/stolen-images-campaign-ends-in-conti-ransomware/",
          "https://github.com/atc-project/atc-data/blob/master/docs/Logging_Policies/LP_0109_windows_powershell_script_block_log.md"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1135",
                "name": "Network Share Discovery",
                "reference": "https://attack.mitre.org/techniques/T1135/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              },
              {
                "id": "T1106",
                "name": "Native API",
                "reference": "https://attack.mitre.org/techniques/T1106/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0009",
              "name": "Collection",
              "reference": "https://attack.mitre.org/tactics/TA0009/"
            },
            "technique": [
              {
                "id": "T1039",
                "name": "Data from Network Shared Drive",
                "reference": "https://attack.mitre.org/techniques/T1039/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'PowerShell Script Block Logging' logging policy must be configured (Enable).\n\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nAdministrative Templates >\nWindows PowerShell >\nTurn on PowerShell Script Block Logging (Enable)\n```\n\nSteps to implement the logging policy via registry:\n\n```\nreg add \"hklm\\SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\ScriptBlockLogging\" /v EnableScriptBlockLogging /t REG_DWORD /d 1\n```\n",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "powershell.file.script_block_text",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "ded7bb13-20bb-4abb-bc78-a80e4523dd33",
        "rule_id": "4c59cff1-b78a-41b8-a9f1-4231984d1fb6",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:55.337Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:27.631Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-windows.powershell*"
        ],
        "filters": [],
        "query": "event.category:process and host.os.type:windows and\n  powershell.file.script_block_text:(\n    \"Invoke-ShareFinder\" or\n    \"Invoke-ShareFinderThreaded\" or\n    (\n      \"shi1_netname\" and\n      \"shi1_remark\"\n    ) or\n    (\n      \"NetShareEnum\" and\n      \"NetApiBufferFree\"\n    )\n  ) and not user.id : \"S-1-5-18\"",
        "language": "kuery"
      },
      {
        "name": "Privilege Escalation via Named Pipe Impersonation",
        "description": "Identifies a privilege escalation attempt via named pipe impersonation. An adversary may abuse this technique by utilizing a framework such Metasploit's meterpreter getsystem command.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Privilege Escalation via Named Pipe Impersonation\n\nA named pipe is a type of inter-process communication (IPC) mechanism used in operating systems like Windows, which allows two or more processes to communicate with each other by sending and receiving data through a well-known point.\n\nAttackers can abuse named pipes to elevate their privileges by impersonating the security context in which they execute code. Metasploit, for example, creates a service and a random pipe, and then uses the service to connect to the pipe and impersonate the service security context, which is SYSTEM.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Inspect the host for suspicious or abnormal behavior in the alert timeframe.\n- Investigate any abnormal behavior by the subject process such as network connections, registry or file modifications, and any spawned child processes.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - If any suspicious processes were found, examine the process executable using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 312,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.ired.team/offensive-security/privilege-escalation/windows-namedpipes-privilege-escalation",
          "https://www.cobaltstrike.com/blog/what-happens-when-i-type-getsystem/",
          "https://redcanary.com/blog/getsystem-offsec/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1134",
                "name": "Access Token Manipulation",
                "reference": "https://attack.mitre.org/techniques/T1134/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "6b6eb9c6-4483-4be6-9719-fb8f6c85d7be",
        "rule_id": "3ecbdc9e-e4f2-43fa-8cca-63802125e582",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:55.340Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:25.721Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n (process.name : (\"Cmd.Exe\", \"PowerShell.EXE\") or ?process.pe.original_file_name in (\"Cmd.Exe\", \"PowerShell.EXE\")) and\n process.args : \"echo\" and process.args : \">\" and process.args : \"\\\\\\\\.\\\\pipe\\\\*\"",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious PDF Reader Child Process",
        "description": "Identifies suspicious child processes of PDF reader applications. These child processes are often launched via exploitation of PDF applications or social engineering.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Suspicious PDF Reader Child Process\n\nPDF is a common file type used in corporate environments and most machines have software to handle these files. This creates a vector where attackers can exploit the engines and technology behind this class of software for initial access or privilege escalation.\n\nThis rule looks for commonly abused built-in utilities spawned by a PDF reader process, which is likely a malicious behavior.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Retrieve PDF documents received and opened by the user that could cause this behavior. Common locations include, but are not limited to, the Downloads and Document folders and the folder configured at the email client.\n- Determine if the collected files are malicious:\n  - Use a private sandboxed malware analysis system to perform analysis.\n    - Observe and collect information about the following activities:\n      - Attempts to contact external domains and addresses.\n      - File and registry access, modification, and creation activities.\n      - Service creation and launch activities.\n      - Scheduled task creation.\n  - Use the PowerShell `Get-FileHash` cmdlet to get the files' SHA-256 hash values.\n    - Search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n  - If the malicious file was delivered via phishing:\n    - Block the email sender from sending future emails.\n    - Block the malicious web pages.\n    - Remove emails from the sender from mailboxes.\n    - Consider improvements to the security awareness program.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 313,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Tactic: Initial Access",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1203",
                "name": "Exploitation for Client Execution",
                "reference": "https://attack.mitre.org/techniques/T1203/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1566",
                "name": "Phishing",
                "reference": "https://attack.mitre.org/techniques/T1566/",
                "subtechnique": [
                  {
                    "id": "T1566.001",
                    "name": "Spearphishing Attachment",
                    "reference": "https://attack.mitre.org/techniques/T1566/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "34f57b93-6361-4cef-9db4-028ad9a6baab",
        "rule_id": "53a26770-9cbd-40c5-8b57-61d01a325e14",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:55.344Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:27.694Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.parent.name : (\"AcroRd32.exe\",\n                         \"Acrobat.exe\",\n                         \"FoxitPhantomPDF.exe\",\n                         \"FoxitReader.exe\") and\n  process.name : (\"arp.exe\", \"dsquery.exe\", \"dsget.exe\", \"gpresult.exe\", \"hostname.exe\", \"ipconfig.exe\", \"nbtstat.exe\",\n                  \"net.exe\", \"net1.exe\", \"netsh.exe\", \"netstat.exe\", \"nltest.exe\", \"ping.exe\", \"qprocess.exe\",\n                  \"quser.exe\", \"qwinsta.exe\", \"reg.exe\", \"sc.exe\", \"systeminfo.exe\", \"tasklist.exe\", \"tracert.exe\",\n                  \"whoami.exe\", \"bginfo.exe\", \"cdb.exe\", \"cmstp.exe\", \"csi.exe\", \"dnx.exe\", \"fsi.exe\", \"ieexec.exe\",\n                  \"iexpress.exe\", \"installutil.exe\", \"Microsoft.Workflow.Compiler.exe\", \"msbuild.exe\", \"mshta.exe\",\n                  \"msxsl.exe\", \"odbcconf.exe\", \"rcsi.exe\", \"regsvr32.exe\", \"xwizard.exe\", \"atbroker.exe\",\n                  \"forfiles.exe\", \"schtasks.exe\", \"regasm.exe\", \"regsvcs.exe\", \"cmd.exe\", \"cscript.exe\",\n                  \"powershell.exe\", \"pwsh.exe\", \"wmic.exe\", \"wscript.exe\", \"bitsadmin.exe\", \"certutil.exe\", \"ftp.exe\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious MS Office Child Process",
        "description": "Identifies suspicious child processes of frequently targeted Microsoft Office applications (Word, PowerPoint, Excel). These child processes are often launched during exploitation of Office applications or from documents with malicious macros.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Suspicious MS Office Child Process\n\nMicrosoft Office (MS Office) is a suite of applications designed to help with productivity and completing common tasks on a computer. You can create and edit documents containing text and images, work with data in spreadsheets and databases, and create presentations and posters. As it is some of the most-used software across companies, MS Office is frequently targeted for initial access. It also has a wide variety of capabilities that attackers can take advantage of.\n\nThis rule looks for suspicious processes spawned by MS Office programs. This is generally the result of the execution of malicious documents.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Retrieve MS Office documents received and opened by the user that could cause this behavior. Common locations include, but are not limited to, the Downloads and Document folders and the folder configured at the email client.\n- Determine if the collected files are malicious:\n  - Use a private sandboxed malware analysis system to perform analysis.\n    - Observe and collect information about the following activities:\n      - Attempts to contact external domains and addresses.\n      - File and registry access, modification, and creation activities.\n      - Service creation and launch activities.\n      - Scheduled task creation.\n  - Use the PowerShell Get-FileHash cmdlet to get the files' SHA-256 hash values.\n    - Search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n  - If the malicious file was delivered via phishing:\n    - Block the email sender from sending future emails.\n    - Block the malicious web pages.\n    - Remove emails from the sender from mailboxes.\n    - Consider improvements to the security awareness program.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 314,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Initial Access",
          "Tactic: Defense Evasion",
          "Tactic: Execution",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/blog/vulnerability-summary-follina"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1566",
                "name": "Phishing",
                "reference": "https://attack.mitre.org/techniques/T1566/",
                "subtechnique": [
                  {
                    "id": "T1566.001",
                    "name": "Spearphishing Attachment",
                    "reference": "https://attack.mitre.org/techniques/T1566/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  },
                  {
                    "id": "T1059.003",
                    "name": "Windows Command Shell",
                    "reference": "https://attack.mitre.org/techniques/T1059/003/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1218",
                "name": "System Binary Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1218/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "20b49fbb-a873-4f94-a4ba-193f4cf037ed",
        "rule_id": "a624863f-a70d-417f-a7d2-7a404638d47f",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:55.347Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:31.954Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.parent.name : (\n      \"eqnedt32.exe\", \"excel.exe\", \"fltldr.exe\", \"msaccess.exe\",\n      \"mspub.exe\", \"powerpnt.exe\", \"winword.exe\", \"outlook.exe\"\n  ) and\n  process.name : (\n      \"Microsoft.Workflow.Compiler.exe\", \"arp.exe\", \"atbroker.exe\", \"bginfo.exe\", \"bitsadmin.exe\", \"cdb.exe\",\n      \"certutil.exe\", \"cmd.exe\", \"cmstp.exe\", \"control.exe\", \"cscript.exe\", \"csi.exe\", \"dnx.exe\", \"dsget.exe\",\n      \"dsquery.exe\", \"forfiles.exe\", \"fsi.exe\", \"ftp.exe\", \"gpresult.exe\", \"hostname.exe\", \"ieexec.exe\", \"iexpress.exe\",\n      \"installutil.exe\", \"ipconfig.exe\", \"mshta.exe\", \"msxsl.exe\", \"nbtstat.exe\", \"net.exe\", \"net1.exe\", \"netsh.exe\",\n      \"netstat.exe\", \"nltest.exe\", \"odbcconf.exe\", \"ping.exe\", \"powershell.exe\", \"pwsh.exe\", \"qprocess.exe\",\n      \"quser.exe\", \"qwinsta.exe\", \"rcsi.exe\", \"reg.exe\", \"regasm.exe\", \"regsvcs.exe\", \"regsvr32.exe\", \"sc.exe\",\n      \"schtasks.exe\", \"systeminfo.exe\", \"tasklist.exe\", \"tracert.exe\", \"whoami.exe\", \"wmic.exe\", \"wscript.exe\",\n      \"xwizard.exe\", \"explorer.exe\", \"rundll32.exe\", \"hh.exe\", \"msdt.exe\"\n  ) and\n  not (\n    process.parent.name : \"outlook.exe\" and\n    process.name : \"rundll32.exe\" and\n    process.args : \"shell32.dll,Control_RunDLL\" and\n    process.args : \"srchadmin.dll\"\n  )",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Potential Invoke-Mimikatz PowerShell Script",
        "description": "Mimikatz is a credential dumper capable of obtaining plaintext Windows account logins and passwords, along with many other features that make it useful for testing the security of networks. This rule detects Invoke-Mimikatz PowerShell script and alike.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Mimikatz PowerShell Activity\n\n[Mimikatz](https://github.com/gentilkiwi/mimikatz) is an open-source tool used to collect, decrypt, and/or use cached credentials. This tool is commonly abused by adversaries during the post-compromise stage where adversaries have gained an initial foothold on an endpoint and are looking to elevate privileges and seek out additional authentication objects such as tokens/hashes/credentials that can then be used to move laterally and pivot across a network.\n\nThis rule looks for PowerShell scripts that load mimikatz in memory, like Invoke-Mimikataz, which are used to dump credentials from the Local Security Authority Subsystem Service (LSASS). Any activity triggered from this rule should be treated with high priority as it typically represents an active adversary.\n\nMore information about Mimikatz components and how to detect/prevent them can be found on [ADSecurity](https://adsecurity.org/?page_id=1821).\n\n#### Possible investigation steps\n\n- Examine the script content that triggered the detection; look for suspicious DLL imports, collection or exfiltration capabilities, suspicious functions, encoded or compressed data, and other potentially malicious characteristics.\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Examine file or network events from the involved PowerShell process for suspicious behavior.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n  - Invoke-Mimitakz and alike scripts heavily use other capabilities covered by other detections described in the \"Related Rules\" section.\n- Evaluate whether the user needs to use PowerShell to complete tasks.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host.\n  - Examine network and security events in the environment to identify potential lateral movement using compromised credentials.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Related rules\n\n- PowerShell PSReflect Script - 56f2e9b5-4803-4e44-a0a4-a52dc79d57fe\n- Suspicious .NET Reflection via PowerShell - e26f042e-c590-4e82-8e05-41e81bd822ad\n- PowerShell Suspicious Payload Encoded and Compressed - 81fe9dc6-a2d7-4192-a2d8-eed98afc766a\n- Potential Process Injection via PowerShell - 2e29e96a-b67c-455a-afe4-de6183431d0d\n- Mimikatz Memssp Log File Detected - ebb200e8-adf0-43f8-a0bb-4ee5b5d852c6\n- Modification of WDigest Security Provider - d703a5af-d5b0-43bd-8ddb-7a5d500b7da5\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Restrict PowerShell usage outside of IT and engineering business units using GPOs, AppLocker, Intune, or similar software.\n- Validate that cleartext passwords are disabled in memory for use with `WDigest`.\n- Look into preventing access to `LSASS` using capabilities such as LSA protection or antivirus/EDR tools that provide this capability.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 210,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Resources: Investigation Guide",
          "Data Source: PowerShell Logs"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://attack.mitre.org/software/S0002/",
          "https://raw.githubusercontent.com/EmpireProject/Empire/master/data/module_source/credentials/Invoke-Mimikatz.ps1",
          "https://www.elastic.co/security-labs/detect-credential-access"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1003",
                "name": "OS Credential Dumping",
                "reference": "https://attack.mitre.org/techniques/T1003/",
                "subtechnique": [
                  {
                    "id": "T1003.001",
                    "name": "LSASS Memory",
                    "reference": "https://attack.mitre.org/techniques/T1003/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'PowerShell Script Block Logging' logging policy must be configured (Enable).\n\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nAdministrative Templates >\nWindows PowerShell >\nTurn on PowerShell Script Block Logging (Enable)\n```\n\nSteps to implement the logging policy via registry:\n\n```\nreg add \"hklm\\SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\ScriptBlockLogging\" /v EnableScriptBlockLogging /t REG_DWORD /d 1\n```\n",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "powershell.file.script_block_text",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "a709740e-09e8-4cb3-a863-ad44ce26dd76",
        "rule_id": "ac96ceb8-4399-4191-af1d-4feeac1f1f46",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:55.350Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:31.997Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-windows.powershell*"
        ],
        "filters": [],
        "query": "event.category:process and host.os.type:windows and\npowershell.file.script_block_text:(\n  (DumpCreds and\n  DumpCerts) or\n  \"sekurlsa::logonpasswords\" or\n  (\"crypto::certificates\" and\n  \"CERT_SYSTEM_STORE_LOCAL_MACHINE\")\n)",
        "language": "kuery"
      },
      {
        "name": "Disable Windows Event and Security Logs Using Built-in Tools",
        "description": "Identifies attempts to disable EventLog via the logman Windows utility, PowerShell, or auditpol. This is often done by attackers in an attempt to evade detection on a system.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Disable Windows Event and Security Logs Using Built-in Tools\n\nWindows event logs are a fundamental data source for security monitoring, forensics, and incident response. Adversaries can tamper, clear, and delete this data to break SIEM detections, cover their tracks, and slow down incident response.\n\nThis rule looks for the usage of different utilities to disable the EventLog service or specific event logs.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n  - Verify if any other anti-forensics behaviors were observed.\n- Investigate the event logs prior to the action for suspicious behaviors that an attacker may be trying to cover up.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Re-enable affected logging components, services, and security monitoring.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 314,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic",
          "Ivan Ninichuck",
          "Austin Songer"
        ],
        "false_positives": [],
        "references": [
          "https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/logman",
          "https://medium.com/palantir/tampering-with-windows-event-tracing-background-offense-and-defense-4be7ac62ac63"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1070",
                "name": "Indicator Removal",
                "reference": "https://attack.mitre.org/techniques/T1070/",
                "subtechnique": [
                  {
                    "id": "T1070.001",
                    "name": "Clear Windows Event Logs",
                    "reference": "https://attack.mitre.org/techniques/T1070/001/"
                  }
                ]
              },
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.002",
                    "name": "Disable Windows Event Logging",
                    "reference": "https://attack.mitre.org/techniques/T1562/002/"
                  },
                  {
                    "id": "T1562.006",
                    "name": "Indicator Blocking",
                    "reference": "https://attack.mitre.org/techniques/T1562/006/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "15cd86f3-e7a4-4250-8a13-00eb06ca1f92",
        "rule_id": "4de76544-f0e5-486a-8f84-eae0b6063cdc",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:55.353Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:27.636Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n(\n  (\n    (process.name:\"logman.exe\" or ?process.pe.original_file_name == \"Logman.exe\") and\n    process.args : \"EventLog-*\" and process.args : (\"stop\", \"delete\")\n  ) or\n  (\n    (\n      process.name : (\"pwsh.exe\", \"powershell.exe\", \"powershell_ise.exe\") or\n      ?process.pe.original_file_name in (\"pwsh.exe\", \"powershell.exe\", \"powershell_ise.exe\")\n    ) and\n\t  process.args : \"Set-Service\" and process.args: \"EventLog\" and process.args : \"Disabled\"\n  )  or\n  (\n    (process.name:\"auditpol.exe\" or ?process.pe.original_file_name == \"AUDITPOL.EXE\") and process.args : \"/success:disable\"\n  )\n)",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Unusual Windows Path Activity",
        "description": "Identifies processes started from atypical folders in the file system, which might indicate malware execution or persistence mechanisms. In corporate Windows environments, software installation is centrally managed and it is unusual for programs to be executed from user or temporary directories. Processes executed from these locations can denote that a user downloaded software directly from the Internet or a malicious script or macro executed malware.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 207,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Rule Type: ML",
          "Rule Type: Machine Learning",
          "Tactic: Persistence",
          "Tactic: Execution"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "15m",
        "from": "now-2700s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "A new and unusual program or artifact download in the course of software upgrades, debugging, or troubleshooting could trigger this alert. Users downloading and running programs from unusual locations, such as temporary directories, browser caches, or profile paths could trigger this alert."
        ],
        "references": [
          "https://www.elastic.co/guide/en/security/current/prebuilt-ml-jobs.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1543",
                "name": "Create or Modify System Process",
                "reference": "https://attack.mitre.org/techniques/T1543/",
                "subtechnique": [
                  {
                    "id": "T1543.003",
                    "name": "Windows Service",
                    "reference": "https://attack.mitre.org/techniques/T1543/003/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1204",
                "name": "User Execution",
                "reference": "https://attack.mitre.org/techniques/T1204/",
                "subtechnique": [
                  {
                    "id": "T1204.002",
                    "name": "Malicious File",
                    "reference": "https://attack.mitre.org/techniques/T1204/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires the installation of associated Machine Learning jobs, as well as data coming in from one of the following integrations:\n- Elastic Defend\n- Windows\n\n### Anomaly Detection Setup\n\nOnce the rule is enabled, the associated Machine Learning job will start automatically. You can view the Machine Learning job linked under the \"Definition\" panel of the detection rule. If the job does not start due to an error, the issue must be resolved for the job to commence successfully. For more details on setting up anomaly detection jobs, refer to the [helper guide](https://www.elastic.co/guide/en/kibana/current/xpack-ml-anomalies.html).\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration to your system:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n### Windows Integration Setup\nThe Windows integration allows you to monitor the Windows OS, services, applications, and more.\n\n#### The following steps should be executed in order to add the Elastic Agent System integration \"windows\" to your system:\n- Go to the Kibana home page and click â€œAdd integrationsâ€.\n- In the query bar, search for â€œWindowsâ€ and select the integration to see more details about it.\n- Click â€œAdd Windowsâ€.\n- Configure the integration name and optionally add a description.\n- Review optional and advanced settings accordingly.\n- Add the newly installed â€œwindowsâ€ to an existing or a new agent policy, and deploy the agent on your system from which windows log files are desirable.\n- Click â€œSave and Continueâ€.\n- For more details on the integration refer to the [helper guide](https://docs.elastic.co/integrations/windows).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [],
        "id": "e208d518-a019-44db-9339-3de430b85af3",
        "rule_id": "445a342e-03fb-42d0-8656-0367eb2dead5",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:55.555Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:25.763Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "machine_learning",
        "anomaly_threshold": 50,
        "machine_learning_job_id": [
          "v3_windows_anomalous_path_activity"
        ]
      },
      {
        "name": "Unusual Windows Process Calling the Metadata Service",
        "description": "Looks for anomalous access to the metadata service by an unusual process. The metadata service may be targeted in order to harvest credentials or user data scripts containing secrets.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Rule Type: ML",
          "Rule Type: Machine Learning",
          "Tactic: Credential Access"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "15m",
        "from": "now-2700s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "A newly installed program or one that runs very rarely as part of a monthly or quarterly workflow could trigger this detection rule."
        ],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1552",
                "name": "Unsecured Credentials",
                "reference": "https://attack.mitre.org/techniques/T1552/",
                "subtechnique": [
                  {
                    "id": "T1552.005",
                    "name": "Cloud Instance Metadata API",
                    "reference": "https://attack.mitre.org/techniques/T1552/005/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires the installation of associated Machine Learning jobs, as well as data coming in from one of the following integrations:\n- Elastic Defend\n- Windows\n\n### Anomaly Detection Setup\n\nOnce the rule is enabled, the associated Machine Learning job will start automatically. You can view the Machine Learning job linked under the \"Definition\" panel of the detection rule. If the job does not start due to an error, the issue must be resolved for the job to commence successfully. For more details on setting up anomaly detection jobs, refer to the [helper guide](https://www.elastic.co/guide/en/kibana/current/xpack-ml-anomalies.html).\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration to your system:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n### Windows Integration Setup\nThe Windows integration allows you to monitor the Windows OS, services, applications, and more.\n\n#### The following steps should be executed in order to add the Elastic Agent System integration \"windows\" to your system:\n- Go to the Kibana home page and click â€œAdd integrationsâ€.\n- In the query bar, search for â€œWindowsâ€ and select the integration to see more details about it.\n- Click â€œAdd Windowsâ€.\n- Configure the integration name and optionally add a description.\n- Review optional and advanced settings accordingly.\n- Add the newly installed â€œwindowsâ€ to an existing or a new agent policy, and deploy the agent on your system from which windows log files are desirable.\n- Click â€œSave and Continueâ€.\n- For more details on the integration refer to the [helper guide](https://docs.elastic.co/integrations/windows).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [],
        "id": "4f3343b7-58cb-4001-aced-609a369da291",
        "rule_id": "abae61a8-c560-4dbd-acca-1e1438bff36b",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:55.559Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:31.979Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "machine_learning",
        "anomaly_threshold": 50,
        "machine_learning_job_id": [
          "v3_windows_rare_metadata_process"
        ]
      },
      {
        "name": "Unusual Process Spawned by a User",
        "description": "A machine learning job has detected a suspicious Windows process. This process has been classified as malicious in two ways. It was predicted to be malicious by the ProblemChild supervised ML model, and it was found to be suspicious given that its user context is unusual and does not commonly manifest malicious activity,by an unsupervised ML model. Such a process may be an instance of suspicious or malicious activity, possibly involving LOLbins, that may be resistant to detection using conventional search rules.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 107,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Living off the Land Attack Detection",
          "Rule Type: ML",
          "Rule Type: Machine Learning",
          "Tactic: Defense Evasion"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "15m",
        "from": "now-2700s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/guide/en/security/current/prebuilt-ml-jobs.html",
          "https://docs.elastic.co/en/integrations/problemchild",
          "https://www.elastic.co/security-labs/detecting-living-off-the-land-attacks-with-new-elastic-integration"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1036",
                "name": "Masquerading",
                "reference": "https://attack.mitre.org/techniques/T1036/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe rule requires the Living off the Land (LotL) Attack Detection integration assets to be installed, as well as Windows process events collected by integrations such as Elastic Defend or Winlogbeat.  \n\n### LotL Attack Detection Setup\nThe LotL Attack Detection integration detects living-off-the-land activity in Windows process events.\n\n#### Prerequisite Requirements:\n- Fleet is required for LotL Attack Detection.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n- Windows process events collected by the [Elastic Defend](https://docs.elastic.co/en/integrations/endpoint) integration or Winlogbeat(https://www.elastic.co/guide/en/beats/winlogbeat/current/_winlogbeat_overview.html).\n- To install Elastic Defend, refer to the [documentation](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n- To set up and run Winlogbeat, follow [this](https://www.elastic.co/guide/en/beats/winlogbeat/current/winlogbeat-installation-configuration.html) guide.\n\n#### The following steps should be executed to install assets associated with the LotL Attack Detection integration:\n- Go to the Kibana homepage. Under Management, click Integrations.\n- In the query bar, search for Living off the Land Attack Detection and select the integration to see more details about it.\n- Follow the instructions under the **Installation** section.\n- For this rule to work, complete the instructions through **Add preconfigured anomaly detection jobs**.\n",
        "related_integrations": [
          {
            "package": "problemchild",
            "version": "^2.0.0"
          },
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [],
        "id": "ea5a5930-b22f-4fd2-abc3-e9701cd6cf05",
        "rule_id": "40155ee4-1e6a-4e4d-a63b-e8ba16980cfb",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:55.562Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:25.732Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "machine_learning",
        "anomaly_threshold": 75,
        "machine_learning_job_id": [
          "problem_child_rare_process_by_user"
        ]
      },
      {
        "name": "Suspicious PrintSpooler Service Executable File Creation",
        "description": "Detects attempts to exploit privilege escalation vulnerabilities related to the Print Spooler service. For more information refer to the following CVE's - CVE-2020-1048, CVE-2020-1337 and CVE-2020-1300 and verify that the impacted system is patched.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 314,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Data Source: Elastic Endgame",
          "Use Case: Vulnerability",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: SentinelOne"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://voidsec.com/cve-2020-1337-printdemon-is-dead-long-live-printdemon/",
          "https://www.thezdi.com/blog/2020/7/8/cve-2020-1300-remote-code-execution-through-microsoft-windows-cab-files"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1068",
                "name": "Exploitation for Privilege Escalation",
                "reference": "https://attack.mitre.org/techniques/T1068/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "a215bd1c-256b-4225-ad75-411c87132943",
        "rule_id": "5bb4a95d-5a08-48eb-80db-4c3a63ec78a8",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:58.757Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:27.776Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "event.category : \"file\" and host.os.type : \"windows\" and event.type : \"creation\" and\n  process.name : \"spoolsv.exe\" and file.extension : \"dll\"",
        "new_terms_fields": [
          "host.id",
          "file.path"
        ],
        "history_window_start": "now-14d",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.file-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*"
        ],
        "filters": [
          {
            "meta": {
              "negate": false
            },
            "query": {
              "wildcard": {
                "file.path": {
                  "case_insensitive": true,
                  "value": "?:\\\\Windows\\\\Sys?????\\\\*"
                }
              }
            }
          },
          {
            "meta": {
              "negate": true
            },
            "query": {
              "wildcard": {
                "file.path": {
                  "case_insensitive": true,
                  "value": "?:\\\\Windows\\\\Sys?????\\\\PrintConfig.dll"
                }
              }
            }
          },
          {
            "meta": {
              "negate": true
            },
            "query": {
              "wildcard": {
                "file.path": {
                  "case_insensitive": true,
                  "value": "?:\\\\Windows\\\\Sys?????\\\\x5lrs.dll"
                }
              }
            }
          },
          {
            "meta": {
              "negate": true
            },
            "query": {
              "wildcard": {
                "file.path": {
                  "case_insensitive": true,
                  "value": "?:\\\\Windows\\\\system32\\\\spool\\\\DRIVERS\\\\x64\\\\*.dll"
                }
              }
            }
          },
          {
            "meta": {
              "negate": true
            },
            "query": {
              "wildcard": {
                "file.path": {
                  "case_insensitive": true,
                  "value": "?:\\\\Windows\\\\system32\\\\spool\\\\DRIVERS\\\\W32X86\\\\*.dll"
                }
              }
            }
          },
          {
            "meta": {
              "negate": true
            },
            "query": {
              "wildcard": {
                "file.path": {
                  "case_insensitive": true,
                  "value": "?:\\\\Windows\\\\system32\\\\spool\\\\PRTPROCS\\\\x64\\\\*.dll"
                }
              }
            }
          },
          {
            "meta": {
              "negate": true
            },
            "query": {
              "wildcard": {
                "file.path": {
                  "case_insensitive": true,
                  "value": "?:\\\\Windows\\\\system32\\\\spool\\\\{????????-????-????-????-????????????}\\\\*.dll"
                }
              }
            }
          }
        ],
        "language": "kuery"
      },
      {
        "name": "Unusual Child Process from a System Virtual Process",
        "description": "Identifies a suspicious child process of the Windows virtual system process, which could indicate code injection.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 312,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1055",
                "name": "Process Injection",
                "reference": "https://attack.mitre.org/techniques/T1055/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.pid",
            "type": "long",
            "ecs": true
          }
        ],
        "id": "384ec0dd-11e2-43ca-ab5f-e0174a27f88d",
        "rule_id": "de9bd7e0-49e9-4e92-a64d-53ade2e66af1",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:58.761Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:35.980Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.parent.pid == 4 and process.executable : \"?*\" and\n  not process.executable : (\"Registry\", \"MemCompression\", \"?:\\\\Windows\\\\System32\\\\smss.exe\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*"
        ],
        "filters": []
      },
      {
        "name": "Attempt to Install Kali Linux via WSL",
        "description": "Detects attempts to install or use Kali Linux via Windows Subsystem for Linux. Adversaries may enable and use WSL for Linux to avoid detection.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 209,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://learn.microsoft.com/en-us/windows/wsl/wsl-config"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1202",
                "name": "Indirect Command Execution",
                "reference": "https://attack.mitre.org/techniques/T1202/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "6e953a76-563d-4476-8a0e-50bb183fa55a",
        "rule_id": "dd34b062-b9e3-4a6b-8c0c-6c8ca6dd450e",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:58.764Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:35.957Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n(\n  (process.name : \"wsl.exe\" and process.args : (\"-d\", \"--distribution\", \"-i\", \"--install\") and process.args : \"kali*\") or \n  process.executable : (\n    \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\packages\\\\kalilinux*\", \n    \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Microsoft\\\\WindowsApps\\\\kali.exe\",\n    \"?:\\\\Program Files*\\\\WindowsApps\\\\KaliLinux.*\\\\kali.exe\",\n    \"\\\\Device\\\\HarddiskVolume?\\\\Users\\\\*\\\\AppData\\\\Local\\\\packages\\\\kalilinux*\", \n    \"\\\\Device\\\\HarddiskVolume?\\\\Users\\\\*\\\\AppData\\\\Local\\\\Microsoft\\\\WindowsApps\\\\kali.exe\",\n    \"\\\\Device\\\\HarddiskVolume?\\\\Program Files*\\\\WindowsApps\\\\KaliLinux.*\\\\kali.exe\"\n  )\n)",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Exchange Mailbox Export via PowerShell",
        "description": "Identifies the use of the Exchange PowerShell cmdlet, New-MailBoxExportRequest, to export the contents of a primary mailbox or archive to a .pst file. Adversaries may target user email to collect sensitive information.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Exchange Mailbox Export via PowerShell\n\nThe `New-MailBoxExportRequest` cmdlet is used to begin the process of exporting contents of a primary mailbox or archive to a .pst file. Note that this is done on a per-mailbox basis and this cmdlet is available only in on-premises Exchange.\nAttackers can abuse this functionality in preparation for exfiltrating contents, which is likely to contain sensitive and strategic data.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate the export operation:\n  - Identify the user account that performed the action and whether it should perform this kind of action.\n  - Contact the account owner and confirm whether they are aware of this activity.\n  - Check if this operation was approved and performed according to the organization's change management policy.\n  - Retrieve the operation status and use the `Get-MailboxExportRequest` cmdlet to review previous requests.\n  - By default, no group in Exchange has the privilege to import or export mailboxes. Investigate administrators that assigned the \"Mailbox Import Export\" privilege for abnormal activity.\n- Investigate if there is a significant quantity of export requests in the alert timeframe. This operation is done on a per-mailbox basis and can be part of a mass export.\n- If the operation was completed successfully:\n  - Check if the file is on the path specified in the command.\n  - Investigate if the file was compressed, archived, or retrieved by the attacker for exfiltration.\n\n### False positive analysis\n\n- This mechanism can be used legitimately. Analysts can dismiss the alert if the administrator is aware of the activity and it is done with proper approval.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- If the involved host is not the Exchange server, isolate the host to prevent further post-compromise behavior.\n- Use the `Remove-MailboxExportRequest` cmdlet to remove fully or partially completed export requests.\n- Prioritize cases that involve personally identifiable information (PII) or other classified data.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Review the privileges of users with the \"Mailbox Import Export\" privilege to ensure that the least privilege principle is being followed.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 210,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Collection",
          "Resources: Investigation Guide",
          "Data Source: PowerShell Logs"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Legitimate exchange system administration activity."
        ],
        "references": [
          "https://www.volexity.com/blog/2020/12/14/dark-halo-leverages-solarwinds-compromise-to-breach-organizations/",
          "https://docs.microsoft.com/en-us/powershell/module/exchange/new-mailboxexportrequest?view=exchange-ps",
          "https://www.elastic.co/security-labs/siestagraph-new-implant-uncovered-in-asean-member-foreign-ministry"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0009",
              "name": "Collection",
              "reference": "https://attack.mitre.org/tactics/TA0009/"
            },
            "technique": [
              {
                "id": "T1005",
                "name": "Data from Local System",
                "reference": "https://attack.mitre.org/techniques/T1005/"
              },
              {
                "id": "T1114",
                "name": "Email Collection",
                "reference": "https://attack.mitre.org/techniques/T1114/",
                "subtechnique": [
                  {
                    "id": "T1114.001",
                    "name": "Local Email Collection",
                    "reference": "https://attack.mitre.org/techniques/T1114/001/"
                  },
                  {
                    "id": "T1114.002",
                    "name": "Remote Email Collection",
                    "reference": "https://attack.mitre.org/techniques/T1114/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "powershell.file.script_block_text",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "958f902e-33fb-4761-b877-539f800ef877",
        "rule_id": "54a81f68-5f2a-421e-8eed-f888278bb712",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:58.768Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:27.704Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-windows.powershell*"
        ],
        "filters": [
          {
            "meta": {
              "negate": true
            },
            "query": {
              "wildcard": {
                "file.path": {
                  "case_insensitive": true,
                  "value": "?:\\\\Users\\\\*\\\\AppData\\\\Roaming\\\\Microsoft\\\\Exchange\\\\RemotePowerShell\\\\*"
                }
              }
            }
          },
          {
            "meta": {
              "negate": true
            },
            "query": {
              "wildcard": {
                "file.path": {
                  "case_insensitive": true,
                  "value": "?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\tmp_????????.???\\\\tmp_????????.???.ps?1"
                }
              }
            }
          },
          {
            "meta": {
              "negate": true
            },
            "query": {
              "wildcard": {
                "file.path": {
                  "case_insensitive": true,
                  "value": "?:\\\\Windows\\\\TEMP\\\\tmp_????????.???\\\\tmp_????????.???.ps?1"
                }
              }
            }
          }
        ],
        "query": "event.category:process and host.os.type:windows and\n  powershell.file.script_block_text : \"New-MailboxExportRequest\"",
        "language": "kuery"
      },
      {
        "name": "Network Logon Provider Registry Modification",
        "description": "Identifies the modification of the network logon provider registry. Adversaries may register a rogue network logon provider module for persistence and/or credential access via intercepting the authentication credentials in clear text during user logon.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Network Logon Provider Registry Modification\n\nNetwork logon providers are components in Windows responsible for handling the authentication process during a network logon.\n\nThis rule identifies the modification of the network logon provider registry. Adversaries may register a rogue network logon provider module for persistence and/or credential access via intercepting the authentication credentials in plain text during user logon.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n### Possible investigation steps\n\n- Examine the `registry.data.strings` field to identify the DLL registered.\n- Identify the process responsible for the registry operation and the file creation and investigate their process execution chains (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n  - Validate the activity is not related to planned patches, updates, network administrator activity, or legitimate software installations.\n  - Investigate any abnormal behavior by the subject process, such as network connections, DLLs loaded, registry or file modifications, and any spawned child processes.\n- Retrieve the file and examine if it is signed with valid digital signatures from vendors that are supposed to implement this kind of software and approved to use in the environment. Check for prevalence in the environment and whether they are located in expected locations.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the executables of the processes using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process's `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n\n\n### False positive analysis\n\n- False Positives can include legitimate software installations or updates that modify the network logon provider registry. These modifications may be necessary for the proper functioning of the software and are not indicative of malicious activity.\n\n### Response and Remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n  - If malicious activity is confirmed, perform a broader investigation to identify the scope of the compromise and determine the appropriate remediation steps.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Reimage the host operating system or restore the compromised files to clean versions.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 213,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Tactic: Credential Access",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: Microsoft Defender for Endpoint"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Authorized third party network logon providers."
        ],
        "references": [
          "https://github.com/gtworek/PSBits/tree/master/PasswordStealing/NPPSpy",
          "https://docs.microsoft.com/en-us/windows/win32/api/npapi/nf-npapi-nplogonnotify"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1556",
                "name": "Modify Authentication Process",
                "reference": "https://attack.mitre.org/techniques/T1556/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1543",
                "name": "Create or Modify System Process",
                "reference": "https://attack.mitre.org/techniques/T1543/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.data.strings",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "registry.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.value",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "15112227-15ae-4b3d-8e7f-35fda9aaeb62",
        "rule_id": "54c3d186-0461-4dc3-9b33-2dc5c7473936",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:58.771Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:27.709Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n  registry.data.strings : \"?*\" and registry.value : \"ProviderPath\" and\n  registry.path : (\n    \"HKLM\\\\SYSTEM\\\\*ControlSet*\\\\Services\\\\*\\\\NetworkProvider\\\\ProviderPath\",\n    \"\\\\REGISTRY\\\\MACHINE\\\\SYSTEM\\\\*ControlSet*\\\\Services\\\\*\\\\NetworkProvider\\\\ProviderPath\"\n  ) and\n  /* Excluding default NetworkProviders RDPNP, LanmanWorkstation and webclient. */\n  not (\n    user.id : \"S-1-5-18\" and\n    registry.data.strings : (\n        \"%SystemRoot%\\\\System32\\\\ntlanman.dll\",\n        \"%SystemRoot%\\\\System32\\\\drprov.dll\",\n        \"%SystemRoot%\\\\System32\\\\davclnt.dll\",\n        \"%SystemRoot%\\\\System32\\\\vmhgfs.dll\",\n        \"?:\\\\Program Files (x86)\\\\Citrix\\\\ICA Client\\\\x64\\\\pnsson.dll\",\n        \"?:\\\\Program Files\\\\Dell\\\\SARemediation\\\\agent\\\\DellMgmtNP.dll\",\n        \"?:\\\\Program Files (x86)\\\\CheckPoint\\\\Endpoint Connect\\\\\\\\epcgina.dll\"\n    )\n  )",
        "language": "eql",
        "index": [
          "logs-endpoint.events.registry-*",
          "endgame-*",
          "logs-windows.sysmon_operational-*",
          "winlogbeat-*",
          "logs-m365_defender.event-*"
        ],
        "filters": []
      },
      {
        "name": "Unusual Process Spawned by a Host",
        "description": "A machine learning job has detected a suspicious Windows process. This process has been classified as suspicious in two ways. It was predicted to be suspicious by the ProblemChild supervised ML model, and it was found to be an unusual process, on a host that does not commonly manifest malicious activity. Such a process may be an instance of suspicious or malicious activity, possibly involving LOLbins, that may be resistant to detection using conventional search rules.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 107,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Living off the Land Attack Detection",
          "Rule Type: ML",
          "Rule Type: Machine Learning",
          "Tactic: Defense Evasion"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "15m",
        "from": "now-2700s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/guide/en/security/current/prebuilt-ml-jobs.html",
          "https://docs.elastic.co/en/integrations/problemchild",
          "https://www.elastic.co/security-labs/detecting-living-off-the-land-attacks-with-new-elastic-integration"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1218",
                "name": "System Binary Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1218/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe rule requires the Living off the Land (LotL) Attack Detection integration assets to be installed, as well as Windows process events collected by integrations such as Elastic Defend or Winlogbeat.  \n\n### LotL Attack Detection Setup\nThe LotL Attack Detection integration detects living-off-the-land activity in Windows process events.\n\n#### Prerequisite Requirements:\n- Fleet is required for LotL Attack Detection.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n- Windows process events collected by the [Elastic Defend](https://docs.elastic.co/en/integrations/endpoint) integration or Winlogbeat(https://www.elastic.co/guide/en/beats/winlogbeat/current/_winlogbeat_overview.html).\n- To install Elastic Defend, refer to the [documentation](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n- To set up and run Winlogbeat, follow [this](https://www.elastic.co/guide/en/beats/winlogbeat/current/winlogbeat-installation-configuration.html) guide.\n\n#### The following steps should be executed to install assets associated with the LotL Attack Detection integration:\n- Go to the Kibana homepage. Under Management, click Integrations.\n- In the query bar, search for Living off the Land Attack Detection and select the integration to see more details about it.\n- Follow the instructions under the **Installation** section.\n- For this rule to work, complete the instructions through **Add preconfigured anomaly detection jobs**.\n",
        "related_integrations": [
          {
            "package": "problemchild",
            "version": "^2.0.0"
          },
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [],
        "id": "9d5c54f4-f98a-4b81-9e58-558f6802acca",
        "rule_id": "56004189-4e69-4a39-b4a9-195329d226e9",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:58.775Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:27.724Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "machine_learning",
        "anomaly_threshold": 75,
        "machine_learning_job_id": [
          "problem_child_rare_process_by_host"
        ]
      },
      {
        "name": "Windows CryptoAPI Spoofing Vulnerability (CVE-2020-0601 - CurveBall)",
        "description": "A spoofing vulnerability exists in the way Windows CryptoAPI (Crypt32.dll) validates Elliptic Curve Cryptography (ECC) certificates. An attacker could exploit the vulnerability by using a spoofed code-signing certificate to sign a malicious executable, making it appear the file was from a trusted, legitimate source.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 207,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Use Case: Vulnerability",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1553",
                "name": "Subvert Trust Controls",
                "reference": "https://attack.mitre.org/techniques/T1553/",
                "subtechnique": [
                  {
                    "id": "T1553.002",
                    "name": "Code Signing",
                    "reference": "https://attack.mitre.org/techniques/T1553/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "message",
            "type": "match_only_text",
            "ecs": true
          }
        ],
        "id": "8a7712f1-1ec2-414d-955e-51f2a5afd171",
        "rule_id": "56557cde-d923-4b88-adee-c61b3f3b5dc3",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:58.778Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:27.728Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-windows.*",
          "logs-system.security*"
        ],
        "filters": [],
        "query": "event.provider:\"Microsoft-Windows-Audit-CVE\" and message:\"[CVE-2020-0601]\" and host.os.type:windows",
        "language": "kuery"
      },
      {
        "name": "PowerShell PSReflect Script",
        "description": "Detects the use of PSReflect in PowerShell scripts. Attackers leverage PSReflect as a library that enables PowerShell to access win32 API functions.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating PowerShell PSReflect Script\n\nPowerShell is one of the main tools system administrators use for automation, report routines, and other tasks. This makes it available for use in various environments, and creates an attractive way for attackers to execute code.\n\nPSReflect is a library that enables PowerShell to access win32 API functions in an uncomplicated way. It also helps to create enums and structs easilyâ€”all without touching the disk.\n\nAlthough this is an interesting project for every developer and admin out there, it is mainly used in the red team and malware tooling for its capabilities.\n\nDetecting the core implementation of PSReflect means detecting most of the tooling that uses Windows API through PowerShell, enabling defenders to discover tools being dropped in the environment.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Examine the script content that triggered the detection; look for suspicious DLL imports, collection or exfiltration capabilities, suspicious functions, encoded or compressed data, and other potentially malicious characteristics. The script content that may be split into multiple script blocks (you can use the field `powershell.file.script_block_id` for filtering).\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Check for additional PowerShell and command-line logs that indicate that imported functions were run.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Evaluate whether the user needs to use PowerShell to complete tasks.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the script using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Related rules\n\n- PowerShell Suspicious Discovery Related Windows API Functions - 61ac3638-40a3-44b2-855a-985636ca985e\n- PowerShell Keylogging Script - bd2c86a0-8b61-4457-ab38-96943984e889\n- PowerShell Suspicious Script with Audio Capture Capabilities - 2f2f4939-0b34-40c2-a0a3-844eb7889f43\n- Potential Process Injection via PowerShell - 2e29e96a-b67c-455a-afe4-de6183431d0d\n- Suspicious .NET Reflection via PowerShell - e26f042e-c590-4e82-8e05-41e81bd822ad\n- PowerShell Suspicious Payload Encoded and Compressed - 81fe9dc6-a2d7-4192-a2d8-eed98afc766a\n- PowerShell Suspicious Script with Screenshot Capabilities - 959a7353-1129-4aa7-9084-30746b256a70\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Restrict PowerShell usage outside of IT and engineering business units using GPOs, AppLocker, Intune, or similar software.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 313,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Resources: Investigation Guide",
          "Data Source: PowerShell Logs"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Legitimate PowerShell scripts that make use of PSReflect to access the win32 API"
        ],
        "references": [
          "https://github.com/mattifestation/PSReflect/blob/master/PSReflect.psm1",
          "https://github.com/atc-project/atc-data/blob/master/docs/Logging_Policies/LP_0109_windows_powershell_script_block_log.md"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              },
              {
                "id": "T1106",
                "name": "Native API",
                "reference": "https://attack.mitre.org/techniques/T1106/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'PowerShell Script Block Logging' logging policy must be configured (Enable).\n\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nAdministrative Templates >\nWindows PowerShell >\nTurn on PowerShell Script Block Logging (Enable)\n```\n\nSteps to implement the logging policy via registry:\n\n```\nreg add \"hklm\\SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\ScriptBlockLogging\" /v EnableScriptBlockLogging /t REG_DWORD /d 1\n```\n",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "powershell.file.script_block_text",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "ed726665-5669-4381-9bdd-2ea01577780c",
        "rule_id": "56f2e9b5-4803-4e44-a0a4-a52dc79d57fe",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:58.781Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:27.733Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-windows.powershell*"
        ],
        "filters": [
          {
            "meta": {
              "negate": true
            },
            "query": {
              "wildcard": {
                "file.path": {
                  "case_insensitive": true,
                  "value": "?:\\\\ProgramData\\\\MaaS360\\\\Cloud Extender\\\\AR\\\\Scripts\\\\ASModuleCommon.ps1"
                }
              }
            }
          }
        ],
        "query": "event.category:process and host.os.type:windows and\n  powershell.file.script_block_text:(\n    \"New-InMemoryModule\" or\n    \"Add-Win32Type\" or\n    psenum or\n    DefineDynamicAssembly or\n    DefineDynamicModule or\n    \"Reflection.TypeAttributes\" or\n    \"Reflection.Emit.OpCodes\" or\n    \"Reflection.Emit.CustomAttributeBuilder\" or\n    \"Runtime.InteropServices.DllImportAttribute\"\n  ) and\n  not user.id : \"S-1-5-18\"",
        "language": "kuery"
      },
      {
        "name": "PowerShell MiniDump Script",
        "description": "This rule detects PowerShell scripts capable of dumping process memory using WindowsErrorReporting or Dbghelp.dll MiniDumpWriteDump. Attackers can use this tooling to dump LSASS and get access to credentials.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating PowerShell MiniDump Script\n\nPowerShell is one of the main tools system administrators use for automation, report routines, and other tasks. This makes it available for use in various environments, and creates an attractive way for attackers to execute code.\n\nAttackers can abuse Process Memory Dump capabilities to extract credentials from LSASS or to obtain other privileged information stored in the process memory.\n\n#### Possible investigation steps\n\n- Examine the script content that triggered the detection; look for suspicious DLL imports, collection or exfiltration capabilities, suspicious functions, encoded or compressed data, and other potentially malicious characteristics.\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Examine file or network events from the involved PowerShell process for suspicious behavior.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Evaluate whether the user needs to use PowerShell to complete tasks.\n- Check if the imported function was executed and which process it targeted.\n\n### False positive analysis\n\n- Regular users do not have a business justification for using scripting utilities to dump process memory, making false positives unlikely.\n\n### Related rules\n\n- PowerShell PSReflect Script - 56f2e9b5-4803-4e44-a0a4-a52dc79d57fe\n- Potential Process Injection via PowerShell - 2e29e96a-b67c-455a-afe4-de6183431d0d\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Restrict PowerShell usage outside of IT and engineering business units using GPOs, AppLocker, Intune, or similar software.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 210,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Resources: Investigation Guide",
          "Data Source: PowerShell Logs"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "PowerShell scripts that use this capability for troubleshooting."
        ],
        "references": [
          "https://github.com/PowerShellMafia/PowerSploit/blob/master/Exfiltration/Out-Minidump.ps1",
          "https://github.com/FuzzySecurity/PowerShell-Suite/blob/master/Get-ProcessMiniDump.ps1",
          "https://github.com/atc-project/atc-data/blob/master/docs/Logging_Policies/LP_0109_windows_powershell_script_block_log.md"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1003",
                "name": "OS Credential Dumping",
                "reference": "https://attack.mitre.org/techniques/T1003/",
                "subtechnique": [
                  {
                    "id": "T1003.001",
                    "name": "LSASS Memory",
                    "reference": "https://attack.mitre.org/techniques/T1003/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'PowerShell Script Block Logging' logging policy must be enabled.\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nAdministrative Templates >\nWindows PowerShell >\nTurn on PowerShell Script Block Logging (Enable)\n```\n\nSteps to implement the logging policy via registry:\n\n```\nreg add \"hklm\\SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\ScriptBlockLogging\" /v EnableScriptBlockLogging /t REG_DWORD /d 1\n```\n",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "powershell.file.script_block_text",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "408893e1-4697-4eee-b9f4-31933aa40b50",
        "rule_id": "577ec21e-56fe-4065-91d8-45eb8224fe77",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:58.785Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:27.738Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-windows.powershell*"
        ],
        "filters": [],
        "query": "event.category:process and host.os.type:windows and powershell.file.script_block_text:(MiniDumpWriteDump or MiniDumpWithFullMemory or pmuDetirWpmuDiniM) and not user.id : \"S-1-5-18\"",
        "language": "kuery"
      },
      {
        "name": "Deleting Backup Catalogs with Wbadmin",
        "description": "Identifies use of the wbadmin.exe to delete the backup catalog. Ransomware and other malware may do this to prevent system recovery.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Deleting Backup Catalogs with Wbadmin\n\nWindows Server Backup stores the details about your backups (what volumes are backed up and where the backups are located) in a file called a backup catalog, which ransomware victims can use to recover corrupted backup files. Deleting these files is a common step in threat actor playbooks.\n\nThis rule identifies the deletion of the backup catalog using the `wbadmin.exe` utility.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n- Check if any files on the host machine have been encrypted.\n\n### False positive analysis\n\n- Administrators can use this command to delete corrupted catalogs, but overall the activity is unlikely to be legitimate.\n\n### Related rules\n\n- Third-party Backup Files Deleted via Unexpected Process - 11ea6bec-ebde-4d71-a8e9-784948f8e3e9\n- Volume Shadow Copy Deleted or Resized via VssAdmin - b5ea4bfe-a1b2-421f-9d47-22a75a6f2921\n- Volume Shadow Copy Deletion via PowerShell - d99a037b-c8e2-47a5-97b9-170d076827c4\n- Volume Shadow Copy Deletion via WMIC - dc9c1f74-dac3-48e3-b47f-eb79db358f57\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Consider isolating the involved host to prevent destructive behavior, which is commonly associated with this activity.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- If any other destructive action was identified on the host, it is recommended to prioritize the investigation and look for ransomware preparation and execution activities.\n- If any backups were affected:\n  - Perform data recovery locally or restore the backups from replicated copies (cloud, other servers, etc.).\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 314,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Impact",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0040",
              "name": "Impact",
              "reference": "https://attack.mitre.org/tactics/TA0040/"
            },
            "technique": [
              {
                "id": "T1485",
                "name": "Data Destruction",
                "reference": "https://attack.mitre.org/techniques/T1485/"
              },
              {
                "id": "T1490",
                "name": "Inhibit System Recovery",
                "reference": "https://attack.mitre.org/techniques/T1490/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "e379246f-80e8-479a-90c8-111f39cd5268",
        "rule_id": "581add16-df76-42bb-af8e-c979bfb39a59",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:58.789Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:27.755Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (process.name : \"wbadmin.exe\" or ?process.pe.original_file_name == \"WBADMIN.EXE\") and\n  process.args : \"catalog\" and process.args : \"delete\"",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious Windows Process Cluster Spawned by a User",
        "description": "A machine learning job combination has detected a set of one or more suspicious Windows processes with unusually high scores for malicious probability. These process(es) have been classified as malicious in several ways. The process(es) were predicted to be malicious by the ProblemChild supervised ML model. If the anomaly contains a cluster of suspicious processes, each process has the same user name, and the aggregate score of the event cluster was calculated to be unusually high by an unsupervised ML model. Such a cluster often contains suspicious or malicious activity, possibly involving LOLbins, that may be resistant to detection using conventional search rules.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 107,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Living off the Land Attack Detection",
          "Rule Type: ML",
          "Rule Type: Machine Learning",
          "Tactic: Defense Evasion"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "15m",
        "from": "now-2700s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/guide/en/security/current/prebuilt-ml-jobs.html",
          "https://docs.elastic.co/en/integrations/problemchild",
          "https://www.elastic.co/security-labs/detecting-living-off-the-land-attacks-with-new-elastic-integration"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1036",
                "name": "Masquerading",
                "reference": "https://attack.mitre.org/techniques/T1036/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe rule requires the Living off the Land (LotL) Attack Detection integration assets to be installed, as well as Windows process events collected by integrations such as Elastic Defend or Winlogbeat.  \n\n### LotL Attack Detection Setup\nThe LotL Attack Detection integration detects living-off-the-land activity in Windows process events.\n\n#### Prerequisite Requirements:\n- Fleet is required for LotL Attack Detection.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n- Windows process events collected by the [Elastic Defend](https://docs.elastic.co/en/integrations/endpoint) integration or Winlogbeat(https://www.elastic.co/guide/en/beats/winlogbeat/current/_winlogbeat_overview.html).\n- To install Elastic Defend, refer to the [documentation](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n- To set up and run Winlogbeat, follow [this](https://www.elastic.co/guide/en/beats/winlogbeat/current/winlogbeat-installation-configuration.html) guide.\n\n#### The following steps should be executed to install assets associated with the LotL Attack Detection integration:\n- Go to the Kibana homepage. Under Management, click Integrations.\n- In the query bar, search for Living off the Land Attack Detection and select the integration to see more details about it.\n- Follow the instructions under the **Installation** section.\n- For this rule to work, complete the instructions through **Add preconfigured anomaly detection jobs**.\n",
        "related_integrations": [
          {
            "package": "problemchild",
            "version": "^2.0.0"
          },
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [],
        "id": "a648e746-4b74-4c6a-9bfc-727118c93834",
        "rule_id": "1224da6c-0326-4b4f-8454-68cdc5ae542b",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:58.792Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:23.990Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "machine_learning",
        "anomaly_threshold": 75,
        "machine_learning_job_id": [
          "problem_child_high_sum_by_user"
        ]
      },
      {
        "name": "Suspicious Lsass Process Access",
        "description": "Identifies access attempts to LSASS handle, this may indicate an attempt to dump credentials from Lsass memory.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 208,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/redcanaryco/atomic-red-team/blob/master/atomics/T1003.001/T1003.001.md"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1003",
                "name": "OS Credential Dumping",
                "reference": "https://attack.mitre.org/techniques/T1003/",
                "subtechnique": [
                  {
                    "id": "T1003.001",
                    "name": "LSASS Memory",
                    "reference": "https://attack.mitre.org/techniques/T1003/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.code",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.event_data.CallTrace",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "winlog.event_data.GrantedAccess",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "winlog.event_data.TargetImage",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "1e87061a-1f06-4551-b2c2-b702e69df368",
        "rule_id": "128468bf-cab1-4637-99ea-fdf3780a4609",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:58.797Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:23.319Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.code == \"10\" and\n  winlog.event_data.TargetImage : \"?:\\\\WINDOWS\\\\system32\\\\lsass.exe\" and\n  not winlog.event_data.GrantedAccess :\n                (\"0x1000\", \"0x1400\", \"0x101400\", \"0x101000\", \"0x101001\", \"0x100000\", \"0x100040\", \"0x3200\", \"0x40\", \"0x3200\") and\n  not process.name : (\"procexp64.exe\", \"procmon.exe\", \"procexp.exe\", \"Microsoft.Identity.AadConnect.Health.AadSync.Host.ex\") and\n  not process.executable : (\n        \"?:\\\\ProgramData\\\\Microsoft\\\\Windows Defender\\\\platform\\\\*\",\n        \"?:\\\\ProgramData\\\\WebEx\\\\webex\\\\*\",\n        \"?:\\\\Program Files (x86)\\\\*\",\n        \"?:\\\\Program Files\\\\*\",\n        \"?:\\\\Windows\\\\CCM\\\\CcmExec.exe\",\n        \"?:\\\\Windows\\\\LTSvc\\\\LTSVC.exe\",\n        \"?:\\\\Windows\\\\Sysmon.exe\",\n        \"?:\\\\Windows\\\\Sysmon64.exe\",\n        \"C:\\\\Windows\\\\CynetMS.exe\",\n        \"?:\\\\Windows\\\\system32\\\\csrss.exe\",\n        \"?:\\\\Windows\\\\System32\\\\lsm.exe\",\n        \"?:\\\\Windows\\\\system32\\\\MRT.exe\",\n        \"?:\\\\Windows\\\\System32\\\\msiexec.exe\",\n        \"?:\\\\Windows\\\\system32\\\\wbem\\\\wmiprvse.exe\",\n        \"?:\\\\Windows\\\\system32\\\\wininit.exe\",\n        \"?:\\\\Windows\\\\SystemTemp\\\\GUM*.tmp\\\\GoogleUpdate.exe\",\n        \"?:\\\\Windows\\\\sysWOW64\\\\wbem\\\\wmiprvse.exe\", \n        \"C:\\\\oracle\\\\64\\\\02\\\\instantclient_19_13\\\\sqlplus.exe\", \n        \"C:\\\\oracle\\\\64\\\\02\\\\instantclient_19_13\\\\sqlldr.exe\",\n        \"d:\\\\oracle\\\\product\\\\19\\\\dbhome1\\\\bin\\\\ORACLE.EXE\",\n        \"C:\\\\wamp\\\\bin\\\\apache\\\\apache*\\\\bin\\\\httpd.exe\",\n        \"C:\\\\Windows\\\\system32\\\\netstat.exe\", \n        \"C:\\\\PROGRA~1\\\\INFORM~1\\\\apps\\\\jdk\\\\*\\\\jre\\\\bin\\\\java.exe\", \n        \"C:\\\\PROGRA~2\\\\CyberCNSAgentV2\\\\osqueryi.exe\",\n        \"C:\\\\Utilityw2k19\\\\packetbeat\\\\packetbeat.exe\",\n        \"C:\\\\ProgramData\\\\Cisco\\\\Cisco AnyConnect Secure Mobility Client\\\\Temp\\\\CloudUpdate\\\\vpndownloader.exe\", \n        \"C:\\\\ProgramData\\\\Cisco\\\\Cisco Secure Client\\\\Temp\\\\CloudUpdate\\\\vpndownloader.exe\"\n  ) and\n  not winlog.event_data.CallTrace : (\"*mpengine.dll*\", \"*appresolver.dll*\", \"*sysmain.dll*\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious Cmd Execution via WMI",
        "description": "Identifies suspicious command execution (cmd) via Windows Management Instrumentation (WMI) on a remote host. This could be indicative of adversary lateral movement.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 314,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/security-labs/elastic-protects-against-data-wiper-malware-targeting-ukraine-hermeticwiper",
          "https://www.elastic.co/security-labs/operation-bleeding-bear"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1047",
                "name": "Windows Management Instrumentation",
                "reference": "https://attack.mitre.org/techniques/T1047/"
              },
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.003",
                    "name": "Windows Command Shell",
                    "reference": "https://attack.mitre.org/techniques/T1059/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "f99f4296-2de9-4e28-b6c3-34b227e990d6",
        "rule_id": "12f07955-1674-44f7-86b5-c35da0a6f41a",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:58.800Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:23.337Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n process.parent.name : \"WmiPrvSE.exe\" and process.name : \"cmd.exe\" and\n process.args : \"\\\\\\\\127.0.0.1\\\\*\" and process.args : (\"2>&1\", \"1>\")",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "winlogbeat-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Potential Ransomware Behavior - High count of Readme files by System",
        "description": "This rule identifies a high number (20) of file creation event by the System virtual process from the same host and with same file name containing keywords similar to ransomware note files and all within a short time period.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n#### Possible investigation steps\n\n- Investigate the content of the readme files.\n- Investigate any file names with unusual extensions.\n- Investigate any incoming network connection to port 445 on this host.\n- Investigate any network logon events to this host.\n- Identify the total number and type of modified files by pid 4.\n- If the number of files is too high and source.ip connecting over SMB is unusual isolate the host and block the used credentials.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n\n### False positive analysis\n\n- Local file modification from a Kernel mode driver.\n\n### Related rules\n\n- Third-party Backup Files Deleted via Unexpected Process - 11ea6bec-ebde-4d71-a8e9-784948f8e3e9\n- Volume Shadow Copy Deleted or Resized via VssAdmin - b5ea4bfe-a1b2-421f-9d47-22a75a6f2921\n- Volume Shadow Copy Deletion via PowerShell - d99a037b-c8e2-47a5-97b9-170d076827c4\n- Volume Shadow Copy Deletion via WMIC - dc9c1f74-dac3-48e3-b47f-eb79db358f57\n- Potential Ransomware Note File Dropped via SMB - 02bab13d-fb14-4d7c-b6fe-4a28874d37c5\n- Suspicious File Renamed via SMB - 78e9b5d5-7c07-40a7-a591-3dbbf464c386\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Consider isolating the involved host to prevent destructive behavior, which is commonly associated with this activity.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- If any other destructive action was identified on the host, it is recommended to prioritize the investigation and look for ransomware preparation and execution activities.\n- If any backups were affected:\n  - Perform data recovery locally or restore the backups from replicated copies (cloud, other servers, etc.).\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 207,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Impact",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://news.sophos.com/en-us/2023/12/21/akira-again-the-ransomware-that-keeps-on-taking/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0040",
              "name": "Impact",
              "reference": "https://attack.mitre.org/tactics/TA0040/"
            },
            "technique": [
              {
                "id": "T1485",
                "name": "Data Destruction",
                "reference": "https://attack.mitre.org/techniques/T1485/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1021",
                "name": "Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1021/",
                "subtechnique": [
                  {
                    "id": "T1021.002",
                    "name": "SMB/Windows Admin Shares",
                    "reference": "https://attack.mitre.org/techniques/T1021/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pid",
            "type": "long",
            "ecs": true
          }
        ],
        "id": "184d985f-eb3e-4d68-9bd5-e07d47ceb987",
        "rule_id": "1397e1b9-0c90-4d24-8d7b-80598eb9bc9a",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:58.804Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:23.348Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "threshold",
        "query": "event.category:file and host.os.type:windows and process.pid:4 and event.action:creation and\n file.name:(*read*me* or *README* or *lock* or *LOCK* or *how*to* or *HOW*TO* or *@* or *recover* or *RECOVER* or *decrypt* or *DECRYPT* or *restore* or *RESTORE* or *FILES_BACK* or *files_back*)",
        "threshold": {
          "field": [
            "host.id",
            "file.name"
          ],
          "value": 20
        },
        "index": [
          "logs-endpoint.events.file-*",
          "winlogbeat-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Remote File Download via Desktopimgdownldr Utility",
        "description": "Identifies the desktopimgdownldr utility being used to download a remote file. An adversary may use desktopimgdownldr to download arbitrary files as an alternative to certutil.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Remote File Download via Desktopimgdownldr Utility\n\nAttackers commonly transfer tooling or malware from external systems into a compromised environment using the command and control channel. However, they can also abuse signed utilities to drop these files.\n\nThe `Desktopimgdownldr.exe` utility is used to to configure lockscreen/desktop image, and can be abused with the `lockscreenurl` argument to download remote files and tools, this rule looks for this behavior.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n> This investigation guide uses the [Investigate Markdown Plugin](https://www.elastic.co/guide/en/security/master/interactive-investigation-guides.html) introduced in Elastic Stack version 8.8.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n  - !{investigate{\"label\":\"Alerts associated with the user in the last 48h\",\"providers\":[[{\"excluded\":false,\"field\":\"event.kind\",\"queryType\":\"phrase\",\"value\":\"signal\",\"valueType\":\"string\"},{\"excluded\":false,\"field\":\"user.id\",\"queryType\":\"phrase\",\"value\":\"{{user.id}}\",\"valueType\":\"string\"}]],\"relativeFrom\":\"now-48h/h\",\"relativeTo\":\"now\"}}\n  - !{investigate{\"label\":\"Alerts associated with the host in the last 48h\",\"providers\":[[{\"excluded\":false,\"field\":\"event.kind\",\"queryType\":\"phrase\",\"value\":\"signal\",\"valueType\":\"string\"},{\"excluded\":false,\"field\":\"host.name\",\"queryType\":\"phrase\",\"value\":\"{{host.name}}\",\"valueType\":\"string\"}]],\"relativeFrom\":\"now-48h/h\",\"relativeTo\":\"now\"}}\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n- Check the reputation of the domain or IP address used to host the downloaded file or if the user downloaded the file from an internal system.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the file using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n        - !{investigate{\"label\":\"Investigate the Subject Process Network Events\",\"providers\":[[{\"excluded\":false,\"field\":\"process.entity_id\",\"queryType\":\"phrase\",\"value\":\"{{process.entity_id}}\",\"valueType\":\"string\"},{\"excluded\":false,\"field\":\"event.category\",\"queryType\":\"phrase\",\"value\":\"network\",\"valueType\":\"string\"}]]}}\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n### False positive analysis\n\n- This activity is unusual but can be done by administrators. Benign true positives (B-TPs) can be added as exceptions if necessary.\n- Analysts can dismiss the alert if the downloaded file is a legitimate image.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 314,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Command and Control",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: SentinelOne",
          "Data Source: Sysmon",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://labs.sentinelone.com/living-off-windows-land-a-new-native-file-downldr/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            },
            "technique": [
              {
                "id": "T1105",
                "name": "Ingress Tool Transfer",
                "reference": "https://attack.mitre.org/techniques/T1105/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "feca00a2-cf3e-4ad7-a31f-1cd596da933b",
        "rule_id": "15c0b7a7-9c34-4869-b25b-fa6518414899",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:58.807Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:23.379Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (process.name : \"desktopimgdownldr.exe\" or ?process.pe.original_file_name == \"desktopimgdownldr.exe\") and\n  process.args : \"/lockscreenurl:http*\"",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Unusual Windows Username",
        "description": "A machine learning job detected activity for a username that is not normally active, which can indicate unauthorized changes, activity by unauthorized users, lateral movement, or compromised credentials. In many organizations, new usernames are not often created apart from specific types of system activities, such as creating new accounts for new employees. These user accounts quickly become active and routine. Events from rarely used usernames can point to suspicious activity. Additionally, automated Linux fleets tend to see activity from rarely used usernames only when personnel log in to make authorized or unauthorized changes, or threat actors have acquired credentials and log in for malicious purposes. Unusual usernames can also indicate pivoting, where compromised credentials are used to try and move laterally from one host to another.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating an Unusual Windows User\nDetection alerts from this rule indicate activity for a Windows user name that is rare and unusual. Here are some possible avenues of investigation:\n- Consider the user as identified by the username field. Is this program part of an expected workflow for the user who ran this program on this host? Could this be related to occasional troubleshooting or support activity?\n- Examine the history of user activity. If this user only manifested recently, it might be a service account for a new software package. If it has a consistent cadence (for example if it runs monthly or quarterly), it might be part of a monthly or quarterly business process.\n- Examine the process arguments, title and working directory. These may provide indications as to the source of the program or the nature of the tasks that the user is performing.\n- Consider the same for the parent process. If the parent process is a legitimate system utility or service, this could be related to software updates or system management. If the parent process is something user-facing like an Office application, this process could be more suspicious.",
        "output_index": "",
        "version": 207,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Rule Type: ML",
          "Rule Type: Machine Learning",
          "Tactic: Initial Access"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "15m",
        "from": "now-2700s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Uncommon user activity can be due to an administrator or help desk technician logging onto a workstation or server in order to perform manual troubleshooting or reconfiguration."
        ],
        "references": [
          "https://www.elastic.co/guide/en/security/current/prebuilt-ml-jobs.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1078",
                "name": "Valid Accounts",
                "reference": "https://attack.mitre.org/techniques/T1078/",
                "subtechnique": [
                  {
                    "id": "T1078.002",
                    "name": "Domain Accounts",
                    "reference": "https://attack.mitre.org/techniques/T1078/002/"
                  },
                  {
                    "id": "T1078.003",
                    "name": "Local Accounts",
                    "reference": "https://attack.mitre.org/techniques/T1078/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires the installation of associated Machine Learning jobs, as well as data coming in from one of the following integrations:\n- Elastic Defend\n- Windows\n\n### Anomaly Detection Setup\n\nOnce the rule is enabled, the associated Machine Learning job will start automatically. You can view the Machine Learning job linked under the \"Definition\" panel of the detection rule. If the job does not start due to an error, the issue must be resolved for the job to commence successfully. For more details on setting up anomaly detection jobs, refer to the [helper guide](https://www.elastic.co/guide/en/kibana/current/xpack-ml-anomalies.html).\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration to your system:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n### Windows Integration Setup\nThe Windows integration allows you to monitor the Windows OS, services, applications, and more.\n\n#### The following steps should be executed in order to add the Elastic Agent System integration \"windows\" to your system:\n- Go to the Kibana home page and click â€œAdd integrationsâ€.\n- In the query bar, search for â€œWindowsâ€ and select the integration to see more details about it.\n- Click â€œAdd Windowsâ€.\n- Configure the integration name and optionally add a description.\n- Review optional and advanced settings accordingly.\n- Add the newly installed â€œwindowsâ€ to an existing or a new agent policy, and deploy the agent on your system from which windows log files are desirable.\n- Click â€œSave and Continueâ€.\n- For more details on the integration refer to the [helper guide](https://docs.elastic.co/integrations/windows).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [],
        "id": "1769e4ff-0835-4adf-95a9-0391e144b001",
        "rule_id": "1781d055-5c66-4adf-9c59-fc0fa58336a5",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:58.810Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:23.995Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "machine_learning",
        "anomaly_threshold": 50,
        "machine_learning_job_id": [
          "v3_windows_anomalous_user_name"
        ]
      },
      {
        "name": "Unusual Windows Service",
        "description": "A machine learning job detected an unusual Windows service, This can indicate execution of unauthorized services, malware, or persistence mechanisms. In corporate Windows environments, hosts do not generally run many rare or unique services. This job helps detect malware and persistence mechanisms that have been installed and run as a service.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Rule Type: ML",
          "Rule Type: Machine Learning",
          "Tactic: Persistence"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "15m",
        "from": "now-2700s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "A newly installed program or one that runs rarely as part of a monthly or quarterly workflow could trigger this alert."
        ],
        "references": [
          "https://www.elastic.co/guide/en/security/current/prebuilt-ml-jobs.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1543",
                "name": "Create or Modify System Process",
                "reference": "https://attack.mitre.org/techniques/T1543/",
                "subtechnique": [
                  {
                    "id": "T1543.003",
                    "name": "Windows Service",
                    "reference": "https://attack.mitre.org/techniques/T1543/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires the installation of associated Machine Learning jobs, as well as data coming in from one of the following integrations:\n- Elastic Defend\n- Windows\n\n### Anomaly Detection Setup\n\nOnce the rule is enabled, the associated Machine Learning job will start automatically. You can view the Machine Learning job linked under the \"Definition\" panel of the detection rule. If the job does not start due to an error, the issue must be resolved for the job to commence successfully. For more details on setting up anomaly detection jobs, refer to the [helper guide](https://www.elastic.co/guide/en/kibana/current/xpack-ml-anomalies.html).\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration to your system:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n### Windows Integration Setup\nThe Windows integration allows you to monitor the Windows OS, services, applications, and more.\n\n#### The following steps should be executed in order to add the Elastic Agent System integration \"windows\" to your system:\n- Go to the Kibana home page and click â€œAdd integrationsâ€.\n- In the query bar, search for â€œWindowsâ€ and select the integration to see more details about it.\n- Click â€œAdd Windowsâ€.\n- Configure the integration name and optionally add a description.\n- Review optional and advanced settings accordingly.\n- Add the newly installed â€œwindowsâ€ to an existing or a new agent policy, and deploy the agent on your system from which windows log files are desirable.\n- Click â€œSave and Continueâ€.\n- For more details on the integration refer to the [helper guide](https://docs.elastic.co/integrations/windows).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [],
        "id": "9cb583b7-894a-4aef-8b18-cc5ad4e42ad9",
        "rule_id": "1781d055-5c66-4adf-9c71-fc0fa58338c7",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:58.814Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:24.000Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "machine_learning",
        "anomaly_threshold": 50,
        "machine_learning_job_id": [
          "v3_windows_anomalous_service"
        ]
      },
      {
        "name": "Unusual Windows User Privilege Elevation Activity",
        "description": "A machine learning job detected an unusual user context switch, using the runas command or similar techniques, which can indicate account takeover or privilege escalation using compromised accounts. Privilege elevation using tools like runas are more commonly used by domain and network administrators than by regular Windows users.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Rule Type: ML",
          "Rule Type: Machine Learning",
          "Tactic: Privilege Escalation"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "15m",
        "from": "now-2700s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Uncommon user privilege elevation activity can be due to an administrator, help desk technician, or a user performing manual troubleshooting or reconfiguration."
        ],
        "references": [
          "https://www.elastic.co/guide/en/security/current/prebuilt-ml-jobs.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            }
          }
        ],
        "setup": "## Setup\n\nThis rule requires the installation of associated Machine Learning jobs, as well as data coming in from one of the following integrations:\n- Elastic Defend\n- Windows\n\n### Anomaly Detection Setup\n\nOnce the rule is enabled, the associated Machine Learning job will start automatically. You can view the Machine Learning job linked under the \"Definition\" panel of the detection rule. If the job does not start due to an error, the issue must be resolved for the job to commence successfully. For more details on setting up anomaly detection jobs, refer to the [helper guide](https://www.elastic.co/guide/en/kibana/current/xpack-ml-anomalies.html).\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration to your system:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n### Windows Integration Setup\nThe Windows integration allows you to monitor the Windows OS, services, applications, and more.\n\n#### The following steps should be executed in order to add the Elastic Agent System integration \"windows\" to your system:\n- Go to the Kibana home page and click â€œAdd integrationsâ€.\n- In the query bar, search for â€œWindowsâ€ and select the integration to see more details about it.\n- Click â€œAdd Windowsâ€.\n- Configure the integration name and optionally add a description.\n- Review optional and advanced settings accordingly.\n- Add the newly installed â€œwindowsâ€ to an existing or a new agent policy, and deploy the agent on your system from which windows log files are desirable.\n- Click â€œSave and Continueâ€.\n- For more details on the integration refer to the [helper guide](https://docs.elastic.co/integrations/windows).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [],
        "id": "c30c3a7a-6b0f-41be-8ac9-fa5bbf70827b",
        "rule_id": "1781d055-5c66-4adf-9d82-fc0fa58449c8",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:58.821Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:24.005Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "machine_learning",
        "anomaly_threshold": 50,
        "machine_learning_job_id": [
          "v3_windows_rare_user_runas_event"
        ]
      },
      {
        "name": "Suspicious Powershell Script",
        "description": "A machine learning job detected a PowerShell script with unusual data characteristics, such as obfuscation, that may be a characteristic of malicious PowerShell script text blocks.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 207,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Rule Type: ML",
          "Rule Type: Machine Learning",
          "Tactic: Execution"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "15m",
        "from": "now-2700s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Certain kinds of security testing may trigger this alert. PowerShell scripts that use high levels of obfuscation or have unusual script block payloads may trigger this alert."
        ],
        "references": [
          "https://www.elastic.co/guide/en/security/current/prebuilt-ml-jobs.html",
          "https://www.elastic.co/security-labs/detecting-living-off-the-land-attacks-with-new-elastic-integration"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires the installation of associated Machine Learning jobs, as well as data coming in from one of the following integrations:\n- Elastic Defend\n- Windows\n\n### Anomaly Detection Setup\n\nOnce the rule is enabled, the associated Machine Learning job will start automatically. You can view the Machine Learning job linked under the \"Definition\" panel of the detection rule. If the job does not start due to an error, the issue must be resolved for the job to commence successfully. For more details on setting up anomaly detection jobs, refer to the [helper guide](https://www.elastic.co/guide/en/kibana/current/xpack-ml-anomalies.html).\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration to your system:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n### Windows Integration Setup\nThe Windows integration allows you to monitor the Windows OS, services, applications, and more.\n\n#### The following steps should be executed in order to add the Elastic Agent System integration \"windows\" to your system:\n- Go to the Kibana home page and click â€œAdd integrationsâ€.\n- In the query bar, search for â€œWindowsâ€ and select the integration to see more details about it.\n- Click â€œAdd Windowsâ€.\n- Configure the integration name and optionally add a description.\n- Review optional and advanced settings accordingly.\n- Add the newly installed â€œwindowsâ€ to an existing or a new agent policy, and deploy the agent on your system from which windows log files are desirable.\n- Click â€œSave and Continueâ€.\n- For more details on the integration refer to the [helper guide](https://docs.elastic.co/integrations/windows).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [],
        "id": "e69a82d6-a511-4d8e-8a28-f413178500af",
        "rule_id": "1781d055-5c66-4adf-9d60-fc0fa58337b6",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:58.817Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:24.010Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "machine_learning",
        "anomaly_threshold": 50,
        "machine_learning_job_id": [
          "v3_windows_anomalous_script"
        ]
      },
      {
        "name": "Unusual Windows Remote User",
        "description": "A machine learning job detected an unusual remote desktop protocol (RDP) username, which can indicate account takeover or credentialed persistence using compromised accounts. RDP attacks, such as BlueKeep, also tend to use unusual usernames.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating an Unusual Windows User\nDetection alerts from this rule indicate activity for a rare and unusual Windows RDP (remote desktop) user. Here are some possible avenues of investigation:\n- Consider the user as identified by the username field. Is the user part of a group who normally logs into Windows hosts using RDP (remote desktop protocol)? Is this logon activity part of an expected workflow for the user?\n- Consider the source of the login. If the source is remote, could this be related to occasional troubleshooting or support activity by a vendor or an employee working remotely?",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Rule Type: ML",
          "Rule Type: Machine Learning",
          "Tactic: Initial Access"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "15m",
        "from": "now-2700s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Uncommon username activity can be due to an engineer logging onto a server instance in order to perform manual troubleshooting or reconfiguration."
        ],
        "references": [
          "https://www.elastic.co/guide/en/security/current/prebuilt-ml-jobs.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1078",
                "name": "Valid Accounts",
                "reference": "https://attack.mitre.org/techniques/T1078/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires the installation of associated Machine Learning jobs, as well as data coming in from one of the following integrations:\n- Elastic Defend\n- Windows\n\n### Anomaly Detection Setup\n\nOnce the rule is enabled, the associated Machine Learning job will start automatically. You can view the Machine Learning job linked under the \"Definition\" panel of the detection rule. If the job does not start due to an error, the issue must be resolved for the job to commence successfully. For more details on setting up anomaly detection jobs, refer to the [helper guide](https://www.elastic.co/guide/en/kibana/current/xpack-ml-anomalies.html).\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration to your system:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n### Windows Integration Setup\nThe Windows integration allows you to monitor the Windows OS, services, applications, and more.\n\n#### The following steps should be executed in order to add the Elastic Agent System integration \"windows\" to your system:\n- Go to the Kibana home page and click â€œAdd integrationsâ€.\n- In the query bar, search for â€œWindowsâ€ and select the integration to see more details about it.\n- Click â€œAdd Windowsâ€.\n- Configure the integration name and optionally add a description.\n- Review optional and advanced settings accordingly.\n- Add the newly installed â€œwindowsâ€ to an existing or a new agent policy, and deploy the agent on your system from which windows log files are desirable.\n- Click â€œSave and Continueâ€.\n- For more details on the integration refer to the [helper guide](https://docs.elastic.co/integrations/windows).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [],
        "id": "832986fa-272e-4d49-8214-ddb5ed169510",
        "rule_id": "1781d055-5c66-4adf-9e93-fc0fa69550c9",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:58.824Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:24.016Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "machine_learning",
        "anomaly_threshold": 50,
        "machine_learning_job_id": [
          "v3_windows_rare_user_type10_remote_login"
        ]
      },
      {
        "name": "Execution of COM object via Xwizard",
        "description": "Windows Component Object Model (COM) is an inter-process communication (IPC) component of the native Windows application programming interface (API) that enables interaction between software objects or executable code. Xwizard can be used to run a COM object created in registry to evade defensive counter measures.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 312,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://lolbas-project.github.io/lolbas/Binaries/Xwizard/",
          "http://www.hexacorn.com/blog/2017/07/31/the-wizard-of-x-oppa-plugx-style/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1559",
                "name": "Inter-Process Communication",
                "reference": "https://attack.mitre.org/techniques/T1559/",
                "subtechnique": [
                  {
                    "id": "T1559.001",
                    "name": "Component Object Model",
                    "reference": "https://attack.mitre.org/techniques/T1559/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "fb345e7b-d87f-4351-bd47-6ddbeaf44b79",
        "rule_id": "1a6075b0-7479-450e-8fe7-b8b8438ac570",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:58.827Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:23.410Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n (process.name : \"xwizard.exe\" or ?process.pe.original_file_name : \"xwizard.exe\") and\n (\n   (process.args : \"RunWizard\" and process.args : \"{*}\") or\n   (process.executable != null and\n     not process.executable : (\n        \"C:\\\\Windows\\\\SysWOW64\\\\xwizard.exe\",\n        \"C:\\\\Windows\\\\System32\\\\xwizard.exe\",\n        \"\\\\Device\\\\HarddiskVolume?\\\\Windows\\\\SysWOW64\\\\xwizard.exe\",\n        \"\\\\Device\\\\HarddiskVolume?\\\\Windows\\\\System32\\\\xwizard.exe\"\n     )\n   )\n )",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "User Account Creation",
        "description": "Identifies attempts to create new users. This is sometimes done by attackers to increase access or establish persistence on a system or domain.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating User Account Creation\n\nAttackers may create new accounts (both local and domain) to maintain access to victim systems.\n\nThis rule identifies the usage of `net.exe` to create new accounts.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Identify if the account was added to privileged groups or assigned special privileges after creation.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n\n### False positive analysis\n\n- Account creation is a common administrative task, so there is a high chance of the activity being legitimate. Before investigating further, verify that this activity is not benign.\n\n### Related rules\n\n- Creation of a Hidden Local User Account - 2edc8076-291e-41e9-81e4-e3fcbc97ae5e\n- Windows User Account Creation - 38e17753-f581-4644-84da-0d60a8318694\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Delete the created account.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 311,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1136",
                "name": "Create Account",
                "reference": "https://attack.mitre.org/techniques/T1136/",
                "subtechnique": [
                  {
                    "id": "T1136.001",
                    "name": "Local Account",
                    "reference": "https://attack.mitre.org/techniques/T1136/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "7abddd2d-8c12-44f5-bfa2-de20e508b97b",
        "rule_id": "1aa9181a-492b-4c01-8b16-fa0735786b2b",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:58.830Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:23.416Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (process.name : (\"net.exe\", \"net1.exe\") and not process.parent.name : \"net.exe\") and\n  (process.args : \"user\" and process.args : (\"/ad\", \"/add\"))",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "PowerShell Script with Encryption/Decryption Capabilities",
        "description": "Identifies the use of Cmdlets and methods related to encryption/decryption of files in PowerShell scripts, which malware and offensive security tools can abuse to encrypt data or decrypt payloads to bypass security solutions.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating PowerShell Script with Encryption/Decryption Capabilities\n\nPowerShell is one of the main tools system administrators use for automation, report routines, and other tasks, making it available for use in various environments, creating an attractive way for attackers to execute code.\n\nPowerShell offers encryption and decryption functionalities that attackers can abuse for various purposes, such as concealing payloads, C2 communications, and encrypting data as part of ransomware operations.\n\n#### Possible investigation steps\n\n- Examine the script content that triggered the detection; look for suspicious DLL imports, collection or exfiltration capabilities, suspicious functions, encoded or compressed data, and other potentially malicious characteristics.\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Examine file or network events from the involved PowerShell process for suspicious behavior.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Evaluate whether the user needs to use PowerShell to complete tasks.\n\n### False positive analysis\n\n- This is a dual-use mechanism, meaning its usage is not inherently malicious. Analysts can dismiss the alert if the script doesn't contain malicious functions or potential for abuse, no other suspicious activity was identified, and there are justifications for the execution.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Restrict PowerShell usage outside of IT and engineering business units using GPOs, AppLocker, Intune, or similar software.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 109,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: PowerShell Logs",
          "Resources: Investigation Guide"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Legitimate PowerShell Scripts which makes use of encryption."
        ],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1027",
                "name": "Obfuscated Files or Information",
                "reference": "https://attack.mitre.org/techniques/T1027/"
              },
              {
                "id": "T1140",
                "name": "Deobfuscate/Decode Files or Information",
                "reference": "https://attack.mitre.org/techniques/T1140/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "powershell.file.script_block_text",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "b26ca093-595e-418a-8bfe-ee53cc301713",
        "rule_id": "1d9aeb0b-9549-46f6-a32d-05e2a001b7fd",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:58.833Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:23.814Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-windows.powershell*"
        ],
        "filters": [],
        "query": "event.category:process and host.os.type:windows and\n  powershell.file.script_block_text : (\n    (\n      \"Cryptography.AESManaged\" or\n      \"Cryptography.RijndaelManaged\" or\n      \"Cryptography.SHA1Managed\" or\n      \"Cryptography.SHA256Managed\" or\n      \"Cryptography.SHA384Managed\" or\n      \"Cryptography.SHA512Managed\" or\n      \"Cryptography.SymmetricAlgorithm\" or\n      \"PasswordDeriveBytes\" or\n      \"Rfc2898DeriveBytes\"\n    ) and\n    (\n      CipherMode and PaddingMode\n    ) and\n    (\n      \".CreateEncryptor\" or\n      \".CreateDecryptor\"\n    )\n  ) and\n  not user.id : \"S-1-5-18\" and\n  not (\n    file.name : \"Bootstrap.Octopus.FunctionAppenderContext.ps1\" and\n    powershell.file.script_block_text : (\"function Decrypt-Variables\" or \"github.com/OctopusDeploy\")\n  )",
        "language": "kuery"
      },
      {
        "name": "UAC Bypass via DiskCleanup Scheduled Task Hijack",
        "description": "Identifies User Account Control (UAC) bypass via hijacking DiskCleanup Scheduled Task. Attackers bypass UAC to stealthily execute code with elevated permissions.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 311,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Tactic: Defense Evasion",
          "Tactic: Execution",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1548",
                "name": "Abuse Elevation Control Mechanism",
                "reference": "https://attack.mitre.org/techniques/T1548/",
                "subtechnique": [
                  {
                    "id": "T1548.002",
                    "name": "Bypass User Account Control",
                    "reference": "https://attack.mitre.org/techniques/T1548/002/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1548",
                "name": "Abuse Elevation Control Mechanism",
                "reference": "https://attack.mitre.org/techniques/T1548/",
                "subtechnique": [
                  {
                    "id": "T1548.002",
                    "name": "Bypass User Account Control",
                    "reference": "https://attack.mitre.org/techniques/T1548/002/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1053",
                "name": "Scheduled Task/Job",
                "reference": "https://attack.mitre.org/techniques/T1053/",
                "subtechnique": [
                  {
                    "id": "T1053.005",
                    "name": "Scheduled Task",
                    "reference": "https://attack.mitre.org/techniques/T1053/005/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "d8d2b10a-23f8-4757-bc94-45a8ef348777",
        "rule_id": "1dcc51f6-ba26-49e7-9ef4-2655abb2361e",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:58.837Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:23.819Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n process.args : \"/autoclean\" and process.args : \"/d\" and process.executable != null and \n not process.executable : (\n        \"C:\\\\Windows\\\\System32\\\\cleanmgr.exe\",\n        \"C:\\\\Windows\\\\SysWOW64\\\\cleanmgr.exe\",\n        \"C:\\\\Windows\\\\System32\\\\taskhostw.exe\",\n        \"\\\\Device\\\\HarddiskVolume?\\\\Windows\\\\System32\\\\cleanmgr.exe\",\n        \"\\\\Device\\\\HarddiskVolume?\\\\Windows\\\\SysWOW64\\\\cleanmgr.exe\",\n        \"\\\\Device\\\\HarddiskVolume?\\\\Windows\\\\System32\\\\taskhostw.exe\"\n)",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "PowerShell Script with Discovery Capabilities",
        "description": "Identifies the use of Cmdlets and methods related to discovery activities. Attackers can use these to perform various situational awareness related activities, like enumerating users, shares, sessions, domain trusts, groups, etc.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 209,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Collection",
          "Tactic: Discovery",
          "Data Source: PowerShell Logs",
          "Rule Type: BBR"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1087",
                "name": "Account Discovery",
                "reference": "https://attack.mitre.org/techniques/T1087/",
                "subtechnique": [
                  {
                    "id": "T1087.001",
                    "name": "Local Account",
                    "reference": "https://attack.mitre.org/techniques/T1087/001/"
                  },
                  {
                    "id": "T1087.002",
                    "name": "Domain Account",
                    "reference": "https://attack.mitre.org/techniques/T1087/002/"
                  }
                ]
              },
              {
                "id": "T1482",
                "name": "Domain Trust Discovery",
                "reference": "https://attack.mitre.org/techniques/T1482/"
              },
              {
                "id": "T1082",
                "name": "System Information Discovery",
                "reference": "https://attack.mitre.org/techniques/T1082/"
              },
              {
                "id": "T1083",
                "name": "File and Directory Discovery",
                "reference": "https://attack.mitre.org/techniques/T1083/"
              },
              {
                "id": "T1615",
                "name": "Group Policy Discovery",
                "reference": "https://attack.mitre.org/techniques/T1615/"
              },
              {
                "id": "T1135",
                "name": "Network Share Discovery",
                "reference": "https://attack.mitre.org/techniques/T1135/"
              },
              {
                "id": "T1201",
                "name": "Password Policy Discovery",
                "reference": "https://attack.mitre.org/techniques/T1201/"
              },
              {
                "id": "T1057",
                "name": "Process Discovery",
                "reference": "https://attack.mitre.org/techniques/T1057/"
              },
              {
                "id": "T1518",
                "name": "Software Discovery",
                "reference": "https://attack.mitre.org/techniques/T1518/",
                "subtechnique": [
                  {
                    "id": "T1518.001",
                    "name": "Security Software Discovery",
                    "reference": "https://attack.mitre.org/techniques/T1518/001/"
                  }
                ]
              },
              {
                "id": "T1012",
                "name": "Query Registry",
                "reference": "https://attack.mitre.org/techniques/T1012/"
              },
              {
                "id": "T1082",
                "name": "System Information Discovery",
                "reference": "https://attack.mitre.org/techniques/T1082/"
              },
              {
                "id": "T1049",
                "name": "System Network Connections Discovery",
                "reference": "https://attack.mitre.org/techniques/T1049/"
              },
              {
                "id": "T1007",
                "name": "System Service Discovery",
                "reference": "https://attack.mitre.org/techniques/T1007/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'PowerShell Script Block Logging' logging policy must be enabled.\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nAdministrative Templates >\nWindows PowerShell >\nTurn on PowerShell Script Block Logging (Enable)\n```\n\nSteps to implement the logging policy via registry:\n\n```\nreg add \"hklm\\SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\ScriptBlockLogging\" /v EnableScriptBlockLogging /t REG_DWORD /d 1\n```\n",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "powershell.file.script_block_text",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "67084526-08b5-4631-9c23-fa5043c3d77b",
        "rule_id": "1e0a3f7c-21e7-4bb1-98c7-2036612fb1be",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:58.840Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:23.829Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-windows.powershell*"
        ],
        "filters": [
          {
            "meta": {
              "negate": true
            },
            "query": {
              "wildcard": {
                "file.path": {
                  "case_insensitive": true,
                  "value": "?:\\\\Program Files\\\\WindowsPowerShell\\\\Modules\\\\*.ps?1"
                }
              }
            }
          },
          {
            "meta": {
              "negate": true
            },
            "query": {
              "wildcard": {
                "file.path": {
                  "case_insensitive": true,
                  "value": "?:\\\\Program Files\\\\Microsoft Azure AD Sync\\\\Extensions\\\\AADConnector.psm1"
                }
              }
            }
          },
          {
            "meta": {
              "negate": true
            },
            "query": {
              "wildcard": {
                "file.path": {
                  "case_insensitive": true,
                  "value": "*ServiceNow MID Server*\\\\agent\\\\scripts\\\\PowerShell\\\\*.psm1"
                }
              }
            }
          },
          {
            "meta": {
              "negate": true
            },
            "query": {
              "wildcard": {
                "file.path": {
                  "case_insensitive": true,
                  "value": "?:\\\\Windows\\\\IMECache\\\\HealthScripts\\\\*\\\\detect.ps1"
                }
              }
            }
          },
          {
            "meta": {
              "negate": true
            },
            "query": {
              "wildcard": {
                "file.path": {
                  "case_insensitive": true,
                  "value": "?:\\\\Windows\\\\TEMP\\\\SDIAG*"
                }
              }
            }
          },
          {
            "meta": {
              "negate": true
            },
            "query": {
              "wildcard": {
                "file.path": {
                  "case_insensitive": true,
                  "value": "?:\\\\Temp\\\\SDIAG*"
                }
              }
            }
          },
          {
            "meta": {
              "negate": true
            },
            "query": {
              "wildcard": {
                "file.path": {
                  "case_insensitive": true,
                  "value": "?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\SDIAG*"
                }
              }
            }
          },
          {
            "meta": {
              "negate": true
            },
            "query": {
              "wildcard": {
                "file.path": {
                  "case_insensitive": true,
                  "value": "?:\\\\Program Files\\\\Microsoft Monitoring Agent\\\\Agent\\\\Health Service State\\\\Monitoring Host Temporary Files*"
                }
              }
            }
          }
        ],
        "query": "event.category:process and host.os.type:windows and\n  powershell.file.script_block_text : (\n    (\n      \"Get-ADDefaultDomainPasswordPolicy\" or\n      \"Get-ADDomain\" or \"Get-ComputerInfo\" or\n      \"Get-Disk\" or \"Get-DnsClientCache\" or\n      \"Get-GPOReport\" or \"Get-HotFix\" or\n      \"Get-LocalUser\" or \"Get-NetFirewallProfile\" or\n      \"get-nettcpconnection\" or \"Get-NetAdapter\" or\n      \"Get-PhysicalDisk\" or \"Get-Process\" or\n      \"Get-PSDrive\" or \"Get-Service\" or\n      \"Get-SmbShare\" or \"Get-WinEvent\"\n    ) or\n    (\n      (\"Get-WmiObject\" or \"gwmi\" or \"Get-CimInstance\" or\n       \"gcim\" or \"Management.ManagementObjectSearcher\" or\n       \"System.Management.ManagementClass\" or\n       \"[WmiClass]\" or \"[WMI]\") and\n      (\n        \"AntiVirusProduct\" or \"CIM_BIOSElement\" or \"CIM_ComputerSystem\" or \"CIM_Product\" or \"CIM_DiskDrive\" or\n        \"CIM_LogicalDisk\" or \"CIM_NetworkAdapter\" or \"CIM_StorageVolume\" or \"CIM_OperatingSystem\" or\n        \"CIM_Process\" or \"CIM_Service\" or \"MSFT_DNSClientCache\" or \"Win32_BIOS\" or \"Win32_ComputerSystem\" or\n        \"Win32_ComputerSystemProduct\" or \"Win32_DiskDrive\" or \"win32_environment\" or \"Win32_Group\" or\n        \"Win32_groupuser\" or \"Win32_IP4RouteTable\" or \"Win32_logicaldisk\" or \"Win32_MappedLogicalDisk\" or\n        \"Win32_NetworkAdapterConfiguration\" or \"win32_ntdomain\" or \"Win32_OperatingSystem\" or\n        \"Win32_PnPEntity\" or \"Win32_Process\" or \"Win32_Product\" or \"Win32_quickfixengineering\" or\n        \"win32_service\" or \"Win32_Share\" or \"Win32_UserAccount\"\n      )\n    ) or\n    (\n      (\"ADSI\" and \"WinNT\") or\n      (\"Get-ChildItem\" and \"sysmondrv.sys\") or\n      (\"::GetIPGlobalProperties()\" and \"GetActiveTcpConnections()\") or\n      (\"ServiceProcess.ServiceController\" and \"::GetServices\") or\n      (\"Diagnostics.Process\" and \"::GetProcesses\") or\n      (\"DirectoryServices.Protocols.GroupPolicy\" and \".GetGPOReport()\") or\n      (\"DirectoryServices.AccountManagement\" and \"PrincipalSearcher\") or\n      (\"NetFwTypeLib.NetFwMgr\" and \"CurrentProfile\") or\n      (\"NetworkInformation.NetworkInterface\" and \"GetAllNetworkInterfaces\") or\n      (\"Automation.PSDriveInfo\") or\n      (\"Microsoft.Win32.RegistryHive\")\n    ) or\n    (\n      \"Get-ItemProperty\" and\n      (\n        \"\\Control\\SecurityProviders\\WDigest\" or\n        \"\\microsoft\\windows\\currentversion\\explorer\\runmru\" or\n        \"\\Microsoft\\Windows\\CurrentVersion\\Policies\\System\\Kerberos\\Parameters\" or\n        \"\\Microsoft\\Windows\\CurrentVersion\\Uninstall\" or\n        \"\\Microsoft\\Windows\\WindowsUpdate\" or\n        \"Policies\\Microsoft\\Windows\\Installer\" or\n        \"Software\\Microsoft\\Windows\\CurrentVersion\\Policies\" or\n        (\"\\Services\\SharedAccess\\Parameters\\FirewallPolicy\" and \"EnableFirewall\") or\n        (\"Microsoft\\Windows\\CurrentVersion\\Internet Settings\" and \"proxyEnable\")\n      )\n    ) or\n    (\n      (\"Directoryservices.Activedirectory\" or\n      \"DirectoryServices.AccountManagement\") and \n      (\n        \"Domain Admins\" or \"DomainControllers\" or\n        \"FindAllGlobalCatalogs\" or \"GetAllTrustRelationships\" or\n        \"GetCurrentDomain\" or \"GetCurrentForest\"\n      ) or\n      \"DirectoryServices.DirectorySearcher\" and\n      (\n        \"samAccountType=805306368\" or\n        \"samAccountType=805306369\" or\n        \"objectCategory=group\" or\n        \"objectCategory=groupPolicyContainer\" or\n        \"objectCategory=site\" or\n        \"objectCategory=subnet\" or\n        \"objectClass=trustedDomain\"\n      )\n    ) or\n    (\n      \"Get-Process\" and\n      (\n        \"mcshield\" or \"windefend\" or \"savservice\" or\n        \"TMCCSF\" or \"symantec antivirus\" or\n        \"CSFalcon\" or \"TmPfw\" or \"kvoop\"\n      )\n    )\n  ) and\n  not powershell.file.script_block_text : (\n    (\n      \"__cmdletization_BindCommonParameters\" and\n      \"Microsoft.PowerShell.Core\\Export-ModuleMember\" and\n      \"Microsoft.PowerShell.Cmdletization.Cim.CimCmdletAdapter\"\n    ) or\n    \"CmdletsToExport=@(\\\"Add-Content\\\",\"\n  ) and\n  not user.id : (\"S-1-5-18\" or \"S-1-5-19\" or \"S-1-5-20\")",
        "language": "kuery"
      },
      {
        "name": "Suspicious .NET Code Compilation",
        "description": "Identifies executions of .NET compilers with suspicious parent processes, which can indicate an attacker's attempt to compile code after delivery in order to bypass security mechanisms.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 312,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Tactic: Execution",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1027",
                "name": "Obfuscated Files or Information",
                "reference": "https://attack.mitre.org/techniques/T1027/",
                "subtechnique": [
                  {
                    "id": "T1027.004",
                    "name": "Compile After Delivery",
                    "reference": "https://attack.mitre.org/techniques/T1027/004/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.005",
                    "name": "Visual Basic",
                    "reference": "https://attack.mitre.org/techniques/T1059/005/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "a54cd65e-977f-458c-b024-37b5b1f4ee06",
        "rule_id": "201200f1-a99b-43fb-88ed-f65a45c4972c",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:58.870Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:23.857Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.name : (\"csc.exe\", \"vbc.exe\") and\n  process.parent.name : (\"wscript.exe\", \"mshta.exe\", \"cscript.exe\", \"wmic.exe\", \"svchost.exe\", \"rundll32.exe\", \"cmstp.exe\", \"regsvr32.exe\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Potential Antimalware Scan Interface Bypass via PowerShell",
        "description": "Identifies the execution of PowerShell script with keywords related to different Antimalware Scan Interface (AMSI) bypasses. An adversary may attempt first to disable AMSI before executing further malicious powershell scripts to evade detection.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Potential Antimalware Scan Interface Bypass via PowerShell\n\nPowerShell is one of the main tools system administrators use for automation, report routines, and other tasks. This makes it available for use in various environments, and creates an attractive way for attackers to execute code.\n\nThe Windows Antimalware Scan Interface (AMSI) is a versatile interface standard that allows your applications and services to integrate with any antimalware product on a machine. AMSI integrates with multiple Windows components, ranging from User Account Control (UAC) to VBA macros and PowerShell.\n\nThis rule identifies scripts that contain methods and classes that can be abused to bypass AMSI.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Examine the script content that triggered the detection; look for suspicious DLL imports, collection or exfiltration capabilities, suspicious functions, encoded or compressed data, and other potentially malicious characteristics.\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Determine whether the script was executed and capture relevant information, such as arguments that reveal intent or are indicators of compromise (IoCs).\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate commands and scripts executed after this activity was observed.\n- Inspect the host for suspicious or abnormal behavior in the alert timeframe:\n  - Observe and collect information about the following activities in the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Restrict PowerShell usage outside of IT and engineering business units using GPOs, AppLocker, Intune, or similar software.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 110,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: PowerShell Logs",
          "Resources: Investigation Guide"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/S3cur3Th1sSh1t/Amsi-Bypass-Powershell"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.001",
                    "name": "Disable or Modify Tools",
                    "reference": "https://attack.mitre.org/techniques/T1562/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "powershell.file.script_block_text",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "625553ca-bc3f-4f27-99d3-07d869241d51",
        "rule_id": "1f0a69c0-3392-4adf-b7d5-6012fd292da8",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:58.867Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:23.847Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-windows.powershell*"
        ],
        "filters": [],
        "query": "event.category:\"process\" and host.os.type:windows and\n  (\n    powershell.file.script_block_text : (\n      \"System.Management.Automation.AmsiUtils\" or\n\t\t\tamsiInitFailed or \n\t\t\t\"Invoke-AmsiBypass\" or \n\t\t\t\"Bypass.AMSI\" or \n\t\t\t\"amsi.dll\" or \n\t\t\tAntimalwareProvider  or \n\t\t\tamsiSession or \n\t\t\tamsiContext or\n\t\t\tAmsiInitialize or \n\t\t\tunloadobfuscated or \n\t\t\tunloadsilent or \n\t\t\tAmsiX64 or \n\t\t\tAmsiX32 or \n\t\t\tFindAmsiFun\n    ) or\n    powershell.file.script_block_text:(\"[System.Runtime.InteropServices.Marshal]::Copy\" and \"VirtualProtect\") or\n    powershell.file.script_block_text:(\"[Ref].Assembly.GetType(('System.Management.Automation\" and \".SetValue(\")\n  ) and\n  not powershell.file.script_block_text : (\n    \"sentinelbreakpoints\" and \"Set-PSBreakpoint\"\n  )",
        "language": "kuery"
      },
      {
        "name": "Mofcomp Activity",
        "description": "Managed Object Format (MOF) files can be compiled locally or remotely through mofcomp.exe. Attackers may leverage MOF files to build their own namespaces and classes into the Windows Management Instrumentation (WMI) repository, or establish persistence using WMI Event Subscription.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 4,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Data Source: Elastic Defend",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Elastic Endgame",
          "Data Source: System",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1047",
                "name": "Windows Management Instrumentation",
                "reference": "https://attack.mitre.org/techniques/T1047/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1546",
                "name": "Event Triggered Execution",
                "reference": "https://attack.mitre.org/techniques/T1546/",
                "subtechnique": [
                  {
                    "id": "T1546.003",
                    "name": "Windows Management Instrumentation Event Subscription",
                    "reference": "https://attack.mitre.org/techniques/T1546/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "2f3b9aac-691e-4045-83ad-4bec8ef7032c",
        "rule_id": "210d4430-b371-470e-b879-80b7182aa75e",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:58.874Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:25.777Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.name : \"mofcomp.exe\" and process.args : \"*.mof\" and\n  not user.id : \"S-1-5-18\" and\n  not\n  (\n    process.parent.name : \"ScenarioEngine.exe\" and\n    process.args : (\n      \"*\\\\MSSQL\\\\Binn\\\\*.mof\",\n      \"*\\\\Microsoft SQL Server\\\\???\\\\Shared\\\\*.mof\",\n      \"*\\\\OLAP\\\\bin\\\\*.mof\"\n    )\n  )",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "logs-m365_defender.event-*",
          "endgame-*",
          "logs-system.security-*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Potential PowerShell HackTool Script by Author",
        "description": "Detects known PowerShell offensive tooling author's name in PowerShell scripts. Attackers commonly use out-of-the-box offensive tools without modifying the code, which may still contain the author artifacts. This rule identifies common author handles found in popular PowerShell scripts used for red team exercises.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 104,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Data Source: PowerShell Logs"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/atc-project/atc-data/blob/master/docs/Logging_Policies/LP_0109_windows_powershell_script_block_log.md"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'PowerShell Script Block Logging' logging policy must be enabled.\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nAdministrative Templates >\nWindows PowerShell >\nTurn on PowerShell Script Block Logging (Enable)\n```\n\nSteps to implement the logging policy via registry:\n\n```\nreg add \"hklm\\SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\ScriptBlockLogging\" /v EnableScriptBlockLogging /t REG_DWORD /d 1\n```\n",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "powershell.file.script_block_text",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "ad7b42fc-9f3c-48f0-92fb-ff9ed4f08b84",
        "rule_id": "2553a9af-52a4-4a05-bb03-85b2a479a0a0",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:58.877Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:25.509Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-windows.powershell*"
        ],
        "filters": [],
        "query": "host.os.type:windows and event.category:process and\n  powershell.file.script_block_text : (\n      \"mattifestation\" or \"JosephBialek\" or\n      \"harmj0y\" or \"ukstufus\" or\n      \"SecureThisShit\" or \"Matthew Graeber\" or\n      \"secabstraction\" or \"mgeeky\" or\n      \"oddvarmoe\" or \"am0nsec\" or\n      \"obscuresec\" or \"sixdub\" or\n      \"darkoperator\" or \"funoverip\" or\n      \"rvrsh3ll\" or \"kevin_robertson\" or\n      \"dafthack\" or \"r4wd3r\" or\n      \"danielhbohannon\" or \"OneLogicalMyth\" or\n      \"cobbr_io\" or \"xorrior\" or\n      \"PetrMedonos\" or \"citronneur\" or\n      \"eladshamir\" or \"RastaMouse\" or\n      \"enigma0x3\" or \"FuzzySec\" or\n      \"424f424f\" or \"jaredhaight\" or\n      \"fullmetalcache\" or \"Hubbl3\" or\n      \"curi0usJack\" or \"Cx01N\" or\n      \"itm4n\" or \"nurfed1\" or\n      \"cfalta\" or \"Scott Sutherland\" or\n      \"_nullbind\" or \"_tmenochet\" or\n      \"jaredcatkinson\" or \"ChrisTruncer\" or\n      \"monoxgas\" or \"TheRealWover\" or\n      \"splinter_code\"\n  )",
        "language": "kuery"
      },
      {
        "name": "Persistence via Update Orchestrator Service Hijack",
        "description": "Identifies potential hijacking of the Microsoft Update Orchestrator Service to establish persistence with an integrity level of SYSTEM.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Persistence via Update Orchestrator Service Hijack\n\nWindows Update Orchestrator Service is a DCOM service used by other components to install Windows updates that are already downloaded. Windows Update Orchestrator Service was vulnerable to elevation of privileges (any user to local system) due to an improper authorization of the callers. The vulnerability affected the Windows 10 and Windows Server Core products. Fixed by Microsoft on Patch Tuesday June 2020.\n\nThis rule will detect uncommon processes spawned by `svchost.exe` with `UsoSvc` as the command line parameters. Attackers can leverage this technique to elevate privileges or maintain persistence.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate any abnormal behavior by the subject process such as network connections, registry or file modifications, and any spawned child processes.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the process executable using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 312,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Tactic: Privilege Escalation",
          "Use Case: Vulnerability",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/irsl/CVE-2020-1313"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1543",
                "name": "Create or Modify System Process",
                "reference": "https://attack.mitre.org/techniques/T1543/",
                "subtechnique": [
                  {
                    "id": "T1543.003",
                    "name": "Windows Service",
                    "reference": "https://attack.mitre.org/techniques/T1543/003/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1068",
                "name": "Exploitation for Privilege Escalation",
                "reference": "https://attack.mitre.org/techniques/T1068/"
              },
              {
                "id": "T1574",
                "name": "Hijack Execution Flow",
                "reference": "https://attack.mitre.org/techniques/T1574/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "f3e4a2a9-7604-4cc2-9aa5-ae5f848b49b7",
        "rule_id": "265db8f5-fc73-4d0d-b434-6483b56372e2",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:58.881Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:25.521Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.parent.executable : \"C:\\\\Windows\\\\System32\\\\svchost.exe\" and\n  process.parent.args : \"UsoSvc\" and\n  not process.executable :\n          (\"?:\\\\ProgramData\\\\Microsoft\\\\Windows\\\\UUS\\\\Packages\\\\*\\\\amd64\\\\MoUsoCoreWorker.exe\",\n          \"?:\\\\Windows\\\\System32\\\\UsoClient.exe\",\n          \"?:\\\\Windows\\\\System32\\\\MusNotification.exe\",\n          \"?:\\\\Windows\\\\System32\\\\MusNotificationUx.exe\",\n          \"?:\\\\Windows\\\\System32\\\\MusNotifyIcon.exe\",\n          \"?:\\\\Windows\\\\System32\\\\WerFault.exe\",\n          \"?:\\\\Windows\\\\System32\\\\WerMgr.exe\",\n          \"?:\\\\Windows\\\\UUS\\\\amd64\\\\MoUsoCoreWorker.exe\",\n          \"?:\\\\Windows\\\\System32\\\\MoUsoCoreWorker.exe\",\n          \"?:\\\\Windows\\\\UUS\\\\amd64\\\\UsoCoreWorker.exe\",\n          \"?:\\\\Windows\\\\System32\\\\UsoCoreWorker.exe\",\n          \"?:\\\\Program Files\\\\Common Files\\\\microsoft shared\\\\ClickToRun\\\\OfficeC2RClient.exe\") and\n  not process.name : (\"MoUsoCoreWorker.exe\", \"OfficeC2RClient.exe\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*"
        ],
        "filters": []
      },
      {
        "name": "PowerShell Script with Archive Compression Capabilities",
        "description": "Identifies the use of Cmdlets and methods related to archive compression activities. Adversaries will often compress and encrypt data in preparation for exfiltration.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 208,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Collection",
          "Data Source: PowerShell Logs",
          "Rule Type: BBR"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0009",
              "name": "Collection",
              "reference": "https://attack.mitre.org/tactics/TA0009/"
            },
            "technique": [
              {
                "id": "T1560",
                "name": "Archive Collected Data",
                "reference": "https://attack.mitre.org/techniques/T1560/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'PowerShell Script Block Logging' logging policy must be enabled.\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nAdministrative Templates >\nWindows PowerShell >\nTurn on PowerShell Script Block Logging (Enable)\n```\n\nSteps to implement the logging policy via registry:\n\n```\nreg add \"hklm\\SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\ScriptBlockLogging\" /v EnableScriptBlockLogging /t REG_DWORD /d 1\n```\n",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.directory",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "powershell.file.script_block_text",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "c17a2e86-8cfe-41d3-a577-63e07796cb93",
        "rule_id": "27071ea3-e806-4697-8abc-e22c92aa4293",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:58.884Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:25.526Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-windows.powershell*"
        ],
        "filters": [
          {
            "meta": {
              "negate": true
            },
            "query": {
              "wildcard": {
                "file.path": {
                  "case_insensitive": true,
                  "value": "?:\\\\ProgramData\\\\Microsoft\\\\Windows Defender Advanced Threat Protection\\\\Downloads\\\\*"
                }
              }
            }
          },
          {
            "meta": {
              "negate": true
            },
            "query": {
              "wildcard": {
                "file.path": {
                  "case_insensitive": true,
                  "value": "?:\\\\ProgramData\\\\Microsoft\\\\Windows Defender Advanced Threat Protection\\\\DataCollection\\\\*"
                }
              }
            }
          },
          {
            "meta": {
              "negate": true
            },
            "query": {
              "wildcard": {
                "file.path": {
                  "case_insensitive": true,
                  "value": "?:\\\\Program Files\\\\WindowsPowerShell\\\\Modules\\\\dbatools\\\\*\\\\optional\\\\Expand-Archive.ps1"
                }
              }
            }
          },
          {
            "meta": {
              "negate": true
            },
            "query": {
              "wildcard": {
                "file.path": {
                  "case_insensitive": true,
                  "value": "?:\\\\Program Files\\\\WindowsPowerShell\\\\Modules\\\\dbatools\\\\*\\\\optional\\\\Compress-Archive.ps1"
                }
              }
            }
          },
          {
            "meta": {
              "negate": true
            },
            "query": {
              "wildcard": {
                "file.path": {
                  "case_insensitive": true,
                  "value": "?:\\\\Program Files\\\\Azure\\\\StorageSyncAgent\\\\AFSDiag.ps1"
                }
              }
            }
          }
        ],
        "query": "event.category:process and host.os.type:windows and\n(\n  powershell.file.script_block_text : (\n    \"IO.Compression.ZipFile\" or\n    \"IO.Compression.ZipArchive\" or\n    \"ZipFile.CreateFromDirectory\" or\n    \"IO.Compression.BrotliStream\" or\n    \"IO.Compression.DeflateStream\" or\n    \"IO.Compression.GZipStream\" or\n    \"IO.Compression.ZLibStream\"\n  ) and \n  powershell.file.script_block_text : (\n    \"CompressionLevel\" or\n    \"CompressionMode\" or\n    \"ZipArchiveMode\"\n  ) or\n  powershell.file.script_block_text : \"Compress-Archive\"\n) and\nnot powershell.file.script_block_text : (\n  \"Compress-Archive -Path 'C:\\ProgramData\\Lenovo\\Udc\\diagnostics\\latest\" or\n  (\"Copyright: (c) 2017, Ansible Project\" and \"Ansible.ModuleUtils.Backup\")\n) and\nnot file.directory : \"C:\\Program Files\\Microsoft Dependency Agent\\plugins\\lib\"",
        "language": "kuery"
      },
      {
        "name": "Remote File Download via MpCmdRun",
        "description": "Identifies the Windows Defender configuration utility (MpCmdRun.exe) being used to download a remote file.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Remote File Download via MpCmdRun\n\nAttackers commonly transfer tooling or malware from external systems into a compromised environment using the command and control channel. However, they can also abuse signed utilities to drop these files.\n\nThe `MpCmdRun.exe` is a command-line tool part of Windows Defender and is used to manage various Microsoft Windows Defender Antivirus settings and perform certain tasks. It can also be abused by attackers to download remote files, including malware and offensive tooling. This rule looks for the patterns used to perform downloads using the utility.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n> This investigation guide uses the [Investigate Markdown Plugin](https://www.elastic.co/guide/en/security/master/interactive-investigation-guides.html) introduced in Elastic Stack version 8.8.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n  - !{investigate{\"label\":\"Alerts associated with the user in the last 48h\",\"providers\":[[{\"excluded\":false,\"field\":\"event.kind\",\"queryType\":\"phrase\",\"value\":\"signal\",\"valueType\":\"string\"},{\"excluded\":false,\"field\":\"user.id\",\"queryType\":\"phrase\",\"value\":\"{{user.id}}\",\"valueType\":\"string\"}]],\"relativeFrom\":\"now-48h/h\",\"relativeTo\":\"now\"}}\n  - !{investigate{\"label\":\"Alerts associated with the host in the last 48h\",\"providers\":[[{\"excluded\":false,\"field\":\"event.kind\",\"queryType\":\"phrase\",\"value\":\"signal\",\"valueType\":\"string\"},{\"excluded\":false,\"field\":\"host.name\",\"queryType\":\"phrase\",\"value\":\"{{host.name}}\",\"valueType\":\"string\"}]],\"relativeFrom\":\"now-48h/h\",\"relativeTo\":\"now\"}}\n- Check the reputation of the domain or IP address used to host the downloaded file.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the file using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n        - !{investigate{\"label\":\"Investigate the Subject Process Network Events\",\"providers\":[[{\"excluded\":false,\"field\":\"process.entity_id\",\"queryType\":\"phrase\",\"value\":\"{{process.entity_id}}\",\"valueType\":\"string\"},{\"excluded\":false,\"field\":\"event.category\",\"queryType\":\"phrase\",\"value\":\"network\",\"valueType\":\"string\"}]]}}\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 314,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Command and Control",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://twitter.com/mohammadaskar2/status/1301263551638761477",
          "https://www.bleepingcomputer.com/news/microsoft/microsoft-defender-can-ironically-be-used-to-download-malware/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            },
            "technique": [
              {
                "id": "T1105",
                "name": "Ingress Tool Transfer",
                "reference": "https://attack.mitre.org/techniques/T1105/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "a36f2c8c-dbd4-4392-8c08-7bb7de290e7c",
        "rule_id": "c6453e73-90eb-4fe7-a98c-cde7bbfc504a",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:58.888Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:34.040Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (process.name : \"MpCmdRun.exe\" or ?process.pe.original_file_name == \"MpCmdRun.exe\") and\n   process.args : \"-DownloadFile\" and process.args : \"-url\" and process.args : \"-path\"",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Disabling Windows Defender Security Settings via PowerShell",
        "description": "Identifies use of the Set-MpPreference PowerShell command to disable or weaken certain Windows Defender settings.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Disabling Windows Defender Security Settings via PowerShell\n\nMicrosoft Windows Defender is an antivirus product built into Microsoft Windows, which makes it popular across multiple environments. Disabling it is a common step in threat actor playbooks.\n\nThis rule monitors the execution of commands that can tamper the Windows Defender antivirus features.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Validate the activity is not related to planned patches, updates, network administrator activity, or legitimate software installations.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Examine the command line to determine which action was executed. Based on that, examine exceptions, antivirus state, sample submission, etc.\n\n### False positive analysis\n\n- This mechanism can be used legitimately. Analysts can dismiss the alert if the administrator is aware of the activity, the configuration is justified (for example, it is being used to deploy other security solutions or troubleshooting), and no other suspicious activity has been observed.\n\n### Related rules\n\n- Windows Defender Disabled via Registry Modification - 2ffa1f1e-b6db-47fa-994b-1512743847eb\n- Microsoft Windows Defender Tampering - fe794edd-487f-4a90-b285-3ee54f2af2d3\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Based on the command line, take actions to restore the appropriate Windows Defender antivirus configurations.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Review the privileges assigned to the user to ensure that the least privilege principle is being followed.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 313,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Tactic: Execution",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Planned Windows Defender configuration changes."
        ],
        "references": [
          "https://docs.microsoft.com/en-us/powershell/module/defender/set-mppreference?view=windowsserver2019-ps",
          "https://www.elastic.co/security-labs/operation-bleeding-bear",
          "https://www.elastic.co/security-labs/invisible-miners-unveiling-ghostengine"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.001",
                    "name": "Disable or Modify Tools",
                    "reference": "https://attack.mitre.org/techniques/T1562/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "e7b318e5-312a-4155-acac-fdacc8b0fd1b",
        "rule_id": "c8cccb06-faf2-4cd5-886e-2c9636cfcb87",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:58.891Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:34.068Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (\n    process.name : (\"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\") or\n    ?process.pe.original_file_name in (\"powershell.exe\", \"pwsh.dll\", \"powershell_ise.exe\")\n  ) and\n  process.args : \"Set-MpPreference\" and process.args : (\"-Disable*\", \"Disabled\", \"NeverSend\", \"-Exclusion*\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Potential PowerShell HackTool Script by Function Names",
        "description": "Detects known PowerShell offensive tooling functions names in PowerShell scripts. Attackers commonly use out-of-the-box offensive tools without modifying the code. This rule aim is to take advantage of that.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Potential PowerShell HackTool Script by Function Names\n\nPowerShell is one of the main tools system administrators use for automation, report routines, and other tasks. This makes it available for use in various environments, and creates an attractive way for attackers to execute code.\n\nAdversaries often exploit PowerShell's capabilities to execute malicious scripts and perform various attacks. This rule identifies known offensive tooling function names in PowerShell scripts, as attackers commonly use out-of-the-box tools without modifying the code. By monitoring these specific function names, the rule aims to detect and alert potential malicious PowerShell activity.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n### Possible investigation steps\n\n- Examine the script content that triggered the detection; look for suspicious DLL imports, collection or exfiltration capabilities, suspicious functions, encoded or compressed data, and other potentially malicious characteristics.\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Examine the script's execution context, such as the user account, privileges, the role of the system on which it was executed, and any relevant timestamps.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Evaluate whether the user needs to use PowerShell to complete tasks.\n- Investigate the origin of the PowerShell script, including its source, download method, and any associated URLs or IP addresses.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the script using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process's `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n\n### False positive analysis\n\n- This rule may generate false positives if legitimate scripts or tools used by administrators contain any of the listed function names. These function names are commonly associated with offensive tooling, but they may also be present in benign scripts or tools.\n- To handle these false positives consider adding exceptions - preferably with a combination of full file path and users.\n\n### Related Rules\n\n- PowerShell Invoke-NinjaCopy script - b8386923-b02c-4b94-986a-d223d9b01f88\n- PowerShell Suspicious Discovery Related Windows API Functions - 61ac3638-40a3-44b2-855a-985636ca985e\n- Potential Process Injection via PowerShell - 2e29e96a-b67c-455a-afe4-de6183431d0d\n- PowerShell Keylogging Script - bd2c86a0-8b61-4457-ab38-96943984e889\n\n### Response and Remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n  - If malicious activity is confirmed, perform a broader investigation to identify the scope of the compromise and determine the appropriate remediation steps.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Reimage the host operating system or restore the compromised files to clean versions.\n- Restrict PowerShell usage outside of IT and engineering business units using GPOs, AppLocker, Intune, or similar software.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 213,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Data Source: PowerShell Logs"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/atc-project/atc-data/blob/master/docs/Logging_Policies/LP_0109_windows_powershell_script_block_log.md",
          "https://github.com/BC-SECURITY/Empire"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'PowerShell Script Block Logging' logging policy must be enabled.\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nAdministrative Templates >\nWindows PowerShell >\nTurn on PowerShell Script Block Logging (Enable)\n```\n\nSteps to implement the logging policy via registry:\n\n```\nreg add \"hklm\\SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\ScriptBlockLogging\" /v EnableScriptBlockLogging /t REG_DWORD /d 1\n```\n",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "powershell.file.script_block_text",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "c221787a-3520-488f-adf4-859da4a9f5ce",
        "rule_id": "cde1bafa-9f01-4f43-a872-605b678968b0",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:58.895Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:34.074Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-windows.powershell*"
        ],
        "filters": [
          {
            "meta": {
              "negate": true
            },
            "query": {
              "wildcard": {
                "file.path": {
                  "case_insensitive": true,
                  "value": "?:\\\\ProgramData\\\\Microsoft\\\\Windows Defender Advanced Threat Protection\\\\DataCollection\\\\*"
                }
              }
            }
          }
        ],
        "query": "event.category:process and host.os.type:windows and\n  powershell.file.script_block_text : (\n    \"Add-DomainGroupMember\" or \"Add-DomainObjectAcl\" or\n    \"Add-RemoteConnection\" or \"Add-ServiceDacl\" or\n    \"Add-Win32Type\" or \"Convert-ADName\" or\n    \"Convert-LDAPProperty\" or \"ConvertFrom-LDAPLogonHours\" or\n    \"ConvertFrom-UACValue\" or \"Copy-ArrayOfMemAddresses\" or\n    \"Create-NamedPipe\" or \"Create-ProcessWithToken\" or\n    \"Create-RemoteThread\" or \"Create-SuspendedWinLogon\" or\n    \"Create-WinLogonProcess\" or \"Emit-CallThreadStub\" or\n    \"Enable-SeAssignPrimaryTokenPrivilege\" or \"Enable-SeDebugPrivilege\" or\n    \"Enum-AllTokens\" or \"Export-PowerViewCSV\" or\n    \"Find-AVSignature\" or \"Find-AppLockerLog\" or\n    \"Find-DomainLocalGroupMember\" or \"Find-DomainObjectPropertyOutlier\" or\n    \"Find-DomainProcess\" or \"Find-DomainShare\" or\n    \"Find-DomainUserEvent\" or \"Find-DomainUserLocation\" or\n    \"Find-InterestingDomainAcl\" or \"Find-InterestingDomainShareFile\" or\n    \"Find-InterestingFile\" or \"Find-LocalAdminAccess\" or\n    \"Find-PSScriptsInPSAppLog\" or \"Find-PathDLLHijack\" or\n    \"Find-ProcessDLLHijack\" or \"Find-RDPClientConnection\" or\n    \"Get-AllAttributesForClass\" or \"Get-CachedGPPPassword\" or\n    \"Get-DecryptedCpassword\" or \"Get-DecryptedSitelistPassword\" or\n    \"Get-DelegateType\" or \"New-RelayEnumObject\" or\n    \"Get-DomainDFSShare\" or \"Get-DomainDFSShareV1\" or\n    \"Get-DomainDFSShareV2\" or \"Get-DomainDNSRecord\" or\n    \"Get-DomainDNSZone\" or \"Get-DomainFileServer\" or\n    \"Get-DomainForeignGroupMember\" or \"Get-DomainForeignUser\" or\n    \"Get-DomainGPO\" or \"Get-DomainGPOComputerLocalGroupMapping\" or\n    \"Get-DomainGPOLocalGroup\" or \"Get-DomainGPOUserLocalGroupMapping\" or\n    \"Get-DomainGUIDMap\" or \"Get-DomainGroup\" or\n    \"Get-DomainGroupMember\" or \"Get-DomainGroupMemberDeleted\" or\n    \"Get-DomainManagedSecurityGroup\" or \"Get-DomainOU\" or\n    \"Get-DomainObject\" or \"Get-DomainObjectAcl\" or\n    \"Get-DomainObjectAttributeHistory\" or \"Get-DomainObjectLinkedAttributeHistory\" or\n    \"Get-DomainPolicyData\" or \"Get-DomainSID\" or\n    \"Get-DomainSPNTicket\" or \"Get-DomainSearcher\" or\n    \"Get-DomainSite\" or \"Get-DomainSubnet\" or\n    \"Get-DomainTrust\" or \"Get-DomainTrustMapping\" or\n    \"Get-DomainUser\" or \"Get-DomainUserEvent\" or\n    \"Get-Forest\" or \"Get-ForestDomain\" or\n    \"Get-ForestGlobalCatalog\" or \"Get-ForestSchemaClass\" or\n    \"Get-ForestTrust\" or \"Get-GPODelegation\" or\n    \"Get-GPPAutologon\" or \"Get-GPPInnerField\" or\n    \"Get-GPPInnerFields\" or \"Get-GPPPassword\" or\n    \"Get-GptTmpl\" or \"Get-GroupsXML\" or\n    \"Get-HttpStatus\" or \"Get-ImageNtHeaders\" or\n    \"Get-Keystrokes\" or \"New-SOASerialNumberArray\" or \n    \"Get-MemoryProcAddress\" or \"Get-MicrophoneAudio\" or\n    \"Get-ModifiablePath\" or \"Get-ModifiableRegistryAutoRun\" or\n    \"Get-ModifiableScheduledTaskFile\" or \"Get-ModifiableService\" or\n    \"Get-ModifiableServiceFile\" or \"Get-Name\" or\n    \"Get-NetComputerSiteName\" or \"Get-NetLocalGroup\" or\n    \"Get-NetLocalGroupMember\" or \"Get-NetLoggedon\" or\n    \"Get-NetRDPSession\" or \"Get-NetSession\" or\n    \"Get-NetShare\" or \"Get-PEArchitecture\" or\n    \"Get-PEBasicInfo\" or \"Get-PEDetailedInfo\" or\n    \"Get-PathAcl\" or \"Get-PrimaryToken\" or\n    \"Get-ProcAddress\" or \"Get-ProcessTokenGroup\" or\n    \"Get-ProcessTokenPrivilege\" or \"Get-ProcessTokenType\" or\n    \"Get-RegLoggedOn\" or \"Get-RegistryAlwaysInstallElevated\" or\n    \"Get-RegistryAutoLogon\" or \"Get-RemoteProcAddress\" or\n    \"Get-Screenshot\" or \"Get-ServiceDetail\" or\n    \"Get-SiteListPassword\" or \"Get-SitelistField\" or\n    \"Get-System\" or \"Get-SystemNamedPipe\" or\n    \"Get-SystemToken\" or \"Get-ThreadToken\" or\n    \"Get-TimedScreenshot\" or \"Get-TokenInformation\" or\n    \"Get-TopPort\" or \"Get-UnattendedInstallFile\" or\n    \"Get-UniqueTokens\" or \"Get-UnquotedService\" or\n    \"Get-VaultCredential\" or \"Get-VaultElementValue\" or\n    \"Get-VirtualProtectValue\" or \"Get-VolumeShadowCopy\" or\n    \"Get-WMIProcess\" or \"Get-WMIRegCachedRDPConnection\" or\n    \"Get-WMIRegLastLoggedOn\" or \"Get-WMIRegMountedDrive\" or\n    \"Get-WMIRegProxy\" or \"Get-WebConfig\" or\n    \"Get-Win32Constants\" or \"Get-Win32Functions\" or\n    \"Get-Win32Types\" or \"Import-DllImports\" or\n    \"Import-DllInRemoteProcess\" or \"Inject-LocalShellcode\" or\n    \"Inject-RemoteShellcode\" or \"Install-ServiceBinary\" or\n    \"Invoke-CompareAttributesForClass\" or \"Invoke-CreateRemoteThread\" or\n    \"Invoke-CredentialInjection\" or \"Invoke-DllInjection\" or\n    \"Invoke-EventVwrBypass\" or \"Invoke-ImpersonateUser\" or\n    \"Invoke-Kerberoast\" or \"Invoke-MemoryFreeLibrary\" or\n    \"Invoke-MemoryLoadLibrary\" or\n    \"Invoke-Mimikatz\" or \"Invoke-NinjaCopy\" or\n    \"Invoke-PatchDll\" or \"Invoke-Portscan\" or\n    \"Invoke-PrivescAudit\" or \"Invoke-ReflectivePEInjection\" or\n    \"Invoke-ReverseDnsLookup\" or \"Invoke-RevertToSelf\" or\n    \"Invoke-ServiceAbuse\" or \"Invoke-Shellcode\" or\n    \"Invoke-TokenManipulation\" or \"Invoke-UserImpersonation\" or\n    \"Invoke-WmiCommand\" or \"Mount-VolumeShadowCopy\" or\n    \"New-ADObjectAccessControlEntry\" or \"New-DomainGroup\" or\n    \"New-DomainUser\" or \"New-DynamicParameter\" or\n    \"New-InMemoryModule\" or\n    \"New-ThreadedFunction\" or \"New-VolumeShadowCopy\" or\n    \"Out-CompressedDll\" or \"Out-EncodedCommand\" or\n    \"Out-EncryptedScript\" or \"Out-Minidump\" or\n    \"PortScan-Alive\" or \"Portscan-Port\" or\n    \"Remove-DomainGroupMember\" or \"Remove-DomainObjectAcl\" or\n    \"Remove-RemoteConnection\" or \"Remove-VolumeShadowCopy\" or\n    \"Restore-ServiceBinary\" or \"Set-DesktopACLToAllowEveryone\" or\n    \"Set-DesktopACLs\" or \"Set-DomainObject\" or\n    \"Set-DomainObjectOwner\" or \"Set-DomainUserPassword\" or\n    \"Set-ServiceBinaryPath\" or \"Sub-SignedIntAsUnsigned\" or\n    \"Test-AdminAccess\" or \"Test-MemoryRangeValid\" or\n    \"Test-ServiceDaclPermission\" or \"Update-ExeFunctions\" or\n    \"Update-MemoryAddresses\" or \"Update-MemoryProtectionFlags\" or\n    \"Write-BytesToMemory\" or \"Write-HijackDll\" or\n    \"Write-PortscanOut\" or \"Write-ServiceBinary\" or\n    \"Write-UserAddMSI\" or \"Invoke-Privesc\" or\n    \"func_get_proc_address\" or \"Invoke-BloodHound\" or\n    \"Invoke-HostEnum\" or \"Get-BrowserInformation\" or\n    \"Get-DomainAccountPolicy\" or \"Get-DomainAdmins\" or\n    \"Get-AVProcesses\" or \"Get-AVInfo\" or\n    \"Get-RecycleBin\" or \"Invoke-BruteForce\" or\n    \"Get-PassHints\" or \"Invoke-SessionGopher\" or\n    \"Get-LSASecret\" or \"Get-PassHashes\" or\n    \"Invoke-WdigestDowngrade\" or \"Get-ChromeDump\" or\n    \"Invoke-DomainPasswordSpray\" or \"Get-FoxDump\" or\n    \"New-HoneyHash\" or \"Invoke-DCSync\" or\n    \"Invoke-PowerDump\" or \"Invoke-SSIDExfil\" or\n    \"Invoke-PowerShellTCP\" or \"Add-Exfiltration\" or\n    \"Do-Exfiltration\" or \"Invoke-DropboxUpload\" or\n    \"Invoke-ExfilDataToGitHub\" or \"Invoke-EgressCheck\" or\n    \"Invoke-PostExfil\" or \"Create-MultipleSessions\" or\n    \"Invoke-NetworkRelay\" or \"New-GPOImmediateTask\" or\n    \"Invoke-WMIDebugger\" or \"Invoke-SQLOSCMD\" or\n    \"Invoke-SMBExec\" or \"Invoke-PSRemoting\" or\n    \"Invoke-ExecuteMSBuild\" or \"Invoke-DCOM\" or\n    \"Invoke-InveighRelay\" or \"Invoke-PsExec\" or\n    \"Invoke-SSHCommand\" or \"Find-ActiveUsersWMI\" or\n    \"Get-SystemDrivesWMI\" or \"Get-ActiveNICSWMI\" or\n    \"Remove-Persistence\" or \"DNS_TXT_Pwnage\" or\n    \"Execute-OnTime\" or \"HTTP-Backdoor\" or\n    \"Add-ConstrainedDelegationBackdoor\" or \"Add-RegBackdoor\" or\n    \"Add-ScrnSaveBackdoor\" or \"Gupt-Backdoor\" or\n    \"Invoke-ADSBackdoor\" or \"Add-Persistence\" or\n    \"Invoke-ResolverBackdoor\" or \"Invoke-EventLogBackdoor\" or\n    \"Invoke-DeadUserBackdoor\" or \"Invoke-DisableMachineAcctChange\" or\n    \"Invoke-AccessBinary\" or \"Add-NetUser\" or\n    \"Invoke-Schtasks\" or \"Invoke-JSRatRegsvr\" or\n    \"Invoke-JSRatRundll\" or \"Invoke-PoshRatHttps\" or\n    \"Invoke-PsGcatAgent\" or \"Remove-PoshRat\" or\n    \"Install-SSP\" or \"Invoke-BackdoorLNK\" or\n    \"PowerBreach\" or \"InstallEXE-Persistence\" or\n    \"RemoveEXE-Persistence\" or \"Install-ServiceLevel-Persistence\" or\n    \"Remove-ServiceLevel-Persistence\" or \"Invoke-Prompt\" or\n    \"Invoke-PacketCapture\" or \"Start-WebcamRecorder\" or\n    \"Get-USBKeyStrokes\" or \"Invoke-KeeThief\" or\n    \"Get-Keystrokes\" or \"Invoke-NetRipper\" or\n    \"Get-EmailItems\" or \"Invoke-MailSearch\" or\n    \"Invoke-SearchGAL\" or \"Get-WebCredentials\" or\n    \"Start-CaptureServer\" or \"Invoke-PowerShellIcmp\" or\n    \"Invoke-PowerShellTcpOneLine\" or \"Invoke-PowerShellTcpOneLineBind\" or\n    \"Invoke-PowerShellUdp\" or \"Invoke-PowerShellUdpOneLine\" or\n    \"Run-EXEonRemote\" or \"Download-Execute-PS\" or\n    \"Out-RundllCommand\" or \"Set-RemoteWMI\" or\n    \"Set-DCShadowPermissions\" or \"Invoke-PowerShellWMI\" or\n    \"Invoke-Vnc\" or \"Invoke-LockWorkStation\" or\n    \"Invoke-EternalBlue\" or \"Invoke-ShellcodeMSIL\" or\n    \"Invoke-MetasploitPayload\" or \"Invoke-DowngradeAccount\" or\n    \"Invoke-RunAs\" or \"ExetoText\" or\n    \"Disable-SecuritySettings\" or \"Set-MacAttribute\" or\n    \"Invoke-MS16032\" or \"Invoke-BypassUACTokenManipulation\" or\n    \"Invoke-SDCLTBypass\" or \"Invoke-FodHelperBypass\" or\n    \"Invoke-EventVwrBypass\" or \"Invoke-EnvBypass\" or\n    \"Get-ServiceUnquoted\" or \"Get-ServiceFilePermission\" or\n    \"Get-ServicePermission\" or\n    \"Enable-DuplicateToken\" or \"Invoke-PsUaCme\" or\n    \"Invoke-Tater\" or \"Invoke-WScriptBypassUAC\" or\n    \"Invoke-AllChecks\" or \"Find-TrustedDocuments\" or\n    \"Invoke-Interceptor\" or \"Invoke-PoshRatHttp\" or\n    \"Invoke-ExecCommandWMI\" or \"Invoke-KillProcessWMI\" or\n    \"Invoke-CreateShareandExecute\" or \"Invoke-RemoteScriptWithOutput\" or\n    \"Invoke-SchedJobManipulation\" or \"Invoke-ServiceManipulation\" or\n    \"Invoke-PowerOptionsWMI\" or \"Invoke-DirectoryListing\" or\n    \"Invoke-FileTransferOverWMI\" or \"Invoke-WMImplant\" or\n    \"Invoke-WMIObfuscatedPSCommand\" or \"Invoke-WMIDuplicateClass\" or\n    \"Invoke-WMIUpload\" or \"Invoke-WMIRemoteExtract\" or \"Invoke-winPEAS\"\n  ) and\n  not powershell.file.script_block_text : (\n    \"sentinelbreakpoints\" and \"Set-PSBreakpoint\"\n  ) and\n  not user.id : (\"S-1-5-18\" or \"S-1-5-19\")",
        "language": "kuery"
      },
      {
        "name": "New ActiveSyncAllowedDeviceID Added via PowerShell",
        "description": "Identifies the use of the Exchange PowerShell cmdlet, Set-CASMailbox, to add a new ActiveSync allowed device. Adversaries may target user email to collect sensitive information.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 311,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Tactic: Execution",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Legitimate exchange system administration activity."
        ],
        "references": [
          "https://www.volexity.com/blog/2020/12/14/dark-halo-leverages-solarwinds-compromise-to-breach-organizations/",
          "https://docs.microsoft.com/en-us/powershell/module/exchange/set-casmailbox?view=exchange-ps"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1098",
                "name": "Account Manipulation",
                "reference": "https://attack.mitre.org/techniques/T1098/",
                "subtechnique": [
                  {
                    "id": "T1098.002",
                    "name": "Additional Email Delegate Permissions",
                    "reference": "https://attack.mitre.org/techniques/T1098/002/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "dc380246-6d06-46c3-99cb-f9c334bed009",
        "rule_id": "ce64d965-6cb0-466d-b74f-8d2c76f47f05",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:58.898Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:34.079Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.name: (\"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\") and process.args : \"Set-CASMailbox*ActiveSyncAllowedDeviceIDs*\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "winlogbeat-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Symbolic Link to Shadow Copy Created",
        "description": "Identifies the creation of symbolic links to a shadow copy. Symbolic links can be used to access files in the shadow copy, including sensitive files such as ntds.dit, System Boot Key and browser offline credentials.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Symbolic Link to Shadow Copy Created\n\nShadow copies are backups or snapshots of an endpoint's files or volumes while they are in use. Adversaries may attempt to discover and create symbolic links to these shadow copies in order to copy sensitive information offline. If Active Directory (AD) is in use, often the ntds.dit file is a target as it contains password hashes, but an offline copy is needed to extract these hashes and potentially conduct lateral movement.\n\n#### Possible investigation steps\n\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Determine if a volume shadow copy was recently created on this endpoint.\n- Review privileges of the end user as this requires administrative access.\n- Verify if the ntds.dit file was successfully copied and determine its copy destination.\n- Investigate for registry SYSTEM file copies made recently or saved via Reg.exe.\n- Investigate recent deletions of volume shadow copies.\n- Identify other files potentially copied from volume shadow copy paths directly.\n\n### False positive analysis\n\n- This rule should cause very few false positives. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Related rules\n\n- NTDS or SAM Database File Copied - 3bc6deaa-fbd4-433a-ae21-3e892f95624f\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- If the entire domain or the `krbtgt` user was compromised:\n  - Activate your incident response plan for total Active Directory compromise which should include, but not be limited to, a password reset (twice) of the `krbtgt` user.\n- Locate and remove static files copied from volume shadow copies.\n- Command-Line tool mklink should require administrative access by default unless in developer mode.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 313,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic",
          "Austin Songer"
        ],
        "false_positives": [
          "Legitimate administrative activity related to shadow copies."
        ],
        "references": [
          "https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/mklink",
          "https://2017.zeronights.org/wp-content/uploads/materials/ZN17_Kheirkhabarov_Hunting_for_Credentials_Dumping_in_Windows_Environment.pdf",
          "https://blog.netwrix.com/2021/11/30/extracting-password-hashes-from-the-ntds-dit-file/",
          "https://www.hackingarticles.in/credential-dumping-ntds-dit/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1003",
                "name": "OS Credential Dumping",
                "reference": "https://attack.mitre.org/techniques/T1003/",
                "subtechnique": [
                  {
                    "id": "T1003.002",
                    "name": "Security Account Manager",
                    "reference": "https://attack.mitre.org/techniques/T1003/002/"
                  },
                  {
                    "id": "T1003.003",
                    "name": "NTDS",
                    "reference": "https://attack.mitre.org/techniques/T1003/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nEnsure advanced audit policies for Windows are enabled, specifically:\nObject Access policies [Event ID 4656](https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4656) (Handle to an Object was Requested)\n\n```\nComputer Configuration >\nPolicies >\nWindows Settings >\nSecurity Settings >\nAdvanced Audit Policies Configuration >\nSystem Audit Policies >\nObject Access >\nAudit File System (Success,Failure)\nAudit Handle Manipulation (Success,Failure)\n```\n\nThis event will only trigger if symbolic links are created from a new process spawning cmd.exe or powershell.exe with the correct arguments.\nDirect access to a shell and calling symbolic link creation tools will not generate an event matching this rule.\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "7eb6d17e-93f2-48d8-b159-74ed81c5ec35",
        "rule_id": "d117cbb4-7d56-41b4-b999-bdf8c25648a0",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:58.902Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:34.093Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n (\n    (?process.pe.original_file_name in (\"Cmd.Exe\",\"PowerShell.EXE\")) or\n    (process.name : (\"cmd.exe\", \"powershell.exe\"))\n ) and\n\n /* Create Symbolic Link to Shadow Copies */\n process.args : (\"*mklink*\", \"*SymbolicLink*\") and process.command_line : (\"*HarddiskVolumeShadowCopy*\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Clearing Windows Event Logs",
        "description": "Identifies attempts to clear or disable Windows event log stores using Windows wevetutil command. This is often done by attackers in an attempt to evade detection or destroy forensic evidence on a system.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Clearing Windows Event Logs\n\nWindows event logs are a fundamental data source for security monitoring, forensics, and incident response. Adversaries can tamper, clear, and delete this data to break SIEM detections, cover their tracks, and slow down incident response.\n\nThis rule looks for the execution of the `wevtutil.exe` utility or the `Clear-EventLog` cmdlet to clear event logs.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n  - Verify if any other anti-forensics behaviors were observed.\n- Investigate the event logs prior to the action for suspicious behaviors that an attacker may be trying to cover up.\n\n### False positive analysis\n\n- This mechanism can be used legitimately. Analysts can dismiss the alert if the administrator is aware of the activity and there are justifications for this action.\n- Analyze whether the cleared event log is pertinent to security and general monitoring. Administrators can clear non-relevant event logs using this mechanism. If this activity is expected and noisy in your environment, consider adding exceptions â€” preferably with a combination of user and command line conditions.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n  - This activity is potentially done after the adversary achieves its objectives on the host. Ensure that previous actions, if any, are investigated accordingly with their response playbooks.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 315,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/security-labs/invisible-miners-unveiling-ghostengine"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1070",
                "name": "Indicator Removal",
                "reference": "https://attack.mitre.org/techniques/T1070/",
                "subtechnique": [
                  {
                    "id": "T1070.001",
                    "name": "Clear Windows Event Logs",
                    "reference": "https://attack.mitre.org/techniques/T1070/001/"
                  },
                  {
                    "id": "T1562.002",
                    "name": "Disable Windows Event Logging",
                    "reference": "https://attack.mitre.org/techniques/T1562/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "0d9e5056-7dd6-4211-8aba-0030fb959360",
        "rule_id": "d331bbe2-6db4-4941-80a5-8270db72eb61",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:58.905Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:34.102Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n(\n  (\n    (process.name : \"wevtutil.exe\" or ?process.pe.original_file_name == \"wevtutil.exe\") and\n    process.args : (\"/e:false\", \"cl\", \"clear-log\")\n  ) or\n  (\n    (\n      process.name : (\"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\") or\n      ?process.pe.original_file_name in (\"powershell.exe\", \"pwsh.dll\", \"powershell_ise.exe\")\n    ) and\n    process.args : \"Clear-EventLog\"\n  )\n)",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "System Information Discovery via Windows Command Shell",
        "description": "Identifies the execution of discovery commands to enumerate system information, files, and folders using the Windows Command Shell.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating System Information Discovery via Windows Command Shell\n\nAfter successfully compromising an environment, attackers may try to gain situational awareness to plan their next steps. This can happen by running commands to enumerate network resources, users, connections, files, and installed security software.\n\nThis rule identifies commands to enumerate system information, files, and folders using the Windows Command Shell.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate any abnormal account behavior, such as command executions, file creations or modifications, and network connections.\n\n### False positive analysis\n\n- Discovery activities are not inherently malicious if they occur in isolation. As long as the analyst did not identify suspicious activity related to the user or host, such alerts can be dismissed.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "building_block_type": "default",
        "output_index": "",
        "version": 114,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Tactic: Execution",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend",
          "Rule Type: BBR",
          "Data Source: Elastic Endgame",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1082",
                "name": "System Information Discovery",
                "reference": "https://attack.mitre.org/techniques/T1082/"
              },
              {
                "id": "T1083",
                "name": "File and Directory Discovery",
                "reference": "https://attack.mitre.org/techniques/T1083/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.003",
                    "name": "Windows Command Shell",
                    "reference": "https://attack.mitre.org/techniques/T1059/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "67231588-07f8-4e9c-978d-62b315a091ad",
        "rule_id": "d68e95ad-1c82-4074-a12a-125fe10ac8ba",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:58.908Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:34.130Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.name : \"cmd.exe\" and process.args : \"/c\" and process.args : (\"set\", \"dir\") and\n  not process.parent.executable : (\"?:\\\\Program Files\\\\*\", \"?:\\\\Program Files (x86)\\\\*\", \"?:\\\\PROGRA~1\\\\*\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-windows.*",
          "logs-endpoint.events.process-*",
          "endgame-*",
          "logs-system.security*"
        ],
        "filters": []
      },
      {
        "name": "Command Execution via SolarWinds Process",
        "description": "A suspicious SolarWinds child process (Cmd.exe or Powershell.exe) was detected.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 313,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Tactic: Initial Access",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Trusted SolarWinds child processes. Verify process details such as network connections and file writes."
        ],
        "references": [
          "https://www.fireeye.com/blog/threat-research/2020/12/evasive-attacker-leverages-solarwinds-supply-chain-compromises-with-sunburst-backdoor.html",
          "https://github.com/mandiant/sunburst_countermeasures/blob/main/rules/SUNBURST/hxioc/SUNBURST%20SUSPICIOUS%20FILEWRITES%20(METHODOLOGY).ioc"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  },
                  {
                    "id": "T1059.003",
                    "name": "Windows Command Shell",
                    "reference": "https://attack.mitre.org/techniques/T1059/003/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1195",
                "name": "Supply Chain Compromise",
                "reference": "https://attack.mitre.org/techniques/T1195/",
                "subtechnique": [
                  {
                    "id": "T1195.002",
                    "name": "Compromise Software Supply Chain",
                    "reference": "https://attack.mitre.org/techniques/T1195/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "f5726cbe-7603-41db-8e19-41c9ff130b02",
        "rule_id": "d72e33fc-6e91-42ff-ac8b-e573268c5a87",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:59.159Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:34.140Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and process.name: (\"cmd.exe\", \"powershell.exe\") and\nprocess.parent.name: (\n     \"ConfigurationWizard*.exe\",\n     \"NetflowDatabaseMaintenance*.exe\",\n     \"NetFlowService*.exe\",\n     \"SolarWinds.Administration*.exe\",\n     \"SolarWinds.Collector.Service*.exe\",\n     \"SolarwindsDiagnostics*.exe\"\n     )",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "NTDS Dump via Wbadmin",
        "description": "Identifies the execution of wbadmin to access the NTDS.dit file in a domain controller. Attackers with privileges from groups like Backup Operators can abuse the utility to perform credential access and compromise the domain.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 203,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://medium.com/r3d-buck3t/windows-privesc-with-sebackupprivilege-65d2cd1eb960"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1003",
                "name": "OS Credential Dumping",
                "reference": "https://attack.mitre.org/techniques/T1003/",
                "subtechnique": [
                  {
                    "id": "T1003.002",
                    "name": "Security Account Manager",
                    "reference": "https://attack.mitre.org/techniques/T1003/002/"
                  },
                  {
                    "id": "T1003.003",
                    "name": "NTDS",
                    "reference": "https://attack.mitre.org/techniques/T1003/003/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1006",
                "name": "Direct Volume Access",
                "reference": "https://attack.mitre.org/techniques/T1006/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "cfbf3e34-2f65-45ff-a6f9-f039b99b8c1c",
        "rule_id": "d93e61db-82d6-4095-99aa-714988118064",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:59.162Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:34.145Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n    (process.name : \"wbadmin.exe\" or ?process.pe.original_file_name : \"wbadmin.exe\") and \n     process.args : \"recovery\" and process.command_line : \"*ntds.dit*\"",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Volume Shadow Copy Deletion via PowerShell",
        "description": "Identifies the use of the Win32_ShadowCopy class and related cmdlets to achieve shadow copy deletion. This commonly occurs in tandem with ransomware or other destructive attacks.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Volume Shadow Copy Deletion via PowerShell\n\nThe Volume Shadow Copy Service (VSS) is a Windows feature that enables system administrators to take snapshots of volumes that can later be restored or mounted to recover specific files or folders.\n\nA typical step in the playbook of an attacker attempting to deploy ransomware is to delete Volume Shadow Copies to ensure that victims have no alternative to paying the ransom, making any action that deletes shadow copies worth monitoring.\n\nThis rule monitors the execution of PowerShell cmdlets to interact with the Win32_ShadowCopy WMI class, retrieve shadow copy objects, and delete them.\n\n#### Possible investigation steps\n\n- Investigate the program execution chain (parent process tree).\n- Check whether the account is authorized to perform this operation.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- If unsigned files are found on the process tree, retrieve them and determine if they are malicious:\n  - Use a private sandboxed malware analysis system to perform analysis.\n    - Observe and collect information about the following activities:\n      - Attempts to contact external domains and addresses.\n      - File and registry access, modification, and creation activities.\n      - Service creation and launch activities.\n      - Scheduled task creation.\n  - Use the PowerShell Get-FileHash cmdlet to get the files' SHA-256 hash values.\n    - Search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Use process name, command line, and file hash to search for occurrences in other hosts.\n- Check if any files on the host machine have been encrypted.\n\n\n### False positive analysis\n\n- This rule has chances of producing benign true positives (B-TPs). If this activity is expected and noisy in your environment, consider adding exceptions â€” preferably with a combination of user and command line conditions.\n\n### Related rules\n\n- Volume Shadow Copy Deleted or Resized via VssAdmin - b5ea4bfe-a1b2-421f-9d47-22a75a6f2921\n- Volume Shadow Copy Deletion via PowerShell - d99a037b-c8e2-47a5-97b9-170d076827c4\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Consider isolating the involved host to prevent destructive behavior, which is commonly associated with this activity.\n- Priority should be given due to the advanced stage of this activity on the attack.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- If data was encrypted, deleted, or modified, activate your data recovery plan.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Perform data recovery locally or restore the backups from replicated copies (cloud, other servers, etc.).\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 313,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Impact",
          "Tactic: Execution",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic",
          "Austin Songer"
        ],
        "false_positives": [],
        "references": [
          "https://docs.microsoft.com/en-us/previous-versions/windows/desktop/vsswmi/win32-shadowcopy",
          "https://powershell.one/wmi/root/cimv2/win32_shadowcopy",
          "https://www.fortinet.com/blog/threat-research/stomping-shadow-copies-a-second-look-into-deletion-methods"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0040",
              "name": "Impact",
              "reference": "https://attack.mitre.org/tactics/TA0040/"
            },
            "technique": [
              {
                "id": "T1490",
                "name": "Inhibit System Recovery",
                "reference": "https://attack.mitre.org/techniques/T1490/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "84d38671-189c-496d-82e1-4bd95b3af4b8",
        "rule_id": "d99a037b-c8e2-47a5-97b9-170d076827c4",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:59.165Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:34.151Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.name : (\"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\") and\n  process.args : (\"*Get-WmiObject*\", \"*gwmi*\", \"*Get-CimInstance*\", \"*gcim*\") and\n  process.args : (\"*Win32_ShadowCopy*\") and\n  process.args : (\"*.Delete()*\", \"*Remove-WmiObject*\", \"*rwmi*\", \"*Remove-CimInstance*\", \"*rcim*\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Potential Pass-the-Hash (PtH) Attempt",
        "description": "Adversaries may pass the hash using stolen password hashes to move laterally within an environment, bypassing normal system access controls. Pass the hash (PtH) is a method of authenticating as a user without having access to the user's cleartext password.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 106,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Lateral Movement",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://attack.mitre.org/techniques/T1550/002/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1550",
                "name": "Use Alternate Authentication Material",
                "reference": "https://attack.mitre.org/techniques/T1550/",
                "subtechnique": [
                  {
                    "id": "T1550.002",
                    "name": "Pass the Hash",
                    "reference": "https://attack.mitre.org/techniques/T1550/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.event_data.LogonProcessName",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "winlog.logon.type",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "f3465cb1-8aaf-41f2-9fee-5d9417f4fc9e",
        "rule_id": "daafdf96-e7b1-4f14-b494-27e0d24b11f6",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:59.167Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:36.228Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "host.os.type:\"windows\" and \nevent.category : \"authentication\" and event.action : \"logged-in\" and \nwinlog.logon.type : \"NewCredentials\" and event.outcome : \"success\" and \nuser.id : (S-1-5-21-* or S-1-12-1-*) and winlog.event_data.LogonProcessName : \"seclogo\"",
        "new_terms_fields": [
          "user.id"
        ],
        "history_window_start": "now-10d",
        "index": [
          "winlogbeat-*",
          "logs-windows.*",
          "logs-system.security*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Execution via Windows Subsystem for Linux",
        "description": "Detects attempts to execute a program on the host from the Windows Subsystem for Linux. Adversaries may enable and use WSL for Linux to avoid detection.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 208,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://learn.microsoft.com/en-us/windows/wsl/wsl-config"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1202",
                "name": "Indirect Command Execution",
                "reference": "https://attack.mitre.org/techniques/T1202/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "d79520eb-e417-4be0-b10f-3e016d9d5a00",
        "rule_id": "db7dbad5-08d2-4d25-b9b1-d3a1e4a15efd",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:59.177Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:35.942Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type : \"start\" and\n  process.parent.name : (\"wsl.exe\", \"wslhost.exe\") and\n  not process.executable : (\n        \"?:\\\\Program Files (x86)\\\\*\",\n        \"?:\\\\Program Files\\\\*\",\n        \"?:\\\\Program Files*\\\\WindowsApps\\\\MicrosoftCorporationII.WindowsSubsystemForLinux_*\\\\wsl*.exe\",\n        \"?:\\\\Windows\\\\System32\\\\conhost.exe\",\n        \"?:\\\\Windows\\\\System32\\\\lxss\\\\wslhost.exe\",\n        \"?:\\\\Windows\\\\System32\\\\WerFault.exe\",\n        \"?:\\\\Windows\\\\Sys?????\\\\wslconfig.exe\"\n  ) and\n  not (\n    event.dataset == \"crowdstrike.fdr\" and\n      process.executable : (\n        \"\\\\Device\\\\HarddiskVolume?\\\\Program Files (x86)\\\\*\",\n        \"\\\\Device\\\\HarddiskVolume?\\\\Program Files\\\\*\",\n        \"\\\\Device\\\\HarddiskVolume?\\\\Program Files*\\\\WindowsApps\\\\MicrosoftCorporationII.WindowsSubsystemForLinux_*\\\\wsl*.exe\",\n        \"\\\\Device\\\\HarddiskVolume?\\\\Windows\\\\System32\\\\conhost.exe\",\n        \"\\\\Device\\\\HarddiskVolume?\\\\Windows\\\\System32\\\\lxss\\\\wslhost.exe\",\n        \"\\\\Device\\\\HarddiskVolume?\\\\Windows\\\\System32\\\\WerFault.exe\",\n        \"\\\\Device\\\\HarddiskVolume?\\\\Windows\\\\Sys?????\\\\wslconfig.exe\"\n      )\n  )",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Volume Shadow Copy Deletion via WMIC",
        "description": "Identifies use of wmic.exe for shadow copy deletion on endpoints. This commonly occurs in tandem with ransomware or other destructive attacks.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Volume Shadow Copy Deletion via WMIC\n\nThe Volume Shadow Copy Service (VSS) is a Windows feature that enables system administrators to take snapshots of volumes that can later be restored or mounted to recover specific files or folders.\n\nA typical step in the playbook of an attacker attempting to deploy ransomware is to delete Volume Shadow Copies to ensure that victims have no alternative to paying the ransom, making any action that deletes shadow copies worth monitoring.\n\nThis rule monitors the execution of `wmic.exe` to interact with VSS via the `shadowcopy` alias and delete parameter.\n\n#### Possible investigation steps\n\n- Investigate the program execution chain (parent process tree).\n- Check whether the account is authorized to perform this operation.\n- Contact the account owner and confirm whether they are aware of this activity.\n- In the case of a resize operation, check if the resize value is equal to suspicious values, like 401MB.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- If unsigned files are found on the process tree, retrieve them and determine if they are malicious:\n  - Use a private sandboxed malware analysis system to perform analysis.\n    - Observe and collect information about the following activities:\n      - Attempts to contact external domains and addresses.\n      - File and registry access, modification, and creation activities.\n      - Service creation and launch activities.\n      - Scheduled task creation.\n  - Use the PowerShell Get-FileHash cmdlet to get the files' SHA-256 hash values.\n    - Search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Use process name, command line, and file hash to search for occurrences in other hosts.\n- Check if any files on the host machine have been encrypted.\n\n\n### False positive analysis\n\n- This rule has chances of producing benign true positives (B-TPs). If this activity is expected and noisy in your environment, consider adding exceptions â€” preferably with a combination of user and command line conditions.\n\n### Related rules\n\n- Volume Shadow Copy Deleted or Resized via VssAdmin - b5ea4bfe-a1b2-421f-9d47-22a75a6f2921\n- Volume Shadow Copy Deletion via PowerShell - d99a037b-c8e2-47a5-97b9-170d076827c4\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Priority should be given due to the advanced stage of this activity on the attack.\n- Consider isolating the involved host to prevent destructive behavior, which is commonly associated with this activity.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- If data was encrypted, deleted, or modified, activate your data recovery plan.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Perform data recovery locally or restore the backups from replicated copies (cloud, other servers, etc.).\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 313,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Impact",
          "Tactic: Execution",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0040",
              "name": "Impact",
              "reference": "https://attack.mitre.org/tactics/TA0040/"
            },
            "technique": [
              {
                "id": "T1490",
                "name": "Inhibit System Recovery",
                "reference": "https://attack.mitre.org/techniques/T1490/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1047",
                "name": "Windows Management Instrumentation",
                "reference": "https://attack.mitre.org/techniques/T1047/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "d09f6ad9-fabd-4938-b091-a43a843a78f0",
        "rule_id": "dc9c1f74-dac3-48e3-b47f-eb79db358f57",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:59.180Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:35.947Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (process.name : \"WMIC.exe\" or ?process.pe.original_file_name == \"wmic.exe\") and\n  process.args : \"delete\" and process.args : \"shadowcopy\"",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious Execution from INET Cache",
        "description": "Identifies the execution of a process with arguments pointing to the INetCache Folder. Adversaries may deliver malicious content via WININET during initial access.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 204,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Initial Access",
          "Tactic: Command and Control",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.trendmicro.com/en_us/research/24/b/cve202421412-water-hydra-targets-traders-with-windows-defender-s.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1566",
                "name": "Phishing",
                "reference": "https://attack.mitre.org/techniques/T1566/",
                "subtechnique": [
                  {
                    "id": "T1566.001",
                    "name": "Spearphishing Attachment",
                    "reference": "https://attack.mitre.org/techniques/T1566/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            },
            "technique": [
              {
                "id": "T1105",
                "name": "Ingress Tool Transfer",
                "reference": "https://attack.mitre.org/techniques/T1105/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "7377de22-6936-4dd2-bd0b-ed2be369c2a6",
        "rule_id": "dca6b4b0-ae70-44eb-bb7a-ce6db502ee78",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:59.183Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:35.952Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and  \n  process.parent.name : (\"explorer.exe\", \"winrar.exe\", \"7zFM.exe\", \"Bandizip.exe\") and\n  (\n    process.args : \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Microsoft\\\\Windows\\\\INetCache\\\\IE\\\\*\" or\n    process.executable : (\n      \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Microsoft\\\\Windows\\\\INetCache\\\\IE\\\\*\",\n      \"\\\\Device\\\\HarddiskVolume?\\\\Users\\\\*\\\\AppData\\\\Local\\\\Microsoft\\\\Windows\\\\INetCache\\\\IE\\\\*\"\n    )\n  )",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "PowerShell Script with Veeam Credential Access Capabilities",
        "description": "Identifies PowerShell scripts that can access and decrypt Veeam credentials stored in MSSQL databases. Attackers can use Veeam Credentials to target backups as part of destructive operations such as Ransomware attacks.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 103,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Data Source: PowerShell Logs"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://forums.veeam.com/veeam-backup-replication-f2/recover-esxi-password-in-veeam-t34630.html",
          "https://www.crowdstrike.com/blog/anatomy-of-alpha-spider-ransomware/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1003",
                "name": "OS Credential Dumping",
                "reference": "https://attack.mitre.org/techniques/T1003/"
              },
              {
                "id": "T1555",
                "name": "Credentials from Password Stores",
                "reference": "https://attack.mitre.org/techniques/T1555/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'PowerShell Script Block Logging' logging policy must be enabled.\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nAdministrative Templates >\nWindows PowerShell >\nTurn on PowerShell Script Block Logging (Enable)\n```\n\nSteps to implement the logging policy via registry:\n\n```\nreg add \"hklm\\SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\ScriptBlockLogging\" /v EnableScriptBlockLogging /t REG_DWORD /d 1\n```\n",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "powershell.file.script_block_text",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "705a301f-056c-45b8-bd3e-403f0ad9f85f",
        "rule_id": "5c602cba-ae00-4488-845d-24de2b6d8055",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:59.186Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:27.781Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-windows.powershell*"
        ],
        "filters": [],
        "query": "event.category:process and host.os.type:windows and\n  powershell.file.script_block_text : (\n    (\n      \"[dbo].[Credentials]\" and\n      (\"Veeam\" or \"VeeamBackup\")\n    ) or\n    \"ProtectedStorage]::GetLocalString\"\n  )",
        "language": "kuery"
      },
      {
        "name": "FirstTime Seen Account Performing DCSync",
        "description": "This rule identifies when a User Account starts the Active Directory Replication Process for the first time. Attackers can use the DCSync technique to get credential information of individual accounts or the entire domain, thus compromising the entire domain.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating FirstTime Seen Account Performing DCSync\n\nActive Directory replication is the process by which the changes that originate on one domain controller are automatically transferred to other domain controllers that store the same data.\n\nActive Directory data consists of objects that have properties, or attributes. Each object is an instance of an object class, and object classes and their respective attributes are defined in the Active Directory schema. Objects are defined by the values of their attributes, and changes to attribute values must be transferred from the domain controller on which they occur to every other domain controller that stores a replica of an affected object.\n\nAdversaries can use the DCSync technique that uses Windows Domain Controller's API to simulate the replication process from a remote domain controller, compromising major credential material such as the Kerberos krbtgt keys that are used legitimately for creating tickets, but also for forging tickets by attackers. This attack requires some extended privileges to succeed (DS-Replication-Get-Changes and DS-Replication-Get-Changes-All), which are granted by default to members of the Administrators, Domain Admins, Enterprise Admins, and Domain Controllers groups. Privileged accounts can be abused to grant controlled objects the right to DCsync/Replicate.\n\nMore details can be found on [Threat Hunter Playbook](https://threathunterplaybook.com/library/windows/active_directory_replication.html?highlight=dcsync#directory-replication-services-auditing) and [The Hacker Recipes](https://www.thehacker.recipes/ad/movement/credentials/dumping/dcsync).\n\nThis rule monitors for when a Windows Event ID 4662 (Operation was performed on an Active Directory object) with the access mask 0x100 (Control Access) and properties that contain at least one of the following or their equivalent Schema-Id-GUID (DS-Replication-Get-Changes, DS-Replication-Get-Changes-All, DS-Replication-Get-Changes-In-Filtered-Set) is seen in the environment for the first time in the last 15 days.\n\n#### Possible investigation steps\n\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account and system owners and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Correlate security events 4662 and 4624 (Logon Type 3) by their Logon ID (`winlog.logon.id`) on the Domain Controller (DC) that received the replication request. This will tell you where the AD replication request came from, and if it came from another DC or not.\n- Scope which credentials were compromised (for example, whether all accounts were replicated or specific ones).\n\n### False positive analysis\n\n- Administrators may use custom accounts on Azure AD Connect; investigate if this is part of a new Azure AD account setup, and ensure it is properly secured. If the activity was expected and there is no other suspicious activity involving the host or user, the analyst can dismiss the alert.\n- Although replicating Active Directory (AD) data to non-Domain Controllers is not a common practice and is generally not recommended from a security perspective, some software vendors may require it for their products to function correctly. Investigate if this is part of a new product setup, and ensure it is properly secured. If the activity was expected and there is no other suspicious activity involving the host or user, the analyst can dismiss the alert.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- If the entire domain or the `krbtgt` user was compromised:\n  - Activate your incident response plan for total Active Directory compromise which should include, but not be limited to, a password reset (twice) of the `krbtgt` user.\n- Investigate how the attacker escalated privileges and identify systems they used to conduct lateral movement. Use this information to determine ways the attacker could regain access to the environment.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 113,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Tactic: Privilege Escalation",
          "Use Case: Active Directory Monitoring",
          "Data Source: Active Directory",
          "Resources: Investigation Guide",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://threathunterplaybook.com/notebooks/windows/06_credential_access/WIN-180815210510.html",
          "https://threathunterplaybook.com/library/windows/active_directory_replication.html?highlight=dcsync#directory-replication-services-auditing",
          "https://github.com/SigmaHQ/sigma/blob/master/rules/windows/builtin/security/win_ad_replication_non_machine_account.yml",
          "https://github.com/atc-project/atomic-threat-coverage/blob/master/Atomic_Threat_Coverage/Logging_Policies/LP_0027_windows_audit_directory_service_access.md",
          "https://attack.stealthbits.com/privilege-escalation-using-mimikatz-dcsync",
          "https://www.thehacker.recipes/ad/movement/credentials/dumping/dcsync"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1003",
                "name": "OS Credential Dumping",
                "reference": "https://attack.mitre.org/techniques/T1003/",
                "subtechnique": [
                  {
                    "id": "T1003.006",
                    "name": "DCSync",
                    "reference": "https://attack.mitre.org/techniques/T1003/006/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1078",
                "name": "Valid Accounts",
                "reference": "https://attack.mitre.org/techniques/T1078/",
                "subtechnique": [
                  {
                    "id": "T1078.002",
                    "name": "Domain Accounts",
                    "reference": "https://attack.mitre.org/techniques/T1078/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'Audit Directory Service Access' logging policy must be configured for (Success, Failure).\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nPolicies >\nWindows Settings >\nSecurity Settings >\nAdvanced Audit Policies Configuration >\nAudit Policies >\nDS Access >\nAudit Directory Service Access (Success,Failure)\n```\n",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.code",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.event_data.Properties",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "winlog.event_data.SubjectUserName",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "ab0af67c-7c00-4d11-ab13-80e85458c15c",
        "rule_id": "5c6f4c58-b381-452a-8976-f1b1c6aa0def",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:59.190Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:27.785Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "event.action:(\"Directory Service Access\" or \"object-operation-performed\") and event.code:\"4662\" and\n winlog.event_data.Properties:(*DS-Replication-Get-Changes* or *DS-Replication-Get-Changes-All* or\n                               *DS-Replication-Get-Changes-In-Filtered-Set* or *1131f6ad-9c07-11d1-f79f-00c04fc2dcd2* or\n                               *1131f6aa-9c07-11d1-f79f-00c04fc2dcd2* or *89e95b76-444d-4c62-991a-0facbeda640c*) and\n not winlog.event_data.SubjectUserName:(*$ or MSOL_*)",
        "new_terms_fields": [
          "winlog.event_data.SubjectUserName"
        ],
        "history_window_start": "now-15d",
        "index": [
          "winlogbeat-*",
          "logs-system.*",
          "logs-windows.*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Potential File Download via a Headless Browser",
        "description": "Identifies the use of a browser to download a file from a remote URL and from a suspicious parent process. Adversaries may use browsers to avoid ingress tool transfer restrictions.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Potential File Download via a Headless Browser\n\n- Investigate the process execution chain (parent process tree).\n- Investigate the process network and file events.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 203,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Command and Control",
          "Resources: Investigation Guide",
          "Data Source: Windows",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: SentinelOne",
          "Data Source: Sysmon",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://lolbas-project.github.io/lolbas/Binaries/Msedge/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            },
            "technique": [
              {
                "id": "T1105",
                "name": "Ingress Tool Transfer",
                "reference": "https://attack.mitre.org/techniques/T1105/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "83656699-3c92-4dbe-b2b0-cbe78347a389",
        "rule_id": "5f2f463e-6997-478c-8405-fb41cc283281",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:59.251Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:27.825Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n process.name : (\"chrome.exe\", \"msedge.exe\", \"brave.exe\", \"browser.exe\", \"dragon.exe\", \"vivaldi.exe\") and\n  (process.args : \"--headless*\" or process.args : \"data:text/html;base64,*\") and\n  process.parent.name :\n     (\"cmd.exe\", \"powershell.exe\", \"wscript.exe\", \"cscript.exe\", \"mshta.exe\", \"conhost.exe\", \"msiexec.exe\",\n      \"explorer.exe\", \"rundll32.exe\", \"winword.exe\", \"excel.exe\", \"onenote.exe\", \"hh.exe\", \"powerpnt.exe\", \"forfiles.exe\",\n      \"pcalua.exe\", \"wmiprvse.exe\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "PowerShell Suspicious Discovery Related Windows API Functions",
        "description": "This rule detects the use of discovery-related Windows API functions in PowerShell Scripts. Attackers can use these functions to perform various situational awareness related activities, like enumerating users, shares, sessions, domain trusts, groups, etc.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating PowerShell Suspicious Discovery Related Windows API Functions\n\nPowerShell is one of the main tools system administrators use for automation, report routines, and other tasks. This makes it available for use in various environments, and creates an attractive way for attackers to execute code.\n\nAttackers can use PowerShell to interact with the Win32 API to bypass command line based detections, using libraries like PSReflect or Get-ProcAddress Cmdlet.\n\n#### Possible investigation steps\n\n- Examine the script content that triggered the detection; look for suspicious DLL imports, collection or exfiltration capabilities, suspicious functions, encoded or compressed data, and other potentially malicious characteristics.\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Examine file or network events from the involved PowerShell process for suspicious behavior.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Evaluate whether the user needs to use PowerShell to complete tasks.\n- Check for additional PowerShell and command-line logs that indicate that imported functions were run.\n\n### False positive analysis\n\n- Discovery activities themselves are not inherently malicious if occurring in isolation, as long as the script does not contain other capabilities, and there are no other alerts related to the user or host; such alerts can be dismissed. However, analysts should keep in mind that this is not a common way of getting information, making it suspicious.\n\n### Related rules\n\n- PowerShell PSReflect Script - 56f2e9b5-4803-4e44-a0a4-a52dc79d57fe\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Restrict PowerShell usage outside of IT and engineering business units using GPOs, AppLocker, Intune, or similar software.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 316,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Tactic: Collection",
          "Tactic: Execution",
          "Resources: Investigation Guide",
          "Data Source: PowerShell Logs"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Legitimate PowerShell scripts that make use of these functions."
        ],
        "references": [
          "https://github.com/BC-SECURITY/Empire/blob/9259e5106986847d2bb770c4289c0c0f1adf2344/data/module_source/situational_awareness/network/powerview.ps1#L21413",
          "https://github.com/atc-project/atc-data/blob/master/docs/Logging_Policies/LP_0109_windows_powershell_script_block_log.md"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1069",
                "name": "Permission Groups Discovery",
                "reference": "https://attack.mitre.org/techniques/T1069/",
                "subtechnique": [
                  {
                    "id": "T1069.001",
                    "name": "Local Groups",
                    "reference": "https://attack.mitre.org/techniques/T1069/001/"
                  }
                ]
              },
              {
                "id": "T1087",
                "name": "Account Discovery",
                "reference": "https://attack.mitre.org/techniques/T1087/",
                "subtechnique": [
                  {
                    "id": "T1087.001",
                    "name": "Local Account",
                    "reference": "https://attack.mitre.org/techniques/T1087/001/"
                  }
                ]
              },
              {
                "id": "T1482",
                "name": "Domain Trust Discovery",
                "reference": "https://attack.mitre.org/techniques/T1482/"
              },
              {
                "id": "T1135",
                "name": "Network Share Discovery",
                "reference": "https://attack.mitre.org/techniques/T1135/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              },
              {
                "id": "T1106",
                "name": "Native API",
                "reference": "https://attack.mitre.org/techniques/T1106/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0009",
              "name": "Collection",
              "reference": "https://attack.mitre.org/tactics/TA0009/"
            },
            "technique": [
              {
                "id": "T1039",
                "name": "Data from Network Shared Drive",
                "reference": "https://attack.mitre.org/techniques/T1039/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'PowerShell Script Block Logging' logging policy must be enabled.\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nAdministrative Templates >\nWindows PowerShell >\nTurn on PowerShell Script Block Logging (Enable)\n```\n\nSteps to implement the logging policy via registry:\n\n```\nreg add \"hklm\\SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\ScriptBlockLogging\" /v EnableScriptBlockLogging /t REG_DWORD /d 1\n```\n",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "powershell.file.script_block_text",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "a2fea4dd-062a-497a-86bd-11516c02fdc7",
        "rule_id": "61ac3638-40a3-44b2-855a-985636ca985e",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:59.255Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:27.840Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-windows.powershell*"
        ],
        "filters": [
          {
            "meta": {
              "negate": true
            },
            "query": {
              "wildcard": {
                "file.path": {
                  "case_insensitive": true,
                  "value": "?:\\\\ProgramData\\\\Microsoft\\\\Windows Defender Advanced Threat Protection\\\\DataCollection\\\\*"
                }
              }
            }
          }
        ],
        "query": "event.category:process and host.os.type:windows and\n  powershell.file.script_block_text : (\n    NetShareEnum or\n    NetWkstaUserEnum or\n    NetSessionEnum or\n    NetLocalGroupEnum or\n    NetLocalGroupGetMembers or\n    DsGetSiteName or\n    DsEnumerateDomainTrusts or\n    WTSEnumerateSessionsEx or\n    WTSQuerySessionInformation or\n    LsaGetLogonSessionData or\n    QueryServiceObjectSecurity or\n    GetComputerNameEx or\n    NetWkstaGetInfo or\n    GetUserNameEx or\n    NetUserEnum or\n    NetUserGetInfo or\n    NetGroupEnum or\n    NetGroupGetInfo or\n    NetGroupGetUsers or\n    NetWkstaTransportEnum or\n    NetServerGetInfo or\n    LsaEnumerateTrustedDomains  or\n    NetScheduleJobEnum or\n    NetUserModalsGet\n  ) and\n  not powershell.file.script_block_text : (\n    (\"DsGetSiteName\" and (\"DiscoverWindowsComputerProperties.ps1\" and \"param($SourceType, $SourceId, $ManagedEntityId, $ComputerIdentity)\")) or\n    (\"# Copyright: (c) 2018, Ansible Project\" and \"#Requires -Module Ansible.ModuleUtils.AddType\" and \"#AnsibleRequires -CSharpUtil Ansible.Basic\") or\n    (\"Ansible.Windows.Setup\" and \"Ansible.Windows.Setup\" and \"NativeMethods.NetWkstaGetInfo(null, 100, out netBuffer);\")\n  )",
        "language": "kuery"
      },
      {
        "name": "Unsigned DLL loaded by DNS Service",
        "description": "Identifies unusual DLLs loaded by the DNS Server process, potentially indicating the abuse of the ServerLevelPluginDll functionality. This can lead to privilege escalation and remote code execution with SYSTEM privileges.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 103,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://cube0x0.github.io/Pocing-Beyond-DA/",
          "https://adsecurity.org/?p=4064",
          "https://github.com/gtworek/PSBits/tree/master/ServerLevelPluginDll"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1068",
                "name": "Exploitation for Privilege Escalation",
                "reference": "https://attack.mitre.org/techniques/T1068/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "dll.code_signature.trusted",
            "type": "boolean",
            "ecs": true
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.code_signature.status",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "ca754f30-bf89-429f-b00b-4038f8e565f8",
        "rule_id": "5d676480-9655-4507-adc6-4eec311efff8",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:17:59.258Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:27.811Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "any where host.os.type == \"windows\" and event.category : (\"library\", \"process\") and\n  event.type : (\"start\", \"change\") and event.action : (\"load\", \"Image loaded*\") and\n  process.executable : \"?:\\\\windows\\\\system32\\\\dns.exe\" and \n  not ?dll.code_signature.trusted == true and\n  not file.code_signature.status == \"Valid\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.library-*",
          "logs-windows.sysmon_operational-*",
          "winlogbeat-*"
        ],
        "filters": []
      },
      {
        "name": "Account Configured with Never-Expiring Password",
        "description": "Detects the creation and modification of an account with the \"Don't Expire Password\" option Enabled. Attackers can abuse this misconfiguration to persist in the domain and maintain long-term access using compromised accounts with this property.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Account Configured with Never-Expiring Password\n\nActive Directory provides a setting that prevents users' passwords from expiring. Enabling this setting is bad practice and can expose environments to vulnerabilities that weaken security posture, especially when these accounts are privileged.\n\nThe setting is usually configured so a user account can act as a service account. Attackers can abuse these accounts to persist in the domain and maintain long-term access using compromised accounts with a never-expiring password set.\n\n#### Possible investigation steps\n\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/source host during the past 48 hours.\n- Inspect the account for suspicious or abnormal behaviors in the alert timeframe.\n\n### False positive analysis\n\n- This activity should not happen legitimately. The security team should address any potential benign true positive (B-TP), as this configuration can put the user and the domain at risk.\n- Using user accounts as service accounts is a bad security practice and should not be allowed in the domain. The security team should map and monitor potential benign true positives (B-TPs), especially if the account is privileged. For cases in which user accounts cannot be avoided, Microsoft provides the Group Managed Service Accounts (gMSA) feature, which ensures that the account password is robust and changed regularly and automatically.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Review the privileges assigned to the user to ensure that the least privilege principle is being followed.\n- Reset the password of the account and update its password settings.\n- Search for other occurrences on the domain.\n    - Using the [Active Directory PowerShell module](https://docs.microsoft.com/en-us/powershell/module/activedirectory/get-aduser):\n        - `get-aduser -filter { passwordNeverExpires -eq $true  -and enabled -eq $true } | ft`\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 211,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Data Source: Active Directory",
          "Resources: Investigation Guide",
          "Use Case: Active Directory Monitoring",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "User accounts can be used as service accounts and have their password set never to expire. This is a bad security practice that exposes the account to Credential Access attacks. For cases in which user accounts cannot be avoided, Microsoft provides the Group Managed Service Accounts (gMSA) feature, which ensures that the account password is robust and changed regularly and automatically."
        ],
        "references": [
          "https://www.cert.ssi.gouv.fr/uploads/guide-ad.html#dont_expire",
          "http://web.archive.org/web/20230329171952/https://blog.menasec.net/2019/02/threat-hunting-26-persistent-password.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1098",
                "name": "Account Manipulation",
                "reference": "https://attack.mitre.org/techniques/T1098/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.code",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "message",
            "type": "match_only_text",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.api",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "67ca2f58-59bd-437f-b8c7-5d248f10a388",
        "rule_id": "62a70f6f-3c37-43df-a556-f64fa475fba2",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:02.282Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:27.856Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-system.*",
          "logs-windows.*"
        ],
        "filters": [],
        "query": "event.action:\"modified-user-account\" and winlog.api:\"wineventlog\" and event.code:\"4738\" and\n  message:\"'Don't Expire Password' - Enabled\" and not user.id:\"S-1-5-18\"",
        "language": "kuery"
      },
      {
        "name": "WebServer Access Logs Deleted",
        "description": "Identifies the deletion of WebServer access logs. This may indicate an attempt to evade detection or destroy forensic evidence on a system.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 207,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "OS: Windows",
          "OS: macOS",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1070",
                "name": "Indicator Removal",
                "reference": "https://attack.mitre.org/techniques/T1070/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "89d58582-84ad-4e8b-b8d9-acd1e8ca44c5",
        "rule_id": "665e7a4f-c58e-4fc6-bc83-87a7572670ac",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:02.292Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:29.712Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where event.type == \"deletion\" and\n  file.path : (\"C:\\\\inetpub\\\\logs\\\\LogFiles\\\\*.log\",\n               \"/var/log/apache*/access.log\",\n               \"/etc/httpd/logs/access_log\",\n               \"/var/log/httpd/access_log\",\n               \"/var/www/*/logs/access.log\")",
        "language": "eql",
        "index": [
          "auditbeat-*",
          "winlogbeat-*",
          "logs-endpoint.events.*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": []
      },
      {
        "name": "Modification of the msPKIAccountCredentials",
        "description": "Identify the modification of the msPKIAccountCredentials attribute in an Active Directory User Object. Attackers can abuse the credentials roaming feature to overwrite an arbitrary file for privilege escalation. ms-PKI-AccountCredentials contains binary large objects (BLOBs) of encrypted credential objects from the credential manager store, private keys, certificates, and certificate requests.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 113,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Data Source: Active Directory",
          "Tactic: Privilege Escalation",
          "Use Case: Active Directory Monitoring",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.mandiant.com/resources/blog/apt29-windows-credential-roaming",
          "https://social.technet.microsoft.com/wiki/contents/articles/11483.windows-credential-roaming.aspx",
          "https://learn.microsoft.com/en-us/windows/security/threat-protection/auditing/event-5136"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1068",
                "name": "Exploitation for Privilege Escalation",
                "reference": "https://attack.mitre.org/techniques/T1068/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'Audit Directory Service Changes' logging policy must be configured for (Success, Failure).\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nPolicies >\nWindows Settings >\nSecurity Settings >\nAdvanced Audit Policies Configuration >\nAudit Policies >\nDS Access >\nAudit Directory Service Changes (Success,Failure)\n```\n",
        "related_integrations": [
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.code",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.event_data.AttributeLDAPDisplayName",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "winlog.event_data.OperationType",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "winlog.event_data.SubjectUserSid",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "c87cca81-4355-42b6-960b-28588485b335",
        "rule_id": "670b3b5a-35e5-42db-bd36-6c5b9b4b7313",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:02.295Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:29.717Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-system.*",
          "logs-windows.*"
        ],
        "filters": [],
        "query": "event.action:(\"Directory Service Changes\" or \"directory-service-object-modified\") and event.code:\"5136\" and\n  winlog.event_data.AttributeLDAPDisplayName:\"msPKIAccountCredentials\" and winlog.event_data.OperationType:\"%%14674\" and\n  not winlog.event_data.SubjectUserSid : \"S-1-5-18\"",
        "language": "kuery"
      },
      {
        "name": "Persistence via TelemetryController Scheduled Task Hijack",
        "description": "Detects the successful hijack of Microsoft Compatibility Appraiser scheduled task to establish persistence with an integrity level of system.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 312,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Tactic: Privilege Escalation",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.trustedsec.com/blog/abusing-windows-telemetry-for-persistence"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1053",
                "name": "Scheduled Task/Job",
                "reference": "https://attack.mitre.org/techniques/T1053/",
                "subtechnique": [
                  {
                    "id": "T1053.005",
                    "name": "Scheduled Task",
                    "reference": "https://attack.mitre.org/techniques/T1053/005/"
                  }
                ]
              },
              {
                "id": "T1574",
                "name": "Hijack Execution Flow",
                "reference": "https://attack.mitre.org/techniques/T1574/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1053",
                "name": "Scheduled Task/Job",
                "reference": "https://attack.mitre.org/techniques/T1053/",
                "subtechnique": [
                  {
                    "id": "T1053.005",
                    "name": "Scheduled Task",
                    "reference": "https://attack.mitre.org/techniques/T1053/005/"
                  }
                ]
              },
              {
                "id": "T1574",
                "name": "Hijack Execution Flow",
                "reference": "https://attack.mitre.org/techniques/T1574/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "46b35b6d-7e04-42b1-a77a-46355d1a46e4",
        "rule_id": "68921d85-d0dc-48b3-865f-43291ca2c4f2",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:02.298Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:29.727Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.parent.name : \"CompatTelRunner.exe\" and process.args : \"-cv*\" and\n  not process.name : (\"conhost.exe\",\n                      \"DeviceCensus.exe\",\n                      \"CompatTelRunner.exe\",\n                      \"DismHost.exe\",\n                      \"rundll32.exe\",\n                      \"powershell.exe\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Modification of Boot Configuration",
        "description": "Identifies use of bcdedit.exe to delete boot configuration data. This tactic is sometimes used as by malware or an attacker as a destructive technique.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Modification of Boot Configuration\n\nBoot entry parameters, or boot parameters, are optional, system-specific settings that represent configuration options. These are stored in a boot configuration data (BCD) store, and administrators can use utilities like `bcdedit.exe` to configure these.\n\nThis rule identifies the usage of `bcdedit.exe` to:\n\n- Disable Windows Error Recovery (recoveryenabled).\n- Ignore errors if there is a failed boot, failed shutdown, or failed checkpoint (bootstatuspolicy ignoreallfailures).\n\nThese are common steps in destructive attacks by adversaries leveraging ransomware.\n\n#### Possible investigation steps\n\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n- Check if any files on the host machine have been encrypted.\n\n### False positive analysis\n\n- The usage of these options is not inherently malicious. Administrators can modify these configurations to force a machine to boot for troubleshooting or data recovery purposes.\n\n### Related rules\n\n- Deleting Backup Catalogs with Wbadmin - 581add16-df76-42bb-af8e-c979bfb39a59\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Consider isolating the involved host to prevent destructive behavior, which is commonly associated with this activity.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- If any other destructive action was identified on the host, it is recommended to prioritize the investigation and look for ransomware preparation and execution activities.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 311,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Impact",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0040",
              "name": "Impact",
              "reference": "https://attack.mitre.org/tactics/TA0040/"
            },
            "technique": [
              {
                "id": "T1490",
                "name": "Inhibit System Recovery",
                "reference": "https://attack.mitre.org/techniques/T1490/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "bb4ced13-9abf-40df-ab28-8339af22a0ee",
        "rule_id": "69c251fb-a5d6-4035-b5ec-40438bd829ff",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:02.301Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:29.749Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (process.name : \"bcdedit.exe\" or ?process.pe.original_file_name == \"bcdedit.exe\") and\n    (\n      (process.args : \"/set\" and process.args : \"bootstatuspolicy\" and process.args : \"ignoreallfailures\") or\n      (process.args : \"no\" and process.args : \"recoveryenabled\")\n    )",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Exporting Exchange Mailbox via PowerShell",
        "description": "Identifies the use of the Exchange PowerShell cmdlet, New-MailBoxExportRequest, to export the contents of a primary mailbox or archive to a .pst file. Adversaries may target user email to collect sensitive information.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Exporting Exchange Mailbox via PowerShell\n\nEmail mailboxes and their information can be valuable assets for attackers. Company mailboxes often contain sensitive information such as login credentials, intellectual property, financial data, and personal information, making them high-value targets for malicious actors.\n\nThe `New-MailBoxExportRequest` cmdlet is used to begin the process of exporting contents of a primary mailbox or archive to a .pst file. Note that this is done on a per-mailbox basis and this cmdlet is available only in on-premises Exchange.\n\nAttackers can abuse this functionality in preparation for exfiltrating contents, which is likely to contain sensitive and strategic data.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate the export operation:\n  - Identify the user account that performed the action and whether it should perform this kind of action.\n  - Contact the account owner and confirm whether they are aware of this activity.\n  - Check if this operation was approved and performed according to the organization's change management policy.\n  - Retrieve the operation status and use the `Get-MailboxExportRequest` cmdlet to review previous requests.\n  - By default, no group in Exchange has the privilege to import or export mailboxes. Investigate administrators that assigned the \"Mailbox Import Export\" privilege for abnormal activity.\n- Investigate if there is a significant quantity of export requests in the alert timeframe. This operation is done on a per-mailbox basis and can be part of a mass export.\n- If the operation was completed successfully:\n  - Check if the file is on the path specified in the command.\n  - Investigate if the file was compressed, archived, or retrieved by the attacker for exfiltration.\n\n### False positive analysis\n\n- This mechanism can be used legitimately. Analysts can dismiss the alert if the administrator is aware of the activity and it is done with proper approval.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- If the involved host is not the Exchange server, isolate the host to prevent further post-compromise behavior.\n- Use the `Remove-MailboxExportRequest` cmdlet to remove fully or partially completed export requests.\n- Prioritize cases that involve personally identifiable information (PII) or other classified data.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Review the privileges of users with the \"Mailbox Import Export\" privilege to ensure that the least privilege principle is being followed.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 417,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Collection",
          "Tactic: Execution",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: SentinelOne",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: System",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Legitimate exchange system administration activity."
        ],
        "references": [
          "https://www.volexity.com/blog/2020/12/14/dark-halo-leverages-solarwinds-compromise-to-breach-organizations/",
          "https://docs.microsoft.com/en-us/powershell/module/exchange/new-mailboxexportrequest?view=exchange-ps",
          "https://www.elastic.co/security-labs/siestagraph-new-implant-uncovered-in-asean-member-foreign-ministry"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0009",
              "name": "Collection",
              "reference": "https://attack.mitre.org/tactics/TA0009/"
            },
            "technique": [
              {
                "id": "T1005",
                "name": "Data from Local System",
                "reference": "https://attack.mitre.org/techniques/T1005/"
              },
              {
                "id": "T1114",
                "name": "Email Collection",
                "reference": "https://attack.mitre.org/techniques/T1114/",
                "subtechnique": [
                  {
                    "id": "T1114.002",
                    "name": "Remote Email Collection",
                    "reference": "https://attack.mitre.org/techniques/T1114/002/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "352280dc-14b7-499e-912b-8a9eb76c6d28",
        "rule_id": "6aace640-e631-4870-ba8e-5fdda09325db",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:02.304Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:29.770Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.name: (\"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\") and\n  process.command_line : (\"*MailboxExportRequest*\", \"*-Mailbox*-ContentFilter*\")",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "winlogbeat-*",
          "logs-windows.*",
          "endgame-*",
          "logs-system.security*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-m365_defender.event-*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Unusual Process For a Windows Host",
        "description": "Identifies rare processes that do not usually run on individual hosts, which can indicate execution of unauthorized services, malware, or persistence mechanisms. Processes are considered rare when they only run occasionally as compared with other processes running on the host.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n###  Investigating Unusual Process For a Windows Host\n\nSearching for abnormal Windows processes is a good methodology to find potentially malicious activity within a network. Understanding what is commonly run within an environment and developing baselines for legitimate activity can help uncover potential malware and suspicious behaviors.\n\nThis rule uses a machine learning job to detect a Windows process that is rare and unusual for an individual Windows host in your environment.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n  - If the parent process is a legitimate system utility or service, this could be related to software updates or system management. If the parent process is something user-facing like an Office application, this process could be more suspicious.\n  - Investigate the process metadata â€” such as the digital signature, directory, etc. â€” to obtain more context that can indicate whether the executable is associated with an expected software vendor or package.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Consider the user as identified by the `user.name` field. Is this program part of an expected workflow for the user who ran this program on this host?\n- Validate the activity is not related to planned patches, updates, network administrator activity, or legitimate software installations.\n- Validate if the activity has a consistent cadence (for example, if it runs monthly or quarterly), as it could be part of a monthly or quarterly business process.\n- Examine the arguments and working directory of the process. These may provide indications as to the source of the program or the nature of the tasks it is performing.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the process executable using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Retrieve Service Unisgned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n\n### False Positive Analysis\n\n- If this activity is related to new benign software installation activity, consider adding exceptions â€” preferably with a combination of user and command line conditions.\n- Try to understand the context of the execution by thinking about the user, machine, or business purpose. A small number of endpoints, such as servers with unique software, might appear unusual but satisfy a specific business need.\n\n### Related Rules\n\n- Unusual Process For a Windows Host - 6d448b96-c922-4adb-b51c-b767f1ea5b76\n- Unusual Windows Path Activity - 445a342e-03fb-42d0-8656-0367eb2dead5\n- Unusual Windows Process Calling the Metadata Service - abae61a8-c560-4dbd-acca-1e1438bff36b\n\n### Response and Remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 211,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Rule Type: ML",
          "Rule Type: Machine Learning",
          "Tactic: Persistence",
          "Resources: Investigation Guide"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "15m",
        "from": "now-2700s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "A newly installed program or one that runs rarely as part of a monthly or quarterly workflow could trigger this alert."
        ],
        "references": [
          "https://www.elastic.co/guide/en/security/current/prebuilt-ml-jobs.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1543",
                "name": "Create or Modify System Process",
                "reference": "https://attack.mitre.org/techniques/T1543/",
                "subtechnique": [
                  {
                    "id": "T1543.003",
                    "name": "Windows Service",
                    "reference": "https://attack.mitre.org/techniques/T1543/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires the installation of associated Machine Learning jobs, as well as data coming in from one of the following integrations:\n- Elastic Defend\n- Windows\n\n### Anomaly Detection Setup\n\nOnce the rule is enabled, the associated Machine Learning job will start automatically. You can view the Machine Learning job linked under the \"Definition\" panel of the detection rule. If the job does not start due to an error, the issue must be resolved for the job to commence successfully. For more details on setting up anomaly detection jobs, refer to the [helper guide](https://www.elastic.co/guide/en/kibana/current/xpack-ml-anomalies.html).\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration to your system:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n### Windows Integration Setup\nThe Windows integration allows you to monitor the Windows OS, services, applications, and more.\n\n#### The following steps should be executed in order to add the Elastic Agent System integration \"windows\" to your system:\n- Go to the Kibana home page and click â€œAdd integrationsâ€.\n- In the query bar, search for â€œWindowsâ€ and select the integration to see more details about it.\n- Click â€œAdd Windowsâ€.\n- Configure the integration name and optionally add a description.\n- Review optional and advanced settings accordingly.\n- Add the newly installed â€œwindowsâ€ to an existing or a new agent policy, and deploy the agent on your system from which windows log files are desirable.\n- Click â€œSave and Continueâ€.\n- For more details on the integration refer to the [helper guide](https://docs.elastic.co/integrations/windows).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [],
        "id": "1e6d744f-48fc-4c60-89d6-951eb2a57be5",
        "rule_id": "6d448b96-c922-4adb-b51c-b767f1ea5b76",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:02.306Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:29.786Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "machine_learning",
        "anomaly_threshold": 50,
        "machine_learning_job_id": [
          "v3_rare_process_by_host_windows"
        ]
      },
      {
        "name": "First Time Seen Commonly Abused Remote Access Tool Execution",
        "description": "Adversaries may install legitimate remote access tools (RAT) to compromised endpoints for further command-and-control (C2). Adversaries can rely on installed RATs for persistence, execution of native commands and more. This rule detects when a process is started whose name or code signature resembles commonly abused RATs. This is a New Terms rule type indicating the host has not seen this RAT process started before within the last 30 days.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating First Time Seen Commonly Abused Remote Access Tool Execution\n\nRemote access software is a class of tools commonly used by IT departments to provide support by connecting securely to users' computers. Remote access is an ever-growing market where new companies constantly offer new ways of quickly accessing remote systems.\n\nAt the same pace as IT departments adopt these tools, the attackers also adopt them as part of their workflow to connect into an interactive session, maintain access with legitimate software as a persistence mechanism, drop malicious software, etc.\n\nThis rule detects when a remote access tool is seen in the environment for the first time in the last 15 days, enabling analysts to investigate and enforce the correct usage of such tools.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Check if the execution of the remote access tool is approved by the organization's IT department.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Contact the account owner and confirm whether they are aware of this activity.\n  - If the tool is not approved for use in the organization, the employee could have been tricked into installing it and providing access to a malicious third party. Investigate whether this third party could be attempting to scam the end-user or gain access to the environment through social engineering.\n- Investigate any abnormal behavior by the subject process, such as network connections, registry or file modifications, and any spawned child processes.\n\n### False positive analysis\n\n- If an authorized support person or administrator used the tool to conduct legitimate support or remote access, consider reinforcing that only tooling approved by the IT policy should be used. The analyst can dismiss the alert if no other suspicious behavior is observed involving the host or users.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Run a full scan using the antimalware tool in place. This scan can reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- If an unauthorized third party did the access via social engineering, consider improvements to the security awareness program.\n- Enforce that only tooling approved by the IT policy should be used for remote access purposes and only by authorized staff.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 108,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Command and Control",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://thedfirreport.com/2023/04/03/malicious-iso-file-leads-to-domain-wide-ransomware/",
          "https://attack.mitre.org/techniques/T1219/",
          "https://github.com/redcanaryco/surveyor/blob/master/definitions/remote-admin.json"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            },
            "technique": [
              {
                "id": "T1219",
                "name": "Remote Access Software",
                "reference": "https://attack.mitre.org/techniques/T1219/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.code_signature.subject_name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name.caseless",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "e3df1c52-302a-4ce1-b903-496b3a5b93e4",
        "rule_id": "6e1a2cc4-d260-11ed-8829-f661ea17fbcc",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:02.309Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:29.790Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "host.os.type: \"windows\" and\n\n   event.category: \"process\" and event.type : \"start\" and\n\n    (\n        process.code_signature.subject_name : (\n            \"Action1 Corporation\" or\n            \"AeroAdmin LLC\" or\n            \"Ammyy LLC\" or\n            \"Atera Networks Ltd\" or\n            \"AWERAY PTE. LTD.\" or\n            \"BeamYourScreen GmbH\" or\n            \"Bomgar Corporation\" or\n            \"DUC FABULOUS CO.,LTD\" or\n            \"DOMOTZ INC.\" or\n            \"DWSNET OÃœ\" or\n            \"FleetDeck Inc\" or\n            \"GlavSoft LLC\" or\n            \"GlavSoft LLC.\" or\n            \"Hefei Pingbo Network Technology Co. Ltd\" or\n            \"IDrive, Inc.\" or\n            \"IMPERO SOLUTIONS LIMITED\" or\n            \"Instant Housecall\" or\n            \"ISL Online Ltd.\" or\n            \"LogMeIn, Inc.\" or\n            \"Monitoring Client\" or\n            \"MMSOFT Design Ltd.\" or\n            \"Nanosystems S.r.l.\" or\n            \"NetSupport Ltd\" or\n            \"NinjaRMM, LLC\" or\n            \"Parallels International GmbH\" or\n            \"philandro Software GmbH\" or\n            \"Pro Softnet Corporation\" or\n            \"RealVNC\" or\n            \"RealVNC Limited\" or\n            \"BreakingSecurity.net\" or\n            \"Remote Utilities LLC\" or\n            \"Rocket Software, Inc.\" or\n            \"SAFIB\" or\n            \"Servably, Inc.\" or\n            \"ShowMyPC INC\" or\n            \"Splashtop Inc.\" or\n            \"Superops Inc.\" or\n            \"TeamViewer\" or\n            \"TeamViewer GmbH\" or\n            \"TeamViewer Germany GmbH\" or\n            \"Techinline Limited\" or\n            \"uvnc bvba\" or\n            \"Yakhnovets Denis Aleksandrovich IP\" or\n            \"Zhou Huabing\"\n        ) or\n\n        process.name.caseless : (\n            AA_v*.exe or\n            \"AeroAdmin.exe\" or\n            \"AnyDesk.exe\" or\n            \"apc_Admin.exe\" or\n            \"apc_host.exe\" or\n            \"AteraAgent.exe\" or\n            aweray_remote*.exe or\n            \"AweSun.exe\" or\n            \"B4-Service.exe\" or\n            \"BASupSrvc.exe\" or\n            \"bomgar-scc.exe\" or\n            \"domotzagent.exe\" or\n            \"domotz-windows-x64-10.exe\" or\n            \"dwagsvc.exe\" or\n            \"DWRCC.exe\" or\n            \"ImperoClientSVC.exe\" or\n            \"ImperoServerSVC.exe\" or\n            \"ISLLight.exe\" or\n            \"ISLLightClient.exe\" or\n            fleetdeck_commander*.exe or\n            \"getscreen.exe\" or\n            \"LMIIgnition.exe\" or\n            \"LogMeIn.exe\" or\n            \"ManageEngine_Remote_Access_Plus.exe\" or\n            \"Mikogo-Service.exe\" or\n            \"NinjaRMMAgent.exe\" or\n            \"NinjaRMMAgenPatcher.exe\" or\n            \"ninjarmm-cli.exe\" or\n            \"r_server.exe\" or\n            \"radmin.exe\" or\n            \"radmin3.exe\" or\n            \"RCClient.exe\" or\n            \"RCService.exe\" or\n            \"RemoteDesktopManager.exe\" or\n            \"RemotePC.exe\" or\n            \"RemotePCDesktop.exe\" or\n            \"RemotePCService.exe\" or\n            \"rfusclient.exe\" or\n            \"ROMServer.exe\" or\n            \"ROMViewer.exe\" or\n            \"RPCSuite.exe\" or\n            \"rserver3.exe\" or\n            \"rustdesk.exe\" or\n            \"rutserv.exe\" or\n            \"rutview.exe\" or\n            \"saazapsc.exe\" or\n            ScreenConnect*.exe or\n            \"smpcview.exe\" or\n            \"spclink.exe\" or\n            \"Splashtop-streamer.exe\" or\n            \"SRService.exe\" or\n            \"strwinclt.exe\" or\n            \"Supremo.exe\" or\n            \"SupremoService.exe\" or\n            \"teamviewer.exe\" or\n            \"TiClientCore.exe\" or\n            \"TSClient.exe\" or\n            \"tvn.exe\" or\n            \"tvnserver.exe\" or\n            \"tvnviewer.exe\" or\n            UltraVNC*.exe or\n            UltraViewer*.exe or\n            \"vncserver.exe\" or\n            \"vncviewer.exe\" or\n            \"winvnc.exe\" or\n            \"winwvc.exe\" or\n            \"Zaservice.exe\" or\n            \"ZohoURS.exe\"\n        ) or\n        process.name : (\n            AA_v*.exe or\n            \"AeroAdmin.exe\" or\n            \"AnyDesk.exe\" or\n            \"apc_Admin.exe\" or\n            \"apc_host.exe\" or\n            \"AteraAgent.exe\" or\n            aweray_remote*.exe or\n            \"AweSun.exe\" or\n            \"B4-Service.exe\" or\n            \"BASupSrvc.exe\" or\n            \"bomgar-scc.exe\" or\n            \"domotzagent.exe\" or\n            \"domotz-windows-x64-10.exe\" or\n            \"dwagsvc.exe\" or\n            \"DWRCC.exe\" or\n            \"ImperoClientSVC.exe\" or\n            \"ImperoServerSVC.exe\" or\n            \"ISLLight.exe\" or\n            \"ISLLightClient.exe\" or\n            fleetdeck_commander*.exe or\n            \"getscreen.exe\" or\n            \"LMIIgnition.exe\" or\n            \"LogMeIn.exe\" or\n            \"ManageEngine_Remote_Access_Plus.exe\" or\n            \"Mikogo-Service.exe\" or\n            \"NinjaRMMAgent.exe\" or\n            \"NinjaRMMAgenPatcher.exe\" or\n            \"ninjarmm-cli.exe\" or\n            \"r_server.exe\" or\n            \"radmin.exe\" or\n            \"radmin3.exe\" or\n            \"RCClient.exe\" or\n            \"RCService.exe\" or\n            \"RemoteDesktopManager.exe\" or\n            \"RemotePC.exe\" or\n            \"RemotePCDesktop.exe\" or\n            \"RemotePCService.exe\" or\n            \"rfusclient.exe\" or\n            \"ROMServer.exe\" or\n            \"ROMViewer.exe\" or\n            \"RPCSuite.exe\" or\n            \"rserver3.exe\" or\n            \"rustdesk.exe\" or\n            \"rutserv.exe\" or\n            \"rutview.exe\" or\n            \"saazapsc.exe\" or\n            ScreenConnect*.exe or\n            \"smpcview.exe\" or\n            \"spclink.exe\" or\n            \"Splashtop-streamer.exe\" or\n            \"SRService.exe\" or\n            \"strwinclt.exe\" or\n            \"Supremo.exe\" or\n            \"SupremoService.exe\" or\n            \"teamviewer.exe\" or\n            \"TiClientCore.exe\" or\n            \"TSClient.exe\" or\n            \"tvn.exe\" or\n            \"tvnserver.exe\" or\n            \"tvnviewer.exe\" or\n            UltraVNC*.exe or\n            UltraViewer*.exe or\n            \"vncserver.exe\" or\n            \"vncviewer.exe\" or\n            \"winvnc.exe\" or\n            \"winwvc.exe\" or\n            \"Zaservice.exe\" or\n            \"ZohoURS.exe\"\n        )\n\t) and\n\n\tnot (process.pe.original_file_name : (\"G2M.exe\" or \"Updater.exe\" or \"powershell.exe\") and process.code_signature.subject_name : \"LogMeIn, Inc.\")",
        "new_terms_fields": [
          "host.id"
        ],
        "history_window_start": "now-15d",
        "index": [
          "logs-endpoint.events.process-*",
          "endgame-*",
          "winlogbeat-*",
          "logs-windows.*",
          "logs-system.security*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Anomalous Process For a Windows Population",
        "description": "Searches for rare processes running on multiple hosts in an entire fleet or network. This reduces the detection of false positives since automated maintenance processes usually only run occasionally on a single machine but are common to all or many hosts in a fleet.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n###  Investigating Anomalous Process For a Windows Population\n\nSearching for abnormal Windows processes is a good methodology to find potentially malicious activity within a network. Understanding what is commonly run within an environment and developing baselines for legitimate activity can help uncover potential malware and suspicious behaviors.\n\nThis rule uses a machine learning job to detect a Windows process that is rare and unusual for all of the monitored Windows hosts in your environment.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n  - If the parent process is a legitimate system utility or service, this could be related to software updates or system management. If the parent process is something user-facing like an Office application, this process could be more suspicious.\n  - Investigate the process metadata â€” such as the digital signature, directory, etc. â€” to obtain more context that can indicate whether the executable is associated with an expected software vendor or package.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Consider the user as identified by the `user.name` field. Is this program part of an expected workflow for the user who ran this program on this host?\n- Validate the activity is not related to planned patches, updates, network administrator activity, or legitimate software installations.\n- Validate if the activity has a consistent cadence (for example, if it runs monthly or quarterly), as it could be part of a monthly or quarterly business process.\n- Examine the arguments and working directory of the process. These may provide indications as to the source of the program or the nature of the tasks it is performing.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the process executable using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSyste' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Retrieve Service Unisgned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n\n### False Positive Analysis\n\n- If this activity is related to new benign software installation activity, consider adding exceptions â€” preferably with a combination of user and command line conditions.\n- Try to understand the context of the execution by thinking about the user, machine, or business purpose. A small number of endpoints, such as servers with unique software, might appear unusual but satisfy a specific business need.\n\n### Related Rules\n\n- Unusual Process For a Windows Host - 6d448b96-c922-4adb-b51c-b767f1ea5b76\n- Unusual Windows Path Activity - 445a342e-03fb-42d0-8656-0367eb2dead5\n- Unusual Windows Process Calling the Metadata Service - abae61a8-c560-4dbd-acca-1e1438bff36b\n\n### Response and Remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 208,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Rule Type: ML",
          "Rule Type: Machine Learning",
          "Tactic: Persistence",
          "Tactic: Execution"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "15m",
        "from": "now-2700s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "A newly installed program or one that runs rarely as part of a monthly or quarterly workflow could trigger this alert."
        ],
        "references": [
          "https://www.elastic.co/guide/en/security/current/prebuilt-ml-jobs.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1543",
                "name": "Create or Modify System Process",
                "reference": "https://attack.mitre.org/techniques/T1543/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1204",
                "name": "User Execution",
                "reference": "https://attack.mitre.org/techniques/T1204/",
                "subtechnique": [
                  {
                    "id": "T1204.002",
                    "name": "Malicious File",
                    "reference": "https://attack.mitre.org/techniques/T1204/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires the installation of associated Machine Learning jobs, as well as data coming in from one of the following integrations:\n- Elastic Defend\n- Windows\n\n### Anomaly Detection Setup\n\nOnce the rule is enabled, the associated Machine Learning job will start automatically. You can view the Machine Learning job linked under the \"Definition\" panel of the detection rule. If the job does not start due to an error, the issue must be resolved for the job to commence successfully. For more details on setting up anomaly detection jobs, refer to the [helper guide](https://www.elastic.co/guide/en/kibana/current/xpack-ml-anomalies.html).\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration to your system:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n### Windows Integration Setup\nThe Windows integration allows you to monitor the Windows OS, services, applications, and more.\n\n#### The following steps should be executed in order to add the Elastic Agent System integration \"windows\" to your system:\n- Go to the Kibana home page and click â€œAdd integrationsâ€.\n- In the query bar, search for â€œWindowsâ€ and select the integration to see more details about it.\n- Click â€œAdd Windowsâ€.\n- Configure the integration name and optionally add a description.\n- Review optional and advanced settings accordingly.\n- Add the newly installed â€œwindowsâ€ to an existing or a new agent policy, and deploy the agent on your system from which windows log files are desirable.\n- Click â€œSave and Continueâ€.\n- For more details on the integration refer to the [helper guide](https://docs.elastic.co/integrations/windows).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [],
        "id": "46b15aae-78e6-4908-b732-806278aa8cb6",
        "rule_id": "6e40d56f-5c0e-4ac6-aece-bee96645b172",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:02.312Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:29.861Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "machine_learning",
        "anomaly_threshold": 50,
        "machine_learning_job_id": [
          "v3_windows_anomalous_process_all_hosts"
        ]
      },
      {
        "name": "AdminSDHolder Backdoor",
        "description": "Detects modifications in the AdminSDHolder object. Attackers can abuse the SDProp process to implement a persistent backdoor in Active Directory. SDProp compares the permissions on protected objects with those defined on the AdminSDHolder object. If the permissions on any of the protected accounts and groups do not match, the permissions on the protected accounts and groups are reset to match those of the domain's AdminSDHolder object, regaining their Administrative Privileges.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 210,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Use Case: Active Directory Monitoring",
          "Data Source: Active Directory",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://adsecurity.org/?p=1906",
          "https://docs.microsoft.com/en-us/windows-server/identity/ad-ds/plan/security-best-practices/appendix-c--protected-accounts-and-groups-in-active-directory#adminsdholder"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1078",
                "name": "Valid Accounts",
                "reference": "https://attack.mitre.org/techniques/T1078/",
                "subtechnique": [
                  {
                    "id": "T1078.002",
                    "name": "Domain Accounts",
                    "reference": "https://attack.mitre.org/techniques/T1078/002/"
                  }
                ]
              },
              {
                "id": "T1098",
                "name": "Account Manipulation",
                "reference": "https://attack.mitre.org/techniques/T1098/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.code",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.event_data.ObjectDN",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "1a77c3a9-2f86-4cd4-99a1-6265d4f951db",
        "rule_id": "6e9130a5-9be6-48e5-943a-9628bfc74b18",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:02.315Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:29.867Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-system.*",
          "logs-windows.*"
        ],
        "filters": [],
        "query": "event.action:(\"Directory Service Changes\" or \"directory-service-object-modified\") and event.code:5136 and\n  winlog.event_data.ObjectDN:CN=AdminSDHolder,CN=System*",
        "language": "kuery"
      },
      {
        "name": "Security Software Discovery using WMIC",
        "description": "Identifies the use of Windows Management Instrumentation Command (WMIC) to discover certain System Security Settings such as AntiVirus or Host Firewall details.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Security Software Discovery using WMIC\n\nAfter successfully compromising an environment, attackers may try to gain situational awareness to plan their next steps. This can happen by running commands to enumerate network resources, users, connections, files, and installed security software.\n\nThis rule looks for the execution of the `wmic` utility with arguments compatible to the enumeration of the security software installed on the host. Attackers can use this information to decide whether or not to infect a system, disable protections, use bypasses, etc.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate any abnormal account behavior, such as command executions, file creations or modifications, and network connections.\n\n### False positive analysis\n\n- Discovery activities are not inherently malicious if they occur in isolation. As long as the analyst did not identify suspicious activity related to the user or host, such alerts can be dismissed.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "building_block_type": "default",
        "output_index": "",
        "version": 214,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Rule Type: BBR",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1518",
                "name": "Software Discovery",
                "reference": "https://attack.mitre.org/techniques/T1518/",
                "subtechnique": [
                  {
                    "id": "T1518.001",
                    "name": "Security Software Discovery",
                    "reference": "https://attack.mitre.org/techniques/T1518/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1047",
                "name": "Windows Management Instrumentation",
                "reference": "https://attack.mitre.org/techniques/T1047/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "338996b1-38a3-47ad-8aa3-463acb3faceb",
        "rule_id": "6ea55c81-e2ba-42f2-a134-bccf857ba922",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:02.318Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:29.877Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n(process.name : \"wmic.exe\" or ?process.pe.original_file_name : \"wmic.exe\") and\nprocess.args : \"/namespace:\\\\\\\\root\\\\SecurityCenter2\" and process.args : \"Get\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "winlogbeat-*",
          "logs-windows.*",
          "endgame-*",
          "logs-system.security*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious Managed Code Hosting Process",
        "description": "Identifies a suspicious managed code hosting process which could indicate code injection or other form of suspicious code execution.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 309,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: SentinelOne",
          "Data Source: Elastic Endgame",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "http://web.archive.org/web/20230329154538/https://blog.menasec.net/2019/07/interesting-difr-traces-of-net-clr.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1055",
                "name": "Process Injection",
                "reference": "https://attack.mitre.org/techniques/T1055/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "c7091d77-6953-46d6-9ee8-ceab18dc8cb8",
        "rule_id": "acf738b5-b5b2-4acc-bad9-1e18ee234f40",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:02.320Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:32.011Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"windows\" and event.type != \"deletion\" and\n  file.name : (\"wscript.exe.log\",\n               \"cscript.exe.log\",\n               \"mshta.exe.log\",\n               \"wmic.exe.log\",\n               \"svchost.exe.log\",\n               \"dllhost.exe.log\",\n               \"cmstp.exe.log\",\n               \"regsvr32.exe.log\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.file-*",
          "logs-windows.sysmon_operational-*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "endgame-*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Signed Proxy Execution via MS Work Folders",
        "description": "Identifies the use of Windows Work Folders to execute a potentially masqueraded control.exe file in the current working directory. Misuse of Windows Work Folders could indicate malicious activity.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Signed Proxy Execution via MS Work Folders\n\nWork Folders is a role service for file servers running Windows Server that provides a consistent way for users to access their work files from their PCs and devices. This allows users to store work files and access them from anywhere. When called, Work Folders will automatically execute any Portable Executable (PE) named control.exe as an argument before accessing the synced share.\n\nUsing Work Folders to execute a masqueraded control.exe could allow an adversary to bypass application controls and increase privileges.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n    - Examine the location of the WorkFolders.exe binary to determine if it was copied to the location of the control.exe binary. It resides in the System32 directory by default.\n- Trace the activity related to the control.exe binary to identify any continuing intrusion activity on the host.\n- Review the control.exe binary executed with Work Folders to determine maliciousness such as additional host activity or network traffic.\n- Determine if control.exe was synced to sync share, indicating potential lateral movement.\n- Review how control.exe was originally delivered on the host, such as emailed, downloaded from the web, or written to\ndisk from a separate binary.\n\n### False positive analysis\n\n- Windows Work Folders are used legitimately by end users and administrators for file sharing and syncing but not in the instance where a suspicious control.exe is passed as an argument.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Review the Work Folders synced share to determine if the control.exe was shared and if so remove it.\n- If no lateral movement was identified during investigation, take the affected host offline if possible and remove the control.exe binary as well as any additional artifacts identified during investigation.\n- Review integrating Windows Information Protection (WIP) to enforce data protection by encrypting the data on PCs using Work Folders.\n- Confirm with the user whether this was expected or not, and reset their password.\n",
        "output_index": "",
        "version": 310,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic",
          "Austin Songer"
        ],
        "false_positives": [],
        "references": [
          "https://docs.microsoft.com/en-us/windows-server/storage/work-folders/work-folders-overview",
          "https://twitter.com/ElliotKillick/status/1449812843772227588",
          "https://lolbas-project.github.io/lolbas/Binaries/WorkFolders/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1218",
                "name": "System Binary Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1218/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "860e3582-9dae-49ed-b7f2-30f2eee0baac",
        "rule_id": "ad0d2742-9a49-11ec-8d6b-acde48001122",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:02.323Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:32.016Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.name : \"control.exe\" and process.parent.name : \"WorkFolders.exe\" and\n  not process.executable : (\n    \"?:\\\\Windows\\\\System32\\\\control.exe\",\n    \"?:\\\\Windows\\\\SysWOW64\\\\control.exe\",\n    \"\\\\Device\\\\HarddiskVolume?\\\\Windows\\\\System32\\\\control.exe\",\n    \"\\\\Device\\\\HarddiskVolume?\\\\Windows\\\\SysWOW64\\\\control.exe\"\n  )",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Potential Network Share Discovery",
        "description": "Adversaries may look for folders and drives shared on remote systems to identify sources of information to gather as a precursor for collection and identify potential systems of interest for Lateral Movement.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 106,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Tactic: Collection",
          "Rule Type: BBR",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1135",
                "name": "Network Share Discovery",
                "reference": "https://attack.mitre.org/techniques/T1135/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0009",
              "name": "Collection",
              "reference": "https://attack.mitre.org/tactics/TA0009/"
            },
            "technique": [
              {
                "id": "T1039",
                "name": "Data from Network Shared Drive",
                "reference": "https://attack.mitre.org/techniques/T1039/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "source.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "source.port",
            "type": "long",
            "ecs": true
          },
          {
            "name": "user.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.event_data.ShareName",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "e54e676c-bbee-4bd5-8de9-c839d14f4af3",
        "rule_id": "b2318c71-5959-469a-a3ce-3a0768e63b9c",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:02.328Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:32.040Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by user.name, source.port, source.ip with maxspan=15s \n [file where event.action == \"network-share-object-access-checked\" and \n  winlog.event_data.ShareName in (\"\\\\\\\\*\\\\ADMIN$\", \"\\\\\\\\*\\\\C$\") and \n  source.ip != null and source.ip != \"0.0.0.0\" and source.ip != \"::1\" and source.ip != \"::\" and source.ip != \"127.0.0.1\"]\n [file where event.action == \"network-share-object-access-checked\" and \n  winlog.event_data.ShareName in (\"\\\\\\\\*\\\\ADMIN$\", \"\\\\\\\\*\\\\C$\") and \n  source.ip != null and source.ip != \"0.0.0.0\" and source.ip != \"::1\" and source.ip != \"::\" and source.ip != \"127.0.0.1\"]",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-windows.*",
          "logs-system.security*"
        ],
        "filters": []
      },
      {
        "name": "Code Signing Policy Modification Through Built-in tools",
        "description": "Identifies attempts to disable/modify the code signing policy through system native utilities. Code signing provides authenticity on a program, and grants the user with the ability to check whether the program has been tampered with. By allowing the execution of unsigned or self-signed code, threat actors can craft and execute malicious code.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Code Signing Policy Modification Through Built-in tools\n\nWindows Driver Signature Enforcement (DSE) is a security feature introduced by Microsoft to enforce that only signed drivers can be loaded and executed into the kernel (ring 0). This feature was introduced to prevent attackers from loading their malicious drivers on targets. If the driver has an invalid signature, the system will not allow it to be loaded.\n\nThis protection is essential for maintaining the security of the system. However, attackers or even administrators can disable this feature and load untrusted drivers, as this can put the system at risk. Therefore, it is important to keep this feature enabled and only load drivers from trusted sources to ensure the integrity and security of the system.\n\nThis rule identifies commands that can disable the Driver Signature Enforcement feature.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Use Osquery and endpoint driver events (`event.category = \"driver\"`) to investigate if suspicious drivers were loaded into the system after the command was executed.\n  - !{osquery{\"label\":\"Osquery - Retrieve All Non-Microsoft Drivers with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, class, description, directory, image,\\nissuer_name, manufacturer, service, signed, subject_name FROM drivers JOIN authenticode ON drivers.image =\\nauthenticode.path JOIN hash ON drivers.image = hash.path WHERE NOT (provider == \\\"Microsoft\\\" AND signed == \\\"1\\\")\\n\"}}\n  - !{osquery{\"label\":\"Osquery - Retrieve All Unsigned Drivers with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, class, description, directory, image,\\nissuer_name, manufacturer, service, signed, subject_name FROM drivers JOIN authenticode ON drivers.image =\\nauthenticode.path JOIN hash ON drivers.image = hash.path WHERE signed == \\\"0\\\"\\n\"}}\n- Identify the driver's `Device Name` and `Service Name`.\n- Check for alerts from the rules specified in the `Related Rules` section.\n\n### False positive analysis\n\n- This activity should not happen legitimately. The security team should address any potential benign true positive (B-TP), as this configuration can put the user and the domain at risk.\n\n### Related Rules\n\n- First Time Seen Driver Loaded - df0fd41e-5590-4965-ad5e-cd079ec22fa9\n- Untrusted Driver Loaded - d8ab1ec1-feeb-48b9-89e7-c12e189448aa\n- Code Signing Policy Modification Through Registry - da7733b1-fe08-487e-b536-0a04c6d8b0cd\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Disable and uninstall all suspicious drivers found in the system. This can be done via Device Manager. (Note that this step may require you to boot the system into Safe Mode.)\n- Remove the related services and registry keys found in the system. Note that the service will probably not stop if the driver is still installed.\n  - This can be done via PowerShell `Remove-Service` cmdlet.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Remove and block malicious artifacts identified during triage.\n- Ensure that the Driver Signature Enforcement is enabled on the system.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 210,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Endgame",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1553",
                "name": "Subvert Trust Controls",
                "reference": "https://attack.mitre.org/techniques/T1553/",
                "subtechnique": [
                  {
                    "id": "T1553.006",
                    "name": "Code Signing Policy Modification",
                    "reference": "https://attack.mitre.org/techniques/T1553/006/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "54dfbc72-6381-4445-990a-dc72b6fd3187",
        "rule_id": "b43570de-a908-4f7f-8bdb-b2df6ffd8c80",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:02.331Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:32.059Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (process.name: \"bcdedit.exe\" or ?process.pe.original_file_name == \"bcdedit.exe\") and process.args: (\"-set\", \"/set\") and \n  process.args: (\"TESTSIGNING\", \"nointegritychecks\", \"loadoptions\", \"DISABLE_INTEGRITY_CHECKS\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious Portable Executable Encoded in Powershell Script",
        "description": "Detects the presence of a portable executable (PE) in a PowerShell script by looking for its encoded header. Attackers embed PEs into PowerShell scripts to inject them into memory, avoiding defences by not writing to disk.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Suspicious Portable Executable Encoded in Powershell Script\n\nPowerShell is one of the main tools system administrators use for automation, report routines, and other tasks. This makes it available for use in various environments, and creates an attractive way for attackers to execute code.\n\nAttackers can abuse PowerShell in-memory capabilities to inject executables into memory without touching the disk, bypassing file-based security protections. These executables are generally base64 encoded.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Examine the script content that triggered the detection; look for suspicious DLL imports, collection or exfiltration capabilities, suspicious functions, encoded or compressed data, and other potentially malicious characteristics.\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Evaluate whether the user needs to use PowerShell to complete tasks.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the script using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Related rules\n\n- Suspicious .NET Reflection via PowerShell - e26f042e-c590-4e82-8e05-41e81bd822ad\n- PowerShell Suspicious Payload Encoded and Compressed - 81fe9dc6-a2d7-4192-a2d8-eed98afc766a\n- PowerShell PSReflect Script - 56f2e9b5-4803-4e44-a0a4-a52dc79d57fe\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Reimage the host operating system or restore the compromised files to clean versions.\n- Restrict PowerShell usage outside of IT and engineering business units using GPOs, AppLocker, Intune, or similar software.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 212,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Tactic: Defense Evasion",
          "Resources: Investigation Guide",
          "Data Source: PowerShell Logs"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/atc-project/atc-data/blob/master/docs/Logging_Policies/LP_0109_windows_powershell_script_block_log.md"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1055",
                "name": "Process Injection",
                "reference": "https://attack.mitre.org/techniques/T1055/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'PowerShell Script Block Logging' logging policy must be enabled.\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nAdministrative Templates >\nWindows PowerShell >\nTurn on PowerShell Script Block Logging (Enable)\n```\n\nSteps to implement the logging policy via registry:\n\n```\nreg add \"hklm\\SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\ScriptBlockLogging\" /v EnableScriptBlockLogging /t REG_DWORD /d 1\n```\n",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "powershell.file.script_block_text",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "b030c1c3-ab32-45c4-9cda-eabc489037b9",
        "rule_id": "ad84d445-b1ce-4377-82d9-7c633f28bf9a",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:02.326Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:32.021Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-windows.powershell*"
        ],
        "filters": [],
        "query": "event.category:process and host.os.type:windows and\n  powershell.file.script_block_text : (\n    TVqQAAMAAAAEAAAA\n  ) and not user.id : \"S-1-5-18\"",
        "language": "kuery"
      },
      {
        "name": "Clearing Windows Console History",
        "description": "Identifies when a user attempts to clear console history. An adversary may clear the command history of a compromised account to conceal the actions undertaken during an intrusion.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Clearing Windows Console History\n\nPowerShell is one of the main tools system administrators use for automation, report routines, and other tasks. This makes it available for use in various environments, and creates an attractive way for attackers to execute code.\n\nAttackers can try to cover their tracks by clearing PowerShell console history. PowerShell has two different ways of logging commands: the built-in history and the command history managed by the PSReadLine module. This rule looks for the execution of commands that can clear the built-in PowerShell logs or delete the `ConsoleHost_history.txt` file.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n  - Verify if any other anti-forensics behaviors were observed.\n- Investigate the PowerShell logs on the SIEM to determine if there was suspicious behavior that an attacker may be trying to cover up.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n  - Ensure that PowerShell auditing policies and log collection are in place to grant future visibility.\n",
        "output_index": "",
        "version": 313,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Tactic: Execution",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Austin Songer"
        ],
        "false_positives": [],
        "references": [
          "https://stefanos.cloud/kb/how-to-clear-the-powershell-command-history/",
          "https://www.shellhacks.com/clear-history-powershell/",
          "https://community.sophos.com/sophos-labs/b/blog/posts/powershell-command-history-forensics"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1070",
                "name": "Indicator Removal",
                "reference": "https://attack.mitre.org/techniques/T1070/",
                "subtechnique": [
                  {
                    "id": "T1070.003",
                    "name": "Clear Command History",
                    "reference": "https://attack.mitre.org/techniques/T1070/003/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "23051362-e8fe-4467-87c7-c6bf788f8d90",
        "rule_id": "b5877334-677f-4fb9-86d5-a9721274223b",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:02.334Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:32.072Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (\n    process.name : (\"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\") or\n    ?process.pe.original_file_name in (\"powershell.exe\", \"pwsh.dll\", \"powershell_ise.exe\")\n  ) and\n  (\n    process.args : \"*Clear-History*\" or\n    (process.args : (\"*Remove-Item*\", \"rm\") and process.args : (\"*ConsoleHost_history.txt*\", \"*(Get-PSReadlineOption).HistorySavePath*\")) or\n    (process.args : \"*Set-PSReadlineOption*\" and process.args : \"*SaveNothing*\")\n  )",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Volume Shadow Copy Deleted or Resized via VssAdmin",
        "description": "Identifies use of vssadmin.exe for shadow copy deletion or resizing on endpoints. This commonly occurs in tandem with ransomware or other destructive attacks.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Volume Shadow Copy Deleted or Resized via VssAdmin\n\nThe Volume Shadow Copy Service (VSS) is a Windows feature that enables system administrators to take snapshots of volumes that can later be restored or mounted to recover specific files or folders.\n\nA typical step in the playbook of an attacker attempting to deploy ransomware is to delete Volume Shadow Copies to ensure that victims have no alternative to paying the ransom, making any action that deletes shadow copies worth monitoring.\n\nThis rule monitors the execution of Vssadmin.exe to either delete or resize shadow copies.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- In the case of a resize operation, check if the resize value is equal to suspicious values, like 401MB.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- If unsigned files are found on the process tree, retrieve them and determine if they are malicious:\n  - Use a private sandboxed malware analysis system to perform analysis.\n    - Observe and collect information about the following activities:\n      - Attempts to contact external domains and addresses.\n      - File and registry access, modification, and creation activities.\n      - Service creation and launch activities.\n      - Scheduled task creation.\n  - Use the PowerShell Get-FileHash cmdlet to get the files' SHA-256 hash values.\n    - Search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Use process name, command line, and file hash to search for occurrences in other hosts.\n- Check if any files on the host machine have been encrypted.\n\n\n### False positive analysis\n\n- This rule may produce benign true positives (B-TPs). If this activity is expected and noisy in your environment, consider adding exceptions â€” preferably with a combination of user and command line conditions.\n\n### Related rules\n\n- Volume Shadow Copy Deleted or Resized via VssAdmin - b5ea4bfe-a1b2-421f-9d47-22a75a6f2921\n- Volume Shadow Copy Deletion via PowerShell - d99a037b-c8e2-47a5-97b9-170d076827c4\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Consider isolating the involved host to prevent destructive behavior, which is commonly associated with this activity.\n- Priority should be given due to the advanced stage of this activity on the attack.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- If data was encrypted, deleted, or modified, activate your data recovery plan.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Perform data recovery locally or restore the backups from replicated copies (cloud, other servers, etc.).\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 313,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Impact",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0040",
              "name": "Impact",
              "reference": "https://attack.mitre.org/tactics/TA0040/"
            },
            "technique": [
              {
                "id": "T1490",
                "name": "Inhibit System Recovery",
                "reference": "https://attack.mitre.org/techniques/T1490/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "ee5f1cdb-595a-41ef-a66e-0dfe8be1c80d",
        "rule_id": "b5ea4bfe-a1b2-421f-9d47-22a75a6f2921",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:02.337Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:32.078Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (process.name : \"vssadmin.exe\" or ?process.pe.original_file_name == \"VSSADMIN.EXE\") and\n  process.args : (\"delete\", \"resize\") and process.args : \"shadows*\"",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Potential Veeam Credential Access Command",
        "description": "Identifies commands that can access and decrypt Veeam credentials stored in MSSQL databases. Attackers can use Veeam Credentials to target backups as part of destructive operations such as Ransomware attacks.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 203,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Tactic: Credential Access",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://thedfirreport.com/2021/12/13/diavol-ransomware/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1003",
                "name": "OS Credential Dumping",
                "reference": "https://attack.mitre.org/techniques/T1003/"
              },
              {
                "id": "T1555",
                "name": "Credentials from Password Stores",
                "reference": "https://attack.mitre.org/techniques/T1555/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "5099ea8d-c664-4b8d-a8d3-88f4a247114b",
        "rule_id": "b661f86d-1c23-4ce7-a59e-2edbdba28247",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:02.347Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:32.088Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (\n    (process.name : \"sqlcmd.exe\" or ?process.pe.original_file_name : \"sqlcmd.exe\") or\n    process.args : (\"Invoke-Sqlcmd\", \"Invoke-SqlExecute\", \"Invoke-DbaQuery\", \"Invoke-SqlQuery\")\n  ) and\n  process.args : \"*[VeeamBackup].[dbo].[Credentials]*\"",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "PowerShell Invoke-NinjaCopy script",
        "description": "Detects PowerShell scripts that contain the default exported functions used on Invoke-NinjaCopy. Attackers can use Invoke-NinjaCopy to read SYSTEM files that are normally locked, such as the NTDS.dit file or registry hives.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating PowerShell Invoke-NinjaCopy script\n\nPowerShell is one of the main tools system administrators use for automation, report routines, and other tasks, making it available for use in various environments, creating an attractive way for attackers to execute code.\n\nInvoke-NinjaCopy is a PowerShell script capable of reading SYSTEM files that were normally locked, such as `NTDS.dit` or sensitive registry locations. It does so by using the direct volume access technique, which enables attackers to bypass access control mechanisms and file system monitoring by reading the raw data directly from the disk and extracting the file by parsing the file system structures.\n\n#### Possible investigation steps\n\n- Examine the script content that triggered the detection; look for suspicious DLL imports, collection or exfiltration capabilities, suspicious functions, encoded or compressed data, and other potentially malicious characteristics.\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Examine file or network events from the involved PowerShell process for suspicious behavior.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Evaluate whether the user needs to use PowerShell to complete tasks.\n- Determine whether the script stores the captured data locally.\n- Check if the imported function was executed and which file it targeted.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Any activity that triggered the alert and is not inherently malicious must be monitored by the security team.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Restrict PowerShell usage outside of IT and engineering business units using GPOs, AppLocker, Intune, or similar software.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 108,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Data Source: PowerShell Logs",
          "Resources: Investigation Guide"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/BC-SECURITY/Empire/blob/main/empire/server/data/module_source/collection/Invoke-NinjaCopy.ps1"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1003",
                "name": "OS Credential Dumping",
                "reference": "https://attack.mitre.org/techniques/T1003/",
                "subtechnique": [
                  {
                    "id": "T1003.002",
                    "name": "Security Account Manager",
                    "reference": "https://attack.mitre.org/techniques/T1003/002/"
                  },
                  {
                    "id": "T1003.003",
                    "name": "NTDS",
                    "reference": "https://attack.mitre.org/techniques/T1003/003/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1006",
                "name": "Direct Volume Access",
                "reference": "https://attack.mitre.org/techniques/T1006/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "powershell.file.script_block_text",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "d82bd924-0971-4055-b48e-d36f51c613b1",
        "rule_id": "b8386923-b02c-4b94-986a-d223d9b01f88",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:02.350Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:32.098Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-windows.powershell*"
        ],
        "filters": [],
        "query": "event.category:process and host.os.type:windows and\n  powershell.file.script_block_text : (\n    \"StealthReadFile\" or\n    \"StealthReadFileAddr\" or\n    \"StealthCloseFileDelegate\" or\n    \"StealthOpenFile\" or\n    \"StealthCloseFile\" or\n    \"StealthReadFile\" or\n    \"Invoke-NinjaCopy\"\n   )\n  and not user.id : \"S-1-5-18\"\n  and not powershell.file.script_block_text : (\n    \"sentinelbreakpoints\" and \"Set-PSBreakpoint\" and \"PowerSploitIndicators\"\n  )",
        "language": "kuery"
      },
      {
        "name": "Creation or Modification of Domain Backup DPAPI private key",
        "description": "Identifies the creation or modification of Domain Backup private keys. Adversaries may extract the Data Protection API (DPAPI) domain backup key from a Domain Controller (DC) to be able to decrypt any domain user master key file.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\nDomain DPAPI Backup keys are stored on domain controllers and can be dumped remotely with tools such as Mimikatz. The resulting .pvk private key can be used to decrypt ANY domain user masterkeys, which then can be used to decrypt any secrets protected by those keys.\n",
        "output_index": "",
        "version": 412,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.dsinternals.com/en/retrieving-dpapi-backup-keys-from-active-directory/",
          "https://posts.specterops.io/operational-guidance-for-offensive-user-dpapi-abuse-1fb7fac8b107"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1552",
                "name": "Unsecured Credentials",
                "reference": "https://attack.mitre.org/techniques/T1552/",
                "subtechnique": [
                  {
                    "id": "T1552.004",
                    "name": "Private Keys",
                    "reference": "https://attack.mitre.org/techniques/T1552/004/"
                  }
                ]
              },
              {
                "id": "T1555",
                "name": "Credentials from Password Stores",
                "reference": "https://attack.mitre.org/techniques/T1555/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "875b7c2f-8edd-4975-9022-a4b864330d40",
        "rule_id": "b83a7e96-2eb3-4edf-8346-427b6858d3bd",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:02.353Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:34.170Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"windows\" and event.type != \"deletion\" and file.name : (\"ntds_capi_*.pfx\", \"ntds_capi_*.pvk\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.file-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-m365_defender.event-*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Kirbi File Creation",
        "description": "Identifies the creation of .kirbi files. The creation of this kind of file is an indicator of an attacker running Kerberos ticket dump utilities, such as Mimikatz, and precedes attacks such as Pass-The-Ticket (PTT), which allows the attacker to impersonate users using Kerberos tickets.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 311,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Elastic Endgame",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1003",
                "name": "OS Credential Dumping",
                "reference": "https://attack.mitre.org/techniques/T1003/"
              },
              {
                "id": "T1558",
                "name": "Steal or Forge Kerberos Tickets",
                "reference": "https://attack.mitre.org/techniques/T1558/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "412b2631-8236-45bb-b771-678cc1a47bf9",
        "rule_id": "b8f8da2d-a9dc-48c0-90e4-955c0aa1259a",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:02.356Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:33.891Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"windows\" and event.type == \"creation\" and file.extension : \"kirbi\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.file-*",
          "logs-windows.sysmon_operational-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-m365_defender.event-*",
          "winlogbeat-*",
          "endgame-*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Unusual Windows Network Activity",
        "description": "Identifies Windows processes that do not usually use the network but have unexpected network activity, which can indicate command-and-control, lateral movement, persistence, or data exfiltration activity. A process with unusual network activity can denote process exploitation or injection, where the process is used to run persistence mechanisms that allow a malicious actor remote access or control of the host, data exfiltration, and execution of unauthorized network applications.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Unusual Network Activity\nDetection alerts from this rule indicate the presence of network activity from a Windows process for which network activity is very unusual.  Here are some possible avenues of investigation:\n- Consider the IP addresses, protocol and ports. Are these used by normal but infrequent network workflows? Are they expected or unexpected?\n- If the destination IP address is remote or external, does it associate with an expected domain, organization or geography? Note: avoid interacting directly with suspected malicious IP addresses.\n- Consider the user as identified by the username field. Is this network activity part of an expected workflow for the user who ran the program?\n- Examine the history of execution. If this process only manifested recently, it might be part of a new software package. If it has a consistent cadence (for example if it runs monthly or quarterly), it might be part of a monthly or quarterly business process.\n- Examine the process arguments, title and working directory. These may provide indications as to the source of the program or the nature of the tasks it is performing.\n- Consider the same for the parent process. If the parent process is a legitimate system utility or service, this could be related to software updates or system management. If the parent process is something user-facing like an Office application, this process could be more suspicious.\n- If you have file hash values in the event data, and you suspect malware, you can optionally run a search for the file hash to see if the file is identified as malware by anti-malware tools.",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Rule Type: ML",
          "Rule Type: Machine Learning"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "15m",
        "from": "now-2700s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "A newly installed program or one that rarely uses the network could trigger this alert."
        ],
        "references": [
          "https://www.elastic.co/guide/en/security/current/prebuilt-ml-jobs.html"
        ],
        "max_signals": 100,
        "threat": [],
        "setup": "## Setup\n\nThis rule requires the installation of associated Machine Learning jobs, as well as data coming in from one of the following integrations:\n- Elastic Defend\n- Windows\n\n### Anomaly Detection Setup\n\nOnce the rule is enabled, the associated Machine Learning job will start automatically. You can view the Machine Learning job linked under the \"Definition\" panel of the detection rule. If the job does not start due to an error, the issue must be resolved for the job to commence successfully. For more details on setting up anomaly detection jobs, refer to the [helper guide](https://www.elastic.co/guide/en/kibana/current/xpack-ml-anomalies.html).\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration to your system:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n### Windows Integration Setup\nThe Windows integration allows you to monitor the Windows OS, services, applications, and more.\n\n#### The following steps should be executed in order to add the Elastic Agent System integration \"windows\" to your system:\n- Go to the Kibana home page and click â€œAdd integrationsâ€.\n- In the query bar, search for â€œWindowsâ€ and select the integration to see more details about it.\n- Click â€œAdd Windowsâ€.\n- Configure the integration name and optionally add a description.\n- Review optional and advanced settings accordingly.\n- Add the newly installed â€œwindowsâ€ to an existing or a new agent policy, and deploy the agent on your system from which windows log files are desirable.\n- Click â€œSave and Continueâ€.\n- For more details on the integration refer to the [helper guide](https://docs.elastic.co/integrations/windows).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [],
        "id": "79a3920e-b6d1-4cb8-b820-f2c6ca52b9ac",
        "rule_id": "ba342eb2-583c-439f-b04d-1fdd7c1417cc",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:02.358Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:33.913Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "machine_learning",
        "anomaly_threshold": 50,
        "machine_learning_job_id": [
          "v3_windows_anomalous_network_activity"
        ]
      },
      {
        "name": "PowerShell Keylogging Script",
        "description": "Detects the use of Win32 API Functions that can be used to capture user keystrokes in PowerShell scripts. Attackers use this technique to capture user input, looking for credentials and/or other valuable data.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating PowerShell Keylogging Script\n\nPowerShell is one of the main tools system administrators use for automation, report routines, and other tasks. This makes it available for use in various environments, and creates an attractive way for attackers to execute code.\n\nAttackers can abuse PowerShell capabilities to capture user keystrokes with the goal of stealing credentials and other valuable information as credit card data and confidential conversations.\n\n#### Possible investigation steps\n\n- Examine the script content that triggered the detection; look for suspicious DLL imports, collection or exfiltration capabilities, suspicious functions, encoded or compressed data, and other potentially malicious characteristics.\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Examine file or network events from the involved PowerShell process for suspicious behavior.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Evaluate whether the user needs to use PowerShell to complete tasks.\n- Determine whether the script stores the captured data locally.\n- Investigate whether the script contains exfiltration capabilities and identify the exfiltration server.\n- Assess network data to determine if the host communicated with the exfiltration server.\n\n### False positive analysis\n\n- Regular users do not have a business justification for using scripting utilities to capture keystrokes, making false positives unlikely. In the case of authorized benign true positives (B-TPs), exceptions can be added.\n\n### Related rules\n\n- PowerShell PSReflect Script - 56f2e9b5-4803-4e44-a0a4-a52dc79d57fe\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Prioritize the response if this alert involves key executives or potentially valuable targets for espionage.\n- Restrict PowerShell usage outside of IT and engineering business units using GPOs, AppLocker, Intune, or similar software.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 215,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Collection",
          "Resources: Investigation Guide",
          "Data Source: PowerShell Logs"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/EmpireProject/Empire/blob/master/data/module_source/collection/Get-Keystrokes.ps1",
          "https://github.com/MojtabaTajik/FunnyKeylogger/blob/master/FunnyLogger.ps1"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0009",
              "name": "Collection",
              "reference": "https://attack.mitre.org/tactics/TA0009/"
            },
            "technique": [
              {
                "id": "T1056",
                "name": "Input Capture",
                "reference": "https://attack.mitre.org/techniques/T1056/",
                "subtechnique": [
                  {
                    "id": "T1056.001",
                    "name": "Keylogging",
                    "reference": "https://attack.mitre.org/techniques/T1056/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              },
              {
                "id": "T1106",
                "name": "Native API",
                "reference": "https://attack.mitre.org/techniques/T1106/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'PowerShell Script Block Logging' logging policy must be enabled.\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nAdministrative Templates >\nWindows PowerShell >\nTurn on PowerShell Script Block Logging (Enable)\n```\n\nSteps to implement the logging policy via registry:\n\n```\nreg add \"hklm\\SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\ScriptBlockLogging\" /v EnableScriptBlockLogging /t REG_DWORD /d 1\n```\n",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "powershell.file.script_block_text",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "583b185f-7016-4b2b-a7d7-4743e912a002",
        "rule_id": "bd2c86a0-8b61-4457-ab38-96943984e889",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:02.361Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:33.933Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-windows.powershell*"
        ],
        "filters": [],
        "query": "event.category:process and host.os.type:windows and\n  (\n   powershell.file.script_block_text : (GetAsyncKeyState or NtUserGetAsyncKeyState or GetKeyboardState or \"Get-Keystrokes\") or\n   powershell.file.script_block_text : (\n        (SetWindowsHookA or SetWindowsHookW or SetWindowsHookEx or SetWindowsHookExA or NtUserSetWindowsHookEx) and\n        (GetForegroundWindow or GetWindowTextA or GetWindowTextW or \"WM_KEYBOARD_LL\" or \"WH_MOUSE_LL\")\n   )\n   ) and not user.id : \"S-1-5-18\"\n  and not powershell.file.script_block_text : (\n    \"sentinelbreakpoints\" and \"Set-PSBreakpoint\"\n  )",
        "language": "kuery"
      },
      {
        "name": "Suspicious Print Spooler Point and Print DLL",
        "description": "Detects attempts to exploit a privilege escalation vulnerability (CVE-2020-1030) related to the print spooler service. Exploitation involves chaining multiple primitives to load an arbitrary DLL into the print spooler process running as SYSTEM.",
        "risk_score": 73,
        "severity": "high",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 208,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Data Source: Elastic Endgame",
          "Use Case: Vulnerability",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.accenture.com/us-en/blogs/cyber-defense/discovering-exploiting-shutting-down-dangerous-windows-print-spooler-vulnerability",
          "https://github.com/sbousseaden/EVTX-ATTACK-SAMPLES/blob/master/Privilege%20Escalation/privesc_sysmon_cve_20201030_spooler.evtx",
          "https://msrc.microsoft.com/update-guide/en-US/vulnerability/CVE-2020-1030"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1068",
                "name": "Exploitation for Privilege Escalation",
                "reference": "https://attack.mitre.org/techniques/T1068/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.data.strings",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "registry.path",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "faf4b81d-6611-43cf-ac1a-8daa011e6fe2",
        "rule_id": "bd7eefee-f671-494e-98df-f01daf9e5f17",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:02.364Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:33.938Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by host.id with maxspan=30s\n[registry where host.os.type == \"windows\" and\n registry.path : (\n    \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Print\\\\Printers\\\\*\\\\SpoolDirectory\",\n    \"\\\\REGISTRY\\\\MACHINE\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Print\\\\Printers\\\\*\\\\SpoolDirectory\"\n    ) and\n registry.data.strings : \"C:\\\\Windows\\\\System32\\\\spool\\\\drivers\\\\x64\\\\4\"]\n[registry where host.os.type == \"windows\" and\n registry.path : (\n    \"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Print\\\\Printers\\\\*\\\\CopyFiles\\\\Payload\\\\Module\",\n    \"\\\\REGISTRY\\\\MACHINE\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Print\\\\Printers\\\\*\\\\CopyFiles\\\\Payload\\\\Module\"\n    ) and\n registry.data.strings : \"C:\\\\Windows\\\\System32\\\\spool\\\\drivers\\\\x64\\\\4\\\\*\"]",
        "language": "eql",
        "index": [
          "logs-endpoint.events.registry-*",
          "endgame-*",
          "logs-windows.sysmon_operational-*",
          "winlogbeat-*"
        ],
        "filters": []
      },
      {
        "name": "Execution via Windows Command Debugging Utility",
        "description": "An adversary can use the Windows command line debugging utility cdb.exe to execute commands or shellcode. This rule looks for those instances and where the cdb.exe binary is outside of the normal WindowsKit installation paths.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 102,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://lolbas-project.github.io/lolbas/OtherMSBinaries/Cdb/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1218",
                "name": "System Binary Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1218/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "6f1f388a-7037-4657-bfbf-584793dbf036",
        "rule_id": "bdfaddc4-4438-48b4-bc43-9f5cf8151c46",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:02.367Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:33.949Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n (?process.pe.original_file_name == \"CDB.Exe\" or process.name : \"cdb.exe\") and\n  process.args : (\"-cf\", \"-c\", \"-pd\") and\n  not process.executable : (\n        \"?:\\\\Program Files (x86)\\\\*\\\\cdb.exe\",\n        \"?:\\\\Program Files\\\\*\\\\cdb.exe\",\n        \"\\\\Device\\\\HarddiskVolume?\\\\Program Files (x86)\\\\*\\\\cdb.exe\",\n        \"\\\\Device\\\\HarddiskVolume?\\\\Program Files\\\\*\\\\cdb.exe\"\n  )",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-m365_defender.event-*",
          "logs-system.security-*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious Windows Process Cluster Spawned by a Host",
        "description": "A machine learning job combination has detected a set of one or more suspicious Windows processes with unusually high scores for malicious probability. These process(es) have been classified as malicious in several ways. The process(es) were predicted to be malicious by the ProblemChild supervised ML model. If the anomaly contains a cluster of suspicious processes, each process has the same host name, and the aggregate score of the event cluster was calculated to be unusually high by an unsupervised ML model. Such a cluster often contains suspicious or malicious activity, possibly involving LOLbins, that may be resistant to detection using conventional search rules.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 107,
        "tags": [
          "Use Case: Living off the Land Attack Detection",
          "Rule Type: ML",
          "Rule Type: Machine Learning",
          "Tactic: Defense Evasion"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "15m",
        "from": "now-2700s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/guide/en/security/current/prebuilt-ml-jobs.html",
          "https://docs.elastic.co/en/integrations/problemchild",
          "https://www.elastic.co/security-labs/detecting-living-off-the-land-attacks-with-new-elastic-integration"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1036",
                "name": "Masquerading",
                "reference": "https://attack.mitre.org/techniques/T1036/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe rule requires the Living off the Land (LotL) Attack Detection integration assets to be installed, as well as Windows process events collected by integrations such as Elastic Defend or Winlogbeat.  \n\n### LotL Attack Detection Setup\nThe LotL Attack Detection integration detects living-off-the-land activity in Windows process events.\n\n#### Prerequisite Requirements:\n- Fleet is required for LotL Attack Detection.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n- Windows process events collected by the [Elastic Defend](https://docs.elastic.co/en/integrations/endpoint) integration or Winlogbeat(https://www.elastic.co/guide/en/beats/winlogbeat/current/_winlogbeat_overview.html).\n- To install Elastic Defend, refer to the [documentation](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n- To set up and run Winlogbeat, follow [this](https://www.elastic.co/guide/en/beats/winlogbeat/current/winlogbeat-installation-configuration.html) guide.\n\n#### The following steps should be executed to install assets associated with the LotL Attack Detection integration:\n- Go to the Kibana homepage. Under Management, click Integrations.\n- In the query bar, search for Living off the Land Attack Detection and select the integration to see more details about it.\n- Follow the instructions under the **Installation** section.\n- For this rule to work, complete the instructions through **Add preconfigured anomaly detection jobs**.\n",
        "related_integrations": [
          {
            "package": "problemchild",
            "version": "^2.0.0"
          },
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [],
        "id": "7798727f-be14-40bc-9f00-5ee399a9b269",
        "rule_id": "bdfebe11-e169-42e3-b344-c5d2015533d3",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:02.370Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:33.954Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "machine_learning",
        "anomaly_threshold": 75,
        "machine_learning_job_id": [
          "problem_child_high_sum_by_host"
        ]
      },
      {
        "name": "Searching for Saved Credentials via VaultCmd",
        "description": "Windows Credential Manager allows you to create, view, or delete saved credentials for signing into websites, connected applications, and networks. An adversary may abuse this to list or dump credentials stored in the Credential Manager for saved usernames and passwords. This may also be performed in preparation of lateral movement.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 312,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://medium.com/threatpunter/detecting-adversary-tradecraft-with-image-load-event-logging-and-eql-8de93338c16",
          "https://web.archive.org/web/20201004080456/https://rastamouse.me/blog/rdp-jump-boxes/",
          "https://www.elastic.co/security-labs/detect-credential-access"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1003",
                "name": "OS Credential Dumping",
                "reference": "https://attack.mitre.org/techniques/T1003/"
              },
              {
                "id": "T1555",
                "name": "Credentials from Password Stores",
                "reference": "https://attack.mitre.org/techniques/T1555/",
                "subtechnique": [
                  {
                    "id": "T1555.004",
                    "name": "Windows Credential Manager",
                    "reference": "https://attack.mitre.org/techniques/T1555/004/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "7c8363f4-7102-40c7-a79f-7de3a8c0f33a",
        "rule_id": "be8afaed-4bcd-4e0a-b5f9-5562003dde81",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:02.372Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:33.959Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (?process.pe.original_file_name:\"vaultcmd.exe\" or process.name:\"vaultcmd.exe\") and\n  process.args:\"/list*\"",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "PowerShell Script with Windows Defender Tampering Capabilities",
        "description": "Identifies PowerShell scripts containing cmdlets and parameters that attackers can abuse to disable Windows Defender features. Attackers can tamper with antivirus to reduce the risk of detection when executing their payloads.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 103,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: PowerShell Logs",
          "Rule Type: BBR"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.001",
                    "name": "Disable or Modify Tools",
                    "reference": "https://attack.mitre.org/techniques/T1562/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'PowerShell Script Block Logging' logging policy must be enabled.\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nAdministrative Templates >\nWindows PowerShell >\nTurn on PowerShell Script Block Logging (Enable)\n```\n\nSteps to implement the logging policy via registry:\n\n```\nreg add \"hklm\\SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\ScriptBlockLogging\" /v EnableScriptBlockLogging /t REG_DWORD /d 1\n```\n",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "powershell.file.script_block_text",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "cf4ec311-f518-4899-8b39-c49cfe6281aa",
        "rule_id": "c124dc1b-cef2-4d01-8d74-ff6b0d5096b6",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:02.375Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:33.974Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-windows.powershell*"
        ],
        "filters": [],
        "query": "event.category: \"process\" and host.os.type:windows and\n(\n  powershell.file.script_block_text: \"Set-MpPreference\" and\n  powershell.file.script_block_text: (\n    DisableArchiveScanning or DisableBehaviorMonitoring or\n    DisableIntrusionPreventionSystem or DisableIOAVProtection or\n    DisableRemovableDriveScanning or DisableBlockAtFirstSeen or\n    DisableScanningMappedNetworkDrivesForFullScan or\n    DisableScanningNetworkFiles or DisableScriptScanning or\n    DisableRealtimeMonitoring or LowThreatDefaultAction or\n    ModerateThreatDefaultAction or HighThreatDefaultAction\n  )\n)",
        "language": "kuery"
      },
      {
        "name": "Microsoft IIS Connection Strings Decryption",
        "description": "Identifies use of aspnet_regiis to decrypt Microsoft IIS connection strings. An attacker with Microsoft IIS web server access via a webshell or alike can decrypt and dump any hardcoded connection strings, such as the MSSQL service account password using aspnet_regiis command.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 312,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://blog.netspi.com/decrypting-iis-passwords-to-break-out-of-the-dmz-part-1/",
          "https://symantec-enterprise-blogs.security.com/blogs/threat-intelligence/greenbug-espionage-telco-south-asia"
        ],
        "max_signals": 33,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1003",
                "name": "OS Credential Dumping",
                "reference": "https://attack.mitre.org/techniques/T1003/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "5927560a-9215-4e6d-ae8b-9d8736e0c36a",
        "rule_id": "c25e9c87-95e1-4368-bfab-9fd34cf867ec",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:02.378Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:33.984Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (process.name : \"aspnet_regiis.exe\" or ?process.pe.original_file_name == \"aspnet_regiis.exe\") and\n  process.args : \"connectionStrings\" and process.args : \"-pdf\"",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Mounting Hidden or WebDav Remote Shares",
        "description": "Identifies the use of net.exe to mount a WebDav or hidden remote share. This may indicate lateral movement or preparation for data exfiltration.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 311,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Initial Access",
          "Tactic: Lateral Movement",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1021",
                "name": "Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1021/",
                "subtechnique": [
                  {
                    "id": "T1021.002",
                    "name": "SMB/Windows Admin Shares",
                    "reference": "https://attack.mitre.org/techniques/T1021/002/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1078",
                "name": "Valid Accounts",
                "reference": "https://attack.mitre.org/techniques/T1078/",
                "subtechnique": [
                  {
                    "id": "T1078.003",
                    "name": "Local Accounts",
                    "reference": "https://attack.mitre.org/techniques/T1078/003/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1087",
                "name": "Account Discovery",
                "reference": "https://attack.mitre.org/techniques/T1087/",
                "subtechnique": [
                  {
                    "id": "T1087.001",
                    "name": "Local Account",
                    "reference": "https://attack.mitre.org/techniques/T1087/001/"
                  },
                  {
                    "id": "T1087.002",
                    "name": "Domain Account",
                    "reference": "https://attack.mitre.org/techniques/T1087/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "4c5adf18-8f72-43c9-b607-a33df7bbdccc",
        "rule_id": "c4210e1c-64f2-4f48-b67e-b5a8ffe3aa14",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:02.380Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:34.009Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n ((process.name : \"net.exe\" or ?process.pe.original_file_name == \"net.exe\") or ((process.name : \"net1.exe\" or ?process.pe.original_file_name == \"net1.exe\") and\n not process.parent.name : \"net.exe\")) and\n process.args : \"use\" and\n /* including hidden and webdav based online shares such as onedrive  */\n process.args : (\"\\\\\\\\*\\\\*$*\", \"\\\\\\\\*@SSL\\\\*\", \"http*\") and\n /* excluding shares deletion operation */\n not process.args : \"/d*\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "winlogbeat-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Microsoft Build Engine Started by an Office Application",
        "description": "An instance of MSBuild, the Microsoft Build Engine, was started by Excel or Word. This is unusual behavior for the Build Engine and could have been caused by an Excel or Word document executing a malicious script payload.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Microsoft Build Engine Started by an Office Application\n\nMicrosoft Office (MS Office) is a suite of applications designed to help with productivity and completing common tasks on a computer. You can create and edit documents containing text and images, work with data in spreadsheets and databases, and create presentations and posters. As it is some of the most-used software across companies, MS Office is frequently targeted for initial access. It also has a wide variety of capabilities that attackers can take advantage of.\n\nThe Microsoft Build Engine is a platform for building applications. This engine, also known as MSBuild, provides an XML schema for a project file that controls how the build platform processes and builds software, and can be abused to proxy execution of code.\n\nThis rule looks for the `Msbuild.exe` utility spawned by MS Office programs. This is generally the result of the execution of malicious documents.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate abnormal behaviors observed by the subject process, such as network connections, registry or file modifications, and any spawned child processes.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Retrieve MS Office documents received and opened by the user that could cause this behavior. Common locations include, but are not limited to, the Downloads and Document folders and the folder configured at the email client.\n- Determine if the collected files are malicious:\n  - Use a private sandboxed malware analysis system to perform analysis.\n    - Observe and collect information about the following activities:\n      - Attempts to contact external domains and addresses.\n      - File and registry access, modification, and creation activities.\n      - Service creation and launch activities.\n      - Scheduled task creation.\n  - Use the PowerShell Get-FileHash cmdlet to get the files' SHA-256 hash values.\n    - Search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n  - If the malicious file was delivered via phishing:\n    - Block the email sender from sending future emails.\n    - Block the malicious web pages.\n    - Remove emails from the sender from mailboxes.\n    - Consider improvements to the security awareness program.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 312,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Tactic: Execution",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "The Build Engine is commonly used by Windows developers but use by non-engineers is unusual. It is quite unusual for this program to be started by an Office application like Word or Excel."
        ],
        "references": [
          "https://blog.talosintelligence.com/2020/02/building-bypass-with-msbuild.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1127",
                "name": "Trusted Developer Utilities Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1127/",
                "subtechnique": [
                  {
                    "id": "T1127.001",
                    "name": "MSBuild",
                    "reference": "https://attack.mitre.org/techniques/T1127/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            }
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "8660d2a7-6591-4505-866f-a9c95fcb2fee",
        "rule_id": "c5dc3223-13a2-44a2-946c-e9dc0aa0449c",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:02.383Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:34.035Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.name : \"MSBuild.exe\" and\n  process.parent.name : (\"eqnedt32.exe\",\n                         \"excel.exe\",\n                         \"fltldr.exe\",\n                         \"msaccess.exe\",\n                         \"mspub.exe\",\n                         \"outlook.exe\",\n                         \"powerpnt.exe\",\n                         \"winword.exe\" )",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Potential PowerShell Obfuscated Script",
        "description": "Identifies scripts that contain patterns and known methods that obfuscate PowerShell code. Attackers can use obfuscation techniques to bypass PowerShell security protections such as Antimalware Scan Interface (AMSI).",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 103,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: PowerShell Logs"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/danielbohannon/Invoke-Obfuscation"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1027",
                "name": "Obfuscated Files or Information",
                "reference": "https://attack.mitre.org/techniques/T1027/"
              },
              {
                "id": "T1140",
                "name": "Deobfuscate/Decode Files or Information",
                "reference": "https://attack.mitre.org/techniques/T1140/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'PowerShell Script Block Logging' logging policy must be enabled.\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nAdministrative Templates >\nWindows PowerShell >\nTurn on PowerShell Script Block Logging (Enable)\n```\n\nSteps to implement the logging policy via registry:\n\n```\nreg add \"hklm\\SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\ScriptBlockLogging\" /v EnableScriptBlockLogging /t REG_DWORD /d 1\n```\n",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "powershell.file.script_block_text",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "96d2fd47-7bb7-4a91-a558-076cf1b3bad6",
        "rule_id": "8025db49-c57c-4fc0-bd86-7ccd6d10a35a",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:02.386Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:29.986Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-windows.powershell*"
        ],
        "filters": [],
        "query": "event.category:process and host.os.type:windows and\n  powershell.file.script_block_text : (\n    \"[string]::join\" or\n    \"-Join\" or\n    \"[convert]::toint16\" or\n    \"[char][int]$_\" or\n    (\"ConvertTo-SecureString\" and \"PtrToStringAuto\") or\n    \".GetNetworkCredential().password\" or\n    \"-BXor\" or\n    (\"replace\" and \"char\") or\n    \"[array]::reverse\"\n  ) and\n  powershell.file.script_block_text : (\n    (\"$pSHoMe[\" and \"+$pSHoMe[\") or\n    (\"$ShellId[\" and \"+$ShellId[\") or\n    (\"$env:ComSpec[4\" and \"25]-Join\") or\n    ((\"Set-Variable\" or \"SV\" or \"Set-Item\") and \"OFS\") or\n    (\"*MDR*\" and \"Name[3,11,2]\") or\n    (\"$VerbosePreference\" and \"[1,3]+'X'-Join''\") or\n    (\"rahc\" or \"ekovin\" or \"gnirts\" or \"ecnereferpesobrev\" or \"ecalper\" or \"cepsmoc\" or \"dillehs\")\n  )",
        "language": "kuery"
      },
      {
        "name": "PowerShell Suspicious Payload Encoded and Compressed",
        "description": "Identifies the use of .NET functionality for decompression and base64 decoding combined in PowerShell scripts, which malware and security tools heavily use to deobfuscate payloads and load them directly in memory to bypass defenses.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating PowerShell Suspicious Payload Encoded and Compressed\n\nPowerShell is one of the main tools system administrators use for automation, report routines, and other tasks. This makes it available for use in various environments, and creates an attractive way for attackers to execute code.\n\nAttackers can embed compressed and encoded payloads in scripts to load directly into the memory without touching the disk. This strategy can circumvent string and file-based security protections.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Examine the script content that triggered the detection; look for suspicious DLL imports, collection or exfiltration capabilities, suspicious functions, encoded or compressed data, and other potentially malicious characteristics.\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Examine file or network events from the involved PowerShell process for suspicious behavior.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Evaluate whether the user needs to use PowerShell to complete tasks.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the script using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately outside engineering or IT business units. As long as the analyst did not identify malware or suspicious activity related to the user or host, this alert can be dismissed.\n\n### Related rules\n\n- PowerShell PSReflect Script - 56f2e9b5-4803-4e44-a0a4-a52dc79d57fe\n- Potential Process Injection via PowerShell - 2e29e96a-b67c-455a-afe4-de6183431d0d\n- Suspicious .NET Reflection via PowerShell - e26f042e-c590-4e82-8e05-41e81bd822ad\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Restrict PowerShell usage outside of IT and engineering business units using GPOs, AppLocker, Intune, or similar software.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 314,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Resources: Investigation Guide",
          "Data Source: PowerShell Logs"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Legitimate PowerShell Scripts which makes use of compression and encoding."
        ],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1027",
                "name": "Obfuscated Files or Information",
                "reference": "https://attack.mitre.org/techniques/T1027/"
              },
              {
                "id": "T1140",
                "name": "Deobfuscate/Decode Files or Information",
                "reference": "https://attack.mitre.org/techniques/T1140/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'PowerShell Script Block Logging' logging policy must be enabled.\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nAdministrative Templates >\nWindows PowerShell >\nTurn on PowerShell Script Block Logging (Enable)\n```\n\nSteps to implement the logging policy via registry:\n\n```\nreg add \"hklm\\SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\ScriptBlockLogging\" /v EnableScriptBlockLogging /t REG_DWORD /d 1\n```\n",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "powershell.file.script_block_text",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "5a99e25a-0308-4a56-bfb0-7ae06ebb123b",
        "rule_id": "81fe9dc6-a2d7-4192-a2d8-eed98afc766a",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:02.388Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:29.996Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-windows.powershell*"
        ],
        "filters": [
          {
            "meta": {
              "negate": true
            },
            "query": {
              "wildcard": {
                "file.path": {
                  "case_insensitive": true,
                  "value": "?:\\\\ProgramData\\\\Microsoft\\\\Windows Defender Advanced Threat Protection\\\\Downloads\\\\*"
                }
              }
            }
          }
        ],
        "query": "event.category:process and host.os.type:windows and\n  powershell.file.script_block_text : (\n    (\n      \"System.IO.Compression.DeflateStream\" or\n      \"System.IO.Compression.GzipStream\" or\n      \"IO.Compression.DeflateStream\" or\n      \"IO.Compression.GzipStream\"\n    ) and\n    FromBase64String\n  ) and\n  not user.id : \"S-1-5-18\"",
        "language": "kuery"
      },
      {
        "name": "Suspicious Windows Powershell Arguments",
        "description": "Identifies the execution of PowerShell with suspicious argument values. This behavior is often observed during malware installation leveraging PowerShell.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 202,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Data Source: System",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "920fd49f-c639-40ff-9799-3717e44e4100",
        "rule_id": "83bf249e-4348-47ba-9741-1202a09556ad",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:02.391Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:30.007Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n process.name : \"powershell.exe\" and \n  (\n   process.command_line :\n        (\n          \"*^*^*^*^*^*^*^*^*^*\",\n          \"*`*`*`*`*\",\n          \"*+*+*+*+*+*+*\",\n          \"*[char[]](*)*-join*\",\n          \"*Base64String*\",\n          \"*[*Convert]*\",\n          \"*.Compression.*\",\n          \"*-join($*\",\n          \"*.replace*\",\n          \"*MemoryStream*\",\n          \"*WriteAllBytes*\",\n          \"* -enc *\",\n          \"* -ec *\",\n          \"* /e *\",\n          \"* /enc *\",\n          \"* /ec *\",\n          \"*WebClient*\",\n          \"*DownloadFile*\",\n          \"*DownloadString*\",\n          \"* iex*\",\n          \"* iwr*\",\n          \"*Reflection.Assembly*\",\n          \"*Assembly.GetType*\",\n          \"*$env:temp\\\\*start*\",\n          \"*powercat*\",\n          \"*nslookup -q=txt*\",\n          \"*$host.UI.PromptForCredential*\",\n          \"*Net.Sockets.TCPClient*\",\n          \"*curl *;Start*\",\n          \"powershell.exe \\\"<#*\",\n          \"*ssh -p *\",\n          \"*http*|iex*\",\n          \"*@SSL\\\\DavWWWRoot\\\\*.ps1*\",\n          \"*.lnk*.Seek(0x*\",\n          \"*[string]::join(*\",\n          \"*[Array]::Reverse($*\",\n          \"* hidden $(gc *\",\n          \"*=wscri& set*\",\n          \"*http'+'s://*\",\n          \"*.content|i''Ex*\",\n          \"*//:sptth*\",\n          \"*//:ptth*\",\n          \"*$*=Get-Content*AppData*.SubString(*$*\",\n          \"*=cat *AppData*.substring(*);*$*\"\n        ) or\n\n      (process.args : \"-c\" and process.args : \"&{'*\") or\n\n      (process.args : \"-Outfile\" and process.args : \"Start*\") or\n\n      (process.args : \"-bxor\" and process.args : \"0x*\") or\n\n      process.args : \"$*$*;set-alias\" or\n\n      (process.parent.name : (\"explorer.exe\", \"cmd.exe\") and \n       process.command_line : (\"*-encodedCommand*\", \"*Invoke-webrequest*\", \"*WebClient*\", \"*Reflection.Assembly*\"))\n  )",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-windows.*",
          "logs-system.security*",
          "logs-windows.sysmon_operational-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-m365_defender.event-*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Microsoft Exchange Transport Agent Install Script",
        "description": "Identifies the use of Cmdlets and methods related to Microsoft Exchange Transport Agents install. Adversaries may leverage malicious Microsoft Exchange Transport Agents to execute tasks in response to adversary-defined criteria, establishing persistence.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 107,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Data Source: PowerShell Logs",
          "Rule Type: BBR"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1505",
                "name": "Server Software Component",
                "reference": "https://attack.mitre.org/techniques/T1505/",
                "subtechnique": [
                  {
                    "id": "T1505.002",
                    "name": "Transport Agent",
                    "reference": "https://attack.mitre.org/techniques/T1505/002/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'PowerShell Script Block Logging' logging policy must be enabled.\nSteps to implement the logging policy with Advanced Audit Configuration:\n```\nComputer Configuration >\nAdministrative Templates >\nWindows PowerShell >\nTurn on PowerShell Script Block Logging (Enable)\n```\nSteps to implement the logging policy via registry:\n```\nreg add \"hklm\\SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\ScriptBlockLogging\" /v EnableScriptBlockLogging /t REG_DWORD /d 1\n```\n",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "powershell.file.script_block_text",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "35861d86-fecf-44e4-b97e-f7a4b1af0657",
        "rule_id": "846fe13f-6772-4c83-bd39-9d16d4ad1a81",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:02.393Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:30.012Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-windows.powershell*"
        ],
        "filters": [
          {
            "meta": {
              "negate": true
            },
            "query": {
              "wildcard": {
                "file.path": {
                  "case_insensitive": true,
                  "value": "?:\\\\Users\\\\*\\\\AppData\\\\Roaming\\\\Microsoft\\\\Exchange\\\\RemotePowerShell\\\\*"
                }
              }
            }
          },
          {
            "meta": {
              "negate": true
            },
            "query": {
              "wildcard": {
                "file.path": {
                  "case_insensitive": true,
                  "value": "?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\tmp_????????.???\\\\tmp_????????.???.ps?1"
                }
              }
            }
          },
          {
            "meta": {
              "negate": true
            },
            "query": {
              "wildcard": {
                "file.path": {
                  "case_insensitive": true,
                  "value": "?:\\\\Windows\\\\TEMP\\\\tmp_????????.???\\\\tmp_????????.???.ps?1"
                }
              }
            }
          },
          {
            "meta": {
              "negate": true
            },
            "query": {
              "wildcard": {
                "file.path": {
                  "case_insensitive": true,
                  "value": "?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\*\\\\tmp_????????.???\\\\tmp_????????.???.ps?1"
                }
              }
            }
          }
        ],
        "query": "event.category: \"process\" and host.os.type:windows and\n  powershell.file.script_block_text : (\n    (\n    \"Install-TransportAgent\" or\n    \"Enable-TransportAgent\"\n    )\n  ) and\n  not user.id : \"S-1-5-18\" and\n  not powershell.file.script_block_text : (\n    \"'Install-TransportAgent', 'Invoke-MonitoringProbe', 'Mount-Database', 'Move-ActiveMailboxDatabase',\" or\n    \"'Enable-TransportAgent', 'Enable-TransportRule', 'Export-ActiveSyncLog', 'Export-AutoDiscoverConfig',\" or\n    (\"scriptCmd.GetSteppablePipeline\" and \"ForwardHelpTargetName Install-TransportAgent\")\n  )",
        "language": "kuery"
      },
      {
        "name": "Enumerating Domain Trusts via NLTEST.EXE",
        "description": "Identifies the use of nltest.exe for domain trust discovery purposes. Adversaries may use this command-line utility to enumerate domain trusts and gain insight into trust relationships, as well as the state of Domain Controller (DC) replication in a Microsoft Windows NT Domain.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Enumerating Domain Trusts via NLTEST.EXE\n\nActive Directory (AD) domain trusts define relationships between domains within a Windows AD environment. In this setup, a \"trusting\" domain permits users from a \"trusted\" domain to access resources. These trust relationships can be configurable as one-way, two-way, transitive, or non-transitive, enabling controlled access and resource sharing across domains.\n\nThis rule identifies the usage of the `nltest.exe` utility to enumerate domain trusts. Attackers can use this information to enable the next actions in a target environment, such as lateral movement.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n\n### False positive analysis\n\n- Discovery activities are not inherently malicious if they occur in isolation and are done within the user business context (e.g., an administrator in this context). As long as the analyst did not identify suspicious activity related to the user or host, such alerts can be dismissed.\n\n### Related rules\n\n- Enumerating Domain Trusts via DSQUERY.EXE - 06a7a03c-c735-47a6-a313-51c354aef6c3\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Restrict PowerShell usage outside of IT and engineering business units using GPOs, AppLocker, Intune, or similar software.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 214,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Data Source: Elastic Endgame",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Domain administrators may use this command-line utility for legitimate information gathering purposes, but it is not common for environments with Windows Server 2012 and newer."
        ],
        "references": [
          "https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/cc731935(v=ws.11)",
          "https://redcanary.com/blog/how-one-hospital-thwarted-a-ryuk-ransomware-outbreak/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1018",
                "name": "Remote System Discovery",
                "reference": "https://attack.mitre.org/techniques/T1018/"
              },
              {
                "id": "T1482",
                "name": "Domain Trust Discovery",
                "reference": "https://attack.mitre.org/techniques/T1482/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "d3fc6602-16ad-4c7b-a641-bc2f7ad95fe8",
        "rule_id": "84da2554-e12a-11ec-b896-f661ea17fbcd",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:02.396Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:30.017Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n    process.name : \"nltest.exe\" and process.args : (\n        \"/DCLIST:*\", \"/DCNAME:*\", \"/DSGET*\",\n        \"/LSAQUERYFTI:*\", \"/PARENTDOMAIN\",\n        \"/DOMAIN_TRUSTS\", \"/BDC_QUERY:*\"\n        ) and \nnot process.parent.name : \"PDQInventoryScanner.exe\" and \nnot user.id in (\"S-1-5-18\", \"S-1-5-19\", \"S-1-5-20\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Enumeration of Administrator Accounts",
        "description": "Identifies instances of lower privilege accounts enumerating Administrator accounts or groups using built-in Windows tools.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Enumeration of Administrator Accounts\n\nAfter successfully compromising an environment, attackers may try to gain situational awareness to plan their next steps. This can happen by running commands to enumerate network resources, users, connections, files, and installed security software.\n\nThis rule looks for the execution of the `net` and `wmic` utilities to enumerate administrator-related users or groups in the domain and local machine scope. Attackers can use this information to plan their next steps of the attack, such as mapping targets for credential compromise and other post-exploitation activities.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate any abnormal account behavior, such as command executions, file creations or modifications, and network connections.\n\n### False positive analysis\n\n- Discovery activities are not inherently malicious if they occur in isolation. As long as the analyst did not identify suspicious activity related to the user or host, such alerts can be dismissed.\n\n### Related rules\n\n- AdFind Command Activity - eda499b8-a073-4e35-9733-22ec71f57f3a\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 215,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1069",
                "name": "Permission Groups Discovery",
                "reference": "https://attack.mitre.org/techniques/T1069/",
                "subtechnique": [
                  {
                    "id": "T1069.001",
                    "name": "Local Groups",
                    "reference": "https://attack.mitre.org/techniques/T1069/001/"
                  },
                  {
                    "id": "T1069.002",
                    "name": "Domain Groups",
                    "reference": "https://attack.mitre.org/techniques/T1069/002/"
                  }
                ]
              },
              {
                "id": "T1087",
                "name": "Account Discovery",
                "reference": "https://attack.mitre.org/techniques/T1087/",
                "subtechnique": [
                  {
                    "id": "T1087.001",
                    "name": "Local Account",
                    "reference": "https://attack.mitre.org/techniques/T1087/001/"
                  },
                  {
                    "id": "T1087.002",
                    "name": "Domain Account",
                    "reference": "https://attack.mitre.org/techniques/T1087/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "94f577c8-053c-45fe-b581-4979853267f1",
        "rule_id": "871ea072-1b71-4def-b016-6278b505138d",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:02.399Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:30.023Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n(\n  (\n    (\n      (process.name : \"net.exe\" or ?process.pe.original_file_name == \"net.exe\") or\n      ((process.name : \"net1.exe\" or ?process.pe.original_file_name == \"net1.exe\") and not process.parent.name : \"net.exe\")\n    ) and\n    process.args : (\"group\", \"user\", \"localgroup\") and\n    process.args : (\"*admin*\", \"Domain Admins\", \"Remote Desktop Users\", \"Enterprise Admins\", \"Organization Management\")\n    and not process.args : (\"/add\", \"/delete\")\n  ) or\n  (\n    (process.name : \"wmic.exe\" or ?process.pe.original_file_name == \"wmic.exe\") and\n    process.args : (\"group\", \"useraccount\")\n  )\n) and not user.id : (\"S-1-5-18\", \"S-1-5-19\", \"S-1-5-20\")",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "winlogbeat-*",
          "logs-windows.forwarded*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Enable Host Network Discovery via Netsh",
        "description": "Identifies use of the netsh.exe program to enable host discovery via the network. Attackers can use this command-line tool to weaken the host firewall settings.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Enable Host Network Discovery via Netsh\n\nThe Windows Defender Firewall is a native component that provides host-based, two-way network traffic filtering for a device and blocks unauthorized network traffic flowing into or out of the local device.\n\nAttackers can enable Network Discovery on the Windows firewall to find other systems present in the same network. Systems with this setting enabled will communicate with other systems using broadcast messages, which can be used to identify targets for lateral movement. This rule looks for the setup of this setting using the netsh utility.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Inspect the host for suspicious or abnormal behavior in the alert timeframe.\n\n### False positive analysis\n\n- This mechanism can be used legitimately. Analysts can dismiss the alert if the Administrator is aware of the activity and there are justifications for this configuration.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Disable Network Discovery:\n    - Using netsh: `netsh advfirewall firewall set rule group=\"Network Discovery\" new enable=No`\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Review the privileges assigned to the involved users to ensure that the least privilege principle is being followed.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 311,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Host Windows Firewall planned system administration changes."
        ],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.004",
                    "name": "Disable or Modify System Firewall",
                    "reference": "https://attack.mitre.org/techniques/T1562/004/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "5a8a1461-454d-4b48-a0fe-4286e2135d17",
        "rule_id": "8b4f0816-6a65-4630-86a6-c21c179c0d09",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:02.402Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:30.067Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\nprocess.name : \"netsh.exe\" and\nprocess.args : (\"firewall\", \"advfirewall\") and process.args : \"group=Network Discovery\" and process.args : \"enable=Yes\"",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Unusual Child Process of dns.exe",
        "description": "Identifies an unexpected process spawning from dns.exe, the process responsible for Windows DNS server services, which may indicate activity related to remote code execution or other forms of exploitation.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Unusual Child Process of dns.exe\n\nSIGRed (CVE-2020-1350) is a wormable, critical vulnerability in the Windows DNS server that affects Windows Server versions 2003 to 2019 and can be triggered by a malicious DNS response. Because the service is running in elevated privileges (SYSTEM), an attacker that successfully exploits it is granted Domain Administrator rights. This can effectively compromise the entire corporate infrastructure.\n\nThis rule looks for unusual children of the `dns.exe` process, which can indicate the exploitation of the SIGRed or a similar remote code execution vulnerability in the DNS server.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes.\n  - Any suspicious or abnormal child process spawned from dns.exe should be carefully reviewed and investigated. It's impossible to predict what an adversary may deploy as the follow-on process after the exploit, but built-in discovery/enumeration utilities should be top of mind (`whoami.exe`, `netstat.exe`, `systeminfo.exe`, `tasklist.exe`).\n  - Built-in Windows programs that contain capabilities used to download and execute additional payloads should also be considered. This is not an exhaustive list, but ideal candidates to start out would be: `mshta.exe`, `powershell.exe`, `regsvr32.exe`, `rundll32.exe`, `wscript.exe`, `wmic.exe`.\n  - If a denial-of-service (DoS) exploit is successful and DNS Server service crashes, be mindful of potential child processes related to `werfault.exe` occurring.\n- Investigate any abnormal behavior by the subject process such as network connections, registry or file modifications, and any spawned child processes.\n- Investigate other alerts associated with the host during the past 48 hours.\n- Check whether the server is vulnerable to CVE-2020-1350.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Reimage the host operating system or restore the compromised server to a clean state.\n- Install the latest patches on systems that run Microsoft DNS Server.\n- Consider the implementation of a patch management system, such as the Windows Server Update Services (WSUS).\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Review the privileges assigned to the user to ensure that the least privilege principle is being followed.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 313,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Lateral Movement",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Use Case: Vulnerability",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Werfault.exe will legitimately spawn when dns.exe crashes, but the DNS service is very stable and so this is a low occurring event. Denial of Service (DoS) attempts by intentionally crashing the service will also cause werfault.exe to spawn."
        ],
        "references": [
          "https://research.checkpoint.com/2020/resolving-your-way-into-domain-admin-exploiting-a-17-year-old-bug-in-windows-dns-servers/",
          "https://msrc-blog.microsoft.com/2020/07/14/july-2020-security-update-cve-2020-1350-vulnerability-in-windows-domain-name-system-dns-server/",
          "https://github.com/maxpl0it/CVE-2020-1350-DoS",
          "https://www.elastic.co/security-labs/detection-rules-for-sigred-vulnerability"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1210",
                "name": "Exploitation of Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1210/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "8730872c-3053-42af-a404-8d1f81f9ad8f",
        "rule_id": "8c37dc0e-e3ac-4c97-8aa0-cf6a9122de45",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:02.413Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:30.072Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and process.parent.name : \"dns.exe\" and\n  not process.name : \"conhost.exe\"",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Potential WSUS Abuse for Lateral Movement",
        "description": "Identifies a potential Windows Server Update Services (WSUS) abuse to execute psexec to enable for lateral movement. WSUS is limited to executing Microsoft signed binaries, which limits the executables that can be used to tools published by Microsoft.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 205,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Lateral Movement",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: System",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.thehacker.recipes/a-d/movement/mitm-and-coerced-authentications/wsus-spoofing"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1210",
                "name": "Exploitation of Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1210/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "9274ed1c-8126-45ee-80a3-6581a9e05657",
        "rule_id": "8e2485b6-a74f-411b-bf7f-38b819f3a846",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:02.416Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:30.476Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and process.parent.name : \"wuauclt.exe\" and\nprocess.executable : (\n    \"?:\\\\Windows\\\\SoftwareDistribution\\\\Download\\\\Install\\\\*\",\n    \"\\\\Device\\\\HarddiskVolume?\\\\Windows\\\\SoftwareDistribution\\\\Download\\\\Install\\\\*\"\n) and\n(process.name : \"psexec64.exe\" or ?process.pe.original_file_name : \"psexec.c\")",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-m365_defender.event-*",
          "logs-system.security-*",
          "winlogbeat-*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "PowerShell Suspicious Script with Clipboard Retrieval Capabilities",
        "description": "Detects PowerShell scripts that can get the contents of the clipboard, which attackers can abuse to retrieve sensitive information like credentials, messages, etc.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating PowerShell Suspicious Script with Clipboard Retrieval Capabilities\n\nPowerShell is one of the main tools system administrators use for automation, report routines, and other tasks. This makes it available for use in various environments, and creates an attractive way for attackers to execute code.\n\nAttackers can abuse PowerShell capabilities to get the contents of the clipboard with the goal of stealing credentials and other valuable information, such as credit card data and confidential conversations.\n\n#### Possible investigation steps\n\n- Examine the script content that triggered the detection; look for suspicious DLL imports, collection or exfiltration capabilities, suspicious functions, encoded or compressed data, and other potentially malicious characteristics.\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Examine file or network events from the involved PowerShell process for suspicious behavior.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Evaluate whether the user needs to use PowerShell to complete tasks.\n- Determine whether the script stores the captured data locally.\n- Investigate whether the script contains exfiltration capabilities and identify the exfiltration server.\n- Assess network data to determine if the host communicated with the exfiltration server.\n\n### False positive analysis\n\n- Regular users are unlikely to use scripting utilities to capture contents of the clipboard, making false positives unlikely. In the case of authorized benign true positives (B-TPs), exceptions can be added.\n\n### Related rules\n\n- PowerShell Keylogging Script - bd2c86a0-8b61-4457-ab38-96943984e889\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Prioritize the response if this alert involves key executives or potentially valuable targets for espionage.\n- Restrict PowerShell usage outside of IT and engineering business units using GPOs, AppLocker, Intune, or similar software.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 210,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Collection",
          "Data Source: PowerShell Logs",
          "Resources: Investigation Guide"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.management/get-clipboard",
          "https://github.com/EmpireProject/Empire/blob/master/data/module_source/collection/Get-ClipboardContents.ps1"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0009",
              "name": "Collection",
              "reference": "https://attack.mitre.org/tactics/TA0009/"
            },
            "technique": [
              {
                "id": "T1115",
                "name": "Clipboard Data",
                "reference": "https://attack.mitre.org/techniques/T1115/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'PowerShell Script Block Logging' logging policy must be enabled.\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nAdministrative Templates >\nWindows PowerShell >\nTurn on PowerShell Script Block Logging (Enable)\n```\n\nSteps to implement the logging policy via registry:\n\n```\nreg add \"hklm\\SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\ScriptBlockLogging\" /v EnableScriptBlockLogging /t REG_DWORD /d 1\n```\n",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "powershell.file.script_block_text",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "fc365efb-e6ba-46b4-8ca3-b4a70907a363",
        "rule_id": "92984446-aefb-4d5e-ad12-598042ca80ba",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:02.419Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:30.495Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-windows.powershell*"
        ],
        "filters": [
          {
            "meta": {
              "negate": true
            },
            "query": {
              "wildcard": {
                "file.path": {
                  "case_insensitive": true,
                  "value": "?:\\\\program?files\\\\powershell\\\\?\\\\Modules\\\\*.psd1"
                }
              }
            }
          },
          {
            "meta": {
              "negate": true
            },
            "query": {
              "wildcard": {
                "file.path": {
                  "case_insensitive": true,
                  "value": "?:\\\\Windows\\\\system32\\\\WindowsPowerShell\\\\v1.0\\\\Modules\\\\*.psd1"
                }
              }
            }
          },
          {
            "meta": {
              "negate": true
            },
            "query": {
              "wildcard": {
                "file.path": {
                  "case_insensitive": true,
                  "value": "?:\\\\Program?Files\\\\WindowsPowerShell\\\\Modules\\\\*.ps?1"
                }
              }
            }
          }
        ],
        "query": "event.category:process and host.os.type:windows and\n  (powershell.file.script_block_text : (\n    \"Windows.Clipboard\" or\n    \"Windows.Forms.Clipboard\" or\n    \"Windows.Forms.TextBox\"\n   ) and\n   powershell.file.script_block_text : (\n    \"]::GetText\" or\n    \".Paste()\"\n  )) or powershell.file.script_block_text : \"Get-Clipboard\" and\n  not powershell.file.script_block_text : (\n    \"sentinelbreakpoints\" and \"Set-PSBreakpoint\" and \"PowerSploitIndicators\"\n  ) and\n  not user.id : \"S-1-5-18\" and\n  not (\n    file.path : C\\:\\\\Program?Files\\\\WindowsPowerShell\\\\*Modules*.ps1 and\n    file.name : (\"Convert-ExcelRangeToImage.ps1\" or \"Read-Clipboard.ps1\")\n  )",
        "language": "kuery"
      },
      {
        "name": "Group Policy Discovery via Microsoft GPResult Utility",
        "description": "Detects the usage of gpresult.exe to query group policy objects. Attackers may query group policy objects during the reconnaissance phase after compromising a system to gain a better understanding of the active directory environment and possible methods to escalate privileges or move laterally.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Group Policy Discovery via Microsoft GPResult Utility\n\nGroup Policy is a Windows feature that allows administrators to manage and configure settings for users and computers in an Active Directory environment. The Microsoft GPResult utility (gpresult.exe) is a command-line tool used to query and display Group Policy Objects (GPOs) applied to a system. Attackers may abuse this utility to gain insights into the active directory environment and identify potential privilege escalation or lateral movement opportunities.\n\nThe detection rule 'Group Policy Discovery via Microsoft GPResult Utility' is designed to identify the usage of gpresult.exe with specific arguments (\"/z\", \"/v\", \"/r\", \"/x\") that are commonly used by adversaries during the reconnaissance phase to perform group policy discovery.\n\n#### Possible investigation steps\n\n- Review the alert details to understand the context of the gpresult.exe usage, such as the user account, system, and time of execution.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate any abnormal account behavior, such as command executions, file creations or modifications, and network connections.\n- Inspect the host for suspicious or abnormal behavior in the alert timeframe.\n- Validate the activity is not related to planned patches, updates, network administrator activity, or legitimate software installations.\n- Investigate any abnormal behavior by the parent process, such as network connections, registry or file modifications, and any other spawned child processes.\n\n### False positive analysis\n\n- Discovery activities are not inherently malicious if they occur in isolation. As long as the analyst did not identify suspicious activity related to the user or host, such alerts can be dismissed.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Reimage the host operating system or restore the compromised files to clean versions.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection via the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 210,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1615",
                "name": "Group Policy Discovery",
                "reference": "https://attack.mitre.org/techniques/T1615/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "96458aac-7839-404a-a84b-ac445390a107",
        "rule_id": "94a401ba-4fa2-455c-b7ae-b6e037afc0b7",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:02.422Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:30.530Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n(process.name: \"gpresult.exe\" or ?process.pe.original_file_name == \"gprslt.exe\") and process.args: (\"/z\", \"/v\", \"/r\", \"/x\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "High Number of Process and/or Service Terminations",
        "description": "This rule identifies a high number (10) of process terminations (stop, delete, or suspend) from the same host within a short time period.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating High Number of Process and/or Service Terminations\n\nAttackers can stop services and kill processes for a variety of purposes. For example, they can stop services associated with business applications and databases to release the lock on files used by these applications so they may be encrypted, or stop security and backup solutions, etc.\n\nThis rule identifies a high number (10) of service and/or process terminations (stop, delete, or suspend) from the same host within a short time period.\n\n#### Possible investigation steps\n\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Check if any files on the host machine have been encrypted.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further destructive behavior, which is commonly associated with this activity.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Reimage the host operating system or restore it to the operational state.\n- If any other destructive action was identified on the host, it is recommended to prioritize the investigation and look for ransomware preparation and execution activities.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 212,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Impact",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/security-labs/luna-ransomware-attack-pattern"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0040",
              "name": "Impact",
              "reference": "https://attack.mitre.org/tactics/TA0040/"
            },
            "technique": [
              {
                "id": "T1489",
                "name": "Service Stop",
                "reference": "https://attack.mitre.org/techniques/T1489/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "6802ec71-f459-4b9c-9205-87198a914532",
        "rule_id": "035889c4-2686-4583-a7df-67f89c292f2c",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:02.425Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:23.216Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "threshold",
        "query": "event.category:process and host.os.type:windows and event.type:start and process.name:(net.exe or sc.exe or taskkill.exe) and\n process.args:(stop or pause or delete or \"/PID\" or \"/IM\" or \"/T\" or \"/F\" or \"/t\" or \"/f\" or \"/im\" or \"/pid\") and\n not process.parent.name:osquerybeat.exe",
        "threshold": {
          "field": [
            "host.id"
          ],
          "value": 10
        },
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.*",
          "endgame-*",
          "logs-system.security*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Potential Escalation via Vulnerable MSI Repair",
        "description": "Identifies when a browser process navigates to the Microsoft Help page followed by spawning an elevated process. This may indicate a successful exploitation for privilege escalation abusing a vulnerable Windows Installer repair setup.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 202,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Microsoft Defender for Endpoint"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://sec-consult.com/blog/detail/msi-installer-repair-to-system-a-detailed-journey/",
          "https://msrc.microsoft.com/update-guide/en-US/advisory/CVE-2024-38014"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1068",
                "name": "Exploitation for Privilege Escalation",
                "reference": "https://attack.mitre.org/techniques/T1068/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1218",
                "name": "System Binary Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1218/",
                "subtechnique": [
                  {
                    "id": "T1218.007",
                    "name": "Msiexec",
                    "reference": "https://attack.mitre.org/techniques/T1218/007/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.domain",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "f000cdf3-379a-4cb8-92ee-c3be7281a108",
        "rule_id": "043d80a3-c49e-43ef-9c72-1088f0c7b278",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:02.428Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:23.187Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where event.type == \"start\" and host.os.type == \"windows\" and\n user.domain : (\"NT AUTHORITY\", \"AUTORITE NT\", \"AUTORIDADE NT\") and\n process.parent.name : (\"chrome.exe\", \"msedge.exe\", \"brave.exe\", \"whale.exe\", \"browser.exe\", \"dragon.exe\", \"vivaldi.exe\",\n                        \"opera.exe\", \"iexplore\", \"firefox.exe\", \"waterfox.exe\", \"iexplore.exe\", \"tor.exe\", \"safari.exe\") and\n process.parent.command_line : \"*go.microsoft.com*\"",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "endgame-*",
          "logs-endpoint.events.process-*",
          "logs-windows.sysmon_operational-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-m365_defender.event-*"
        ],
        "filters": []
      },
      {
        "name": "Microsoft IIS Service Account Password Dumped",
        "description": "Identifies the Internet Information Services (IIS) command-line tool, AppCmd, being used to list passwords. An attacker with IIS web server access via a web shell can decrypt and dump the IIS AppPool service account password using AppCmd.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 214,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Rule Type: BBR",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://blog.netspi.com/decrypting-iis-passwords-to-break-out-of-the-dmz-part-1/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1003",
                "name": "OS Credential Dumping",
                "reference": "https://attack.mitre.org/techniques/T1003/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "70afa5dc-1ecb-40f6-8200-a3d4d34e212f",
        "rule_id": "0564fb9d-90b9-4234-a411-82a546dc1343",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:02.430Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:23.198Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n   (process.name : \"appcmd.exe\" or ?process.pe.original_file_name == \"appcmd.exe\") and\n   process.args : \"list\" and process.args : \"/text*\"",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.*",
          "endgame-*",
          "logs-system.security*"
        ],
        "filters": []
      },
      {
        "name": "Remote System Discovery Commands",
        "description": "Discovery of remote system information using built-in commands, which may be used to move laterally.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Remote System Discovery Commands\n\nAfter successfully compromising an environment, attackers may try to gain situational awareness to plan their next steps. This can happen by running commands to enumerate network resources, users, connections, files, and installed security software.\n\nThis rule looks for the execution of the `arp` or `nbstat` utilities to enumerate remote systems in the environment, which is useful for attackers to identify lateral movement targets.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate any abnormal account behavior, such as command executions, file creations or modifications, and network connections.\n\n### False positive analysis\n\n- Discovery activities are not inherently malicious if they occur in isolation. As long as the analyst did not identify suspicious activity related to the user or host, such alerts can be dismissed.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "building_block_type": "default",
        "output_index": "",
        "version": 214,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame",
          "Rule Type: BBR"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1016",
                "name": "System Network Configuration Discovery",
                "reference": "https://attack.mitre.org/techniques/T1016/"
              },
              {
                "id": "T1018",
                "name": "Remote System Discovery",
                "reference": "https://attack.mitre.org/techniques/T1018/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "51f61aeb-a12d-4deb-ab00-c355b7fa7473",
        "rule_id": "0635c542-1b96-4335-9b47-126582d2c19a",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:02.433Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:23.227Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  ((process.name : \"nbtstat.exe\" and process.args : (\"-n\", \"-s\")) or\n  (process.name : \"arp.exe\" and process.args : \"-a\") or\n  (process.name : \"nltest.exe\" and process.args : (\"/dclist\", \"/dsgetdc\")) or\n  (process.name : \"nslookup.exe\" and process.args : \"*_ldap._tcp.dc.*\") or\n  (process.name: (\"dsquery.exe\", \"dsget.exe\") and process.args: \"subnet\") or\n  ((((process.name : \"net.exe\" or process.pe.original_file_name == \"net.exe\") or\n    ((process.name : \"net1.exe\" or process.pe.original_file_name == \"net1.exe\") and not \n       process.parent.name : \"net.exe\")) and \n       process.args : \"group\" and process.args : \"/domain\" and not process.args : \"/add\"))) and\n  not\n  (\n    (\n      process.name : \"arp.exe\" and\n      process.parent.executable : (\n        \"?:\\\\ProgramData\\\\CentraStage\\\\AEMAgent\\\\AEMAgent.exe\",\n        \"?:\\\\Program Files (x86)\\\\Citrix\\\\Workspace Environment Management Agent\\\\Citrix.Wem.Agent.Service.exe\",\n        \"?:\\\\Program Files (x86)\\\\Lansweeper\\\\Service\\\\LansweeperService.exe\"\n      )\n    )\n  )",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "winlogbeat-*",
          "logs-windows.*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "Enumerating Domain Trusts via DSQUERY.EXE",
        "description": "Identifies the use of dsquery.exe for domain trust discovery purposes. Adversaries may use this command-line utility to enumerate trust relationships that may be used for Lateral Movement opportunities in Windows multi-domain forest environments.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Enumerating Domain Trusts via DSQUERY.EXE\n\nActive Directory (AD) domain trusts define relationships between domains within a Windows AD environment. In this setup, a \"trusting\" domain permits users from a \"trusted\" domain to access resources. These trust relationships can be configurable as one-way, two-way, transitive, or non-transitive, enabling controlled access and resource sharing across domains.\n\nThis rule identifies the usage of the `dsquery.exe` utility to enumerate domain trusts. Attackers can use this information to enable the next actions in a target environment, such as lateral movement.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n\n### False positive analysis\n\n- Discovery activities are not inherently malicious if they occur in isolation and are done within the user business context (e.g., an administrator in this context). As long as the analyst did not identify suspicious activity related to the user or host, such alerts can be dismissed.\n\n### Related rules\n\n- Enumerating Domain Trusts via NLTEST.EXE - 84da2554-e12a-11ec-b896-f661ea17fbcd\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Restrict PowerShell usage outside of IT and engineering business units using GPOs, AppLocker, Intune, or similar software.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 210,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Data Source: Elastic Endgame",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Domain administrators may use this command-line utility for legitimate information gathering purposes."
        ],
        "references": [
          "https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/cc732952(v=ws.11)",
          "https://posts.specterops.io/a-guide-to-attacking-domain-trusts-971e52cb2944"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1018",
                "name": "Remote System Discovery",
                "reference": "https://attack.mitre.org/techniques/T1018/"
              },
              {
                "id": "T1482",
                "name": "Domain Trust Discovery",
                "reference": "https://attack.mitre.org/techniques/T1482/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "f96b40e3-8439-4d9d-af8a-bab5e486777b",
        "rule_id": "06a7a03c-c735-47a6-a313-51c354aef6c3",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:02.655Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:23.211Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n    (process.name : \"dsquery.exe\" or ?process.pe.original_file_name: \"dsquery.exe\") and \n    process.args : \"*objectClass=trustedDomain*\"",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Potential Evasion via Filter Manager",
        "description": "The Filter Manager Control Program (fltMC.exe) binary may be abused by adversaries to unload a filter driver and evade defenses.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Potential Evasion via Filter Manager\n\nA file system filter driver, or minifilter, is a specialized type of filter driver designed to intercept and modify I/O requests sent to a file system or another filter driver. Minifilters are used by a wide range of security software, including EDR, antivirus, backup agents, encryption products, etc.\n\nAttackers may try to unload minifilters to avoid protections such as malware detection, file system monitoring, and behavior-based detections.\n\nThis rule identifies the attempt to unload a minifilter using the `fltmc.exe` command-line utility, a tool used to manage and query the filter drivers loaded on Windows systems.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Examine the command line event to identify the target driver.\n  - Identify the minifilter's role in the environment and if it is security-related. Microsoft provides a [list](https://learn.microsoft.com/en-us/windows-hardware/drivers/ifs/allocated-altitudes) of allocated altitudes that may provide more context, such as the manufacturer.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Observe and collect information about the following activities in the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n\n### False positive analysis\n\n- This mechanism can be used legitimately. Analysts can dismiss the alert if the administrator is aware of the activity and there are justifications for the action.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 213,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Endgame",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.001",
                    "name": "Disable or Modify Tools",
                    "reference": "https://attack.mitre.org/techniques/T1562/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "7614b6da-78da-4f8f-83ce-ca3bfcee1e8f",
        "rule_id": "06dceabf-adca-48af-ac79-ffdf4c3b1e9a",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:02.658Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:23.233Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.name : \"fltMC.exe\" and process.args : \"unload\" and\n  not\n  (\n    (\n      process.executable : \"?:\\\\Program Files (x86)\\\\ManageEngine\\\\UEMS_Agent\\\\bin\\\\DCFAService64.exe\" and\n      process.args : (\"DFMFilter\", \"DRMFilter\")\n    ) or\n    (\n      process.executable : \"?:\\\\Windows\\\\SysWOW64\\\\msiexec.exe\" and\n      process.args : (\"BrFilter_*\", \"BrCow_*\") and\n      user.id : \"S-1-5-18\"\n    )\n  )",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*"
        ],
        "filters": []
      },
      {
        "name": "System Time Discovery",
        "description": "Detects the usage of commonly used system time discovery techniques, which attackers may use during the reconnaissance phase after compromising a system.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 110,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame",
          "Rule Type: BBR",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1124",
                "name": "System Time Discovery",
                "reference": "https://attack.mitre.org/techniques/T1124/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "8eae2bb6-a643-4449-b14c-38111b852f32",
        "rule_id": "06568a02-af29-4f20-929c-f3af281e41aa",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:02.662Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:23.205Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n(\n (\n    (process.name: \"net.exe\" or (process.name : \"net1.exe\" and not process.parent.name : \"net.exe\")) and \n    process.args : \"time\" and not process.args : \"/set\"\n ) or \n (process.name: \"w32tm.exe\" and process.args: \"/tz\") or \n (process.name: \"tzutil.exe\" and process.args: \"/g\")\n) and not user.id : (\"S-1-5-18\", \"S-1-5-19\", \"S-1-5-20\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.*",
          "endgame-*",
          "logs-system.security*"
        ],
        "filters": []
      },
      {
        "name": "First Time Seen Removable Device",
        "description": "Identifies newly seen removable devices by device friendly name using registry modification events. While this activity is not inherently malicious, analysts can use those events to aid monitoring for data exfiltration over those devices.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 209,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Initial Access",
          "Tactic: Exfiltration",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: SentinelOne"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://winreg-kb.readthedocs.io/en/latest/sources/system-keys/USB-storage.html",
          "https://learn.microsoft.com/en-us/windows-hardware/drivers/usbcon/usb-device-specific-registry-settings"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1091",
                "name": "Replication Through Removable Media",
                "reference": "https://attack.mitre.org/techniques/T1091/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0010",
              "name": "Exfiltration",
              "reference": "https://attack.mitre.org/tactics/TA0010/"
            },
            "technique": [
              {
                "id": "T1052",
                "name": "Exfiltration Over Physical Medium",
                "reference": "https://attack.mitre.org/techniques/T1052/",
                "subtechnique": [
                  {
                    "id": "T1052.001",
                    "name": "Exfiltration over USB",
                    "reference": "https://attack.mitre.org/techniques/T1052/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.value",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "ce19775f-b0c7-48bf-a358-5bec6cdde0c0",
        "rule_id": "0859355c-0f08-4b43-8ff5-7d2a4789fc08",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:05.296Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:23.244Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "event.category:\"registry\" and host.os.type:\"windows\" and registry.value:\"FriendlyName\" and registry.path:*USBSTOR*",
        "new_terms_fields": [
          "registry.path"
        ],
        "history_window_start": "now-7d",
        "index": [
          "logs-endpoint.events.registry-*",
          "winlogbeat-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Remote Desktop Enabled in Windows Firewall by Netsh",
        "description": "Identifies use of the network shell utility (netsh.exe) to enable inbound Remote Desktop Protocol (RDP) connections in the Windows Firewall.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Remote Desktop Enabled in Windows Firewall by Netsh\n\nMicrosoft Remote Desktop Protocol (RDP) is a proprietary Microsoft protocol that enables remote connections to other computers, typically over TCP port 3389.\n\nAttackers can use RDP to conduct their actions interactively. Ransomware operators frequently use RDP to access victim servers, often using privileged accounts.\n\nThis rule detects the creation of a Windows Firewall inbound rule that would allow inbound RDP traffic using the `netsh.exe` utility.\n\n#### Possible investigation steps\n\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the user to check if they are aware of the operation.\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Check whether it makes sense to enable RDP to this host, given its role in the environment.\n- Check if the host is directly exposed to the internet.\n- Check whether privileged accounts accessed the host shortly after the modification.\n- Review network events within a short timespan of this alert for incoming RDP connection attempts.\n\n### False positive analysis\n\n- The `netsh.exe` utility can be used legitimately. Check whether the user should be performing this kind of activity, whether the user is aware of it, whether RDP should be open, and whether the action exposes the environment to unnecessary risks.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- If RDP is needed, make sure to secure it:\n  - Allowlist RDP traffic to specific trusted hosts.\n  - Restrict RDP logins to authorized non-administrator accounts, where possible.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Review the privileges assigned to the involved users to ensure that the least privilege principle is being followed.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 312,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.004",
                    "name": "Disable or Modify System Firewall",
                    "reference": "https://attack.mitre.org/techniques/T1562/004/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "399d95b3-d9fb-40c6-910f-3796e7e4fb82",
        "rule_id": "074464f9-f30d-4029-8c03-0ed237fffec7",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:05.305Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:23.222Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n (process.name : \"netsh.exe\" or ?process.pe.original_file_name == \"netsh.exe\") and\n process.args : (\"localport=3389\", \"RemoteDesktop\", \"group=\\\"remote desktop\\\"\") and\n process.args : (\"action=allow\", \"enable=Yes\", \"enable\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "PowerShell Script with Remote Execution Capabilities via WinRM",
        "description": "Identifies the use of Cmdlets and methods related to remote execution activities using WinRM. Attackers can abuse WinRM to perform lateral movement using built-in tools.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 208,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Lateral Movement",
          "Tactic: Execution",
          "Data Source: PowerShell Logs",
          "Rule Type: BBR"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://attack.mitre.org/techniques/T1021/006/",
          "https://github.com/cobbr/SharpSploit/blob/master/SharpSploit/LateralMovement/PowerShellRemoting.cs",
          "https://github.com/BC-SECURITY/Empire/blob/main/empire/server/modules/powershell/lateral_movement/invoke_psremoting.py"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1021",
                "name": "Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1021/",
                "subtechnique": [
                  {
                    "id": "T1021.006",
                    "name": "Windows Remote Management",
                    "reference": "https://attack.mitre.org/techniques/T1021/006/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'PowerShell Script Block Logging' logging policy must be enabled.\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nAdministrative Templates >\nWindows PowerShell >\nTurn on PowerShell Script Block Logging (Enable)\n```\n\nSteps to implement the logging policy via registry:\n\n```\nreg add \"hklm\\SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\ScriptBlockLogging\" /v EnableScriptBlockLogging /t REG_DWORD /d 1\n```\n",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.directory",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "powershell.file.script_block_text",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "22d7ccc3-b339-4077-81dd-5d86f1ea5195",
        "rule_id": "0abf0c5b-62dd-48d2-ac4e-6b43fe3a6e83",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:05.307Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:23.258Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-windows.powershell*"
        ],
        "filters": [
          {
            "meta": {
              "negate": true
            },
            "query": {
              "wildcard": {
                "file.path": {
                  "case_insensitive": true,
                  "value": "?:\\\\Program Files\\\\WindowsPowerShell\\\\Modules\\\\dbatools\\\\*\\\\allcommands.ps1"
                }
              }
            }
          },
          {
            "meta": {
              "negate": true
            },
            "query": {
              "wildcard": {
                "file.directory": {
                  "case_insensitive": true,
                  "value": "?:\\\\Program Files\\\\Microsoft\\\\Exchange Server\\\\*\\\\bin"
                }
              }
            }
          },
          {
            "meta": {
              "negate": true
            },
            "query": {
              "wildcard": {
                "file.directory": {
                  "case_insensitive": true,
                  "value": "?:\\\\ExchangeServer\\\\bin*"
                }
              }
            }
          }
        ],
        "query": "event.category:process and host.os.type:windows and\n  powershell.file.script_block_text : (\n    (\"Invoke-WmiMethod\" or \"Invoke-Command\" or \"Enter-PSSession\") and \"ComputerName\"\n  ) and\n  not user.id : \"S-1-5-18\" and\n  not file.directory : (\n    \"C:\\\\Program Files\\\\LogicMonitor\\\\Agent\\\\tmp\"\n  ) and not\n  powershell.file.script_block_text : (\n    \"Export-ModuleMember -Function @('Invoke-Expression''Invoke-Command')\" and\n    \"function Invoke-Command {\"\n  )",
        "language": "kuery"
      },
      {
        "name": "Anomalous Windows Process Creation",
        "description": "Identifies unusual parent-child process relationships that can indicate malware execution or persistence mechanisms. Malicious scripts often call on other applications and processes as part of their exploit payload. For example, when a malicious Office document runs scripts as part of an exploit payload, Excel or Word may start a script interpreter process, which, in turn, runs a script that downloads and executes malware. Another common scenario is Outlook running an unusual process when malware is downloaded in an email. Monitoring and identifying anomalous process relationships is a method of detecting new and emerging malware that is not yet recognized by anti-virus scanners.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n###  Investigating Anomalous Windows Process Creation\n\nSearching for abnormal Windows processes is a good methodology to find potentially malicious activity within a network. Understanding what is commonly run within an environment and developing baselines for legitimate activity can help uncover potential malware and suspicious behaviors.\n\nThis rule uses a machine learning job to detect an anomalous Windows process with an unusual parent-child relationship, which could indicate malware execution or persistence activities on the host machine.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n  - If the parent process is a legitimate system utility or service, this could be related to software updates or system management. If the parent process is something user-facing like an Office application, this process could be more suspicious.\n  - Investigate the process metadata â€” such as the digital signature, directory, etc. â€” to obtain more context that can indicate whether the executable is associated with an expected software vendor or package.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Consider the user as identified by the `user.name` field. Is this program part of an expected workflow for the user who ran this program on this host?\n- Validate the activity is not related to planned patches, updates, network administrator activity, or legitimate software installations.\n- Validate if the activity has a consistent cadence (for example, if it runs monthly or quarterly), as it could be part of a monthly or quarterly business process.\n- Examine the arguments and working directory of the process. These may provide indications as to the source of the program or the nature of the tasks it is performing.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the process executable using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Retrieve Service Unisgned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n\n### False Positive Analysis\n\n- If this activity is related to new benign software installation activity, consider adding exceptions â€” preferably with a combination of user and command line conditions.\n- Try to understand the context of the execution by thinking about the user, machine, or business purpose. A small number of endpoints, such as servers with unique software, might appear unusual but satisfy a specific business need.\n\n### Related Rules\n\n- Unusual Process For a Windows Host - 6d448b96-c922-4adb-b51c-b767f1ea5b76\n- Unusual Windows Path Activity - 445a342e-03fb-42d0-8656-0367eb2dead5\n- Unusual Windows Process Calling the Metadata Service - abae61a8-c560-4dbd-acca-1e1438bff36b\n\n### Response and Remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 208,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Rule Type: ML",
          "Rule Type: Machine Learning",
          "Tactic: Persistence",
          "Resources: Investigation Guide"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "15m",
        "from": "now-2700s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Users running scripts in the course of technical support operations of software upgrades could trigger this alert. A newly installed program or one that runs rarely as part of a monthly or quarterly workflow could trigger this alert."
        ],
        "references": [
          "https://www.elastic.co/guide/en/security/current/prebuilt-ml-jobs.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1543",
                "name": "Create or Modify System Process",
                "reference": "https://attack.mitre.org/techniques/T1543/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires the installation of associated Machine Learning jobs, as well as data coming in from one of the following integrations:\n- Elastic Defend\n- Windows\n\n### Anomaly Detection Setup\n\nOnce the rule is enabled, the associated Machine Learning job will start automatically. You can view the Machine Learning job linked under the \"Definition\" panel of the detection rule. If the job does not start due to an error, the issue must be resolved for the job to commence successfully. For more details on setting up anomaly detection jobs, refer to the [helper guide](https://www.elastic.co/guide/en/kibana/current/xpack-ml-anomalies.html).\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration to your system:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n### Windows Integration Setup\nThe Windows integration allows you to monitor the Windows OS, services, applications, and more.\n\n#### The following steps should be executed in order to add the Elastic Agent System integration \"windows\" to your system:\n- Go to the Kibana home page and click â€œAdd integrationsâ€.\n- In the query bar, search for â€œWindowsâ€ and select the integration to see more details about it.\n- Click â€œAdd Windowsâ€.\n- Configure the integration name and optionally add a description.\n- Review optional and advanced settings accordingly.\n- Add the newly installed â€œwindowsâ€ to an existing or a new agent policy, and deploy the agent on your system from which windows log files are desirable.\n- Click â€œSave and Continueâ€.\n- For more details on the integration refer to the [helper guide](https://docs.elastic.co/integrations/windows).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [],
        "id": "1740cb36-40de-49e7-b5c5-c8a12e72e106",
        "rule_id": "0b29cab4-dbbd-4a3f-9e8e-1287c7c11ae5",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:05.310Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:23.985Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "machine_learning",
        "anomaly_threshold": 50,
        "machine_learning_job_id": [
          "v3_windows_anomalous_process_creation"
        ]
      },
      {
        "name": "User account exposed to Kerberoasting",
        "description": "Detects when a user account has the servicePrincipalName attribute modified. Attackers can abuse write privileges over a user to configure Service Principle Names (SPNs) so that they can perform Kerberoasting. Administrators can also configure this for legitimate purposes, exposing the account to Kerberoasting.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating User account exposed to Kerberoasting\n\nService Principal Names (SPNs) are names by which Kerberos clients uniquely identify service instances for Kerberos target computers.\n\nBy default, only computer accounts have SPNs, which creates no significant risk, since machine accounts have a default domain policy that rotates their passwords every 30 days, and the password is composed of 120 random characters, making them invulnerable to Kerberoasting.\n\nA user account with an SPN assigned is considered a service account, and is accessible to the entire domain. If any user in the directory requests a ticket-granting service (TGS), the domain controller will encrypt it with the secret key of the account executing the service. An attacker can potentially perform a Kerberoasting attack with this information, as the human-defined password is likely to be less complex.\n\nFor scenarios where SPNs cannot be avoided on user accounts, Microsoft provides the Group Managed Service Accounts (gMSA) feature, which ensures that account passwords are robust and changed regularly and automatically. More information can be found [here](https://docs.microsoft.com/en-us/windows-server/security/group-managed-service-accounts/group-managed-service-accounts-overview).\n\nAttackers can also perform \"Targeted Kerberoasting\", which consists of adding fake SPNs to user accounts that they have write privileges to, making them potentially vulnerable to Kerberoasting.\n\n#### Possible investigation steps\n\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate if the target account is a member of privileged groups (Domain Admins, Enterprise Admins, etc.).\n- Investigate if tickets have been requested for the target account.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n\n### False positive analysis\n\n- The use of user accounts as service accounts is a bad security practice and should not be allowed in the domain. The security team should map and monitor any potential benign true positive (B-TP), especially if the account is privileged. Domain Administrators that define this kind of setting can put the domain at risk as user accounts don't have the same security standards as computer accounts (which have long, complex, random passwords that change frequently), exposing them to credential cracking attacks (Kerberoasting, brute force, etc.).\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services. Prioritize privileged accounts.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 213,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Data Source: Active Directory",
          "Resources: Investigation Guide",
          "Use Case: Active Directory Monitoring",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.thehacker.recipes/ad/movement/access-controls/targeted-kerberoasting",
          "https://www.qomplx.com/qomplx-knowledge-kerberoasting-attacks-explained/",
          "https://www.thehacker.recipes/ad/movement/kerberos/kerberoast",
          "https://attack.stealthbits.com/cracking-kerberos-tgs-tickets-using-kerberoasting",
          "https://adsecurity.org/?p=280",
          "https://github.com/OTRF/Set-AuditRule"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1558",
                "name": "Steal or Forge Kerberos Tickets",
                "reference": "https://attack.mitre.org/techniques/T1558/",
                "subtechnique": [
                  {
                    "id": "T1558.003",
                    "name": "Kerberoasting",
                    "reference": "https://attack.mitre.org/techniques/T1558/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'Audit Directory Service Changes' logging policy must be configured for (Success, Failure).\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nPolicies >\nWindows Settings >\nSecurity Settings >\nAdvanced Audit Policies Configuration >\nAudit Policies >\nDS Access >\nAudit Directory Service Changes (Success,Failure)\n```\n\nThe above policy does not cover User objects, so set up an AuditRule using https://github.com/OTRF/Set-AuditRule.\nAs this specifies the servicePrincipalName Attribute GUID, it is expected to be low noise.\n\n```\nSet-AuditRule -AdObjectPath 'AD:\\CN=Users,DC=Domain,DC=com' -WellKnownSidType WorldSid -Rights WriteProperty -InheritanceFlags Children -AttributeGUID f3a64788-5306-11d1-a9c5-0000f80367c1 -AuditFlags Success\n```\n",
        "related_integrations": [
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.code",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.event_data.AttributeLDAPDisplayName",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "winlog.event_data.ObjectClass",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "winlog.event_data.OperationType",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "6776050e-694a-4f88-a4d4-da17108e3eef",
        "rule_id": "0b2f3da5-b5ec-47d1-908b-6ebb74814289",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:05.313Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:23.264Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-system.*",
          "logs-windows.*"
        ],
        "filters": [],
        "query": "event.action:(\"Directory Service Changes\" or \"directory-service-object-modified\") and event.code:5136 and\n  winlog.event_data.OperationType:\"%%14674\" and\n  winlog.event_data.ObjectClass:\"user\" and\n  winlog.event_data.AttributeLDAPDisplayName:\"servicePrincipalName\"",
        "language": "kuery"
      },
      {
        "name": "Attempt to Establish VScode Remote Tunnel",
        "description": "Detects the execution of the VScode portable binary with the tunnel command line option indicating an attempt to establish a remote tunnel session to Github or a remote VScode instance.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 104,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Command and Control",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: System",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://badoption.eu/blog/2023/01/31/code_c2.html",
          "https://code.visualstudio.com/docs/remote/tunnels"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            },
            "technique": [
              {
                "id": "T1219",
                "name": "Remote Access Software",
                "reference": "https://attack.mitre.org/techniques/T1219/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "6e9c4450-787e-458c-aaa1-c4c2e28459a8",
        "rule_id": "0b96dfd8-5b8c-4485-9a1c-69ff7839786a",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:05.316Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:23.270Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.args : \"tunnel\" and (process.args : \"--accept-server-license-terms\" or process.name : \"code*.exe\") and \n  not (process.name == \"code-tunnel.exe\" and process.args == \"status\" and process.parent.name == \"Code.exe\")",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "winlogbeat-*",
          "logs-windows.sysmon_operational-*",
          "logs-system.security*",
          "endgame-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-m365_defender.event-*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Potential LSASS Memory Dump via PssCaptureSnapShot",
        "description": "Identifies suspicious access to an LSASS handle via PssCaptureSnapShot where two successive process accesses are performed by the same process and target two different instances of LSASS. This may indicate an attempt to evade detection and dump LSASS memory for credential access.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 310,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.matteomalvica.com/blog/2019/12/02/win-defender-atp-cred-bypass/",
          "https://twitter.com/sbousseaden/status/1280619931516747777?lang=en"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1003",
                "name": "OS Credential Dumping",
                "reference": "https://attack.mitre.org/techniques/T1003/",
                "subtechnique": [
                  {
                    "id": "T1003.001",
                    "name": "LSASS Memory",
                    "reference": "https://attack.mitre.org/techniques/T1003/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis is meant to run only on datasources using Elastic Agent 7.14+ since versions prior to that will be missing the threshold\nrule cardinality feature.\n",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.code",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.event_data.TargetImage",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "3e94e9ba-00d8-4e46-bef0-e8e621496da7",
        "rule_id": "0f93cb9a-1931-48c2-8cd0-f173fd3e5283",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:05.330Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:23.294Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "threshold",
        "query": "event.category:process and host.os.type:windows and event.code:10 and\n winlog.event_data.TargetImage:(\"C:\\\\Windows\\\\system32\\\\lsass.exe\" or\n                                 \"c:\\\\Windows\\\\system32\\\\lsass.exe\" or\n                                 \"c:\\\\Windows\\\\System32\\\\lsass.exe\")",
        "threshold": {
          "field": [
            "process.entity_id"
          ],
          "value": 2,
          "cardinality": [
            {
              "field": "winlog.event_data.TargetProcessId",
              "value": 2
            }
          ]
        },
        "index": [
          "winlogbeat-*",
          "logs-windows.sysmon_operational-*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Peripheral Device Discovery",
        "description": "Identifies use of the Windows file system utility (fsutil.exe) to gather information about attached peripheral devices and components connected to a computer system.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Peripheral Device Discovery\n\nAfter successfully compromising an environment, attackers may try to gain situational awareness to plan their next steps. This can happen by running commands to enumerate network resources, users, connections, files, and installed security software.\n\nThis rule looks for the execution of the `fsutil` utility with the `fsinfo` subcommand to enumerate drives attached to the computer, which can be used to identify secondary drives used for backups, mapped network drives, and removable media. These devices can contain valuable information for attackers.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate any abnormal account behavior, such as command executions, file creations or modifications, and network connections.\n- Determine whether this activity was followed by suspicious file access/copy operations or uploads to file storage services.\n\n### False positive analysis\n\n- Discovery activities are not inherently malicious if they occur in isolation. As long as the analyst did not identify suspicious activity related to the user or host, such alerts can be dismissed.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 311,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1120",
                "name": "Peripheral Device Discovery",
                "reference": "https://attack.mitre.org/techniques/T1120/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "1583df60-4bb4-443f-946f-3c50b77be8ac",
        "rule_id": "0c7ca5c2-728d-4ad9-b1c5-bbba83ecb1f4",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:05.327Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:23.276Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (process.name : \"fsutil.exe\" or ?process.pe.original_file_name == \"fsutil.exe\") and\n  process.args : \"fsinfo\" and process.args : \"drives\"",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "PowerShell Script with Token Impersonation Capabilities",
        "description": "Detects scripts that contain PowerShell functions, structures, or Windows API functions related to token impersonation/theft. Attackers may duplicate then impersonate another user's token to escalate privileges and bypass access controls.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating PowerShell Script with Token Impersonation Capabilities\n\nPowerShell is one of the main tools system administrators use for automation, report routines, and other tasks. This makes it available for use in various environments, and creates an attractive way for attackers to execute code.\n\nAdversaries can abuse PowerShell to perform token impersonation, which involves duplicating and impersonating another user's token to escalate privileges and bypass access controls. This rule identifies scripts containing PowerShell functions, structures, or Windows API functions related to token impersonation/theft.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n### Possible investigation steps\n\n- Examine the script content that triggered the detection; look for suspicious DLL imports, collection or exfiltration capabilities, suspicious functions, encoded or compressed data, and other potentially malicious characteristics.\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Examine PowerShell process creation and script block logs to identify command line arguments or hardcoded information that can indicate which user was the target of the impersonation.\n- Investigate any abnormal behavior by the subject process (PowerShell), such as network connections, registry or file modifications, and any spawned child processes.\n- Evaluate whether the user needs to use PowerShell to complete tasks.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the script using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n### False positive analysis\n\n- Regular users should not need to impersonate other users, which makes false positives unlikely. In the case of authorized benign true positives (B-TPs), exceptions can be added.\n\n### Related Rules\n\n- PowerShell PSReflect Script - 56f2e9b5-4803-4e44-a0a4-a52dc79d57fe\n- Potential Process Injection via PowerShell - 2e29e96a-b67c-455a-afe4-de6183431d0d\n\n### Response and Remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Restrict PowerShell usage outside of IT and engineering business units using GPOs, AppLocker, Intune, or similar software.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).",
        "output_index": "",
        "version": 114,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Data Source: PowerShell Logs"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/decoder-it/psgetsystem",
          "https://github.com/PowerShellMafia/PowerSploit/blob/master/Privesc/Get-System.ps1",
          "https://github.com/EmpireProject/Empire/blob/master/data/module_source/privesc/Invoke-MS16032.ps1",
          "https://github.com/atc-project/atc-data/blob/master/docs/Logging_Policies/LP_0109_windows_powershell_script_block_log.md"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1134",
                "name": "Access Token Manipulation",
                "reference": "https://attack.mitre.org/techniques/T1134/",
                "subtechnique": [
                  {
                    "id": "T1134.001",
                    "name": "Token Impersonation/Theft",
                    "reference": "https://attack.mitre.org/techniques/T1134/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              },
              {
                "id": "T1106",
                "name": "Native API",
                "reference": "https://attack.mitre.org/techniques/T1106/"
              }
            ]
          }
        ],
        "setup": "The 'PowerShell Script Block Logging' logging policy must be configured (Enable).\n\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nAdministrative Templates >\nWindows PowerShell >\nTurn on PowerShell Script Block Logging (Enable)\n```\n\nSteps to implement the logging policy via registry:\n\n```\nreg add \"hklm\\SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\ScriptBlockLogging\" /v EnableScriptBlockLogging /t REG_DWORD /d 1\n```",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.directory",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "powershell.file.script_block_text",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "66eb54b8-19c5-4b0b-9cf2-75090183cc7e",
        "rule_id": "11dd9713-0ec6-4110-9707-32daae1ee68c",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:05.333Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:23.305Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-windows.powershell*"
        ],
        "filters": [],
        "query": "event.category:process and host.os.type:windows and\n  powershell.file.script_block_text:(\n    \"Invoke-TokenManipulation\" or\n    \"ImpersonateNamedPipeClient\" or\n    \"NtImpersonateThread\" or\n    (\n      \"STARTUPINFOEX\" and\n      \"UpdateProcThreadAttribute\"\n    ) or\n    (\n      \"AdjustTokenPrivileges\" and\n      \"SeDebugPrivilege\"\n    ) or\n    (\n      (\"DuplicateToken\" or\n      \"DuplicateTokenEx\") and\n      (\"SetThreadToken\" or\n      \"ImpersonateLoggedOnUser\" or\n      \"CreateProcessWithTokenW\" or\n      \"CreatePRocessAsUserW\" or\n      \"CreateProcessAsUserA\")\n    ) \n  ) and\n  not (\n    user.id:(\"S-1-5-18\" or \"S-1-5-19\" or \"S-1-5-20\") and\n    file.directory: \"C:\\\\ProgramData\\\\Microsoft\\\\Windows Defender Advanced Threat Protection\\\\Downloads\"\n  ) and\n  not powershell.file.script_block_text : (\n    \"sentinelbreakpoints\" and \"Set-PSBreakpoint\" and \"PowerSploitIndicators\"\n  ) and\n  not (\n    powershell.file.script_block_text : \"New-HPPrivateToastNotificationLogo\" and\n    file.path : \"C:\\Program Files\\HPConnect\\hp-cmsl-wl\\modules\\HP.Notifications\\HP.Notifications.psm1\"\n  )",
        "language": "kuery"
      },
      {
        "name": "Potential Remote Desktop Tunneling Detected",
        "description": "Identifies potential use of an SSH utility to establish RDP over a reverse SSH Tunnel. This can be used by attackers to enable routing of network packets that would otherwise not reach their intended destination.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Potential Remote Desktop Tunneling Detected\n\nProtocol Tunneling is a mechanism that involves explicitly encapsulating a protocol within another for various use cases, ranging from providing an outer layer of encryption (similar to a VPN) to enabling traffic that network appliances would filter to reach their destination.\n\nAttackers may tunnel Remote Desktop Protocol (RDP) traffic through other protocols like Secure Shell (SSH) to bypass network restrictions that block incoming RDP connections but may be more permissive to other protocols.\n\nThis rule looks for command lines involving the `3389` port, which RDP uses by default and options commonly associated with tools that perform tunneling.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account and system owners and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n- Examine network data to determine if the host communicated with external servers using the tunnel.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n- Investigate the command line for the execution of programs that are unrelated to tunneling, like Remote Desktop clients.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Take the necessary actions to disable the tunneling, which can be a process kill, service deletion, registry key modification, etc. Inspect the host to learn which method was used and to determine a response for the case.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 416,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Command and Control",
          "Tactic: Lateral Movement",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: SentinelOne",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: System",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://blog.netspi.com/how-to-access-rdp-over-a-reverse-ssh-tunnel/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            },
            "technique": [
              {
                "id": "T1572",
                "name": "Protocol Tunneling",
                "reference": "https://attack.mitre.org/techniques/T1572/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1021",
                "name": "Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1021/",
                "subtechnique": [
                  {
                    "id": "T1021.004",
                    "name": "SSH",
                    "reference": "https://attack.mitre.org/techniques/T1021/004/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "039b778c-1633-4898-bdc9-dc1da1861680",
        "rule_id": "76fd43b7-3480-4dd9-8ad7-8bd36bfad92f",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:05.336Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:29.931Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  /* RDP port and usual SSH tunneling related switches in command line */\n  process.args : \"*:3389\" and\n  process.args : (\"-L\", \"-P\", \"-R\", \"-pw\", \"-ssh\")",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "winlogbeat-*",
          "logs-windows.*",
          "endgame-*",
          "logs-system.security*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-m365_defender.event-*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Enumeration Command Spawned via WMIPrvSE",
        "description": "Identifies native Windows host and network enumeration commands spawned by the Windows Management Instrumentation Provider Service (WMIPrvSE).",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 314,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1047",
                "name": "Windows Management Instrumentation",
                "reference": "https://attack.mitre.org/techniques/T1047/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1016",
                "name": "System Network Configuration Discovery",
                "reference": "https://attack.mitre.org/techniques/T1016/",
                "subtechnique": [
                  {
                    "id": "T1016.001",
                    "name": "Internet Connection Discovery",
                    "reference": "https://attack.mitre.org/techniques/T1016/001/"
                  }
                ]
              },
              {
                "id": "T1018",
                "name": "Remote System Discovery",
                "reference": "https://attack.mitre.org/techniques/T1018/"
              },
              {
                "id": "T1057",
                "name": "Process Discovery",
                "reference": "https://attack.mitre.org/techniques/T1057/"
              },
              {
                "id": "T1087",
                "name": "Account Discovery",
                "reference": "https://attack.mitre.org/techniques/T1087/"
              },
              {
                "id": "T1518",
                "name": "Software Discovery",
                "reference": "https://attack.mitre.org/techniques/T1518/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "ebd67c4c-0acd-4fae-a731-1ed6caf5a903",
        "rule_id": "770e0c4d-b998-41e5-a62e-c7901fd7f470",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:05.339Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:29.936Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and process.command_line != null and \n  process.name:\n  (\n    \"arp.exe\", \"dsquery.exe\", \"dsget.exe\", \"gpresult.exe\", \"hostname.exe\", \"ipconfig.exe\", \"nbtstat.exe\",\n    \"net.exe\", \"net1.exe\", \"netsh.exe\", \"netstat.exe\", \"nltest.exe\", \"ping.exe\", \"qprocess.exe\", \"quser.exe\",\n    \"qwinsta.exe\", \"reg.exe\", \"sc.exe\", \"systeminfo.exe\", \"tasklist.exe\", \"tracert.exe\", \"whoami.exe\"\n  ) and\n  process.parent.name:\"wmiprvse.exe\" and \n  not (\n    process.name : \"sc.exe\" and process.args : \"RemoteRegistry\" and process.args : \"start=\" and \n    process.args : (\"demand\", \"disabled\")\n  ) and\n  not process.args : \"tenable_mw_scan\"",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious ScreenConnect Client Child Process",
        "description": "Identifies suspicious processes being spawned by the ScreenConnect client processes. This activity may indicate execution abusing unauthorized access to the ScreenConnect remote access software.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 307,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Command and Control",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: System",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.huntress.com/blog/slashandgrab-screen-connect-post-exploitation-in-the-wild-cve-2024-1709-cve-2024-1708"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            },
            "technique": [
              {
                "id": "T1219",
                "name": "Remote Access Software",
                "reference": "https://attack.mitre.org/techniques/T1219/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "38caaf01-0d2d-4b6c-99d5-4ba891a24fd5",
        "rule_id": "78de1aeb-5225-4067-b8cc-f4a1de8a8546",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:05.342Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:29.941Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.parent.name :\n                (\"ScreenConnect.ClientService.exe\",\n                 \"ScreenConnect.WindowsClient.exe\",\n                 \"ScreenConnect.WindowsBackstageShell.exe\",\n                 \"ScreenConnect.WindowsFileManager.exe\") and\n  (\n   (process.name : \"powershell.exe\" and\n    process.args : (\"-enc\", \"-ec\", \"-e\", \"*downloadstring*\", \"*Reflection.Assembly*\", \"*http*\")) or\n   (process.name : \"cmd.exe\" and process.args : \"/c\") or\n   (process.name : \"net.exe\" and process.args : \"/add\") or\n   (process.name : \"schtasks.exe\" and process.args : (\"/create\", \"-create\")) or\n   (process.name : \"sc.exe\" and process.args : \"create\") or\n   (process.name : \"rundll32.exe\" and not process.args : \"url.dll,FileProtocolHandler\") or\n   (process.name : \"msiexec.exe\" and process.args : (\"/i\", \"-i\") and\n    process.args : (\"/q\", \"/quiet\", \"/qn\", \"-q\", \"-quiet\", \"-qn\", \"-Q+\")) or\n   process.name : (\"mshta.exe\", \"certutil.exe\", \"bistadmin.exe\", \"certreq.exe\", \"wscript.exe\", \"cscript.exe\", \"curl.exe\",\n                   \"ssh.exe\", \"scp.exe\", \"wevtutil.exe\", \"wget.exe\", \"wmic.exe\")\n   )",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "winlogbeat-*",
          "logs-windows.sysmon_operational-*",
          "logs-system.security*",
          "endgame-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-m365_defender.event-*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Potential File Transfer via Certreq",
        "description": "Identifies Certreq making an HTTP Post request. Adversaries could abuse Certreq to download files or upload data to a remote URL.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Potential File Transfer via Certreq\n\nCertreq is a command-line utility in Windows operating systems that allows users to request and manage certificates from certificate authorities. It is primarily used for generating certificate signing requests (CSRs) and installing certificates. However, adversaries may abuse Certreq's functionality to download files or upload data to a remote URL by making an HTTP POST request.\n\nThis rule identifies the potential abuse of Certreq to download files or upload data to a remote URL.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n- Examine the details of the dropped file, and whether it was executed.\n- Check the reputation of the domain or IP address used to host the downloaded file or if the user downloaded the file from an internal system.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the file using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process's `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n\n### False positive analysis\n\n- This activity is unusual but can be done by administrators. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 210,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Tactic: Command and Control",
          "Tactic: Exfiltration",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://lolbas-project.github.io/lolbas/Binaries/Certreq/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            },
            "technique": [
              {
                "id": "T1105",
                "name": "Ingress Tool Transfer",
                "reference": "https://attack.mitre.org/techniques/T1105/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1218",
                "name": "System Binary Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1218/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0010",
              "name": "Exfiltration",
              "reference": "https://attack.mitre.org/tactics/TA0010/"
            },
            "technique": [
              {
                "id": "T1567",
                "name": "Exfiltration Over Web Service",
                "reference": "https://attack.mitre.org/techniques/T1567/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "50c5268a-af6b-4aec-87b5-f32257061b65",
        "rule_id": "79f0a1f7-ed6b-471c-8eb1-23abd6470b1c",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:05.346Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:29.946Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n (process.name : \"CertReq.exe\" or ?process.pe.original_file_name == \"CertReq.exe\") and process.args : \"-Post\"",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Potential Shadow Credentials added to AD Object",
        "description": "Identify the modification of the msDS-KeyCredentialLink attribute in an Active Directory Computer or User Object. Attackers can abuse control over the object and create a key pair, append to raw public key in the attribute, and obtain persistent and stealthy access to the target user or computer object.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Potential Shadow Credentials added to AD Object\n\nThe msDS-KeyCredentialLink is an Active Directory (AD) attribute that links cryptographic certificates to a user or computer for domain authentication.\n\nAttackers with write privileges on this attribute over an object can abuse it to gain access to the object or maintain persistence. This means they can authenticate and perform actions on behalf of the exploited identity, and they can use Shadow Credentials to request Ticket Granting Tickets (TGTs) on behalf of the identity.\n\n#### Possible investigation steps\n\n- Identify whether Windows Hello for Business (WHfB) and/or Azure AD is used in the environment.\n  - Review the event ID 4624 for logon events involving the subject identity (`winlog.event_data.SubjectUserName`).\n    - Check whether the `source.ip` is the server running Azure AD Connect.\n- Contact the account and system owners and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Review the event IDs 4768 and 4769 for suspicious ticket requests involving the modified identity (`winlog.event_data.ObjectDN`).\n  - Extract the source IP addresses from these events and use them as indicators of compromise (IoCs) to investigate whether the host is compromised and to scope the attacker's access to the environment.\n\n### False positive analysis\n\n- Administrators might use custom accounts on Azure AD Connect. If this is the case, make sure the account is properly secured. You can also create an exception for the account if expected activity makes too much noise in your environment.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n  - Remove the Shadow Credentials from the object.\n- Investigate how the attacker escalated privileges and identify systems they used to conduct lateral movement. Use this information to determine ways the attacker could regain access to the environment.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 212,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Data Source: Active Directory",
          "Resources: Investigation Guide",
          "Use Case: Active Directory Monitoring",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Modifications in the msDS-KeyCredentialLink attribute can be done legitimately by the Azure AD Connect synchronization account or the ADFS service account. These accounts can be added as Exceptions."
        ],
        "references": [
          "https://posts.specterops.io/shadow-credentials-abusing-key-trust-account-mapping-for-takeover-8ee1a53566ab",
          "https://www.thehacker.recipes/ad/movement/kerberos/shadow-credentials",
          "https://github.com/OTRF/Set-AuditRule",
          "https://cyberstoph.org/posts/2022/03/detecting-shadow-credentials/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1556",
                "name": "Modify Authentication Process",
                "reference": "https://attack.mitre.org/techniques/T1556/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'Audit Directory Service Changes' logging policy must be configured for (Success, Failure).\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nPolicies >\nWindows Settings >\nSecurity Settings >\nAdvanced Audit Policies Configuration >\nAudit Policies >\nDS Access >\nAudit Directory Service Changes (Success,Failure)\n```\n\nThe above policy does not cover User objects, so we need to set up an AuditRule using https://github.com/OTRF/Set-AuditRule.\nAs this specifies the msDS-KeyCredentialLink Attribute GUID, it is expected to be low noise.\n\n```\nSet-AuditRule -AdObjectPath 'AD:\\CN=Users,DC=Domain,DC=com' -WellKnownSidType WorldSid -Rights WriteProperty -InheritanceFlags Children -AttributeGUID 5b47d60f-6090-40b2-9f37-2a4de88f3063 -AuditFlags Success\n```\n",
        "related_integrations": [
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.code",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.event_data.AttributeLDAPDisplayName",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "winlog.event_data.AttributeValue",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "winlog.event_data.SubjectUserName",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "9d30e9a6-f3f9-4da7-9321-b7feace4a8aa",
        "rule_id": "79f97b31-480e-4e63-a7f4-ede42bf2c6de",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:05.348Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:29.951Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-system.*",
          "logs-windows.*"
        ],
        "filters": [],
        "query": "event.action:(\"Directory Service Changes\" or \"directory-service-object-modified\") and event.code:\"5136\" and\n winlog.event_data.AttributeLDAPDisplayName:\"msDS-KeyCredentialLink\" and winlog.event_data.AttributeValue :B\\:828* and\n not winlog.event_data.SubjectUserName: MSOL_*",
        "language": "kuery"
      },
      {
        "name": "Windows Network Enumeration",
        "description": "Identifies attempts to enumerate hosts in a network using the built-in Windows net.exe tool.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Windows Network Enumeration\n\nAfter successfully compromising an environment, attackers may try to gain situational awareness to plan their next steps. This can happen by running commands to enumerate network resources, users, connections, files, and installed security software.\n\nThis rule looks for the execution of the `net` utility to enumerate servers in the environment that hosts shared drives or printers. This information is useful to attackers as they can identify targets for lateral movements and search for valuable shared data.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate any abnormal account behavior, such as command executions, file creations or modifications, and network connections.\n\n### False positive analysis\n\n- Discovery activities are not inherently malicious if they occur in isolation. As long as the analyst did not identify suspicious activity related to the user or host, such alerts can be dismissed.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "building_block_type": "default",
        "output_index": "",
        "version": 214,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Tactic: Collection",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Rule Type: BBR"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/security-labs/siestagraph-new-implant-uncovered-in-asean-member-foreign-ministry"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1018",
                "name": "Remote System Discovery",
                "reference": "https://attack.mitre.org/techniques/T1018/"
              },
              {
                "id": "T1135",
                "name": "Network Share Discovery",
                "reference": "https://attack.mitre.org/techniques/T1135/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0009",
              "name": "Collection",
              "reference": "https://attack.mitre.org/tactics/TA0009/"
            },
            "technique": [
              {
                "id": "T1039",
                "name": "Data from Network Shared Drive",
                "reference": "https://attack.mitre.org/techniques/T1039/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "fcf54aa5-a4c6-4a3d-9b5e-92ffd2fa4d28",
        "rule_id": "7b8bfc26-81d2-435e-965c-d722ee397ef1",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:05.351Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:29.965Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  ((process.name : \"net.exe\" or process.pe.original_file_name == \"net.exe\") or\n   ((process.name : \"net1.exe\" or process.pe.original_file_name == \"net1.exe\") and\n       not process.parent.name : \"net.exe\")) and\n  (process.args : \"view\" or (process.args : \"time\" and process.args : \"\\\\\\\\*\")) and\n  not process.command_line : \"net  view \\\\\\\\localhost \"\n\n\n  /* expand when ancestry is available\n  and not descendant of [process where event.type == \"start\" and process.name : \"cmd.exe\" and\n                           ((process.parent.name : \"userinit.exe\") or\n                            (process.parent.name : \"gpscript.exe\") or\n                            (process.parent.name : \"explorer.exe\" and\n                               process.args : \"C:\\\\*\\\\Start Menu\\\\Programs\\\\Startup\\\\*.bat*\"))]\n  */",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "winlogbeat-*",
          "logs-windows.*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "Microsoft Management Console File from Unusual Path",
        "description": "Identifies attempts to open a Microsoft Management Console File from untrusted paths. Adversaries may use MSC files for initial access and execution.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 307,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: SentinelOne",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: System",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/security-labs/grimresource"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.005",
                    "name": "Visual Basic",
                    "reference": "https://attack.mitre.org/techniques/T1059/005/"
                  },
                  {
                    "id": "T1059.007",
                    "name": "JavaScript",
                    "reference": "https://attack.mitre.org/techniques/T1059/007/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1218",
                "name": "System Binary Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1218/",
                "subtechnique": [
                  {
                    "id": "T1218.014",
                    "name": "MMC",
                    "reference": "https://attack.mitre.org/techniques/T1218/014/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "820de903-bb9a-47f2-928c-b09e5afaa69d",
        "rule_id": "7e23dfef-da2c-4d64-b11d-5f285b638853",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:05.354Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:29.976Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.executable : (\n    \"?:\\\\Windows\\\\System32\\\\mmc.exe\",\n    \"\\\\Device\\\\HarddiskVolume?\\\\Windows\\\\System32\\\\mmc.exe\"\n  ) and\n  process.args : \"*.msc\" and\n  not process.args : (\n        \"?:\\\\Windows\\\\System32\\\\*.msc\",\n        \"?:\\\\Windows\\\\SysWOW64\\\\*.msc\",\n        \"?:\\\\Program files\\\\*.msc\",\n        \"?:\\\\Program Files (x86)\\\\*.msc\"\n  )",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "winlogbeat-*",
          "logs-windows.*",
          "endgame-*",
          "logs-system.security*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-m365_defender.event-*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "High Number of Okta Device Token Cookies Generated for Authentication",
        "description": "Detects when an Okta client address has a certain threshold of Okta user authentication events with multiple device token hashes generated for single user authentication. Adversaries may attempt to launch a credential stuffing or password spraying attack from the same device by using a list of known usernames and passwords to gain unauthorized access to user accounts.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating High Number of Okta Device Token Cookies Generated for Authentication\n\nThis rule detects when a certain threshold of Okta user authentication events are reported for multiple users from the same client address. Adversaries may attempt to launch a credential stuffing attack from the same device by using a list of known usernames and passwords to gain unauthorized access to user accounts. Note that Okta does not log unrecognized usernames supplied during authentication attempts, so this rule may not detect all credential stuffing attempts or may indicate a targeted attack.\n\n#### Possible investigation steps:\n- Since this is an ES|QL rule, the `okta.actor.alternate_id` and `okta.client.ip` values can be used to pivot into the raw authentication events related to this activity.\n- Identify the users involved in this action by examining the `okta.actor.id`, `okta.actor.type`, `okta.actor.alternate_id`, and `okta.actor.display_name` fields.\n- Determine the device client used for these actions by analyzing `okta.client.ip`, `okta.client.user_agent.raw_user_agent`, `okta.client.zone`, `okta.client.device`, and `okta.client.id` fields.\n- Review the `okta.security_context.is_proxy` field to determine if the device is a proxy.\n    - If the device is a proxy, this may indicate that a user is using a proxy to access multiple accounts for password spraying.\n- With the list of `okta.actor.alternate_id` values, review `event.outcome` results to determine if the authentication was successful.\n    - If the authentication was successful for any user, pivoting to `event.action` values for those users may provide additional context.\n- With Okta end users identified, review the `okta.debug_context.debug_data.dt_hash` field.\n    - Historical analysis should indicate if this device token hash is commonly associated with the user.\n- Review the `okta.event_type` field to determine the type of authentication event that occurred.\n    - If the event type is `user.authentication.sso`, the user may have legitimately started a session via a proxy for security or privacy reasons.\n    - If the event type is `user.authentication.password`, the user may be using a proxy to access multiple accounts for password spraying.\n    - If the event type is `user.session.start`, the source may have attempted to establish a session via the Okta authentication API.\n- Examine the `okta.outcome.result` field to determine if the authentication was successful.\n- Review the past activities of the actor(s) involved in this action by checking their previous actions.\n- Evaluate the actions that happened just before and after this event in the `okta.event_type` field to help understand the full context of the activity.\n    - This may help determine the authentication and authorization actions that occurred between the user, Okta and application.\n\n### False positive analysis:\n- A user may have legitimately started a session via a proxy for security or privacy reasons.\n- Users may share an endpoint related to work or personal use in which separate Okta accounts are used.\n    - Architecturally, this shared endpoint may leverage a proxy for security or privacy reasons.\n    - Shared systems such as Kiosks and conference room computers may be used by multiple users.\n    - Shared working spaces may have a single endpoint that is used by multiple users.\n\n### Response and remediation:\n- Review the profile of the users involved in this action to determine if proxy usage may be expected.\n- If the user is legitimate and the authentication behavior is not suspicious based on device analysis, no action is required.\n- If the user is legitimate but the authentication behavior is suspicious, consider resetting passwords for the users involves and enabling multi-factor authentication (MFA).\n    - If MFA is already enabled, consider resetting MFA for the users.\n- If any of the users are not legitimate, consider deactivating the user's account.\n- Conduct a review of Okta policies and ensure they are in accordance with security best practices.\n- Check with internal IT teams to determine if the accounts involved recently had MFA reset at the request of the user.\n    - If so, confirm with the user this was a legitimate request.\n    - If so and this was not a legitimate request, consider deactivating the user's account temporarily.\n        - Reset passwords and reset MFA for the user.\n- If this is a false positive, consider adding the `okta.debug_context.debug_data.dt_hash` field to the `exceptions` list in the rule.\n    - This will prevent future occurrences of this event for this device from triggering the rule.\n    - Alternatively adding `okta.client.ip` or a CIDR range to the `exceptions` list can prevent future occurrences of this event from triggering the rule.\n        - This should be done with caution as it may prevent legitimate alerts from being generated.\n",
        "output_index": "",
        "version": 203,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Data Source: Okta",
          "Tactic: Credential Access"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Users may share an endpoint related to work or personal use in which separate Okta accounts are used.",
          "Shared systems such as Kiosks and conference room computers may be used by multiple users."
        ],
        "references": [
          "https://support.okta.com/help/s/article/How-does-the-Device-Token-work?language=en_US",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://sec.okta.com/articles/2023/08/cross-tenant-impersonation-prevention-and-detection",
          "https://www.okta.com/resources/whitepaper-how-adaptive-mfa-can-help-in-mitigating-brute-force-attacks/",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1110",
                "name": "Brute Force",
                "reference": "https://attack.mitre.org/techniques/T1110/",
                "subtechnique": [
                  {
                    "id": "T1110.003",
                    "name": "Password Spraying",
                    "reference": "https://attack.mitre.org/techniques/T1110/003/"
                  }
                ]
              },
              {
                "id": "T1110",
                "name": "Brute Force",
                "reference": "https://attack.mitre.org/techniques/T1110/",
                "subtechnique": [
                  {
                    "id": "T1110.004",
                    "name": "Credential Stuffing",
                    "reference": "https://attack.mitre.org/techniques/T1110/004/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [],
        "required_fields": [],
        "id": "94529a40-caea-4a64-be25-e47f5b83c806",
        "rule_id": "23f18264-2d6d-11ef-9413-f661ea17fbce",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:05.356Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:42.438Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "esql",
        "language": "esql",
        "query": "FROM logs-okta*\n| WHERE\n    event.dataset == \"okta.system\"\n    AND (event.action RLIKE \"user\\\\.authentication(.*)\" OR event.action == \"user.session.start\")\n    AND okta.debug_context.debug_data.request_uri == \"/api/v1/authn\"\n    AND okta.outcome.reason == \"INVALID_CREDENTIALS\"\n| KEEP event.action, okta.debug_context.debug_data.dt_hash, okta.client.ip, okta.actor.alternate_id, okta.debug_context.debug_data.request_uri, okta.outcome.reason\n| STATS\n    source_auth_count = COUNT_DISTINCT(okta.debug_context.debug_data.dt_hash)\n    BY okta.client.ip, okta.actor.alternate_id\n| WHERE\n    source_auth_count >= 30\n| SORT\n    source_auth_count DESC"
      },
      {
        "name": "Okta User Sessions Started from Different Geolocations",
        "description": "Detects when a specific Okta actor has multiple sessions started from different geolocations. Adversaries may attempt to launch an attack by using a list of known usernames and passwords to gain unauthorized access to user accounts from different locations.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "\n## Triage and analysis\n\n### Investigating Okta User Sessions Started from Different Geolocations\n\nThis rule detects when a specific Okta actor has multiple sessions started from different geolocations. Adversaries may attempt to launch an attack by using a list of known usernames and passwords to gain unauthorized access to user accounts from different locations.\n\n#### Possible investigation steps:\n- Since this is an ES|QL rule, the `okta.actor.alternate_id` and `okta.client.id` values can be used to pivot into the raw authentication events related to this alert.\n- Identify the users involved in this action by examining the `okta.actor.id`, `okta.actor.type`, `okta.actor.alternate_id`, and `okta.actor.display_name` fields.\n- Determine the device client used for these actions by analyzing `okta.client.ip`, `okta.client.user_agent.raw_user_agent`, `okta.client.zone`, `okta.client.device`, and `okta.client.id` fields.\n- With Okta end users identified, review the `okta.debug_context.debug_data.dt_hash` field.\n    - Historical analysis should indicate if this device token hash is commonly associated with the user.\n- Review the `okta.event_type` field to determine the type of authentication event that occurred.\n    - If the event type is `user.authentication.sso`, the user may have legitimately started a session via a proxy for security or privacy reasons.\n    - If the event type is `user.authentication.password`, the user may be using a proxy to access multiple accounts for password spraying.\n    - If the event type is `user.session.start`, the source may have attempted to establish a session via the Okta authentication API.\n- Review the past activities of the actor(s) involved in this action by checking their previous actions.\n- Evaluate the actions that happened just before and after this event in the `okta.event_type` field to help understand the full context of the activity.\n    - This may help determine the authentication and authorization actions that occurred between the user, Okta and application.\n\n### False positive analysis:\n- It is very rare that a legitimate user would have multiple sessions started from different geo-located countries in a short time frame.\n\n### Response and remediation:\n- If the user is legitimate and the authentication behavior is not suspicious based on device analysis, no action is required.\n- If the user is legitimate but the authentication behavior is suspicious, consider resetting passwords for the users involves and enabling multi-factor authentication (MFA).\n    - If MFA is already enabled, consider resetting MFA for the users.\n- If any of the users are not legitimate, consider deactivating the user's account.\n- Conduct a review of Okta policies and ensure they are in accordance with security best practices.\n- Check with internal IT teams to determine if the accounts involved recently had MFA reset at the request of the user.\n    - If so, confirm with the user this was a legitimate request.\n    - If so and this was not a legitimate request, consider deactivating the user's account temporarily.\n        - Reset passwords and reset MFA for the user.\n- If this is a false positive, consider adding the `okta.debug_context.debug_data.dt_hash` field to the `exceptions` list in the rule.\n    - This will prevent future occurrences of this event for this device from triggering the rule.\n    - Alternatively adding `okta.client.ip` or a CIDR range to the `exceptions` list can prevent future occurrences of this event from triggering the rule.\n        - This should be done with caution as it may prevent legitimate alerts from being generated.\n",
        "output_index": "",
        "version": 303,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Data Source: Okta",
          "Tactic: Initial Access"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "15m",
        "from": "now-1800s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://sec.okta.com/articles/2023/08/cross-tenant-impersonation-prevention-and-detection",
          "https://www.rezonate.io/blog/okta-logs-decoded-unveiling-identity-threats-through-threat-hunting/",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1078",
                "name": "Valid Accounts",
                "reference": "https://attack.mitre.org/techniques/T1078/",
                "subtechnique": [
                  {
                    "id": "T1078.004",
                    "name": "Cloud Accounts",
                    "reference": "https://attack.mitre.org/techniques/T1078/004/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.\n",
        "related_integrations": [],
        "required_fields": [],
        "id": "7ce5d44d-237e-4a4e-9467-61253c98e9b8",
        "rule_id": "2e56e1bc-867a-11ee-b13e-f661ea17fbcd",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:05.359Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:44.297Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "esql",
        "language": "esql",
        "query": "FROM logs-okta*\n| WHERE\n    event.dataset == \"okta.system\"\n    AND (event.action RLIKE \"user\\\\.authentication(.*)\" OR event.action == \"user.session.start\")\n    AND okta.security_context.is_proxy != true and okta.actor.id != \"unknown\"\n    AND event.outcome == \"success\"\n| KEEP event.action, okta.security_context.is_proxy, okta.actor.id, event.outcome, client.geo.country_name, okta.actor.alternate_id\n| STATS\n    geo_auth_counts = COUNT_DISTINCT(client.geo.country_name)\n    BY okta.actor.id, okta.actor.alternate_id\n| WHERE\n    geo_auth_counts >= 2"
      },
      {
        "name": "AWS Bedrock Guardrails Detected Multiple Violations by a Single User Over a Session",
        "description": "Identifies multiple violations of AWS Bedrock guardrails by the same user in the same account over a session. Multiple violations implies that a user may be intentionally attempting to cirvumvent security controls, access sensitive information, or possibly exploit a vulnerability in the system.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Amazon Bedrock Guardrail Multiple Policy Violations by a Single User Over a Session.\n\nAmazon Bedrock Guardrail is a set of features within Amazon Bedrock designed to help businesses apply robust safety and privacy controls to their generative AI applications.\n\nIt enables users to set guidelines and filters that manage content quality, relevancy, and adherence to responsible AI practices.\n\nThrough Guardrail, organizations can define \"denied topics\" to prevent the model from generating content on specific, undesired subjects,\nand they can establish thresholds for harmful content categories, including hate speech, violence, or offensive language.\n\n#### Possible investigation steps\n\n- Identify the user account that caused multiple policy violations over a session and whether it should perform this kind of action.\n- Investigate the user activity that might indicate a potential brute force attack.\n- Investigate other alerts associated with the user account during the past 48 hours.\n- Consider the time of day. If the user is a human (not a program or script), did the activity take place during a normal time of day?\n- Examine the account's prompts and responses in the last 24 hours.\n- If you suspect the account has been compromised, scope potentially compromised assets by tracking Amazon Bedrock model access, prompts generated, and responses to the prompts by the account in the last 24 hours.\n\n### False positive analysis\n\n- Verify the user account that caused multiple policy violations by a single user over session, is not testing any new model deployments or updated compliance policies in Amazon Bedrock guardrails.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Disable or limit the account during the investigation and response.\n- Identify the possible impact of the incident and prioritize accordingly; the following actions can help you gain context:\n    - Identify the account role in the cloud environment.\n    - Identify if the attacker is moving laterally and compromising other Amazon Bedrock Services.\n    - Identify any regulatory or legal ramifications related to this activity.\n- Review the permissions assigned to the implicated user group or role behind these requests to ensure they are authorized and expected to access bedrock and ensure that the least privilege principle is being followed.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection via the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 4,
        "tags": [
          "Domain: LLM",
          "Data Source: AWS Bedrock",
          "Data Source: AWS S3",
          "Resources: Investigation Guide",
          "Use Case: Policy Violation",
          "Mitre Atlas: T0051",
          "Mitre Atlas: T0054"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-3600s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Legitimate misunderstanding by users or overly strict policies"
        ],
        "references": [
          "https://docs.aws.amazon.com/bedrock/latest/userguide/guardrails-components.html",
          "https://atlas.mitre.org/techniques/AML.T0051",
          "https://atlas.mitre.org/techniques/AML.T0054",
          "https://www.elastic.co/security-labs/elastic-advances-llm-security"
        ],
        "max_signals": 100,
        "threat": [],
        "setup": "## Setup\n\nThis rule requires that guardrails are configured in AWS Bedrock. For more information, see the AWS Bedrock documentation:\n\nhttps://docs.aws.amazon.com/bedrock/latest/userguide/guardrails-create.html\n",
        "related_integrations": [],
        "required_fields": [],
        "id": "b024ab52-7bde-4dcc-9e3b-ee011b3e0499",
        "rule_id": "0cd2f3e6-41da-40e6-b28b-466f688f00a6",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:05.361Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:40.135Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "esql",
        "language": "esql",
        "query": "from logs-aws_bedrock.invocation-*\n| where gen_ai.compliance.violation_detected\n| keep user.id, gen_ai.request.model.id, cloud.account.id\n| stats violations = count(*) by user.id, gen_ai.request.model.id, cloud.account.id\n| where violations > 1\n| sort violations desc"
      },
      {
        "name": "Successful Application SSO from Rare Unknown Client Device",
        "description": "Detects successful single sign-on (SSO) events to Okta applications from an unrecognized or \"unknown\" client device, as identified by the user-agent string. This activity may be indicative of exploitation of a vulnerability in Okta's Classic Engine, which could allow an attacker to bypass application-specific sign-on policies, such as device or network restrictions. The vulnerability potentially enables unauthorized access to applications using only valid, stolen credentials, without requiring additional authentication factors.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 204,
        "tags": [
          "Domain: SaaS",
          "Data Source: Okta",
          "Use Case: Threat Detection",
          "Use Case: Identity and Access Audit",
          "Tactic: Initial Access"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://trust.okta.com/security-advisories/okta-classic-application-sign-on-policy-bypass-2024/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1078",
                "name": "Valid Accounts",
                "reference": "https://attack.mitre.org/techniques/T1078/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "okta.client.device",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "db291789-325d-441e-beac-3238cf90e875",
        "rule_id": "1502a836-84b2-11ef-b026-f661ea17fbcc",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:05.364Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:40.274Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "event.dataset: \"okta.system\"\n    and event.action: \"user.authentication.sso\"\n    and event.outcome: \"success\"\n    and okta.client.device: (\"Unknown\" or \"unknown\")",
        "new_terms_fields": [
          "client.user.name",
          "okta.client.user_agent.raw_user_agent"
        ],
        "history_window_start": "now-14d",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "AWS Bedrock Detected Multiple Attempts to use Denied Models by a Single User",
        "description": "Identifies multiple successive failed attempts to use denied model resources within AWS Bedrock. This could indicated attempts to bypass limitations of other approved models, or to force an impact on the environment by incurring exhorbitant costs.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Attempt to use Denied Amazon Bedrock Models.\n\nAmazon Bedrock is AWSâ€™s managed service that enables developers to build and scale generative AI applications using large foundation models (FMs) from top providers.\n\nBedrock offers a variety of pretrained models from Amazon (such as the Titan series), as well as models from providers like Anthropic, Meta, Cohere, and AI21 Labs.\n\n#### Possible investigation steps\n\n- Identify the user account that attempted to use denied models.\n- Investigate other alerts associated with the user account during the past 48 hours.\n- Consider the time of day. If the user is a human (not a program or script), did the activity take place during a normal time of day?\n- Examine the account's attempts to access Amazon Bedrock models in the last 24 hours.\n- If you suspect the account has been compromised, scope potentially compromised assets by tracking Amazon Bedrock model access, prompts generated, and responses to the prompts by the account in the last 24 hours.\n\n### False positive analysis\n\n- Verify the user account that attempted to use denied models, is a legitimate misunderstanding by users or overly strict policies.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Disable or limit the account during the investigation and response.\n- Identify the possible impact of the incident and prioritize accordingly; the following actions can help you gain context:\n    - Identify the account role in the cloud environment.\n    - Identify if the attacker is moving laterally and compromising other Amazon Bedrock Services.\n    - Identify any regulatory or legal ramifications related to this activity.\n- Review the permissions assigned to the implicated user group or role behind these requests to ensure they are authorized and expected to access bedrock and ensure that the least privilege principle is being followed.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection via the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "investigation_fields": {
          "field_names": [
            "user.id",
            "cloud.account.id",
            "gen_ai.request.model.id",
            "total_denials"
          ]
        },
        "version": 3,
        "tags": [
          "Domain: LLM",
          "Data Source: AWS Bedrock",
          "Data Source: AWS S3",
          "Resources: Investigation Guide",
          "Use Case: Policy Violation",
          "Mitre Atlas: T0015",
          "Mitre Atlas: T0034"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-3600s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Legitimate misunderstanding by users or overly strict policies"
        ],
        "references": [
          "https://docs.aws.amazon.com/bedrock/latest/userguide/guardrails-components.html",
          "https://atlas.mitre.org/techniques/AML.T0015",
          "https://atlas.mitre.org/techniques/AML.T0034",
          "https://www.elastic.co/security-labs/elastic-advances-llm-security"
        ],
        "max_signals": 100,
        "threat": [],
        "setup": "## Setup\n\nThis rule requires that guardrails are configured in AWS Bedrock. For more information, see the AWS Bedrock documentation:\n\nhttps://docs.aws.amazon.com/bedrock/latest/userguide/guardrails-create.html\n",
        "related_integrations": [],
        "required_fields": [],
        "id": "e378b968-e96e-4089-827f-e445985c15a2",
        "rule_id": "17261da3-a6d0-463c-aac8-ea1718afcd20",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:05.367Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:40.334Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "esql",
        "language": "esql",
        "query": "from logs-aws_bedrock.invocation-*\n| where gen_ai.response.error_code == \"AccessDeniedException\"\n| keep user.id, gen_ai.request.model.id, cloud.account.id, gen_ai.response.error_code\n| stats total_denials = count(*) by user.id, gen_ai.request.model.id, cloud.account.id\n| where total_denials > 3\n| sort total_denials desc"
      },
      {
        "name": "Potential Abuse of Resources by High Token Count and Large Response Sizes",
        "description": "Detects potential resource exhaustion or data breach attempts by monitoring for users who consistently generate high input token counts, submit numerous requests, and receive large responses. This behavior could indicate an attempt to overload the system or extract an unusually large amount of data, possibly revealing sensitive information or causing service disruptions.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Amazon Bedrock Models High Token Count and Large Response Sizes.\n\nAmazon Bedrock is AWSâ€™s managed service that enables developers to build and scale generative AI applications using large foundation models (FMs) from top providers.\n\nBedrock offers a variety of pretrained models from Amazon (such as the Titan series), as well as models from providers like Anthropic, Meta, Cohere, and AI21 Labs.\n\n#### Possible investigation steps\n\n- Identify the user account that used high prompt token counts and whether it should perform this kind of action.\n- Investigate large response sizes and the number of requests made by the user account.\n- Investigate other alerts associated with the user account during the past 48 hours.\n- Consider the time of day. If the user is a human (not a program or script), did the activity take place during a normal time of day?\n- Examine the account's prompts and responses in the last 24 hours.\n- If you suspect the account has been compromised, scope potentially compromised assets by tracking Amazon Bedrock model access, prompts generated, and responses to the prompts by the account in the last 24 hours.\n\n### False positive analysis\n\n- Verify the user account that used high prompt and large response sizes, has a business justification for the heavy usage of the system.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Disable or limit the account during the investigation and response.\n- Identify the possible impact of the incident and prioritize accordingly; the following actions can help you gain context:\n    - Identify the account role in the cloud environment.\n    - Identify if the attacker is moving laterally and compromising other Amazon Bedrock Services.\n    - Identify any regulatory or legal ramifications related to this activity.\n    - Identify potential resource exhaustion and impact on billing.\n- Review the permissions assigned to the implicated user group or role behind these requests to ensure they are authorized and expected to access bedrock and ensure that the least privilege principle is being followed.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection via the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 3,
        "tags": [
          "Domain: LLM",
          "Data Source: AWS Bedrock",
          "Data Source: Amazon Web Services",
          "Data Source: AWS S3",
          "Use Case: Potential Overload",
          "Use Case: Resource Exhaustion",
          "Mitre Atlas: LLM04"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-3600s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Authorized heavy usage of the system that is business justified and monitored."
        ],
        "references": [
          "https://atlas.mitre.org/techniques/AML.T0051",
          "https://owasp.org/www-project-top-10-for-large-language-model-applications/",
          "https://www.elastic.co/security-labs/elastic-advances-llm-security"
        ],
        "max_signals": 100,
        "threat": [],
        "setup": "## Setup\n\nThis rule requires that guardrails are configured in AWS Bedrock. For more information, see the AWS Bedrock documentation:\n\nhttps://docs.aws.amazon.com/bedrock/latest/userguide/guardrails-create.html\n",
        "related_integrations": [],
        "required_fields": [],
        "id": "e4f5ceae-83da-4eb8-b7c2-2deddd8f12ea",
        "rule_id": "b1773d05-f349-45fb-9850-287b8f92f02d",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:05.370Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:17:00.916Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "esql",
        "language": "esql",
        "query": "from logs-aws_bedrock.invocation-*\n| keep user.id, gen_ai.usage.prompt_tokens, gen_ai.usage.completion_tokens\n| stats max_tokens = max(gen_ai.usage.prompt_tokens),\n         total_requests = count(*),\n         avg_response_size = avg(gen_ai.usage.completion_tokens)\n  by user.id\n// tokens count depends on specific LLM, as is related to how embeddings are generated.\n| where max_tokens > 5000 and total_requests > 10 and avg_response_size > 500\n| eval risk_factor = (max_tokens / 1000) * total_requests * (avg_response_size / 500)\n| where risk_factor > 10\n| sort risk_factor desc"
      },
      {
        "name": "AWS S3 Bucket Enumeration or Brute Force",
        "description": "Identifies a high number of failed S3 operations from a single source and account (or anonymous account) within a short timeframe. This activity can be indicative of attempting to cause an increase in billing to an account for excessive random operations, cause resource exhaustion, or enumerating bucket names for discovery.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating AWS S3 Bucket Enumeration or Brute Force\n\nAWS S3 buckets can be be brute forced to cause financial impact against the resource owner. What makes this even riskier is that even private, locked down buckets can still trigger a potential cost, even with an \"Access Denied\", while also being accessible from unauthenticated, anonymous accounts. This also appears to work on several or all [operations](https://docs.aws.amazon.com/cli/latest/reference/s3api/) (GET, PUT, list-objects, etc.). Additionally, buckets are trivially discoverable by default as long as the bucket name is known, making it vulnerable to enumeration for discovery.\n\nAttackers may attempt to enumerate names until a valid bucket is discovered and then pivot to cause financial impact, enumerate for more information, or brute force in other ways to attempt to exfil data.\n\n#### Possible investigation steps\n\n- Examine the history of the operation requests from the same `source.address` and `cloud.account.id` to determine if there is other suspicious activity.\n- Review similar requests and look at the `user.agent` info to ascertain the source of the requests (though do not overly rely on this since it is controlled by the requestor).\n- Review other requests to the same `aws.s3.object.key` as well as other `aws.s3.object.key` accessed by the same `cloud.account.id` or `source.address`.\n- Investigate other alerts associated with the user account during the past 48 hours.\n- Validate the activity is not related to planned patches, updates, or network administrator activity.\n- Examine the request parameters. These may indicate the source of the program or the nature of the task being performed when the error occurred.\n    - Check whether the error is related to unsuccessful attempts to enumerate or access objects, data, or secrets.\n- Considering the source IP address and geolocation of the user who issued the command:\n    - Do they look normal for the calling user?\n    - If the source is an EC2 IP address, is it associated with an EC2 instance in one of your accounts or is the source IP from an EC2 instance that's not under your control?\n    - If it is an authorized EC2 instance, is the activity associated with normal behavior for the instance role or roles? Are there any other alerts or signs of suspicious activity involving this instance?\n- Consider the time of day. If the user is a human (not a program or script), did the activity take place during a normal time of day?\n- Contact the account owner and confirm whether they are aware of this activity if suspicious.\n- If you suspect the account has been compromised, scope potentially compromised assets by tracking servers, services, and data accessed by the account in the last 24 hours.\n\n### False positive analysis\n\n- Verify the `source.address` and `cloud.account.id` - there are some valid operations from within AWS directly that can cause failures and false positives. Additionally, failed automation can also caeuse false positives, but should be identifiable by reviewing the `source.address` and `cloud.account.id`.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Disable or limit the account during the investigation and response.\n- Identify the possible impact of the incident and prioritize accordingly; the following actions can help you gain context:\n    - Identify the account role in the cloud environment.\n    - Assess the criticality of affected services and servers.\n    - Work with your IT team to identify and minimize the impact on users.\n    - Identify if the attacker is moving laterally and compromising other accounts, servers, or services.\n    - Identify any regulatory or legal ramifications related to this activity.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords or delete API keys as needed to revoke the attacker's access to the environment. Work with your IT teams to minimize the impact on business operations during these actions.\n- Check if unauthorized new users were created, remove unauthorized new accounts, and request password resets for other IAM users.\n- Consider enabling multi-factor authentication for users.\n- Review the permissions assigned to the implicated user to ensure that the least privilege principle is being followed.\n- Implement security best practices [outlined](https://aws.amazon.com/premiumsupport/knowledge-center/security-best-practices/) by AWS.\n- Take the actions needed to return affected systems, data, or services to their normal operational levels.\n- Identify the initial vector abused by the attacker and take action to prevent reinfection via the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n- Check for PutBucketPolicy event actions as well to see if they have been tampered with. While we monitor for denied, a single successful action to add a backdoor into the bucket via policy updates (however they got permissions) may be critical to identify during TDIR.\n\n",
        "output_index": "",
        "investigation_fields": {
          "field_names": [
            "source.address",
            "tls.client.server_name",
            "cloud.account.id",
            "failed_requests"
          ]
        },
        "version": 4,
        "tags": [
          "Domain: Cloud",
          "Data Source: AWS",
          "Data Source: Amazon Web Services",
          "Data Source: AWS S3",
          "Resources: Investigation Guide",
          "Use Case: Log Auditing",
          "Tactic: Impact"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Known or internal account IDs or automation"
        ],
        "references": [
          "https://medium.com/@maciej.pocwierz/how-an-empty-s3-bucket-can-make-your-aws-bill-explode-934a383cb8b1",
          "https://docs.aws.amazon.com/cli/latest/reference/s3api/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0040",
              "name": "Impact",
              "reference": "https://attack.mitre.org/tactics/TA0040/"
            },
            "technique": [
              {
                "id": "T1657",
                "name": "Financial Theft",
                "reference": "https://attack.mitre.org/techniques/T1657/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1580",
                "name": "Cloud Infrastructure Discovery",
                "reference": "https://attack.mitre.org/techniques/T1580/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0009",
              "name": "Collection",
              "reference": "https://attack.mitre.org/tactics/TA0009/"
            },
            "technique": [
              {
                "id": "T1530",
                "name": "Data from Cloud Storage",
                "reference": "https://attack.mitre.org/techniques/T1530/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [],
        "required_fields": [],
        "id": "9e7c056f-d2e8-4c68-9258-7a633117402e",
        "rule_id": "5f0234fd-7f21-42af-8391-511d5fd11d5c",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:05.373Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:50.501Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "esql",
        "language": "esql",
        "query": "from logs-aws.cloudtrail*\n| where event.provider == \"s3.amazonaws.com\" and aws.cloudtrail.error_code == \"AccessDenied\"\n// keep only relevant fields\n| keep tls.client.server_name, source.address, cloud.account.id\n| stats failed_requests = count(*) by tls.client.server_name, source.address, cloud.account.id\n  // can modify the failed request count or tweak time window to fit environment\n  // can add `not cloud.account.id in (KNOWN)` or specify in exceptions\n| where failed_requests > 40"
      },
      {
        "name": "Multiple Device Token Hashes for Single Okta Session",
        "description": "This rule detects when a specific Okta actor has multiple device token hashes for a single Okta session. This may indicate an authenticated session has been hijacked or is being used by multiple devices. Adversaries may hijack a session to gain unauthorized access to Okta admin console, applications, tenants, or other resources.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Multiple Device Token Hashes for Single Okta Session\n\nThis rule detects when a specific Okta actor has multiple device token hashes for a single Okta session. This may indicate an authenticated session has been hijacked or is being used by multiple devices. Adversaries may hijack a session to gain unauthorized access to Okta admin console, applications, tenants, or other resources.\n\n#### Possible investigation steps:\n- Since this is an ES|QL rule, the `okta.actor.alternate_id` and `okta.authentication_context.external_session_id` values can be used to pivot into the raw authentication events related to this alert.\n- Identify the users involved in this action by examining the `okta.actor.id`, `okta.actor.type`, `okta.actor.alternate_id`, and `okta.actor.display_name` fields.\n- Determine the device client used for these actions by analyzing `okta.client.ip`, `okta.client.user_agent.raw_user_agent`, `okta.client.zone`, `okta.client.device`, and `okta.client.id` fields.\n- With Okta end users identified, review the `okta.debug_context.debug_data.dt_hash` field.\n    - Historical analysis should indicate if this device token hash is commonly associated with the user.\n- Review the `okta.event_type` field to determine the type of authentication event that occurred.\n    - Authentication events have been filtered out to focus on Okta activity via established sessions.\n- Review the past activities of the actor(s) involved in this action by checking their previous actions.\n- Evaluate the actions that happened just before and after this event in the `okta.event_type` field to help understand the full context of the activity.\n    - This may help determine the authentication and authorization actions that occurred between the user, Okta and application.\n- Aggregate by `okta.actor.alternate_id` and `event.action` to determine the type of actions that are being performed by the actor(s) involved in this action.\n    - If various activity is reported that seems to indicate actions from separate users, consider deactivating the user's account temporarily.\n\n### False positive analysis:\n- It is very rare that a legitimate user would have multiple device token hashes for a single Okta session as DT hashes do not change after an authenticated session is established.\n\n### Response and remediation:\n- Consider stopping all sessions for the user(s) involved in this action.\n- If this does not appear to be a false positive, consider resetting passwords for the users involved and enabling multi-factor authentication (MFA).\n    - If MFA is already enabled, consider resetting MFA for the users.\n- If any of the users are not legitimate, consider deactivating the user's account.\n- Conduct a review of Okta policies and ensure they are in accordance with security best practices.\n- Check with internal IT teams to determine if the accounts involved recently had MFA reset at the request of the user.\n    - If so, confirm with the user this was a legitimate request.\n    - If so and this was not a legitimate request, consider deactivating the user's account temporarily.\n        - Reset passwords and reset MFA for the user.\n- Alternatively adding `okta.client.ip` or a CIDR range to the `exceptions` list can prevent future occurrences of this event from triggering the rule.\n    - This should be done with caution as it may prevent legitimate alerts from being generated.\n",
        "output_index": "",
        "version": 304,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Data Source: Okta",
          "Tactic: Credential Access",
          "Domain: SaaS"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://sec.okta.com/articles/2023/08/cross-tenant-impersonation-prevention-and-detection",
          "https://support.okta.com/help/s/article/session-hijacking-attack-definition-damage-defense?language=en_US",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1539",
                "name": "Steal Web Session Cookie",
                "reference": "https://attack.mitre.org/techniques/T1539/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [],
        "required_fields": [],
        "id": "937b6c8d-9c30-4708-b77e-f02799f84a19",
        "rule_id": "cc382a2e-7e52-11ee-9aac-f661ea17fbcd",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:05.376Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:17:04.934Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "esql",
        "language": "esql",
        "query": "FROM logs-okta*\n| WHERE\n    event.dataset == \"okta.system\"\n    // ignore authentication events where session and device token hash change often\n    AND NOT event.action IN (\n        \"policy.evaluate_sign_on\",\n        \"user.session.start\",\n        \"user.authentication.sso\"\n    )\n    // ignore Okta system events and only allow registered users\n    AND (\n        okta.actor.alternate_id != \"system@okta.com\"\n        AND okta.actor.alternate_id RLIKE \"[^@\\\\s]+\\\\@[^@\\\\s]+\"\n    )\n    AND okta.authentication_context.external_session_id != \"unknown\"\n| KEEP event.action, okta.actor.alternate_id, okta.authentication_context.external_session_id, okta.debug_context.debug_data.dt_hash\n| STATS\n    dt_hash_counts = COUNT_DISTINCT(okta.debug_context.debug_data.dt_hash) BY\n        okta.actor.alternate_id,\n        okta.authentication_context.external_session_id\n| WHERE\n    dt_hash_counts >= 2\n| SORT\n    dt_hash_counts DESC"
      },
      {
        "name": "AWS EC2 Multi-Region DescribeInstances API Calls",
        "description": "Identifies when a single AWS resource is making `DescribeInstances` API calls in more than 10 regions within a 30-second window. This could indicate a potential threat actor attempting to discover the AWS infrastructure across multiple regions using compromised credentials or a compromised instance. Adversaries may use this information to identify potential targets for further exploitation or to gain a better understanding of the target's infrastructure.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and Analysis\n\n### Investigating AWS EC2 Multi-Region DescribeInstances API Calls\n\nThis rule detects instances where a single AWS resource makes `DescribeInstances` API calls in over 10 regions within a 30-second window. This could indicate an adversary using compromised credentials or an exploited resource to enumerate AWS infrastructure across multiple regions. Attackers often leverage multi-region enumeration to assess the overall cloud environment and find potential targets for further exploitation.\n\n#### Possible Investigation Steps\n\n- **Identify the Resource and Actor**:\n  - **Actor ARN**: Check `aws.cloudtrail.user_identity.arn` to determine the exact identity performing the enumeration. Validate if the user is expected to perform region-wide `DescribeInstances` actions across multiple regions or if it seems unusual.\n  - **Account and Role Details**: Examine `cloud.account.id` and `aws.cloudtrail.user_identity.session_context.session_issuer` for information about the AWS account and specific role associated with the action.\n\n- **Analyze API Call Patterns**:\n  - **Frequency and Scope**: Review `cloud.region` field and confirm if this specific resource commonly performs `DescribeInstances` calls across multiple regions.\n  - **Time Window Context**: Compare the timing of the API calls within the `target_time_window` to determine if this burst pattern aligns with expected system usage or is potentially malicious.\n\n- **Check User Agent and Tooling**:\n  - **Source and User Agent**: Verify `user_agent.original` to determine if the request was made through expected tooling (e.g., AWS CLI or SDK) or a third-party tool that might indicate non-standard access.\n  - **Source IP Address**: Look into `source.address` to identify the origin of the calls. Unusual IP addresses, especially those outside expected ranges, may indicate compromised access.\n\n- **Evaluate for Potential Reconnaissance Behavior**:\n  - **Account and Region Enumeration**: Adversaries may use region-wide `DescribeInstances` requests to discover resources within an account across different regions. Confirm if this access aligns with operational practices or represents excessive access.\n  - **Permissions and Roles**: Investigate the permissions associated with the user role. Excessive permissions on a compromised role may allow broader enumeration, which should be restricted.\n\n- **Review Related CloudTrail Events**:\n  - **Additional Describe or List Actions**: Identify any associated `Describe` or `List` API calls that may indicate further enumeration of other AWS services within the same timeframe.\n  - **Potential Preceding Events**: Look for preceding login or access events from the same actor, as these may indicate potential credential compromise or unauthorized escalation of privileges.\n\n### False Positive Analysis\n\n- **Expected Enumeration**: Certain administrative or automation scripts may conduct broad `DescribeInstances` API calls for inventory purposes. Review usage patterns or consult relevant teams to validate the purpose.\n- **Automated Cloud Management**: Some automated services may perform regional checks for compliance or backup operations. If this rule is triggered repeatedly by a known service, consider whitelisting or tuning accordingly.\n\n### Response and Remediation\n\n- **Review IAM Policies and Role Permissions**: Limit the permissions of roles associated with this resource, restricting unnecessary multi-region enumeration access.\n- **Enforce Least Privilege Access**: Ensure that permissions for DescribeInstances are tightly controlled and restricted to specific roles or accounts that require multi-region access.\n- **Increase Monitoring and Alerts**: Set up additional monitoring on this role or account for further signs of unauthorized activity or lateral movement attempts.\n- **Access Review**: Conduct a review of users and entities with `DescribeInstances` permissions, especially for multi-region capabilities, and ensure these permissions are necessary for their functions.\n\n### Additional Information\n\nFor further information on AWS `DescribeInstances` permissions and best practices, refer to the [AWS DescribeInstances API documentation](https://docs.aws.amazon.com/AWSEC2/latest/APIReference/API_DescribeInstances.html).\n",
        "output_index": "",
        "investigation_fields": {
          "field_names": [
            "aws.cloudtrail.user_identity.arn",
            "target_time_window",
            "region_count",
            "window_count"
          ]
        },
        "version": 3,
        "tags": [
          "Domain: Cloud",
          "Data Source: AWS",
          "Data Source: AWS EC2",
          "Resources: Investigation Guide",
          "Use Case: Threat Detection",
          "Tactic: Discovery"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Legitimate use of the `DescribeInstances` API call by an AWS resource that requires information about instances in multiple regions.",
          "Scheduled tasks or scripts that require information about instances in multiple regions."
        ],
        "references": [
          "https://www.sentinelone.com/labs/exploring-fbot-python-based-malware-targeting-cloud-and-payment-services/",
          "https://docs.aws.amazon.com/AWSEC2/latest/APIReference/API_DescribeInstances.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1580",
                "name": "Cloud Infrastructure Discovery",
                "reference": "https://attack.mitre.org/techniques/T1580/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [],
        "required_fields": [],
        "id": "e737432a-6f91-48c9-a657-311c9df05313",
        "rule_id": "393ef120-63d1-11ef-8e38-f661ea17fbce",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:05.379Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:46.294Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "esql",
        "language": "esql",
        "query": "from logs-aws.cloudtrail-*\n\n// filter for DescribeInstances API calls\n| where event.dataset == \"aws.cloudtrail\" and event.provider == \"ec2.amazonaws.com\" and event.action == \"DescribeInstances\"\n\n// truncate the timestamp to a 30-second window\n| eval target_time_window = DATE_TRUNC(30 seconds, @timestamp)\n\n// keep only the relevant fields\n| keep target_time_window, aws.cloudtrail.user_identity.arn, cloud.region\n\n// count the number of unique regions and total API calls within the 30-second window\n| stats region_count = count_distinct(cloud.region), window_count = count(*) by target_time_window, aws.cloudtrail.user_identity.arn\n\n// filter for resources making DescribeInstances API calls in more than 10 regions within the 30-second window\n| where region_count >= 10 and window_count >= 10\n\n// sort the results by time windows in descending order\n| sort target_time_window desc"
      },
      {
        "name": "Unusual High Confidence Content Filter Blocks Detected",
        "description": "Detects repeated high-confidence 'BLOCKED' actions coupled with specific 'Content Filter' policy violation having codes such as 'MISCONDUCT', 'HATE', 'SEXUAL', INSULTS', 'PROMPT_ATTACK', 'VIOLENCE' indicating persistent misuse or attempts to probe the model's ethical boundaries.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Amazon Bedrock Guardrail High Confidence Content Filter Blocks.\n\nAmazon Bedrock Guardrail is a set of features within Amazon Bedrock designed to help businesses apply robust safety and privacy controls to their generative AI applications.\n\nIt enables users to set guidelines and filters that manage content quality, relevancy, and adherence to responsible AI practices.\n\nThrough Guardrail, organizations can enable Content filter for Hate, Insults, Sexual Violence and Misconduct along with Prompt Attack filters prompts \nto prevent the model from generating content on specific, undesired subjects, and they can establish thresholds for harmful content categories.\n\n#### Possible investigation steps\n\n- Identify the user account whose prompts caused high confidence content filter blocks and whether it should perform this kind of action.\n- Investigate other alerts associated with the user account during the past 48 hours.\n- Consider the time of day. If the user is a human (not a program or script), did the activity take place during a normal time of day?\n- Examine the account's prompts and responses in the last 24 hours.\n- If you suspect the account has been compromised, scope potentially compromised assets by tracking Amazon Bedrock model access, prompts generated, and responses to the prompts by the account in the last 24 hours.\n\n### False positive analysis\n\n- Verify the user account that queried denied topics, is not testing any new model deployments or updated compliance policies in Amazon Bedrock guardrails.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Disable or limit the account during the investigation and response.\n- Identify the possible impact of the incident and prioritize accordingly; the following actions can help you gain context:\n    - Identify the account role in the cloud environment.\n    - Identify if the attacker is moving laterally and compromising other Amazon Bedrock Services.\n    - Identify any regulatory or legal ramifications related to this activity.\n- Review the permissions assigned to the implicated user group or role behind these requests to ensure they are authorized and expected to access bedrock and ensure that the least privilege principle is being followed.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection via the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 5,
        "tags": [
          "Domain: LLM",
          "Data Source: AWS Bedrock",
          "Data Source: AWS S3",
          "Use Case: Policy Violation",
          "Mitre Atlas: T0051",
          "Mitre Atlas: T0054"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-3600s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "New model deployments.",
          "Testing updates to compliance policies."
        ],
        "references": [
          "https://docs.aws.amazon.com/bedrock/latest/userguide/guardrails-components.html",
          "https://atlas.mitre.org/techniques/AML.T0051",
          "https://atlas.mitre.org/techniques/AML.T0054",
          "https://www.elastic.co/security-labs/elastic-advances-llm-security"
        ],
        "max_signals": 100,
        "threat": [],
        "setup": "## Setup\n\nThis rule requires that guardrails are configured in AWS Bedrock. For more information, see the AWS Bedrock documentation:\n\nhttps://docs.aws.amazon.com/bedrock/latest/userguide/guardrails-create.html\n",
        "related_integrations": [],
        "required_fields": [],
        "id": "7e1362f0-4a73-4055-a3bc-97f9cf982a00",
        "rule_id": "4f855297-c8e0-4097-9d97-d653f7e471c4",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:05.382Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:48.439Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "esql",
        "language": "esql",
        "query": "from logs-aws_bedrock.invocation-*\n| MV_EXPAND gen_ai.compliance.violation_code\n| MV_EXPAND gen_ai.policy.confidence\n| MV_EXPAND gen_ai.policy.name \n| where gen_ai.policy.action == \"BLOCKED\" and gen_ai.policy.name == \"content_policy\" and gen_ai.policy.confidence LIKE \"HIGH\" and gen_ai.compliance.violation_code IN (\"HATE\", \"MISCONDUCT\", \"SEXUAL\", \"INSULTS\", \"PROMPT_ATTACK\", \"VIOLENCE\")\n| keep user.id, gen_ai.compliance.violation_code\n| stats block_count_per_violation = count() by user.id, gen_ai.compliance.violation_code \n| SORT block_count_per_violation DESC \n| keep user.id, gen_ai.compliance.violation_code, block_count_per_violation\n| STATS violation_count = SUM(block_count_per_violation) by user.id\n| WHERE violation_count > 5 \n| SORT violation_count DESC"
      },
      {
        "name": "AWS IAM User Created Access Keys For Another User",
        "description": "An adversary with access to a set of compromised credentials may attempt to persist or escalate privileges by creating a new set of credentials for an existing user. This rule looks for use of the IAM `CreateAccessKey` API operation to create new programmatic access keys for another IAM user.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating AWS IAM User Created Access Keys For Another User\n\nAWS access keys created for IAM users or root user are long-term credentials that provide programmatic access to AWS.\nWith access to the `iam:CreateAccessKey` permission, a set of compromised credentials could be used to create a new\nset of credentials for another user for privilege escalation or as a means of persistence. This rule uses [ES|QL](https://www.elastic.co/guide/en/security/master/rules-ui-create.html#create-esql-rule)\nto look for use of the `CreateAccessKey` operation where the user.name is different from the user.target.name.\n\n\n#### Possible investigation steps\n\n- Identify both related accounts and their role in the environment.\n- Review IAM permission policies for the user identities.\n- Identify the applications or users that should use these accounts.\n- Investigate other alerts associated with the accounts during the past 48 hours.\n- Investigate abnormal values in the `user_agent.original` field by comparing them with the intended and authorized usage and historical data. Suspicious user agent values include non-SDK, AWS CLI, custom user agents, etc.\n- Contact the account owners and confirm whether they are aware of this activity.\n- Considering the source IP address and geolocation of the user who issued the command:\n    - Do they look normal for the calling user?\n    - If the source is an EC2 IP address, is it associated with an EC2 instance in one of your accounts or is the source IP from an EC2 instance that's not under your control?\n    - If it is an authorized EC2 instance, is the activity associated with normal behavior for the instance role or roles? Are there any other alerts or signs of suspicious activity involving this instance?\n- If you suspect the account has been compromised, scope potentially compromised assets by tracking servers, services, and data accessed by the account in the last 24 hours.\n    - Determine what other API calls were made by the user.\n    - Assess whether this behavior is prevalent in the environment by looking for similar occurrences involving other users.\n\n### False positive analysis\n\n- False positives may occur due to the intended usage of the IAM `CreateAccessKey` operation. Verify the `aws.cloudtrail.user_identity.arn` should use this operation against the `user.target.name` account.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Disable or limit the account during the investigation and response.\n    - Rotate user credentials\n    - Remove the newly created credentials from the affected user(s)\n- Identify the possible impact of the incident and prioritize accordingly; the following actions can help you gain context:\n    - Identify the account role in the cloud environment.\n    - Assess the criticality of affected services and servers.\n    - Work with your IT team to identify and minimize the impact on users.\n    - Identify if the attacker is moving laterally and compromising other accounts, servers, or services.\n    - Identify any regulatory or legal ramifications related to this activity.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified.\n    - Rotate secrets or delete API keys as needed to revoke the attacker's access to the environment.\n    - Work with your IT teams to minimize the impact on business operations during these actions.\n- Remove unauthorized new accounts, and request password resets for other IAM users.\n- Consider enabling multi-factor authentication for users.\n- Review the permissions assigned to the implicated user to ensure that the least privilege principle is being followed.\n- Implement security best practices [outlined](https://aws.amazon.com/premiumsupport/knowledge-center/security-best-practices/) by AWS.\n- Take the actions needed to return affected systems, data, or services to their normal operational levels.\n- Identify the initial vector abused by the attacker and take action to prevent reinfection via the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "investigation_fields": {
          "field_names": [
            "@timestamp",
            "user.name",
            "source.address",
            "aws.cloudtrail.user_identity.arn",
            "aws.cloudtrail.user_identity.type",
            "user_agent.original",
            "user.target.name",
            "event.action",
            "event.outcome",
            "cloud.region",
            "event.provider",
            "aws.cloudtrail.request_parameters",
            "aws.cloudtrail.response_elements"
          ]
        },
        "version": 5,
        "tags": [
          "Domain: Cloud",
          "Data Source: AWS",
          "Data Source: Amazon Web Services",
          "Data Source: AWS IAM",
          "Use Case: Identity and Access Audit",
          "Tactic: Privilege Escalation",
          "Tactic: Persistence",
          "Resources: Investigation Guide"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "While this can be normal behavior, it should be investigated to ensure validity. Verify whether the user identity should be using the IAM `CreateAccessKey` for the targeted user."
        ],
        "references": [
          "https://hackingthe.cloud/aws/exploitation/iam_privilege_escalation/#iamcreateaccesskey",
          "https://cloud.hacktricks.xyz/pentesting-cloud/aws-security/aws-persistence/aws-iam-persistence",
          "https://permiso.io/blog/lucr-3-scattered-spider-getting-saas-y-in-the-cloud",
          "https://docs.aws.amazon.com/IAM/latest/APIReference/API_CreateAccessKey.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1098",
                "name": "Account Manipulation",
                "reference": "https://attack.mitre.org/techniques/T1098/",
                "subtechnique": [
                  {
                    "id": "T1098.001",
                    "name": "Additional Cloud Credentials",
                    "reference": "https://attack.mitre.org/techniques/T1098/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1098",
                "name": "Account Manipulation",
                "reference": "https://attack.mitre.org/techniques/T1098/",
                "subtechnique": [
                  {
                    "id": "T1098.001",
                    "name": "Additional Cloud Credentials",
                    "reference": "https://attack.mitre.org/techniques/T1098/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [],
        "required_fields": [],
        "id": "d39693a3-485a-46fd-8ff6-27f5e428d38d",
        "rule_id": "696015ef-718e-40ff-ac4a-cc2ba88dbeeb",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:05.384Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:52.441Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "esql",
        "language": "esql",
        "query": "from logs-aws.cloudtrail-* metadata _id, _version, _index\n| where event.provider == \"iam.amazonaws.com\"\n    and event.action == \"CreateAccessKey\"\n    and event.outcome == \"success\"\n    and user.name != user.target.name\n| keep\n    @timestamp,\n    cloud.region,\n    event.provider,\n    event.action,\n    event.outcome,\n    user.name,\n    source.address,\n    user.target.name,\n    user_agent.original,\n    aws.cloudtrail.request_parameters,\n    aws.cloudtrail.response_elements,\n    aws.cloudtrail.user_identity.arn,\n    aws.cloudtrail.user_identity.type"
      },
      {
        "name": "AWS Bedrock Detected Multiple Validation Exception Errors by a Single User",
        "description": "Identifies multiple validation exeception errors within AWS Bedrock. Validation errors occur when you run the InvokeModel or InvokeModelWithResponseStream APIs on a foundation model that uses an incorrect inference parameter or corresponding value. These errors also occur when you use an inference parameter for one model with a model that doesn't have the same API parameter. This could indicate attempts to bypass limitations of other approved models, or to force an impact on the environment by incurring exhorbitant costs.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Amazon Bedrock Model Validation Exception Errors.\n\nAmazon Bedrock is AWSâ€™s managed service that enables developers to build and scale generative AI applications using large foundation models (FMs) from top providers.\n\nBedrock offers a variety of pretrained models from Amazon (such as the Titan series), as well as models from providers like Anthropic, Meta, Cohere, and AI21 Labs.\n\n#### Possible investigation steps\n\n- Identify the user account that caused validation errors in accessing the Amazon Bedrock models.\n- Investigate other alerts associated with the user account during the past 48 hours.\n- Consider the time of day. If the user is a human (not a program or script), did the activity take place during a normal time of day?\n- Examine the account's attempts to access Amazon Bedrock models in the last 24 hours.\n- If you suspect the account has been compromised, scope potentially compromised assets by tracking Amazon Bedrock model access, prompts generated, and responses to the prompts by the account in the last 24 hours.\n\n### False positive analysis\n\n- Verify the user account that that caused validation errors is a legitimate misunderstanding by users on accessing the bedrock models.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Disable or limit the account during the investigation and response.\n- Identify the possible impact of the incident and prioritize accordingly; the following actions can help you gain context:\n    - Identify the account role in the cloud environment.\n    - Identify if the attacker is moving laterally and compromising other Amazon Bedrock Services.\n    - Identify any regulatory or legal ramifications related to this activity.\n    - Identify if any implication to resource billing.\n- Review the permissions assigned to the implicated user group or role behind these requests to ensure they are authorized and expected to access bedrock and ensure that the least privilege principle is being followed.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection via the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "investigation_fields": {
          "field_names": [
            "target_time_window",
            "user.id",
            "cloud.account.id",
            "total_denials"
          ]
        },
        "version": 3,
        "tags": [
          "Domain: LLM",
          "Data Source: AWS",
          "Data Source: AWS Bedrock",
          "Data Source: AWS S3",
          "Use Case: Policy Violation",
          "Mitre Atlas: T0015",
          "Mitre Atlas: T0034",
          "Mitre Atlas: T0046"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-3600s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Legitimate misunderstanding by users on accessing the bedrock models."
        ],
        "references": [
          "https://atlas.mitre.org/techniques/AML.T0015",
          "https://atlas.mitre.org/techniques/AML.T0034",
          "https://atlas.mitre.org/techniques/AML.T0046",
          "https://www.elastic.co/security-labs/elastic-advances-llm-security"
        ],
        "max_signals": 100,
        "threat": [],
        "setup": "## Setup\n\nThis rule requires that AWS Bedrock Integration be configured. For more information, see the AWS Bedrock integration documentation:\n\nhttps://www.elastic.co/docs/current/integrations/aws_bedrock\n",
        "related_integrations": [],
        "required_fields": [],
        "id": "2d0f11a0-6ef1-47c1-bd27-bea16200e6a8",
        "rule_id": "725a048a-88c5-4fc7-8677-a44fc0031822",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:05.387Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:52.593Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "esql",
        "language": "esql",
        "query": "from logs-aws_bedrock.invocation-*\n// truncate the timestamp to a 1-minute window\n| eval target_time_window = DATE_TRUNC(1 minutes, @timestamp)\n| where gen_ai.response.error_code == \"ValidationException\"\n| keep user.id, gen_ai.request.model.id, cloud.account.id, gen_ai.response.error_code, target_time_window\n// count the number of users causing validation errors within a 1 minute window\n| stats total_denials = count(*) by target_time_window, user.id, cloud.account.id\n| where total_denials > 3"
      },
      {
        "name": "Multiple Okta User Authentication Events with Client Address",
        "description": "Detects when a certain threshold of Okta user authentication events are reported for multiple users from the same client address. Adversaries may attempt to launch a credential stuffing or password spraying attack from the same device by using a list of known usernames and passwords to gain unauthorized access to user accounts.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Multiple Okta User Authentication Events with Client Address\n\nThis rule detects when a certain threshold of Okta user authentication events are reported for multiple users from the same client address. Adversaries may attempt to launch a credential stuffing attack from the same device by using a list of known usernames and passwords to gain unauthorized access to user accounts. Note that Okta does not log unrecognized usernames supplied during authentication attempts, so this rule may not detect all credential stuffing attempts or may indicate a targeted attack.\n\n#### Possible investigation steps:\nSince this is an ES|QL rule, the `okta.actor.alternate_id` and `okta.client.ip` values can be used to pivot into the raw authentication events related to this activity.\n- Identify the users involved in this action by examining the `okta.actor.id`, `okta.actor.type`, `okta.actor.alternate_id`, and `okta.actor.display_name` fields.\n- Determine the device client used for these actions by analyzing `okta.client.ip`, `okta.client.user_agent.raw_user_agent`, `okta.client.zone`, `okta.client.device`, and `okta.client.id` fields.\n- Review the `okta.security_context.is_proxy` field to determine if the device is a proxy.\n    - If the device is a proxy, this may indicate that a user is using a proxy to access multiple accounts for password spraying.\n- With the list of `okta.actor.alternate_id` values, review `event.outcome` results to determine if the authentication was successful.\n    - If the authentication was successful for any user, pivoting to `event.action` values for those users may provide additional context.\n- With Okta end users identified, review the `okta.debug_context.debug_data.dt_hash` field.\n    - Historical analysis should indicate if this device token hash is commonly associated with the user.\n- Review the `okta.event_type` field to determine the type of authentication event that occurred.\n    - If the event type is `user.authentication.sso`, the user may have legitimately started a session via a proxy for security or privacy reasons.\n    - If the event type is `user.authentication.password`, the user may be using a proxy to access multiple accounts for password spraying.\n    - If the event type is `user.session.start`, the source may have attempted to establish a session via the Okta authentication API.\n- Examine the `okta.outcome.result` field to determine if the authentication was successful.\n- Review the past activities of the actor(s) involved in this action by checking their previous actions.\n- Evaluate the actions that happened just before and after this event in the `okta.event_type` field to help understand the full context of the activity.\n    - This may help determine the authentication and authorization actions that occurred between the user, Okta and application.\n\n### False positive analysis:\n- A user may have legitimately started a session via a proxy for security or privacy reasons.\n- Users may share an endpoint related to work or personal use in which separate Okta accounts are used.\n    - Architecturally, this shared endpoint may leverage a proxy for security or privacy reasons.\n    - Shared systems such as Kiosks and conference room computers may be used by multiple users.\n    - Shared working spaces may have a single endpoint that is used by multiple users.\n\n### Response and remediation:\n- Review the profile of the users involved in this action to determine if proxy usage may be expected.\n- If the user is legitimate and the authentication behavior is not suspicious based on device analysis, no action is required.\n- If the user is legitimate but the authentication behavior is suspicious, consider resetting passwords for the users involves and enabling multi-factor authentication (MFA).\n    - If MFA is already enabled, consider resetting MFA for the users.\n- If any of the users are not legitimate, consider deactivating the user's account.\n- Conduct a review of Okta policies and ensure they are in accordance with security best practices.\n- Check with internal IT teams to determine if the accounts involved recently had MFA reset at the request of the user.\n    - If so, confirm with the user this was a legitimate request.\n    - If so and this was not a legitimate request, consider deactivating the user's account temporarily.\n        - Reset passwords and reset MFA for the user.\n- If this is a false positive, consider adding the `okta.debug_context.debug_data.dt_hash` field to the `exceptions` list in the rule.\n    - This will prevent future occurrences of this event for this device from triggering the rule.\n    - Alternatively adding `okta.client.ip` or a CIDR range to the `exceptions` list can prevent future occurrences of this event from triggering the rule.\n        - This should be done with caution as it may prevent legitimate alerts from being generated.\n",
        "output_index": "",
        "version": 203,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Data Source: Okta",
          "Tactic: Credential Access"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Users may share an endpoint related to work or personal use in which separate Okta accounts are used.",
          "Shared systems such as Kiosks and conference room computers may be used by multiple users."
        ],
        "references": [
          "https://support.okta.com/help/s/article/How-does-the-Device-Token-work?language=en_US",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://sec.okta.com/articles/2023/08/cross-tenant-impersonation-prevention-and-detection",
          "https://www.okta.com/resources/whitepaper-how-adaptive-mfa-can-help-in-mitigating-brute-force-attacks/",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1110",
                "name": "Brute Force",
                "reference": "https://attack.mitre.org/techniques/T1110/",
                "subtechnique": [
                  {
                    "id": "T1110.003",
                    "name": "Password Spraying",
                    "reference": "https://attack.mitre.org/techniques/T1110/003/"
                  }
                ]
              },
              {
                "id": "T1110",
                "name": "Brute Force",
                "reference": "https://attack.mitre.org/techniques/T1110/",
                "subtechnique": [
                  {
                    "id": "T1110.004",
                    "name": "Credential Stuffing",
                    "reference": "https://attack.mitre.org/techniques/T1110/004/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [],
        "required_fields": [],
        "id": "62156e01-2285-433b-93e8-a1b7ebc70fcd",
        "rule_id": "94e734c0-2cda-11ef-84e1-f661ea17fbce",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:05.390Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:56.793Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "esql",
        "language": "esql",
        "query": "FROM logs-okta*\n| WHERE\n    event.dataset == \"okta.system\"\n    AND (event.action == \"user.session.start\" OR event.action RLIKE \"user\\\\.authentication(.*)\")\n    AND okta.outcome.reason == \"INVALID_CREDENTIALS\"\n| KEEP okta.client.ip, okta.actor.alternate_id, okta.actor.id, event.action, okta.outcome.reason\n| STATS\n    source_auth_count = COUNT_DISTINCT(okta.actor.id)\n    BY okta.client.ip, okta.actor.alternate_id\n| WHERE\n    source_auth_count > 5\n| SORT\n    source_auth_count DESC"
      },
      {
        "name": "Multiple Okta User Authentication Events with Same Device Token Hash",
        "description": "Detects when a high number of Okta user authentication events are reported for multiple users in a short time frame. Adversaries may attempt to launch a credential stuffing or password spraying attack from the same device by using a list of known usernames and passwords to gain unauthorized access to user accounts.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Multiple Okta User Authentication Events with Same Device Token Hash\n\nThis rule detects when a high number of Okta user authentication events are reported for multiple users in a short time frame. Adversaries may attempt to launch a credential stuffing attack from the same device by using a list of known usernames and passwords to gain unauthorized access to user accounts. Note that Okta does not log unrecognized usernames supplied during authentication attempts, so this rule may not detect all credential stuffing attempts or may indicate a targeted attack.\n\n#### Possible investigation steps:\n- Since this is an ES|QL rule, the `okta.actor.alternate_id` and `okta.debug_context.debug_data.dt_hash` values can be used to pivot into the raw authentication events related to this activity.\n- Identify the users involved in this action by examining the `okta.actor.id`, `okta.actor.type`, `okta.actor.alternate_id`, and `okta.actor.display_name` fields.\n- Determine the device client used for these actions by analyzing `okta.client.ip`, `okta.client.user_agent.raw_user_agent`, `okta.client.zone`, `okta.client.device`, and `okta.client.id` fields.\n- Review the `okta.security_context.is_proxy` field to determine if the device is a proxy.\n    - If the device is a proxy, this may indicate that a user is using a proxy to access multiple accounts for password spraying.\n- With the list of `okta.actor.alternate_id` values, review `event.outcome` results to determine if the authentication was successful.\n    - If the authentication was successful for any user, pivoting to `event.action` values for those users may provide additional context.\n- With Okta end users identified, review the `okta.debug_context.debug_data.dt_hash` field.\n    - Historical analysis should indicate if this device token hash is commonly associated with the user.\n- Review the `okta.event_type` field to determine the type of authentication event that occurred.\n    - If the event type is `user.authentication.sso`, the user may have legitimately started a session via a proxy for security or privacy reasons.\n    - If the event type is `user.authentication.password`, the user may be using a proxy to access multiple accounts for password spraying.\n- Examine the `okta.outcome.result` field to determine if the authentication was successful.\n- Review the past activities of the actor(s) involved in this action by checking their previous actions.\n- Evaluate the actions that happened just before and after this event in the `okta.event_type` field to help understand the full context of the activity.\n    - This may help determine the authentication and authorization actions that occurred between the user, Okta and application.\n\n### False positive analysis:\n- A user may have legitimately started a session via a proxy for security or privacy reasons.\n- Users may share an endpoint related to work or personal use in which separate Okta accounts are used.\n    - Architecturally, this shared endpoint may leverage a proxy for security or privacy reasons.\n    - Shared systems such as Kiosks and conference room computers may be used by multiple users.\n    - Shared working spaces may have a single endpoint that is used by multiple users.\n\n### Response and remediation:\n- Review the profile of the users involved in this action to determine if proxy usage may be expected.\n- If the user is legitimate and the authentication behavior is not suspicious based on device analysis, no action is required.\n- If the user is legitimate but the authentication behavior is suspicious, consider resetting passwords for the users involves and enabling multi-factor authentication (MFA).\n    - If MFA is already enabled, consider resetting MFA for the users.\n- If any of the users are not legitimate, consider deactivating the user's account.\n- Conduct a review of Okta policies and ensure they are in accordance with security best practices.\n- Check with internal IT teams to determine if the accounts involved recently had MFA reset at the request of the user.\n    - If so, confirm with the user this was a legitimate request.\n    - If so and this was not a legitimate request, consider deactivating the user's account temporarily.\n        - Reset passwords and reset MFA for the user.\n- If this is a false positive, consider adding the `okta.debug_context.debug_data.dt_hash` field to the `exceptions` list in the rule.\n    - This will prevent future occurrences of this event for this device from triggering the rule.\n",
        "output_index": "",
        "version": 203,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Data Source: Okta",
          "Tactic: Credential Access"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Users may share an endpoint related to work or personal use in which separate Okta accounts are used.",
          "Shared systems such as Kiosks and conference room computers may be used by multiple users."
        ],
        "references": [
          "https://support.okta.com/help/s/article/How-does-the-Device-Token-work?language=en_US",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://sec.okta.com/articles/2023/08/cross-tenant-impersonation-prevention-and-detection",
          "https://www.okta.com/resources/whitepaper-how-adaptive-mfa-can-help-in-mitigating-brute-force-attacks/",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1110",
                "name": "Brute Force",
                "reference": "https://attack.mitre.org/techniques/T1110/",
                "subtechnique": [
                  {
                    "id": "T1110.003",
                    "name": "Password Spraying",
                    "reference": "https://attack.mitre.org/techniques/T1110/003/"
                  }
                ]
              },
              {
                "id": "T1110",
                "name": "Brute Force",
                "reference": "https://attack.mitre.org/techniques/T1110/",
                "subtechnique": [
                  {
                    "id": "T1110.004",
                    "name": "Credential Stuffing",
                    "reference": "https://attack.mitre.org/techniques/T1110/004/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [],
        "required_fields": [],
        "id": "1ed65cff-ac17-481c-ac98-415143bf2e42",
        "rule_id": "95b99adc-2cda-11ef-84e1-f661ea17fbce",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:05.401Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:56.803Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "esql",
        "language": "esql",
        "query": "FROM logs-okta*\n| WHERE\n    event.dataset == \"okta.system\"\n    AND (event.action RLIKE \"user\\\\.authentication(.*)\" OR event.action == \"user.session.start\")\n    AND okta.debug_context.debug_data.dt_hash != \"-\"\n    AND okta.outcome.reason == \"INVALID_CREDENTIALS\"\n| KEEP event.action, okta.debug_context.debug_data.dt_hash, okta.actor.id, okta.actor.alternate_id, okta.outcome.reason\n| STATS\n    target_auth_count = COUNT_DISTINCT(okta.actor.id)\n    BY okta.debug_context.debug_data.dt_hash, okta.actor.alternate_id\n| WHERE\n    target_auth_count > 20\n| SORT\n    target_auth_count DESC"
      },
      {
        "name": "AWS IAM AdministratorAccess Policy Attached to User",
        "description": "An adversary with access to a set of compromised credentials may attempt to persist or escalate privileges by attaching additional permissions to compromised user accounts. This rule looks for use of the IAM `AttachUserPolicy` API operation to attach the highly permissive `AdministratorAccess` AWS managed policy to an existing IAM user.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating AWS IAM AdministratorAccess Policy Attached to User\n\nThe AWS IAM `AdministratorAccess` managed policy provides full access to all AWS services and resources.\nWith access to the `iam:AttachUserPolicy` permission, a set of compromised credentials could be used to attach\nthis policy to the current user for privilege escalation or another user as a means of persistence. This rule uses [ES|QL](https://www.elastic.co/guide/en/security/master/rules-ui-create.html#create-esql-rule)\nto look for use of the `AttachUserPolicy` operation along with request_parameters where the policyName is `AdministratorAccess`.\n\n\n#### Possible investigation steps\n\n- Identify the account and its role in the environment.\n- Review IAM permission policies for the user identity.\n- Identify the applications or users that should use this account.\n- Investigate other alerts associated with the account during the past 48 hours.\n- Investigate abnormal values in the `user_agent.original` field by comparing them with the intended and authorized usage and historical data. Suspicious user agent values include non-SDK, AWS CLI, custom user agents, etc.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Considering the source IP address and geolocation of the user who issued the command:\n    - Do they look normal for the calling user?\n    - If the source is an EC2 IP address, is it associated with an EC2 instance in one of your accounts or is the source IP from an EC2 instance that's not under your control?\n    - If it is an authorized EC2 instance, is the activity associated with normal behavior for the instance role or roles? Are there any other alerts or signs of suspicious activity involving this instance?\n- If you suspect the account has been compromised, scope potentially compromised assets by tracking servers, services, and data accessed by the account in the last 24 hours.\n    - Determine what other API calls were made by the user.\n    - Assess whether this behavior is prevalent in the environment by looking for similar occurrences involving other users.\n\n### False positive analysis\n\n- False positives may occur due to the intended usage of the IAM `AdministratorAccess` managed policy. Verify the `aws.cloudtrail.user_identity.arn` should have the `iam:AttachUserPolicy` permission and that the `target.userName` should be given full administrative access.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Disable or limit the account during the investigation and response.\n    - Rotate user credentials\n    - Remove the `AdministratorAccess` policy from the affected user(s)\n- Identify the possible impact of the incident and prioritize accordingly; the following actions can help you gain context:\n    - Identify the account role in the cloud environment.\n    - Assess the criticality of affected services and servers.\n    - Work with your IT team to identify and minimize the impact on users.\n    - Identify if the attacker is moving laterally and compromising other accounts, servers, or services.\n    - Identify any regulatory or legal ramifications related to this activity.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified.\n    - Rotate secrets or delete API keys as needed to revoke the attacker's access to the environment.\n    - Work with your IT teams to minimize the impact on business operations during these actions.\n- Check if unauthorized new users were created, remove unauthorized new accounts, and request password resets for other IAM users.\n- Consider enabling multi-factor authentication for users.\n- Review the permissions assigned to the implicated user to ensure that the least privilege principle is being followed.\n- Implement security best practices [outlined](https://aws.amazon.com/premiumsupport/knowledge-center/security-best-practices/) by AWS.\n- Take the actions needed to return affected systems, data, or services to their normal operational levels.\n- Identify the initial vector abused by the attacker and take action to prevent reinfection via the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "investigation_fields": {
          "field_names": [
            "@timestamp",
            "user.name",
            "source.address",
            "aws.cloudtrail.user_identity.arn",
            "user_agent.original",
            "target.userName",
            "event.action",
            "policyName",
            "event.outcome",
            "cloud.region",
            "event.provider",
            "aws.cloudtrail.request_parameters"
          ]
        },
        "version": 4,
        "tags": [
          "Domain: Cloud",
          "Data Source: AWS",
          "Data Source: Amazon Web Services",
          "Data Source: AWS IAM",
          "Use Case: Identity and Access Audit",
          "Tactic: Privilege Escalation",
          "Tactic: Persistence",
          "Resources: Investigation Guide"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "While this can be normal behavior, it should be investigated to ensure validity. Verify whether the user identity should be using the IAM `AttachUserPolicy` API operation to attach the `AdministratorAccess` policy to the target user."
        ],
        "references": [
          "https://docs.aws.amazon.com/IAM/latest/APIReference/API_AttachUserPolicy.html",
          "https://docs.aws.amazon.com/aws-managed-policy/latest/reference/AdministratorAccess.html",
          "https://hackingthe.cloud/aws/exploitation/iam_privilege_escalation/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1098",
                "name": "Account Manipulation",
                "reference": "https://attack.mitre.org/techniques/T1098/",
                "subtechnique": [
                  {
                    "id": "T1098.003",
                    "name": "Additional Cloud Roles",
                    "reference": "https://attack.mitre.org/techniques/T1098/003/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1098",
                "name": "Account Manipulation",
                "reference": "https://attack.mitre.org/techniques/T1098/",
                "subtechnique": [
                  {
                    "id": "T1098.003",
                    "name": "Additional Cloud Roles",
                    "reference": "https://attack.mitre.org/techniques/T1098/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [],
        "required_fields": [],
        "id": "0703608a-8664-4946-85a1-c14194069fa1",
        "rule_id": "9aa4be8d-5828-417d-9f54-7cd304571b24",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:05.404Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:58.745Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "esql",
        "language": "esql",
        "query": "from logs-aws.cloudtrail-* metadata _id, _version, _index\n| where event.provider == \"iam.amazonaws.com\" and event.action == \"AttachUserPolicy\" and event.outcome == \"success\"\n| dissect aws.cloudtrail.request_parameters \"{%{?policyArn}=%{?arn}:%{?aws}:%{?iam}::%{?aws}:%{?policy}/%{policyName},%{?userName}=%{target.userName}}\"\n| where policyName == \"AdministratorAccess\"\n| keep\n    @timestamp,\n    cloud.region,\n    event.provider,\n    event.action,\n    event.outcome,\n    policyName,\n    target.userName,\n    aws.cloudtrail.request_parameters,\n    aws.cloudtrail.user_identity.arn,\n    related.user,\n    user_agent.original,\n    user.name,\n    source.address"
      },
      {
        "name": "Okta Sign-In Events via Third-Party IdP",
        "description": "Detects sign-in events where authentication is carried out via a third-party Identity Provider (IdP).",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Okta Sign-In Events via Third-Party IdP\n\nThis rule detects sign-in events where authentication is carried out via a third-party Identity Provider (IdP).\n\nAdversaries may attempt to add an unauthorized IdP to an Okta tenant to gain access to the tenant. Following this action, adversaries may attempt to sign in to the tenant using the unauthorized IdP. This rule detects both the addition of an unauthorized IdP and the subsequent sign-in attempt.\n\n#### Possible investigation steps:\n- Identify the third-party IdP by examining the `okta.authentication_context.issuer.id` field.\n- Once the third-party IdP is identified, determine if this IdP is authorized to be used by the tenant.\n- If the IdP is unauthorized, deactivate it immediately via the Okta console.\n- Identify the actor associated with the IdP creation by examining the `okta.actor.id`, `okta.actor.type`, `okta.actor.alternate_id`, and `okta.actor.display_name` fields in historical data.\n    - The `New Okta Identity Provider (IdP) Added by Admin` rule may be helpful in identifying the actor and the IdP creation event.\n- Determine the client used by the actor. Review the `okta.client.ip`, `okta.client.user_agent.raw_user_agent`, `okta.client.zone`, `okta.client.device`, and `okta.client.id` fields.\n- If the client is a device, check the `okta.device.id`, `okta.device.name`, `okta.device.os_platform`, `okta.device.os_version`, and `okta.device.managed` fields.\n- Review the past activities of the actor involved in this action by checking their previous actions logged in the `okta.target` field.\n- Examine the `okta.request.ip_chain` field to potentially determine if the actor used a proxy or VPN to perform this action.\n- Evaluate the actions that happened just before and after this event in the `okta.event_type` field to help understand the full context of the activity.\n\n### False positive analysis:\n- It might be a false positive if this IdP is authorized to be used by the tenant.\n- This may be a false positive if an authorized third-party IdP is used to sign in to the tenant but failures occurred due to an incorrect configuration.\n\n### Response and remediation:\n- If the IdP is unauthorized, deactivate it immediately via the Okta console.\n- Reset the effected user's password and enforce MFA re-enrollment, if applicable.\n- Mobile device forensics may be required to determine if the user's device is compromised.\n- If the IdP is authorized, ensure that the actor who created it is authorized to do so.\n- If the actor is unauthorized, deactivate their account via the Okta console.\n- If the actor is authorized, ensure that the actor's account is not compromised.\n\n- Block the IP address or device used in the attempts if they appear suspicious, using the data from the `okta.client.ip` and `okta.device.id` fields.\n- Conduct a review of Okta policies and ensure they are in accordance with security best practices.\n- If the deactivated IdP was crucial to the organization, consider adding a new IdP and removing the unauthorized IdP.",
        "output_index": "",
        "version": 206,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Tactic: Initial Access",
          "Data Source: Okta"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "15m",
        "from": "now-1800s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://blog.cloudflare.com/cloudflare-investigation-of-the-january-2022-okta-compromise/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://sec.okta.com/articles/2023/08/cross-tenant-impersonation-prevention-and-detection",
          "https://unit42.paloaltonetworks.com/muddled-libra/",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1199",
                "name": "Trusted Relationship",
                "reference": "https://attack.mitre.org/techniques/T1199/"
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "okta.authentication_context.issuer.id",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "okta.debug_context.debug_data.request_uri",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "okta.outcome.reason",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "okta.outcome.result",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "b8bbf8e8-d280-4339-9786-d09aa39b72be",
        "rule_id": "1ceb05c4-7d25-11ee-9562-f661ea17fbcd",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:05.407Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:42.294Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset:okta.system and okta.debug_context.debug_data.request_uri:/oauth2/v1/authorize/callback and\n    (not okta.authentication_context.issuer.id:Okta and event.action:(user.authentication.auth_via_IDP\n        or user.authentication.auth_via_inbound_SAML\n        or user.authentication.auth_via_mfa\n        or user.authentication.auth_via_social)\n        or event.action:user.session.start) or\n    (event.action:user.authentication.auth_via_IDP and okta.outcome.result:FAILURE\n        and okta.outcome.reason:(\"A SAML assert with the same ID has already been processed by Okta for a previous request\"\n            or \"Unable to match transformed username\"\n            or \"Unable to resolve IdP endpoint\"\n            or \"Unable to validate SAML Response\"\n            or \"Unable to validate incoming SAML Assertion\"))",
        "language": "kuery"
      },
      {
        "name": "New Okta Authentication Behavior Detected",
        "description": "Detects events where Okta behavior detection has identified a new authentication behavior.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating New Okta Authentication Behavior Detected\n\nThis rule detects events where Okta behavior detection has identified a new authentication behavior such as a new device or location.\n\n#### Possible investigation steps:\n- Identify the user involved in this action by examining the `okta.actor.id`, `okta.actor.type`, `okta.actor.alternate_id`, and `okta.actor.display_name` fields.\n- Determine the authentication anomaly by examining the `okta.debug_context.debug_data.risk_behaviors` and `okta.debug_context.debug_data.flattened` fields.\n- Determine the client used by the actor. Review the `okta.client.ip`, `okta.client.user_agent.raw_user_agent`, `okta.client.zone`, `okta.client.device`, and `okta.client.id` fields.\n- If the client is a device, check the `okta.device.id`, `okta.device.name`, `okta.device.os_platform`, `okta.device.os_version`, and `okta.device.managed` fields.\n- Review the past activities of the actor involved in this action by checking their previous actions.\n- Examine the `okta.request.ip_chain` field to potentially determine if the actor used a proxy or VPN to perform this action.\n- Evaluate the actions that happened just before and after this event in the `okta.event_type` field to help understand the full context of the activity.\n\n### False positive analysis:\n- A user may be using a new device or location to sign in.\n- The Okta behavior detection may be incorrectly identifying a new authentication behavior and need adjusted.\n\n### Response and remediation:\n- If the user is legitimate and the authentication behavior is not suspicious, no action is required.\n- If the user is legitimate but the authentication behavior is suspicious, consider resetting the user's password and enabling multi-factor authentication (MFA).\n    - If MFA is already enabled, consider resetting MFA for the user.\n- If the user is not legitimate, consider deactivating the user's account.\n- If this is a false positive, consider adjusting the Okta behavior detection settings.\n- Block the IP address or device used in the attempts if they appear suspicious, using the data from the `okta.client.ip` and `okta.device.id` fields.\n- Conduct a review of Okta policies and ensure they are in accordance with security best practices.",
        "output_index": "",
        "version": 206,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Tactic: Initial Access",
          "Data Source: Okta"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "15m",
        "from": "now-1800s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://sec.okta.com/articles/2023/08/cross-tenant-impersonation-prevention-and-detection",
          "https://unit42.paloaltonetworks.com/muddled-libra/",
          "https://help.okta.com/oie/en-us/content/topics/security/behavior-detection/about-behavior-detection.htm",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            }
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "okta.debug_context.debug_data.risk_behaviors",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "9bc9fd91-c5d2-4ca1-8717-64d41526eed1",
        "rule_id": "260486ee-7d98-11ee-9599-f661ea17fbcd",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:05.410Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:42.465Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset:okta.system and okta.debug_context.debug_data.risk_behaviors:*",
        "language": "kuery"
      },
      {
        "name": "Privilege Escalation via SUID/SGID",
        "description": "Identifies instances where a process is executed with user/group ID 0 (root), and a real user/group ID that is not 0. This is indicative of a process that has been granted SUID/SGID permissions, allowing it to run with elevated privileges. Attackers may leverage a misconfiguration for exploitation in order to escalate their privileges to root, or establish a backdoor for persistence.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 105,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Tactic: Persistence",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://gtfobins.github.io/#+suid",
          "https://www.elastic.co/security-labs/primer-on-persistence-mechanisms"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1068",
                "name": "Exploitation for Privilege Escalation",
                "reference": "https://attack.mitre.org/techniques/T1068/"
              },
              {
                "id": "T1548",
                "name": "Abuse Elevation Control Mechanism",
                "reference": "https://attack.mitre.org/techniques/T1548/",
                "subtechnique": [
                  {
                    "id": "T1548.001",
                    "name": "Setuid and Setgid",
                    "reference": "https://attack.mitre.org/techniques/T1548/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            }
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.group.id",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.real_group.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.real_user.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "455d8991-f0d6-4c40-8f60-c36f52464e69",
        "rule_id": "28eb3afe-131d-48b0-a8fc-9784f3d54f3c",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:05.412Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:44.224Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and (\n  (process.user.id == \"0\" and process.real_user.id != \"0\") or \n  (process.group.id == \"0\" and process.real_group.id != \"0\")\n) and (\n  process.name in (\n    \"aa-exec\", \"ab\", \"agetty\", \"alpine\", \"ar\", \"arj\", \"arp\", \"as\", \"ascii-xfr\", \"ash\", \"aspell\",\n    \"atobm\", \"awk\", \"base32\", \"base64\", \"basenc\", \"basez\", \"bash\", \"bc\", \"bridge\", \"busctl\",\n    \"busybox\", \"bzip2\", \"cabal\", \"capsh\", \"cat\", \"choom\", \"chown\", \"chroot\", \"clamscan\", \"cmp\",\n    \"column\", \"comm\", \"cp\", \"cpio\", \"cpulimit\", \"csh\", \"csplit\", \"csvtool\", \"cupsfilter\", \"curl\",\n    \"cut\", \"dash\", \"date\", \"dd\", \"debugfs\", \"dialog\", \"diff\", \"dig\", \"distcc\", \"dmsetup\", \"docker\",\n    \"dosbox\", \"ed\", \"efax\", \"elvish\", \"emacs\", \"env\", \"eqn\", \"espeak\", \"expand\", \"expect\", \"file\",\n    \"find\", \"fish\", \"flock\", \"fmt\", \"fold\", \"gawk\", \"gcore\", \"gdb\", \"genie\", \"genisoimage\", \"gimp\",\n    \"grep\", \"gtester\", \"gzip\", \"hd\", \"head\", \"hexdump\", \"highlight\", \"hping3\", \"iconv\", \"install\",\n    \"ionice\", \"ispell\", \"jjs\", \"join\", \"jq\", \"jrunscript\", \"julia\", \"ksh\", \"ksshell\", \"kubectl\",\n    \"ld.so\", \"less\", \"links\", \"logsave\", \"look\", \"lua\", \"make\", \"mawk\", \"minicom\", \"more\",\n    \"mosquitto\", \"msgattrib\", \"msgcat\", \"msgconv\", \"msgfilter\", \"msgmerge\", \"msguniq\", \"multitime\",\n    \"mv\", \"nasm\", \"nawk\", \"ncftp\", \"nft\", \"nice\", \"nl\", \"nm\", \"nmap\", \"node\", \"nohup\", \"ntpdate\",\n    \"od\", \"openssl\", \"openvpn\", \"pandoc\", \"paste\", \"perf\", \"perl\", \"pexec\", \"pg\", \"php\", \"pidstat\",\n    \"pr\", \"ptx\", \"python\", \"rc\", \"readelf\", \"restic\", \"rev\", \"rlwrap\", \"rsync\", \"rtorrent\",\n    \"run-parts\", \"rview\", \"rvim\", \"sash\", \"scanmem\", \"sed\", \"setarch\", \"setfacl\", \"setlock\", \"shuf\",\n    \"soelim\", \"softlimit\", \"sort\", \"sqlite3\", \"ss\", \"ssh-agent\", \"ssh-keygen\", \"ssh-keyscan\",\n    \"sshpass\", \"start-stop-daemon\", \"stdbuf\", \"strace\", \"strings\", \"sysctl\", \"systemctl\", \"tac\",\n    \"tail\", \"taskset\", \"tbl\", \"tclsh\", \"tee\", \"terraform\", \"tftp\", \"tic\", \"time\", \"timeout\", \"troff\",\n    \"ul\", \"unexpand\", \"uniq\", \"unshare\", \"unsquashfs\", \"unzip\", \"update-alternatives\", \"uudecode\",\n    \"uuencode\", \"vagrant\", \"varnishncsa\", \"view\", \"vigr\", \"vim\", \"vimdiff\", \"vipw\", \"w3m\", \"watch\",\n    \"wc\", \"wget\", \"whiptail\", \"xargs\", \"xdotool\", \"xmodmap\", \"xmore\", \"xxd\", \"xz\", \"yash\", \"zsh\",\n    \"zsoelim\"\n  ) or \n  process.name == \"ip\" and (\n    (process.args == \"-force\" and process.args in (\"-batch\", \"-b\")) or (process.args == \"exec\")\n  )\n) and not process.parent.name == \"spine\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Shell Configuration Creation or Modification",
        "description": "This rule monitors the creation/alteration of a shell configuration file. Unix systems use shell configuration files to set environment variables, create aliases, and customize the user's environment. Adversaries may modify or add a shell configuration file to execute malicious code and gain persistence in the system. This behavior is consistent with the Kaiji malware family.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 5,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Legitimate user shell modification activity."
        ],
        "references": [
          "https://intezer.com/blog/research/kaiji-new-chinese-linux-malware-turning-to-golang/",
          "https://www.elastic.co/security-labs/primer-on-persistence-mechanisms"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1546",
                "name": "Event Triggered Execution",
                "reference": "https://attack.mitre.org/techniques/T1546/",
                "subtechnique": [
                  {
                    "id": "T1546.004",
                    "name": "Unix Shell Configuration Modification",
                    "reference": "https://attack.mitre.org/techniques/T1546/004/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.Ext.original.extension",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "854e4597-0127-402b-b5f1-af92b8b996ab",
        "rule_id": "28f6f34b-8e16-487a-b5fd-9d22eb903db8",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:05.416Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:44.229Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"linux\" and event.action in (\"rename\", \"creation\") and file.path : (\n  // system-wide configurations\n  \"/etc/profile\", \"/etc/profile.d/*\", \"/etc/bash.bashrc\", \"/etc/bash.bash_logout\", \"/etc/zsh/*\",\n  \"/etc/csh.cshrc\", \"/etc/csh.login\", \"/etc/fish/config.fish\", \"/etc/ksh.kshrc\",\n  // root and user configurations\n  \"/home/*/.profile\", \"/home/*/.bashrc\", \"/home/*/.bash_login\", \"/home/*/.bash_logout\", \"/home/*/.bash_profile\",\n  \"/root/.profile\", \"/root/.bashrc\", \"/root/.bash_login\", \"/root/.bash_logout\", \"/root/.bash_profile\",\n  \"/home/*/.zprofile\", \"/home/*/.zshrc\", \"/root/.zprofile\", \"/root/.zshrc\",\n  \"/home/*/.cshrc\", \"/home/*/.login\", \"/home/*/.logout\", \"/root/.cshrc\", \"/root/.login\", \"/root/.logout\",\n  \"/home/*/.config/fish/config.fish\", \"/root/.config/fish/config.fish\",\n  \"/home/*/.kshrc\", \"/root/.kshrc\"\n) and not (\n  process.executable in (\n    \"/bin/dpkg\", \"/usr/bin/dpkg\", \"/bin/dockerd\", \"/usr/bin/dockerd\", \"/usr/sbin/dockerd\", \"/bin/microdnf\",\n    \"/usr/bin/microdnf\", \"/bin/rpm\", \"/usr/bin/rpm\", \"/bin/snapd\", \"/usr/bin/snapd\", \"/bin/yum\", \"/usr/bin/yum\",\n    \"/bin/dnf\", \"/usr/bin/dnf\", \"/bin/podman\", \"/usr/bin/podman\", \"/bin/dnf-automatic\", \"/usr/bin/dnf-automatic\",\n    \"/bin/pacman\", \"/usr/bin/pacman\", \"/usr/bin/dpkg-divert\", \"/bin/dpkg-divert\", \"/sbin/apk\", \"/usr/sbin/apk\",\n    \"/usr/local/sbin/apk\", \"/usr/bin/apt\", \"/usr/sbin/pacman\", \"/bin/podman\", \"/usr/bin/podman\", \"/usr/bin/puppet\",\n    \"/bin/puppet\", \"/opt/puppetlabs/puppet/bin/puppet\", \"/usr/bin/chef-client\", \"/bin/chef-client\",\n    \"/bin/autossl_check\", \"/usr/bin/autossl_check\", \"/proc/self/exe\", \"/dev/fd/*\",  \"/usr/bin/pamac-daemon\",\n    \"/bin/pamac-daemon\", \"/usr/lib/snapd/snapd\", \"/usr/sbin/adduser\", \"/usr/sbin/useradd\", \"/usr/local/bin/dockerd\",\n    \"/usr/sbin/gdm\", \"/usr/bin/unzip\", \"/usr/bin/gnome-shell\", \"/sbin/mkhomedir_helper\", \"/usr/sbin/sshd\",\n    \"/opt/puppetlabs/puppet/bin/ruby\", \"/usr/bin/xfce4-session\", \"/usr/libexec/oddjob/mkhomedir\", \"/sbin/useradd\",\n    \"/usr/lib/systemd/systemd\", \"/usr/sbin/crond\", \"/usr/bin/pamac-daemon\", \"/usr/sbin/mkhomedir_helper\",\n    \"/opt/pbis/sbin/lwsmd\", \"/usr/sbin/oddjobd\"\n  ) or\n  file.extension in (\"swp\", \"swpx\", \"swx\", \"dpkg-remove\") or\n  file.Ext.original.extension == \"dpkg-new\" or\n  process.executable : (\n    \"/nix/store/*\", \"/var/lib/dpkg/*\", \"/tmp/vmis.*\", \"/snap/*\", \"/dev/fd/*\", \"/usr/lib/virtualbox/*\",\n    \"/usr/libexec/platform-python*\"\n  ) or\n  process.executable == null or\n  process.name in (\"adclient\", \"mkhomedir_helper\", \"teleport\", \"mkhomedir\", \"adduser\", \"desktopDaemon\") or\n  (process.name == \"sed\" and file.name : \"sed*\") or\n  (process.name == \"perl\" and file.name : \"e2scrub_all.tmp*\") \n)",
        "language": "eql",
        "index": [
          "logs-endpoint.events.file*"
        ],
        "filters": []
      },
      {
        "name": "New Okta Identity Provider (IdP) Added by Admin",
        "description": "Detects the creation of a new Identity Provider (IdP) by a Super Administrator or Organization Administrator within Okta.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating New Okta Identity Provider (IdP) Added by Admin\n\nThis rule detects the creation of a new Identity Provider (IdP) by a Super Administrator or Organization Administrator within Okta.\n\n#### Possible investigation steps:\n- Identify the actor associated with the IdP creation by examining the `okta.actor.id`, `okta.actor.type`, `okta.actor.alternate_id`, and `okta.actor.display_name` fields.\n- Identify the IdP added by reviewing the `okta.target` field and determing if this IdP is authorized.\n- Determine the client used by the actor. Review the `okta.client.ip`, `okta.client.user_agent.raw_user_agent`, `okta.client.zone`, `okta.client.device`, and `okta.client.id` fields.\n- If the client is a device, check the `okta.device.id`, `okta.device.name`, `okta.device.os_platform`, `okta.device.os_version`, and `okta.device.managed` fields.\n- Review the past activities of the actor involved in this action by checking their previous actions logged in the `okta.target` field.\n- Examine the `okta.request.ip_chain` field to potentially determine if the actor used a proxy or VPN to perform this action.\n- Evaluate the actions that happened just before and after this event in the `okta.event_type` field to help understand the full context of the activity.\n\n### False positive analysis:\n- It might be a false positive if the action was part of a planned activity or performed by an authorized person.\n- Several unsuccessful attempts prior to this success, may indicate an adversary attempting to add an unauthorized IdP multiple times.\n\n### Response and remediation:\n- If the IdP is unauthorized, deactivate it immediately via the Okta console.\n- If the IdP is authorized, ensure that the actor who created it is authorized to do so.\n- If the actor is unauthorized, deactivate their account via the Okta console.\n- If the actor is authorized, ensure that the actor's account is not compromised.\n- Reset the user's password and enforce MFA re-enrollment, if applicable.\n- Block the IP address or device used in the attempts if they appear suspicious, using the data from the `okta.client.ip` and `okta.device.id` fields.\n- Conduct a review of Okta policies and ensure they are in accordance with security best practices.\n- If the deactivated IdP was crucial to the organization, consider adding a new IdP and removing the unauthorized IdP.",
        "output_index": "",
        "version": 205,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Tactic: Persistence",
          "Data Source: Okta"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "15m",
        "from": "now-1800s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://blog.cloudflare.com/cloudflare-investigation-of-the-january-2022-okta-compromise/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://sec.okta.com/articles/2023/08/cross-tenant-impersonation-prevention-and-detection",
          "https://unit42.paloaltonetworks.com/muddled-libra/",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1556",
                "name": "Modify Authentication Process",
                "reference": "https://attack.mitre.org/techniques/T1556/",
                "subtechnique": [
                  {
                    "id": "T1556.007",
                    "name": "Hybrid Identity",
                    "reference": "https://attack.mitre.org/techniques/T1556/007/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "okta.outcome.result",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "a610ce9a-4fa7-42d4-91c5-c03aa7c52991",
        "rule_id": "29b53942-7cd4-11ee-b70e-f661ea17fbcd",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:05.418Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:44.239Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset: \"okta.system\" and event.action: \"system.idp.lifecycle.create\" and okta.outcome.result: \"SUCCESS\"",
        "language": "kuery"
      },
      {
        "name": "Git Hook Created or Modified",
        "description": "This rule detects the creation or modification of a Git hook file on a Linux system. Git hooks are scripts that Git executes before or after events such as commit, push, and receive. They are used to automate tasks, enforce policies, and customize Git's behavior. Attackers can abuse Git hooks to maintain persistence on a system by executing malicious code whenever a specific Git event occurs.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 3,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Tactic: Execution",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://git-scm.com/docs/githooks/2.26.0",
          "https://www.elastic.co/security-labs/sequel-on-persistence-mechanisms"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1543",
                "name": "Create or Modify System Process",
                "reference": "https://attack.mitre.org/techniques/T1543/"
              },
              {
                "id": "T1574",
                "name": "Hijack Execution Flow",
                "reference": "https://attack.mitre.org/techniques/T1574/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.004",
                    "name": "Unix Shell",
                    "reference": "https://attack.mitre.org/techniques/T1059/004/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            }
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "58d09e74-ad90-4086-b0d3-83e1160f55b8",
        "rule_id": "ac531fcc-1d3b-476d-bbb5-1357728c9a37",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:05.421Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:17:00.801Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"linux\" and event.type == \"creation\" and file.path : \"*.git/hooks/*\" and\nfile.extension == null and process.executable != null and not (\n  process.executable in (\n    \"/bin/dpkg\", \"/usr/bin/dpkg\", \"/bin/dockerd\", \"/usr/bin/dockerd\", \"/usr/sbin/dockerd\", \"/bin/microdnf\",\n    \"/usr/bin/microdnf\", \"/bin/rpm\", \"/usr/bin/rpm\", \"/bin/snapd\", \"/usr/bin/snapd\", \"/bin/yum\", \"/usr/bin/yum\",\n    \"/bin/dnf\", \"/usr/bin/dnf\", \"/bin/podman\", \"/usr/bin/podman\", \"/bin/dnf-automatic\", \"/usr/bin/dnf-automatic\",\n    \"/bin/pacman\", \"/usr/bin/pacman\", \"/usr/bin/dpkg-divert\", \"/bin/dpkg-divert\", \"/sbin/apk\", \"/usr/sbin/apk\",\n    \"/usr/local/sbin/apk\", \"/usr/bin/apt\", \"/usr/sbin/pacman\", \"/bin/podman\", \"/usr/bin/podman\", \"/usr/bin/puppet\",\n    \"/bin/puppet\", \"/opt/puppetlabs/puppet/bin/puppet\", \"/usr/bin/chef-client\", \"/bin/chef-client\",\n    \"/bin/autossl_check\", \"/usr/bin/autossl_check\", \"/proc/self/exe\", \"/usr/bin/pamac-daemon\", \"/bin/pamac-daemon\",\n    \"/usr/local/bin/dockerd\", \"/sbin/dockerd\"\n  ) or\n  process.executable : (\"/nix/store/*\", \"/var/lib/dpkg/*\", \"/snap/*\", \"/dev/fd/*\") or\n  process.name in (\"git\", \"dirname\", \"tar\", \"gitea\", \"git-lfs\") or\n  (process.name == \"sed\" and file.name : \"sed*\") or\n  (process.name == \"perl\" and file.name : \"e2scrub_all.tmp*\") \n)",
        "language": "eql",
        "index": [
          "logs-endpoint.events.file*"
        ],
        "filters": []
      },
      {
        "name": "Persistence via KDE AutoStart Script or Desktop File Modification",
        "description": "Identifies the creation or modification of a K Desktop Environment (KDE) AutoStart script or desktop file that will execute upon each user logon. Adversaries may abuse this method for persistence.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Persistence via KDE AutoStart Script or Desktop File Modification\n\nK Desktop Environment (KDE) is a popular graphical desktop environment for Linux systems. It supports AutoStart scripts and desktop files that execute automatically upon user logon.\n\nAdversaries may exploit this feature to maintain persistence on a compromised system by creating or modifying these files.\n\nThe detection rule 'Persistence via KDE AutoStart Script or Desktop File Modification' is designed to identify such activities by monitoring file events on Linux systems. It specifically targets the creation or modification of files with extensions \".sh\" or \".desktop\" in various AutoStart directories. By detecting these events, the rule helps security analysts identify potential abuse of KDE AutoStart functionality by malicious actors.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n> This investigation guide uses [placeholder fields](https://www.elastic.co/guide/en/security/current/osquery-placeholder-fields.html) to dynamically pass alert data into Osquery queries. Placeholder fields were introduced in Elastic Stack version 8.7.0. If you're using Elastic Stack version 8.6.0 or earlier, you'll need to manually adjust this investigation guide's queries to ensure they properly run.\n\n### Possible investigation steps\n\n- Investigate the file that was created or modified.\n  - !{osquery{\"label\":\"Osquery - Retrieve File Listing Information\",\"query\":\"SELECT * FROM file WHERE ( path LIKE '/home/%/.config/autostart/%.sh' OR path LIKE '/home/%/.config/autostart/%.desktop'\\nOR path LIKE '/root/.config/autostart/%.sh' OR path LIKE '/root/.config/autostart/%.desktop' OR path LIKE\\n'/home/%/.kde/Autostart/%.sh' OR path LIKE '/home/%/.kde/Autostart/%.desktop' OR path LIKE '/root/.kde/Autostart/%.sh'\\nOR path LIKE '/root/.kde/Autostart/%.desktop' OR path LIKE '/home/%/.kde4/Autostart/%.sh' OR path LIKE\\n'/home/%/.kde4/Autostart/%.desktop' OR path LIKE '/root/.kde4/Autostart/%.sh' OR path LIKE\\n'/root/.kde4/Autostart/%.desktop' OR path LIKE '/home/%/.kde/share/autostart/%.sh' OR path LIKE\\n'/home/%/.kde/share/autostart/%.desktop' OR path LIKE '/root/.kde/share/autostart/%.sh' OR path LIKE\\n'/root/.kde/share/autostart/%.desktop' OR path LIKE '/home/%/.kde4/share/autostart/%.sh' OR path LIKE\\n'/home/%/.kde4/share/autostart/%.desktop' OR path LIKE '/root/.kde4/share/autostart/%.sh' OR path LIKE\\n'/root/.kde4/share/autostart/%.desktop' OR path LIKE '/home/%/.local/share/autostart/%.sh' OR path LIKE\\n'/home/%/.local/share/autostart/%.desktop' OR path LIKE '/root/.local/share/autostart/%.sh' OR path LIKE\\n'/root/.local/share/autostart/%.desktop' OR path LIKE '/home/%/.config/autostart-scripts/%.sh' OR path LIKE\\n'/home/%/.config/autostart-scripts/%.desktop' OR path LIKE '/root/.config/autostart-scripts/%.sh' OR path LIKE\\n'/root/.config/autostart-scripts/%.desktop' OR path LIKE '/etc/xdg/autostart/%.sh' OR path LIKE\\n'/etc/xdg/autostart/%.desktop' OR path LIKE '/usr/share/autostart/%.sh' OR path LIKE '/usr/share/autostart/%.desktop' )\\n\"}}\n  - !{osquery{\"label\":\"Osquery - Retrieve Additional File Listing Information\",\"query\":\"SELECT f.path, u.username AS file_owner, g.groupname AS group_owner, datetime(f.atime, 'unixepoch') AS\\nfile_last_access_time, datetime(f.mtime, 'unixepoch') AS file_last_modified_time, datetime(f.ctime, 'unixepoch') AS\\nfile_last_status_change_time, datetime(f.btime, 'unixepoch') AS file_created_time, f.size AS size_bytes FROM file f LEFT\\nJOIN users u ON f.uid = u.uid LEFT JOIN groups g ON f.gid = g.gid WHERE ( path LIKE '/home/%/.config/autostart/%.sh' OR\\npath LIKE '/home/%/.config/autostart/%.desktop' OR path LIKE '/root/.config/autostart/%.sh' OR path LIKE\\n'/root/.config/autostart/%.desktop' OR path LIKE '/home/%/.kde/Autostart/%.sh' OR path LIKE\\n'/home/%/.kde/Autostart/%.desktop' OR path LIKE '/root/.kde/Autostart/%.sh' OR path LIKE\\n'/root/.kde/Autostart/%.desktop' OR path LIKE '/home/%/.kde4/Autostart/%.sh' OR path LIKE\\n'/home/%/.kde4/Autostart/%.desktop' OR path LIKE '/root/.kde4/Autostart/%.sh' OR path LIKE\\n'/root/.kde4/Autostart/%.desktop' OR path LIKE '/home/%/.kde/share/autostart/%.sh' OR path LIKE\\n'/home/%/.kde/share/autostart/%.desktop' OR path LIKE '/root/.kde/share/autostart/%.sh' OR path LIKE\\n'/root/.kde/share/autostart/%.desktop' OR path LIKE '/home/%/.kde4/share/autostart/%.sh' OR path LIKE\\n'/home/%/.kde4/share/autostart/%.desktop' OR path LIKE '/root/.kde4/share/autostart/%.sh' OR path LIKE\\n'/root/.kde4/share/autostart/%.desktop' OR path LIKE '/home/%/.local/share/autostart/%.sh' OR path LIKE\\n'/home/%/.local/share/autostart/%.desktop' OR path LIKE '/root/.local/share/autostart/%.sh' OR path LIKE\\n'/root/.local/share/autostart/%.desktop' OR path LIKE '/home/%/.config/autostart-scripts/%.sh' OR path LIKE\\n'/home/%/.config/autostart-scripts/%.desktop' OR path LIKE '/root/.config/autostart-scripts/%.sh' OR path LIKE\\n'/root/.config/autostart-scripts/%.desktop' OR path LIKE '/etc/xdg/autostart/%.sh' OR path LIKE\\n'/etc/xdg/autostart/%.desktop' OR path LIKE '/usr/share/autostart/%.sh' OR path LIKE '/usr/share/autostart/%.desktop' )\\n\"}}\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence and whether they are located in expected locations.\n  - !{osquery{\"label\":\"Osquery - Retrieve Running Processes by User\",\"query\":\"SELECT pid, username, name FROM processes p JOIN users u ON u.uid = p.uid ORDER BY username\"}}\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Validate the activity is not related to planned patches, updates, network administrator activity, or legitimate software installations.\n- Investigate whether the altered scripts call other malicious scripts elsewhere on the file system. \n  - If scripts or executables were dropped, retrieve the files and determine if they are malicious:\n    - Use a private sandboxed malware analysis system to perform analysis.\n      - Observe and collect information about the following activities:\n        - Attempts to contact external domains and addresses.\n          - Check if the domain is newly registered or unexpected.\n          - Check the reputation of the domain or IP address.\n        - File access, modification, and creation activities.\n        - Cron jobs, services and other persistence mechanisms.\n            - !{osquery{\"label\":\"Osquery - Retrieve Crontab Information\",\"query\":\"SELECT * FROM crontab\"}}\n- Investigate abnormal behaviors by the subject process/user such as network connections, file modifications, and any other spawned child processes.\n  - Investigate listening ports and open sockets to look for potential command and control traffic or data exfiltration.\n    - !{osquery{\"label\":\"Osquery - Retrieve Listening Ports\",\"query\":\"SELECT pid, address, port, socket, protocol, path FROM listening_ports\"}}\n    - !{osquery{\"label\":\"Osquery - Retrieve Open Sockets\",\"query\":\"SELECT pid, family, remote_address, remote_port, socket, state FROM process_open_sockets\"}}\n  - Identify the user account that performed the action, analyze it, and check whether it should perform this kind of action.\n    - !{osquery{\"label\":\"Osquery - Retrieve Information for a Specific User\",\"query\":\"SELECT * FROM users WHERE username = {{user.name}}\"}}\n- Investigate whether the user is currently logged in and active.\n    - !{osquery{\"label\":\"Osquery - Investigate the Account Authentication Status\",\"query\":\"SELECT * FROM logged_in_users WHERE user = {{user.name}}\"}}\n\n### False positive analysis\n\n- If this activity is related to new benign software installation activity, consider adding exceptions â€” preferably with a combination of user and command line conditions.\n- If this activity is related to a system administrator who uses cron jobs for administrative purposes, consider adding exceptions for this specific administrator user account. \n- Try to understand the context of the execution by thinking about the user, machine, or business purpose. A small number of endpoints, such as servers with unique software, might appear unusual but satisfy a specific business need.\n\n### Response and Remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Leverage the incident response data and logging to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 114,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://userbase.kde.org/System_Settings/Autostart",
          "https://www.amnesty.org/en/latest/research/2020/09/german-made-finspy-spyware-found-in-egypt-and-mac-and-linux-versions-revealed/",
          "https://www.intezer.com/blog/research/operation-electrorat-attacker-creates-fake-companies-to-drain-your-crypto-wallets/",
          "https://www.elastic.co/security-labs/primer-on-persistence-mechanisms"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1547",
                "name": "Boot or Logon Autostart Execution",
                "reference": "https://attack.mitre.org/techniques/T1547/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from one of the following integrations:\n- Elastic Defend\n- Auditbeat\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n### Auditbeat Setup\nAuditbeat is a lightweight shipper that you can install on your servers to audit the activities of users and processes on your systems. For example, you can use Auditbeat to collect and centralize audit events from the Linux Audit Framework. You can also use Auditbeat to detect changes to critical files, like binaries and configuration files, and identify potential security policy violations.\n\n#### The following steps should be executed in order to add the Auditbeat on a Linux System:\n- Elastic provides repositories available for APT and YUM-based distributions. Note that we provide binary packages, but no source packages.\n- To install the APT and YUM repositories follow the setup instructions in this [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/setup-repositories.html).\n- To run Auditbeat on Docker follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/running-on-docker.html).\n- To run Auditbeat on Kubernetes follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/running-on-kubernetes.html).\n- For complete â€œSetup and Run Auditbeatâ€ information refer to the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/setting-up-and-running.html).\n\n#### Custom Ingest Pipeline\nFor versions <8.2, you need to add a custom ingest pipeline to populate `event.ingested` with @timestamp for non-elastic-agent indexes, like auditbeats/filebeat/winlogbeat etc. For more details to add a custom ingest pipeline refer to the [guide](https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "26c86f2d-aca5-4f0a-b38c-0540f59bfe07",
        "rule_id": "e3e904b3-0a8e-4e68-86a8-977a163e21d3",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:05.424Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:17:08.778Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"linux\" and event.type != \"deletion\" and\n  file.extension in (\"sh\", \"desktop\") and\n  file.path :\n    (\n      \"/home/*/.config/autostart/*\", \"/root/.config/autostart/*\",\n      \"/home/*/.kde/Autostart/*\", \"/root/.kde/Autostart/*\",\n      \"/home/*/.kde4/Autostart/*\", \"/root/.kde4/Autostart/*\",\n      \"/home/*/.kde/share/autostart/*\", \"/root/.kde/share/autostart/*\",\n      \"/home/*/.kde4/share/autostart/*\", \"/root/.kde4/share/autostart/*\",\n      \"/home/*/.local/share/autostart/*\", \"/root/.local/share/autostart/*\",\n      \"/home/*/.config/autostart-scripts/*\", \"/root/.config/autostart-scripts/*\",\n      \"/etc/xdg/autostart/*\", \"/usr/share/autostart/*\"\n    ) and\n    not process.name in (\n      \"yum\", \"dpkg\", \"install\", \"dnf\", \"teams\", \"yum-cron\", \"dnf-automatic\", \"docker\", \"dockerd\", \"rpm\", \"pacman\",\n      \"podman\", \"nautilus\", \"remmina\", \"cinnamon-settings.py\", \"executor\", \"xfce4-clipman\", \"jetbrains-toolbox\",\n      \"ansible-admin\"\n    )",
        "language": "eql",
        "index": [
          "auditbeat-*",
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "Attempt to Modify an Okta Network Zone",
        "description": "Detects attempts to modify an Okta network zone. Okta network zones can be configured to limit or restrict access to a network based on IP addresses or geolocations. An adversary may attempt to modify, delete, or deactivate an Okta network zone in order to remove or weaken an organization's security controls.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Attempt to Modify an Okta Network Zone\n\nThe modification of an Okta network zone is a critical event as it could potentially allow an adversary to gain unrestricted access to your network. This rule detects attempts to modify, delete, or deactivate an Okta network zone, which may suggest an attempt to remove or weaken an organization's security controls.\n\n#### Possible investigation steps:\n\n- Identify the actor related to the alert by reviewing `okta.actor.id`, `okta.actor.type`, `okta.actor.alternate_id`, or `okta.actor.display_name` fields in the alert.\n- Review the `okta.client.user_agent.raw_user_agent` field to understand the device and software used by the actor.\n- Examine the `okta.outcome.reason` field for additional context around the modification attempt.\n- Check the `okta.outcome.result` field to confirm the network zone modification attempt.\n- Check if there are multiple network zone modification attempts from the same actor or IP address (`okta.client.ip`).\n- Check for successful logins immediately following the modification attempt.\n- Verify whether the actor's activity aligns with typical behavior or if any unusual activity took place around the time of the modification attempt.\n\n### False positive analysis:\n\n- Check if there were issues with the Okta system at the time of the modification attempt. This could indicate a system error rather than a genuine threat activity.\n- Check the geographical location (`okta.request.ip_chain.geographical_context`) and time of the modification attempt. If these match the actor's normal behavior, it might be a false positive.\n- Verify the actor's administrative rights to ensure they are correctly configured.\n\n### Response and remediation:\n\n- If unauthorized modification is confirmed, initiate the incident response process.\n- Immediately lock the affected actor account and require a password change.\n- Consider resetting MFA tokens for the actor and require re-enrollment.\n- Check if the compromised account was used to access or alter any sensitive data or systems.\n- If a specific modification technique was used, ensure your systems are patched or configured to prevent such techniques.\n- Assess the criticality of affected services and servers.\n- Work with your IT team to minimize the impact on users and maintain business continuity.\n- If multiple accounts are affected, consider a broader reset or audit of MFA tokens.\n- Implement security best practices [outlined](https://www.okta.com/blog/2019/10/9-admin-best-practices-to-keep-your-org-secure/) by Okta.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).",
        "output_index": "",
        "version": 410,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Data Source: Okta",
          "Use Case: Network Security Monitoring",
          "Tactic: Defense Evasion"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Consider adding exceptions to this rule to filter false positives if Oyour organization's Okta network zones are regularly modified."
        ],
        "references": [
          "https://help.okta.com/en/prod/Content/Topics/Security/network/network-zones.htm",
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.007",
                    "name": "Disable or Modify Cloud Firewall",
                    "reference": "https://attack.mitre.org/techniques/T1562/007/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "addcff34-e322-442e-85ce-4134da522a6a",
        "rule_id": "e48236ca-b67a-4b4e-840c-fdc7782bc0c3",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:05.427Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:17:08.792Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset:okta.system and event.action:(zone.update or network_zone.rule.disabled or zone.remove_blacklist)",
        "language": "kuery"
      },
      {
        "name": "Possible Okta DoS Attack",
        "description": "Detects possible Denial of Service (DoS) attacks against an Okta organization. An adversary may attempt to disrupt an organization's business operations by performing a DoS attack against its Okta service.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 409,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Data Source: Okta",
          "Tactic: Impact"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0040",
              "name": "Impact",
              "reference": "https://attack.mitre.org/tactics/TA0040/"
            },
            "technique": [
              {
                "id": "T1498",
                "name": "Network Denial of Service",
                "reference": "https://attack.mitre.org/techniques/T1498/"
              },
              {
                "id": "T1499",
                "name": "Endpoint Denial of Service",
                "reference": "https://attack.mitre.org/techniques/T1499/"
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "8e6ac02b-fbc1-44b5-b810-98159fd5421c",
        "rule_id": "e6e3ecff-03dd-48ec-acbd-54a04de10c68",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:05.430Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:17:08.813Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset:okta.system and event.action:(application.integration.rate_limit_exceeded or system.org.rate_limit.warning or system.org.rate_limit.violation or core.concurrency.org.limit.violation)",
        "language": "kuery"
      },
      {
        "name": "High Number of Okta User Password Reset or Unlock Attempts",
        "description": "Identifies a high number of Okta user password reset or account unlock attempts. An adversary may attempt to obtain unauthorized access to Okta user accounts using these methods and attempt to blend in with normal activity in their target's environment and evade detection.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating High Number of Okta User Password Reset or Unlock Attempts\n\nThis rule is designed to detect a suspiciously high number of password reset or account unlock attempts in Okta. Excessive password resets or account unlocks can be indicative of an attacker's attempt to gain unauthorized access to an account.\n\n#### Possible investigation steps:\n- Identify the actor associated with the excessive attempts. The `okta.actor.alternate_id` field can be used for this purpose.\n- Determine the client used by the actor. You can look at `okta.client.device`, `okta.client.ip`, `okta.client.user_agent.raw_user_agent`, `okta.client.ip_chain.ip`, and `okta.client.geographical_context`.\n- Review the `okta.outcome.result` and `okta.outcome.reason` fields to understand the outcome of the password reset or unlock attempts.\n- Review the event actions associated with these attempts. Look at the `event.action` field and filter for actions related to password reset and account unlock attempts.\n- Check for other similar patterns of behavior from the same actor or IP address. If there is a high number of failed login attempts before the password reset or unlock attempts, this may suggest a brute force attack.\n- Also, look at the times when these attempts were made. If these were made during off-hours, it could further suggest an adversary's activity.\n\n### False positive analysis:\n- This alert might be a false positive if there are legitimate reasons for a high number of password reset or unlock attempts. This could be due to the user forgetting their password or account lockouts due to too many incorrect attempts.\n- Check the actor's past behavior. If this is their usual behavior and they have a valid reason for it, then it might be a false positive.\n\n### Response and remediation:\n- If unauthorized attempts are confirmed, initiate the incident response process.\n- Reset the user's password and enforce MFA re-enrollment, if applicable.\n- Block the IP address or device used in the attempts, if they appear suspicious.\n- If the attack was facilitated by a particular technique, ensure your systems are patched or configured to prevent such techniques.\n- Consider a security review of your Okta policies and rules to ensure they follow security best practices.",
        "output_index": "",
        "version": 412,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Data Source: Okta",
          "Tactic: Defense Evasion"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-3600s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic",
          "@BenB196",
          "Austin Songer"
        ],
        "false_positives": [
          "The number of Okta user password reset or account unlock attempts will likely vary between organizations. To fit this rule to their organization, users can duplicate this rule and edit the schedule and threshold values in the new rule."
        ],
        "references": [
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1078",
                "name": "Valid Accounts",
                "reference": "https://attack.mitre.org/techniques/T1078/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1078",
                "name": "Valid Accounts",
                "reference": "https://attack.mitre.org/techniques/T1078/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1078",
                "name": "Valid Accounts",
                "reference": "https://attack.mitre.org/techniques/T1078/"
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "764188f9-5e38-4eb7-9c40-b182c20ab038",
        "rule_id": "e90ee3af-45fc-432e-a850-4a58cf14a457",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:05.432Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:17:08.924Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "threshold",
        "query": "event.dataset:okta.system and\n  event.action:(system.email.account_unlock.sent_message or system.email.password_reset.sent_message or\n                system.sms.send_account_unlock_message or system.sms.send_password_reset_message or\n                system.voice.send_account_unlock_call or system.voice.send_password_reset_call or\n                user.account.unlock_token)",
        "threshold": {
          "field": [
            "okta.actor.alternate_id"
          ],
          "value": 5
        },
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Attempt to Deactivate an Okta Application",
        "description": "Detects attempts to deactivate an Okta application. An adversary may attempt to modify, deactivate, or delete an Okta application in order to weaken an organization's security controls or disrupt their business operations.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Attempt to Deactivate an Okta Application\n\nThis rule detects attempts to deactivate an Okta application. Unauthorized deactivation could lead to disruption of services and pose a significant risk to the organization.\n\n#### Possible investigation steps:\n- Identify the actor associated with the deactivation attempt by examining the `okta.actor.id`, `okta.actor.type`, `okta.actor.alternate_id`, and `okta.actor.display_name` fields.\n- Determine the client used by the actor. Review the `okta.client.ip`, `okta.client.user_agent.raw_user_agent`, `okta.client.zone`, `okta.client.device`, and `okta.client.id` fields.\n- If the client is a device, check the `okta.device.id`, `okta.device.name`, `okta.device.os_platform`, `okta.device.os_version`, and `okta.device.managed` fields.\n- Understand the context of the event from the `okta.debug_context.debug_data` and `okta.authentication_context` fields.\n- Check the `okta.outcome.result` and `okta.outcome.reason` fields to see if the attempt was successful or failed.\n- Review the past activities of the actor involved in this action by checking their previous actions logged in the `okta.target` field.\n- Analyze the `okta.transaction.id` and `okta.transaction.type` fields to understand the context of the transaction.\n- Evaluate the actions that happened just before and after this event in the `okta.event_type` field to help understand the full context of the activity.\n\n### False positive analysis:\n- It might be a false positive if the action was part of a planned activity, performed by an authorized person, or if the `okta.outcome.result` field shows a failure.\n- An unsuccessful attempt might also indicate an authorized user having trouble rather than a malicious activity.\n\n### Response and remediation:\n- If unauthorized deactivation attempts are confirmed, initiate the incident response process.\n- Block the IP address or device used in the attempts if they appear suspicious, using the data from the `okta.client.ip` and `okta.device.id` fields.\n- Reset the user's password and enforce MFA re-enrollment, if applicable.\n- Conduct a review of Okta policies and ensure they are in accordance with security best practices.\n- If the deactivated application was crucial for business operations, coordinate with the relevant team to reactivate it and minimize the impact.",
        "output_index": "",
        "version": 410,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Data Source: Okta",
          "Tactic: Impact"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Consider adding exceptions to this rule to filter false positives if your organization's Okta applications are regularly deactivated and the behavior is expected."
        ],
        "references": [
          "https://help.okta.com/en/prod/Content/Topics/Apps/Apps_Apps.htm",
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0040",
              "name": "Impact",
              "reference": "https://attack.mitre.org/tactics/TA0040/"
            },
            "technique": [
              {
                "id": "T1489",
                "name": "Service Stop",
                "reference": "https://attack.mitre.org/techniques/T1489/"
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "16f5983f-b21f-4658-a28d-a714ab9da641",
        "rule_id": "edb91186-1c7e-4db8-b53e-bfa33a1a0a8a",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:05.435Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:17:09.016Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset:okta.system and event.action:application.lifecycle.deactivate",
        "language": "kuery"
      },
      {
        "name": "Okta FastPass Phishing Detection",
        "description": "Detects when Okta FastPass prevents a user from authenticating to a phishing website.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 307,
        "tags": [
          "Tactic: Initial Access",
          "Use Case: Identity and Access Audit",
          "Data Source: Okta"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Austin Songer"
        ],
        "false_positives": [],
        "references": [
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://sec.okta.com/fastpassphishingdetection",
          "https://sec.okta.com/articles/2023/08/cross-tenant-impersonation-prevention-and-detection",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1566",
                "name": "Phishing",
                "reference": "https://attack.mitre.org/techniques/T1566/"
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.\n\nThis rule requires Okta to have the following turned on:\n\nOkta Identity Engine - select 'Phishing Resistance for FastPass' under Settings > Features in the Admin Console.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "okta.event_type",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "okta.outcome.reason",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "3434f17a-5552-4749-9b1b-2797bdf2da41",
        "rule_id": "ee39a9f7-5a79-4b0a-9815-d36b3cf28d3e",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:05.438Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:17:09.026Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset:okta.system and event.category:authentication and\n  okta.event_type:user.authentication.auth_via_mfa and event.outcome:failure and okta.outcome.reason:\"FastPass declined phishing attempt\"",
        "language": "kuery"
      },
      {
        "name": "Administrator Role Assigned to an Okta User",
        "description": "Identifies when an administrator role is assigned to an Okta user. An adversary may attempt to assign an administrator role to an Okta user in order to assign additional permissions to a user account and maintain access to their target's environment.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 409,
        "tags": [
          "Data Source: Okta",
          "Use Case: Identity and Access Audit",
          "Tactic: Persistence"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Administrator roles may be assigned to Okta users by a Super Admin user. Verify that the behavior was expected. Exceptions can be added to this rule to filter expected behavior."
        ],
        "references": [
          "https://help.okta.com/en/prod/Content/Topics/Security/administrators-admin-comparison.htm",
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta",
          "https://www.elastic.co/security-labs/okta-and-lapsus-what-you-need-to-know"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1098",
                "name": "Account Manipulation",
                "reference": "https://attack.mitre.org/techniques/T1098/"
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "917aba9a-1d5a-4ab6-a2d4-8d352e96feb6",
        "rule_id": "f06414a6-f2a4-466d-8eba-10f85e8abf71",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:05.441Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:17:09.899Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset:okta.system and event.action:user.account.privilege.grant",
        "language": "kuery"
      },
      {
        "name": "Printer User (lp) Shell Execution",
        "description": "This detection rule addresses multiple vulnerabilities in the CUPS printing system, including CVE-2024-47176, CVE-2024-47076, CVE-2024-47175, and CVE-2024-47177. Specifically, this rule detects shell executions from the foomatic-rip parent process through the default printer user (lp). These flaws impact components like cups-browsed, libcupsfilters, libppd, and foomatic-rip, allowing remote unauthenticated attackers to manipulate IPP URLs or inject malicious data through crafted UDP packets or network spoofing. This can result in arbitrary command execution when a print job is initiated.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Printer User (lp) Shell Execution\n\nThis rule identifies potential exploitation attempts of several vulnerabilities in the CUPS printing system (CVE-2024-47176, CVE-2024-47076, CVE-2024-47175, CVE-2024-47177). These vulnerabilities allow attackers to send crafted IPP requests or manipulate UDP packets to execute arbitrary commands or modify printer configurations. Attackers can exploit these flaws to inject malicious data, leading to Remote Code Execution (RCE) on affected systems.\n\n#### Possible Investigation Steps\n\n- Investigate the incoming IPP requests or UDP packets targeting port 631.\n- Examine the printer configurations on the system to determine if any unauthorized printers or URLs have been added.\n- Investigate the process tree to check if any unexpected processes were triggered as a result of IPP activity. Review the executable files for legitimacy.\n- Check for additional alerts related to the compromised system or user within the last 48 hours.\n- Investigate network traffic logs for suspicious outbound connections to unrecognized domains or IP addresses.\n- Check if any of the contacted domains or addresses are newly registered or have a suspicious reputation.\n- Retrieve any scripts or executables dropped by the attack for further analysis in a private sandbox environment:\n- Analyze potential malicious activity, including:\n  - Attempts to communicate with external servers.\n  - File access or creation of unauthorized executables.\n  - Cron jobs, services, or other persistence mechanisms.\n\n### Related Rules\n- Cupsd or Foomatic-rip Shell Execution - 476267ff-e44f-476e-99c1-04c78cb3769d\n- Network Connection by Cups or Foomatic-rip Child - e80ee207-9505-49ab-8ca8-bc57d80e2cab\n- File Creation by Cups or Foomatic-rip Child - b9b14be7-b7f4-4367-9934-81f07d2f63c4\n- Suspicious Execution from Foomatic-rip or Cupsd Parent - 986361cd-3dac-47fe-afa1-5c5dd89f2fb4\n\n### False Positive Analysis\n\n- This activity is rarely legitimate. However, verify the context to rule out non-malicious printer configuration changes or legitimate IPP requests.\n\n### Response and Remediation\n\n- Initiate the incident response process based on the triage outcome.\n- Isolate the compromised host to prevent further exploitation.\n- If the investigation confirms malicious activity, search the environment for additional compromised hosts.\n- Implement network segmentation or restrictions to contain the attack.\n- Stop suspicious processes or services tied to CUPS exploitation.\n- Block identified Indicators of Compromise (IoCs), including IP addresses, domains, or hashes of involved files.\n- Review compromised systems for backdoors, such as reverse shells or persistence mechanisms like cron jobs.\n- Investigate potential credential exposure on compromised systems and reset passwords for any affected accounts.\n- Restore the original printer configurations or uninstall unauthorized printer entries.\n- Perform a thorough antimalware scan to identify any lingering threats or artifacts from the attack.\n- Investigate how the attacker gained initial access and address any weaknesses to prevent future exploitation.\n- Use insights from the incident to improve detection and response times in future incidents (MTTD and MTTR).\n",
        "output_index": "",
        "version": 2,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Use Case: Vulnerability",
          "Tactic: Execution",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/security-labs/cups-overflow",
          "https://www.evilsocket.net/2024/09/26/Attacking-UNIX-systems-via-CUPS-Part-I/",
          "https://gist.github.com/stong/c8847ef27910ae344a7b5408d9840ee1",
          "https://github.com/RickdeJager/cupshax/blob/main/cupshax.py"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1203",
                "name": "Exploitation for Client Execution",
                "reference": "https://attack.mitre.org/techniques/T1203/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "a6848bd8-c1a6-4c87-a635-875cf4cc4a47",
        "rule_id": "f86cd31c-5c7e-4481-99d7-6875a3e31309",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:05.444Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:17:10.104Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and user.name == \"lp\" and\nprocess.parent.name in (\"cupsd\", \"foomatic-rip\", \"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\") and\nprocess.name in (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\") and not (\n  process.command_line like (\n    \"*/tmp/foomatic-*\", \"*-sDEVICE=ps2write*\", \"*printf*\", \"/bin/sh -e -c cat\", \"/bin/bash -c cat\",\n    \"/bin/bash -e -c cat\"\n  ) or\n  process.args like \"gs*\"\n)",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Attempt to Deactivate an Okta Policy Rule",
        "description": "Detects attempts to deactivate a rule within an Okta policy. An adversary may attempt to deactivate a rule within an Okta policy in order to remove or weaken an organization's security controls.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Attempt to Deactivate an Okta Policy Rule\n\nIdentity and Access Management (IAM) systems like Okta serve as the first line of defense for an organization's network, and are often targeted by adversaries. By disabling security rules, adversaries can circumvent multi-factor authentication, access controls, or other protective measures enforced by these policies, enabling unauthorized access, privilege escalation, or other malicious activities.\n\nThis rule detects attempts to deactivate a rule within an Okta policy, which could be indicative of an adversary's attempt to weaken an organization's security controls. A threat actor may do this to remove barriers to their activities or enable future attacks.\n\n#### Possible investigation steps:\n\n- Identify the actor related to the alert by reviewing `okta.actor.id`, `okta.actor.type`, `okta.actor.alternate_id`, or `okta.actor.display_name` fields in the alert.\n- Review the `okta.client.user_agent.raw_user_agent` field to understand the device and software used by the actor.\n- Examine the `okta.outcome.reason` field for additional context around the deactivation attempt.\n- Check the `okta.outcome.result` field to confirm the policy rule deactivation attempt.\n- Check if there are multiple policy rule deactivation attempts from the same actor or IP address (`okta.client.ip`).\n- Check for successful logins immediately following the policy rule deactivation attempt.\n- Verify whether the actor's activity aligns with typical behavior or if any unusual activity took place around the time of the deactivation attempt.\n\n### False positive analysis:\n\n- Check if there were issues with the Okta system at the time of the deactivation attempt. This could indicate a system error rather than a genuine threat activity.\n- Check the geographical location (`okta.request.ip_chain.geographical_context`) and time of the deactivation attempt. If these match the actor's normal behavior, it might be a false positive.\n- Verify the actor's administrative rights to ensure they are correctly configured.\n\n### Response and remediation:\n\n- If unauthorized policy rule deactivation is confirmed, initiate the incident response process.\n- Immediately lock the affected actor account and require a password change.\n- Consider resetting MFA tokens for the actor and require re-enrollment.\n- Check if the compromised account was used to access or alter any sensitive data or systems.\n- If a specific deactivation technique was used, ensure your systems are patched or configured to prevent such techniques.\n- Assess the criticality of affected services and servers.\n- Work with your IT team to minimize the impact on users and maintain business continuity.\n- If multiple accounts are affected, consider a broader reset or audit of MFA tokens.\n- Implement security best practices [outlined](https://www.okta.com/blog/2019/10/9-admin-best-practices-to-keep-your-org-secure/) by Okta.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).",
        "output_index": "",
        "version": 411,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Tactic: Defense Evasion",
          "Data Source: Okta"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Consider adding exceptions to this rule to filter false positives if Okta MFA rules are regularly deactivated in your organization."
        ],
        "references": [
          "https://help.okta.com/en/prod/Content/Topics/Security/Security_Policies.htm",
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.007",
                    "name": "Disable or Modify Cloud Firewall",
                    "reference": "https://attack.mitre.org/techniques/T1562/007/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "1bfeea5d-0368-4aff-acf6-0cd7803bf245",
        "rule_id": "cc92c835-da92-45c9-9f29-b4992ad621a0",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:05.446Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:17:04.954Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset:okta.system and event.action:policy.rule.deactivate",
        "language": "kuery"
      },
      {
        "name": "Modification or Removal of an Okta Application Sign-On Policy",
        "description": "Detects attempts to modify or delete a sign on policy for an Okta application. An adversary may attempt to modify or delete the sign on policy for an Okta application in order to remove or weaken an organization's security controls.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 410,
        "tags": [
          "Tactic: Persistence",
          "Use Case: Identity and Access Audit",
          "Data Source: Okta"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Consider adding exceptions to this rule to filter false positives if sign on policies for Okta applications are regularly modified or deleted in your organization."
        ],
        "references": [
          "https://help.okta.com/en/prod/Content/Topics/Security/App_Based_Signon.htm",
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1556",
                "name": "Modify Authentication Process",
                "reference": "https://attack.mitre.org/techniques/T1556/"
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "04d43d80-108c-4737-b6a9-e331df922cb0",
        "rule_id": "cd16fb10-0261-46e8-9932-a0336278cdbe",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:05.449Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:17:04.959Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset:okta.system and event.action:(application.policy.sign_on.update or application.policy.sign_on.rule.delete)",
        "language": "kuery"
      },
      {
        "name": "MFA Deactivation with no Re-Activation for Okta User Account",
        "description": "Detects multi-factor authentication (MFA) deactivation with no subsequent re-activation for an Okta user account. An adversary may deactivate MFA for an Okta user account in order to weaken the authentication requirements for the account.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating MFA Deactivation with no Re-Activation for Okta User Account\n\nMFA is used to provide an additional layer of security for user accounts. An adversary may achieve MFA deactivation for an Okta user account to achieve persistence.\n\nThis rule fires when an Okta user account has MFA deactivated and no subsequent MFA reactivation is observed within 12 hours.\n\n#### Possible investigation steps:\n\n- Identify the actor related to the alert by reviewing `okta.actor.alternate_id` field in the alert. This should give the username of the account being targeted.\n- Review `okta.target` or `user.target.full_name` fields to determine if deactivation was performed by a se parate user.\n- Using the `okta.actor.alternate_id` field, search  for MFA re-activation events where `okta.event_type` is `user.mfa.factor.activate`.\n- Review events where `okta.event_type` is `user.authenticate*` to determine if the user account had suspicious login activity.\n    - Geolocation details found in `client.geo*` related fields may be useful in determining if the login activity was suspicious for this user.\n\n#### False positive steps:\n\n- Determine with the target user if MFA deactivation was expected.\n- Determine if MFA is required for the target user account.\n\n#### Response and remediation:\n\n- If the MFA deactivation was not expected, consider deactivating the user\n    - This should be followed by resetting the user's password and re-enabling MFA.\n- If the MFA deactivation was expected, consider adding an exception to this rule to filter false positives.\n- Investigate the source of the attack. If a specific machine or network is compromised, additional steps may need to be taken to address the issue.\n- Encourage users to use complex, unique passwords and consider implementing multi-factor authentication.\n- Check if the compromised account was used to access or alter any sensitive data, applications or systems.\n- Review the client user-agent to determine if it's a known custom application that can be whitelisted.\n",
        "output_index": "",
        "version": 412,
        "tags": [
          "Tactic: Persistence",
          "Use Case: Identity and Access Audit",
          "Data Source: Okta",
          "Domain: Cloud"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "6h",
        "from": "now-43200s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "If the behavior of deactivating MFA for Okta user accounts is expected, consider adding exceptions to this rule to filter false positives."
        ],
        "references": [
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1556",
                "name": "Modify Authentication Process",
                "reference": "https://attack.mitre.org/techniques/T1556/",
                "subtechnique": [
                  {
                    "id": "T1556.006",
                    "name": "Multi-Factor Authentication",
                    "reference": "https://attack.mitre.org/techniques/T1556/006/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.\n",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "okta.actor.id",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "okta.event_type",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "okta.outcome.reason",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "okta.outcome.result",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "003ee9ea-3f24-4664-9580-28aae201ce76",
        "rule_id": "cd89602e-9db0-48e3-9391-ae3bf241acd8",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:05.452Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:17:04.992Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by okta.actor.id with maxspan=12h\n    [any where event.dataset == \"okta.system\" and okta.event_type in (\"user.mfa.factor.deactivate\", \"user.mfa.factor.reset_all\")\n        and okta.outcome.reason != \"User reset SECURITY_QUESTION factor\" and okta.outcome.result == \"SUCCESS\"]\n    ![any where event.dataset == \"okta.system\" and okta.event_type == \"user.mfa.factor.activate\"]",
        "language": "eql",
        "index": [
          "filebeat-*",
          "logs-okta.system*"
        ],
        "filters": []
      },
      {
        "name": "Okta User Session Impersonation",
        "description": "A user has initiated a session impersonation granting them access to the environment with the permissions of the user they are impersonating. This would likely indicate Okta administrative access and should only ever occur if requested and expected.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Okta User Session Impersonation\n\nThe detection of an Okta User Session Impersonation indicates that a user has initiated a session impersonation which grants them access with the permissions of the user they are impersonating. This type of activity typically indicates Okta administrative access and should only ever occur if requested and expected.\n\n#### Possible investigation steps\n\n- Identify the actor associated with the impersonation event by checking the `okta.actor.id`, `okta.actor.type`, `okta.actor.alternate_id`, or `okta.actor.display_name` fields.\n- Review the `event.action` field to confirm the initiation of the impersonation event.\n- Check the `event.time` field to understand the timing of the event.\n- Check the `okta.target.id`, `okta.target.type`, `okta.target.alternate_id`, or `okta.target.display_name` to identify the user who was impersonated.\n- Review any activities that occurred during the impersonation session. Look for any activities related to the impersonated user's account during and after the impersonation event.\n\n### False positive analysis\n\n- Verify if the session impersonation was part of an approved activity. Check if it was associated with any documented administrative tasks or troubleshooting efforts.\n- Ensure that the impersonation session was initiated by an authorized individual. You can check this by verifying the `okta.actor.id` or `okta.actor.display_name` against the list of approved administrators.\n\n### Response and remediation\n\n- If the impersonation was not authorized, consider it as a breach. Suspend the user account of the impersonator immediately.\n- Reset the user session and invalidate any active sessions related to the impersonated user.\n- If a specific impersonation technique was used, ensure that systems are patched or configured to prevent such techniques.\n- Conduct a thorough investigation to understand the extent of the breach and the potential impact on the systems and data.\n- Review and update your security policies to prevent such incidents in the future.\n- Implement additional monitoring and logging of Okta events to improve visibility of user actions.",
        "output_index": "",
        "version": 411,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Tactic: Credential Access",
          "Data Source: Okta"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "15m",
        "from": "now-1800s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://blog.cloudflare.com/cloudflare-investigation-of-the-january-2022-okta-compromise/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta",
          "https://www.elastic.co/security-labs/okta-and-lapsus-what-you-need-to-know"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            }
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "b32c24c0-5a72-4e8e-abc3-de3977126d36",
        "rule_id": "cdbebdc1-dc97-43c6-a538-f26a20c0a911",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:05.455Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:17:04.996Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset:okta.system and event.action:user.session.impersonation.initiate",
        "language": "kuery"
      },
      {
        "name": "Attempt to Delete an Okta Application",
        "description": "Detects attempts to delete an Okta application. An adversary may attempt to modify, deactivate, or delete an Okta application in order to weaken an organization's security controls or disrupt their business operations.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 409,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Data Source: Okta",
          "Tactic: Impact"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Consider adding exceptions to this rule to filter false positives if your organization's Okta applications are regularly deleted and the behavior is expected."
        ],
        "references": [
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0040",
              "name": "Impact",
              "reference": "https://attack.mitre.org/tactics/TA0040/"
            },
            "technique": [
              {
                "id": "T1489",
                "name": "Service Stop",
                "reference": "https://attack.mitre.org/techniques/T1489/"
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "6f56cc01-b0ad-4ebf-a537-e0840f0a44fd",
        "rule_id": "d48e1c13-4aca-4d1f-a7b1-a9161c0ad86f",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:05.692Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:17:05.093Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset:okta.system and event.action:application.lifecycle.delete",
        "language": "kuery"
      },
      {
        "name": "Attempts to Brute Force an Okta User Account",
        "description": "Identifies when an Okta user account is locked out 3 times within a 3 hour window. An adversary may attempt a brute force or password spraying attack to obtain unauthorized access to user accounts. The default Okta authentication policy ensures that a user account is locked out after 10 failed authentication attempts.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Attempts to Brute Force an Okta User Account\n\nBrute force attacks aim to guess user credentials through exhaustive trial-and-error attempts. In this context, Okta accounts are targeted.\n\nThis rule fires when an Okta user account has been locked out 3 times within a 3-hour window. This could indicate an attempted brute force or password spraying attack to gain unauthorized access to the user account. Okta's default authentication policy locks a user account after 10 failed authentication attempts.\n\n#### Possible investigation steps:\n\n- Identify the actor related to the alert by reviewing `okta.actor.alternate_id` field in the alert. This should give the username of the account being targeted.\n- Review the `okta.event_type` field to understand the nature of the events that led to the account lockout.\n- Check the `okta.severity` and `okta.display_message` fields for more context around the lockout events.\n- Look for correlation of events from the same IP address. Multiple lockouts from the same IP address might indicate a single source for the attack.\n- If the IP is not familiar, investigate it. The IP could be a proxy, VPN, Tor node, cloud datacenter, or a legitimate IP turned malicious.\n- Determine if the lockout events occurred during the user's regular activity hours. Unusual timing may indicate malicious activity.\n- Examine the authentication methods used during the lockout events by checking the `okta.authentication_context.credential_type` field.\n\n### False positive analysis:\n\n- Determine whether the account owner or an internal user made repeated mistakes in entering their credentials, leading to the account lockout.\n- Ensure there are no known network or application issues that might cause these events.\n\n### Response and remediation:\n\n- Alert the user and your IT department immediately.\n- If unauthorized access is confirmed, initiate your incident response process.\n- Investigate the source of the attack. If a specific machine or network is compromised, additional steps may need to be taken to address the issue.\n- Require the affected user to change their password.\n- If the attack is ongoing, consider blocking the IP address initiating the brute force attack.\n- Implement account lockout policies to limit the impact of brute force attacks.\n- Encourage users to use complex, unique passwords and consider implementing multi-factor authentication.\n- Check if the compromised account was used to access or alter any sensitive data or systems.",
        "output_index": "",
        "version": 412,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Tactic: Credential Access",
          "Data Source: Okta"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-10800s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic",
          "@BenB196",
          "Austin Songer"
        ],
        "false_positives": [],
        "references": [
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1110",
                "name": "Brute Force",
                "reference": "https://attack.mitre.org/techniques/T1110/"
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "87b9d6ee-f640-4ffa-bb76-f46e5b6e479e",
        "rule_id": "e08ccd49-0380-4b2b-8d71-8000377d6e49",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:08.412Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:17:07.264Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "threshold",
        "query": "event.dataset:okta.system and event.action:user.account.lock",
        "threshold": {
          "field": [
            "okta.actor.alternate_id"
          ],
          "value": 3
        },
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Attempt to Delete an Okta Policy Rule",
        "description": "Detects attempts to delete a rule within an Okta policy. An adversary may attempt to delete an Okta policy rule in order to weaken an organization's security controls.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Attempt to Delete an Okta Policy Rule\n\nOkta policy rules are integral components of an organization's security controls, as they define how user access to resources is managed. Deletion of a rule within an Okta policy could potentially weaken the organization's security posture, allowing for unauthorized access or facilitating other malicious activities.\n\nThis rule detects attempts to delete an Okta policy rule, which could indicate an adversary's attempt to weaken an organization's security controls. Adversaries may do this to circumvent security measures and enable further malicious activities.\n\n#### Possible investigation steps:\n\n- Identify the actor related to the alert by reviewing `okta.actor.id`, `okta.actor.type`, `okta.actor.alternate_id`, or `okta.actor.display_name` fields in the alert.\n- Review the `okta.client.user_agent.raw_user_agent` field to understand the device and software used by the actor.\n- Examine the `okta.outcome.reason` field for additional context around the deletion attempt.\n- Check the `okta.outcome.result` field to confirm the policy rule deletion attempt.\n- Check if there are multiple policy rule deletion attempts from the same actor or IP address (`okta.client.ip`).\n- Check for successful logins immediately following the policy rule deletion attempt.\n- Verify whether the actor's activity aligns with typical behavior or if any unusual activity took place around the time of the deletion attempt.\n\n### False positive analysis:\n\n- Check if there were issues with the Okta system at the time of the deletion attempt. This could indicate a system error rather than a genuine threat activity.\n- Check the geographical location (`okta.request.ip_chain.geographical_context`) and time of the deletion attempt. If these match the actor's normal behavior, it might be a false positive.\n- Verify the actor's administrative rights to ensure they are correctly configured.\n\n### Response and remediation:\n\n- If unauthorized policy rule deletion is confirmed, initiate the incident response process.\n- Immediately lock the affected actor account and require a password change.\n- Consider resetting MFA tokens for the actor and require re-enrollment.\n- Check if the compromised account was used to access or alter any sensitive data or systems.\n- If a specific deletion technique was used, ensure your systems are patched or configured to prevent such techniques.\n- Assess the criticality of affected services and servers.\n- Work with your IT team to minimize the impact on users and maintain business continuity.\n- If multiple accounts are affected, consider a broader reset or audit of MFA tokens.\n- Implement security best practices [outlined](https://www.okta.com/blog/2019/10/9-admin-best-practices-to-keep-your-org-secure/) by Okta.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).",
        "output_index": "",
        "version": 410,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Data Source: Okta",
          "Tactic: Defense Evasion"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Consider adding exceptions to this rule to filter false positives if Okta MFA rules are regularly modified in your organization."
        ],
        "references": [
          "https://help.okta.com/en/prod/Content/Topics/Security/Security_Policies.htm",
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.007",
                    "name": "Disable or Modify Cloud Firewall",
                    "reference": "https://attack.mitre.org/techniques/T1562/007/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "4dc9e5a5-69c4-4040-aee0-f31376704d20",
        "rule_id": "d5d86bf5-cf0c-4c06-b688-53fdc072fdfd",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:08.420Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:17:06.976Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset:okta.system and event.action:policy.rule.delete",
        "language": "kuery"
      },
      {
        "name": "Multiple Okta Sessions Detected for a Single User",
        "description": "Detects when a user has started multiple Okta sessions with the same user account and different session IDs. This may indicate that an attacker has stolen the user's session cookie and is using it to access the user's account from a different location.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 206,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Data Source: Okta",
          "Tactic: Lateral Movement"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-3600s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "A user may have multiple sessions open at the same time, such as on a mobile device and a laptop."
        ],
        "references": [
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://sec.okta.com/articles/2023/08/cross-tenant-impersonation-prevention-and-detection",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1550",
                "name": "Use Alternate Authentication Material",
                "reference": "https://attack.mitre.org/techniques/T1550/",
                "subtechnique": [
                  {
                    "id": "T1550.004",
                    "name": "Web Session Cookie",
                    "reference": "https://attack.mitre.org/techniques/T1550/004/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "okta.actor.display_name",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "okta.actor.id",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "okta.authentication_context.external_session_id",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "okta.event_type",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "7ece9f5e-b5bc-4389-8891-c0e22cb4e7f6",
        "rule_id": "621e92b6-7e54-11ee-bdc0-f661ea17fbcd",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": true
        },
        "updated_at": "2024-12-16T15:18:08.423Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:50.531Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "threshold",
        "query": "event.dataset:okta.system and okta.event_type:user.session.start and okta.authentication_context.external_session_id:*\n    and not (okta.actor.id: okta* or okta.actor.display_name: okta*)",
        "threshold": {
          "field": [
            "okta.actor.id"
          ],
          "value": 1,
          "cardinality": [
            {
              "field": "okta.authentication_context.external_session_id",
              "value": 3
            }
          ]
        },
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Unauthorized Scope for Public App OAuth2 Token Grant with Client Credentials",
        "description": "Identifies a failed OAuth 2.0 token grant attempt for a public client app using client credentials. This event is generated when a public client app attempts to exchange a client credentials grant for an OAuth 2.0 access token, but the request is denied due to the lack of required scopes. This could indicate compromised client credentials in which an adversary is attempting to obtain an access token for unauthorized scopes. This is a [New Terms](https://www.elastic.co/guide/en/security/master/rules-ui-create.html#create-new-terms-rule) rule where the `okta.actor.display_name` field value has not been seen in the last 14 days regarding this event.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 205,
        "tags": [
          "Domain: SaaS",
          "Data Source: Okta",
          "Use Case: Threat Detection",
          "Use Case: Identity and Access Audit",
          "Tactic: Defense Evasion"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.blog/news-insights/company-news/security-alert-stolen-oauth-user-tokens/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1550",
                "name": "Use Alternate Authentication Material",
                "reference": "https://attack.mitre.org/techniques/T1550/",
                "subtechnique": [
                  {
                    "id": "T1550.001",
                    "name": "Application Access Token",
                    "reference": "https://attack.mitre.org/techniques/T1550/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "okta.actor.display_name",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "okta.actor.type",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "okta.client.user_agent.raw_user_agent",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "okta.debug_context.debug_data.flattened.grantType",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "okta.debug_context.debug_data.flattened.requestedScopes",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "okta.outcome.reason",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "okta.outcome.result",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "9d785ba6-df06-4be7-9132-0009703cb11f",
        "rule_id": "6649e656-6f85-11ef-8876-f661ea17fbcc",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:08.426Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:50.613Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "event.dataset: okta.system\n    and event.action: \"app.oauth2.as.token.grant\"\n    and okta.actor.type: \"PublicClientApp\"\n    and okta.debug_context.debug_data.flattened.grantType: \"client_credentials\"\n    and okta.outcome.result: \"FAILURE\"\n    and not okta.client.user_agent.raw_user_agent: \"Okta-Integrations\"\n    and not okta.actor.display_name: (Okta* or Datadog)\n    and not okta.debug_context.debug_data.flattened.requestedScopes: (\"okta.logs.read\" or \"okta.eventHooks.read\" or \"okta.inlineHooks.read\")\n    and okta.outcome.reason: \"no_matching_scope\"",
        "new_terms_fields": [
          "okta.actor.display_name"
        ],
        "history_window_start": "now-14d",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Attempt to Modify an Okta Policy",
        "description": "Detects attempts to modify an Okta policy. An adversary may attempt to modify an Okta policy in order to weaken an organization's security controls. For example, an adversary may attempt to modify an Okta multi-factor authentication (MFA) policy in order to weaken the authentication requirements for user accounts.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Attempt to Modify an Okta Policy\n\nModifications to Okta policies may indicate attempts to weaken an organization's security controls. If such an attempt is detected, consider the following steps for investigation.\n\n#### Possible investigation steps:\n- Identify the actor associated with the event. Check the fields `okta.actor.id`, `okta.actor.type`, `okta.actor.alternate_id`, and `okta.actor.display_name`.\n- Determine the client used by the actor. You can look at `okta.client.device`, `okta.client.ip`, `okta.client.user_agent.raw_user_agent`, `okta.client.ip_chain.ip`, and `okta.client.geographical_context`.\n- Check the nature of the policy modification. You can review the `okta.target` field, especially `okta.target.display_name` and `okta.target.id`.\n- Examine the `okta.outcome.result` and `okta.outcome.reason` fields to understand the outcome of the modification attempt.\n- Check if there have been other similar modification attempts in a short time span from the same actor or IP address.\n\n### False positive analysis:\n- This alert might be a false positive if Okta policies are regularly updated in your organization as a part of normal operations.\n- Check if the actor associated with the event has legitimate rights to modify the Okta policies.\n- Verify the actor's geographical location and the time of the modification attempt. If these align with the actor's regular behavior, it could be a false positive.\n\n### Response and remediation:\n- If unauthorized modification is confirmed, initiate the incident response process.\n- Lock the actor's account and enforce password change as an immediate response.\n- Reset MFA tokens for the actor and enforce re-enrollment, if applicable.\n- Review any other actions taken by the actor to assess the overall impact.\n- If the attack was facilitated by a particular technique, ensure your systems are patched or configured to prevent such techniques.\n- Consider a security review of your Okta policies and rules to ensure they follow security best practices.",
        "output_index": "",
        "version": 410,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Data Source: Okta",
          "Tactic: Defense Evasion"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Consider adding exceptions to this rule to filter false positives if Okta policies are regularly modified in your organization."
        ],
        "references": [
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.007",
                    "name": "Disable or Modify Cloud Firewall",
                    "reference": "https://attack.mitre.org/techniques/T1562/007/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "b41290e8-5bc5-4019-a3ad-2bb131db45d4",
        "rule_id": "6731fbf2-8f28-49ed-9ab9-9a918ceb5a45",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:08.437Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:52.383Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset:okta.system and event.action:policy.lifecycle.update",
        "language": "kuery"
      },
      {
        "name": "Attempt to Revoke Okta API Token",
        "description": "Identifies attempts to revoke an Okta API token. An adversary may attempt to revoke or delete an Okta API token to disrupt an organization's business operations.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Attempt to Revoke Okta API Token\n\nThe rule alerts when attempts are made to revoke an Okta API token. The API tokens are critical for integration services, and revoking them may lead to disruption in services. Therefore, it's important to validate these activities.\n\n#### Possible investigation steps:\n- Identify the actor associated with the API token revocation attempt. You can use the `okta.actor.alternate_id` field for this purpose.\n- Determine the client used by the actor. Review the `okta.client.device`, `okta.client.ip`, `okta.client.user_agent.raw_user_agent`, `okta.client.ip_chain.ip`, and `okta.client.geographical_context` fields.\n- Verify if the API token revocation was authorized or part of some planned activity.\n- Check the `okta.outcome.result` and `okta.outcome.reason` fields to see if the attempt was successful or failed.\n- Analyze the past activities of the actor involved in this action. An actor who usually performs such activities may indicate a legitimate reason.\n- Evaluate the actions that happened just before and after this event. It can help understand the full context of the activity.\n\n### False positive analysis:\n- It might be a false positive if the action was part of a planned activity or was performed by an authorized person.\n\n### Response and remediation:\n- If unauthorized revocation attempts are confirmed, initiate the incident response process.\n- Block the IP address or device used in the attempts, if they appear suspicious.\n- Reset the user's password and enforce MFA re-enrollment, if applicable.\n- Conduct a review of Okta policies and ensure they are in accordance with security best practices.\n- If the revoked token was used for critical integrations, coordinate with the relevant team to minimize the impact.",
        "output_index": "",
        "version": 410,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Data Source: Okta",
          "Tactic: Impact"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "If the behavior of revoking Okta API tokens is expected, consider adding exceptions to this rule to filter false positives."
        ],
        "references": [
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0040",
              "name": "Impact",
              "reference": "https://attack.mitre.org/tactics/TA0040/"
            },
            "technique": [
              {
                "id": "T1531",
                "name": "Account Access Removal",
                "reference": "https://attack.mitre.org/techniques/T1531/"
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "2dec789c-a178-4662-992f-647aa7c0ffd4",
        "rule_id": "676cff2b-450b-4cf1-8ed2-c0c58a4a2dd7",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:08.440Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:52.393Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset:okta.system and event.action:system.api_token.revoke",
        "language": "kuery"
      },
      {
        "name": "Okta ThreatInsight Threat Suspected Promotion",
        "description": "Okta ThreatInsight is a feature that provides valuable debug data regarding authentication and authorization processes, which is logged in the system. Within this data, there is a specific field called threat_suspected, which represents Okta's internal evaluation of the authentication or authorization workflow. When this field is set to True, it suggests the presence of potential credential access techniques, such as password-spraying, brute-forcing, replay attacks, and other similar threats.",
        "risk_score": 47,
        "severity": "medium",
        "rule_name_override": "okta.display_message",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\nThis is a promotion rule for Okta ThreatInsight suspected threat events, which are alertable events per the vendor.\nConsult vendor documentation on interpreting specific events.",
        "output_index": "",
        "version": 409,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Data Source: Okta"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [
          {
            "field": "okta.debug_context.debug_data.risk_level",
            "operator": "equals",
            "severity": "low",
            "value": "LOW"
          },
          {
            "field": "okta.debug_context.debug_data.risk_level",
            "operator": "equals",
            "severity": "medium",
            "value": "MEDIUM"
          },
          {
            "field": "okta.debug_context.debug_data.risk_level",
            "operator": "equals",
            "severity": "high",
            "value": "HIGH"
          }
        ],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://help.okta.com/en-us/Content/Topics/Security/threat-insight/configure-threatinsight-system-log.html",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [],
        "setup": "",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "okta.debug_context.debug_data.threat_suspected",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "30ffeb47-ab2f-4e08-9989-0d9da7a30ffe",
        "rule_id": "6885d2ae-e008-4762-b98a-e8e1cd3a81e9",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:08.442Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:52.416Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset:okta.system and (event.action:security.threat.detected or okta.debug_context.debug_data.threat_suspected: true)",
        "language": "kuery"
      },
      {
        "name": "First Occurrence of Okta User Session Started via Proxy",
        "description": "Identifies the first occurrence of an Okta user session started via a proxy.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating First Occurrence of Okta User Session Started via Proxy\n\nThis rule detects the first occurrence of an Okta user session started via a proxy. This rule is designed to help identify suspicious authentication behavior that may be indicative of an attacker attempting to gain access to an Okta account while remaining anonymous. This rule leverages the New Terms rule type feature where the `okta.actor.id` value is checked against the previous 7 days of data to determine if the value has been seen before for this activity.\n\n#### Possible investigation steps:\n- Identify the user involved in this action by examining the `okta.actor.id`, `okta.actor.type`, `okta.actor.alternate_id`, and `okta.actor.display_name` fields.\n- Determine the client used by the actor. Review the `okta.client.ip`, `okta.client.user_agent.raw_user_agent`, `okta.client.zone`, `okta.client.device`, and `okta.client.id` fields.\n- Examine the `okta.debug_context.debug_data.flattened` field for more information about the proxy used.\n- Review the `okta.request.ip_chain` field for more information about the geographic location of the proxy.\n- Review the past activities of the actor involved in this action by checking their previous actions.\n- Evaluate the actions that happened just before and after this event in the `okta.event_type` field to help understand the full context of the activity.\n\n### False positive analysis:\n- A user may have legitimately started a session via a proxy for security or privacy reasons.\n\n### Response and remediation:\n- Review the profile of the user involved in this action to determine if proxy usage may be expected.\n- If the user is legitimate and the authentication behavior is not suspicious, no action is required.\n- If the user is legitimate but the authentication behavior is suspicious, consider resetting the user's password and enabling multi-factor authentication (MFA).\n    - If MFA is already enabled, consider resetting MFA for the user.\n- If the user is not legitimate, consider deactivating the user's account.\n- Conduct a review of Okta policies and ensure they are in accordance with security best practices.\n\n## Setup",
        "output_index": "",
        "version": 205,
        "tags": [
          "Tactic: Initial Access",
          "Use Case: Identity and Access Audit",
          "Data Source: Okta"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://developer.okta.com/docs/reference/api/system-log/#issuer-object",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://sec.okta.com/articles/2023/08/cross-tenant-impersonation-prevention-and-detection",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1133",
                "name": "External Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1133/"
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "okta.actor.id",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "okta.event_type",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "okta.security_context.is_proxy",
            "type": "boolean",
            "ecs": false
          }
        ],
        "id": "32c6171d-aa9e-4eae-ade9-54b92751db12",
        "rule_id": "6f1bb4b2-7dc8-11ee-92b2-f661ea17fbcd",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:08.445Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:52.518Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "event.dataset:okta.system and okta.event_type: (user.session.start or user.authentication.verify) and okta.security_context.is_proxy:true and not okta.actor.id: okta*",
        "new_terms_fields": [
          "okta.actor.id",
          "cloud.account.id"
        ],
        "history_window_start": "now-7d",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Attempt to Reset MFA Factors for an Okta User Account",
        "description": "Detects attempts to reset an Okta user's enrolled multi-factor authentication (MFA) factors. An adversary may attempt to reset the MFA factors for an Okta user's account in order to register new MFA factors and abuse the account to blend in with normal activity in the victim's environment.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 410,
        "tags": [
          "Tactic: Persistence",
          "Use Case: Identity and Access Audit",
          "Data Source: Okta"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Consider adding exceptions to this rule to filter false positives if the MFA factors for Okta user accounts are regularly reset in your organization."
        ],
        "references": [
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta",
          "https://www.elastic.co/security-labs/okta-and-lapsus-what-you-need-to-know"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1098",
                "name": "Account Manipulation",
                "reference": "https://attack.mitre.org/techniques/T1098/"
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "a6de2a9c-178b-4cd1-ba83-eb61ab904110",
        "rule_id": "729aa18d-06a6-41c7-b175-b65b739b1181",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:08.448Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:52.598Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset:okta.system and event.action:user.mfa.factor.reset_all",
        "language": "kuery"
      },
      {
        "name": "Unauthorized Access to an Okta Application",
        "description": "Identifies unauthorized access attempts to Okta applications.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 410,
        "tags": [
          "Tactic: Initial Access",
          "Use Case: Identity and Access Audit",
          "Data Source: Okta"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic",
          "Austin Songer"
        ],
        "false_positives": [],
        "references": [
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1078",
                "name": "Valid Accounts",
                "reference": "https://attack.mitre.org/techniques/T1078/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            }
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            }
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            }
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "f387aa16-6d39-4d8e-9515-9d8dd9890df5",
        "rule_id": "4edd3e1a-3aa0-499b-8147-4d2ea43b1613",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:08.450Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:48.435Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset:okta.system and event.action:app.generic.unauth_app_access_attempt",
        "language": "kuery"
      },
      {
        "name": "Multiple Okta User Auth Events with Same Device Token Hash Behind a Proxy",
        "description": "Detects when Okta user authentication events are reported for multiple users with the same device token hash behind a proxy.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Multiple Okta User Auth Events with Same Device Token Hash Behind a Proxy\n\nThis rule detects when Okta user authentication events are reported for multiple users with the same device token hash behind a proxy. This may indicate that a shared device between users, or that a user is using a proxy to access multiple accounts for password spraying.\n\n#### Possible investigation steps:\n- Identify the users involved in this action by examining the `okta.actor.id`, `okta.actor.type`, `okta.actor.alternate_id`, and `okta.actor.display_name` fields.\n- Determine the device client used for these actions by analyzing `okta.client.ip`, `okta.client.user_agent.raw_user_agent`, `okta.client.zone`, `okta.client.device`, and `okta.client.id` fields.\n    - Since the device is behind a proxy, the `okta.client.ip` field will not be useful for determining the actual device IP address.\n- Review the `okta.request.ip_chain` field for more information about the geographic location of the proxy.\n- With Okta end users identified, review the `okta.debug_context.debug_data.dt_hash` field.\n    - Historical analysis should indicate if this device token hash is commonly associated with the user.\n- Review the `okta.event_type` field to determine the type of authentication event that occurred.\n    - If the event type is `user.authentication.sso`, the user may have legitimately started a session via a proxy for security or privacy reasons.\n    - If the event type is `user.authentication.password`, the user may be using a proxy to access multiple accounts for password spraying.\n- Examine the `okta.outcome.result` field to determine if the authentication was successful.\n- Review the past activities of the actor(s) involved in this action by checking their previous actions.\n- Evaluate the actions that happened just before and after this event in the `okta.event_type` field to help understand the full context of the activity.\n    - This may help determine the authentication and authorization actions that occurred between the user, Okta and application.\n\n### False positive analysis:\n- A user may have legitimately started a session via a proxy for security or privacy reasons.\n- Users may share an endpoint related to work or personal use in which separate Okta accounts are used.\n    - Architecturally, this shared endpoint may leverage a proxy for security or privacy reasons.\n    - Shared systems such as Kiosks and conference room computers may be used by multiple users.\n    - Shared working spaces may have a single endpoint that is used by multiple users.\n\n### Response and remediation:\n- Review the profile of the users involved in this action to determine if proxy usage may be expected.\n- If the user is legitimate and the authentication behavior is not suspicious based on device analysis, no action is required.\n- If the user is legitimate but the authentication behavior is suspicious, consider resetting passwords for the users involves and enabling multi-factor authentication (MFA).\n    - If MFA is already enabled, consider resetting MFA for the users.\n- If any of the users are not legitimate, consider deactivating the user's account.\n- Conduct a review of Okta policies and ensure they are in accordance with security best practices.\n- Check with internal IT teams to determine if the accounts involved recently had MFA reset at the request of the user.\n    - If so, confirm with the user this was a legitimate request.\n    - If so and this was not a legitimate request, consider deactivating the user's account temporarily.\n        - Reset passwords and reset MFA for the user.\n- If this is a false positive, consider adding the `okta.debug_context.debug_data.dt_hash` field to the `exceptions` list in the rule.\n    - This will prevent future occurrences of this event for this device from triggering the rule.\n",
        "output_index": "",
        "version": 206,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Data Source: Okta",
          "Tactic: Credential Access"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "An Okta admnistrator may be logged into multiple accounts from the same host for legitimate reasons.",
          "Users may share an endpoint related to work or personal use in which separate Okta accounts are used.",
          "Shared systems such as Kiosks and conference room computers may be used by multiple users."
        ],
        "references": [
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://sec.okta.com/articles/2023/08/cross-tenant-impersonation-prevention-and-detection",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1110",
                "name": "Brute Force",
                "reference": "https://attack.mitre.org/techniques/T1110/",
                "subtechnique": [
                  {
                    "id": "T1110.003",
                    "name": "Password Spraying",
                    "reference": "https://attack.mitre.org/techniques/T1110/003/"
                  }
                ]
              },
              {
                "id": "T1110",
                "name": "Brute Force",
                "reference": "https://attack.mitre.org/techniques/T1110/",
                "subtechnique": [
                  {
                    "id": "T1110.004",
                    "name": "Credential Stuffing",
                    "reference": "https://attack.mitre.org/techniques/T1110/004/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "okta.actor.id",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "okta.debug_context.debug_data.dt_hash",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "okta.event_type",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "okta.security_context.is_proxy",
            "type": "boolean",
            "ecs": false
          }
        ],
        "id": "52b9956a-7d4c-491d-b4ae-58f782d962d2",
        "rule_id": "50887ba8-7ff7-11ee-a038-f661ea17fbcd",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:08.453Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:48.445Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "threshold",
        "query": "event.dataset:okta.system\n    and not okta.actor.id:okta* and okta.debug_context.debug_data.dt_hash:*\n    and okta.event_type:user.authentication* and okta.security_context.is_proxy:true",
        "threshold": {
          "field": [
            "okta.debug_context.debug_data.dt_hash"
          ],
          "value": 1,
          "cardinality": [
            {
              "field": "okta.actor.id",
              "value": 3
            }
          ]
        },
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Stolen Credentials Used to Login to Okta Account After MFA Reset",
        "description": "Detects a sequence of suspicious activities on Windows hosts indicative of credential compromise, followed by efforts to undermine multi-factor authentication (MFA) and single sign-on (SSO) mechanisms for an Okta user account.",
        "risk_score": 73,
        "severity": "high",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Stolen Credentials Used to Login to Okta Account After MFA Reset\n\nThis rule detects a sequence of suspicious activities on Windows hosts indicative of credential compromise, followed by efforts to undermine multi-factor authentication (MFA) and single sign-on (SSO) mechanisms for an Okta user account.\n\nTypically, adversaries initially extract credentials from targeted endpoints through various means. Subsequently, leveraging social engineering, they may seek to reset the MFA credentials associated with an Okta account, especially in scenarios where Active Directory (AD) services are integrated with Okta. Successfully resetting MFA allows the unauthorized use of stolen credentials to gain access to the compromised Okta account. The attacker can then register their own device for MFA, paving the way for unfettered access to the user's Okta account and any associated SaaS applications. This is particularly alarming if the compromised account has administrative rights, as it could lead to widespread access to organizational resources and configurations.\n\n#### Possible investigation steps:\n- Identify the user account associated with the Okta login attempt by examining the `user.name` field.\n- Identify the endpoint for the Credential Access alert for this user by examining the `host.name` and `host.id` fields from the alert document.\n- Cross-examine the Okta user and endpoint user to confirm that they are the same person.\n- Reach out to the user to confirm if they have intentionally reset their MFA credentials recently or asked for help in doing so.\n- If the user is unaware of the MFA reset, incident response may be required immediately to prevent further compromise.\n\n### False positive analysis:\n- A Windows administrator may have triggered a low-fidelity credential access alert during a legitimate administrative action. Following this, the administrator may have reset the MFA credentials for themselves and then logged into the Okta console for AD directory services integration management.\n\n### Response and remediation:\n- If confirmed that the user did not intentionally have their MFA factor reset, deactivate the user account.\n- After deactivation, reset the user's password and MFA factor to regain control of the account.\n    - Ensure that all user sessions are stopped during this process.\n- Immediately reset the user's AD password as well if Okta does not sync back to AD.\n- Forensic analysis on the user's endpoint may be required to determine the root cause of the compromise and identify the scope of the compromise.\n- Review Okta system logs to identify any other suspicious activity associated with the user account, such as creation of a backup account.\n- With the device ID captured from the MFA factor reset, search across all Okta logs for any other activity associated with the device ID.\n\n## Setup",
        "output_index": "",
        "version": 205,
        "tags": [
          "Tactic: Persistence",
          "Use Case: Identity and Access Audit",
          "Data Source: Okta",
          "Data Source: Elastic Defend",
          "Rule Type: Higher-Order Rule",
          "Domain: Endpoint",
          "Domain: Cloud"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "6h",
        "from": "now-43200s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "A Windows administrator may have triggered a low-fidelity credential access alert during a legitimate administrative action. Following this, the administrator may have reset the MFA credentials for themselves and then logged into the Okta console for AD directory services integration management."
        ],
        "references": [
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://sec.okta.com/articles/2023/08/cross-tenant-impersonation-prevention-and-detection",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1556",
                "name": "Modify Authentication Process",
                "reference": "https://attack.mitre.org/techniques/T1556/",
                "subtechnique": [
                  {
                    "id": "T1556.006",
                    "name": "Multi-Factor Authentication",
                    "reference": "https://attack.mitre.org/techniques/T1556/006/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The Okta and Elastic Defend fleet integration structured data is required to be compatible with this rule. Directory services integration in Okta with AD synced is also required for this rule to be effective as it relies on triaging `user.name` from Okta and Elastic Defend events.",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "okta.event_type",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "signal.rule.threat.tactic.name",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "user.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "26b34989-2df1-49f9-a0e0-dc63aa2848b6",
        "rule_id": "5610b192-7f18-11ee-825b-f661ea17fbcd",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:08.456Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:48.551Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by user.name with maxspan=12h\n    [any where host.os.type == \"windows\" and signal.rule.threat.tactic.name == \"Credential Access\"]\n    [any where event.dataset == \"okta.system\" and okta.event_type == \"user.mfa.factor.update\"]\n    [any where event.dataset == \"okta.system\" and okta.event_type: (\"user.session.start\", \"user.authentication*\")]",
        "language": "eql",
        "index": [
          "filebeat-*",
          "logs-okta*",
          ".alerts-security.*",
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "AWS STS GetCallerIdentity API Called for the First Time",
        "description": "An adversary with access to a set of compromised credentials may attempt to verify that the credentials are valid and determine what account they are using. This rule looks for the first time an identity has called the STS `GetCallerIdentity` API operation in the last 15 days, which may be an indicator of compromised credentials. A legitimate user would not need to call this operation as they should know the account they are using.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating AWS GetCallerIdentity API Called for the First Time\n\nAWS Security Token Service (AWS STS) is a service that enables you to request temporary, limited-privilege credentials for users.\nThe `GetCallerIdentity` function returns details about the IAM user or role owning the credentials used to call the operation.\nNo permissions are required to run this operation and the same information is returned even when access is denied.\nThis rule looks for use of the `GetCallerIdentity` operation. This is a [New Terms](https://www.elastic.co/guide/en/security/master/rules-ui-create.html#create-new-terms-rule) rule indicating this is the first time a specific user identity has called this operation within the last 15 days.\n\n#### Possible investigation steps\n\n- Identify the account and its role in the environment, a role belonging to a service like Lambda or an EC2 instance would be highly suspicious.\n- Identify the applications or users that should use this account.\n- Investigate other alerts associated with the account during the past 48 hours.\n- Investigate abnormal values in the `user_agent.original` field by comparing them with the intended and authorized usage and historical data. Suspicious user agent values include non-SDK, AWS CLI, custom user agents, etc.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences involving other users.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Considering the source IP address and geolocation of the user who issued the command:\n    - Do they look normal for the calling user?\n    - If the source is an EC2 IP address, is it associated with an EC2 instance in one of your accounts or is the source IP from an EC2 instance that's not under your control?\n    - If it is an authorized EC2 instance, is the activity associated with normal behavior for the instance role or roles? Are there any other alerts or signs of suspicious activity involving this instance?\n- Review IAM permission policies for the user identity.\n- If you suspect the account has been compromised, scope potentially compromised assets by tracking servers, services, and data accessed by the account in the last 24 hours.\n\n### False positive analysis\n\n- False positives may occur due to the intended usage of the service. Tuning is needed in order to have higher confidence. Consider adding exceptions â€” preferably with a combination of user agent and IP address conditions.\n- Automation workflows that rely on the results from this API request may also generate false-positives. We recommend adding exceptions related to the `user.name` or `aws.cloudtrail.user_identity.arn` values to ignore these.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Disable or limit the account during the investigation and response.\n- Identify the possible impact of the incident and prioritize accordingly; the following actions can help you gain context:\n    - Identify the account role in the cloud environment.\n    - Assess the criticality of affected services and servers.\n    - Work with your IT team to identify and minimize the impact on users.\n    - Identify if the attacker is moving laterally and compromising other accounts, servers, or services.\n    - Identify any regulatory or legal ramifications related to this activity.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Rotate secrets or delete API keys as needed to revoke the attacker's access to the environment. Work with your IT teams to minimize the impact on business operations during these actions.\n- Check if unauthorized new users were created, remove unauthorized new accounts, and request password resets for other IAM users.\n- Consider enabling multi-factor authentication for users.\n- Review the permissions assigned to the implicated user to ensure that the least privilege principle is being followed.\n- Implement security best practices [outlined](https://aws.amazon.com/premiumsupport/knowledge-center/security-best-practices/) by AWS.\n- Take the actions needed to return affected systems, data, or services to their normal operational levels.\n- Identify the initial vector abused by the attacker and take action to prevent reinfection via the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "investigation_fields": {
          "field_names": [
            "@timestamp",
            "user.name",
            "source.address",
            "aws.cloudtrail.user_identity.type",
            "aws.cloudtrail.user_identity.arn",
            "user_agent.original",
            "event.action",
            "event.outcome",
            "cloud.region",
            "aws.cloudtrail.request_parameters"
          ]
        },
        "version": 3,
        "tags": [
          "Domain: Cloud",
          "Data Source: AWS",
          "Data Source: Amazon Web Services",
          "Data Source: AWS STS",
          "Use Case: Identity and Access Audit",
          "Tactic: Discovery",
          "Resources: Investigation Guide"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-3600s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Verify whether the user identity should be using the STS `GetCallerIdentity` API operation. If known behavior is causing false positives, it can be exempted from the rule."
        ],
        "references": [
          "https://docs.aws.amazon.com/STS/latest/APIReference/API_GetCallerIdentity.html",
          "https://www.secureworks.com/research/detecting-the-use-of-stolen-aws-lambda-credentials",
          "https://detectioninthe.cloud/ttps/discovery/get_caller_identity/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1087",
                "name": "Account Discovery",
                "reference": "https://attack.mitre.org/techniques/T1087/",
                "subtechnique": [
                  {
                    "id": "T1087.004",
                    "name": "Cloud Account",
                    "reference": "https://attack.mitre.org/techniques/T1087/004/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "aws",
            "version": "^2.0.0",
            "integration": "cloudtrail"
          }
        ],
        "required_fields": [
          {
            "name": "aws.cloudtrail.user_identity.type",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "c8842900-e0ce-4f6e-b155-a501c7908abc",
        "rule_id": "30fbf4db-c502-4e68-a239-2e99af0f70da",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:08.459Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:44.341Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "event.dataset: \"aws.cloudtrail\"\n    and event.provider: \"sts.amazonaws.com\"\n    and event.action: \"GetCallerIdentity\"\n    and event.outcome: \"success\"\n    and not aws.cloudtrail.user_identity.type: \"AssumedRole\"",
        "new_terms_fields": [
          "aws.cloudtrail.user_identity.arn"
        ],
        "history_window_start": "now-10d",
        "index": [
          "filebeat-*",
          "logs-aws.cloudtrail-*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Network Connection from Binary with RWX Memory Region",
        "description": "Monitors for the execution of a unix binary with read, write and execute memory region permissions, followed by a network connection. The mprotect() system call is used to change the access protections on a region of memory that has already been allocated. This syscall allows a process to modify the permissions of pages in its virtual address space, enabling or disabling permissions such as read, write, and execute for those pages. RWX permissions on memory is in many cases overly permissive, and should (especially in conjunction with an outbound network connection) be analyzed thoroughly.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 3,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Data Source: Elastic Defend",
          "Data Source: Auditd Manager"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://man7.org/linux/man-pages/man2/mprotect.2.html",
          "https://www.elastic.co/security-labs/linux-detection-engineering-with-auditd"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.004",
                    "name": "Unix Shell",
                    "reference": "https://attack.mitre.org/techniques/T1059/004/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            },
            "technique": [
              {
                "id": "T1071",
                "name": "Application Layer Protocol",
                "reference": "https://attack.mitre.org/techniques/T1071/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires the use of the `auditd_manager` integration. `Auditd_manager` is a tool designed to simplify and enhance the management of the audit subsystem in Linux systems. It provides a user-friendly interface and automation capabilities for configuring and monitoring system auditing through the auditd daemon. With `auditd_manager`, administrators can easily define audit rules, track system events, and generate comprehensive audit reports, improving overall security and compliance in the system. The following steps should be executed in order to install and deploy `auditd_manager` on a Linux system.\n```\nKibana -->\nManagement -->\nIntegrations -->\nAuditd Manager -->\nAdd Auditd Manager\n```\n`Auditd_manager` subscribes to the kernel and receives events as they occur without any additional configuration. However, if more advanced configuration is required to detect specific behavior, audit rules can be added to the integration in either the \"audit rules\" configuration box or the \"auditd rule files\" box by specifying a file to read the audit rules from.\nFor this detection rule to trigger, the following additional audit rules are required to be added to the integration:\n```\n-a always,exit -F arch=b64 -S mprotect\n```\nAdd the newly installed `auditd manager` to an agent policy, and deploy the agent on a Linux system from which auditd log files are desirable.\n",
        "related_integrations": [
          {
            "package": "auditd_manager",
            "version": "^1.0.0"
          },
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "auditd.data.a2",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "auditd.data.syscall",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "destination.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pid",
            "type": "long",
            "ecs": true
          }
        ],
        "id": "4ac22e91-e140-4001-bf54-365e6e5ce68f",
        "rule_id": "32300431-c2d5-432d-8ec8-0e03f9924756",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:08.462Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:44.370Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sample by host.id, process.pid, process.name\n  /* auditd.data.a2 == \"7\" translates to RWX memory region protection (PROT_READ | PROT_WRITE | PROT_EXEC) */\n  [process where host.os.type == \"linux\" and auditd.data.syscall == \"mprotect\" and auditd.data.a2 == \"7\" and\n   not process.name == \"httpd\"]\n  [network where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"connection_attempted\" and\n   not cidrmatch(destination.ip, \"127.0.0.0/8\", \"169.254.0.0/16\", \"224.0.0.0/4\", \"::1\")]",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "auditbeat-*",
          "logs-auditd_manager.auditd-*"
        ],
        "filters": []
      },
      {
        "name": "Attempted Bypass of Okta MFA",
        "description": "Detects attempts to bypass Okta multi-factor authentication (MFA). An adversary may attempt to bypass the Okta MFA policies configured for an organization in order to obtain unauthorized access to an application.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Attempted Bypass of Okta MFA\n\nMulti-factor authentication (MFA) is a crucial security measure in preventing unauthorized access. Okta MFA, like other MFA solutions, requires the user to provide multiple means of identification at login. An adversary might attempt to bypass Okta MFA to gain unauthorized access to an application.\n\nThis rule detects attempts to bypass Okta MFA. It might indicate a serious attempt to compromise a user account within the organization's network.\n\n#### Possible investigation steps\n\n- Identify the actor related to the alert by reviewing `okta.actor.id`, `okta.actor.type`, `okta.actor.alternate_id`, or `okta.actor.display_name` fields in the alert.\n- Review the `okta.client.user_agent.raw_user_agent` field to understand the device and software used by the actor.\n- Examine the `okta.outcome.reason` field for additional context around the bypass attempt.\n- Check the `okta.outcome.result` field to confirm the MFA bypass attempt.\n- Check if there are multiple unsuccessful MFA attempts from the same actor or IP address (`okta.client.ip`).\n- Check for successful logins immediately following the MFA bypass attempt.\n- Verify whether the actor's activity aligns with typical behavior or if any unusual activity took place around the time of the bypass attempt.\n\n### False positive analysis\n\n- Check if there were issues with the MFA system at the time of the bypass attempt. This could indicate a system error rather than a genuine bypass attempt.\n- Check the geographical location (`okta.request.ip_chain.geographical_context`) and time of the login attempt. If these match the actor's normal behavior, it might be a false positive.\n- Verify the actor's MFA settings to ensure they are correctly configured.\n\n### Response and remediation\n\n- If unauthorized access is confirmed, initiate the incident response process.\n- Immediately lock the affected actor account and require a password change.\n- Consider resetting MFA tokens for the actor and require re-enrollment.\n- Check if the compromised account was used to access or alter any sensitive data or systems.\n- If a specific MFA bypass technique was used, ensure your systems are patched or configured to prevent such techniques.\n- Assess the criticality of affected services and servers.\n- Work with your IT team to minimize the impact on users and maintain business continuity.\n- If multiple accounts are affected, consider a broader reset or audit of MFA tokens.\n- Implement security best practices [outlined](https://www.okta.com/blog/2019/10/9-admin-best-practices-to-keep-your-org-secure/) by Okta.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).",
        "output_index": "",
        "version": 411,
        "tags": [
          "Data Source: Okta",
          "Use Case: Identity and Access Audit",
          "Tactic: Credential Access"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/okta-and-lapsus-what-you-need-to-know",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1111",
                "name": "Multi-Factor Authentication Interception",
                "reference": "https://attack.mitre.org/techniques/T1111/"
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "7d4c09c3-3588-4cc9-9b18-19493773722e",
        "rule_id": "3805c3dc-f82c-4f8d-891e-63c24d3102b0",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:08.466Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:46.250Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset:okta.system and event.action:user.mfa.attempt_bypass",
        "language": "kuery"
      },
      {
        "name": "Systemd Generator Created",
        "description": "This rule detects the creation of a systemd generator file. Generators are small executables executed by systemd at bootup and during configuration reloads. Their main role is to convert non-native configuration and execution parameters into dynamically generated unit files, symlinks, or drop-ins, extending the unit file hierarchy for the service manager. Systemd generators can be used to execute arbitrary code at boot time, which can be leveraged by attackers to maintain persistence on a Linux system.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 3,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Tactic: Privilege Escalation",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://pberba.github.io/security/2022/02/07/linux-threat-hunting-for-persistence-systemd-generators/",
          "https://www.elastic.co/security-labs/primer-on-persistence-mechanisms"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1543",
                "name": "Create or Modify System Process",
                "reference": "https://attack.mitre.org/techniques/T1543/",
                "subtechnique": [
                  {
                    "id": "T1543.002",
                    "name": "Systemd Service",
                    "reference": "https://attack.mitre.org/techniques/T1543/002/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1543",
                "name": "Create or Modify System Process",
                "reference": "https://attack.mitre.org/techniques/T1543/",
                "subtechnique": [
                  {
                    "id": "T1543.002",
                    "name": "Systemd Service",
                    "reference": "https://attack.mitre.org/techniques/T1543/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.Ext.original.extension",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "f5d4c4bb-f2e8-48f9-a6f4-6ba177fec8c4",
        "rule_id": "39c06367-b700-4380-848a-cab06e7afede",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:08.469Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:46.299Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"linux\" and event.action in (\"rename\", \"creation\") and file.path : (\n\"/run/systemd/system-generators/*\", \"/etc/systemd/system-generators/*\",\n\"/usr/local/lib/systemd/system-generators/*\", \"/lib/systemd/system-generators/*\",\n\"/usr/lib/systemd/system-generators/*\", \"/etc/systemd/user-generators/*\",\n\"/usr/local/lib/systemd/user-generators/*\", \"/usr/lib/systemd/user-generators/*\",\n\"/lib/systemd/user-generators/*\"\n) and not (\n  process.executable in (\n    \"/bin/dpkg\", \"/usr/bin/dpkg\", \"/bin/dockerd\", \"/usr/bin/dockerd\", \"/usr/sbin/dockerd\", \"/bin/microdnf\",\n    \"/usr/bin/microdnf\", \"/bin/rpm\", \"/usr/bin/rpm\", \"/bin/snapd\", \"/usr/bin/snapd\", \"/bin/yum\", \"/usr/bin/yum\",\n    \"/bin/dnf\", \"/usr/bin/dnf\", \"/bin/podman\", \"/usr/bin/podman\", \"/bin/dnf-automatic\", \"/usr/bin/dnf-automatic\",\n    \"/bin/pacman\", \"/usr/bin/pacman\", \"/usr/bin/dpkg-divert\", \"/bin/dpkg-divert\", \"/sbin/apk\", \"/usr/sbin/apk\",\n    \"/usr/local/sbin/apk\", \"/usr/bin/apt\", \"/usr/sbin/pacman\", \"/bin/podman\", \"/usr/bin/podman\", \"/usr/bin/puppet\",\n    \"/bin/puppet\", \"/opt/puppetlabs/puppet/bin/puppet\", \"/usr/bin/chef-client\", \"/bin/chef-client\", \"/usr/sbin/sshd\",\n    \"/bin/autossl_check\", \"/usr/bin/autossl_check\", \"/proc/self/exe\", \"/dev/fd/*\",  \"/usr/bin/pamac-daemon\",\n    \"/bin/pamac-daemon\", \"/usr/lib/snapd/snapd\", \"/usr/local/bin/dockerd\", \"/usr/libexec/platform-python\"\n  ) or\n  file.extension in (\"swp\", \"swpx\", \"swx\", \"dpkg-remove\") or\n  file.Ext.original.extension == \"dpkg-new\" or\n  process.executable == null\n)",
        "language": "eql",
        "index": [
          "logs-endpoint.events.file*"
        ],
        "filters": []
      },
      {
        "name": "Okta Brute Force or Password Spraying Attack",
        "description": "Identifies a high number of failed Okta user authentication attempts from a single IP address, which could be indicative of a brute force or password spraying attack. An adversary may attempt a brute force or password spraying attack to obtain unauthorized access to user accounts.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Okta Brute Force or Password Spraying Attack\n\nThis rule alerts when a high number of failed Okta user authentication attempts occur from a single IP address. This could be indicative of a brute force or password spraying attack, where an adversary may attempt to gain unauthorized access to user accounts by guessing the passwords.\n\n#### Possible investigation steps:\n\n- Review the `source.ip` field to identify the IP address from which the high volume of failed login attempts originated.\n- Look into the `event.outcome` field to verify that these are indeed failed authentication attempts.\n- Determine the `user.name` or `user.email` related to these failed login attempts. If the attempts are spread across multiple accounts, it might indicate a password spraying attack.\n- Check the timeline of the events. Are the failed attempts spread out evenly, or are there burst periods, which might indicate an automated tool?\n- Determine the geographical location of the source IP. Is this location consistent with the user's typical login location?\n- Analyze any previous successful logins from this IP. Was this IP previously associated with successful logins?\n\n### False positive analysis:\n\n- A single user or automated process that attempts to authenticate using expired or wrong credentials multiple times may trigger a false positive.\n- Analyze the behavior of the source IP. If the IP is associated with legitimate users or services, it may be a false positive.\n\n### Response and remediation:\n\n- If you identify unauthorized access attempts, consider blocking the source IP at the firewall level.\n- Notify the users who are targeted by the attack. Ask them to change their passwords and ensure they use unique, complex passwords.\n- Enhance monitoring on the affected user accounts for any suspicious activity.\n- If the attack is persistent, consider implementing CAPTCHA or account lockouts after a certain number of failed login attempts.\n- If the attack is persistent, consider implementing multi-factor authentication (MFA) for the affected user accounts.\n- Review and update your security policies based on the findings from the incident.",
        "output_index": "",
        "version": 412,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Tactic: Credential Access",
          "Data Source: Okta"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Automated processes that attempt to authenticate using expired credentials and unbounded retries may lead to false positives."
        ],
        "references": [
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1110",
                "name": "Brute Force",
                "reference": "https://attack.mitre.org/techniques/T1110/"
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "3b7f7434-7439-4c38-b2a6-411a470d8dbe",
        "rule_id": "42bf698b-4738-445b-8231-c834ddefd8a0",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:08.472Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:46.457Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "threshold",
        "query": "event.dataset:okta.system and event.category:authentication and event.outcome:failure",
        "threshold": {
          "field": [
            "source.ip"
          ],
          "value": 25
        },
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Linux User Added to Privileged Group",
        "description": "Identifies attempts to add a user to a privileged group. Attackers may add users to a privileged group in order to establish persistence on a system.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Linux User User Added to Privileged Group\n\nThe `usermod`, `adduser`, and `gpasswd` commands can be used to assign user accounts to new groups in Linux-based operating systems.\n\nAttackers may add users to a privileged group in order to escalate privileges or establish persistence on a system or domain.\n\nThis rule identifies the usages of `usermod`, `adduser` and `gpasswd` to assign user accounts to a privileged group.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n> This investigation guide uses [placeholder fields](https://www.elastic.co/guide/en/security/current/osquery-placeholder-fields.html) to dynamically pass alert data into Osquery queries. Placeholder fields were introduced in Elastic Stack version 8.7.0. If you're using Elastic Stack version 8.6.0 or earlier, you'll need to manually adjust this investigation guide's queries to ensure they properly run.\n\n#### Possible investigation steps\n\n- Investigate whether the user was succesfully added to the privileged group.\n  - !{osquery{\"label\":\"Osquery - Retrieve Information for a Specific User\",\"query\":\"SELECT * FROM users WHERE username = {{user.name}}\"}}\n- Investigate whether the user is currently logged in and active.\n  - !{osquery{\"label\":\"Osquery - Investigate the Account Authentication Status\",\"query\":\"SELECT * FROM logged_in_users WHERE user = {{user.name}}\"}}\n- Retrieve information about the privileged group to which the user was added.\n  - !{osquery{\"label\":\"Osquery - Retrieve Information for a Specific Group\",\"query\":\"SELECT * FROM groups WHERE groupname = {{group.name}}\"}}\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence and whether they are located in expected locations.\n  - !{osquery{\"label\":\"Osquery - Retrieve Running Processes by User\",\"query\":\"SELECT pid, username, name FROM processes p JOIN users u ON u.uid = p.uid ORDER BY username\"}}\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n\n### False positive analysis\n\n- Adding accounts to a group is a common administrative task, so there is a high chance of the activity being legitimate. Before investigating further, verify that this activity is not benign.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Review the privileges assigned to the involved users to ensure that the least privilege principle is being followed.\n- Delete the account that seems to be involved in malicious activity.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 8,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Data Source: Elastic Endgame",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend",
          "Data Source: Auditd Manager"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/security-labs/primer-on-persistence-mechanisms"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1136",
                "name": "Create Account",
                "reference": "https://attack.mitre.org/techniques/T1136/",
                "subtechnique": [
                  {
                    "id": "T1136.001",
                    "name": "Local Account",
                    "reference": "https://attack.mitre.org/techniques/T1136/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "auditd_manager",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "aa2d06da-b067-4bc9-81e3-9d62e23d3c90",
        "rule_id": "43d6ec12-2b1c-47b5-8f35-e9de65551d3b",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:08.475Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:46.476Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\", \"executed\", \"process_started\")\n and process.args in (\n  \"root\", \"admin\", \"wheel\", \"staff\", \"sudo\",\"disk\", \"video\", \"shadow\", \"lxc\", \"lxd\"\n) and\n(\n  process.name in (\"usermod\", \"adduser\") or\n  (process.name == \"gpasswd\" and process.args in (\"-a\", \"--add\", \"-M\", \"--members\")) \n)",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*",
          "auditbeat-*",
          "logs-auditd_manager.auditd-*"
        ],
        "filters": []
      },
      {
        "name": "System V Init Script Created",
        "description": "Files that are placed in the /etc/init.d/ directory in Unix can be used to start custom applications, services, scripts or commands during start-up. Init.d has been mostly replaced in favor of Systemd. However, the \"systemd-sysv-generator\" can convert init.d files to service unit files that run at boot. Adversaries may add or alter files located in the /etc/init.d/ directory to execute malicious code upon boot in order to gain persistence on the system.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating System V Init Script Created\n\nThe `/etc/init.d` directory is used in Linux systems to store the initialization scripts for various services and daemons that are executed during system startup and shutdown.\n\nAttackers can abuse files within the `/etc/init.d/` directory to run scripts, commands or malicious software every time a system is rebooted by converting an executable file into a service file through the `systemd-sysv-generator`. After conversion, a unit file is created within the `/run/systemd/generator.late/` directory.\n\nThis rule looks for the creation of new files within the `/etc/init.d/` directory. Executable files in these directories will automatically run at boot with root privileges.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n> This investigation guide uses [placeholder fields](https://www.elastic.co/guide/en/security/current/osquery-placeholder-fields.html) to dynamically pass alert data into Osquery queries. Placeholder fields were introduced in Elastic Stack version 8.7.0. If you're using Elastic Stack version 8.6.0 or earlier, you'll need to manually adjust this investigation guide's queries to ensure they properly run.\n#### Possible Investigation Steps\n\n- Investigate the file that was created or modified.\n  - !{osquery{\"label\":\"Osquery - Retrieve File Information\",\"query\":\"SELECT * FROM file WHERE path = {{file.path}}\"}}\n- Investigate whether any other files in the `/etc/init.d/` or `/run/systemd/generator.late/` directories have been altered.\n  - !{osquery{\"label\":\"Osquery - Retrieve File Listing Information\",\"query\":\"SELECT * FROM file WHERE path LIKE '/etc/init.d/%'\"}}\n  - !{osquery{\"label\":\"Osquery - Retrieve Additional File Listing Information\",\"query\":\"SELECT f.path, u.username AS file_owner, g.groupname AS group_owner, datetime(f.atime, 'unixepoch') AS\\nfile_last_access_time, datetime(f.mtime, 'unixepoch') AS file_last_modified_time, datetime(f.ctime, 'unixepoch') AS\\nfile_last_status_change_time, datetime(f.btime, 'unixepoch') AS file_created_time, f.size AS size_bytes FROM file f LEFT\\nJOIN users u ON f.uid = u.uid LEFT JOIN groups g ON f.gid = g.gid WHERE path LIKE '/etc/init.d/%'\\n\"}}\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence and whether they are located in expected locations.\n  - !{osquery{\"label\":\"Osquery - Retrieve Running Processes by User\",\"query\":\"SELECT pid, username, name FROM processes p JOIN users u ON u.uid = p.uid ORDER BY username\"}}\n- Investigate syslog through the `sudo cat /var/log/syslog | grep 'LSB'` command to find traces of the LSB header of the script (if present). If syslog is being ingested into Elasticsearch, the same can be accomplished through Kibana.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Validate whether this activity is related to planned patches, updates, network administrator activity, or legitimate software installations.\n- Investigate whether the altered scripts call other malicious scripts elsewhere on the file system. \n  - If scripts or executables were dropped, retrieve the files and determine if they are malicious:\n    - Use a private sandboxed malware analysis system to perform analysis.\n      - Observe and collect information about the following activities:\n        - Attempts to contact external domains and addresses.\n          - Check if the domain is newly registered or unexpected.\n          - Check the reputation of the domain or IP address.\n        - File access, modification, and creation activities.\n        - Cron jobs, services and other persistence mechanisms.\n            - !{osquery{\"label\":\"Osquery - Retrieve Crontab Information\",\"query\":\"SELECT * FROM crontab\"}}\n\n### False Positive Analysis\n\n- If this activity is related to new benign software installation activity, consider adding exceptions â€” preferably with a combination of user and command line conditions.\n- If this activity is related to a system administrator who uses init.d for administrative purposes, consider adding exceptions for this specific administrator user account. \n- Try to understand the context of the execution by thinking about the user, machine, or business purpose. A small number of endpoints, such as servers with unique software, might appear unusual but satisfy a specific business need.\n\n### Related Rules\n\n- Suspicious File Creation in /etc for Persistence - 1c84dd64-7e6c-4bad-ac73-a5014ee37042\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Delete the maliciously created service/init.d files or restore it to the original configuration.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Leverage the incident response data and logging to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 13,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Data Source: Elastic Endgame",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.intezer.com/blog/malware-analysis/hiddenwasp-malware-targeting-linux-systems/",
          "https://pberba.github.io/security/2022/02/06/linux-threat-hunting-for-persistence-initialization-scripts-and-shell-configuration/#8-boot-or-logon-initialization-scripts-rc-scripts",
          "https://www.cyberciti.biz/faq/how-to-enable-rc-local-shell-script-on-systemd-while-booting-linux-system/",
          "https://www.elastic.co/security-labs/sequel-on-persistence-mechanisms"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1037",
                "name": "Boot or Logon Initialization Scripts",
                "reference": "https://attack.mitre.org/techniques/T1037/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "d6f76b6e-f08e-4c51-806d-6540f5df552b",
        "rule_id": "474fd20e-14cc-49c5-8160-d9ab4ba16c8b",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:08.477Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:48.308Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"linux\" and event.action in (\"creation\", \"file_create_event\", \"rename\", \"file_rename_event\")\nand file.path : \"/etc/init.d/*\" and not (\n  process.executable in (\n    \"/bin/dpkg\", \"/usr/bin/dpkg\", \"/bin/dockerd\", \"/usr/bin/dockerd\", \"/usr/sbin/dockerd\", \"/bin/microdnf\",\n    \"/usr/bin/microdnf\", \"/bin/rpm\", \"/usr/bin/rpm\", \"/bin/snapd\", \"/usr/bin/snapd\", \"/bin/yum\", \"/usr/bin/yum\",\n    \"/bin/dnf\", \"/usr/bin/dnf\", \"/bin/podman\", \"/usr/bin/podman\", \"/bin/dnf-automatic\", \"/usr/bin/dnf-automatic\",\n    \"/bin/pacman\", \"/usr/bin/pacman\", \"/usr/bin/dpkg-divert\", \"/bin/dpkg-divert\", \"/sbin/apk\", \"/usr/sbin/apk\",\n    \"/usr/local/sbin/apk\", \"/usr/bin/apt\", \"/usr/sbin/pacman\", \"/bin/podman\", \"/usr/bin/podman\", \"/usr/bin/puppet\",\n    \"/bin/puppet\", \"/opt/puppetlabs/puppet/bin/puppet\", \"/usr/bin/chef-client\", \"/bin/chef-client\",\n    \"/bin/autossl_check\", \"/usr/bin/autossl_check\", \"/proc/self/exe\", \"/dev/fd/*\",  \"/usr/bin/pamac-daemon\",\n    \"/bin/pamac-daemon\", \"/usr/lib/snapd/snapd\", \"/usr/local/bin/dockerd\"\n  ) or\n  file.extension in (\"swp\", \"swpx\", \"swx\", \"dpkg-remove\") or\n  file.path like (\"/etc/init.d/*beat*\", \"/etc/init.d/elastic-agent*\") or\n  process.executable like (\"/nix/store/*\", \"/var/lib/dpkg/*\", \"/snap/*\", \"/dev/fd/*\", \"/usr/lib/virtualbox/*\") or\n  process.name in (\"docker-init\", \"jumpcloud-agent\", \"crio\") or\n  process.executable == null or\n  (process.name == \"ln\" and file.path : \"/etc/init.d/rc*.d/*\") or\n  (process.name == \"sed\" and file.name : \"sed*\") or\n  (process.name == \"perl\" and file.name : \"e2scrub_all.tmp*\") \n)",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "Cupsd or Foomatic-rip Shell Execution",
        "description": "This detection rule addresses multiple vulnerabilities in the CUPS printing system, including CVE-2024-47176, CVE-2024-47076, CVE-2024-47175, and CVE-2024-47177. Specifically, this rule detects shell executions from the foomatic-rip parent process. These flaws impact components like cups-browsed, libcupsfilters, libppd, and foomatic-rip, allowing remote unauthenticated attackers to manipulate IPP URLs or inject malicious data through crafted UDP packets or network spoofing. This can result in arbitrary command execution when a print job is initiated.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Cupsd or Foomatic-rip Shell Execution\n\nThis rule identifies potential exploitation attempts of several vulnerabilities in the CUPS printing system (CVE-2024-47176, CVE-2024-47076, CVE-2024-47175, CVE-2024-47177). These vulnerabilities allow attackers to send crafted IPP requests or manipulate UDP packets to execute arbitrary commands or modify printer configurations. Attackers can exploit these flaws to inject malicious data, leading to Remote Code Execution (RCE) on affected systems.\n\n#### Possible Investigation Steps\n\n- Investigate the incoming IPP requests or UDP packets targeting port 631.\n- Examine the printer configurations on the system to determine if any unauthorized printers or URLs have been added.\n- Investigate the process tree to check if any unexpected processes were triggered as a result of IPP activity. Review the executable files for legitimacy.\n- Check for additional alerts related to the compromised system or user within the last 48 hours.\n- Investigate network traffic logs for suspicious outbound connections to unrecognized domains or IP addresses.\n- Check if any of the contacted domains or addresses are newly registered or have a suspicious reputation.\n- Retrieve any scripts or executables dropped by the attack for further analysis in a private sandbox environment:\n- Analyze potential malicious activity, including:\n  - Attempts to communicate with external servers.\n  - File access or creation of unauthorized executables.\n  - Cron jobs, services, or other persistence mechanisms.\n\n### Related Rules\n- Printer User (lp) Shell Execution - f86cd31c-5c7e-4481-99d7-6875a3e31309\n- Network Connection by Cups or Foomatic-rip Child - e80ee207-9505-49ab-8ca8-bc57d80e2cab\n- File Creation by Cups or Foomatic-rip Child - b9b14be7-b7f4-4367-9934-81f07d2f63c4\n- Suspicious Execution from Foomatic-rip or Cupsd Parent - 986361cd-3dac-47fe-afa1-5c5dd89f2fb4\n\n### False Positive Analysis\n\n- This activity is rarely legitimate. However, verify the context to rule out non-malicious printer configuration changes or legitimate IPP requests.\n\n### Response and Remediation\n\n- Initiate the incident response process based on the triage outcome.\n- Isolate the compromised host to prevent further exploitation.\n- If the investigation confirms malicious activity, search the environment for additional compromised hosts.\n- Implement network segmentation or restrictions to contain the attack.\n- Stop suspicious processes or services tied to CUPS exploitation.\n- Block identified Indicators of Compromise (IoCs), including IP addresses, domains, or hashes of involved files.\n- Review compromised systems for backdoors, such as reverse shells or persistence mechanisms like cron jobs.\n- Investigate potential credential exposure on compromised systems and reset passwords for any affected accounts.\n- Restore the original printer configurations or uninstall unauthorized printer entries.\n- Perform a thorough antimalware scan to identify any lingering threats or artifacts from the attack.\n- Investigate how the attacker gained initial access and address any weaknesses to prevent future exploitation.\n- Use insights from the incident to improve detection and response times in future incidents (MTTD and MTTR).\n",
        "output_index": "",
        "version": 2,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Use Case: Vulnerability",
          "Tactic: Execution",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/security-labs/cups-overflow",
          "https://www.evilsocket.net/2024/09/26/Attacking-UNIX-systems-via-CUPS-Part-I/",
          "https://gist.github.com/stong/c8847ef27910ae344a7b5408d9840ee1",
          "https://github.com/RickdeJager/cupshax/blob/main/cupshax.py"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1203",
                "name": "Exploitation for Client Execution",
                "reference": "https://attack.mitre.org/techniques/T1203/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "eb2ce51d-d82a-4258-b180-c2195cdf7f38",
        "rule_id": "476267ff-e44f-476e-99c1-04c78cb3769d",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:08.480Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:48.318Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\nprocess.parent.name == \"foomatic-rip\" and\nprocess.name in (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\") and not (\n  process.command_line like (\n    \"*/tmp/foomatic-*\", \"*-sDEVICE=ps2write*\", \"*printf*\", \"/bin/sh -e -c cat\", \"/bin/bash -c cat\",\n    \"/bin/bash -e -c cat\"\n  ) or\n  process.args like \"gs*\"\n)",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Attempt to Delete an Okta Policy",
        "description": "Detects attempts to delete an Okta policy. An adversary may attempt to delete an Okta policy in order to weaken an organization's security controls. For example, an adversary may attempt to delete an Okta multi-factor authentication (MFA) policy in order to weaken the authentication requirements for user accounts.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Attempt to Delete an Okta Policy\n\nOkta policies are critical to managing user access and enforcing security controls within an organization. The deletion of an Okta policy could drastically weaken an organization's security posture by allowing unrestricted access or facilitating other malicious activities.\n\nThis rule detects attempts to delete an Okta policy, which could be indicative of an adversary's attempt to weaken an organization's security controls. Adversaries may do this to bypass security barriers and enable further malicious activities.\n\n#### Possible investigation steps:\n\n- Identify the actor related to the alert by reviewing `okta.actor.id`, `okta.actor.type`, `okta.actor.alternate_id`, or `okta.actor.display_name` fields in the alert.\n- Review the `okta.client.user_agent.raw_user_agent` field to understand the device and software used by the actor.\n- Examine the `okta.outcome.reason` field for additional context around the deletion attempt.\n- Check the `okta.outcome.result` field to confirm the policy deletion attempt.\n- Check if there are multiple policy deletion attempts from the same actor or IP address (`okta.client.ip`).\n- Check for successful logins immediately following the policy deletion attempt.\n- Verify whether the actor's activity aligns with typical behavior or if any unusual activity took place around the time of the deletion attempt.\n\n### False positive analysis:\n\n- Check if there were issues with the Okta system at the time of the deletion attempt. This could indicate a system error rather than a genuine threat activity.\n- Check the geographical location (`okta.request.ip_chain.geographical_context`) and time of the deletion attempt. If these match the actor's normal behavior, it might be a false positive.\n- Verify the actor's administrative rights to ensure they are correctly configured.\n\n### Response and remediation:\n\n- If unauthorized policy deletion is confirmed, initiate the incident response process.\n- Immediately lock the affected actor account and require a password change.\n- Consider resetting MFA tokens for the actor and require re-enrollment.\n- Check if the compromised account was used to access or alter any sensitive data or systems.\n- If a specific deletion technique was used, ensure your systems are patched or configured to prevent such techniques.\n- Assess the criticality of affected services and servers.\n- Work with your IT team to minimize the impact on users and maintain business continuity.\n- If multiple accounts are affected, consider a broader reset or audit of MFA tokens.\n- Implement security best practices [outlined](https://www.okta.com/blog/2019/10/9-admin-best-practices-to-keep-your-org-secure/) by Okta.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).",
        "output_index": "",
        "version": 410,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Data Source: Okta",
          "Tactic: Defense Evasion"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Consider adding exceptions to this rule to filter false positives if Okta policies are regularly deleted in your organization."
        ],
        "references": [
          "https://help.okta.com/en/prod/Content/Topics/Security/Security_Policies.htm",
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.007",
                    "name": "Disable or Modify Cloud Firewall",
                    "reference": "https://attack.mitre.org/techniques/T1562/007/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "255bf700-858b-4c20-b921-db8bd42c6ddf",
        "rule_id": "b4bb1440-0fcb-4ed1-87e5-b06d58efc5e9",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:08.483Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:17:00.968Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset:okta.system and event.action:policy.lifecycle.delete",
        "language": "kuery"
      },
      {
        "name": "Attempt to Deactivate an Okta Policy",
        "description": "Detects attempts to deactivate an Okta policy. An adversary may attempt to deactivate an Okta policy in order to weaken an organization's security controls. For example, an adversary may attempt to deactivate an Okta multi-factor authentication (MFA) policy in order to weaken the authentication requirements for user accounts.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Attempt to Deactivate an Okta Policy\n\nOkta policies define rules to manage user access to resources. Policies such as multi-factor authentication (MFA) are critical for enforcing strong security measures. Deactivation of an Okta policy could potentially weaken the security posture, allowing for unauthorized access or facilitating other malicious activities.\n\nThis rule is designed to detect attempts to deactivate an Okta policy, which could be indicative of an adversary's attempt to weaken an organization's security controls. For example, disabling an MFA policy could lower the security of user authentication processes.\n\n#### Possible investigation steps:\n\n- Identify the actor related to the alert by reviewing `okta.actor.id`, `okta.actor.type`, `okta.actor.alternate_id`, or `okta.actor.display_name` fields in the alert.\n- Review the `okta.client.user_agent.raw_user_agent` field to understand the device and software used by the actor.\n- Examine the `okta.outcome.reason` field for additional context around the deactivation attempt.\n- Check the `okta.outcome.result` field to confirm the policy deactivation attempt.\n- Check if there are multiple policy deactivation attempts from the same actor or IP address (`okta.client.ip`).\n- Check for successful logins immediately following the policy deactivation attempt.\n- Verify whether the actor's activity aligns with typical behavior or if any unusual activity took place around the time of the deactivation attempt.\n\n### False positive analysis:\n\n- Check if there were issues with the Okta system at the time of the deactivation attempt. This could indicate a system error rather than a genuine threat activity.\n- Check the geographical location (`okta.request.ip_chain.geographical_context`) and time of the deactivation attempt. If these match the actor's normal behavior, it might be a false positive.\n- Verify the actor's administrative rights to ensure they are correctly configured.\n\n### Response and remediation:\n\n- If unauthorized policy deactivation is confirmed, initiate the incident response process.\n- Immediately lock the affected actor account and require a password change.\n- Consider resetting MFA tokens for the actor and require re-enrollment.\n- Check if the compromised account was used to access or alter any sensitive data or systems.\n- If a specific deactivation technique was used, ensure your systems are patched or configured to prevent such techniques.\n- Assess the criticality of affected services and servers.\n- Work with your IT team to minimize the impact on users and maintain business continuity.\n- If multiple accounts are affected, consider a broader reset or audit of MFA tokens.\n- Implement security best practices [outlined](https://www.okta.com/blog/2019/10/9-admin-best-practices-to-keep-your-org-secure/) by Okta.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).",
        "output_index": "",
        "version": 410,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Data Source: Okta",
          "Tactic: Defense Evasion"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "If the behavior of deactivating Okta policies is expected, consider adding exceptions to this rule to filter false positives."
        ],
        "references": [
          "https://help.okta.com/en/prod/Content/Topics/Security/Security_Policies.htm",
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.007",
                    "name": "Disable or Modify Cloud Firewall",
                    "reference": "https://attack.mitre.org/techniques/T1562/007/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "65abd123-b9c6-4617-8765-693317b82a76",
        "rule_id": "b719a170-3bdb-4141-b0e3-13e3cf627bfe",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:08.485Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:17:03.056Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset:okta.system and event.action:policy.lifecycle.deactivate",
        "language": "kuery"
      },
      {
        "name": "Administrator Privileges Assigned to an Okta Group",
        "description": "Detects when an administrator role is assigned to an Okta group. An adversary may attempt to assign administrator privileges to an Okta group in order to assign additional permissions to compromised user accounts and maintain access to their target organization.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 409,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Data Source: Okta",
          "Tactic: Persistence"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Administrator roles may be assigned to Okta users by a Super Admin user. Verify that the behavior was expected. Exceptions can be added to this rule to filter expected behavior."
        ],
        "references": [
          "https://help.okta.com/en/prod/Content/Topics/Security/administrators-admin-comparison.htm",
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1098",
                "name": "Account Manipulation",
                "reference": "https://attack.mitre.org/techniques/T1098/"
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "f872a1c3-6102-422a-8172-823613f27bf5",
        "rule_id": "b8075894-0b62-46e5-977c-31275da34419",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:08.488Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:17:02.788Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset:okta.system and event.action:group.privilege.grant",
        "language": "kuery"
      },
      {
        "name": "Attempt to Delete an Okta Network Zone",
        "description": "Detects attempts to delete an Okta network zone. Okta network zones can be configured to limit or restrict access to a network based on IP addresses or geolocations. An adversary may attempt to modify, delete, or deactivate an Okta network zone in order to remove or weaken an organization's security controls.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Attempt to Delete an Okta Network Zone\n\nOkta network zones can be configured to limit or restrict access to a network based on IP addresses or geolocations. Deleting a network zone in Okta might remove or weaken the security controls of an organization, which might be an indicator of an adversary's attempt to evade defenses.\n\n#### Possible investigation steps:\n\n- Identify the actor associated with the alert by examining the `okta.actor.id`, `okta.actor.type`, `okta.actor.alternate_id`, or `okta.actor.display_name` fields.\n- Examine the `event.action` field to confirm the deletion of a network zone.\n- Investigate the `okta.target.id`, `okta.target.type`, `okta.target.alternate_id`, or `okta.target.display_name` fields to identify the network zone that was deleted.\n- Review the `event.time` field to understand when the event happened.\n- Check the actor's activities before and after the event to understand the context of this event.\n\n### False positive analysis:\n\n- Verify the `okta.client.user_agent.raw_user_agent` field to understand the device and software used by the actor. If these match the actor's typical behavior, it might be a false positive.\n- Check if the actor is a known administrator or a member of the IT team who might have a legitimate reason to delete a network zone.\n- Cross-verify the actor's actions with any known planned changes or maintenance activities.\n\n### Response and remediation:\n\n- If unauthorized access or actions are confirmed, immediately lock the affected actor's account and require a password change.\n- If a network zone was deleted without authorization, create a new network zone with similar settings as the deleted one.\n- Review and update the privileges of the actor who initiated the deletion.\n- Identify any gaps in the security policies and procedures and update them as necessary.\n- Implement additional monitoring and logging of Okta events to improve visibility of user actions.\n- Communicate and train the employees about the importance of following proper procedures for modifying network zone settings.",
        "output_index": "",
        "version": 410,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Data Source: Okta",
          "Use Case: Network Security Monitoring",
          "Tactic: Defense Evasion"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Consider adding exceptions to this rule to filter false positives if Oyour organization's Okta network zones are regularly deleted."
        ],
        "references": [
          "https://help.okta.com/en/prod/Content/Topics/Security/network/network-zones.htm",
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.007",
                    "name": "Disable or Modify Cloud Firewall",
                    "reference": "https://attack.mitre.org/techniques/T1562/007/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "bd2029c1-d880-4862-9308-854a56bc2b91",
        "rule_id": "c749e367-a069-4a73-b1f2-43a3798153ad",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:08.491Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:17:03.364Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset:okta.system and event.action:zone.delete",
        "language": "kuery"
      },
      {
        "name": "Attempt to Modify an Okta Application",
        "description": "Detects attempts to modify an Okta application. An adversary may attempt to modify, deactivate, or delete an Okta application in order to weaken an organization's security controls or disrupt their business operations.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 409,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Data Source: Okta",
          "Tactic: Impact"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Consider adding exceptions to this rule to filter false positives if your organization's Okta applications are regularly modified and the behavior is expected."
        ],
        "references": [
          "https://help.okta.com/en/prod/Content/Topics/Apps/Apps_Apps.htm",
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0040",
              "name": "Impact",
              "reference": "https://attack.mitre.org/tactics/TA0040/"
            }
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "16133ac3-cd10-4987-9513-c45876e1e65d",
        "rule_id": "c74fd275-ab2c-4d49-8890-e2943fa65c09",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:08.493Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:17:05.131Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset:okta.system and event.action:application.lifecycle.update",
        "language": "kuery"
      },
      {
        "name": "Potential Execution via XZBackdoor",
        "description": "It identifies potential malicious shell executions through remote SSH and detects cases where the sshd service suddenly terminates soon after successful execution, suggesting suspicious behavior similar to the XZ backdoor.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 4,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Tactic: Persistence",
          "Tactic: Lateral Movement",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/amlweems/xzbot",
          "https://access.redhat.com/security/cve/CVE-2024-3094",
          "https://www.elastic.co/security-labs/500ms-to-midnight"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1543",
                "name": "Create or Modify System Process",
                "reference": "https://attack.mitre.org/techniques/T1543/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1556",
                "name": "Modify Authentication Process",
                "reference": "https://attack.mitre.org/techniques/T1556/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1021",
                "name": "Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1021/",
                "subtechnique": [
                  {
                    "id": "T1021.004",
                    "name": "SSH",
                    "reference": "https://attack.mitre.org/techniques/T1021/004/"
                  }
                ]
              },
              {
                "id": "T1563",
                "name": "Remote Service Session Hijacking",
                "reference": "https://attack.mitre.org/techniques/T1563/",
                "subtechnique": [
                  {
                    "id": "T1563.001",
                    "name": "SSH Hijacking",
                    "reference": "https://attack.mitre.org/techniques/T1563/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.exit_code",
            "type": "long",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.pid",
            "type": "long",
            "ecs": true
          },
          {
            "name": "process.pid",
            "type": "long",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "2b79277b-3a46-481e-b8c2-995548c73359",
        "rule_id": "7afc6cc9-8800-4c7f-be6b-b688d2dea248",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:08.496Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:54.545Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by host.id, user.id with maxspan=1s\n [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and process.name == \"sshd\" and\n    process.args == \"-D\" and process.args == \"-R\"] by process.pid, process.entity_id\n [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and process.parent.name == \"sshd\" and \n  process.executable != null and not (\n    process.executable in (\"/usr/sbin/sshd\", \"/usr/sbin/unix_chkpwd\", \"/usr/bin/google_authorized_keys\", \"/usr/bin/fipscheck\") or\n    process.args like (\"rsync*\", \"systemctl*\", \"/usr/sbin/unix_chkpwd\", \"/usr/bin/google_authorized_keys\", \"/usr/sbin/aad_certhandler*\") or\n    process.command_line like \"sh -c /usr/bin/env -i PATH=*\"\n  )] by process.parent.pid, process.parent.entity_id\n [process where host.os.type == \"linux\" and event.action == \"end\" and process.name == \"sshd\" and process.exit_code != 0] by process.pid, process.entity_id\n [network where host.os.type == \"linux\" and event.type == \"end\" and event.action == \"disconnect_received\" and process.name == \"sshd\"] by process.pid, process.entity_id",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "APT Package Manager Configuration File Creation",
        "description": "Detects file creation events in the configuration directory for the APT package manager. In Linux, APT (Advanced Package Tool) is a command-line utility used for handling packages on (by default) Debian-based systems, providing functions for installing, updating, upgrading, and removing software along with managing package repositories. Attackers can backdoor APT to gain persistence by injecting malicious code into scripts that APT runs, thereby ensuring continued unauthorized access or control each time APT is used for package management.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 4,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://packetstormsecurity.com/files/152668/APT-Package-Manager-Persistence.html",
          "https://www.elastic.co/security-labs/sequel-on-persistence-mechanisms"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1543",
                "name": "Create or Modify System Process",
                "reference": "https://attack.mitre.org/techniques/T1543/"
              },
              {
                "id": "T1546",
                "name": "Event Triggered Execution",
                "reference": "https://attack.mitre.org/techniques/T1546/",
                "subtechnique": [
                  {
                    "id": "T1546.016",
                    "name": "Installer Packages",
                    "reference": "https://attack.mitre.org/techniques/T1546/016/"
                  }
                ]
              },
              {
                "id": "T1574",
                "name": "Hijack Execution Flow",
                "reference": "https://attack.mitre.org/techniques/T1574/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            }
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.Ext.original.extension",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "5c8b39b4-101e-42eb-af50-652569bcbbab",
        "rule_id": "7c2e1297-7664-42bc-af11-6d5d35220b6b",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:08.499Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:54.574Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"linux\" and event.action in (\"rename\", \"creation\") and\nfile.path : \"/etc/apt/apt.conf.d/*\" and not (\n  process.executable in (\n    \"/bin/dpkg\", \"/usr/bin/dpkg\", \"/bin/dockerd\", \"/usr/bin/dockerd\", \"/usr/sbin/dockerd\", \"/bin/microdnf\",\n    \"/usr/bin/microdnf\", \"/bin/rpm\", \"/usr/bin/rpm\", \"/bin/snapd\", \"/usr/bin/snapd\", \"/bin/yum\", \"/usr/bin/yum\",\n    \"/bin/dnf\", \"/usr/bin/dnf\", \"/bin/podman\", \"/usr/bin/podman\", \"/bin/dnf-automatic\", \"/usr/bin/dnf-automatic\",\n    \"/bin/pacman\", \"/usr/bin/pacman\", \"/usr/bin/dpkg-divert\", \"/bin/dpkg-divert\", \"/sbin/apk\", \"/usr/sbin/apk\",\n    \"/usr/local/sbin/apk\", \"/usr/bin/apt\", \"/usr/sbin/pacman\", \"/bin/podman\", \"/usr/bin/podman\", \"/usr/bin/puppet\",\n    \"/bin/puppet\", \"/opt/puppetlabs/puppet/bin/puppet\", \"/usr/bin/chef-client\", \"/bin/chef-client\",\n    \"/bin/autossl_check\", \"/usr/bin/autossl_check\", \"/proc/self/exe\", \"/dev/fd/*\",  \"/usr/bin/pamac-daemon\",\n    \"/bin/pamac-daemon\", \"/usr/lib/snapd/snapd\", \"/usr/local/bin/dockerd\", \"/usr/libexec/netplan/generate\",\n    \"/usr/local/bin/apt-get\", \"/usr/bin/apt-get\"\n  ) or\n  file.path :(\"/etc/apt/apt.conf.d/*.tmp*\") or\n  file.extension in (\"swp\", \"swpx\", \"swx\", \"dpkg-remove\") or\n  file.Ext.original.extension == \"dpkg-new\" or\n  process.executable : (\n    \"/nix/store/*\", \"/var/lib/dpkg/*\", \"/tmp/vmis.*\", \"/snap/*\", \"/dev/fd/*\", \"/usr/lib/*\", \"/usr/libexec/*\",\n    \"/etc/kernel/*\"\n  ) or\n  process.executable == null or\n  process.name in (\"pveupdate\", \"perl\") or\n  (process.name == \"sed\" and file.name : \"sed*\") or\n  (process.name == \"perl\" and file.name : \"e2scrub_all.tmp*\") \n)",
        "language": "eql",
        "index": [
          "logs-endpoint.events.file*"
        ],
        "filters": []
      },
      {
        "name": "Systemd Timer Created",
        "description": "Detects the creation of a systemd timer within any of the default systemd timer directories. Systemd timers can be used by an attacker to gain persistence, by scheduling the execution of a command or script. Similarly to cron/at, systemd timers can be set up to execute on boot time, or on a specific point in time, which allows attackers to regain access in case the connection to the infected asset was lost.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Systemd Timer Created\n\nSystemd timers are used for scheduling and automating recurring tasks or services on Linux systems. \n\nAttackers can leverage systemd timers to run scripts, commands, or malicious software at system boot or on a set time interval by creating a systemd timer and a corresponding systemd service file. \n\nThis rule monitors the creation of new systemd timer files, potentially indicating the creation of a persistence mechanism.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n> This investigation guide uses [placeholder fields](https://www.elastic.co/guide/en/security/current/osquery-placeholder-fields.html) to dynamically pass alert data into Osquery queries. Placeholder fields were introduced in Elastic Stack version 8.7.0. If you're using Elastic Stack version 8.6.0 or earlier, you'll need to manually adjust this investigation guide's queries to ensure they properly run.\n\n#### Possible Investigation Steps\n\n- Investigate the timer file that was created or modified.\n  - !{osquery{\"label\":\"Osquery - Retrieve File Information\",\"query\":\"SELECT * FROM file WHERE path = {{file.path}}\"}}\n- Investigate the currently enabled systemd timers through the following command `sudo systemctl list-timers`.\n- Search for the systemd service file named similarly to the timer that was created.\n- Investigate whether any other files in any of the available systemd directories have been altered through OSQuery.\n  - !{osquery{\"label\":\"Osquery - Retrieve File Listing Information\",\"query\":\"SELECT * FROM file WHERE (path LIKE '/etc/systemd/system/%' OR path LIKE '/usr/local/lib/systemd/system/%' OR path LIKE\\n'/lib/systemd/system/%' OR path LIKE '/usr/lib/systemd/system/%' OR path LIKE\\n'/home/{{user.name}}/.config/systemd/user/%' OR path LIKE '/home/{{user.name}}/.local/share/systemd/user/%' OR path LIKE\\n'/root/.config/systemd/user/%' OR path LIKE '/root/.local/share/systemd/user/%' OR path LIKE '/etc/systemd/user/%' OR\\npath LIKE '/usr/lib/systemd/user/%')\\n\"}}\n  - !{osquery{\"label\":\"Osquery - Retrieve Additional File Listing Information\",\"query\":\"SELECT f.path, u.username AS file_owner, g.groupname AS group_owner, datetime(f.atime, 'unixepoch') AS\\nfile_last_access_time, datetime(f.mtime, 'unixepoch') AS file_last_modified_time, datetime(f.ctime, 'unixepoch') AS\\nfile_last_status_change_time, datetime(f.btime, 'unixepoch') AS file_created_time, f.size AS size_bytes FROM file f LEFT\\nJOIN users u ON f.uid = u.uid LEFT JOIN groups g ON f.gid = g.gid WHERE ( path LIKE '/etc/systemd/system/%' OR path LIKE\\n'/usr/local/lib/systemd/system/%' OR path LIKE '/lib/systemd/system/%' OR path LIKE '/usr/lib/systemd/system/%' OR path\\nLIKE '/home/{{user.name}}/.config/systemd/user/%' OR path LIKE '/home/{{user.name}}/.local/share/systemd/user/%' OR path\\nLIKE '/root/.config/systemd/user/%' OR path LIKE '/root/.local/share/systemd/user/%' OR path LIKE '/etc/systemd/user/%'\\nOR path LIKE '/usr/lib/systemd/user/%')\\n\"}}\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence and whether they are located in expected locations.\n  - !{osquery{\"label\":\"Osquery - Retrieve Running Processes by User\",\"query\":\"SELECT pid, username, name FROM processes p JOIN users u ON u.uid = p.uid ORDER BY username\"}}\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Validate the activity is not related to planned patches, updates, network administrator activity, or legitimate software installations.\n- Investigate whether the altered scripts call other malicious scripts elsewhere on the file system. \n  - If scripts or executables were dropped, retrieve the files and determine if they are malicious:\n    - Use a private sandboxed malware analysis system to perform analysis.\n      - Observe and collect information about the following activities:\n        - Attempts to contact external domains and addresses.\n          - Check if the domain is newly registered or unexpected.\n          - Check the reputation of the domain or IP address.\n        - File access, modification, and creation activities.\n        - Cron jobs, services and other persistence mechanisms.\n            - !{osquery{\"label\":\"Osquery - Retrieve Crontab Information\",\"query\":\"SELECT * FROM crontab\"}}\n\n### False Positive Analysis\n\n- If this activity is related to new benign software installation activity, consider adding exceptions â€” preferably with a combination of user and command line conditions.\n- If this activity is related to a system administrator who uses systemd timers for administrative purposes, consider adding exceptions for this specific administrator user account. \n- Try to understand the context of the execution by thinking about the user, machine, or business purpose. A small number of endpoints, such as servers with unique software, might appear unusual but satisfy a specific business need.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Delete the service/timer or restore its original configuration.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Leverage the incident response data and logging to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 15,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://opensource.com/article/20/7/systemd-timers",
          "https://pberba.github.io/security/2022/01/30/linux-threat-hunting-for-persistence-systemd-timers-cron/",
          "https://www.elastic.co/security-labs/primer-on-persistence-mechanisms"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1053",
                "name": "Scheduled Task/Job",
                "reference": "https://attack.mitre.org/techniques/T1053/",
                "subtechnique": [
                  {
                    "id": "T1053.006",
                    "name": "Systemd Timers",
                    "reference": "https://attack.mitre.org/techniques/T1053/006/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.Ext.original.extension",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "a5060fa6-eea4-49ca-9e44-5ee1cd603916",
        "rule_id": "7fb500fa-8e24-4bd1-9480-2a819352602c",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:08.512Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:54.614Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"linux\" and event.action in (\"rename\", \"creation\") and file.path : (\n  \"/etc/systemd/system/*\", \"/etc/systemd/user/*\", \"/usr/local/lib/systemd/system/*\",\n  \"/lib/systemd/system/*\", \"/usr/lib/systemd/system/*\", \"/usr/lib/systemd/user/*\",\n  \"/home/*/.config/systemd/user/*\", \"/home/*/.local/share/systemd/user/*\",\n  \"/root/.config/systemd/user/*\", \"/root/.local/share/systemd/user/*\"\n) and file.extension == \"timer\" and not (\n  process.executable in (\n    \"/bin/dpkg\", \"/usr/bin/dpkg\", \"/bin/dockerd\", \"/usr/bin/dockerd\", \"/usr/sbin/dockerd\", \"/bin/microdnf\",\n    \"/usr/bin/microdnf\", \"/bin/rpm\", \"/usr/bin/rpm\", \"/bin/snapd\", \"/usr/bin/snapd\", \"/bin/yum\", \"/usr/bin/yum\",\n    \"/bin/dnf\", \"/usr/bin/dnf\", \"/bin/podman\", \"/usr/bin/podman\", \"/bin/dnf-automatic\", \"/usr/bin/dnf-automatic\",\n    \"/bin/pacman\", \"/usr/bin/pacman\", \"/usr/bin/dpkg-divert\", \"/bin/dpkg-divert\", \"/sbin/apk\", \"/usr/sbin/apk\",\n    \"/usr/local/sbin/apk\", \"/usr/bin/apt\", \"/usr/sbin/pacman\", \"/bin/podman\", \"/usr/bin/podman\", \"/usr/bin/puppet\",\n    \"/bin/puppet\", \"/opt/puppetlabs/puppet/bin/puppet\", \"/usr/bin/chef-client\", \"/bin/chef-client\",\n    \"/bin/autossl_check\", \"/usr/bin/autossl_check\", \"/proc/self/exe\", \"/dev/fd/*\",  \"/usr/bin/pamac-daemon\",\n    \"/bin/pamac-daemon\", \"/usr/lib/snapd/snapd\", \"/usr/local/bin/dockerd\", \"/usr/bin/crio\", \"/usr/sbin/crond\",\n    \"/opt/puppetlabs/puppet/bin/ruby\", \"/usr/libexec/platform-python\", \"/kaniko/kaniko-executor\",\n    \"/usr/local/bin/dockerd\", \"/usr/bin/podman\", \"/bin/install\", \"/proc/self/exe\"\n  ) or\n  process.name like (\n    \"python*\", \"crio\", \"apt-get\", \"install\", \"snapd\", \"cloudflared\", \"sshd\", \"convert-usrmerge\", \"docker-init\",\n    \"google_metadata_script_runner\"\n  ) or\n  file.extension in (\"swp\", \"swpx\", \"swx\", \"dpkg-remove\") or\n  file.Ext.original.extension == \"dpkg-new\" or\n  process.executable : (\n    \"/nix/store/*\", \"/var/lib/dpkg/*\", \"/tmp/vmis.*\", \"/snap/*\", \"/dev/fd/*\", \"/usr/lib/virtualbox/*\"\n  ) or\n  process.executable == null or\n  (process.name == \"sed\" and file.name : \"sed*\") or\n  (process.name == \"perl\" and file.name : \"e2scrub_all.tmp*\") \n)",
        "language": "eql",
        "index": [
          "logs-endpoint.events.file*"
        ],
        "filters": []
      },
      {
        "name": "Potential Okta MFA Bombing via Push Notifications",
        "description": "Detects when an attacker abuses the Multi-Factor authentication mechanism by repeatedly issuing login requests until the user eventually accepts the Okta push notification. An adversary may attempt to bypass the Okta MFA policies configured for an organization to obtain unauthorized access.",
        "risk_score": 73,
        "severity": "high",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Potential Okta MFA Bombing via Push Notifications\n\nMulti-Factor Authentication (MFA) is an effective method to prevent unauthorized access. However, some adversaries may abuse the system by repeatedly sending MFA push notifications until the user unwittingly approves the access.\n\nThis rule detects when a user denies MFA Okta Verify push notifications twice, followed by a successful authentication event within a 10-minute window. This sequence could indicate an adversary's attempt to bypass the Okta MFA policy.\n\n#### Possible investigation steps:\n\n- Identify the user who received the MFA notifications by reviewing the `user.email` field.\n- Identify the time, source IP, and geographical location of the MFA requests and the subsequent successful login.\n- Review the `event.action` field to understand the nature of the events. It should include two `user.mfa.okta_verify.deny_push` actions and one `user.authentication.sso` action.\n- Ask the user if they remember receiving the MFA notifications and subsequently logging into their account.\n- Check if the MFA requests and the successful login occurred during the user's regular activity hours.\n- Look for any other suspicious activity on the account around the same time.\n- Identify whether the same pattern is repeated for other users in your organization. Multiple users receiving push notifications simultaneously might indicate a larger attack.\n\n### False positive analysis:\n\n- Determine if the MFA push notifications were legitimate. Sometimes, users accidentally trigger MFA requests or deny them unintentionally and later approve them.\n- Check if there are known issues with the MFA system causing false denials.\n\n### Response and remediation:\n\n- If unauthorized access is confirmed, initiate your incident response process.\n- Alert the user and your IT department immediately.\n- If possible, isolate the user's account until the issue is resolved.\n- Investigate the source of the unauthorized access.\n- If the account was accessed by an unauthorized party, determine the actions they took after logging in.\n- Consider enhancing your MFA policy to prevent such incidents in the future.\n- Encourage users to report any unexpected MFA notifications immediately.\n- Review and update your incident response plans and security policies based on the findings from the incident.\n",
        "output_index": "",
        "version": 207,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Tactic: Credential Access",
          "Data Source: Okta"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.mandiant.com/resources/russian-targeting-gov-business",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://sec.okta.com/articles/2023/08/cross-tenant-impersonation-prevention-and-detection",
          "https://www.rezonate.io/blog/okta-logs-decoded-unveiling-identity-threats-through-threat-hunting/",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1621",
                "name": "Multi-Factor Authentication Request Generation",
                "reference": "https://attack.mitre.org/techniques/T1621/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.\n",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "okta.actor.id",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "okta.event_type",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "okta.outcome.result",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "bf3961b5-7fa4-4de4-b134-4eea86184c51",
        "rule_id": "8a0fbd26-867f-11ee-947c-f661ea17fbcd",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:08.515Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:56.585Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by okta.actor.id with maxspan=10m\n  [authentication where event.dataset == \"okta.system\"\n    and okta.event_type == \"user.mfa.okta_verify.deny_push\"] with runs=5\n  until [authentication where event.dataset == \"okta.system\"\n    and (okta.event_type: (\n      \"user.authentication.sso\",\n      \"user.authentication.auth_via_mfa\",\n      \"user.authentication.verify\",\n      \"user.session.start\") and okta.outcome.result == \"SUCCESS\")]",
        "language": "eql",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "event_category_override": "event.category"
      },
      {
        "name": "Attempt to Deactivate an Okta Network Zone",
        "description": "Detects attempts to deactivate an Okta network zone. Okta network zones can be configured to limit or restrict access to a network based on IP addresses or geolocations. An adversary may attempt to modify, delete, or deactivate an Okta network zone in order to remove or weaken an organization's security controls.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Attempt to Deactivate an Okta Network Zone\n\nThe Okta network zones can be configured to restrict or limit access to a network based on IP addresses or geolocations. Deactivating a network zone in Okta may remove or weaken the security controls of an organization, which might be an indicator of an adversary's attempt to evade defenses.\n\n#### Possible investigation steps\n\n- Identify the actor related to the alert by reviewing the `okta.actor.id`, `okta.actor.type`, `okta.actor.alternate_id`, or `okta.actor.display_name` fields.\n- Examine the `event.action` field to confirm the deactivation of a network zone.\n- Check the `okta.target.id`, `okta.target.type`, `okta.target.alternate_id`, or `okta.target.display_name` to identify the network zone that was deactivated.\n- Investigate the `event.time` field to understand when the event happened.\n- Review the actor's activities before and after the event to understand the context of this event.\n\n### False positive analysis\n\n- Check the `okta.client.user_agent.raw_user_agent` field to understand the device and software used by the actor. If these match the actor's normal behavior, it might be a false positive.\n- Check if the actor is a known administrator or part of the IT team who might have a legitimate reason to deactivate a network zone.\n- Verify the actor's actions with any known planned changes or maintenance activities.\n\n### Response and remediation\n\n- If unauthorized access or actions are confirmed, immediately lock the affected actor account and require a password change.\n- Re-enable the deactivated network zone if it was deactivated without authorization.\n- Review and update the privileges of the actor who initiated the deactivation.\n- Check the security policies and procedures to identify any gaps and update them as necessary.\n- Implement additional monitoring and logging of Okta events to improve visibility of user actions.\n- Communicate and train the employees about the importance of following proper procedures for modifying network zone settings.",
        "output_index": "",
        "version": 410,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Data Source: Okta",
          "Use Case: Network Security Monitoring",
          "Tactic: Defense Evasion"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Consider adding exceptions to this rule to filter false positives if your organization's Okta network zones are regularly modified."
        ],
        "references": [
          "https://help.okta.com/en/prod/Content/Topics/Security/network/network-zones.htm",
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.007",
                    "name": "Disable or Modify Cloud Firewall",
                    "reference": "https://attack.mitre.org/techniques/T1562/007/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "1c28872c-3e6c-4d04-8b9e-7b9983d7d5cc",
        "rule_id": "8a5c1e5f-ad63-481e-b53a-ef959230f7f1",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:08.518Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:56.600Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset:okta.system and event.action:zone.deactivate",
        "language": "kuery"
      },
      {
        "name": "Attempt to Create Okta API Token",
        "description": "Detects attempts to create an Okta API token. An adversary may create an Okta API token to maintain access to an organization's network while they work to achieve their objectives. An attacker may abuse an API token to execute techniques such as creating user accounts or disabling security rules or policies.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 409,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Data Source: Okta",
          "Tactic: Persistence"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "If the behavior of creating Okta API tokens is expected, consider adding exceptions to this rule to filter false positives."
        ],
        "references": [
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1136",
                "name": "Create Account",
                "reference": "https://attack.mitre.org/techniques/T1136/"
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "d6b792dc-347e-45e9-b9bc-faead67a5f58",
        "rule_id": "96b9f4ea-0e8c-435b-8d53-2096e75fcac5",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:08.520Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:58.607Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset:okta.system and event.action:system.api_token.create",
        "language": "kuery"
      },
      {
        "name": "Potentially Successful MFA Bombing via Push Notifications",
        "description": "Detects when an attacker abuses the Multi-Factor authentication mechanism by repeatedly issuing login requests until the user eventually accepts the Okta push notification. An adversary may attempt to bypass the Okta MFA policies configured for an organization to obtain unauthorized access.",
        "risk_score": 73,
        "severity": "high",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Potential Abuse of Repeated MFA Push Notifications\n\nMulti-Factor Authentication (MFA) is an effective method to prevent unauthorized access. However, some adversaries may abuse the system by repeatedly sending MFA push notifications until the user unwittingly approves the access.\n\nThis rule detects when a user denies MFA Okta Verify push notifications twice, followed by a successful authentication event within a 10-minute window. This sequence could indicate an adversary's attempt to bypass the Okta MFA policy.\n\n#### Possible investigation steps:\n\n- Identify the user who received the MFA notifications by reviewing the `user.email` field.\n- Identify the time, source IP, and geographical location of the MFA requests and the subsequent successful login.\n- Review the `event.action` field to understand the nature of the events. It should include two `user.mfa.okta_verify.deny_push` actions and one `user.authentication.sso` action.\n- Ask the user if they remember receiving the MFA notifications and subsequently logging into their account.\n- Check if the MFA requests and the successful login occurred during the user's regular activity hours.\n- Look for any other suspicious activity on the account around the same time.\n- Identify whether the same pattern is repeated for other users in your organization. Multiple users receiving push notifications simultaneously might indicate a larger attack.\n\n### False positive analysis:\n\n- Determine if the MFA push notifications were legitimate. Sometimes, users accidentally trigger MFA requests or deny them unintentionally and later approve them.\n- Check if there are known issues with the MFA system causing false denials.\n\n### Response and remediation:\n\n- If unauthorized access is confirmed, initiate your incident response process.\n- Alert the user and your IT department immediately.\n- If possible, isolate the user's account until the issue is resolved.\n- Investigate the source of the unauthorized access.\n- If the account was accessed by an unauthorized party, determine the actions they took after logging in.\n- Consider enhancing your MFA policy to prevent such incidents in the future.\n- Encourage users to report any unexpected MFA notifications immediately.\n- Review and update your incident response plans and security policies based on the findings from the incident.",
        "output_index": "",
        "version": 413,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Tactic: Credential Access",
          "Data Source: Okta"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.mandiant.com/resources/russian-targeting-gov-business",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://sec.okta.com/articles/2023/08/cross-tenant-impersonation-prevention-and-detection",
          "https://www.rezonate.io/blog/okta-logs-decoded-unveiling-identity-threats-through-threat-hunting/",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1621",
                "name": "Multi-Factor Authentication Request Generation",
                "reference": "https://attack.mitre.org/techniques/T1621/"
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.module",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "okta.actor.id",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "okta.outcome.result",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "1b7f5f17-7172-4635-a486-cddb0ca0009c",
        "rule_id": "97a8e584-fd3b-421f-9b9d-9c9d9e57e9d7",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:08.523Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:58.657Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by okta.actor.id with maxspan=10m\n  [authentication where event.dataset == \"okta.system\" and event.module == \"okta\"\n    and event.action == \"user.mfa.okta_verify.deny_push\"] with runs=3\n  [authentication where event.dataset == \"okta.system\" and event.module == \"okta\"\n    and (event.action : (\n      \"user.authentication.sso\",\n      \"user.authentication.auth_via_mfa\",\n      \"user.authentication.verify\",\n      \"user.session.start\") and okta.outcome.result == \"SUCCESS\")]",
        "language": "eql",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "event_category_override": "event.category"
      },
      {
        "name": "Suspicious Execution from Foomatic-rip or Cupsd Parent",
        "description": "This detection rule addresses multiple vulnerabilities in the CUPS printing system, including CVE-2024-47176, CVE-2024-47076, CVE-2024-47175, and CVE-2024-47177. Specifically, this rule detects suspicious process command lines executed by child processes of foomatic-rip and cupsd. These flaws impact components like cups-browsed, libcupsfilters, libppd, and foomatic-rip, allowing remote unauthenticated attackers to manipulate IPP URLs or inject malicious data through crafted UDP packets or network spoofing. This can result in arbitrary command execution when a print job is initiated.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Suspicious Execution from Foomatic-rip or Cupsd Parent\n\nThis rule identifies potential exploitation attempts of several vulnerabilities in the CUPS printing system (CVE-2024-47176, CVE-2024-47076, CVE-2024-47175, CVE-2024-47177). These vulnerabilities allow attackers to send crafted IPP requests or manipulate UDP packets to execute arbitrary commands or modify printer configurations. Attackers can exploit these flaws to inject malicious data, leading to Remote Code Execution (RCE) on affected systems.\n\n#### Possible Investigation Steps\n\n- Investigate the incoming IPP requests or UDP packets targeting port 631.\n- Examine the printer configurations on the system to determine if any unauthorized printers or URLs have been added.\n- Investigate the process tree to check if any unexpected processes were triggered as a result of IPP activity. Review the executable files for legitimacy.\n- Check for additional alerts related to the compromised system or user within the last 48 hours.\n- Investigate network traffic logs for suspicious outbound connections to unrecognized domains or IP addresses.\n- Check if any of the contacted domains or addresses are newly registered or have a suspicious reputation.\n- Retrieve any scripts or executables dropped by the attack for further analysis in a private sandbox environment:\n- Analyze potential malicious activity, including:\n  - Attempts to communicate with external servers.\n  - File access or creation of unauthorized executables.\n  - Cron jobs, services, or other persistence mechanisms.\n\n### Related Rules\n- Cupsd or Foomatic-rip Shell Execution - 476267ff-e44f-476e-99c1-04c78cb3769d\n- Printer User (lp) Shell Execution - f86cd31c-5c7e-4481-99d7-6875a3e31309\n- Network Connection by Cups or Foomatic-rip Child - e80ee207-9505-49ab-8ca8-bc57d80e2cab\n- File Creation by Cups or Foomatic-rip Child - b9b14be7-b7f4-4367-9934-81f07d2f63c4\n\n### False Positive Analysis\n\n- This activity is rarely legitimate. However, verify the context to rule out non-malicious printer configuration changes or legitimate IPP requests.\n\n### Response and Remediation\n\n- Initiate the incident response process based on the triage outcome.\n- Isolate the compromised host to prevent further exploitation.\n- If the investigation confirms malicious activity, search the environment for additional compromised hosts.\n- Implement network segmentation or restrictions to contain the attack.\n- Stop suspicious processes or services tied to CUPS exploitation.\n- Block identified Indicators of Compromise (IoCs), including IP addresses, domains, or hashes of involved files.\n- Review compromised systems for backdoors, such as reverse shells or persistence mechanisms like cron jobs.\n- Investigate potential credential exposure on compromised systems and reset passwords for any affected accounts.\n- Restore the original printer configurations or uninstall unauthorized printer entries.\n- Perform a thorough antimalware scan to identify any lingering threats or artifacts from the attack.\n- Investigate how the attacker gained initial access and address any weaknesses to prevent future exploitation.\n- Use insights from the incident to improve detection and response times in future incidents (MTTD and MTTR).\n",
        "output_index": "",
        "version": 2,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Use Case: Vulnerability",
          "Tactic: Execution",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/security-labs/cups-overflow",
          "https://www.evilsocket.net/2024/09/26/Attacking-UNIX-systems-via-CUPS-Part-I/",
          "https://gist.github.com/stong/c8847ef27910ae344a7b5408d9840ee1",
          "https://github.com/RickdeJager/cupshax/blob/main/cupshax.py"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1203",
                "name": "Exploitation for Client Execution",
                "reference": "https://attack.mitre.org/techniques/T1203/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "fa56304d-082a-488d-8819-ab04fb26d7d9",
        "rule_id": "986361cd-3dac-47fe-afa1-5c5dd89f2fb4",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:08.525Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:58.681Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\nprocess.parent.name in (\"foomatic-rip\", \"cupsd\") and process.command_line like (\n  // persistence\n  \"*cron*\", \"*/etc/rc.local*\", \"*/dev/tcp/*\", \"*/etc/init.d*\", \"*/etc/update-motd.d*\", \"*/etc/sudoers*\",\n  \"*/etc/profile*\", \"*autostart*\", \"*/etc/ssh*\", \"*/home/*/.ssh/*\", \"*/root/.ssh*\", \"*~/.ssh/*\", \"*udev*\",\n  \"*/etc/shadow*\", \"*/etc/passwd*\",\n\n  // Downloads\n  \"*curl*\", \"*wget*\",\n\n  // encoding and decoding\n  \"*base64 *\", \"*base32 *\", \"*xxd *\", \"*openssl*\",\n\n  // reverse connections\n  \"*GS_ARGS=*\", \"*/dev/tcp*\", \"*/dev/udp/*\", \"*import*pty*spawn*\", \"*import*subprocess*call*\", \"*TCPSocket.new*\",\n  \"*TCPSocket.open*\", \"*io.popen*\", \"*os.execute*\", \"*fsockopen*\", \"*disown*\", \"*nohup*\",\n\n  // SO loads\n  \"*openssl*-engine*.so*\", \"*cdll.LoadLibrary*.so*\", \"*ruby*-e**Fiddle.dlopen*.so*\", \"*Fiddle.dlopen*.so*\",\n  \"*cdll.LoadLibrary*.so*\",\n\n  // misc. suspicious command lines\n   \"*/etc/ld.so*\", \"*/dev/shm/*\", \"*/var/tmp*\", \"*echo*\", \"*>>*\", \"*|*\"\n) and not process.args like \"gs*\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Systemd-udevd Rule File Creation",
        "description": "Monitors for the creation of rule files that are used by systemd-udevd to manage device nodes and handle kernel device events in the Linux operating system. Systemd-udevd can be exploited for persistence by adversaries by creating malicious udev rules that trigger on specific events, executing arbitrary commands or payloads whenever a certain device is plugged in or recognized by the system.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 7,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/security-labs/sequel-on-persistence-mechanisms"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1037",
                "name": "Boot or Logon Initialization Scripts",
                "reference": "https://attack.mitre.org/techniques/T1037/"
              },
              {
                "id": "T1546",
                "name": "Event Triggered Execution",
                "reference": "https://attack.mitre.org/techniques/T1546/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows\nthe Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click Add integrations.\n- In the query bar, search for Elastic Defend and select the integration to see more details about it.\n- Click Add Elastic Defend.\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either Traditional Endpoints or Cloud Workloads.\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest to select \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in New agent policy name. If other agent policies already exist, you can click the Existing hosts tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click Save and Continue.\n- To complete the integration, select Add Elastic Agent to your hosts and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.Ext.original.extension",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "bfe76685-2284-43cb-8ad7-2a122507404c",
        "rule_id": "054db96b-fd34-43b3-9af2-587b3bd33964",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:08.528Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:38.222Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"linux\" and event.action in (\"rename\", \"creation\") and \nprocess.executable != null and file.extension == \"rules\" and\nfile.path : (\n  \"/lib/udev/*\", \"/etc/udev/rules.d/*\", \"/usr/lib/udev/rules.d/*\", \"/run/udev/rules.d/*\", \"/usr/local/lib/udev/rules.d/*\"\n) and not (\n  process.executable in (\n    \"/bin/dpkg\", \"/usr/bin/dpkg\", \"/bin/dockerd\", \"/usr/bin/dockerd\", \"/usr/sbin/dockerd\", \"/bin/microdnf\",\n    \"/usr/bin/microdnf\", \"/bin/rpm\", \"/usr/bin/rpm\", \"/bin/snapd\", \"/usr/bin/snapd\", \"/bin/yum\", \"/usr/bin/yum\",\n    \"/bin/dnf\", \"/usr/bin/dnf\", \"/bin/podman\", \"/usr/bin/podman\", \"/bin/dnf-automatic\", \"/usr/bin/dnf-automatic\",\n    \"/bin/pacman\", \"/usr/bin/pacman\", \"/usr/bin/dpkg-divert\", \"/bin/dpkg-divert\", \"/sbin/apk\", \"/usr/sbin/apk\",\n    \"/usr/local/sbin/apk\", \"/usr/bin/apt\", \"/usr/sbin/pacman\", \"/bin/podman\", \"/usr/bin/podman\", \"/usr/bin/puppet\",\n    \"/bin/puppet\", \"/opt/puppetlabs/puppet/bin/puppet\", \"/usr/bin/chef-client\", \"/bin/chef-client\",\n    \"/bin/autossl_check\", \"/usr/bin/autossl_check\", \"/proc/self/exe\", \"/dev/fd/*\",  \"/usr/bin/pamac-daemon\",\n    \"/bin/pamac-daemon\", \"/usr/lib/snapd/snapd\", \"/usr/local/bin/dockerd\", \"/usr/libexec/netplan/generate\",\n    \"/lib/systemd/system-generators/netplan\", \"/lib/systemd/systemd\", \"/usr/bin/containerd\", \"/usr/sbin/sshd\",\n    \"/kaniko/executor\"\n  ) or\n  file.Ext.original.extension == \"dpkg-new\" or\n  process.executable : (\n    \"/nix/store/*\", \"/var/lib/dpkg/*\", \"/snap/*\", \"/dev/fd/*\", \"/usr/lib/*\", \"/usr/libexec/*\"\n  ) or\n  process.name in (\"systemd\", \"netplan\", \"apt-get\", \"vmware-config-tools.pl\", \"systemd-hwdb\") or\n  (process.name == \"sed\" and file.name : \"sed*\") or\n  (process.name == \"perl\" and file.name : \"e2scrub_all.tmp*\") \n)",
        "language": "eql",
        "index": [
          "logs-endpoint.events.file*"
        ],
        "filters": []
      },
      {
        "name": "Yum Package Manager Plugin File Creation",
        "description": "Detects file creation events in the plugin directories for the Yum package manager. In Linux, Yum (Yellowdog Updater, Modified) is a command-line utility used for handling packages on (by default) Fedora-based systems, providing functions for installing, updating, upgrading, and removing software along with managing package repositories. Attackers can backdoor Yum to gain persistence by injecting malicious code into plugins that Yum runs, thereby ensuring continued unauthorized access or control each time Yum is used for package management.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 4,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/rapid7/metasploit-framework/blob/master/modules/exploits/linux/local/yum_package_manager_persistence.rb",
          "https://www.elastic.co/security-labs/sequel-on-persistence-mechanisms"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1543",
                "name": "Create or Modify System Process",
                "reference": "https://attack.mitre.org/techniques/T1543/"
              },
              {
                "id": "T1546",
                "name": "Event Triggered Execution",
                "reference": "https://attack.mitre.org/techniques/T1546/",
                "subtechnique": [
                  {
                    "id": "T1546.016",
                    "name": "Installer Packages",
                    "reference": "https://attack.mitre.org/techniques/T1546/016/"
                  }
                ]
              },
              {
                "id": "T1574",
                "name": "Hijack Execution Flow",
                "reference": "https://attack.mitre.org/techniques/T1574/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            }
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.Ext.original.name",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "578b6764-5937-403b-9828-f97d10fa7961",
        "rule_id": "0b15bcad-aff1-4250-a5be-5d1b7eb56d07",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:08.531Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:40.098Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"linux\" and event.action in (\"rename\", \"creation\") and\nfile.path : (\"/usr/lib/yum-plugins/*\", \"/etc/yum/pluginconf.d/*\") and not (\n  process.executable in (\n    \"/bin/dockerd\", \"/usr/bin/dockerd\", \"/usr/sbin/dockerd\", \"/bin/microdnf\", \"/usr/bin/microdnf\", \"/bin/rpm\",\n    \"/usr/bin/rpm\", \"/bin/snapd\", \"/usr/bin/snapd\", \"/bin/yum\", \"/usr/bin/yum\", \"/bin/dnf\", \"/usr/bin/dnf\",\n    \"/bin/podman\", \"/usr/bin/podman\", \"/bin/dnf-automatic\", \"/usr/bin/dnf-automatic\", \"/sbin/apk\", \"/usr/sbin/apk\",\n    \"/usr/local/sbin/apk\", \"/bin/podman\", \"/usr/bin/podman\", \"/usr/bin/puppet\", \"/bin/puppet\",\n    \"/opt/puppetlabs/puppet/bin/puppet\", \"/usr/bin/chef-client\", \"/bin/chef-client\", \"/bin/autossl_check\",\n    \"/usr/bin/autossl_check\", \"/proc/self/exe\", \"/dev/fd/*\", \"/usr/lib/snapd/snapd\", \"/usr/local/bin/dockerd\",\n    \"/usr/libexec/netplan/generate\"\n  ) or\n  process.name == \"yumBackend.py\" or\n  file.extension in (\"swp\", \"swpx\", \"swx\") or\n  file.Ext.original.name like \".ansible*\" or\n  file.name like \".ansible_tmp*\" or\n  process.executable : (\n    \"/nix/store/*\", \"/var/lib/dpkg/*\", \"/tmp/vmis.*\", \"/snap/*\", \"/dev/fd/*\", \"/usr/lib/*\", \"/usr/libexec/*\",\n    \"/etc/kernel/*\"\n  ) or\n  process.executable == null or\n  (process.name == \"sed\" and file.name : \"sed*\") or\n  (process.name == \"perl\" and file.name : \"e2scrub_all.tmp*\") \n)",
        "language": "eql",
        "index": [
          "logs-endpoint.events.file*"
        ],
        "filters": []
      },
      {
        "name": "Systemd Service Created",
        "description": "This rule detects the creation or renaming of a new Systemd file in all of the common Systemd service locations for both root and regular users. Systemd service files are configuration files in Linux systems used to define and manage system services. Malicious actors can leverage systemd service files to achieve persistence by creating or modifying services to execute malicious commands or payloads during system startup or at a predefined interval by adding a systemd timer. This allows them to maintain unauthorized access, execute additional malicious activities, or evade detection.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Systemd Service Created\n\nSystemd service files are configuration files in Linux systems used to define and manage system services.\n\nMalicious actors can leverage systemd service files to achieve persistence by creating or modifying service files to execute malicious commands or payloads during system startup. This allows them to maintain unauthorized access, execute additional malicious activities, or evade detection.\n\nThis rule monitors the creation of new systemd service files, potentially indicating the creation of a persistence mechanism.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n> This investigation guide uses [placeholder fields](https://www.elastic.co/guide/en/security/current/osquery-placeholder-fields.html) to dynamically pass alert data into Osquery queries. Placeholder fields were introduced in Elastic Stack version 8.7.0. If you're using Elastic Stack version 8.6.0 or earlier, you'll need to manually adjust this investigation guide's queries to ensure they properly run.\n\n#### Possible Investigation Steps\n\n- Investigate the systemd service file that was created or modified.\n  - !{osquery{\"label\":\"Osquery - Retrieve File Information\",\"query\":\"SELECT * FROM file WHERE path = {{file.path}}\"}}\n- Investigate the currently enabled systemd services through the following command `sudo systemctl list-unit-files`.\n- Investigate whether any other files in any of the available systemd directories have been altered through OSQuery.\n  - !{osquery{\"label\":\"Osquery - Retrieve File Listing Information\",\"query\":\"SELECT * FROM file WHERE (path LIKE '/etc/systemd/system/%' OR path LIKE '/usr/local/lib/systemd/system/%' OR path LIKE\\n'/lib/systemd/system/%' OR path LIKE '/usr/lib/systemd/system/%' OR path LIKE\\n'/home/{{user.name}}/.config/systemd/user/%' OR path LIKE '/home/{{user.name}}/.local/share/systemd/user/%' OR path LIKE\\n'/root/.config/systemd/user/%' OR path LIKE '/root/.local/share/systemd/user/%' OR path LIKE '/etc/systemd/user/%' OR\\npath LIKE '/usr/lib/systemd/user/%')\\n\"}}\n  - !{osquery{\"label\":\"Osquery - Retrieve Additional File Listing Information\",\"query\":\"SELECT f.path, u.username AS file_owner, g.groupname AS group_owner, datetime(f.atime, 'unixepoch') AS\\nfile_last_access_time, datetime(f.mtime, 'unixepoch') AS file_last_modified_time, datetime(f.ctime, 'unixepoch') AS\\nfile_last_status_change_time, datetime(f.btime, 'unixepoch') AS file_created_time, f.size AS size_bytes FROM file f LEFT\\nJOIN users u ON f.uid = u.uid LEFT JOIN groups g ON f.gid = g.gid WHERE ( path LIKE '/etc/systemd/system/%' OR path LIKE\\n'/usr/local/lib/systemd/system/%' OR path LIKE '/lib/systemd/system/%' OR path LIKE '/usr/lib/systemd/system/%' OR path\\nLIKE '/home/{{user.name}}/.config/systemd/user/%' OR path LIKE '/home/{{user.name}}/.local/share/systemd/user/%' OR path\\nLIKE '/root/.config/systemd/user/%' OR path LIKE '/root/.local/share/systemd/user/%' OR path LIKE '/etc/systemd/user/%'\\nOR path LIKE '/usr/lib/systemd/user/%')\\n\"}}\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence and whether they are located in expected locations.\n  - !{osquery{\"label\":\"Osquery - Retrieve Running Processes by User\",\"query\":\"SELECT pid, username, name FROM processes p JOIN users u ON u.uid = p.uid ORDER BY username\"}}\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Validate the activity is not related to planned patches, updates, network administrator activity, or legitimate software installations.\n- Investigate whether the altered scripts call other malicious scripts elsewhere on the file system. \n  - If scripts or executables were dropped, retrieve the files and determine if they are malicious:\n    - Use a private sandboxed malware analysis system to perform analysis.\n      - Observe and collect information about the following activities:\n        - Attempts to contact external domains and addresses.\n          - Check if the domain is newly registered or unexpected.\n          - Check the reputation of the domain or IP address.\n        - File access, modification, and creation activities.\n        - Cron jobs, services and other persistence mechanisms.\n            - !{osquery{\"label\":\"Osquery - Retrieve Crontab Information\",\"query\":\"SELECT * FROM crontab\"}}\n- Investigate abnormal behaviors by the subject process/user such as network connections, file modifications, and any other spawned child processes.\n  - Investigate listening ports and open sockets to look for potential command and control traffic or data exfiltration.\n    - !{osquery{\"label\":\"Osquery - Retrieve Listening Ports\",\"query\":\"SELECT pid, address, port, socket, protocol, path FROM listening_ports\"}}\n    - !{osquery{\"label\":\"Osquery - Retrieve Open Sockets\",\"query\":\"SELECT pid, family, remote_address, remote_port, socket, state FROM process_open_sockets\"}}\n  - Identify the user account that performed the action, analyze it, and check whether it should perform this kind of action.\n    - !{osquery{\"label\":\"Osquery - Retrieve Information for a Specific User\",\"query\":\"SELECT * FROM users WHERE username = {{user.name}}\"}}\n- Investigate whether the user is currently logged in and active.\n    - !{osquery{\"label\":\"Osquery - Investigate the Account Authentication Status\",\"query\":\"SELECT * FROM logged_in_users WHERE user = {{user.name}}\"}}\n\n### False Positive Analysis\n\n- If this activity is related to new benign software installation activity, consider adding exceptions â€” preferably with a combination of user and command line conditions.\n- If this activity is related to a system administrator who uses systemd services for administrative purposes, consider adding exceptions for this specific administrator user account. \n- Try to understand the context of the execution by thinking about the user, machine, or business purpose. A small number of endpoints, such as servers with unique software, might appear unusual but satisfy a specific business need.\n\n### Related Rules\n\n- Potential Persistence Through Run Control Detected - 0f4d35e4-925e-4959-ab24-911be207ee6f\n- Potential Persistence Through init.d Detected - 474fd20e-14cc-49c5-8160-d9ab4ba16c8b\n- Systemd Timer Created - 7fb500fa-8e24-4bd1-9480-2a819352602c\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Delete the service/timer or restore its original configuration.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Leverage the incident response data and logging to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 15,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Tactic: Privilege Escalation",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://pberba.github.io/security/2022/01/30/linux-threat-hunting-for-persistence-systemd-timers-cron/",
          "https://www.elastic.co/security-labs/primer-on-persistence-mechanisms"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1543",
                "name": "Create or Modify System Process",
                "reference": "https://attack.mitre.org/techniques/T1543/",
                "subtechnique": [
                  {
                    "id": "T1543.002",
                    "name": "Systemd Service",
                    "reference": "https://attack.mitre.org/techniques/T1543/002/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1543",
                "name": "Create or Modify System Process",
                "reference": "https://attack.mitre.org/techniques/T1543/",
                "subtechnique": [
                  {
                    "id": "T1543.002",
                    "name": "Systemd Service",
                    "reference": "https://attack.mitre.org/techniques/T1543/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.Ext.original.extension",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "af043080-9c93-42dd-b94f-3ab108b645f4",
        "rule_id": "17b0a495-4d9f-414c-8ad0-92f018b8e001",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:08.534Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:40.339Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"linux\" and event.action in (\"rename\", \"creation\") and file.path : (\n  \"/etc/systemd/system/*\", \"/etc/systemd/user/*\", \"/usr/local/lib/systemd/system/*\",\n  \"/lib/systemd/system/*\", \"/usr/lib/systemd/system/*\", \"/usr/lib/systemd/user/*\",\n  \"/home/*/.config/systemd/user/*\", \"/home/*/.local/share/systemd/user/*\",\n  \"/root/.config/systemd/user/*\", \"/root/.local/share/systemd/user/*\"\n) and file.extension == \"service\" and not (\n  process.executable in (\n    \"/bin/dpkg\", \"/usr/bin/dpkg\", \"/bin/dockerd\", \"/usr/bin/dockerd\", \"/usr/sbin/dockerd\", \"/bin/microdnf\",\n    \"/usr/bin/microdnf\", \"/bin/rpm\", \"/usr/bin/rpm\", \"/bin/snapd\", \"/usr/bin/snapd\", \"/bin/yum\", \"/usr/bin/yum\",\n    \"/bin/dnf\", \"/usr/bin/dnf\", \"/bin/podman\", \"/usr/bin/podman\", \"/bin/dnf-automatic\", \"/usr/bin/dnf-automatic\",\n    \"/bin/pacman\", \"/usr/bin/pacman\", \"/usr/bin/dpkg-divert\", \"/bin/dpkg-divert\", \"/sbin/apk\", \"/usr/sbin/apk\",\n    \"/usr/local/sbin/apk\", \"/usr/bin/apt\", \"/usr/sbin/pacman\", \"/bin/podman\", \"/usr/bin/podman\", \"/usr/bin/puppet\",\n    \"/bin/puppet\", \"/opt/puppetlabs/puppet/bin/puppet\", \"/usr/bin/chef-client\", \"/bin/chef-client\",\n    \"/bin/autossl_check\", \"/usr/bin/autossl_check\", \"/proc/self/exe\", \"/dev/fd/*\",  \"/usr/bin/pamac-daemon\",\n    \"/bin/pamac-daemon\", \"/usr/lib/snapd/snapd\", \"/usr/local/bin/dockerd\", \"/usr/bin/crio\", \"/usr/sbin/crond\",\n    \"/opt/puppetlabs/puppet/bin/ruby\", \"/usr/libexec/platform-python\", \"/kaniko/kaniko-executor\",\n    \"/usr/local/bin/dockerd\", \"/usr/bin/podman\", \"/bin/install\", \"/proc/self/exe\", \"/usr/lib/systemd/systemd\",\n    \"/usr/sbin/sshd\", \"/usr/bin/gitlab-runner\", \"/opt/gitlab/embedded/bin/ruby\", \"/usr/sbin/gdm\", \"/usr/bin/install\",\n    \"/usr/local/manageengine/uems_agent/bin/dcregister\"\n  ) or\n  file.extension in (\"swp\", \"swpx\", \"swx\", \"dpkg-remove\") or\n  file.Ext.original.extension == \"dpkg-new\" or\n  process.executable : (\n    \"/nix/store/*\", \"/var/lib/dpkg/*\", \"/tmp/vmis.*\", \"/snap/*\", \"/dev/fd/*\", \"/usr/lib/virtualbox/*\"\n  ) or\n  process.executable == null or\n  process.name like (\n    \"ssm-agent-worker\", \"python*\", \"platform-python*\", \"dnf_install\", \"cloudflared\", \"lxc-pve-prestart-hook\",\n    \"convert-usrmerge\", \"elastic-agent\", \"google_metadata_script_runner\", \"update-alternatives\", \"gitlab-runner\",\n    \"install\", \"crio\", \"apt-get\", \"package-cleanup\", \"dcservice\", \"dcregister\", \"jumpcloud-agent\", \"executor\"\n  ) or\n  (process.name == \"sed\" and file.name : \"sed*\") or\n  (process.name == \"perl\" and file.name : \"e2scrub_all.tmp*\") \n)",
        "language": "eql",
        "index": [
          "logs-endpoint.events.file*"
        ],
        "filters": []
      },
      {
        "name": "AWS SSM `SendCommand` with Run Shell Command Parameters",
        "description": "Identifies the use of the AWS Systems Manager (SSM) `SendCommand` API with the either `AWS-RunShellScript` or `AWS-RunPowerShellScript` parameters. The `SendCommand` API call allows users to execute commands on EC2 instances using the SSM service. Adversaries may use this technique to execute commands on EC2 instances without the need for SSH or RDP access. This behavior may indicate an adversary attempting to execute commands on an EC2 instance for malicious purposes. This is a [New Terms](https://www.elastic.co/guide/en/security/current/rules-ui-create.html#create-new-terms-rule) rule that only flags when this behavior is observed for the first time on a host in the last 7 days.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "investigation_fields": {
          "field_names": [
            "@timestamp",
            "process.user.name",
            "process.entry_leader.group.name",
            "process.entry_leader.real_user.name",
            "event.action",
            "event.type",
            "host.os.type",
            "host.os.kernel",
            "process.entry_leader.executable",
            "process.entry_leader.working_directory",
            "process.parent.executable",
            "process.executable",
            "process.hash.sha256",
            "process.parent.command_line",
            "process.command_line",
            "process.args"
          ]
        },
        "version": 3,
        "tags": [
          "Domain: Endpoint",
          "Domain: Cloud",
          "OS: Linux",
          "OS: macOS",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame",
          "Data Source: Auditd Manager"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Legitimate use of the `SendCommand` API call to execute commands on EC2 instances using the SSM service may be done by system administrators or DevOps engineers for legitimate purposes."
        ],
        "references": [
          "https://cloud.hacktricks.xyz/pentesting-cloud/aws-security/aws-privilege-escalation/aws-ssm-privesc",
          "https://securitycafe.ro/2023/01/17/aws-post-explitation-with-ssm-sendcommand/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1651",
                "name": "Cloud Administration Command",
                "reference": "https://attack.mitre.org/techniques/T1651/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "auditd_manager",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "8cad3da8-4b34-43f6-885c-d876f99fca80",
        "rule_id": "c371e9fc-6a10-11ef-a0ac-f661ea17fbcc",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:08.537Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:17:03.020Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "event.category: \"process\" and event.type: \"start\" and process.name: \"aws\"\nand (\n    host.os.type: (\"windows\" or \"macos\")\n    or (\n        host.os.type: \"linux\"\n        and event.action: (\"exec\" or \"exec_event\" or \"executed\" or \"process_started\")\n    )\n)\nand process.args: (\n    \"send-command\" and \"--parameters\" and commands=*\n    and (\"AWS-RunShellScript\" or \"AWS-RunPowerShellScript\")\n)",
        "new_terms_fields": [
          "host.id"
        ],
        "history_window_start": "now-7d",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*",
          "auditbeat-*",
          "logs-auditd_manager.auditd-*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Root Certificate Installation",
        "description": "This rule detects the installation of root certificates on a Linux system. Adversaries may install a root certificate on a compromised system to avoid warnings when connecting to their command and control servers. Root certificates are used in public key cryptography to identify a root certificate authority (CA). When a root certificate is installed, the system or application will trust certificates in the root's chain of trust that have been signed by the root certificate.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 2,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1553.004/T1553.004.md"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1553",
                "name": "Subvert Trust Controls",
                "reference": "https://attack.mitre.org/techniques/T1553/",
                "subtechnique": [
                  {
                    "id": "T1553.004",
                    "name": "Install Root Certificate",
                    "reference": "https://attack.mitre.org/techniques/T1553/004/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "c0c82d72-29ba-4aef-8472-a4119a2183b7",
        "rule_id": "6ded0996-7d4b-40f2-bf4a-6913e7591795",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:08.539Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:52.503Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\nprocess.name in (\"update-ca-trust\", \"update-ca-certificates\") and not (\n  process.parent.name like (\n    \"ca-certificates.postinst\", \"ca-certificates-*.trigger\", \"pacman\", \"pamac-daemon\", \"autofirma.postinst\",\n    \"ipa-client-install\", \"su\", \"platform-python\", \"python*\", \"kesl\", \"execd\"\n  ) or\n  process.parent.args like \"/var/tmp/rpm*\" or\n  (process.parent.name in (\"sh\", \"bash\", \"zsh\") and process.args == \"-e\")\n)",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process*"
        ],
        "filters": []
      },
      {
        "name": "Potential Linux Ransomware Note Creation Detected",
        "description": "This rule identifies a sequence of a mass file encryption event in conjunction with the creation of a .txt file with a file name containing ransomware keywords executed by the same process in a 1 second timespan. Ransomware is a type of malware that encrypts a victim's files or systems and demands payment (usually in cryptocurrency) in exchange for the decryption key. One important indicator of a ransomware attack is the mass encryption of the file system, after which a new file extension is added to the file.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 10,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Impact",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0040",
              "name": "Impact",
              "reference": "https://attack.mitre.org/tactics/TA0040/"
            },
            "technique": [
              {
                "id": "T1486",
                "name": "Data Encrypted for Impact",
                "reference": "https://attack.mitre.org/techniques/T1486/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "4ddbe0a4-d754-4514-8475-5d92fc21daac",
        "rule_id": "c8935a8b-634a-4449-98f7-bb24d3b2c0af",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:08.542Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:17:04.877Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by process.entity_id, host.id with maxspan=1s \n  [file where host.os.type == \"linux\" and event.type == \"change\" and event.action == \"rename\" and file.extension : \"?*\" \n   and process.executable : (\"./*\", \"/tmp/*\", \"/var/tmp/*\", \"/dev/shm/*\", \"/var/run/*\", \"/boot/*\") and\n   file.path : (\n     \"/home/*/Downloads/*\", \"/home/*/Documents/*\", \"/root/*\", \"/bin/*\", \"/usr/bin/*\", \"/var/log/*\", \"/var/lib/log/*\",\n     \"/var/backup/*\", \"/var/www/*\") and\n   not process.name : (\n     \"dpkg\", \"yum\", \"dnf\", \"rpm\", \"dockerd\", \"go\", \"java\", \"pip*\", \"python*\", \"node\", \"containerd\", \"php\", \"p4d\",\n     \"conda\", \"chrome\", \"imap\", \"cmake\", \"firefox\", \"semanage\", \"semodule\", \"ansible-galaxy\", \"fc-cache\", \"jammy\", \"git\",\n     \"systemsettings\", \"vmis-launcher\", \"bundle\", \"kudu-tserver\", \"suldownloader\", \"rustup-init\"\n    )\n  ] with runs=25\n  [file where host.os.type == \"linux\" and event.action == \"creation\" and\n   file.name : (\"*restore*\", \"*lock*\", \"*recovery*\", \"*read*\", \"*instruction*\", \"*how_to*\", \"*ransom*\")\n  ]",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Abnormal Process ID or Lock File Created",
        "description": "Identifies the creation of a Process ID (PID), lock or reboot file created in temporary file storage paradigm (tmpfs) directory /var/run. On Linux, the PID files typically hold the process ID to track previous copies running and manage other tasks. Certain Linux malware use the /var/run directory for holding data, executables and other tasks, disguising itself or these files as legitimate PID files.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Abnormal Process ID or Lock File Created\n\nLinux applications may need to save their process identification number (PID) for various purposes: from signaling that a program is running to serving as a signal that a previous instance of an application didn't exit successfully. PID files contain its creator process PID in an integer value.\n\nLinux lock files are used to coordinate operations in files so that conflicts and race conditions are prevented.\n\nThis rule identifies the creation of PID, lock, or reboot files in the /var/run/ directory. Attackers can masquerade malware, payloads, staged data for exfiltration, and more as legitimate PID files.\n\n#### Possible investigation steps\n\n- Retrieve the file and determine if it is malicious:\n    - Check the contents of the PID files. They should only contain integer strings.\n    - Check the file type of the lock and PID files to determine if they are executables. This is only observed in     malicious files.\n    - Check the size of the subject file. Legitimate PID files should be under 10 bytes.\n    - Check if the lock or PID file has high entropy. This typically indicates an encrypted payload.\n        - Analysts can use tools like `ent` to measure entropy.\n    - Examine the reputation of the SHA-256 hash in the PID file. Use a database like VirusTotal to identify additional pivots and artifacts for investigation.\n- Trace the file's creation to ensure it came from a legitimate or authorized process.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate any abnormal account behavior, such as command executions, file creations or modifications, and network connections.\n- Investigate any abnormal behavior by the subject process such as network connections, file modifications, and any spawned child processes.\n\n### False positive analysis\n\n- False positives can appear if the PID file is legitimate and holding a process ID as intended. If the PID file is an executable or has a file size that's larger than 10 bytes, it should be ruled suspicious.\n- If this activity is expected and noisy in your environment, consider adding exceptions â€” preferably with a combination of file name and process executable conditions.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Block the identified indicators of compromise (IoCs).\n- Take actions to terminate processes and connections used by the attacker.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 214,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Threat: BPFDoor",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "False-Positives (FP) can appear if the PID file is legitimate and holding a process ID as intended. To differentiate, if the PID file is an executable or larger than 10 bytes, it should be ruled suspicious."
        ],
        "references": [
          "https://www.sandflysecurity.com/blog/linux-file-masquerading-and-malicious-pids-sandfly-1-2-6-update/",
          "https://twitter.com/GossiTheDog/status/1522964028284411907",
          "https://exatrack.com/public/Tricephalic_Hellkeeper.pdf",
          "https://www.elastic.co/security-labs/a-peek-behind-the-bpfdoor"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1106",
                "name": "Native API",
                "reference": "https://attack.mitre.org/techniques/T1106/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "631d16c8-69c8-45b0-9cb3-172c838dab7f",
        "rule_id": "cac91072-d165-11ec-a764-f661ea17fbce",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:08.545Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:17:04.914Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "host.os.type:linux and event.category:file and event.action:(creation or file_create_event) and\nfile.extension:(pid or lock or reboot) and file.path:(/var/run/* or /run/*) and (\n  (process.name : (\n    bash or dash or sh or tcsh or csh or zsh or ksh or fish or ash or touch or nano or vim or vi or editor or mv or cp)\n  ) or (\n  process.executable : (\n    ./* or /tmp/* or /var/tmp/* or /dev/shm/* or /var/run/* or /boot/* or /srv/* or /run/*\n  ))\n) and not (\n  process.executable : (\n  /tmp/newroot/* or /run/containerd/* or /run/k3s/containerd/* or /run/k0s/container* or /snap/* or /vz/* or\n  /var/lib/docker/* or /etc/*/universal-hooks/pkgs/mysql-community-server/* or /var/lib/snapd/* or /etc/rubrik/* or\n  /run/udev/data/*\n  ) or\n  process.name : (\n    go or git or containerd* or snap-confine or cron or crond or sshd or unattended-upgrade or vzctl or ifup or\n    rpcbind or runc or gitlab-runner-helper or elastic-agent or metricbeat or redis-server or\n    s6-ipcserver-socketbinder or xinetd\n  ) or\n  file.name : (\n    jem.*.pid or lynis.pid or redis.pid or yum.pid or MFS.pid or jenkins.pid or nvmupdate.pid or openlitespeed.pid or\n    rhnsd.pid\n  ) or\n  file.path : (/run/containerd/* or /var/run/docker/containerd/* or /var/run/jem*.pid)\n)",
        "new_terms_fields": [
          "process.executable",
          "file.name"
        ],
        "history_window_start": "now-14d",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Kernel Module Removal",
        "description": "Kernel modules are pieces of code that can be loaded and unloaded into the kernel upon demand. They extend the functionality of the kernel without the need to reboot the system. This rule identifies attempts to remove a kernel module.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 110,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "There is usually no reason to remove modules, but some buggy modules require it. These can be exempted by username. Note that some Linux distributions are not built to support the removal of modules at all."
        ],
        "references": [
          "http://man7.org/linux/man-pages/man8/modprobe.8.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.001",
                    "name": "Disable or Modify Tools",
                    "reference": "https://attack.mitre.org/techniques/T1562/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1547",
                "name": "Boot or Logon Autostart Execution",
                "reference": "https://attack.mitre.org/techniques/T1547/",
                "subtechnique": [
                  {
                    "id": "T1547.006",
                    "name": "Kernel Modules and Extensions",
                    "reference": "https://attack.mitre.org/techniques/T1547/006/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "2c46c438-4130-41be-9ad4-7ce7b5ca9a21",
        "rule_id": "cd66a5af-e34b-4bb0-8931-57d0a043f2ef",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:08.548Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:17:04.982Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\") and (\n  process.name == \"rmmod\" or\n  (process.name == \"modprobe\" and process.args in (\"--remove\", \"-r\"))\n) and process.parent.name in (\"sudo\", \"bash\", \"dash\", \"ash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\")",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "WMI WBEMTEST Utility Execution",
        "description": "Adversaries may abuse the WMI diagnostic tool, wbemtest.exe, to enumerate WMI object instances or invoke methods against local or remote endpoints.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 104,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Data Source: Elastic Defend",
          "Rule Type: BBR",
          "Data Source: Elastic Endgame",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1047",
                "name": "Windows Management Instrumentation",
                "reference": "https://attack.mitre.org/techniques/T1047/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "4cdc9ae8-b37c-4727-b819-061c7d35b0c1",
        "rule_id": "d3551433-782f-4e22-bbea-c816af2d41c6",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:08.554Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:17:05.078Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and process.name : \"wbemtest.exe\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "winlogbeat-*",
          "logs-windows.*",
          "endgame-*",
          "logs-system.security*"
        ],
        "filters": []
      },
      {
        "name": "Unusual DPKG Execution",
        "description": "This rule detects the execution of the DPKG command by processes not associated with the DPKG package manager. The DPKG command is used to install, remove, and manage Debian packages on a Linux system. Attackers can abuse the DPKG command to install malicious packages on a system.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 2,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.makeuseof.com/how-deb-packages-are-backdoored-how-to-detect-it/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1546",
                "name": "Event Triggered Execution",
                "reference": "https://attack.mitre.org/techniques/T1546/",
                "subtechnique": [
                  {
                    "id": "T1546.016",
                    "name": "Installer Packages",
                    "reference": "https://attack.mitre.org/techniques/T1546/016/"
                  }
                ]
              },
              {
                "id": "T1543",
                "name": "Create or Modify System Process",
                "reference": "https://attack.mitre.org/techniques/T1543/"
              },
              {
                "id": "T1574",
                "name": "Hijack Execution Flow",
                "reference": "https://attack.mitre.org/techniques/T1574/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1195",
                "name": "Supply Chain Compromise",
                "reference": "https://attack.mitre.org/techniques/T1195/",
                "subtechnique": [
                  {
                    "id": "T1195.002",
                    "name": "Compromise Software Supply Chain",
                    "reference": "https://attack.mitre.org/techniques/T1195/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.group_leader.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.session_leader.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "29c50ab2-6629-46d7-b5b2-3435996945d1",
        "rule_id": "d6241c90-99f2-44db-b50f-299b6ebd7ee9",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:08.556Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:17:06.984Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\nprocess.executable : \"/var/lib/dpkg/info/*\" and process.session_leader.name != null and\nprocess.group_leader.name != null and not (\n  process.parent.name in (\"dpkg\", \"dpkg-reconfigure\") or\n  process.session_leader.name == \"dpkg\" or\n  process.group_leader.name == \"dpkg\" or\n  process.parent.executable in (\"/usr/share/debconf/frontend\", \"/usr/bin/unattended-upgrade\")\n)",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "First Occurrence GitHub Event for a Personal Access Token (PAT)",
        "description": "Detects a first occurrence event for a personal access token (PAT) not seen in the last 14 days.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 204,
        "tags": [
          "Domain: Cloud",
          "Use Case: Threat Detection",
          "Use Case: UEBA",
          "Tactic: Execution",
          "Rule Type: BBR",
          "Data Source: Github"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1648",
                "name": "Serverless Execution",
                "reference": "https://attack.mitre.org/techniques/T1648/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "github",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "github.hashed_token",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "github.programmatic_access_type",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "3d75a458-d8c7-450f-b632-a16f78360df6",
        "rule_id": "ce08b55a-f67d-4804-92b5-617b0fe5a5b5",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:08.551Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:17:05.007Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "event.dataset:\"github.audit\" and event.category:\"configuration\" and\nevent.action:* and github.hashed_token:* and \ngithub.programmatic_access_type:(\"OAuth access token\" or \"Fine-grained personal access token\")",
        "new_terms_fields": [
          "github.hashed_token",
          "event.action"
        ],
        "history_window_start": "now-14d",
        "index": [
          "logs-github.audit-*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Suspicious Memory grep Activity",
        "description": "Monitors for grep activity related to memory mapping. The /proc/*/maps file in Linux provides a memory map for a specific process, detailing the memory segments, permissions, and what files are mapped to these segments. Attackers may read a process's memory map to identify memory addresses for code injection or process hijacking.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 3,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/arget13/DDexec"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1057",
                "name": "Process Discovery",
                "reference": "https://attack.mitre.org/techniques/T1057/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "2e0dbff9-2410-4398-b77b-14f8ebe01224",
        "rule_id": "d74d6506-427a-4790-b170-0c2a6ddac799",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:08.559Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:17:07.021Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\") and\nprocess.name in (\"grep\", \"egrep\", \"fgrep\", \"rgrep\") and process.args in (\"[stack]\", \"[vdso]\", \"[heap]\")",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "AWS IAM Deactivation of MFA Device",
        "description": "Identifies the deactivation of a specified multi-factor authentication (MFA) device and removes it from association with the user name for which it was originally enabled. In AWS Identity and Access Management (IAM), a device must be deactivated before it can be deleted.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating AWS IAM Deactivation of MFA Device\n\nMulti-factor authentication (MFA) in AWS is a simple best practice that adds an extra layer of protection on top of your user name and password. With MFA enabled, when a user signs in to an AWS Management Console, they will be prompted for their user name and password (the first factorâ€”what they know), as well as for an authentication code from their AWS MFA device (the second factorâ€”what they have). Taken together, these multiple factors provide increased security for your AWS account settings and resources.\n\nFor more information about using MFA in AWS, access the [official documentation](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_mfa.html).\n\nThis rule looks for the deactivation or deletion of AWS MFA devices. These modifications weaken account security and can lead to the compromise of accounts and other assets.\n\n#### Possible investigation steps\n\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Investigate other alerts associated with the user account during the past 48 hours.\n- Contact the account and resource owners and confirm whether they are aware of this activity.\n- Check if this operation was approved and performed according to the organization's change management policy.\n- If you suspect the account has been compromised, scope potentially compromised assets by tracking servers, services, and data accessed by the account in the last 24 hours.\n\n### False positive analysis\n\n- While this activity can be done by administrators, all users must use MFA. The security team should address any potential benign true positive (B-TP), as this configuration can risk the user and domain.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Disable or limit the account during the investigation and response.\n- Identify the possible impact of the incident and prioritize accordingly; the following actions can help you gain context:\n    - Identify the account role in the cloud environment.\n    - Assess the criticality of affected services and servers.\n    - Work with your IT team to identify and minimize the impact on users.\n    - Identify if the attacker is moving laterally and compromising other accounts, servers, or services.\n    - Identify any regulatory or legal ramifications related to this activity.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords or delete API keys as needed to revoke the attacker's access to the environment. Work with your IT teams to minimize the impact on business operations during these actions.\n- Reactivate multi-factor authentication for the user.\n- Review the permissions assigned to the implicated user to ensure that the least privilege principle is being followed.\n- Implement security best practices [outlined](https://aws.amazon.com/premiumsupport/knowledge-center/security-best-practices/) by AWS.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection via the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).",
        "output_index": "",
        "version": 210,
        "tags": [
          "Domain: Cloud",
          "Data Source: AWS",
          "Data Source: Amazon Web Services",
          "Data Source: AWS IAM",
          "Resources: Investigation Guide",
          "Tactic: Impact",
          "Tactic: Persistence"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-3600s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic",
          "Austin Songer"
        ],
        "false_positives": [
          "A MFA device may be deactivated by a system or network administrator. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. MFA device deactivations from unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule."
        ],
        "references": [
          "https://awscli.amazonaws.com/v2/documentation/api/latest/reference/iam/deactivate-mfa-device.html",
          "https://docs.aws.amazon.com/IAM/latest/APIReference/API_DeactivateMFADevice.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0040",
              "name": "Impact",
              "reference": "https://attack.mitre.org/tactics/TA0040/"
            },
            "technique": [
              {
                "id": "T1531",
                "name": "Account Access Removal",
                "reference": "https://attack.mitre.org/techniques/T1531/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1556",
                "name": "Modify Authentication Process",
                "reference": "https://attack.mitre.org/techniques/T1556/",
                "subtechnique": [
                  {
                    "id": "T1556.006",
                    "name": "Multi-Factor Authentication",
                    "reference": "https://attack.mitre.org/techniques/T1556/006/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The AWS Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "aws",
            "version": "^2.0.0",
            "integration": "cloudtrail"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "65bc0111-6b8f-44d3-b148-d0751a20da19",
        "rule_id": "d8fc1cca-93ed-43c1-bbb6-c0dd3eff2958",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:08.562Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:17:07.100Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-aws.cloudtrail-*"
        ],
        "filters": [],
        "query": "event.dataset:aws.cloudtrail and event.provider:iam.amazonaws.com and event.action:(DeactivateMFADevice or DeleteVirtualMFADevice) and event.outcome:success",
        "language": "kuery"
      },
      {
        "name": "Potential Hidden Process via Mount Hidepid",
        "description": "Identifies the execution of mount process with hidepid parameter, which can make processes invisible to other users from the system. Adversaries using Linux kernel version 3.2+ (or RHEL/CentOS v6.5+ above) can hide the process from other users. When hidepid=2 option is executed to mount the /proc filesystem, only the root user can see all processes and the logged-in user can only see their own process. This provides a defense evasion mechanism for the adversaries to hide their process executions from all other commands such as ps, top, pgrep and more. With the Linux kernel hardening hidepid option all the user has to do is remount the /proc filesystem with the option, which can now be monitored and detected.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 9,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Auditd Manager"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.cyberciti.biz/faq/linux-hide-processes-from-other-users/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1564",
                "name": "Hide Artifacts",
                "reference": "https://attack.mitre.org/techniques/T1564/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "auditd_manager",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.command_line",
            "type": "wildcard",
            "ecs": true
          }
        ],
        "id": "972ae0aa-ea49-4f40-9a47-074dff770759",
        "rule_id": "dc71c186-9fe4-4437-a4d0-85ebb32b8204",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:08.565Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:17:07.147Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and\nevent.action in (\"exec\", \"exec_event\", \"executed\", \"process_started\") and\nprocess.name == \"mount\" and process.args == \"/proc\" and process.args == \"-o\" and process.args : \"*hidepid=2*\" and\nnot process.parent.command_line like \"/opt/cloudlinux/*\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*",
          "auditbeat-*",
          "logs-auditd_manager.auditd-*"
        ],
        "filters": []
      },
      {
        "name": "Potentially Suspicious Process Started via tmux or screen",
        "description": "This rule monitors for the execution of suspicious commands via screen and tmux. When launching a command and detaching directly, the commands will be executed in the background via its parent process. Attackers may leverage screen or tmux to execute commands while attempting to evade detection.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 5,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1218",
                "name": "System Binary Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1218/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "57079851-3641-4e75-bbb9-58f6fd29f280",
        "rule_id": "e0cc3807-e108-483c-bf66-5a4fbe0d7e89",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:08.578Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:17:07.288Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\") and \nprocess.parent.name in (\"screen\", \"tmux\") and process.name like (\n  \"nmap\", \"nc\", \"ncat\", \"netcat\", \"socat\", \"nc.openbsd\", \"ngrok\", \"ping\", \"java\", \"php*\", \"perl\", \"ruby\", \"lua*\",\n  \"openssl\", \"telnet\", \"wget\", \"curl\", \"id\"\n)",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "Network Traffic Capture via CAP_NET_RAW",
        "description": "Identifies the ability of a process to be able to create RAW and PACKET socket types for the available network namespaces by a non-root user. A malicious process with this capability may exploit routing between hosts, bypass network access controls, and otherwise tamper with host networking if a firewall is not in place to limit the packet types and contents. The CAP_NET_RAW capability allows the process to bind to any address within the available namespaces, which allows network traffic sniffing by a non root user. The rule identifies previously unknown processes executing with CAP_NET_RAW capabilities through the use of the new terms rule type.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 4,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Data Source: Elastic Defend",
          "Rule Type: BBR"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1040",
                "name": "Network Sniffing",
                "reference": "https://attack.mitre.org/techniques/T1040/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.thread.capabilities.effective",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.thread.capabilities.permitted",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "7e0e5a43-ec75-4d6c-afef-17a037434e0c",
        "rule_id": "e28b8093-833b-4eda-b877-0873d134cf3c",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:08.581Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:17:07.350Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "event.category:\"process\" and host.os.type:\"linux\" and event.type:\"start\" and event.action:\"exec\" and process.name:* and\n(process.thread.capabilities.effective:\"CAP_NET_RAW\" or process.thread.capabilities.permitted:\"CAP_NET_RAW\") and\nnot user.id:\"0\"",
        "new_terms_fields": [
          "process.executable"
        ],
        "history_window_start": "now-14d",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Indirect Command Execution via Forfiles/Pcalua",
        "description": "Identifies indirect command execution via Program Compatibility Assistant (pcalua.exe) or forfiles.exe.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 104,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend",
          "Rule Type: BBR",
          "Data Source: Elastic Endgame",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1202",
                "name": "Indirect Command Execution",
                "reference": "https://attack.mitre.org/techniques/T1202/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "57dd993e-b240-49d6-8042-53e8007f97ca",
        "rule_id": "98843d35-645e-4e66-9d6a-5049acd96ce1",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:08.816Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:58.686Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.parent.name : (\"pcalua.exe\", \"forfiles.exe\")",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "logs-system.security*",
          "winlogbeat-*",
          "logs-windows.*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "Potential Shadow File Read via Command Line Utilities",
        "description": "Identifies access to the /etc/shadow file via the commandline using standard system utilities. After elevating privileges to root, threat actors may attempt to read or dump this file in order to gain valid credentials. They may utilize these to move laterally undetected and access additional resources.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 209,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Tactic: Credential Access",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.cyberciti.biz/faq/unix-linux-password-cracking-john-the-ripper/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1068",
                "name": "Exploitation for Privilege Escalation",
                "reference": "https://attack.mitre.org/techniques/T1068/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1003",
                "name": "OS Credential Dumping",
                "reference": "https://attack.mitre.org/techniques/T1003/",
                "subtechnique": [
                  {
                    "id": "T1003.008",
                    "name": "/etc/passwd and /etc/shadow",
                    "reference": "https://attack.mitre.org/techniques/T1003/008/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.working_directory",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "8e788764-10ed-4819-bbd8-67047ac8252f",
        "rule_id": "9a3a3689-8ed1-4cdb-83fb-9506db54c61f",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:11.511Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:58.740Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "host.os.type : \"linux\" and event.category : \"process\" and event.action : (\"exec\" or \"exec_event\") and\n(process.args : \"/etc/shadow\" or (process.working_directory: \"/etc\" and process.args: \"shadow\")) and not (\n  (process.executable : (\"/bin/chown\" or \"/usr/bin/chown\") and process.args : \"root:shadow\") or\n  (process.executable : (\"/bin/chmod\" or \"/usr/bin/chmod\") and process.args : \"640\") or\n  process.executable:(/vz/* or /var/lib/docker/* or /run/containerd/* or /tmp/.criu* or /tmp/newroot/*) or\n  process.parent.name:(gen_passwd_sets or scc_* or wazuh-modulesd)\n)",
        "new_terms_fields": [
          "process.executable"
        ],
        "history_window_start": "now-10d",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "GitHub Owner Role Granted To User",
        "description": "This rule detects when a member is granted the organization owner role of a GitHub organization. This role provides admin level privileges. Any new owner role should be investigated to determine its validity. Unauthorized owner roles could indicate compromise within your organization and provide unlimited access to data and settings.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Cloud",
          "Use Case: Threat Detection",
          "Use Case: UEBA",
          "Tactic: Persistence",
          "Data Source: Github"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1098",
                "name": "Account Manipulation",
                "reference": "https://attack.mitre.org/techniques/T1098/",
                "subtechnique": [
                  {
                    "id": "T1098.003",
                    "name": "Additional Cloud Roles",
                    "reference": "https://attack.mitre.org/techniques/T1098/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "github",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "github.permission",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "15949125-1148-48ea-864c-83f2cdbeae86",
        "rule_id": "9b343b62-d173-4cfd-bd8b-e6379f964ca4",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:11.523Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:58.750Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "iam where event.dataset == \"github.audit\" and event.action == \"org.update_member\" and github.permission == \"admin\"",
        "language": "eql",
        "index": [
          "logs-github.audit-*"
        ],
        "filters": []
      },
      {
        "name": "Access Control List Modification via setfacl",
        "description": "This rule detects Linux Access Control List (ACL) modification via the setfacl command.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 2,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame",
          "Data Source: Auditd Manager"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.uptycs.com/blog/threat-research-report-team/evasive-techniques-used-by-malicious-linux-shell-scripts"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1222",
                "name": "File and Directory Permissions Modification",
                "reference": "https://attack.mitre.org/techniques/T1222/",
                "subtechnique": [
                  {
                    "id": "T1222.002",
                    "name": "Linux and Mac File and Directory Permissions Modification",
                    "reference": "https://attack.mitre.org/techniques/T1222/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "auditd_manager",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "dda0cd92-e2ad-4214-a1cd-ec45e91dcc5e",
        "rule_id": "999565a2-fc52-4d72-91e4-ba6712c0377e",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:11.526Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:58.726Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and\nevent.action in (\"exec\", \"exec_event\", \"executed\", \"process_started\") and\nprocess.name == \"setfacl\" and not (\n  process.command_line == \"/bin/setfacl --restore=-\" or\n  process.args == \"/var/log/journal/\"\n)",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*",
          "auditbeat-*",
          "logs-auditd_manager.auditd-*"
        ],
        "filters": []
      },
      {
        "name": "Privilege Escalation via CAP_SETUID/SETGID Capabilities",
        "description": "Identifies instances where a process (granted CAP_SETUID and/or CAP_SETGID capabilities) is executed, after which the user's access is elevated to UID/GID 0 (root). In Linux, the CAP_SETUID and CAP_SETGID capabilities allow a process to change its UID and GID, respectively, providing control over user and group identity management. Attackers may leverage a misconfiguration for exploitation in order to escalate their privileges to root.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 4,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1068",
                "name": "Exploitation for Privilege Escalation",
                "reference": "https://attack.mitre.org/techniques/T1068/"
              },
              {
                "id": "T1548",
                "name": "Abuse Elevation Control Mechanism",
                "reference": "https://attack.mitre.org/techniques/T1548/",
                "subtechnique": [
                  {
                    "id": "T1548.001",
                    "name": "Setuid and Setgid",
                    "reference": "https://attack.mitre.org/techniques/T1548/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.thread.capabilities.effective",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.thread.capabilities.permitted",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "e20f9ad7-3328-4c17-b357-a3a0648eadaf",
        "rule_id": "9b80cb26-9966-44b5-abbf-764fbdbc3586",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:11.530Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:58.755Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by host.id, process.entity_id with maxspan=1s\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and process.name != null and\n   (process.thread.capabilities.effective : \"CAP_SET?ID\" or process.thread.capabilities.permitted : \"CAP_SET?ID\") and \n   user.id != \"0\" and not (\n     process.parent.executable : (\"/tmp/newroot/*\", \"/opt/carbonblack*\") or\n     process.parent.executable in (\n       \"/opt/SolarWinds/Agent/bin/Plugins/JobEngine/SolarWinds.Agent.JobEngine.Plugin\", \"/usr/bin/vmware-toolbox-cmd\",\n       \"/usr/bin/dbus-daemon\", \"/usr/bin/update-notifier\", \"/usr/share/language-tools/language-options\",\n       \"/opt/SolarWinds/Agent/*\", \"/usr/local/sbin/lynis.sh\"\n     ) or\n     process.executable : (\"/opt/dynatrace/*\", \"/tmp/newroot/*\", \"/opt/SolarWinds/Agent/*\") or\n     process.executable in (\n       \"/bin/fgrep\", \"/usr/bin/sudo\", \"/usr/bin/pkexec\", \"/usr/lib/cockpit/cockpit-session\", \"/usr/sbin/suexec\"\n     ) or\n     process.parent.name in (\"update-notifier\", \"language-options\", \"osqueryd\", \"saposcol\", \"dbus-daemon\", \"osqueryi\", \"sdbrun\") or\n     process.command_line like (\"sudo*BECOME-SUCCESS*\", \"/bin/sh*sapsysinfo.sh*\", \"sudo su\", \"sudo su -\") or\n     process.name == \"sudo\" or\n     process.parent.command_line like \"/usr/bin/python*ansible*\"\n   )]\n  [process where host.os.type == \"linux\" and event.action == \"uid_change\" and event.type == \"change\" and \n   (process.thread.capabilities.effective : \"CAP_SET?ID\" or process.thread.capabilities.permitted : \"CAP_SET?ID\")\n   and user.id == \"0\"]",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "AWS EC2 Instance Interaction with IAM Service",
        "description": "Identifies when an EC2 instance interacts with the AWS IAM service via an assumed role. This is uncommon behavior and could indicate an attacker using compromised credentials to further exploit an environment. For example, an assumed role could be used to create new users for persistence or add permissions for privilege escalation. An EC2 instance assumes a role using their EC2 ID as the session name. This rule looks for the pattern \"i-\" which is the beginning pattern for assumed role sessions started by an EC2 instance. This is a [building block](https://www.elastic.co/guide/en/security/current/building-block-rule.html) rule and does not generate alerts on its own. It is meant to be used for correlation with other rules to detect suspicious activity.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "investigation_fields": {
          "field_names": [
            "@timestamp",
            "source.address",
            "user.name",
            "user.id",
            "aws.cloudtrail.user_identity.arn",
            "aws.cloudtrail.user_identity.type",
            "user_agent.original",
            "user.target.name",
            "event.action",
            "event.outcome",
            "cloud.region",
            "event.provider",
            "aws.cloudtrail.request_parameters",
            "aws.cloudtrail.response_elements"
          ]
        },
        "version": 2,
        "tags": [
          "Domain: Cloud",
          "Data Source: AWS",
          "Data Source: Amazon Web Services",
          "Data Source: AWS EC2",
          "Data Source: AWS IAM",
          "Use Case: Identity and Access Audit",
          "Tactic: Privilege Escalation",
          "Tactic: Persistence",
          "Rule Type: BBR"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Administrators may use EC2 instances to interact with IAM services as part of an automation workflow, ensure validity of the triggered event and include exceptions where necessary."
        ],
        "references": [
          "https://redcanary.com/blog/aws-sts/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1078",
                "name": "Valid Accounts",
                "reference": "https://attack.mitre.org/techniques/T1078/",
                "subtechnique": [
                  {
                    "id": "T1078.004",
                    "name": "Cloud Accounts",
                    "reference": "https://attack.mitre.org/techniques/T1078/004/"
                  }
                ]
              },
              {
                "id": "T1098",
                "name": "Account Manipulation",
                "reference": "https://attack.mitre.org/techniques/T1098/",
                "subtechnique": [
                  {
                    "id": "T1098.001",
                    "name": "Additional Cloud Credentials",
                    "reference": "https://attack.mitre.org/techniques/T1098/001/"
                  },
                  {
                    "id": "T1098.003",
                    "name": "Additional Cloud Roles",
                    "reference": "https://attack.mitre.org/techniques/T1098/003/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            }
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "aws",
            "version": "^2.0.0",
            "integration": "cloudtrail"
          }
        ],
        "required_fields": [
          {
            "name": "aws.cloudtrail.user_identity.type",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "48df157b-60dd-4854-b395-9b2c89ada064",
        "rule_id": "a44bcb58-5109-4870-a7c6-11f5fe7dd4b1",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:11.536Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:58.845Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "any where event.dataset == \"aws.cloudtrail\"\n    and event.provider == \"iam.amazonaws.com\"\n    and aws.cloudtrail.user_identity.type == \"AssumedRole\"\n    and stringContains(user.id, \":i-\")\n    and (\n            startsWith(event.action, \"Update\")\n            or startsWith(event.action, \"Attach\")\n            or startsWith(event.action, \"Detach\")\n            or startsWith(event.action, \"Create\")\n            or startsWith(event.action, \"Delete\")\n            or startsWith(event.action, \"Add\")\n            or startsWith(event.action, \"Remove\")\n            or startsWith(event.action, \"Put\")\n            or startsWith(event.action, \"Tag\")\n    )",
        "language": "eql",
        "index": [
          "filebeat-*",
          "logs-aws.cloudtrail-*"
        ],
        "filters": []
      },
      {
        "name": "File Permission Modification in Writable Directory",
        "description": "Identifies file permission modifications in common writable directories by a non-root user. Adversaries often drop files or payloads into a writable directory and change permissions prior to execution.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 211,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Certain programs or applications may modify files or change ownership in writable directories. These can be exempted by username."
        ],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1222",
                "name": "File and Directory Permissions Modification",
                "reference": "https://attack.mitre.org/techniques/T1222/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from one of the following integrations:\n- Elastic Defend\n- Auditbeat\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n### Auditbeat Setup\nAuditbeat is a lightweight shipper that you can install on your servers to audit the activities of users and processes on your systems. For example, you can use Auditbeat to collect and centralize audit events from the Linux Audit Framework. You can also use Auditbeat to detect changes to critical files, like binaries and configuration files, and identify potential security policy violations.\n\n#### The following steps should be executed in order to add the Auditbeat on a Linux System:\n- Elastic provides repositories available for APT and YUM-based distributions. Note that we provide binary packages, but no source packages.\n- To install the APT and YUM repositories follow the setup instructions in this [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/setup-repositories.html).\n- To run Auditbeat on Docker follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/running-on-docker.html).\n- To run Auditbeat on Kubernetes follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/running-on-kubernetes.html).\n- For complete â€œSetup and Run Auditbeatâ€ information refer to the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/setting-up-and-running.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.working_directory",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "3ca972a5-1924-4399-b947-cd853136814b",
        "rule_id": "9f9a2a82-93a8-4b1a-8778-1780895626d4",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:11.533Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:58.795Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "host.os.type:linux and event.category:process and event.type:start and\nprocess.name:(chattr or chgrp or chmod or chown) and process.working_directory:(/dev/shm or /tmp or /var/tmp) and\nnot process.parent.name:(apt-key or update-motd-updates-available or apt-get)",
        "new_terms_fields": [
          "host.id",
          "process.parent.executable",
          "process.command_line"
        ],
        "history_window_start": "now-14d",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Privileged Docker Container Creation",
        "description": "This rule leverages the new_terms rule type to identify the creation of a potentially unsafe docker container from an unusual parent process. Attackers can use the `--privileged` flag to create containers with escalated privileges, which can lead to trivial privilege escalation, docker escaping and persistence. access.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 2,
        "tags": [
          "Domain: Endpoint",
          "Domain: Container",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.004",
                    "name": "Unix Shell",
                    "reference": "https://attack.mitre.org/techniques/T1059/004/"
                  }
                ]
              },
              {
                "id": "T1609",
                "name": "Container Administration Command",
                "reference": "https://attack.mitre.org/techniques/T1609/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1611",
                "name": "Escape to Host",
                "reference": "https://attack.mitre.org/techniques/T1611/"
              }
            ]
          }
        ],
        "setup": "## Setup\nThis rule requires data coming in from Elastic Defend.\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "0e672db9-e2d2-4272-a260-b87ca00264e7",
        "rule_id": "a80d96cd-1164-41b3-9852-ef58724be496",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:11.539Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:17:00.706Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "host.os.type:linux and event.category:process and event.type:start and event.action:exec and process.name:docker and\nprocess.args:(run and --privileged)",
        "new_terms_fields": [
          "process.parent.executable"
        ],
        "history_window_start": "now-14d",
        "index": [
          "logs-endpoint.events.process*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Openssl Client or Server Activity",
        "description": "This rule identifies when the openssl client or server is used to establish a connection. Attackers may use openssl to establish a secure connection to a remote server or to create a secure server to receive connections. This activity may be used to exfiltrate data or establish a command and control channel.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 2,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://gtfobins.github.io/gtfobins/openssl/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.004",
                    "name": "Unix Shell",
                    "reference": "https://attack.mitre.org/techniques/T1059/004/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            },
            "technique": [
              {
                "id": "T1071",
                "name": "Application Layer Protocol",
                "reference": "https://attack.mitre.org/techniques/T1071/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "d774ddc0-e43b-4e85-a2f7-a72aec5166d6",
        "rule_id": "ad5a3757-c872-4719-8c72-12d3f08db655",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:11.542Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:17:00.847Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\") and\nprocess.name == \"openssl\" and (\n  (process.args == \"s_client\" and process.args : (\"-connect\", \"*:*\") and not process.args == \"-showcerts\") or\n  (process.args == \"s_server\" and process.args == \"-port\")\n) and\nnot process.parent.executable in (\"/pro/xymon/client/ext/awsXymonCheck.sh\", \"/opt/antidot-svc/nrpe/plugins/check_cert\")",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "Shared Object Created or Changed by Previously Unknown Process",
        "description": "This rule monitors the creation of shared object files by previously unknown processes. The creation of a shared object file involves compiling code into a dynamically linked library that can be loaded by other programs at runtime. While this process is typically used for legitimate purposes, malicious actors can leverage shared object files to execute unauthorized code, inject malicious functionality into legitimate processes, or bypass security controls. This allows malware to persist on the system, evade detection, and potentially compromise the integrity and confidentiality of the affected system and its data.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Shared Object Created or Changed by Previously Unknown Process\n\nA shared object file is a compiled library file (typically with a .so extension) that can be dynamically linked to executable programs at runtime, allowing for code reuse and efficient memory usage. The creation of a shared object file involves compiling code into a dynamically linked library that can be loaded by other programs at runtime.\n\nMalicious actors can leverage shared object files to execute unauthorized code, inject malicious functionality into legitimate processes, or bypass security controls. This allows malware to persist on the system, evade detection, and potentially compromise the integrity and confidentiality of the affected system and its data.\n\nThis rule monitors the creation of shared object files by previously unknown processes through the usage of the new terms rule type.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n> This investigation guide uses [placeholder fields](https://www.elastic.co/guide/en/security/current/osquery-placeholder-fields.html) to dynamically pass alert data into Osquery queries. Placeholder fields were introduced in Elastic Stack version 8.7.0. If you're using Elastic Stack version 8.6.0 or earlier, you'll need to manually adjust this investigation guide's queries to ensure they properly run.\n\n#### Possible Investigation Steps\n\n- Investigate the shared object that was created or modified through OSQuery.\n  - !{osquery{\"label\":\"Osquery - Retrieve File Listing Information\",\"query\":\"SELECT * FROM file WHERE path = {{file.path}}\\n\"}}\n  - !{osquery{\"label\":\"Osquery - Retrieve Additional File Listing Information\",\"query\":\"SELECT f.path, u.username AS file_owner, g.groupname AS group_owner, datetime(f.atime, 'unixepoch') AS\\nfile_last_access_time, datetime(f.mtime, 'unixepoch') AS file_last_modified_time, datetime(f.ctime, 'unixepoch') AS\\nfile_last_status_change_time, datetime(f.btime, 'unixepoch') AS file_created_time, f.size AS size_bytes FROM file f LEFT\\nJOIN users u ON f.uid = u.uid LEFT JOIN groups g ON f.gid = g.gid WHERE path = {{file.path}}\\n\"}}\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence and whether they are located in expected locations.\n  - !{osquery{\"label\":\"Osquery - Retrieve Running Processes by User\",\"query\":\"SELECT pid, username, name FROM processes p JOIN users u ON u.uid = p.uid ORDER BY username\"}}\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Validate the activity is not related to planned patches, updates, network administrator activity, or legitimate software installations.\n- Investigate whether the altered scripts call other malicious scripts elsewhere on the file system. \n  - If scripts or executables were dropped, retrieve the files and determine if they are malicious:\n    - Use a private sandboxed malware analysis system to perform analysis.\n      - Observe and collect information about the following activities:\n        - Attempts to contact external domains and addresses.\n          - Check if the domain is newly registered or unexpected.\n          - Check the reputation of the domain or IP address.\n        - File access, modification, and creation activities.\n        - Cron jobs, services and other persistence mechanisms.\n            - !{osquery{\"label\":\"Osquery - Retrieve Crontab Information\",\"query\":\"SELECT * FROM crontab\"}}\n- Investigate abnormal behaviors by the subject process/user such as network connections, file modifications, and any other spawned child processes.\n  - Investigate listening ports and open sockets to look for potential command and control traffic or data exfiltration.\n    - !{osquery{\"label\":\"Osquery - Retrieve Listening Ports\",\"query\":\"SELECT pid, address, port, socket, protocol, path FROM listening_ports\"}}\n    - !{osquery{\"label\":\"Osquery - Retrieve Open Sockets\",\"query\":\"SELECT pid, family, remote_address, remote_port, socket, state FROM process_open_sockets\"}}\n  - Identify the user account that performed the action, analyze it, and check whether it should perform this kind of action.\n    - !{osquery{\"label\":\"Osquery - Retrieve Information for a Specific User\",\"query\":\"SELECT * FROM users WHERE username = {{user.name}}\"}}\n- Investigate whether the user is currently logged in and active.\n    - !{osquery{\"label\":\"Osquery - Investigate the Account Authentication Status\",\"query\":\"SELECT * FROM logged_in_users WHERE user = {{user.name}}\"}}\n\n### False Positive Analysis\n\n- If this activity is related to new benign software installation activity, consider adding exceptions â€” preferably with a combination of user and command line conditions.\n- If this activity is related to a system administrator that performed these actions for administrative purposes, consider adding exceptions for this specific administrator user account. \n- Try to understand the context of the execution by thinking about the user, machine, or business purpose. A small number of endpoints, such as servers with unique software, might appear unusual but satisfy a specific business need.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Leverage the incident response data and logging to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 9,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://threatpost.com/sneaky-malware-backdoors-linux/180158/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1574",
                "name": "Hijack Execution Flow",
                "reference": "https://attack.mitre.org/techniques/T1574/",
                "subtechnique": [
                  {
                    "id": "T1574.006",
                    "name": "Dynamic Linker Hijacking",
                    "reference": "https://attack.mitre.org/techniques/T1574/006/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "40828d5a-a052-4156-8569-75f44e3a77bc",
        "rule_id": "aebaa51f-2a91-4f6a-850b-b601db2293f4",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:11.545Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:17:00.877Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "host.os.type:linux and event.action:(creation or file_create_event or file_rename_event or rename) and \nfile.path:(/dev/shm/* or /usr/lib/*) and file.extension:so and process.name:* and not (\n  process.name:(\n    \"dockerd\" or \"dpkg\" or \"rpm\" or \"snapd\" or \"yum\" or \"vmis-launcher\" or \"pacman\" or \"apt-get\" or \"dnf\" or \"podman\" or\n    platform-python* or \"dnf-automatic\" or \"unattended-upgrade\" or \"apk\" or \"snap-update-ns\" or \"install\" or \"exe\" or\n    \"systemd\" or \"root\" or \"sshd\" or \"pip\" or \"jlink\" or python* or \"update-alternatives\" or pip* or\n    \"installer.bin.inst\" or \"uninstall-bin\" or \"linux_agent.inst\"\n  ) or \n  (process.name:vmware-install.pl and file.path:/usr/lib/vmware-tools/*) or\n  process.executable : (/dev/fd/* or \"/\" or \"/kaniko/executor\" or \"/usr/bin/buildah\")\n)",
        "new_terms_fields": [
          "file.path",
          "process.executable"
        ],
        "history_window_start": "now-10d",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Kernel Module Load via insmod",
        "description": "Detects the use of the insmod binary to load a Linux kernel object file. Threat actors can use this binary, given they have root privileges, to load a rootkit on a system providing them with complete control and the ability to hide from security products. Manually loading a kernel module in this manner should not be at all common and can indicate suspcious or malicious behavior.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Kernel module load via insmod\n\nThe insmod binary is a Linux utility that allows users with root privileges to load kernel modules, which are object files that extend the functionality of the kernel. \n\nThreat actors can abuse this utility to load rootkits, granting them full control over the system and the ability to evade security products.\n\nThe detection rule 'Kernel module load via insmod' is designed to identify instances where the insmod binary is used to load a kernel object file (with a .ko extension) on a Linux system. This activity is uncommon and may indicate suspicious or malicious behavior.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n> This investigation guide uses [placeholder fields](https://www.elastic.co/guide/en/security/current/osquery-placeholder-fields.html) to dynamically pass alert data into Osquery queries. Placeholder fields were introduced in Elastic Stack version 8.7.0. If you're using Elastic Stack version 8.6.0 or earlier, you'll need to manually adjust this investigation guide's queries to ensure they properly run.\n\n### Possible investigation steps\n\n- Investigate the kernel object file that was loaded via insmod.\n  - !{osquery{\"label\":\"Osquery - Retrieve Running Processes by User\",\"query\":\"SELECT pid, username, name FROM processes p JOIN users u ON u.uid = p.uid ORDER BY username\"}}\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence and whether they are located in expected locations.\n  - !{osquery{\"label\":\"Osquery - Retrieve Listening Ports\",\"query\":\"SELECT pid, address, port, socket, protocol, path FROM listening_ports\"}}\n- Investigate the kernel ring buffer for any warnings or messages, such as tainted or out-of-tree kernel module loads through `dmesg`.\n- Investigate syslog for any unusual segfaults or other messages. Rootkits may be installed on targets with different architecture as expected, and could potentially cause segmentation faults. \n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Validate the activity is not related to planned patches, updates, network administrator activity, or legitimate software installations.\n- Investigate whether the altered scripts call other malicious scripts elsewhere on the file system. \n  - If scripts or executables were dropped, retrieve the files and determine if they are malicious:\n    - Use a private sandboxed malware analysis system to perform analysis.\n      - Observe and collect information about the following activities:\n        - Attempts to contact external domains and addresses.\n          - Check if the domain is newly registered or unexpected.\n          - Check the reputation of the domain or IP address.\n        - File access, modification, and creation activities.\n- Investigate abnormal behaviors by the subject process/user such as network connections, file modifications, and any other spawned child processes.\n  - Investigate listening ports and open sockets to look for potential command and control traffic or data exfiltration.\n    - !{osquery{\"label\":\"Osquery - Retrieve Open Sockets\",\"query\":\"SELECT pid, family, remote_address, remote_port, socket, state FROM process_open_sockets\"}}\n    - !{osquery{\"label\":\"Osquery - Retrieve Information for a Specific User\",\"query\":\"SELECT * FROM users WHERE username = {{user.name}}\"}}\n  - Identify the user account that performed the action, analyze it, and check whether it should perform this kind of action.\n    - !{osquery{\"label\":\"Osquery - Investigate the Account Authentication Status\",\"query\":\"SELECT * FROM logged_in_users WHERE user = {{user.name}}\"}}\n- Investigate whether the user is currently logged in and active.\n    - $osquery_6\n\n### False positive analysis\n\n- If this activity is related to new benign software installation activity, consider adding exceptions â€” preferably with a combination of user and command line conditions.\n- If this activity is related to a system administrator who uses cron jobs for administrative purposes, consider adding exceptions for this specific administrator user account. \n- Try to understand the context of the execution by thinking about the user, machine, or business purpose. A small number of endpoints, such as servers with unique software, might appear unusual but satisfy a specific business need.\n\n### Related Rules\n\n- Kernel Driver Load - 3e12a439-d002-4944-bc42-171c0dcb9b96\n- Tainted Out-Of-Tree Kernel Module Load - 51a09737-80f7-4551-a3be-dac8ef5d181a\n- Tainted Kernel Module Load - 05cad2fb-200c-407f-b472-02ea8c9e5e4a\n- Attempt to Clear Kernel Ring Buffer - 2724808c-ba5d-48b2-86d2-0002103df753\n- Enumeration of Kernel Modules via Proc - 80084fa9-8677-4453-8680-b891d3c0c778\n- Suspicious Modprobe File Event - 40ddbcc8-6561-44d9-afc8-eefdbfe0cccd\n- Kernel Module Removal - cd66a5af-e34b-4bb0-8931-57d0a043f2ef\n- Enumeration of Kernel Modules - 2d8043ed-5bda-4caf-801c-c1feb7410504\n\n### Response and Remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Leverage the incident response data and logging to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 110,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Threat: Rootkit",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Auditd Manager"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://decoded.avast.io/davidalvarez/linux-threat-hunting-syslogk-a-kernel-rootkit-found-under-development-in-the-wild/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1547",
                "name": "Boot or Logon Autostart Execution",
                "reference": "https://attack.mitre.org/techniques/T1547/",
                "subtechnique": [
                  {
                    "id": "T1547.006",
                    "name": "Kernel Modules and Extensions",
                    "reference": "https://attack.mitre.org/techniques/T1547/006/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "auditd_manager",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "6c60b2dd-e815-4b3b-8cda-8edb9ed9e754",
        "rule_id": "2339f03c-f53f-40fa-834b-40c5983fc41f",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:11.548Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:42.427Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and process.name == \"insmod\" and process.args : \"*.ko\" and\nnot process.parent.executable like (\n  \"/opt/ds_agent/*\", \"/usr/sbin/veeamsnap-loader\", \"/opt/TrendMicro/vls_agent/*\", \"/opt/intel/oneapi/*\",\n  \"/opt/commvault/Base/linux_drv\", \"/bin/falcoctl\"\n)",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*",
          "auditbeat-*",
          "logs-auditd_manager.auditd-*"
        ],
        "filters": []
      },
      {
        "name": "New GitHub Owner Added",
        "description": "Detects when a new member is added to a GitHub organization as an owner. This role provides admin level privileges. Any new owner roles should be investigated to determine it's validity. Unauthorized owner roles could indicate compromise within your organization and provide unlimited access to data and settings.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Cloud",
          "Use Case: Threat Detection",
          "Use Case: UEBA",
          "Tactic: Persistence",
          "Data Source: Github"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1136",
                "name": "Create Account",
                "reference": "https://attack.mitre.org/techniques/T1136/",
                "subtechnique": [
                  {
                    "id": "T1136.003",
                    "name": "Cloud Account",
                    "reference": "https://attack.mitre.org/techniques/T1136/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "github",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "github.permission",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "b67a70b8-4898-43bf-9832-837aa58a77da",
        "rule_id": "24401eca-ad0b-4ff9-9431-487a8e183af9",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:11.550Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:42.445Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "iam where event.dataset == \"github.audit\" and event.action == \"org.add_member\" and github.permission == \"admin\"",
        "language": "eql",
        "index": [
          "logs-github.audit-*"
        ],
        "filters": []
      },
      {
        "name": "Network Activity Detected via Kworker",
        "description": "This rule monitors for network connections from a kworker process. kworker, or kernel worker, processes are part of the kernel's workqueue mechanism. They are responsible for executing work that has been scheduled to be done in kernel space, which might include tasks like handling interrupts, background activities, and other kernel-related tasks. Attackers may attempt to evade detection by masquerading as a kernel worker process.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 6,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Command and Control",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            }
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1014",
                "name": "Rootkit",
                "reference": "https://attack.mitre.org/techniques/T1014/"
              },
              {
                "id": "T1036",
                "name": "Masquerading",
                "reference": "https://attack.mitre.org/techniques/T1036/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0010",
              "name": "Exfiltration",
              "reference": "https://attack.mitre.org/tactics/TA0010/"
            },
            "technique": [
              {
                "id": "T1041",
                "name": "Exfiltration Over C2 Channel",
                "reference": "https://attack.mitre.org/techniques/T1041/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows\nthe Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest to select \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "destination.port",
            "type": "long",
            "ecs": true
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "bff316c1-01eb-4ae2-861f-8ef9cdd35eec",
        "rule_id": "25d917c4-aa3c-4111-974c-286c0312ff95",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:11.553Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:42.454Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "host.os.type:linux and event.category:network and event.action:(connection_attempted or connection_accepted) and \nprocess.name:kworker* and not destination.ip:(\n  10.0.0.0/8 or\n  127.0.0.0/8 or\n  169.254.0.0/16 or\n  172.16.0.0/12 or\n  192.168.0.0/16 or\n  224.0.0.0/4 or\n  \"::1\" or\n  \"FE80::/10\" or\n  \"FF00::/8\"\n) and not destination.port:(\"2049\" or \"111\" or \"892\" or \"597\")",
        "new_terms_fields": [
          "process.name",
          "host.id"
        ],
        "history_window_start": "now-14d",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Sudo Command Enumeration Detected",
        "description": "This rule monitors for the usage of the sudo -l command, which is used to list the allowed and forbidden commands for the invoking user. Attackers may execute this command to enumerate commands allowed to be executed with sudo permissions, potentially allowing to escalate privileges to root.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 6,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1033",
                "name": "System Owner/User Discovery",
                "reference": "https://attack.mitre.org/techniques/T1033/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args_count",
            "type": "long",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "08188d3a-192d-46a1-914f-6bd2d2e7e426",
        "rule_id": "28d39238-0c01-420a-b77a-24e5a7378663",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:11.557Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:44.218Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and \nprocess.name == \"sudo\" and process.args == \"-l\" and process.args_count == 2 and\nprocess.parent.name in (\"bash\", \"dash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\") and \nnot process.args == \"dpkg\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "AWS EC2 Security Group Configuration Change",
        "description": "Identifies a change to an AWS Security Group Configuration. A security group is like a virtual firewall, and modifying configurations may allow unauthorized access. Threat actors may abuse this to establish persistence, exfiltrate data, or pivot in an AWS environment.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "### Investigating AWS EC2 Security Group Configuration Change\n\nThis rule identifies any changes to an AWS Security Group, which functions as a virtual firewall controlling inbound and outbound traffic for resources like EC2 instances. Modifications to a security group configuration could expose critical assets to unauthorized access. Threat actors may exploit such changes to establish persistence, exfiltrate data, or pivot within an AWS environment.\n\n#### Possible Investigation Steps\n\n1. **Identify the Modified Security Group**:\n   - **Security Group ID**: Check the `aws.cloudtrail.flattened.request_parameters.groupId` field to identify the specific security group affected.\n   - **Rule Changes**: Review `aws.cloudtrail.flattened.response_elements.securityGroupRuleSet` to determine the new rules or configurations, including any added or removed IP ranges, protocol changes, and port specifications.\n\n2. **Review User Context**:\n   - **User Identity**: Inspect the `aws.cloudtrail.user_identity.arn` field to determine which user or role made the modification. Verify if this is an authorized administrator or a potentially compromised account.\n   - **Access Patterns**: Analyze whether this user regularly interacts with security group configurations or if this event is out of the ordinary for their account.\n\n3. **Analyze the Configuration Change**:\n   - **Egress vs. Ingress**: Determine if the change affected inbound (ingress) or outbound (egress) traffic by reviewing fields like `isEgress` in the `securityGroupRuleSet`. Unauthorized changes to outbound traffic can indicate data exfiltration attempts.\n   - **IP Ranges and Ports**: Assess any added IP ranges, especially `0.0.0.0/0`, which exposes resources to the internet. Port changes should also be evaluated to ensure only necessary ports are open.\n\n4. **Check User Agent and Source IP**:\n   - **User Agent Analysis**: Examine the `user_agent.original` field to identify the tool or application used, such as `AWS Console` or `Terraform`, which may reveal if the action was automated or manual.\n   - **Source IP and Geolocation**: Use `source.address` and `source.geo` fields to verify if the IP address and geolocation match expected locations for your organization. Unexpected IPs or regions may indicate unauthorized access.\n\n5. **Evaluate for Persistence Indicators**:\n   - **Repeated Changes**: Investigate if similar changes were recently made across multiple security groups, which may suggest an attempt to maintain or expand access.\n   - **Permissions Review**: Confirm that the userâ€™s IAM policies are configured to limit changes to security groups only as necessary.\n\n6. **Correlate with Other CloudTrail Events**:\n   - **Cross-Reference Other Security Events**: Look for related actions like `AuthorizeSecurityGroupIngress`, `CreateSecurityGroup`, or `RevokeSecurityGroupIngress` that may indicate additional or preparatory steps for unauthorized access.\n   - **Monitor for IAM or Network Changes**: Check for IAM modifications, network interface changes, or other configuration updates in the same timeframe to detect broader malicious activities.\n\n### False Positive Analysis\n\n- **Routine Security Changes**: Security group modifications may be part of regular infrastructure maintenance. Verify if this action aligns with known, scheduled administrative activities.\n- **Automated Configuration Management**: If you are using automated tools like `Terraform` or `CloudFormation`, confirm if the change matches expected configuration drift corrections or deployments.\n\n### Response and Remediation\n\n- **Revert Unauthorized Changes**: If unauthorized, revert the security group configuration to its previous state to secure the environment.\n- **Restrict Security Group Permissions**: Remove permissions to modify security groups from any compromised or unnecessary accounts to limit future access.\n- **Quarantine Affected Resources**: If necessary, isolate any affected instances or resources to prevent further unauthorized activity.\n- **Audit IAM and Security Group Policies**: Regularly review permissions related to security groups to ensure least privilege access and prevent excessive access.\n\n### Additional Information\n\nFor more details on managing AWS Security Groups and best practices, refer to the [AWS EC2 Security Groups Documentation](https://docs.aws.amazon.com/AWSEC2/latest/WindowsGuide/ec2-security-groups.html) and AWS security best practices.\n",
        "output_index": "",
        "investigation_fields": {
          "field_names": [
            "@timestamp",
            "user.name",
            "aws.cloudtrail.user_identity.arn",
            "aws.cloudtrail.user_identity.type",
            "user_agent.original",
            "aws.cloudtrail.flattened.request_parameters.instanceId",
            "event.action",
            "event.outcome",
            "cloud.region",
            "event.provider",
            "aws.cloudtrail.request_parameters",
            "aws.cloudtrail.response_elements"
          ]
        },
        "version": 207,
        "tags": [
          "Domain: Cloud",
          "Data Source: AWS",
          "Data Source: Amazon Web Services",
          "Data Source: AWS EC2",
          "Use Case: Network Security Monitoring",
          "Resources: Investigation Guide",
          "Tactic: Persistence",
          "Tactic: Defense Evasion"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic",
          "Austin Songer"
        ],
        "false_positives": [
          "A security group may be created by a system or network administrator. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. Security group creations by unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule."
        ],
        "references": [
          "https://docs.aws.amazon.com/AWSEC2/latest/WindowsGuide/ec2-security-groups.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            }
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.007",
                    "name": "Disable or Modify Cloud Firewall",
                    "reference": "https://attack.mitre.org/techniques/T1562/007/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "aws",
            "version": "^2.0.0",
            "integration": "cloudtrail"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "2a610862-ae0b-4b4e-871a-4794ece24c66",
        "rule_id": "29052c19-ff3e-42fd-8363-7be14d7c5469",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:11.569Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:44.234Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-aws.cloudtrail-*"
        ],
        "filters": [],
        "query": "event.dataset: \"aws.cloudtrail\"\n    and event.provider: \"ec2.amazonaws.com\"\n    and event.action:(\n            \"AuthorizeSecurityGroupEgress\" or\n            \"CreateSecurityGroup\" or\n            \"ModifyInstanceAttribute\" or\n            \"ModifySecurityGroupRules\" or\n            \"RevokeSecurityGroupEgress\" or\n            \"RevokeSecurityGroupIngress\")\n    and event.outcome: \"success\"",
        "language": "kuery"
      },
      {
        "name": "Linux SSH X11 Forwarding",
        "description": "This rule monitors for X11 forwarding via SSH. X11 forwarding is a feature that allows users to run graphical applications on a remote server and display the application's graphical user interface on their local machine. Attackers can abuse X11 forwarding for tunneling their GUI-based tools, pivot through compromised systems, and create covert communication channels, enabling lateral movement and facilitating remote control of systems within a network.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Potential Linux SSH X11 Forwarding\n\nAttackers can leverage SSH X11 forwarding to capture a user's graphical desktop session and potentially execute unauthorized GUI applications remotely.\n\nThis rule looks for the execution of SSH in conjunction with command line arguments that are capable of setting up X11 forwarding. \n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n> This investigation guide uses [placeholder fields](https://www.elastic.co/guide/en/security/current/osquery-placeholder-fields.html) to dynamically pass alert data into Osquery queries. Placeholder fields were introduced in Elastic Stack version 8.7.0. If you're using Elastic Stack version 8.6.0 or earlier, you'll need to manually adjust this investigation guide's queries to ensure they properly run.\n\n#### Possible investigation steps\n\n- Identify any signs of suspicious network activity or anomalies that may indicate network forwarding activity. This could include unexpected traffic patterns or unusual network behavior.\n  - Investigate listening ports and open sockets to look for potential protocol tunneling, reverse shells, or data exfiltration.\n    - !{osquery{\"label\":\"Osquery - Retrieve Listening Ports\",\"query\":\"SELECT pid, address, port, socket, protocol, path FROM listening_ports\"}}\n    - !{osquery{\"label\":\"Osquery - Retrieve Open Sockets\",\"query\":\"SELECT pid, family, remote_address, remote_port, socket, state FROM process_open_sockets\"}}\n- Identify the user account that performed the action, analyze it, and check whether it should perform this kind of action.\n  - !{osquery{\"label\":\"Osquery - Retrieve Information for a Specific User\",\"query\":\"SELECT * FROM users WHERE username = {{user.name}}\"}}\n- Investigate whether the user is currently logged in and active.\n  - !{osquery{\"label\":\"Osquery - Investigate the Account Authentication Status\",\"query\":\"SELECT * FROM logged_in_users WHERE user = {{user.name}}\"}}\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence and whether they are located in expected locations.\n  - !{osquery{\"label\":\"Osquery - Retrieve Running Processes by User\",\"query\":\"SELECT pid, username, name FROM processes p JOIN users u ON u.uid = p.uid ORDER BY username\"}}\n  - !{osquery{\"label\":\"Osquery - Retrieve Process Info\",\"query\":\"SELECT name, cmdline, parent, path, uid FROM processes\"}}\n- Investigate other alerts associated with the user/host during the past 48 hours.\n  - If scripts or executables were dropped, retrieve the files and determine if they are malicious:\n    - Use a private sandboxed malware analysis system to perform analysis.\n      - Observe and collect information about the following activities:\n        - Attempts to contact external domains and addresses.\n          - Check if the domain is newly registered or unexpected.\n          - Check the reputation of the domain or IP address.\n        - File access, modification, and creation activities.\n\n### Related rules\n\n- Potential Linux Tunneling and/or Port Forwarding - 6ee947e9-de7e-4281-a55d-09289bdf947e\n\n### False positive analysis\n\n- If this activity is related to new benign software installation activity, consider adding exceptions â€” preferably with a combination of user and command line conditions.\n- If this activity is related to a system administrator or developer who uses port tunneling/forwarding for benign purposes, consider adding exceptions for specific user accounts or hosts. \n- Try to understand the context of the execution by thinking about the user, machine, or business purpose. A small number of endpoints, such as servers with unique software, might appear unusual but satisfy a specific business need.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors, such as reverse shells, reverse proxies, or droppers, that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Leverage the incident response data and logging to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 4,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Command and Control",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://book.hacktricks.xyz/generic-methodologies-and-resources/tunneling-and-port-forwarding"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            },
            "technique": [
              {
                "id": "T1572",
                "name": "Protocol Tunneling",
                "reference": "https://attack.mitre.org/techniques/T1572/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args_count",
            "type": "long",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "7fd6c8de-1738-4ccd-a702-c40d8188edb1",
        "rule_id": "29f0cf93-d17c-4b12-b4f3-a433800539fa",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:11.572Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:44.249Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\") and\nprocess.name in (\"ssh\", \"sshd\") and process.args in (\"-X\", \"-Y\") and process.args_count >= 3 and \nprocess.parent.name in (\"bash\", \"dash\", \"ash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\")",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "Potential Code Execution via Postgresql",
        "description": "This rule monitors for suspicious activities that may indicate an attacker attempting to execute arbitrary code within a PostgreSQL environment. Attackers can execute code via PostgreSQL as a result of gaining unauthorized access to a public facing PostgreSQL database or exploiting vulnerabilities, such as remote command execution and SQL injection attacks, which can result in unauthorized access and malicious actions, and facilitate post-exploitation activities for unauthorized access and malicious actions.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 7,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.004",
                    "name": "Unix Shell",
                    "reference": "https://attack.mitre.org/techniques/T1059/004/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.parent.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "71ebf9fb-39f8-496d-95d7-a36d5137e39b",
        "rule_id": "2a692072-d78d-42f3-a48a-775677d79c4e",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:11.575Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:44.254Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and\nevent.action in (\"exec\", \"exec_event\", \"fork\", \"fork_event\") and user.name == \"postgres\" and (\n  (process.parent.args : \"*sh\" and process.parent.args : \"echo*\") or \n  (process.args : \"*sh\" and process.args : \"echo*\")\n) and not (\n  process.parent.name == \"puppet\" or\n  process.command_line like \"*BECOME-SUCCESS-*\" or\n  process.parent.command_line like \"*BECOME-SUCCESS-*\"\n)",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "ESXI Discovery via Grep",
        "description": "Identifies instances where a process named 'grep', 'egrep', or 'pgrep' is started on a Linux system with arguments related to virtual machine (VM) files, such as \"vmdk\", \"vmx\", \"vmxf\", \"vmsd\", \"vmsn\", \"vswp\", \"vmss\", \"nvram\", or \"vmem\". These file extensions are associated with VM-related file formats, and their presence in grep command arguments may indicate that a threat actor is attempting to search for, analyze, or manipulate VM files on the system.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 7,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame",
          "Data Source: Auditd Manager"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.bleepingcomputer.com/news/security/massive-esxiargs-ransomware-attack-targets-vmware-esxi-servers-worldwide/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1518",
                "name": "Software Discovery",
                "reference": "https://attack.mitre.org/techniques/T1518/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "auditd_manager",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "af9b6b05-a21b-491a-ae44-af759c0f2893",
        "rule_id": "2b662e21-dc6e-461e-b5cf-a6eb9b235ec4",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:11.578Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:44.264Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and\nevent.action in (\"exec\", \"exec_event\", \"executed\", \"process_started\") and\nprocess.name in (\"grep\", \"egrep\", \"pgrep\") and\nprocess.args in (\"vmdk\", \"vmx\", \"vmxf\", \"vmsd\", \"vmsn\", \"vswp\", \"vmss\", \"nvram\", \"vmem\") and\nnot process.parent.executable == \"/usr/share/qemu/init/qemu-kvm-init\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*",
          "auditbeat-*",
          "logs-auditd_manager.auditd-*"
        ],
        "filters": []
      },
      {
        "name": "Enumeration of Kernel Modules",
        "description": "Loadable Kernel Modules (or LKMs) are pieces of code that can be loaded and unloaded into the kernel upon demand. They extend the functionality of the kernel without the need to reboot the system. This identifies attempts to enumerate information about a kernel module.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 210,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Security tools and device drivers may run these programs in order to enumerate kernel modules. Use of these programs by ordinary users is uncommon. These can be exempted by process name or username."
        ],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1082",
                "name": "System Information Discovery",
                "reference": "https://attack.mitre.org/techniques/T1082/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "1a297457-c1b9-4710-b86f-1f15beca5fa5",
        "rule_id": "2d8043ed-5bda-4caf-801c-c1feb7410504",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:11.581Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:44.269Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "event.category:process and host.os.type:linux and event.type:start and event.action:(exec or exec_event) and (\n (process.name:(lsmod or modinfo)) or \n (process.name:kmod and process.args:list) or \n (process.name:depmod and process.args:(--all or -a))\n) and\nnot (\n  process.parent.name:(\n    mkinitramfs or cryptroot or framebuffer or dracut or jem or thin-provisioning-tools or readykernel or lvm2 or\n    vz-start or iscsi or mdadm or ovalprobes or bcache or plymouth or dkms or overlayroot or weak-modules or zfs or\n    systemd or whoopsie-upload-all or kdumpctl or apport-gtk or casper or rear or kernel-install\n  )\n)",
        "new_terms_fields": [
          "process.executable",
          "process.parent.executable"
        ],
        "history_window_start": "now-14d",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Accessing Outlook Data Files",
        "description": "Identifies commands containing references to Outlook data files extensions, which can potentially indicate the search, access, or modification of these files.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 105,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Collection",
          "Data Source: Elastic Defend",
          "Rule Type: BBR",
          "Data Source: Sysmon",
          "Data Source: Elastic Endgame",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0009",
              "name": "Collection",
              "reference": "https://attack.mitre.org/tactics/TA0009/"
            },
            "technique": [
              {
                "id": "T1114",
                "name": "Email Collection",
                "reference": "https://attack.mitre.org/techniques/T1114/",
                "subtechnique": [
                  {
                    "id": "T1114.001",
                    "name": "Local Email Collection",
                    "reference": "https://attack.mitre.org/techniques/T1114/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "fedcf3f7-e35d-4c3f-a59f-24a7bdfe8f2d",
        "rule_id": "2e311539-cd88-4a85-a301-04f38795007c",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:11.584Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:44.292Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and process.args : (\"*.ost\", \"*.pst\") and\n  not process.name : \"outlook.exe\" and\n  not (\n        process.name : \"rundll32.exe\" and\n        process.args : \"*davclnt.dll,DavSetCookie*\"\n  )",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "winlogbeat-*"
        ],
        "filters": []
      },
      {
        "name": "ESXI Discovery via Find",
        "description": "Identifies instances where the 'find' command is started on a Linux system with arguments targeting specific VM-related paths, such as \"/etc/vmware/\", \"/usr/lib/vmware/\", or \"/vmfs/*\". These paths are associated with VMware virtualization software, and their presence in the find command arguments may indicate that a threat actor is attempting to search for, analyze, or manipulate VM-related files and configurations on the system.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 7,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame",
          "Data Source: Auditd Manager"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.bleepingcomputer.com/news/security/massive-esxiargs-ransomware-attack-targets-vmware-esxi-servers-worldwide/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1518",
                "name": "Software Discovery",
                "reference": "https://attack.mitre.org/techniques/T1518/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "auditd_manager",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "91f1f1a4-2b43-4010-b591-b22d7b60a316",
        "rule_id": "33a6752b-da5e-45f8-b13a-5f094c09522f",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:11.587Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:44.395Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and\nevent.action in (\"exec\", \"exec_event\", \"executed\", \"process_started\") and process.name == \"find\" and\nprocess.args : (\"/etc/vmware/*\", \"/usr/lib/vmware/*\", \"/vmfs/*\") and \nnot process.parent.executable == \"/usr/lib/vmware/viewagent/bin/uninstall_viewagent.sh\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*",
          "auditbeat-*",
          "logs-auditd_manager.auditd-*"
        ],
        "filters": []
      },
      {
        "name": "GitHub Repository Deleted",
        "description": "This rule detects when a GitHub repository is deleted within your organization. Repositories are a critical component used within an organization to manage work, collaborate with others and release products to the public. Any delete action against a repository should be investigated to determine it's validity. Unauthorized deletion of organization repositories could cause irreversible loss of intellectual property and indicate compromise within your organization.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 203,
        "tags": [
          "Domain: Cloud",
          "Use Case: Threat Detection",
          "Use Case: UEBA",
          "Tactic: Impact",
          "Data Source: Github"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0040",
              "name": "Impact",
              "reference": "https://attack.mitre.org/tactics/TA0040/"
            },
            "technique": [
              {
                "id": "T1485",
                "name": "Data Destruction",
                "reference": "https://attack.mitre.org/techniques/T1485/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "github",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.module",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "c2d81afe-0901-4f52-8f97-cd9c16832648",
        "rule_id": "345889c4-23a8-4bc0-b7ca-756bd17ce83b",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:11.590Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:44.410Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "configuration where event.module == \"github\" and event.dataset == \"github.audit\" and event.action == \"repo.destroy\"",
        "language": "eql",
        "index": [
          "logs-github.audit-*"
        ],
        "filters": []
      },
      {
        "name": "First Occurrence of User Agent For a GitHub Personal Access Token (PAT)",
        "description": "Detects a new user agent used for a GitHub PAT not previously seen in the last 14 days.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 204,
        "tags": [
          "Domain: Cloud",
          "Use Case: Threat Detection",
          "Use Case: UEBA",
          "Tactic: Initial Access",
          "Rule Type: BBR",
          "Data Source: Github"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1078",
                "name": "Valid Accounts",
                "reference": "https://attack.mitre.org/techniques/T1078/",
                "subtechnique": [
                  {
                    "id": "T1078.004",
                    "name": "Cloud Accounts",
                    "reference": "https://attack.mitre.org/techniques/T1078/004/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "github",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "github.hashed_token",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "github.programmatic_access_type",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "github.user_agent",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "b5fc164d-bff9-4dc4-815b-aebe2b44fc45",
        "rule_id": "0e4367a0-a483-439d-ad2e-d90500b925fd",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:11.594Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:40.160Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "event.dataset:\"github.audit\" and event.category:\"configuration\" and\ngithub.user_agent:* and github.hashed_token:* and\ngithub.programmatic_access_type:(\"OAuth access token\" or \"Fine-grained personal access token\")",
        "new_terms_fields": [
          "github.hashed_token",
          "github.user_agent"
        ],
        "history_window_start": "now-14d",
        "index": [
          "logs-github.audit-*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Possible Consent Grant Attack via Azure-Registered Application",
        "description": "Detects when a user grants permissions to an Azure-registered application or when an administrator grants tenant-wide permissions to an application. An adversary may create an Azure-registered application that requests access to data such as contact information, email, or documents.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Possible Consent Grant Attack via Azure-Registered Application\n\nIn an illicit consent grant attack, the attacker creates an Azure-registered application that requests access to data such as contact information, email, or documents. The attacker then tricks an end user into granting that application consent to access their data either through a phishing attack, or by injecting illicit code into a trusted website. After the illicit application has been granted consent, it has account-level access to data without the need for an organizational account. Normal remediation steps like resetting passwords for breached accounts or requiring multi-factor authentication (MFA) on accounts are not effective against this type of attack, since these are third-party applications and are external to the organization.\n\nOfficial Microsoft guidance for detecting and remediating this attack can be found [here](https://docs.microsoft.com/en-us/microsoft-365/security/office-365-security/detect-and-remediate-illicit-consent-grants).\n\n#### Possible investigation steps\n\n- From the Azure AD portal, Review the application that was granted permissions:\n  - Click on the `Review permissions` button on the `Permissions` blade of the application.\n  - An app should require only permissions related to the app's purpose. If that's not the case, the app might be risky.\n  - Apps that require high privileges or admin consent are more likely to be risky.\n- Investigate the app and the publisher. The following characteristics can indicate suspicious apps:\n  -  A low number of downloads.\n  -  Low rating or score or bad comments.\n  -  Apps with a suspicious publisher or website.\n  -  Apps whose last update is not recent. This might indicate an app that is no longer supported.\n- Export and examine the [Oauth app auditing](https://docs.microsoft.com/en-us/defender-cloud-apps/manage-app-permissions#oauth-app-auditing) to identify users affected.\n\n### False positive analysis\n\n- This mechanism can be used legitimately. Malicious applications abuse the same workflow used by legitimate apps. Thus, analysts must review each app consent to ensure that only desired apps are granted access.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Identify the possible impact of the incident and prioritize accordingly; the following actions can help you gain context:\n    - Identify the account role in the cloud environment.\n    - Assess the criticality of affected services and servers.\n    - Work with your IT team to identify and minimize the impact on users.\n    - Identify if the attacker is moving laterally and compromising other accounts, servers, or services.\n    - Identify any regulatory or legal ramifications related to this activity.\n- Disable the malicious application to stop user access and the application access to your data.\n- Revoke the application Oauth consent grant. The `Remove-AzureADOAuth2PermissionGrant` cmdlet can be used to complete this task.\n- Remove the service principal application role assignment. The `Remove-AzureADServiceAppRoleAssignment` cmdlet can be used to complete this task.\n- Revoke the refresh token for all users assigned to the application. Azure provides a [playbook](https://github.com/Azure/Azure-Sentinel/tree/master/Playbooks/Revoke-AADSignInSessions) for this task.\n- [Report](https://docs.microsoft.com/en-us/defender-cloud-apps/manage-app-permissions#send-feedback) the application as malicious to Microsoft.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords or delete API keys as needed to revoke the attacker's access to the environment. Work with your IT teams to minimize the impact on business operations during these actions.\n- Investigate the potential for data compromise from the user's email and file sharing services. Activate your Data Loss incident response playbook.\n- Disable the permission for a user to set consent permission on their behalf.\n  - Enable the [Admin consent request](https://docs.microsoft.com/en-us/azure/active-directory/manage-apps/configure-admin-consent-workflow) feature.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).",
        "output_index": "",
        "version": 213,
        "tags": [
          "Domain: Cloud",
          "Data Source: Azure",
          "Data Source: Microsoft 365",
          "Use Case: Identity and Access Audit",
          "Resources: Investigation Guide",
          "Tactic: Initial Access"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-1500s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://docs.microsoft.com/en-us/microsoft-365/security/office-365-security/detect-and-remediate-illicit-consent-grants?view=o365-worldwide",
          "https://www.cloud-architekt.net/detection-and-mitigation-consent-grant-attacks-azuread/",
          "https://docs.microsoft.com/en-us/defender-cloud-apps/investigate-risky-oauth#how-to-detect-risky-oauth-apps"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1566",
                "name": "Phishing",
                "reference": "https://attack.mitre.org/techniques/T1566/",
                "subtechnique": [
                  {
                    "id": "T1566.002",
                    "name": "Spearphishing Link",
                    "reference": "https://attack.mitre.org/techniques/T1566/002/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1528",
                "name": "Steal Application Access Token",
                "reference": "https://attack.mitre.org/techniques/T1528/"
              }
            ]
          }
        ],
        "setup": "The Azure Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "azure",
            "version": "^1.0.0",
            "integration": "activitylogs"
          },
          {
            "package": "azure",
            "version": "^1.0.0"
          },
          {
            "package": "o365",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "azure.activitylogs.operation_name",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "azure.auditlogs.operation_name",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "e4892a5d-bad5-41f2-91d6-c34b94ce44d1",
        "rule_id": "1c6a8c7a-5cb6-4a82-ba27-d5a5b8a40a38",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:11.597Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:42.275Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-azure*",
          "logs-o365*"
        ],
        "filters": [],
        "query": "event.dataset:(azure.activitylogs or azure.auditlogs or o365.audit) and\n  (\n    azure.activitylogs.operation_name:\"Consent to application\" or\n    azure.auditlogs.operation_name:\"Consent to application\" or \n    event.action:\"Consent to application.\"\n  ) and\n  event.outcome:(Success or success)",
        "language": "kuery"
      },
      {
        "name": "New GitHub App Installed",
        "description": "This rule detects when a new GitHub App has been installed in your organization account. GitHub Apps extend GitHub's functionality both within and outside of GitHub. When an app is installed it is granted permissions to read or modify your repository and organization data. Only trusted apps should be installed and any newly installed apps should be investigated to verify their legitimacy. Unauthorized app installation could lower your organization's security posture and leave you exposed for future attacks.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 204,
        "tags": [
          "Domain: Cloud",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Data Source: Github"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1072",
                "name": "Software Deployment Tools",
                "reference": "https://attack.mitre.org/techniques/T1072/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "github",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "9a7562dd-b4ff-4fdb-a730-8b3bfb341e7c",
        "rule_id": "1ca62f14-4787-4913-b7af-df11745a49da",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:11.600Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:42.290Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "configuration where event.dataset == \"github.audit\" and event.action == \"integration_installation.create\"",
        "language": "eql",
        "index": [
          "logs-github.audit-*"
        ],
        "filters": []
      },
      {
        "name": "Potential Linux Hack Tool Launched",
        "description": "Monitors for the execution of different processes that might be used by attackers for malicious intent. An alert from this rule should be investigated further, as hack tools are commonly used by blue teamers and system administrators as well.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 4,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Auditd Manager"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            }
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows\nthe Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest to select \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "auditd_manager",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "7b723e5b-f44f-4cb8-9df7-44277152c1cd",
        "rule_id": "1df1152b-610a-4f48-9d7a-504f6ee5d9da",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:11.603Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:42.318Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and\nevent.action in (\"exec\", \"exec_event\", \"executed\", \"process_started\") and\nprocess.name in~ (\n  // exploitation frameworks\n  \"crackmapexec\", \"msfconsole\", \"msfvenom\", \"sliver-client\", \"sliver-server\", \"havoc\",\n  // network scanners (nmap left out to reduce noise)\n  \"zenmap\", \"nuclei\", \"netdiscover\", \"legion\",\n  // web enumeration\n  \"gobuster\", \"dirbuster\", \"dirb\", \"wfuzz\", \"ffuf\", \"whatweb\", \"eyewitness\",\n  // web vulnerability scanning\n  \"wpscan\", \"joomscan\", \"droopescan\", \"nikto\", \n  // exploitation tools\n  \"sqlmap\", \"commix\", \"yersinia\",\n  // cracking and brute forcing\n  \"john\", \"hashcat\", \"hydra\", \"ncrack\", \"cewl\", \"fcrackzip\", \"rainbowcrack\",\n  // host and network\n  \"linenum.sh\", \"linpeas.sh\", \"pspy32\", \"pspy32s\", \"pspy64\", \"pspy64s\", \"binwalk\", \"evil-winrm\",\n  \"linux-exploit-suggester-2.pl\", \"linux-exploit-suggester.sh\", \"panix.sh\"\n)",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*",
          "auditbeat-*",
          "logs-auditd_manager.auditd-*"
        ],
        "filters": []
      },
      {
        "name": "Creation of SettingContent-ms Files",
        "description": "Identifies the suspicious creation of SettingContents-ms files, which have been used in attacks to achieve code execution while evading defenses.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 106,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Data Source: Elastic Defend",
          "Rule Type: BBR",
          "Data Source: Sysmon",
          "Data Source: Elastic Endgame"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://posts.specterops.io/the-tale-of-settingcontent-ms-files-f1ea253e4d39"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1204",
                "name": "User Execution",
                "reference": "https://attack.mitre.org/techniques/T1204/",
                "subtechnique": [
                  {
                    "id": "T1204.002",
                    "name": "Malicious File",
                    "reference": "https://attack.mitre.org/techniques/T1204/002/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1566",
                "name": "Phishing",
                "reference": "https://attack.mitre.org/techniques/T1566/",
                "subtechnique": [
                  {
                    "id": "T1566.001",
                    "name": "Spearphishing Attachment",
                    "reference": "https://attack.mitre.org/techniques/T1566/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "dfbdcba9-f350-488e-acb8-8a006ecc3fc0",
        "rule_id": "1e6363a6-3af5-41d4-b7ea-d475389c0ceb",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:11.606Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:42.336Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"windows\" and event.type == \"creation\" and\n  file.extension : \"settingcontent-ms\" and\n  not file.path : (\n    \"?:\\\\*\\\\AppData\\\\Local\\\\Packages\\\\windows.immersivecontrolpanel_*\\\\LocalState\\\\Indexed\\\\Settings\\\\*\",\n    \"\\\\Device\\\\HarddiskVolume*\\\\Windows\\\\WinSxS\\\\amd64_microsoft-windows-s..*\\\\*.settingcontent-ms\"\n  )",
        "language": "eql",
        "index": [
          "logs-endpoint.events.file-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "winlogbeat-*"
        ],
        "filters": []
      },
      {
        "name": "First Occurrence of Private Repo Event from Specific GitHub Personal Access Token (PAT)",
        "description": "Detects a new private repo interaction for a GitHub PAT not seen in the last 14 days.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 204,
        "tags": [
          "Domain: Cloud",
          "Use Case: Threat Detection",
          "Use Case: UEBA",
          "Tactic: Execution",
          "Rule Type: BBR",
          "Data Source: Github"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1648",
                "name": "Serverless Execution",
                "reference": "https://attack.mitre.org/techniques/T1648/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "github",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "github.hashed_token",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "github.programmatic_access_type",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "github.repo",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "github.repository_public",
            "type": "boolean",
            "ecs": false
          }
        ],
        "id": "3fed8588-c957-4377-9c0a-6534055f4d0d",
        "rule_id": "1e9b271c-8caa-4e20-aed8-e91e34de9283",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:11.609Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:42.342Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "event.dataset:\"github.audit\" and event.category:\"configuration\" and\ngithub.repo:* and github.hashed_token:* and\ngithub.programmatic_access_type:(\"OAuth access token\" or \"Fine-grained personal access token\") and \ngithub.repository_public:false",
        "new_terms_fields": [
          "github.hashed_token",
          "github.repo"
        ],
        "history_window_start": "now-14d",
        "index": [
          "logs-github.audit-*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Unusual Process Execution on WBEM Path",
        "description": "Identifies unusual processes running from the WBEM path, uncommon outside WMI-related Windows processes.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 104,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend",
          "Rule Type: BBR",
          "Data Source: Elastic Endgame",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1036",
                "name": "Masquerading",
                "reference": "https://attack.mitre.org/techniques/T1036/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "f0890676-bd43-4563-bdee-c9dccd5bbb75",
        "rule_id": "1f460f12-a3cf-4105-9ebb-f788cc63f365",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:11.612Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:42.358Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.executable : (\"?:\\\\Windows\\\\System32\\\\wbem\\\\*\", \"?:\\\\Windows\\\\SysWow64\\\\wbem\\\\*\") and\n  not process.name : (\n    \"mofcomp.exe\",\n    \"scrcons.exe\",\n    \"unsecapp.exe\",\n    \"wbemtest.exe\",\n    \"winmgmt.exe\",\n    \"wmiadap.exe\",\n    \"wmiapsrv.exe\",\n    \"wmic.exe\",\n    \"wmiprvse.exe\"\n  )",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "logs-system.security*",
          "winlogbeat-*",
          "logs-windows.*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "Binary Content Copy via Cmd.exe",
        "description": "Attackers may abuse cmd.exe commands to reassemble binary fragments into a malicious payload.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 106,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Tactic: Execution",
          "Data Source: Elastic Defend",
          "Rule Type: BBR",
          "Data Source: Sysmon",
          "Data Source: Elastic Endgame",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1140",
                "name": "Deobfuscate/Decode Files or Information",
                "reference": "https://attack.mitre.org/techniques/T1140/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.003",
                    "name": "Windows Command Shell",
                    "reference": "https://attack.mitre.org/techniques/T1059/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "57f1beb0-50d6-415d-95b9-67f6515246fd",
        "rule_id": "53dedd83-1be7-430f-8026-363256395c8b",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:11.615Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:48.531Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.name : \"cmd.exe\" and (\n    (process.args : \"type\" and process.args : (\">\", \">>\")) or\n    (process.args : \"copy\" and process.args : \"/b\"))",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "winlogbeat-*"
        ],
        "filters": []
      },
      {
        "name": "File Staged in Root Folder of Recycle Bin",
        "description": "Identifies files written to the root of the Recycle Bin folder instead of subdirectories. Adversaries may place files in the root of the Recycle Bin in preparation for exfiltration or to evade defenses.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 106,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Collection",
          "Data Source: Elastic Defend",
          "Rule Type: BBR",
          "Data Source: Elastic Endgame",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0009",
              "name": "Collection",
              "reference": "https://attack.mitre.org/tactics/TA0009/"
            },
            "technique": [
              {
                "id": "T1074",
                "name": "Data Staged",
                "reference": "https://attack.mitre.org/techniques/T1074/",
                "subtechnique": [
                  {
                    "id": "T1074.001",
                    "name": "Local Data Staging",
                    "reference": "https://attack.mitre.org/techniques/T1074/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "00107ae4-ff64-4fd1-b175-e2e30815fa80",
        "rule_id": "57bccf1d-daf5-4e1a-9049-ff79b5254704",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:11.618Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:50.339Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"windows\" and event.type == \"creation\" and\n  file.path : \"?:\\\\$RECYCLE.BIN\\\\*\" and\n  not file.path : \"?:\\\\$RECYCLE.BIN\\\\*\\\\*\" and\n  not file.name : \"desktop.ini\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.file-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "winlogbeat-*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious which Enumeration",
        "description": "This rule monitors for the usage of the which command with an unusual amount of process arguments. Attackers may leverage the which command to enumerate the system for useful installed utilities that may be used after compromising a system to escalate privileges or move latteraly across the network.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 7,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1082",
                "name": "System Information Discovery",
                "reference": "https://attack.mitre.org/techniques/T1082/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args_count",
            "type": "long",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "0f5a71d7-7cbb-45c6-938a-510dee817f9b",
        "rule_id": "5b18eef4-842c-4b47-970f-f08d24004bde",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:11.622Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:50.428Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\") and \nprocess.name == \"which\" and process.args_count >= 10 and not (\n  process.parent.name == \"jem\" or\n  process.parent.executable like (\"/vz/root/*\", \"/var/lib/docker/*\") or\n  process.args == \"--tty-only\"\n)\n\n/* potential tuning if rule would turn out to be noisy\nand process.args in (\"nmap\", \"nc\", \"ncat\", \"netcat\", nc.traditional\", \"gcc\", \"g++\", \"socat\") and \nprocess.parent.name in (\"bash\", \"dash\", \"ash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\")\n*/",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "New User Added To GitHub Organization",
        "description": "A new user was added to a GitHub organization.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 204,
        "tags": [
          "Domain: Cloud",
          "Use Case: Threat Detection",
          "Use Case: UEBA",
          "Tactic: Persistence",
          "Rule Type: BBR",
          "Data Source: Github"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1098",
                "name": "Account Manipulation",
                "reference": "https://attack.mitre.org/techniques/T1098/",
                "subtechnique": [
                  {
                    "id": "T1098.001",
                    "name": "Additional Cloud Credentials",
                    "reference": "https://attack.mitre.org/techniques/T1098/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "github",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "967e184e-8070-4924-983a-43575965b4b9",
        "rule_id": "61336fe6-c043-4743-ab6e-41292f439603",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:11.624Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:50.526Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "configuration where event.dataset == \"github.audit\" and event.action == \"org.add_member\"",
        "language": "eql",
        "index": [
          "logs-github.audit-*"
        ],
        "filters": []
      },
      {
        "name": "Network Connection Initiated by SSHD Child Process",
        "description": "This rule identifies an egress internet connection initiated by an SSH Daemon child process. This behavior is indicative of the alteration of a shell configuration file or other mechanism that launches a process when a new SSH login occurs. Attackers can also backdoor the SSH daemon to allow for persistence, call out to a C2 or to steal credentials.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 3,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://hadess.io/the-art-of-linux-persistence/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1546",
                "name": "Event Triggered Execution",
                "reference": "https://attack.mitre.org/techniques/T1546/",
                "subtechnique": [
                  {
                    "id": "T1546.004",
                    "name": "Unix Shell Configuration Modification",
                    "reference": "https://attack.mitre.org/techniques/T1546/004/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1021",
                "name": "Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1021/",
                "subtechnique": [
                  {
                    "id": "T1021.004",
                    "name": "SSH",
                    "reference": "https://attack.mitre.org/techniques/T1021/004/"
                  }
                ]
              },
              {
                "id": "T1563",
                "name": "Remote Service Session Hijacking",
                "reference": "https://attack.mitre.org/techniques/T1563/",
                "subtechnique": [
                  {
                    "id": "T1563.001",
                    "name": "SSH Hijacking",
                    "reference": "https://attack.mitre.org/techniques/T1563/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            }
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "474479d1-bd39-41de-bd3e-20c0a2fd1017",
        "rule_id": "63431796-f813-43af-820b-492ee2efec8e",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:11.627Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:50.542Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by host.id with maxspan=1s\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\n   process.parent.executable == \"/usr/sbin/sshd\"] by process.entity_id\n  [network where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"connection_attempted\" and not (\n     destination.ip == null or destination.ip == \"0.0.0.0\" or cidrmatch(\n     destination.ip, \"10.0.0.0/8\", \"127.0.0.0/8\", \"169.254.0.0/16\", \"172.16.0.0/12\", \"192.0.0.0/24\", \"192.0.0.0/29\",\n     \"192.0.0.8/32\", \"192.0.0.9/32\", \"192.0.0.10/32\", \"192.0.0.170/32\", \"192.0.0.171/32\", \"192.0.2.0/24\",\n     \"192.31.196.0/24\", \"192.52.193.0/24\", \"192.168.0.0/16\", \"192.88.99.0/24\", \"224.0.0.0/4\", \"100.64.0.0/10\",\n     \"192.175.48.0/24\",\"198.18.0.0/15\", \"198.51.100.0/24\", \"203.0.113.0/24\", \"240.0.0.0/4\", \"::1\", \"FE80::/10\",\n     \"FF00::/8\", \"172.31.0.0/16\"\n     )\n    ) and not (\n      process.executable in (\"/bin/yum\", \"/usr/bin/yum\") or\n      process.name in (\"login_duo\", \"ssh\", \"sshd\", \"sshd-session\")\n    )\n  ] by process.parent.entity_id",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Dynamic Linker Creation or Modification",
        "description": "Detects the creation or modification of files related to the dynamic linker on Linux systems. The dynamic linker is a shared library that is used by the Linux kernel to load and execute programs. Attackers may attempt to hijack the execution flow of a program by modifying the dynamic linker configuration files.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 2,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Tactic: Persistence",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1574",
                "name": "Hijack Execution Flow",
                "reference": "https://attack.mitre.org/techniques/T1574/",
                "subtechnique": [
                  {
                    "id": "T1574.006",
                    "name": "Dynamic Linker Hijacking",
                    "reference": "https://attack.mitre.org/techniques/T1574/006/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1574",
                "name": "Hijack Execution Flow",
                "reference": "https://attack.mitre.org/techniques/T1574/",
                "subtechnique": [
                  {
                    "id": "T1574.006",
                    "name": "Dynamic Linker Hijacking",
                    "reference": "https://attack.mitre.org/techniques/T1574/006/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.Ext.original.extension",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "54f7b1bd-9f76-4a44-a1ec-86444f317b2a",
        "rule_id": "640f79d1-571d-4f96-a9af-1194fc8cf763",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:11.632Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:50.577Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"linux\" and event.action in (\"creation\", \"rename\") and\nfile.path : (\"/etc/ld.so.preload\", \"/etc/ld.so.conf.d/*\", \"/etc/ld.so.conf\") and\nnot (\n  process.executable in (\n    \"/bin/dpkg\", \"/usr/bin/dpkg\", \"/bin/dockerd\", \"/usr/bin/dockerd\", \"/usr/sbin/dockerd\", \"/bin/microdnf\",\n    \"/usr/bin/microdnf\", \"/bin/rpm\", \"/usr/bin/rpm\", \"/bin/snapd\", \"/usr/bin/snapd\", \"/bin/yum\", \"/usr/bin/yum\",\n    \"/bin/dnf\", \"/usr/bin/dnf\", \"/bin/podman\", \"/usr/bin/podman\", \"/bin/dnf-automatic\", \"/usr/bin/dnf-automatic\",\n    \"/bin/pacman\", \"/usr/bin/pacman\", \"/usr/bin/dpkg-divert\", \"/bin/dpkg-divert\", \"/sbin/apk\", \"/usr/sbin/apk\",\n    \"/usr/local/sbin/apk\", \"/usr/bin/apt\", \"/usr/sbin/pacman\", \"/bin/podman\", \"/usr/bin/podman\", \"/usr/bin/puppet\",\n    \"/bin/puppet\", \"/opt/puppetlabs/puppet/bin/puppet\", \"/usr/bin/chef-client\", \"/bin/chef-client\",\n    \"/bin/autossl_check\", \"/usr/bin/autossl_check\", \"/proc/self/exe\", \"/dev/fd/*\",  \"/usr/bin/pamac-daemon\",\n    \"/bin/pamac-daemon\", \"/usr/lib/snapd/snapd\", \"/usr/local/bin/dockerd\", \"/usr/libexec/platform-python\",\n    \"/usr/lib/snapd/snap-update-ns\", \"/usr/bin/vmware-config-tools.pl\"\n  ) or\n  file.extension in (\"swp\", \"swpx\", \"swx\", \"dpkg-remove\") or\n  file.Ext.original.extension == \"dpkg-new\" or\n  process.executable : (\n    \"/nix/store/*\", \"/var/lib/dpkg/*\", \"/snap/*\", \"/dev/fd/*\", \"/usr/lib/virtualbox/*\", \"/opt/dynatrace/oneagent/*\"\n  ) or\n  process.executable == null or\n  process.name == \"java\" or\n  (process.name == \"sed\" and file.name : \"sed*\") or\n  (process.name == \"perl\" and file.name : \"e2scrub_all.tmp*\")\n)",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Network Connection via Recently Compiled Executable",
        "description": "This rule monitors a sequence involving a program compilation event followed by its execution and a subsequent network connection event. This behavior can indicate the set up of a reverse tcp connection to a command-and-control server. Attackers may spawn reverse shells to establish persistence onto a target system.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 6,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.004",
                    "name": "Unix Shell",
                    "reference": "https://attack.mitre.org/techniques/T1059/004/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            },
            "technique": [
              {
                "id": "T1071",
                "name": "Application Layer Protocol",
                "reference": "https://attack.mitre.org/techniques/T1071/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "071f8775-4549-41b5-8c55-86a756d54fb3",
        "rule_id": "64cfca9e-0f6f-4048-8251-9ec56a055e9e",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:11.635Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:50.592Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by host.id with maxspan=1m\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and \n   process.name in (\"gcc\", \"g++\", \"cc\")] by process.args\n  [file where host.os.type == \"linux\" and event.action == \"creation\" and process.name == \"ld\"] by file.name\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\"] by process.name\n  [network where host.os.type == \"linux\" and event.action == \"connection_attempted\" and destination.ip != null and not (\n     cidrmatch(destination.ip, \"127.0.0.0/8\", \"169.254.0.0/16\", \"224.0.0.0/4\", \"::1\") or\n     process.name in (\"simpleX\", \"conftest\", \"ssh\", \"python\", \"ispnull\", \"pvtui\")\n   )] by process.name",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "GitHub Repo Created",
        "description": "A new GitHub repository was created.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 204,
        "tags": [
          "Domain: Cloud",
          "Use Case: Threat Detection",
          "Use Case: UEBA",
          "Tactic: Execution",
          "Rule Type: BBR",
          "Data Source: Github"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1648",
                "name": "Serverless Execution",
                "reference": "https://attack.mitre.org/techniques/T1648/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "github",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "6415893c-826d-41d9-ad6b-ccd6872ac7dd",
        "rule_id": "6cea88e4-6ce2-4238-9981-a54c140d6336",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:11.647Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:52.493Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "configuration where event.dataset == \"github.audit\" and event.action == \"repo.create\"",
        "language": "eql",
        "index": [
          "logs-github.audit-*"
        ],
        "filters": []
      },
      {
        "name": "First Occurrence of IP Address For GitHub User",
        "description": "Detects a new IP address used for a GitHub user not previously seen in the last 14 days.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 204,
        "tags": [
          "Domain: Cloud",
          "Use Case: Threat Detection",
          "Use Case: UEBA",
          "Tactic: Initial Access",
          "Rule Type: BBR",
          "Data Source: Github"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1078",
                "name": "Valid Accounts",
                "reference": "https://attack.mitre.org/techniques/T1078/",
                "subtechnique": [
                  {
                    "id": "T1078.004",
                    "name": "Cloud Accounts",
                    "reference": "https://attack.mitre.org/techniques/T1078/004/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "github",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "github.actor_ip",
            "type": "ip",
            "ecs": false
          },
          {
            "name": "user.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "3c8f048c-ec73-4246-a5a8-1b768f3782fc",
        "rule_id": "3af4cb9b-973f-4c54-be2b-7623c0e21b2b",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:11.650Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:46.318Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "event.dataset:\"github.audit\" and event.category:\"configuration\" and\ngithub.actor_ip:* and user.name:*",
        "new_terms_fields": [
          "user.name",
          "github.actor_ip"
        ],
        "history_window_start": "now-14d",
        "index": [
          "logs-github.audit-*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Potential Protocol Tunneling via Chisel Client",
        "description": "This rule monitors for common command line flags leveraged by the Chisel client utility followed by a connection attempt. Chisel is a command-line utility used for creating and managing TCP and UDP tunnels, enabling port forwarding and secure communication between machines. Attackers can abuse the Chisel utility to establish covert communication channels, bypass network restrictions, and carry out malicious activities by creating tunnels that allow unauthorized access to internal systems.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Potential Protocol Tunneling via Chisel Client\n\nAttackers can leverage `chisel` to clandestinely tunnel network communications and evade security measures, potentially gaining unauthorized access to sensitive systems.\n\nThis rule looks for a sequence of command line arguments that are consistent with `chisel` client tunneling behavior, followed by a network event by an uncommon process. \n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n> This investigation guide uses [placeholder fields](https://www.elastic.co/guide/en/security/current/osquery-placeholder-fields.html) to dynamically pass alert data into Osquery queries. Placeholder fields were introduced in Elastic Stack version 8.7.0. If you're using Elastic Stack version 8.6.0 or earlier, you'll need to manually adjust this investigation guide's queries to ensure they properly run.\n\n#### Possible investigation steps\n\n- Identify any signs of suspicious network activity or anomalies that may indicate protocol tunneling. This could include unexpected traffic patterns or unusual network behavior.\n  - Investigate listening ports and open sockets to look for potential protocol tunneling, reverse shells, or data exfiltration.\n    - !{osquery{\"label\":\"Osquery - Retrieve Listening Ports\",\"query\":\"SELECT pid, address, port, socket, protocol, path FROM listening_ports\"}}\n    - !{osquery{\"label\":\"Osquery - Retrieve Open Sockets\",\"query\":\"SELECT pid, family, remote_address, remote_port, socket, state FROM process_open_sockets\"}}\n- Identify the user account that performed the action, analyze it, and check whether it should perform this kind of action.\n  - !{osquery{\"label\":\"Osquery - Retrieve Information for a Specific User\",\"query\":\"SELECT * FROM users WHERE username = {{user.name}}\"}}\n- Investigate whether the user is currently logged in and active.\n  - !{osquery{\"label\":\"Osquery - Investigate the Account Authentication Status\",\"query\":\"SELECT * FROM logged_in_users WHERE user = {{user.name}}\"}}\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence and whether they are located in expected locations.\n  - !{osquery{\"label\":\"Osquery - Retrieve Running Processes by User\",\"query\":\"SELECT pid, username, name FROM processes p JOIN users u ON u.uid = p.uid ORDER BY username\"}}\n  - !{osquery{\"label\":\"Osquery - Retrieve Process Info\",\"query\":\"SELECT name, cmdline, parent, path, uid FROM processes\"}}\n- Investigate other alerts associated with the user/host during the past 48 hours.\n  - If scripts or executables were dropped, retrieve the files and determine if they are malicious:\n    - Use a private sandboxed malware analysis system to perform analysis.\n      - Observe and collect information about the following activities:\n        - Attempts to contact external domains and addresses.\n          - Check if the domain is newly registered or unexpected.\n          - Check the reputation of the domain or IP address.\n        - File access, modification, and creation activities.\n\n### Related rules\n\n- Potential Protocol Tunneling via Chisel Server - ac8805f6-1e08-406c-962e-3937057fa86f\n- Potential Linux Tunneling and/or Port Forwarding - 6ee947e9-de7e-4281-a55d-09289bdf947e\n- Potential Protocol Tunneling via EarthWorm - 9f1c4ca3-44b5-481d-ba42-32dc215a2769\n\n### False positive analysis\n\n- If this activity is related to new benign software installation activity, consider adding exceptions â€” preferably with a combination of user and command line conditions.\n- If this activity is related to a system administrator or developer who uses port tunneling for benign purposes, consider adding exceptions for specific user accounts or hosts. \n- Try to understand the context of the execution by thinking about the user, machine, or business purpose. A small number of endpoints, such as servers with unique software, might appear unusual but satisfy a specific business need.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors, such as reverse shells, reverse proxies, or droppers, that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Leverage the incident response data and logging to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 6,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Command and Control",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://blog.bitsadmin.com/living-off-the-foreign-land-windows-as-offensive-platform",
          "https://book.hacktricks.xyz/generic-methodologies-and-resources/tunneling-and-port-forwarding"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            },
            "technique": [
              {
                "id": "T1572",
                "name": "Protocol Tunneling",
                "reference": "https://attack.mitre.org/techniques/T1572/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args_count",
            "type": "long",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "499d6864-543b-4415-bc8e-1194dca5a191",
        "rule_id": "3f12325a-4cc6-410b-8d4c-9fbbeb744cfd",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:11.653Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:46.377Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by host.id, process.entity_id with maxspan=3s\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and \n   process.args == \"client\" and process.args : (\"R*\", \"*:*\", \"*socks*\", \"*.*\") and process.args_count >= 4 and \n   process.parent.name in (\"bash\", \"dash\", \"ash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\") and\n   not process.name in (\"velociraptor\", \"nbemmcmd\")]\n  [network where host.os.type == \"linux\" and event.action == \"connection_attempted\" and event.type == \"start\" and \n   destination.ip != null and destination.ip != \"127.0.0.1\" and destination.ip != \"::1\" and \n   not process.name : (\n     \"python*\", \"php*\", \"perl\", \"ruby\", \"lua*\", \"openssl\", \"nc\", \"netcat\", \"ncat\", \"telnet\", \"awk\", \"java\", \"telnet\",\n     \"ftp\", \"socat\", \"curl\", \"wget\", \"dpkg\", \"docker\", \"dockerd\", \"yum\", \"apt\", \"rpm\", \"dnf\", \"ssh\", \"sshd\")]",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "GitHub User Blocked From Organization",
        "description": "A GitHub user was blocked from access to an organization.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 204,
        "tags": [
          "Domain: Cloud",
          "Use Case: Threat Detection",
          "Use Case: UEBA",
          "Tactic: Impact",
          "Rule Type: BBR",
          "Data Source: Github"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0040",
              "name": "Impact",
              "reference": "https://attack.mitre.org/tactics/TA0040/"
            },
            "technique": [
              {
                "id": "T1531",
                "name": "Account Access Removal",
                "reference": "https://attack.mitre.org/techniques/T1531/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "github",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "8c80b5a6-7b1a-464d-8208-5ef610053825",
        "rule_id": "4030c951-448a-4017-a2da-ed60f6d14f4f",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:11.655Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:46.409Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "configuration where event.dataset == \"github.audit\" and event.action == \"org.block_user\"",
        "language": "eql",
        "index": [
          "logs-github.audit-*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious Modprobe File Event",
        "description": "Detects file events involving kernel modules in modprobe configuration files, which may indicate unauthorized access or manipulation of critical kernel modules. Attackers may tamper with the modprobe files to load malicious or unauthorized kernel modules, potentially bypassing security measures, escalating privileges, or hiding their activities within the system.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 108,
        "tags": [
          "Data Source: Auditd Manager",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Rule Type: BBR"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1082",
                "name": "System Information Discovery",
                "reference": "https://attack.mitre.org/techniques/T1082/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires the use of the `auditd_manager` integration. `Auditd_manager` is a tool designed to simplify and enhance the management of the audit subsystem in Linux systems. It provides a user-friendly interface and automation capabilities for configuring and monitoring system auditing through the auditd daemon. With `auditd_manager`, administrators can easily define audit rules, track system events, and generate comprehensive audit reports, improving overall security and compliance in the system. The following steps should be executed in order to install and deploy `auditd_manager` on a Linux system.\n\n```\nKibana -->\nManagement -->\nIntegrations -->\nAuditd Manager -->\nAdd Auditd Manager\n```\n\n`Auditd_manager` subscribes to the kernel and receives events as they occur without any additional configuration. However, if more advanced configuration is required to detect specific behavior, audit rules can be added to the integration in either the \"audit rules\" configuration box or the \"auditd rule files\" box by specifying a file to read the audit rules from.\n\nFor this detection rule to trigger, the following additional audit rules are required to be added to the integration:\n```\n-w /etc/modprobe.conf -p wa -k modprobe\n-w /etc/modprobe.d -p wa -k modprobe\n```\n\nAdd the newly installed `auditd manager` to an agent policy, and deploy the agent on a Linux system from which auditd log files are desirable.\n",
        "related_integrations": [
          {
            "package": "auditd_manager",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "e8f4554d-6684-4b1a-92bc-1fe72826ba2f",
        "rule_id": "40ddbcc8-6561-44d9-afc8-eefdbfe0cccd",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:11.658Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:46.414Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "host.os.type:linux and event.category:file and event.action:\"opened-file\" and\nfile.path : (\"/etc/modprobe.conf\" or \"/etc/modprobe.d\" or /etc/modprobe.d/*) and not process.name:(\n  cp or dpkg or dockerd or lynis or mkinitramfs or snapd or systemd-udevd or borg or auditbeat or lspci or\n  aide or modprobe or python*\n)",
        "new_terms_fields": [
          "process.executable"
        ],
        "history_window_start": "now-14d",
        "index": [
          "auditbeat-*",
          "logs-auditd_manager.auditd-*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Unix Socket Connection",
        "description": "This rule monitors for inter-process communication via Unix sockets. Adversaries may attempt to communicate with local Unix sockets to enumerate application details, find vulnerabilities/configuration mistakes and potentially escalate privileges or set up malicious communication channels via Unix sockets for inter-process communication to attempt to evade detection.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 3,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame",
          "Data Source: Auditd Manager"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1559",
                "name": "Inter-Process Communication",
                "reference": "https://attack.mitre.org/techniques/T1559/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "auditd_manager",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "9368532b-2ff5-4666-9c21-4b926e1d35da",
        "rule_id": "41284ba3-ed1a-4598-bfba-a97f75d9aba2",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:11.661Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:46.419Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\", \"executed\", \"process_started\")\n and (\n  (process.name in (\"nc\", \"ncat\", \"netcat\", \"nc.openbsd\") and \n   process.args == \"-U\" and process.args : (\"/usr/local/*\", \"/run/*\", \"/var/run/*\")) or\n  (process.name == \"socat\" and \n   process.args == \"-\" and process.args : (\"UNIX-CLIENT:/usr/local/*\", \"UNIX-CLIENT:/run/*\", \"UNIX-CLIENT:/var/run/*\"))\n) and\nnot process.args == \"/var/run/libvirt/libvirt-sock\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*",
          "auditbeat-*",
          "logs-auditd_manager.auditd-*"
        ],
        "filters": []
      },
      {
        "name": "First Occurrence of User-Agent For a GitHub User",
        "description": "Detects a new user agent used for a GitHub user not previously seen in the last 14 days.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 204,
        "tags": [
          "Domain: Cloud",
          "Use Case: Threat Detection",
          "Use Case: UEBA",
          "Tactic: Initial Access",
          "Rule Type: BBR",
          "Data Source: Github"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1078",
                "name": "Valid Accounts",
                "reference": "https://attack.mitre.org/techniques/T1078/",
                "subtechnique": [
                  {
                    "id": "T1078.004",
                    "name": "Cloud Accounts",
                    "reference": "https://attack.mitre.org/techniques/T1078/004/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "github",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "github.user_agent",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "user.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "350686da-f593-4c62-80bf-1d18274d4bec",
        "rule_id": "41761cd3-380f-4d4d-89f3-46d6853ee35d",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:11.663Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:46.425Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "event.dataset:\"github.audit\" and event.category:\"configuration\" and\ngithub.user_agent:* and user.name:*",
        "new_terms_fields": [
          "user.name",
          "github.user_agent"
        ],
        "history_window_start": "now-14d",
        "index": [
          "logs-github.audit-*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Process Discovery Using Built-in Tools",
        "description": "This rule identifies the execution of commands that can be used to enumerate running processes. Adversaries may enumerate processes to identify installed applications and security solutions.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 106,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Rule Type: BBR",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1057",
                "name": "Process Discovery",
                "reference": "https://attack.mitre.org/techniques/T1057/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "a17204b2-09b7-4291-b6b8-5a227896a4bd",
        "rule_id": "4982ac3e-d0ee-4818-b95d-d9522d689259",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:11.666Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:48.377Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (\n    process.name :(\"PsList.exe\", \"qprocess.exe\") or \n   (process.name : \"powershell.exe\" and process.args : (\"*get-process*\", \"*Win32_Process*\")) or \n   (process.name : \"wmic.exe\" and process.args : (\"process\", \"*Win32_Process*\")) or\n   (process.name : \"tasklist.exe\" and not process.args : (\"pid eq*\")) or\n   (process.name : \"query.exe\" and process.args : \"process\")\n  ) and not user.id : \"S-1-5-18\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "logs-system.security*",
          "winlogbeat-*",
          "logs-windows.*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "Hidden Files and Directories via Hidden Flag",
        "description": "Identify activity related where adversaries can add the 'hidden' flag to files to hide them from the user in an attempt to evade detection.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 3,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "OS: macOS",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame",
          "Data Source: Auditd Manager"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1564",
                "name": "Hide Artifacts",
                "reference": "https://attack.mitre.org/techniques/T1564/",
                "subtechnique": [
                  {
                    "id": "T1564.001",
                    "name": "Hidden Files and Directories",
                    "reference": "https://attack.mitre.org/techniques/T1564/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "auditd_manager",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "dabea1c7-40a6-4c7a-a253-44cd60291d70",
        "rule_id": "5124e65f-df97-4471-8dcb-8e3953b3ea97",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:11.672Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:48.451Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"linux\" and event.type == \"creation\" and process.name == \"chflags\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*",
          "auditbeat-*",
          "logs-auditd_manager.auditd-*"
        ],
        "filters": []
      },
      {
        "name": "Kernel Load or Unload via Kexec Detected",
        "description": "This detection rule identifies the usage of kexec, helping to uncover unauthorized kernel replacements and potential compromise of the system's integrity. Kexec is a Linux feature that enables the loading and execution of a different kernel without going through the typical boot process. Malicious actors can abuse kexec to bypass security measures, escalate privileges, establish persistence or hide their activities by loading a malicious kernel, enabling them to tamper with the system's trusted state, allowing e.g. a VM Escape.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 7,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Tactic: Privilege Escalation",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame",
          "Data Source: Auditd Manager"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.crowdstrike.com/blog/venom-vulnerability-details/",
          "https://www.makeuseof.com/what-is-venom-vulnerability/",
          "https://madaidans-insecurities.github.io/guides/linux-hardening.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1611",
                "name": "Escape to Host",
                "reference": "https://attack.mitre.org/techniques/T1611/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1547",
                "name": "Boot or Logon Autostart Execution",
                "reference": "https://attack.mitre.org/techniques/T1547/",
                "subtechnique": [
                  {
                    "id": "T1547.006",
                    "name": "Kernel Modules and Extensions",
                    "reference": "https://attack.mitre.org/techniques/T1547/006/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1601",
                "name": "Modify System Image",
                "reference": "https://attack.mitre.org/techniques/T1601/",
                "subtechnique": [
                  {
                    "id": "T1601.001",
                    "name": "Patch System Image",
                    "reference": "https://attack.mitre.org/techniques/T1601/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "auditd_manager",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "53636324-9bab-44da-9fc8-951ff131cc55",
        "rule_id": "4d4c35f4-414e-4d0c-bb7e-6db7c80a6957",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:11.670Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:48.415Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\", \"executed\", \"process_started\")\n and process.name == \"kexec\" and process.args in (\"--exec\", \"-e\", \"--load\", \"-l\", \"--unload\", \"-u\") and not\n process.parent.name in (\"kdumpctl\", \"unload.sh\")",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*",
          "auditbeat-*",
          "logs-auditd_manager.auditd-*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious Network Activity to the Internet by Previously Unknown Executable",
        "description": "This rule monitors for network connectivity to the internet from a previously unknown executable located in a suspicious directory. An alert from this rule can indicate the presence of potentially malicious activity, such as the execution of unauthorized or suspicious processes attempting to establish connections to unknown or suspicious destinations such as a command and control server. Detecting and investigating such behavior can help identify and mitigate potential security threats, protecting the system and its data from potential compromise.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Suspicious Network Activity to the Internet by Previously Unknown Executable\n\nAfter being installed, malware will often call out to its command and control server to receive further instructions by its operators.\n\nThis rule leverages the new terms rule type to detect previously unknown processes, initiating network connections to external IP-addresses. \n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n> This investigation guide uses [placeholder fields](https://www.elastic.co/guide/en/security/current/osquery-placeholder-fields.html) to dynamically pass alert data into Osquery queries. Placeholder fields were introduced in Elastic Stack version 8.7.0. If you're using Elastic Stack version 8.6.0 or earlier, you'll need to manually adjust this investigation guide's queries to ensure they properly run.\n\n#### Possible investigation steps\n\n- Identify any signs of suspicious network activity or anomalies that may indicate malicious behavior. This could include unexpected traffic patterns or unusual network behavior.\n  - Investigate listening ports and open sockets to look for potential malicious processes, reverse shells or data exfiltration.\n    - !{osquery{\"label\":\"Osquery - Retrieve Listening Ports\",\"query\":\"SELECT pid, address, port, socket, protocol, path FROM listening_ports\"}}\n    - !{osquery{\"label\":\"Osquery - Retrieve Open Sockets\",\"query\":\"SELECT pid, family, remote_address, remote_port, socket, state FROM process_open_sockets\"}}\n- Identify the user account that performed the action, analyze it, and check whether it should perform this kind of action.\n  - !{osquery{\"label\":\"Osquery - Retrieve Information for a Specific User\",\"query\":\"SELECT * FROM users WHERE username = {{user.name}}\"}}\n- Investigate whether the user is currently logged in and active.\n  - !{osquery{\"label\":\"Osquery - Investigate the Account Authentication Status\",\"query\":\"SELECT * FROM logged_in_users WHERE user = {{user.name}}\"}}\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence and whether they are located in expected locations.\n  - !{osquery{\"label\":\"Osquery - Retrieve Running Processes by User\",\"query\":\"SELECT pid, username, name FROM processes p JOIN users u ON u.uid = p.uid ORDER BY username\"}}\n  - !{osquery{\"label\":\"Osquery - Retrieve Process Info\",\"query\":\"SELECT name, cmdline, parent, path, uid FROM processes\"}}\n- Investigate other alerts associated with the user/host during the past 48 hours.\n  - If scripts or executables were dropped, retrieve the files and determine if they are malicious:\n    - Use a private sandboxed malware analysis system to perform analysis.\n      - Observe and collect information about the following activities:\n        - Attempts to contact external domains and addresses.\n          - Check if the domain is newly registered or unexpected.\n          - Check the reputation of the domain or IP address.\n        - File access, modification, and creation activities.\n\n### Related rules\n\n- Network Activity Detected via cat - afd04601-12fc-4149-9b78-9c3f8fe45d39\n\n### False positive analysis\n\n- If this activity is related to new benign software installation activity, consider adding exceptions â€” preferably with a combination of user and command line conditions.\n- Try to understand the context of the execution by thinking about the user, machine, or business purpose. A small number of endpoints, such as servers with unique software, might appear unusual but satisfy a specific business need.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors, such as reverse shells, reverse proxies, or droppers, that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Leverage the incident response data and logging to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 11,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Command and Control",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-3540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            },
            "technique": [
              {
                "id": "T1071",
                "name": "Application Layer Protocol",
                "reference": "https://attack.mitre.org/techniques/T1071/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from one of the following integrations:\n- Elastic Defend\n- Auditbeat\n- Filebeat\n- Packetbeat\n\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows\nthe Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest to select \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n### Auditbeat Setup\nAuditbeat is a lightweight shipper that you can install on your servers to audit the activities of users and processes on your systems. For example, you can use Auditbeat to collect and centralize audit events from the Linux Audit Framework. You can also use Auditbeat to detect changes to critical files, like binaries and configuration files, and identify potential security policy violations.\n\n#### The following steps should be executed in order to add the Auditbeat on a Linux System:\n- Elastic provides repositories available for APT and YUM-based distributions. Note that we provide binary packages, but no source packages.\n- To install the APT and YUM repositories follow the setup instructions in this [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/setup-repositories.html).\n- To run Auditbeat on Docker follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/running-on-docker.html).\n- To run Auditbeat on Kubernetes follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/running-on-kubernetes.html).\n- For complete â€œSetup and Run Auditbeatâ€ information refer to the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/setting-up-and-running.html).\n\n### Filebeat Setup\nFilebeat is a lightweight shipper for forwarding and centralizing log data. Installed as an agent on your servers, Filebeat monitors the log files or locations that you specify, collects log events, and forwards them either to Elasticsearch or Logstash for indexing.\n\n#### The following steps should be executed in order to add the Filebeat on a Linux System:\n- Elastic provides repositories available for APT and YUM-based distributions. Note that we provide binary packages, but no source packages.\n- To install the APT and YUM repositories follow the setup instructions in this [helper guide](https://www.elastic.co/guide/en/beats/filebeat/current/setup-repositories.html).\n- To run Filebeat on Docker follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/filebeat/current/running-on-docker.html).\n- To run Filebeat on Kubernetes follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/filebeat/current/running-on-kubernetes.html).\n- For quick start information for Filebeat refer to the [helper guide](https://www.elastic.co/guide/en/beats/filebeat/8.11/filebeat-installation-configuration.html).\n- For complete â€œSetup and Run Filebeatâ€ information refer to the [helper guide](https://www.elastic.co/guide/en/beats/filebeat/current/setting-up-and-running.html).\n\n### Packetbeat Setup\nPacketbeat is a real-time network packet analyzer that you can use for application monitoring, performance analytics, and threat detection. Packetbeat works by capturing the network traffic between your application servers, decoding the application layer protocols (HTTP, MySQL, Redis, and so on), correlating the requests with the responses, and recording the interesting fields for each transaction.\n\n#### The following steps should be executed in order to add the Packetbeat on a  Linux System:\n- Elastic provides repositories available for APT and YUM-based distributions. Note that we provide binary packages, but no source packages.\n- To install the APT and YUM repositories follow the setup instructions in this [helper guide](https://www.elastic.co/guide/en/beats/packetbeat/current/setup-repositories.html).\n- To run Packetbeat on Docker follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/packetbeat/current/running-on-docker.html).\n- For quick start information for Packetbeat refer to the [helper guide](https://www.elastic.co/guide/en/beats/packetbeat/current/packetbeat-installation-configuration.html).\n- For complete â€œSetup and Run Packetbeatâ€ information refer to the [helper guide](https://www.elastic.co/guide/en/beats/packetbeat/current/setting-up-and-running.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "source.ip",
            "type": "ip",
            "ecs": true
          }
        ],
        "id": "072f6fcb-3b99-41d6-abe0-21160844fdd7",
        "rule_id": "53617418-17b4-4e9c-8a2c-8deb8086ca4b",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:11.675Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:48.511Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "host.os.type:linux and event.category:network and event.action:(connection_attempted or ipv4_connection_attempt_event) and\nprocess.executable : (\n  /etc/crontab or /etc/rc.local or ./* or /boot/* or /dev/shm/* or /etc/cron.*/* or /etc/init.d/* or /etc/rc*.d/* or\n  /etc/update-motd.d/* or /home/*/.* or /tmp/* or /usr/lib/update-notifier/* or /var/log/* or /var/tmp/*\n) and process.name : * and\nnot (\n  process.executable : (\n    /tmp/newroot/* or /tmp/snap.rootfs* or /etc/cron.hourly/BitdefenderRedline or /tmp/go-build* or /srv/snp/docker/* or\n    /run/containerd/* or /tmp/.mount* or /run/k3s/containerd/* or /tmp/selenium* or /tmp/tmp.*/juliainstaller or\n    /tmp/.criu.mntns* or /home/*/.local/share/containers/* or /etc/update-motd.d/*\n  ) or\n  source.ip:(10.0.0.0/8 or 127.0.0.0/8 or 172.16.0.0/12 or 192.168.0.0/16) or\n  process.name : (\n    apt or chrome or curl or dnf or dockerd or dpkg or firefox-bin or git-remote-https or java or kite-update or\n    kited or node or rpm or saml2aws or selenium-manager or solana-validator or wget or yum or ansible* or aws* or\n    php* or pip* or python* or steam* or terraform*\n  ) or\n  destination.ip:(\n    0.0.0.0 or 10.0.0.0/8 or 100.64.0.0/10 or 127.0.0.0/8 or 169.254.0.0/16 or 172.16.0.0/12 or 192.0.0.0/24 or\n    192.0.0.0/29 or 192.0.0.10/32 or 192.0.0.170/32 or 192.0.0.171/32 or 192.0.0.8/32 or 192.0.0.9/32 or 192.0.2.0/24 or\n    192.168.0.0/16 or 192.175.48.0/24 or 192.31.196.0/24 or 192.52.193.0/24 or 192.88.99.0/24 or 198.18.0.0/15 or\n    198.51.100.0/24 or 203.0.113.0/24 or 224.0.0.0/4 or 240.0.0.0/4 or \"::1\" or \"FE80::/10\" or \"FF00::/8\"\n  )\n)",
        "new_terms_fields": [
          "process.executable"
        ],
        "history_window_start": "now-20d",
        "index": [
          "auditbeat-*",
          "filebeat-*",
          "packetbeat-*",
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Elastic Agent Service Terminated",
        "description": "Identifies the Elastic endpoint agent has stopped and is no longer running on the host. Adversaries may attempt to disable security monitoring tools in an attempt to evade detection or prevention capabilities during an intrusion. This may also indicate an issue with the agent itself and should be addressed to ensure defensive measures are back in a stable state.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 107,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "OS: Windows",
          "OS: macOS",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.001",
                    "name": "Disable or Modify Tools",
                    "reference": "https://attack.mitre.org/techniques/T1562/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "e0299a2c-64d4-4e1e-97a6-1dd79286869d",
        "rule_id": "b627cd12-dac4-11ec-9582-f661ea17fbcd",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:11.680Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:17:02.744Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where\n/* net, sc or wmic stopping or deleting Elastic Agent on Windows */\n(event.type == \"start\" and\n  process.name : (\"net.exe\", \"sc.exe\", \"wmic.exe\",\"powershell.exe\",\"taskkill.exe\",\"PsKill.exe\",\"ProcessHacker.exe\") and\n  process.args : (\"stopservice\",\"uninstall\", \"stop\", \"disabled\",\"Stop-Process\",\"terminate\",\"suspend\") and\n  process.args : (\"elasticendpoint\", \"Elastic Agent\",\"elastic-agent\",\"elastic-endpoint\"))\nor\n/* service or systemctl used to stop Elastic Agent on Linux */\n(event.type == \"end\" and\n  (process.name : (\"systemctl\", \"service\") and\n    process.args : \"elastic-agent\" and\n    process.args : (\"stop\", \"disable\"))\n  or\n  /* pkill , killall used to stop Elastic Agent on Linux */\n  ( event.type == \"end\" and process.name : (\"pkill\", \"killall\") and process.args: \"elastic-agent\")\n  or\n  /* Unload Elastic Agent extension on MacOS */\n  (process.name : \"kextunload\" and\n    process.args : \"com.apple.iokit.EndpointSecurity\" and\n    event.action : \"end\"))",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "At.exe Command Lateral Movement",
        "description": "Identifies use of at.exe to interact with the task scheduler on remote hosts. Remote task creations, modifications or execution could be indicative of adversary lateral movement.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 105,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Lateral Movement",
          "Data Source: Elastic Defend",
          "Rule Type: BBR",
          "Data Source: Elastic Endgame",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1021",
                "name": "Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1021/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1053",
                "name": "Scheduled Task/Job",
                "reference": "https://attack.mitre.org/techniques/T1053/",
                "subtechnique": [
                  {
                    "id": "T1053.002",
                    "name": "At",
                    "reference": "https://attack.mitre.org/techniques/T1053/002/"
                  },
                  {
                    "id": "T1053.005",
                    "name": "Scheduled Task",
                    "reference": "https://attack.mitre.org/techniques/T1053/005/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "dd115a8a-0afb-4cb0-91b7-b3c46be8d747",
        "rule_id": "b483365c-98a8-40c0-92d8-0458ca25058a",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:11.678Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:17:00.962Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and process.name : \"at.exe\" and process.args : \"\\\\\\\\*\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "winlogbeat-*",
          "logs-windows.*",
          "endgame-*",
          "logs-system.security*"
        ],
        "filters": []
      },
      {
        "name": "Chkconfig Service Add",
        "description": "Detects the use of the chkconfig binary to manually add a service for management by chkconfig. Threat actors may utilize this technique to maintain persistence on a system. When a new service is added, chkconfig ensures that the service has either a start or a kill entry in every runlevel and when the system is rebooted the service file added will run providing long-term persistence.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Chkconfig Service Add\nService files are configuration files in Linux systems used to define and manage system services. The `Chkconfig` binary can be used to manually add, delete or modify a service. \n\nMalicious actors can leverage services to achieve persistence by creating or modifying service files to execute malicious commands or payloads during system startup. This allows them to maintain unauthorized access, execute additional malicious activities, or evade detection.\n\nThis rule monitors the usage of the `chkconfig` binary to manually add a service for management by `chkconfig`, potentially indicating the creation of a persistence mechanism.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n> This investigation guide uses [placeholder fields](https://www.elastic.co/guide/en/security/current/osquery-placeholder-fields.html) to dynamically pass alert data into Osquery queries. Placeholder fields were introduced in Elastic Stack version 8.7.0. If you're using Elastic Stack version 8.6.0 or earlier, you'll need to manually adjust this investigation guide's queries to ensure they properly run.\n\n#### Possible Investigation Steps\n\n- Investigate the service that was created or modified.\n- Investigate the currently enabled system services through the following commands `sudo chkconfig --list | grep on` and `sudo systemctl list-unit-files`.\n- Investigate the status of potentially suspicious services through the `chkconfig --list service_name` command. \n- Search for the `rc.d` or `init.d` service files that were created or modified, and analyze their contents.\n- Investigate whether any other files in any of the available `rc.d` or `init.d` directories have been altered through OSQuery.\n  - !{osquery{\"label\":\"Osquery - Retrieve File Listing Information\",\"query\":\"SELECT * FROM file WHERE (path LIKE '/etc/init.d/%' OR path LIKE '/etc/rc%.d/%')\"}}\n  - !{osquery{\"label\":\"Osquery - Retrieve Additional File Listing Information\",\"query\":\"SELECT f.path, u.username AS file_owner, g.groupname AS group_owner, datetime(f.atime, 'unixepoch') AS\\nfile_last_access_time, datetime(f.mtime, 'unixepoch') AS file_last_modified_time, datetime(f.ctime, 'unixepoch') AS\\nfile_last_status_change_time, datetime(f.btime, 'unixepoch') AS file_created_time, f.size AS size_bytes FROM file f LEFT\\nJOIN users u ON f.uid = u.uid LEFT JOIN groups g ON f.gid = g.gid WHERE (path LIKE '/etc/init.d/%' OR path LIKE\\n'/etc/rc%.d/%')\\n\"}}\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence and whether they are located in expected locations.\n  - !{osquery{\"label\":\"Osquery - Retrieve Running Processes by User\",\"query\":\"SELECT pid, username, name FROM processes p JOIN users u ON u.uid = p.uid ORDER BY username\"}}\n- Investigate syslog through the `sudo cat /var/log/syslog | grep 'LSB'` command to find traces of the LSB header of the script (if present). If syslog is being ingested into Elasticsearch, the same can be accomplished through Kibana.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Validate the activity is not related to planned patches, updates, network administrator activity, or legitimate software installations.\n- Investigate whether the altered scripts call other malicious scripts elsewhere on the file system. \n  - If scripts or executables were dropped, retrieve the files and determine if they are malicious:\n    - Use a private sandboxed malware analysis system to perform analysis.\n      - Observe and collect information about the following activities:\n        - Attempts to contact external domains and addresses.\n          - Check if the domain is newly registered or unexpected.\n          - Check the reputation of the domain or IP address.\n        - File access, modification, and creation activities.\n        - Cron jobs, services and other persistence mechanisms.\n            - !{osquery{\"label\":\"Osquery - Retrieve Crontab Information\",\"query\":\"SELECT * FROM crontab\"}}\n- Investigate abnormal behaviors by the subject process/user such as network connections, file modifications, and any other spawned child processes.\n  - Investigate listening ports and open sockets to look for potential command and control traffic or data exfiltration.\n    - !{osquery{\"label\":\"Osquery - Retrieve Listening Ports\",\"query\":\"SELECT pid, address, port, socket, protocol, path FROM listening_ports\"}}\n    - !{osquery{\"label\":\"Osquery - Retrieve Open Sockets\",\"query\":\"SELECT pid, family, remote_address, remote_port, socket, state FROM process_open_sockets\"}}\n  - Identify the user account that performed the action, analyze it, and check whether it should perform this kind of action.\n    - !{osquery{\"label\":\"Osquery - Retrieve Information for a Specific User\",\"query\":\"SELECT * FROM users WHERE username = {{user.name}}\"}}\n- Investigate whether the user is currently logged in and active.\n    - !{osquery{\"label\":\"Osquery - Investigate the Account Authentication Status\",\"query\":\"SELECT * FROM logged_in_users WHERE user = {{user.name}}\"}}\n\n### False Positive Analysis\n\n- If this activity is related to new benign software installation activity, consider adding exceptions â€” preferably with a combination of user and command line conditions.\n- If this activity is related to a system administrator who uses the `chkconfig` binary for administrative purposes, consider adding exceptions for this specific administrator user account. \n- Try to understand the context of the execution by thinking about the user, machine, or business purpose. A small number of endpoints, such as servers with unique software, might appear unusual but satisfy a specific business need.\n\n### Related Rules\n\n- Suspicious File Creation in /etc for Persistence - 1c84dd64-7e6c-4bad-ac73-a5014ee37042\n- Potential Persistence Through Run Control Detected - 0f4d35e4-925e-4959-ab24-911be207ee6f\n- Potential Persistence Through init.d Detected - 474fd20e-14cc-49c5-8160-d9ab4ba16c8b\n- New Systemd Timer Created - 7fb500fa-8e24-4bd1-9480-2a819352602c\n- New Systemd Service Created by Previously Unknown Process - 17b0a495-4d9f-414c-8ad0-92f018b8e001\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Delete the service/timer or restore its original configuration.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Leverage the incident response data and logging to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 113,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Threat: Lightning Framework",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.intezer.com/blog/research/lightning-framework-new-linux-threat/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1037",
                "name": "Boot or Logon Initialization Scripts",
                "reference": "https://attack.mitre.org/techniques/T1037/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "206284c2-ae24-4f9f-8cfc-ab76160f975d",
        "rule_id": "b910f25a-2d44-47f2-a873-aabdc0d355e6",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:11.683Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:17:02.798Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.action in (\"exec\", \"exec_event\") and\n( \n  (process.executable : \"/usr/sbin/chkconfig\" and process.args : \"--add\") or\n  (process.args : \"*chkconfig\" and process.args : \"--add\")\n) and not (\n  process.parent.name in (\"rpm\", \"qualys-scan-util\", \"qualys-cloud-agent\", \"update-alternatives\") or\n  process.parent.args : (\"/var/tmp/rpm*\", \"/var/lib/waagent/*\") or\n  process.args in (\"jexec\", \"sapinit\", \"httpd\", \"dbora\")\n)",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "Creation of Hidden Files and Directories via CommandLine",
        "description": "Users can mark specific files as hidden simply by putting a \".\" as the first character in the file or folder name. Adversaries can use this to their advantage to hide files and folders on the system for persistence and defense evasion. This rule looks for hidden files or folders in common writable directories.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 111,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Certain tools may create hidden temporary files or directories upon installation or as part of their normal behavior. These events can be filtered by the process arguments, username, or process name values."
        ],
        "references": [],
        "max_signals": 33,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1564",
                "name": "Hide Artifacts",
                "reference": "https://attack.mitre.org/techniques/T1564/",
                "subtechnique": [
                  {
                    "id": "T1564.001",
                    "name": "Hidden Files and Directories",
                    "reference": "https://attack.mitre.org/techniques/T1564/001/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            }
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from one of the following integrations:\n- Elastic Defend\n- Auditbeat\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n### Auditbeat Setup\nAuditbeat is a lightweight shipper that you can install on your servers to audit the activities of users and processes on your systems. For example, you can use Auditbeat to collect and centralize audit events from the Linux Audit Framework. You can also use Auditbeat to detect changes to critical files, like binaries and configuration files, and identify potential security policy violations.\n\n#### The following steps should be executed in order to add the Auditbeat on a Linux System:\n- Elastic provides repositories available for APT and YUM-based distributions. Note that we provide binary packages, but no source packages.\n- To install the APT and YUM repositories follow the setup instructions in this [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/setup-repositories.html).\n- To run Auditbeat on Docker follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/running-on-docker.html).\n- To run Auditbeat on Kubernetes follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/running-on-kubernetes.html).\n- For complete â€œSetup and Run Auditbeatâ€ information refer to the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/setting-up-and-running.html).\n\n#### Custom Ingest Pipeline\nFor versions <8.2, you need to add a custom ingest pipeline to populate `event.ingested` with @timestamp for non-elastic-agent indexes, like auditbeats/filebeat/winlogbeat etc. For more details to add a custom ingest pipeline refer to the [guide](https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.working_directory",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "b1949e58-8007-4f6b-91fe-ffe6b441c140",
        "rule_id": "b9666521-4742-49ce-9ddc-b8e84c35acae",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:11.690Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:17:02.814Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\nprocess.working_directory in (\"/tmp\", \"/var/tmp\", \"/dev/shm\") and\nprocess.args regex~ \"\"\"\\.[a-z0-9_\\-][a-z0-9_\\-\\.]{1,254}\"\"\" and\nnot process.name in (\n  \"ls\", \"find\", \"grep\", \"git\", \"jq\", \"basename\", \"check_snmp\", \"snmpget\", \"snmpwalk\", \"cc1plus\", \"snap\",\n  \"command-not-found\"\n)",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Linux Clipboard Activity Detected",
        "description": "This rule monitors for the usage of the most common clipboard utilities on unix systems by an uncommon process group leader. Adversaries may collect data stored in the clipboard from users copying information within or between applications.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 5,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Collection",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame",
          "Data Source: Auditd Manager"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0009",
              "name": "Collection",
              "reference": "https://attack.mitre.org/tactics/TA0009/"
            },
            "technique": [
              {
                "id": "T1115",
                "name": "Clipboard Data",
                "reference": "https://attack.mitre.org/techniques/T1115/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "auditd_manager",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "0b9e0751-6b3d-48e4-b9a3-1a8127456126",
        "rule_id": "884e87cc-c67b-4c90-a4ed-e1e24a940c82",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:14.449Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:56.544Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "event.category:process and host.os.type:\"linux\" and event.type:\"start\" and\nevent.action:(\"exec\" or \"exec_event\" or \"executed\" or \"process_started\") and\nprocess.name:(\"xclip\" or \"xsel\" or \"wl-clipboard\" or \"clipman\" or \"copyq\") and\nnot process.parent.name:(\"bwrap\" or \"micro\")",
        "new_terms_fields": [
          "host.id",
          "process.group_leader.executable"
        ],
        "history_window_start": "now-7d",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*",
          "auditbeat-*",
          "logs-auditd_manager.auditd-*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Security Software Discovery via Grep",
        "description": "Identifies the use of the grep command to discover known third-party macOS and Linux security tools, such as Antivirus or Host Firewall details.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Security Software Discovery via Grep\n\nAfter successfully compromising an environment, attackers may try to gain situational awareness to plan their next steps. This can happen by running commands to enumerate network resources, users, connections, files, and installed security software.\n\nThis rule looks for the execution of the `grep` utility with arguments compatible to the enumeration of the security software installed on the host. Attackers can use this information to decide whether or not to infect a system, disable protections, use bypasses, etc.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence and whether they are located in expected locations.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate any abnormal account behavior, such as command executions, file creations or modifications, and network connections.\n- Investigate any abnormal behavior by the subject process such as network connections, file modifications, and any spawned child processes.\n- Inspect the host for suspicious or abnormal behavior in the alert timeframe.\n- Validate the activity is not related to planned patches, updates, network administrator activity, or legitimate software installations.\n\n### False positive analysis\n\n- Discovery activities are not inherently malicious if they occur in isolation. As long as the analyst did not identify suspicious activity related to the user or host, such alerts can be dismissed.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection via the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 110,
        "tags": [
          "Domain: Endpoint",
          "OS: macOS",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Endpoint Security installers, updaters and post installation verification scripts."
        ],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1518",
                "name": "Software Discovery",
                "reference": "https://attack.mitre.org/techniques/T1518/",
                "subtechnique": [
                  {
                    "id": "T1518.001",
                    "name": "Security Software Discovery",
                    "reference": "https://attack.mitre.org/techniques/T1518/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "5082baac-2234-44e5-9b0c-81c3038df44e",
        "rule_id": "870aecc0-cea4-4110-af3f-e02e9b373655",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:14.452Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:56.529Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where event.type == \"start\" and\nprocess.name : \"grep\" and user.id != \"0\" and\n not process.parent.executable : (\"/Library/Application Support/*\", \"/opt/McAfee/agent/scripts/ma\") and\n   process.args :\n         (\"Little Snitch*\",\n          \"Avast*\",\n          \"Avira*\",\n          \"ESET*\",\n          \"BlockBlock*\",\n          \"360Sec*\",\n          \"LuLu*\",\n          \"KnockKnock*\",\n          \"kav\",\n          \"KIS\",\n          \"RTProtectionDaemon*\",\n          \"Malware*\",\n          \"VShieldScanner*\",\n          \"WebProtection*\",\n          \"webinspectord*\",\n          \"McAfee*\",\n          \"isecespd*\",\n          \"macmnsvc*\",\n          \"masvc*\",\n          \"kesl*\",\n          \"avscan*\",\n          \"guard*\",\n          \"rtvscand*\",\n          \"symcfgd*\",\n          \"scmdaemon*\",\n          \"symantec*\",\n          \"sophos*\",\n          \"osquery*\",\n          \"elastic-endpoint*\"\n          ) and\n   not (\n     (process.args : \"Avast\" and process.args : \"Passwords\") or\n     (process.args == \"osquery.conf\") or \n     (process.parent.args : \"/opt/McAfee/agent/scripts/ma\" and process.parent.args : \"checkhealth\") or\n     (process.command_line : (\n       \"grep ESET Command-line scanner, version %s -A2\",\n       \"grep -i McAfee Web Gateway Core version:\",\n       \"grep --color=auto ESET Command-line scanner, version %s -A2\"\n       )\n     ) or\n     (process.parent.command_line : (\n       \"\"\"sh -c printf \"command_start_%s\"*; perl -pe 's/[^ -~]/\\n/g' < /opt/eset/esets/sbin/esets_scan | grep 'ESET Command-line scanner, version %s' -A2 | tail -1; printf \"command_done_%s*\"\"\",\n       \"\"\"bash -c perl -pe 's/[^ -~]/\\n/g' < /opt/eset/esets/sbin/esets_scan | grep 'ESET Command-line scanner, version %s' -A2 | tail -1\"\"\"\n       )\n     )\n    )",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "auditbeat-*"
        ],
        "filters": []
      },
      {
        "name": "Potential Linux Local Account Brute Force Detected",
        "description": "Identifies multiple consecutive login attempts executed by one process targeting a local linux user account within a short time interval. Adversaries might brute force login attempts across different users with a default wordlist or a set of customly crafted passwords in an attempt to gain access to these accounts.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 7,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1110",
                "name": "Brute Force",
                "reference": "https://attack.mitre.org/techniques/T1110/",
                "subtechnique": [
                  {
                    "id": "T1110.001",
                    "name": "Password Guessing",
                    "reference": "https://attack.mitre.org/techniques/T1110/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "0a4cd09a-e61c-4fa0-965d-d0138c5ad0dc",
        "rule_id": "835c0622-114e-40b5-a346-f843ea5d01f1",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:14.455Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:54.673Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by host.id, process.parent.executable, user.id with maxspan=1s\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and process.name == \"su\" and \n   not process.parent.name in (\n     \"bash\", \"dash\", \"ash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\", \"clickhouse-server\", \"ma\", \"gitlab-runner\",\n     \"updatedb.findutils\", \"cron\", \"perl\", \"sudo\", \"java\", \"cloud-app-identify\", \"ambari-sudo.sh\"\n   )\n  ] with runs=10",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious Troubleshooting Pack Cabinet Execution",
        "description": "Identifies the execution of the Microsoft Diagnostic Wizard to open a diagcab file from a suspicious path and with an unusual parent process. This may indicate an attempt to execute malicious Troubleshooting Pack Cabinet files.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 104,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Rule Type: BBR",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://irsl.medium.com/the-trouble-with-microsofts-troubleshooters-6e32fc80b8bd"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1218",
                "name": "System Binary Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1218/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "4cf478b5-9382-4b4b-b2be-53d54aeae10c",
        "rule_id": "808291d3-e918-4a3a-86cd-73052a0c9bdc",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:14.458Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:54.649Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.action == \"start\" and\n  (process.name : \"msdt.exe\" or ?process.pe.original_file_name == \"msdt.exe\") and process.args : \"/cab\" and\n  process.parent.name : (\n    \"firefox.exe\", \"chrome.exe\", \"msedge.exe\", \"explorer.exe\", \"brave.exe\", \"whale.exe\", \"browser.exe\",\n    \"dragon.exe\", \"vivaldi.exe\", \"opera.exe\", \"iexplore\", \"firefox.exe\", \"waterfox.exe\", \"iexplore.exe\",\n    \"winrar.exe\", \"winrar.exe\", \"7zFM.exe\", \"outlook.exe\", \"winword.exe\", \"excel.exe\"\n  ) and\n  process.args : (\n    \"?:\\\\Users\\\\*\",\n    \"\\\\\\\\*\",\n    \"http*\",\n    \"ftp://*\"\n  )",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "logs-system.security*",
          "winlogbeat-*",
          "logs-windows.*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "Service Path Modification via sc.exe",
        "description": "Identifies attempts to modify a service path setting using sc.exe. Attackers may attempt to modify existing services for persistence or privilege escalation.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 106,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Rule Type: BBR",
          "Data Source: Sysmon",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1112",
                "name": "Modify Registry",
                "reference": "https://attack.mitre.org/techniques/T1112/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1543",
                "name": "Create or Modify System Process",
                "reference": "https://attack.mitre.org/techniques/T1543/",
                "subtechnique": [
                  {
                    "id": "T1543.003",
                    "name": "Windows Service",
                    "reference": "https://attack.mitre.org/techniques/T1543/003/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1543",
                "name": "Create or Modify System Process",
                "reference": "https://attack.mitre.org/techniques/T1543/",
                "subtechnique": [
                  {
                    "id": "T1543.003",
                    "name": "Windows Service",
                    "reference": "https://attack.mitre.org/techniques/T1543/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "5f7a974d-7b0e-4bef-8f99-48d48dfc0dd6",
        "rule_id": "c5677997-f75b-4cda-b830-a75920514096",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:14.461Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:17:03.050Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where event.type == \"start\" and process.name : \"sc.exe\" and\n  process.args : \"*config*\" and process.args : \"*binPath*\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "winlogbeat-*"
        ],
        "filters": []
      },
      {
        "name": "Attempted Private Key Access",
        "description": "Attackers may try to access private keys, e.g. ssh, in order to gain further authenticated access to the environment.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 106,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Data Source: Elastic Defend",
          "Rule Type: BBR",
          "Data Source: Sysmon",
          "Data Source: Elastic Endgame",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1552",
                "name": "Unsecured Credentials",
                "reference": "https://attack.mitre.org/techniques/T1552/",
                "subtechnique": [
                  {
                    "id": "T1552.004",
                    "name": "Private Keys",
                    "reference": "https://attack.mitre.org/techniques/T1552/004/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "1e49f485-4a62-4aa3-8bc8-4e2ce717a723",
        "rule_id": "c55badd3-3e61-4292-836f-56209dc8a601",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:14.464Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:17:03.045Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.args : (\"*.pem *\", \"*.pem\", \"*.id_rsa*\") and\n  not process.args: (\"--tls-cert\", \"--ssl-cert\") and\n  not process.executable : (\n    \"?:\\\\ProgramData\\\\Logishrd\\\\LogiOptions\\\\Software\\\\*\\\\LogiLuUpdater.exe\",\n    \"?:\\\\Program Files\\\\Elastic\\\\Agent\\\\data\\\\*\\\\osqueryd.exe\",\n    \"?:\\\\Program Files\\\\Guardicore\\\\gc-controller.exe\",\n    \"?:\\\\Program Files\\\\Guardicore\\\\gc-deception-agent.exe\",\n    \"?:\\\\Program Files\\\\Guardicore\\\\gc-detection-agent.exe\",\n    \"?:\\\\Program Files\\\\Guardicore\\\\gc-enforcement-agent.exe\",\n    \"?:\\\\Program Files\\\\Guardicore\\\\gc-guest-agent.exe\",\n    \"?:\\\\Program Files\\\\Logi\\\\LogiBolt\\\\LogiBoltUpdater.exe\",\n    \"?:\\\\Program Files (x86)\\\\Schneider Electric EcoStruxure\\\\Building Operation 5.0\\\\Device Administrator\\\\Python\\\\python.exe\",\n    \"?:\\\\Program Files\\\\Splunk\\\\bin\\\\openssl.exe\",\n    \"?:\\\\Program Files\\\\SplunkUniversalForwarder\\\\bin\\\\openssl.exe\",\n    \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Logi\\\\LogiBolt\\\\LogiBoltUpdater.exe\",\n    \"?:\\\\Windows\\\\system32\\\\icacls.exe\",\n    \"?:\\\\Windows\\\\System32\\\\OpenSSH\\\\*\"\n  )",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "winlogbeat-*"
        ],
        "filters": []
      },
      {
        "name": "Potential Pspy Process Monitoring Detected",
        "description": "This rule leverages auditd to monitor for processes scanning different processes within the /proc directory using the openat syscall. This is a strong indication for the usage of the pspy utility. Attackers may leverage the pspy process monitoring utility to monitor system processes without requiring root permissions, in order to find potential privilege escalation vectors.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 8,
        "tags": [
          "Data Source: Auditd Manager",
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Discovery"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/DominicBreuker/pspy"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1057",
                "name": "Process Discovery",
                "reference": "https://attack.mitre.org/techniques/T1057/"
              },
              {
                "id": "T1082",
                "name": "System Information Discovery",
                "reference": "https://attack.mitre.org/techniques/T1082/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Auditd Manager.\n\n### Auditd Manager Integration Setup\nThe Auditd Manager Integration receives audit events from the Linux Audit Framework which is a part of the Linux kernel.\nAuditd Manager provides a user-friendly interface and automation capabilities for configuring and monitoring system auditing through the auditd daemon. With `auditd_manager`, administrators can easily define audit rules, track system events, and generate comprehensive audit reports, improving overall security and compliance in the system.\n\n#### The following steps should be executed in order to add the Elastic Agent System integration \"auditd_manager\" on a Linux System:\n- Go to the Kibana home page and click â€œAdd integrationsâ€.\n- In the query bar, search for â€œAuditd Managerâ€ and select the integration to see more details about it.\n- Click â€œAdd Auditd Managerâ€.\n- Configure the integration name and optionally add a description.\n- Review optional and advanced settings accordingly.\n- Add the newly installed â€œauditd managerâ€ to an existing or a new agent policy, and deploy the agent on a Linux system from which auditd log files are desirable.\n- Click â€œSave and Continueâ€.\n- For more details on the integration refer to the [helper guide](https://docs.elastic.co/integrations/auditd_manager).\n\n#### Rule Specific Setup Note\nAuditd Manager subscribes to the kernel and receives events as they occur without any additional configuration.\nHowever, if more advanced configuration is required to detect specific behavior, audit rules can be added to the integration in either the \"audit rules\" configuration box or the \"auditd rule files\" box by specifying a file to read the audit rules from.\n- For this detection rule the following additional audit rules are required to be added to the integration:\n  -- \"-w /proc/ -p r -k audit_proc\"\n",
        "related_integrations": [
          {
            "package": "auditd_manager",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "auditd.data.a0",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "auditd.data.a2",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "auditd.data.syscall",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pid",
            "type": "long",
            "ecs": true
          }
        ],
        "id": "ef664cec-4fa9-4e6a-b623-8093d7f1cf13",
        "rule_id": "bdb04043-f0e3-4efa-bdee-7d9d13fa9edc",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:14.467Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:17:02.927Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by process.pid, host.id with maxspan=5s\n  [file where host.os.type == \"linux\" and auditd.data.syscall == \"openat\" and file.path == \"/proc\" and\n   auditd.data.a0 : (\"ffffffffffffff9c\", \"ffffff9c\") and auditd.data.a2 : (\"80000\", \"88000\") and\n   not process.name == \"agentbeat\"\n  ] with runs=10",
        "language": "eql",
        "index": [
          "logs-auditd_manager.auditd-*"
        ],
        "filters": []
      },
      {
        "name": "Potential Defense Evasion via CMSTP.exe",
        "description": "The Microsoft Connection Manager Profile Installer (CMSTP.exe) is a command-line program to install Connection Manager service profiles, which accept installation information file (INF) files. Adversaries may abuse CMSTP to proxy the execution of malicious code by supplying INF files that contain malicious commands.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 105,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend",
          "Rule Type: BBR",
          "Data Source: Sysmon",
          "Data Source: Elastic Endgame",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://attack.mitre.org/techniques/T1218/003/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1218",
                "name": "System Binary Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1218/",
                "subtechnique": [
                  {
                    "id": "T1218.003",
                    "name": "CMSTP",
                    "reference": "https://attack.mitre.org/techniques/T1218/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "03095ea9-0722-4dbd-851e-24a900af6fb8",
        "rule_id": "bd3d058d-5405-4cee-b890-337f09366ba2",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:14.470Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:17:02.922Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.name : \"cmstp.exe\" and process.args == \"/s\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "winlogbeat-*"
        ],
        "filters": []
      },
      {
        "name": "Potential Non-Standard Port SSH connection",
        "description": "Identifies potentially malicious processes communicating via a port paring typically not associated with SSH. For example, SSH over port 2200 or port 2222 as opposed to the traditional port 22. Adversaries may make changes to the standard port a protocol uses to bypass filtering or muddle analysis/parsing of network data.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 6,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Command and Control",
          "OS: macOS",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "SSH over ports apart from the traditional port 22 is highly uncommon. This rule alerts the usage of the such uncommon ports by the ssh service. Tuning is needed to have higher confidence. If this activity is expected and noisy in your environment, consider adding exceptions â€” preferably with a combination whitelisted ports for such legitimate ssh activities."
        ],
        "references": [
          "https://attack.mitre.org/techniques/T1571/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            },
            "technique": [
              {
                "id": "T1571",
                "name": "Non-Standard Port",
                "reference": "https://attack.mitre.org/techniques/T1571/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "destination.port",
            "type": "long",
            "ecs": true
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "network.transport",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "5edc16cb-bc8d-4b74-a1cc-a7c22c65cac4",
        "rule_id": "bc8ca7e0-92fd-4b7c-b11e-ee0266b8d9c9",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:14.473Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:17:02.901Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by process.entity_id with maxspan=1m\n  [process where event.action == \"exec\" and process.name in (\"ssh\", \"sshd\") and not process.parent.name in (\n   \"rsync\", \"pyznap\", \"git\", \"ansible-playbook\", \"scp\", \"pgbackrest\", \"git-lfs\", \"expect\", \"Sourcetree\", \"ssh-copy-id\",\n   \"run\"\n   )\n  ]\n  [network where process.name:\"ssh\" and event.action in (\"connection_attempted\", \"connection_accepted\") and \n   destination.port != 22 and network.transport == \"tcp\" and not (\n     destination.ip == null or destination.ip == \"0.0.0.0\" or cidrmatch(\n       destination.ip, \"10.0.0.0/8\", \"127.0.0.0/8\", \"169.254.0.0/16\", \"172.16.0.0/12\", \"192.0.0.0/24\", \"192.0.0.0/29\",\n       \"192.0.0.8/32\", \"192.0.0.9/32\", \"192.0.0.10/32\", \"192.0.0.170/32\", \"192.0.0.171/32\", \"192.0.2.0/24\",\n       \"192.31.196.0/24\", \"192.52.193.0/24\", \"192.168.0.0/16\", \"192.88.99.0/24\", \"224.0.0.0/4\", \"100.64.0.0/10\",\n       \"192.175.48.0/24\",\"198.18.0.0/15\", \"198.51.100.0/24\", \"203.0.113.0/24\", \"240.0.0.0/4\", \"::1\", \"FE80::/10\",\n       \"FF00::/8\"\n     )\n   )\n  ]",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "GitHub PAT Access Revoked",
        "description": "Access to private GitHub organization resources was revoked for a PAT.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 204,
        "tags": [
          "Domain: Cloud",
          "Use Case: Threat Detection",
          "Use Case: UEBA",
          "Tactic: Impact",
          "Rule Type: BBR",
          "Data Source: Github"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0040",
              "name": "Impact",
              "reference": "https://attack.mitre.org/tactics/TA0040/"
            },
            "technique": [
              {
                "id": "T1531",
                "name": "Account Access Removal",
                "reference": "https://attack.mitre.org/techniques/T1531/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "github",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "6e799411-92c8-4c22-8ebb-b70013881d9b",
        "rule_id": "8a0fd93a-7df8-410d-8808-4cc5e340f2b9",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:14.493Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:56.590Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "configuration where event.dataset == \"github.audit\" and event.action == \"personal_access_token.access_revoked\"",
        "language": "eql",
        "index": [
          "logs-github.audit-*"
        ],
        "filters": []
      },
      {
        "name": "Deprecated - Suspicious JAVA Child Process",
        "description": "Identifies suspicious child processes of the Java interpreter process. This may indicate an attempt to execute a malicious JAR file or an exploitation attempt via a JAVA specific vulnerability.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Suspicious Java Child Process\n\nThis rule identifies a suspicious child process of the Java interpreter process. It may indicate an attempt to execute a malicious JAR file or an exploitation attempt via a Java specific vulnerability.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence and whether they are located in expected locations.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate any abnormal account behavior, such as command executions, file creations or modifications, and network connections.\n- Investigate any abnormal behavior by the subject process such as network connections, file modifications, and any spawned child processes.\n- Examine the command line to determine if the command executed is potentially harmful or malicious.\n- Inspect the host for suspicious or abnormal behavior in the alert timeframe.\n\n### False positive analysis\n\n- If this activity is expected and noisy in your environment, consider adding exceptions â€” preferably with a combination of process and command line conditions.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Remove and block malicious artifacts identified during triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 209,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "OS: macOS",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Resources: Investigation Guide",
          "Use Case: Vulnerability",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.lunasec.io/docs/blog/log4j-zero-day/",
          "https://github.com/christophetd/log4shell-vulnerable-app",
          "https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE.pdf",
          "https://www.elastic.co/security-labs/detecting-log4j2-with-elastic-security",
          "https://www.elastic.co/security-labs/analysis-of-log4shell-cve-2021-45046"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.007",
                    "name": "JavaScript",
                    "reference": "https://attack.mitre.org/techniques/T1059/007/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "4774f5f4-60be-4d39-be05-72647f13913b",
        "rule_id": "8acb7614-1d92-4359-bfcf-478b6d9de150",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:14.496Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:56.605Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "event.category:process and event.type:(\"start\" or \"process_started\") and process.parent.name:\"java\" and process.name:(\n  bash or dash or sh or tcsh or csh or zsh or ksh or fish or python* or php* or perl or ruby or lua* or openssl or\n  nc or netcat or ncat or telnet or awk or socat or wget or curl\n) and process.args :(\n  whoami or id or uname or cat or hostname or ip or curl or wget or pwd or ls or cd or python* or php* or perl or\n  ruby or lua* or openssl or nc or netcat or ncat or telnet or awk or socat\n)",
        "new_terms_fields": [
          "host.id",
          "process.command_line"
        ],
        "history_window_start": "now-14d",
        "index": [
          "auditbeat-*",
          "logs-endpoint.events.*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "RPM Package Installed by Unusual Parent Process",
        "description": "This rule leverages the new_terms rule type to identify the installation of RPM packages by an unusual parent process. RPM is a package management system used in Linux systems such as Red Hat, CentOS and Fedora. Attacks may backdoor RPM packages to gain initial access or install malicious RPM packages to maintain persistence.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 2,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1543",
                "name": "Create or Modify System Process",
                "reference": "https://attack.mitre.org/techniques/T1543/"
              },
              {
                "id": "T1546",
                "name": "Event Triggered Execution",
                "reference": "https://attack.mitre.org/techniques/T1546/",
                "subtechnique": [
                  {
                    "id": "T1546.016",
                    "name": "Installer Packages",
                    "reference": "https://attack.mitre.org/techniques/T1546/016/"
                  }
                ]
              },
              {
                "id": "T1574",
                "name": "Hijack Execution Flow",
                "reference": "https://attack.mitre.org/techniques/T1574/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1195",
                "name": "Supply Chain Compromise",
                "reference": "https://attack.mitre.org/techniques/T1195/",
                "subtechnique": [
                  {
                    "id": "T1195.002",
                    "name": "Compromise Software Supply Chain",
                    "reference": "https://attack.mitre.org/techniques/T1195/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\nThis rule requires data coming in from Elastic Defend.\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "5f9a7b32-0bde-4cf4-9c4a-e371b7ec0390",
        "rule_id": "8cc72fa3-70ae-4ea1-bee2-8e6aaf3c1fcf",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:14.499Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:56.650Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "host.os.type:linux and event.category:process and event.type:start and event.action:exec and process.name:rpm and\nprocess.args:(\"-i\" or \"--install\")",
        "new_terms_fields": [
          "process.parent.executable"
        ],
        "history_window_start": "now-7d",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Bitsadmin Activity",
        "description": "Windows Background Intelligent Transfer Service (BITS) is a low-bandwidth, asynchronous file transfer mechanism. Adversaries may abuse BITS to persist, download, execute, and even clean up after running malicious code.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 105,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Command and Control",
          "Data Source: Elastic Defend",
          "Rule Type: BBR",
          "Data Source: Sysmon",
          "Data Source: Elastic Endgame",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            },
            "technique": [
              {
                "id": "T1105",
                "name": "Ingress Tool Transfer",
                "reference": "https://attack.mitre.org/techniques/T1105/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1197",
                "name": "BITS Jobs",
                "reference": "https://attack.mitre.org/techniques/T1197/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1197",
                "name": "BITS Jobs",
                "reference": "https://attack.mitre.org/techniques/T1197/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "56094eb6-25d3-4a55-8f56-056c66cf46d1",
        "rule_id": "8eec4df1-4b4b-4502-b6c3-c788714604c9",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:14.501Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:56.680Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (\n   (process.name : \"bitsadmin.exe\" and process.args : (\n        \"*Transfer*\", \"*Create*\", \"AddFile\", \"*SetNotifyFlags*\", \"*SetNotifyCmdLine*\",\n        \"*SetMinRetryDelay*\", \"*SetCustomHeaders*\", \"*Resume*\")\n   ) or\n   (process.name : \"powershell.exe\" and process.args : (\n        \"*Start-BitsTransfer*\", \"*Add-BitsFile*\",\n        \"*Resume-BitsTransfer*\", \"*Set-BitsTransfer*\", \"*BITS.Manager*\")\n   )\n  )",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "winlogbeat-*"
        ],
        "filters": []
      },
      {
        "name": "InstallUtil Activity",
        "description": "InstallUtil is a command-line utility that allows for installation and uninstallation of resources by executing specific installer components specified in .NET binaries. Adversaries may use InstallUtil to proxy the execution of code through a trusted Windows utility.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 104,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend",
          "Rule Type: BBR",
          "Data Source: Elastic Endgame",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1218",
                "name": "System Binary Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1218/",
                "subtechnique": [
                  {
                    "id": "T1218.004",
                    "name": "InstallUtil",
                    "reference": "https://attack.mitre.org/techniques/T1218/004/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "00473999-e72e-4c8c-8e3a-b75cde205c0b",
        "rule_id": "90babaa8-5216-4568-992d-d4a01a105d98",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:14.504Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:56.712Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.name : \"installutil.exe\" and not user.id : \"S-1-5-18\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "logs-system.security*",
          "winlogbeat-*",
          "logs-windows.*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "GitHub UEBA - Multiple Alerts from a GitHub Account",
        "description": "This rule is part of the \"GitHub UEBA - Unusual Activity from Account Pack\", and leverages alert data to determine when multiple alerts are executed by the same user in a timespan of one hour. Analysts can use this to prioritize triage and response, as these alerts are a higher indicator of compromised user accounts or PATs.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 101,
        "tags": [
          "Domain: Cloud",
          "Use Case: Threat Detection",
          "Use Case: UEBA",
          "Tactic: Execution",
          "Rule Type: Higher-Order Rule",
          "Data Source: Github"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-3600s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            }
          }
        ],
        "setup": "",
        "related_integrations": [],
        "required_fields": [
          {
            "name": "kibana.alert.workflow_status",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "signal.rule.tags",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "40af2271-7af1-4d50-bb67-9291cbc6f0d0",
        "rule_id": "929223b4-fba3-4a1c-a943-ec4716ad23ec",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:14.507Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:56.743Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "threshold",
        "query": "signal.rule.tags:(\"Use Case: UEBA\" and \"Data Source: Github\") and kibana.alert.workflow_status:\"open\"",
        "threshold": {
          "field": [
            "user.name"
          ],
          "value": 1,
          "cardinality": [
            {
              "field": "signal.rule.name",
              "value": 5
            }
          ]
        },
        "index": [
          ".alerts-security.*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "AWS STS Role Assumption by Service",
        "description": "Identifies when a service has assumed a role in AWS Security Token Service (STS). Services can assume a role to obtain temporary credentials and access AWS resources. Adversaries can use this technique for credential access and privilege escalation. This is a [New Terms](https://www.elastic.co/guide/en/security/current/rules-ui-create.html#create-new-terms-rule) rule that identifies when a service assumes a role in AWS Security Token Service (STS) to obtain temporary credentials and access AWS resources. While often legitimate, adversaries may use this technique for unauthorized access, privilege escalation, or lateral movement within an AWS environment.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and Analysis\n\n### Investigating AWS STS Role Assumption by Service\n\nThis rule identifies instances where AWS STS (Security Token Service) is used to assume a role, granting temporary credentials for AWS resource access. While this action is often legitimate, it can be exploited by adversaries to obtain unauthorized access, escalate privileges, or move laterally within an AWS environment.\n\n#### Possible Investigation Steps\n\n- **Identify the Actor and Assumed Role**:\n  - **User Identity**: Review the `aws.cloudtrail.user_identity.arn` and `aws.cloudtrail.user_identity.type` fields to determine who initiated the `AssumeRole` action.\n  - **Role Assumed**: Check the `aws.cloudtrail.flattened.request_parameters.roleArn` field to confirm the assumed role and ensure it aligns with expected responsibilities.\n  - **Session Name**: Observe the `aws.cloudtrail.flattened.request_parameters.roleSessionName` for context on the session's intended purpose, if available.\n\n- **Analyze the Role Session and Duration**:\n  - **Session Context**: Look at the `aws.cloudtrail.user_identity.session_context.creation_date` to understand when the session began and check if multi-factor authentication (MFA) was used, indicated by the `aws.cloudtrail.user_identity.session_context.mfa_authenticated` field.\n  - **Credential Validity**: Examine the `aws.cloudtrail.flattened.request_parameters.durationSeconds` for the credential's validity period.\n  - **Expiration Time**: Verify `aws.cloudtrail.flattened.response_elements.credentials.expiration` to determine when the credentials expire or expired.\n\n- **Inspect the User Agent for Tooling Identification**:\n  - **User Agent Details**: Review the `user_agent.original` field to identify the tool or SDK used for the role assumption. Indicators include:\n    - **AWS SDKs (e.g., Boto3)**: Often used in automated workflows or scripts.\n    - **AWS CLI**: Suggests command-line access, potentially indicating direct user interaction.\n    - **Custom Tooling**: Unusual user agents may signify custom or suspicious tools.\n  - **Source IP and Location**: Evaluate the `source.address` and `source.geo` fields to confirm if the access source aligns with typical access locations for your environment.\n\n- **Contextualize with Related Events**:\n  - **Review Event Patterns**: Check surrounding CloudTrail events to see if other actions coincide with this `AssumeRole` activity, such as attempts to access sensitive resources.\n  - **Identify High-Volume Exceptions**: Due to the potential volume of `AssumeRole` events, determine common, legitimate `roleArn` values or `user_agent` patterns, and consider adding these as exceptions to reduce noise.\n\n- **Evaluate the Privilege Level of the Assumed Role**:\n  - **Permissions**: Inspect permissions associated with the assumed role to understand its access level.\n  - **Authorized Usage**: Confirm whether the role is typically used for administrative purposes and if the assuming entity frequently accesses it as part of regular responsibilities.\n\n### False Positive Analysis\n\n- **Automated Workflows and Applications**: Many applications or scheduled tasks may assume roles for standard operations. Check user agents and ARNs for consistency with known workflows.\n- **Routine IAM Policy Actions**: Historical data may reveal if the same user or application assumes this specific role regularly as part of authorized operations.\n\n### Response and Remediation\n\n- **Revoke Unauthorized Sessions**: If unauthorized, consider revoking the session by adjusting IAM policies or permissions associated with the assumed role.\n- **Enhance Monitoring and Alerts**: Set up enhanced monitoring for high-risk roles, especially those with elevated privileges.\n- **Manage Exceptions**: Regularly review and manage high-frequency roles and user agent patterns, adding trusted ARNs and user agents to exception lists to minimize alert fatigue.\n- **Incident Response**: If malicious behavior is identified, follow incident response protocols, including containment, investigation, and remediation.\n\n### Additional Information\n\nFor more information on managing and securing AWS STS, refer to the [AWS STS documentation](https://docs.aws.amazon.com/STS/latest/APIReference/API_AssumeRole.html) and AWS security best practices.\n",
        "output_index": "",
        "investigation_fields": {
          "field_names": [
            "@timestamp",
            "aws.cloudtrail.user_identity.type",
            "aws.cloudtrail.resources.arn",
            "aws.cloudtrail.resources.type",
            "source.address",
            "aws.cloudtrail.user_identity.invoked_by",
            "aws.cloudtrail.flattened.request_parameters.roleArn",
            "aws.cloudtrail.flattened.request_parameters.roleSessionName",
            "event.action",
            "event.outcome",
            "cloud.region",
            "aws.cloudtrail.request_parameters",
            "aws.cloudtrail.response_elements"
          ]
        },
        "version": 209,
        "tags": [
          "Domain: Cloud",
          "Data Source: AWS",
          "Data Source: Amazon Web Services",
          "Data Source: AWS STS",
          "Resources: Investigation Guide",
          "Use Case: Identity and Access Audit",
          "Tactic: Privilege Escalation"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic",
          "Austin Songer"
        ],
        "false_positives": [
          "AWS administrators or automated processes might regularly assume roles for legitimate administrative purposes.",
          "AWS services might assume roles to access AWS resources as part of their standard operations.",
          "Automated workflows might assume roles to perform periodic tasks such as data backups, updates, or deployments."
        ],
        "references": [
          "https://docs.aws.amazon.com/STS/latest/APIReference/API_AssumeRole.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1548",
                "name": "Abuse Elevation Control Mechanism",
                "reference": "https://attack.mitre.org/techniques/T1548/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1550",
                "name": "Use Alternate Authentication Material",
                "reference": "https://attack.mitre.org/techniques/T1550/",
                "subtechnique": [
                  {
                    "id": "T1550.001",
                    "name": "Application Access Token",
                    "reference": "https://attack.mitre.org/techniques/T1550/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "aws",
            "version": "^2.0.0",
            "integration": "cloudtrail"
          }
        ],
        "required_fields": [
          {
            "name": "aws.cloudtrail.user_identity.invoked_by",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "aws.cloudtrail.user_identity.type",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "0bb2103a-b39c-4d95-ac65-a90f1f6fb7e8",
        "rule_id": "93075852-b0f5-4b8b-89c3-a226efae5726",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:14.510Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:56.748Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "event.dataset: \"aws.cloudtrail\"\n    and event.provider: \"sts.amazonaws.com\"\n    and event.action: \"AssumeRole\"\n    and event.outcome: \"success\"\n    and aws.cloudtrail.user_identity.type: \"AWSService\"\n    and not aws.cloudtrail.user_identity.invoked_by: (\n              \"config.amazonaws.com\" or\n              \"securityhub.amazonaws.com\" or\n              \"sso.amazonaws.com\"\n            )",
        "new_terms_fields": [
          "aws.cloudtrail.resources.arn",
          "aws.cloudtrail.user_identity.invoked_by"
        ],
        "history_window_start": "now-14d",
        "index": [
          "filebeat-*",
          "logs-aws.cloudtrail-*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "File made Immutable by Chattr",
        "description": "Detects a file being made immutable using the chattr binary. Making a file immutable means it cannot be deleted or renamed, no link can be created to this file, most of the file's metadata can not be modified, and the file can not be opened in write mode. Threat actors will commonly utilize this to prevent tampering or modification of their malicious files or any system files they have modified for purposes of persistence (e.g .ssh, /etc/passwd, etc.).",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 112,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 33,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1222",
                "name": "File and Directory Permissions Modification",
                "reference": "https://attack.mitre.org/techniques/T1222/",
                "subtechnique": [
                  {
                    "id": "T1222.002",
                    "name": "Linux and Mac File and Directory Permissions Modification",
                    "reference": "https://attack.mitre.org/techniques/T1222/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from one of the following integrations:\n- Elastic Defend\n- Auditbeat\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n### Auditbeat Setup\nAuditbeat is a lightweight shipper that you can install on your servers to audit the activities of users and processes on your systems. For example, you can use Auditbeat to collect and centralize audit events from the Linux Audit Framework. You can also use Auditbeat to detect changes to critical files, like binaries and configuration files, and identify potential security policy violations.\n\n#### The following steps should be executed in order to add the Auditbeat on a Linux System:\n- Elastic provides repositories available for APT and YUM-based distributions. Note that we provide binary packages, but no source packages.\n- To install the APT and YUM repositories follow the setup instructions in this [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/setup-repositories.html).\n- To run Auditbeat on Docker follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/running-on-docker.html).\n- To run Auditbeat on Kubernetes follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/running-on-kubernetes.html).\n- For complete â€œSetup and Run Auditbeatâ€ information refer to the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/setting-up-and-running.html).\n\n#### Custom Ingest Pipeline\nFor versions <8.2, you need to add a custom ingest pipeline to populate `event.ingested` with @timestamp for non-elastic-agent indexes, like auditbeats/filebeat/winlogbeat etc. For more details to add a custom ingest pipeline refer to the [guide](https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "3db1fde5-157b-402e-a3ac-1db6496b90b1",
        "rule_id": "968ccab9-da51-4a87-9ce2-d3c9782fd759",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:14.513Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:58.889Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and process.parent.executable != null and\nprocess.executable : \"/usr/bin/chattr\" and process.args : (\"-*i*\", \"+*i*\") and not (\n  process.parent.executable: (\"/lib/systemd/systemd\", \"/usr/local/uems_agent/bin/*\", \"/usr/lib/systemd/systemd\") or\n  process.parent.name in (\n    \"systemd\", \"cf-agent\", \"ntpdate\", \"xargs\", \"px\", \"preinst\", \"auth\", \"cf-agent\", \"dcservice\", \"dcagentupgrader\",\n    \"sudo\", \"ephemeral-disk-warning\"\n  )\n)",
        "language": "eql",
        "index": [
          "auditbeat-*",
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "AWS CloudTrail Log Deleted",
        "description": "Identifies the deletion of an AWS log trail. An adversary may delete trails in an attempt to evade defenses.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating AWS CloudTrail Log Deleted\n\nAmazon CloudTrail is a service that enables governance, compliance, operational auditing, and risk auditing of your Amazon Web Services account. With CloudTrail, you can log, continuously monitor, and retain account activity related to actions across your Amazon Web Services infrastructure. CloudTrail provides event history of your Amazon Web Services account activity, including actions taken through the Amazon Management Console, Amazon SDKs, command line tools, and other Amazon Web Services services. This event history simplifies security analysis, resource change tracking, and troubleshooting.\n\nThis rule identifies the deletion of an AWS log trail using the API `DeleteTrail` action. Attackers can do this to cover their tracks and impact security monitoring that relies on this source.\n\n#### Possible investigation steps\n\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Investigate other alerts associated with the user account during the past 48 hours.\n- Contact the account and resource owners and confirm whether they are aware of this activity.\n- Check if this operation was approved and performed according to the organization's change management policy.\n- Considering the source IP address and geolocation of the user who issued the command:\n    - Do they look normal for the user?\n    - If the source is an EC2 IP address, is it associated with an EC2 instance in one of your accounts or is the source IP from an EC2 instance that's not under your control?\n    - If it is an authorized EC2 instance, is the activity associated with normal behavior for the instance role or roles? Are there any other alerts or signs of suspicious activity involving this instance?\n- Investigate the deleted log trail's criticality and whether the responsible team is aware of the deletion.\n- If you suspect the account has been compromised, scope potentially compromised assets by tracking servers, services, and data accessed by the account in the last 24 hours.\n\n### False positive analysis\n\n- If this rule is noisy in your environment due to expected activity, consider adding exceptions â€” preferably with a combination of user and IP address conditions.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Disable or limit the account during the investigation and response.\n- Identify the possible impact of the incident and prioritize accordingly; the following actions can help you gain context:\n    - Identify the account role in the cloud environment.\n    - Assess the criticality of affected services and servers.\n    - Work with your IT team to identify and minimize the impact on users.\n    - Identify if the attacker is moving laterally and compromising other accounts, servers, or services.\n    - Identify any regulatory or legal ramifications related to this activity.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords or delete API keys as needed to revoke the attacker's access to the environment. Work with your IT teams to minimize the impact on business operations during these actions.\n- Check if unauthorized new users were created, remove unauthorized new accounts, and request password resets for other IAM users.\n- Consider enabling multi-factor authentication for users.\n- Review the permissions assigned to the implicated user to ensure that the least privilege principle is being followed.\n- Implement security best practices [outlined](https://aws.amazon.com/premiumsupport/knowledge-center/security-best-practices/) by AWS.\n- Take the actions needed to return affected systems, data, or services to their normal operational levels.\n- Identify the initial vector abused by the attacker and take action to prevent reinfection via the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).",
        "output_index": "",
        "investigation_fields": {
          "field_names": [
            "@timestamp",
            "user.name",
            "aws.cloudtrail.user_identity.arn",
            "aws.cloudtrail.user_identity.type",
            "source.address",
            "user_agent.original",
            "aws.cloudtrail.flattened.request_parameters.name",
            "event.action",
            "event.outcome",
            "cloud.region",
            "aws.cloudtrail.request_parameters"
          ]
        },
        "version": 210,
        "tags": [
          "Domain: Cloud",
          "Data Source: AWS",
          "Data Source: Amazon Web Services",
          "Use Case: Log Auditing",
          "Resources: Investigation Guide",
          "Tactic: Defense Evasion"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-3600s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Trail deletions may be made by a system or network administrator. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. Trail deletions by unfamiliar users or hosts should be investigated. If known behavior is causing false positives, it can be exempted from the rule."
        ],
        "references": [
          "https://docs.aws.amazon.com/awscloudtrail/latest/APIReference/API_DeleteTrail.html",
          "https://awscli.amazonaws.com/v2/documentation/api/latest/reference/cloudtrail/delete-trail.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.001",
                    "name": "Disable or Modify Tools",
                    "reference": "https://attack.mitre.org/techniques/T1562/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The AWS Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "aws",
            "version": "^2.0.0",
            "integration": "cloudtrail"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.outcome",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.provider",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "3582815d-cecc-4d29-88f2-1c490712e440",
        "rule_id": "7024e2a0-315d-4334-bb1a-441c593e16ab",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:14.516Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:52.535Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-aws.cloudtrail-*"
        ],
        "filters": [],
        "query": "event.dataset:aws.cloudtrail\n    and event.provider:cloudtrail.amazonaws.com\n    and event.action:DeleteTrail\n    and event.outcome:success",
        "language": "kuery"
      },
      {
        "name": "Suspicious Execution via MSIEXEC",
        "description": "Identifies suspicious execution of the built-in Windows Installer, msiexec.exe, to install a package from usual paths or parent process. Adversaries may abuse msiexec.exe to launch malicious local MSI files.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 103,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Rule Type: BBR",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://lolbas-project.github.io/lolbas/Binaries/Msiexec/",
          "https://www.guardicore.com/labs/purple-fox-rootkit-now-propagates-as-a-worm/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1218",
                "name": "System Binary Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1218/",
                "subtechnique": [
                  {
                    "id": "T1218.007",
                    "name": "Msiexec",
                    "reference": "https://attack.mitre.org/techniques/T1218/007/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args_count",
            "type": "long",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.args_count",
            "type": "long",
            "ecs": true
          },
          {
            "name": "process.parent.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.working_directory",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "56becddf-3ded-44eb-bafd-c406e734b556",
        "rule_id": "708c9d92-22a3-4fe0-b6b9-1f861c55502d",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:14.519Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:52.554Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.action == \"start\" and\n  process.name : \"msiexec.exe\" and user.id : (\"S-1-5-21*\", \"S-1-12-*\") and process.parent.executable != null and\n  (\n    (process.args : \"/i\" and process.args : (\"/q\", \"/quiet\") and process.args_count == 4 and\n     process.args : (\"?:\\\\Users\\\\*\", \"?:\\\\ProgramData\\\\*\") and\n     not process.parent.executable : (\"?:\\\\Program Files (x86)\\\\*.exe\",\n                                      \"?:\\\\Program Files\\\\*.exe\",\n                                      \"?:\\\\Windows\\\\explorer.exe\",\n                                      \"?:\\\\Users\\\\*\\\\Desktop\\\\*\",\n                                      \"?:\\\\Users\\\\*\\\\Downloads\\\\*\",\n                                      \"?:\\\\programdata\\\\*\")) or\n\n    (process.args_count == 1 and not process.parent.executable : (\"?:\\\\Windows\\\\explorer.exe\", \"?:\\\\Windows\\\\SysWOW64\\\\explorer.exe\")) or\n\n    (process.args : \"/i\" and process.args : (\"/q\", \"/quiet\") and process.args_count == 4 and\n     (process.parent.args : \"Schedule\" or process.parent.name : \"wmiprvse.exe\" or\n     process.parent.executable : \"?:\\\\Users\\\\*\\\\AppData\\\\*\" or\n     (process.parent.name : (\"powershell.exe\", \"cmd.exe\") and length(process.parent.command_line) >= 200))) or\n\n    (process.args : \"/i\" and process.args : (\"/q\", \"/quiet\") and process.args_count == 4 and\n     ?process.working_directory : \"?:\\\\\" and process.parent.name : (\"cmd.exe\", \"powershell.exe\"))\n  ) and\n\n  /* noisy pattern */\n  not (process.parent.executable : \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\*\" and ?process.parent.args_count >= 2 and\n       process.args : \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\*\\\\*.msi\") and\n\n  not process.args : (\"?:\\\\Program Files (x86)\\\\*\", \"?:\\\\Program Files\\\\*\")",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "winlogbeat-*",
          "logs-windows.*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious Sysctl File Event",
        "description": "Monitors file events on sysctl configuration files (e.g., /etc/sysctl.conf, /etc/sysctl.d/*.conf) to identify potential unauthorized access or manipulation of system-level configuration settings. Attackers may tamper with the sysctl configuration files to modify kernel parameters, potentially compromising system stability, performance, or security.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 108,
        "tags": [
          "Data Source: Auditd Manager",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Rule Type: BBR"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1082",
                "name": "System Information Discovery",
                "reference": "https://attack.mitre.org/techniques/T1082/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires the use of the `auditd_manager` integration. `Auditd_manager` is a tool designed to simplify and enhance the management of the audit subsystem in Linux systems. It provides a user-friendly interface and automation capabilities for configuring and monitoring system auditing through the auditd daemon. With `auditd_manager`, administrators can easily define audit rules, track system events, and generate comprehensive audit reports, improving overall security and compliance in the system. The following steps should be executed in order to install and deploy `auditd_manager` on a Linux system.\n\n```\nKibana -->\nManagement -->\nIntegrations -->\nAuditd Manager -->\nAdd Auditd Manager\n```\n\n`Auditd_manager` subscribes to the kernel and receives events as they occur without any additional configuration. However, if more advanced configuration is required to detect specific behavior, audit rules can be added to the integration in either the \"audit rules\" configuration box or the \"auditd rule files\" box by specifying a file to read the audit rules from.\n\nFor this detection rule to trigger, the following additional audit rules are required to be added to the integration:\n\n```\n-w /etc/sysctl.conf -p wa -k sysctl\n-w /etc/sysctl.d -p wa -k sysctl\n```\n\nAdd the newly installed `auditd manager` to an agent policy, and deploy the agent on a Linux system from which auditd log files are desirable.\n",
        "related_integrations": [
          {
            "package": "auditd_manager",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "f2b3d26a-ebd5-4f26-940c-e335814a1e6d",
        "rule_id": "7592c127-89fb-4209-a8f6-f9944dfd7e02",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:14.522Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:52.639Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "host.os.type:linux and event.category:file and event.action:(\"opened-file\" or \"read-file\" or \"wrote-to-file\") and\nfile.path : (\"/etc/sysctl.conf\" or \"/etc/sysctl.d\" or /etc/sysctl.d/*) and not process.name:(\n  dpkg or dockerd or unattended-upg or systemd-sysctl or python* or auditbeat or dpkg or pool*\n)",
        "new_terms_fields": [
          "process.executable"
        ],
        "history_window_start": "now-14d",
        "index": [
          "auditbeat-*",
          "logs-auditd_manager.auditd-*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "UID Elevation from Previously Unknown Executable",
        "description": "Monitors for the elevation of regular user permissions to root permissions through a previously unknown executable. Attackers may attempt to evade detection by hijacking the execution flow and hooking certain functions/syscalls through a rootkit in order to provide easy access to root via a special modified command.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 4,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1574",
                "name": "Hijack Execution Flow",
                "reference": "https://attack.mitre.org/techniques/T1574/",
                "subtechnique": [
                  {
                    "id": "T1574.013",
                    "name": "KernelCallbackTable",
                    "reference": "https://attack.mitre.org/techniques/T1574/013/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1014",
                "name": "Rootkit",
                "reference": "https://attack.mitre.org/techniques/T1014/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows\nthe Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click Add integrations.\n- In the query bar, search for Elastic Defend and select the integration to see more details about it.\n- Click Add Elastic Defend.\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either Traditional Endpoints or Cloud Workloads.\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest to select \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in New agent policy name. If other agent policies already exist, you can click the Existing hosts tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click Save and Continue.\n- To complete the integration, select Add Elastic Agent to your hosts and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "afdb0439-1c90-4e1b-af9b-e9b30a401d4e",
        "rule_id": "7787362c-90ff-4b1a-b313-8808b1020e64",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:14.525Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:54.462Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "host.os.type:\"linux\" and event.category:\"process\" and event.action:\"uid_change\" and event.type:\"change\" and user.id:\"0\"\nand process.parent.name:(\"bash\" or \"dash\" or \"sh\" or \"tcsh\" or \"csh\" or \"zsh\" or \"ksh\" or \"fish\") and not (\n  process.executable:(\n    /bin/* or /usr/bin/* or /sbin/* or /usr/sbin/* or /snap/* or /tmp/newroot/* or /var/lib/docker/* or /usr/local/* or\n    /opt/psa/admin/* or /usr/lib/snapd/snap-confine or /opt/dynatrace/* or /opt/microsoft/* or\n    /var/lib/snapd/snap/bin/node or /opt/gitlab/embedded/sbin/logrotate or /etc/apt/universal-hooks/* or\n    /opt/puppetlabs/puppet/bin/puppet or /opt/cisco/* or /run/k3s/containerd/* or /usr/lib/postfix/sbin/master or\n    /usr/libexec/postfix/local or /var/lib/snapd/snap/bin/postgresql* or /opt/puppetlabs/puppet/bin/ruby\n  ) or\n  process.name:(\n    \"bash\" or \"dash\" or \"sh\" or \"tcsh\" or \"csh\" or \"zsh\" or \"ksh\" or \"fish\" or \"sudo\" or \"su\" or \"apt\" or \"apt-get\" or\n    \"aptitude\" or \"squid\" or \"snap\" or \"fusermount\" or \"pkexec\" or \"umount\" or \"master\" or \"omsbaseline\" or \"dzdo\" or\n    \"sandfly\" or \"logrotate\"\n  ) or\n  process.args:/usr/bin/python*\n)",
        "new_terms_fields": [
          "process.executable"
        ],
        "history_window_start": "now-14d",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Enumeration of Kernel Modules via Proc",
        "description": "Loadable Kernel Modules (or LKMs) are pieces of code that can be loaded and unloaded into the kernel upon demand. They extend the functionality of the kernel without the need to reboot the system. This identifies attempts to enumerate information about a kernel module using the /proc/modules filesystem. This filesystem is used by utilities such as lsmod and kmod to list the available kernel modules.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 107,
        "tags": [
          "Data Source: Auditd Manager",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Rule Type: BBR"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Security tools and device drivers may run these programs in order to enumerate kernel modules. Use of these programs by ordinary users is uncommon. These can be exempted by process name or username."
        ],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1082",
                "name": "System Information Discovery",
                "reference": "https://attack.mitre.org/techniques/T1082/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires the use of the `auditd_manager` integration. `Auditd_manager` is a tool designed to simplify and enhance the management of the audit subsystem in Linux systems. It provides a user-friendly interface and automation capabilities for configuring and monitoring system auditing through the auditd daemon. With `auditd_manager`, administrators can easily define audit rules, track system events, and generate comprehensive audit reports, improving overall security and compliance in the system. The following steps should be executed in order to install and deploy `auditd_manager` on a Linux system.\n```\nKibana -->\nManagement -->\nIntegrations -->\nAuditd Manager -->\nAdd Auditd Manager\n```\n`Auditd_manager` subscribes to the kernel and receives events as they occur without any additional configuration. However, if more advanced configuration is required to detect specific behavior, audit rules can be added to the integration in either the \"audit rules\" configuration box or the \"auditd rule files\" box by specifying a file to read the audit rules from.\nFor this detection rule to trigger, the following additional audit rules are required to be added to the integration:\n```\n-w /proc/ -p r -k audit_proc\n```\nAdd the newly installed `auditd manager` to an agent policy, and deploy the agent on a Linux system from which auditd log files are desirable.\n",
        "related_integrations": [
          {
            "package": "auditd_manager",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "113dd557-8d46-4779-9e3d-5848cceca10d",
        "rule_id": "80084fa9-8677-4453-8680-b891d3c0c778",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:14.528Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:54.633Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "host.os.type:linux and event.category:file and event.action:\"opened-file\" and file.path:\"/proc/modules\" and\nnot process.name:(python* or chef-client)",
        "new_terms_fields": [
          "process.executable"
        ],
        "history_window_start": "now-14d",
        "index": [
          "auditbeat-*",
          "logs-auditd_manager.auditd-*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Potential Memory Seeking Activity",
        "description": "Monitors for the execution of Unix utilities that may be leveraged as memory address seekers. Attackers may leverage built-in utilities to seek specific memory addresses, allowing for potential future manipulation/exploitation.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 3,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Rule Type: BBR",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/arget13/DDexec"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1057",
                "name": "Process Discovery",
                "reference": "https://attack.mitre.org/techniques/T1057/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "85e09a95-5c93-40ad-bc02-b3965913d44b",
        "rule_id": "035a6f21-4092-471d-9cda-9e379f459b1e",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:14.531Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:38.181Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\") and (\n  (process.name == \"tail\" and process.args in (\"-c\", \"--bytes\")) or\n  (process.name == \"cmp\" and process.args == \"-i\") or\n  (process.name in (\"hexdump\", \"xxd\") and process.args == \"-s\") or\n  (process.name == \"dd\" and process.args : (\"skip*\", \"seek*\"))\n) and not (\n  process.parent.args like (\"/opt/error_monitor/error_monitor.sh\", \"printf*\") or\n  process.parent.name in (\"acme.sh\", \"dracut\", \"leapp\") or\n  process.parent.executable like (\n    \"/bin/cagefs_enter\", \"/opt/nessus_agent/sbin/nessus-service\", \"/usr/libexec/platform-python*\",\n    \"/usr/libexec/vdsm/vdsmd\", \"/usr/local/bin/docker-entrypoint.sh\", \"/usr/lib/module-init-tools/lsinitrd-quick\"\n  ) or\n  process.parent.command_line like \"sh*acme.sh*\" or\n  process.args like \"/var/tmp/dracut*\"\n)",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "Modification of OpenSSH Binaries",
        "description": "Adversaries may modify SSH related binaries for persistence or credential access by patching sensitive functions to enable unauthorized access or by logging SSH credentials for exfiltration.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Modification of OpenSSH Binaries\n\nOpenSSH is a widely used suite of secure networking utilities based on the Secure Shell (SSH) protocol, which provides encrypted communication sessions over a computer network.\n\nAdversaries may exploit OpenSSH by modifying its binaries, such as `/usr/bin/scp`, `/usr/bin/sftp`, `/usr/bin/ssh`, `/usr/sbin/sshd`, or `libkeyutils.so`, to gain unauthorized access or exfiltrate SSH credentials.\n\nThe detection rule 'Modification of OpenSSH Binaries' is designed to identify such abuse by monitoring file changes in the Linux environment. It triggers an alert when a process, modifies any of the specified OpenSSH binaries or libraries. This helps security analysts detect potential malicious activities and take appropriate action.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n> This investigation guide uses [placeholder fields](https://www.elastic.co/guide/en/security/current/osquery-placeholder-fields.html) to dynamically pass alert data into Osquery queries. Placeholder fields were introduced in Elastic Stack version 8.7.0. If you're using Elastic Stack version 8.6.0 or earlier, you'll need to manually adjust this investigation guide's queries to ensure they properly run.\n\n### Possible investigation steps\n\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence and whether they are located in expected locations.\n  - !{osquery{\"label\":\"Osquery - Retrieve Running Processes by User\",\"query\":\"SELECT pid, username, name FROM processes p JOIN users u ON u.uid = p.uid ORDER BY username\"}}\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Validate the activity is not related to planned patches, updates, network administrator activity, or legitimate software installations.\n- Investigate whether the altered scripts call other malicious scripts elsewhere on the file system. \n  - If scripts or executables were dropped, retrieve the files and determine if they are malicious:\n    - Use a private sandboxed malware analysis system to perform analysis.\n      - Observe and collect information about the following activities:\n        - Attempts to contact external domains and addresses.\n          - Check if the domain is newly registered or unexpected.\n          - Check the reputation of the domain or IP address.\n        - File access, modification, and creation activities.\n        - Cron jobs, services and other persistence mechanisms.\n            - !{osquery{\"label\":\"Osquery - Retrieve Crontab Information\",\"query\":\"SELECT * FROM crontab\"}}\n- Investigate abnormal behaviors by the subject process/user such as network connections, file modifications, and any other spawned child processes.\n  - Investigate listening ports and open sockets to look for potential command and control traffic or data exfiltration.\n    - !{osquery{\"label\":\"Osquery - Retrieve Listening Ports\",\"query\":\"SELECT pid, address, port, socket, protocol, path FROM listening_ports\"}}\n    - !{osquery{\"label\":\"Osquery - Retrieve Open Sockets\",\"query\":\"SELECT pid, family, remote_address, remote_port, socket, state FROM process_open_sockets\"}}\n  - Identify the user account that performed the action, analyze it, and check whether it should perform this kind of action.\n    - !{osquery{\"label\":\"Osquery - Retrieve Information for a Specific User\",\"query\":\"SELECT * FROM users WHERE username = {{user.name}}\"}}\n- Investigate whether the user is currently logged in and active.\n    - !{osquery{\"label\":\"Osquery - Investigate the Account Authentication Status\",\"query\":\"SELECT * FROM logged_in_users WHERE user = {{user.name}}\"}}\n\n### False positive analysis\n\n- Regular users should not need to modify OpenSSH binaries, which makes false positives unlikely. In the case of authorized benign true positives (B-TPs), exceptions can be added.\n- If this activity is related to new benign software installation activity, consider adding exceptions â€” preferably with a combination of user and command line conditions.\n- If this activity is related to a system administrator that performed these actions for administrative purposes, consider adding exceptions for this specific administrator user account. \n- Try to understand the context of the execution by thinking about the user, machine, or business purpose. A small number of endpoints, such as servers with unique software, might appear unusual but satisfy a specific business need.\n\n### Response and Remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Leverage the incident response data and logging to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 110,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Tactic: Persistence",
          "Tactic: Lateral Movement",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Trusted OpenSSH executable updates. It's recommended to verify the integrity of OpenSSH binary changes."
        ],
        "references": [
          "https://blog.angelalonso.es/2016/09/anatomy-of-real-linux-intrusion-part-ii.html"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1543",
                "name": "Create or Modify System Process",
                "reference": "https://attack.mitre.org/techniques/T1543/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1556",
                "name": "Modify Authentication Process",
                "reference": "https://attack.mitre.org/techniques/T1556/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1021",
                "name": "Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1021/",
                "subtechnique": [
                  {
                    "id": "T1021.004",
                    "name": "SSH",
                    "reference": "https://attack.mitre.org/techniques/T1021/004/"
                  }
                ]
              },
              {
                "id": "T1563",
                "name": "Remote Service Session Hijacking",
                "reference": "https://attack.mitre.org/techniques/T1563/",
                "subtechnique": [
                  {
                    "id": "T1563.001",
                    "name": "SSH Hijacking",
                    "reference": "https://attack.mitre.org/techniques/T1563/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from one of the following integrations:\n- Elastic Defend\n- Auditbeat\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n### Auditbeat Setup\nAuditbeat is a lightweight shipper that you can install on your servers to audit the activities of users and processes on your systems. For example, you can use Auditbeat to collect and centralize audit events from the Linux Audit Framework. You can also use Auditbeat to detect changes to critical files, like binaries and configuration files, and identify potential security policy violations.\n\n#### The following steps should be executed in order to add the Auditbeat on a Linux System:\n- Elastic provides repositories available for APT and YUM-based distributions. Note that we provide binary packages, but no source packages.\n- To install the APT and YUM repositories follow the setup instructions in this [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/setup-repositories.html).\n- To run Auditbeat on Docker follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/running-on-docker.html).\n- To run Auditbeat on Kubernetes follow the setup instructions in the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/running-on-kubernetes.html).\n- For complete â€œSetup and Run Auditbeatâ€ information refer to the [helper guide](https://www.elastic.co/guide/en/beats/auditbeat/current/setting-up-and-running.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "fc2c31f9-e74a-446d-a6df-b3c080415ac1",
        "rule_id": "0415f22a-2336-45fa-ba07-618a5942e22c",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:14.535Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:38.206Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": [],
        "query": "event.category:file and host.os.type:linux and event.type:change and \n  process.name:(* and not (dnf or dnf-automatic or dpkg or yum or rpm or yum-cron or anacron or platform-python)) and \n  (file.path:(/usr/bin/scp or \n                /usr/bin/sftp or \n                /usr/bin/ssh or \n                /usr/sbin/sshd) or \n  file.name:libkeyutils.so) and\n  not (\n    process.executable:/usr/share/elasticsearch/* or\n    process.name : (apk or ansible-admin or systemd or dnf or python*)\n  )",
        "language": "kuery"
      },
      {
        "name": "GitHub Protected Branch Settings Changed",
        "description": "This rule detects setting modifications for protected branches of a GitHub repository. Branch protection rules can be used to enforce certain workflows or requirements before a contributor can push changes to a branch in your repository. Changes to these protected branch settings should be investigated and verified as legitimate activity. Unauthorized changes could be used to lower your organization's security posture and leave you exposed for future attacks.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Cloud",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Github"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.001",
                    "name": "Disable or Modify Tools",
                    "reference": "https://attack.mitre.org/techniques/T1562/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "github",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "github.category",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "5624574c-f560-4dc1-9503-d77a84c3a12e",
        "rule_id": "07639887-da3a-4fbf-9532-8ce748ff8c50",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:14.537Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:38.251Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "configuration where event.dataset == \"github.audit\"\n  and github.category == \"protected_branch\" and event.type == \"change\"",
        "language": "eql",
        "index": [
          "logs-github.audit-*"
        ],
        "filters": []
      },
      {
        "name": "Process Termination followed by Deletion",
        "description": "Identifies a process termination event quickly followed by the deletion of its executable file. Malware tools and other non-native files dropped or created on a system by an adversary may leave traces to indicate to what occurred. Removal of these files can occur during an intrusion, or as part of a post-intrusion process to minimize the adversary's footprint.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Process Termination followed by Deletion\n\nThis rule identifies an unsigned process termination event quickly followed by the deletion of its executable file. Attackers can delete programs after their execution in an attempt to cover their tracks in a host.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate any abnormal behavior by the subject process such as network connections, registry or file modifications, command line and any spawned child processes.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the process executable using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately, as programs that exhibit this behavior, such as installers and similar utilities, should be signed. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 110,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Endgame",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1036",
                "name": "Masquerading",
                "reference": "https://attack.mitre.org/techniques/T1036/",
                "subtechnique": [
                  {
                    "id": "T1036.001",
                    "name": "Invalid Code Signature",
                    "reference": "https://attack.mitre.org/techniques/T1036/001/"
                  }
                ]
              },
              {
                "id": "T1070",
                "name": "Indicator Removal",
                "reference": "https://attack.mitre.org/techniques/T1070/",
                "subtechnique": [
                  {
                    "id": "T1070.004",
                    "name": "File Deletion",
                    "reference": "https://attack.mitre.org/techniques/T1070/004/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.code_signature.subject_name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.code_signature.trusted",
            "type": "boolean",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.code_signature.status",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.code_signature.subject_name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "7e333dd6-dfe9-4aaa-bfc8-98ab607096e8",
        "rule_id": "09443c92-46b3-45a4-8f25-383b028b258d",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:14.541Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:38.291Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by host.id with maxspan=5s\n   [process where host.os.type == \"windows\" and event.type == \"end\" and\n    process.code_signature.trusted != true and\n    not process.executable like\n             (\"C:\\\\Windows\\\\SoftwareDistribution\\\\*.exe\",\n              \"C:\\\\Windows\\\\WinSxS\\\\*.exe\",\n              \"?:\\\\Windows\\\\Postillion\\\\Office\\\\*.exe\") and\n    not (\n      process.name : \"infinst.exe\" and process.parent.name: \"dxsetup.exe\" and\n      process.parent.code_signature.subject_name == \"NVIDIA Corporation\" and\n      process.parent.code_signature.status == \"trusted\"\n    )\n   ] by process.executable\n   [file where host.os.type == \"windows\" and event.type == \"deletion\" and file.extension in~ (\"exe\", \"scr\", \"com\") and\n    not process.executable like\n             (\"?:\\\\Program Files\\\\*.exe\",\n              \"?:\\\\Program Files (x86)\\\\*.exe\",\n              \"?:\\\\Windows\\\\System32\\\\svchost.exe\",\n              \"?:\\\\Windows\\\\System32\\\\drvinst.exe\",\n              \"?:\\\\Windows\\\\Postillion\\\\Office\\\\*.exe\") and\n    not file.path like (\n          \"?:\\\\Program Files\\\\*.exe\",\n          \"?:\\\\Program Files (x86)\\\\*.exe\",\n          \"?:\\\\Windows\\\\Temp\\\\*\\\\DismHost.exe\",\n          \"?:\\\\$WINDOWS.~BT\\\\Work\\\\*\\\\DismHost.exe\",\n          \"?:\\\\$WinREAgent\\\\Scratch\\\\*\\\\DismHost.exe\",\n          \"?:\\\\Windows\\\\tenable_mw_scan_*.exe\",\n          \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Temp\\\\LogiUI\\\\Pak\\\\uninstall.exe\",\n          \"?:\\\\ProgramData\\\\chocolatey\\\\*.exe\"\n    ) and\n    not (process.name : \"OktaVerifySetup-*.exe\" and process.code_signature.subject_name == \"Okta, Inc.\") and\n    not (\n      process.executable : \"?:\\\\Windows\\\\SysWOW64\\\\config\\\\systemprofile\\\\Citrix\\\\UpdaterBinaries\\\\CitrixReceiver\\\\*\" and\n      process.code_signature.subject_name == \"Citrix Systems, Inc.\" and\n      file.path : \"?:\\\\Windows\\\\SysWOW64\\\\config\\\\systemprofile\\\\Citrix\\\\UpdaterBinaries\\\\CitrixReceiver\\\\*\\\\bootstrapperhelper.exe\"\n    )\n   ] by file.path",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "logs-endpoint.events.file-*"
        ],
        "filters": []
      },
      {
        "name": "Member Removed From GitHub Organization",
        "description": "A member was removed or their invitation to join was removed from a GitHub Organization.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 204,
        "tags": [
          "Domain: Cloud",
          "Use Case: Threat Detection",
          "Use Case: UEBA",
          "Tactic: Impact",
          "Rule Type: BBR",
          "Data Source: Github"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0040",
              "name": "Impact",
              "reference": "https://attack.mitre.org/tactics/TA0040/"
            },
            "technique": [
              {
                "id": "T1531",
                "name": "Account Access Removal",
                "reference": "https://attack.mitre.org/techniques/T1531/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "github",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "3d946ce7-b5bd-4b75-b3fc-8f56b95e1577",
        "rule_id": "095b6a58-8f88-4b59-827c-ab584ad4e759",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:14.544Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:40.363Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "configuration where event.dataset == \"github.audit\" and event.action == \"org.remove_member\"",
        "language": "eql",
        "index": [
          "logs-github.audit-*"
        ],
        "filters": []
      },
      {
        "name": "File Creation, Execution and Self-Deletion in Suspicious Directory",
        "description": "This rule monitors for the creation of a file, followed by its execution and self-deletion in a short timespan within a directory often used for malicious purposes by threat actors. This behavior is often used by malware to execute malicious code and delete itself to hide its tracks.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 5,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.004",
                    "name": "Unix Shell",
                    "reference": "https://attack.mitre.org/techniques/T1059/004/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "31722bc3-35cc-4070-a178-c2b748476b5d",
        "rule_id": "09bc6c90-7501-494d-b015-5d988dc3f233",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:14.547Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:40.078Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by host.id, user.id with maxspan=1m\n  [file where host.os.type == \"linux\" and event.action == \"creation\" and \n   process.name in (\"curl\", \"wget\", \"fetch\", \"ftp\", \"sftp\", \"scp\", \"rsync\", \"ld\") and \n   file.path : (\"/dev/shm/*\", \"/run/shm/*\", \"/tmp/*\", \"/var/tmp/*\",\n     \"/run/*\", \"/var/run/*\", \"/var/www/*\", \"/proc/*/fd/*\")] by file.name\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and \n   process.parent.name in (\"bash\", \"dash\", \"ash\", \"sh\", \"tcsh\", \"csh\", \"zsh\", \"ksh\", \"fish\") and\n   not process.parent.executable like (\n     \"/tmp/VeeamApp*\", \"/tmp/rajh/spack-stage/*\", \"plz-out/bin/vault/bridge/test/e2e/base/bridge-dev\",\n     \"/usr/bin/ranlib\", \"/usr/bin/ar\", \"plz-out/bin/vault/bridge/test/e2e/base/local-k8s\"  \n   )] by process.name\n  [file where host.os.type == \"linux\" and event.action == \"deletion\" and not process.name in (\"rm\", \"ld\") and \n   file.path : (\"/dev/shm/*\", \"/run/shm/*\", \"/tmp/*\", \"/var/tmp/*\",\n     \"/run/*\", \"/var/run/*\", \"/var/www/*\", \"/proc/*/fd/*\")] by file.name",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "First Occurrence of GitHub User Interaction with Private Repo",
        "description": "Detects a new private repo interaction for a GitHub user not seen in the last 14 days.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 204,
        "tags": [
          "Domain: Cloud",
          "Use Case: Threat Detection",
          "Use Case: UEBA",
          "Tactic: Execution",
          "Rule Type: BBR",
          "Data Source: Github"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1648",
                "name": "Serverless Execution",
                "reference": "https://attack.mitre.org/techniques/T1648/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "github",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "github.repo",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "github.repository_public",
            "type": "boolean",
            "ecs": false
          },
          {
            "name": "user.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "7b31e79c-1833-4c5f-a9ca-f76d725bf794",
        "rule_id": "01c49712-25bc-49d2-a27d-d7ce52f5dc49",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:14.561Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:38.142Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "event.dataset:\"github.audit\" and event.category:\"configuration\" and\ngithub.repo:* and user.name:* and \ngithub.repository_public:false",
        "new_terms_fields": [
          "user.name",
          "github.repo"
        ],
        "history_window_start": "now-14d",
        "index": [
          "logs-github.audit-*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "First Occurrence of GitHub Repo Interaction From a New IP",
        "description": "Detects an interaction with a private GitHub repository from a new IP address not seen in the last 14 days.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 204,
        "tags": [
          "Domain: Cloud",
          "Use Case: Threat Detection",
          "Use Case: UEBA",
          "Tactic: Execution",
          "Rule Type: BBR",
          "Data Source: Github"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1648",
                "name": "Serverless Execution",
                "reference": "https://attack.mitre.org/techniques/T1648/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "github",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "github.actor_ip",
            "type": "ip",
            "ecs": false
          },
          {
            "name": "github.repo",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "github.repository_public",
            "type": "boolean",
            "ecs": false
          }
        ],
        "id": "52af54b0-77b8-45b1-afe4-38de23674042",
        "rule_id": "0294f105-d7af-4a02-ae90-35f56763ffa2",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:14.565Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:38.147Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "event.dataset:\"github.audit\" and event.category:\"configuration\" and\ngithub.actor_ip:* and github.repo:* and \ngithub.repository_public:false",
        "new_terms_fields": [
          "github.repo",
          "github.actor_ip"
        ],
        "history_window_start": "now-14d",
        "index": [
          "logs-github.audit-*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Suspicious System Commands Executed by Previously Unknown Executable",
        "description": "This rule monitors for the execution of several commonly used system commands executed by a previously unknown executable located in commonly abused directories. An alert from this rule can indicate the presence of potentially malicious activity, such as the execution of unauthorized or suspicious processes attempting to run malicious code. Detecting and investigating such behavior can help identify and mitigate potential security threats, protecting the system and its data from potential compromise.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 107,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.004",
                    "name": "Unix Shell",
                    "reference": "https://attack.mitre.org/techniques/T1059/004/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "ce6dfaa8-028f-4a8f-aaca-f04f381ee2a1",
        "rule_id": "e9001ee6-2d00-4d2f-849e-b8b1fb05234c",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:14.568Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:17:08.919Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "host.os.type:linux and event.category:process and event.action:(exec or exec_event or fork or fork_event) and\nprocess.executable:(* and (\n  /etc/crontab or /bin/* or /boot/* or /dev/shm/* or /etc/cron.*/* or /etc/init.d/* or /etc/rc*.d/* or /etc/update-motd.d/* or\n  /home/*/.* or /tmp/* or /usr/bin/* or /usr/lib/update-notifier/* or /usr/share/* or /var/tmp/*\n) and not /tmp/go-build*) and\nprocess.args:(hostname or id or ifconfig or ls or netstat or ps or pwd or route or top or uptime or whoami) and\nnot (process.name:\n  (apt or dnf or docker or dockerd or dpkg or hostname or id or ls or netstat or ps or pwd or rpm or snap or\n  snapd or sudo or top or uptime or which or whoami or yum) or\nprocess.parent.executable:(\n  /opt/cassandra/bin/cassandra or /opt/nessus/sbin/nessusd or /opt/nessus_agent/sbin/nessus-agent-module or /opt/puppetlabs/puppet/bin/puppet or\n  /opt/puppetlabs/puppet/bin/ruby or /usr/libexec/platform-python or /usr/local/cloudamize/bin/CCAgent or /usr/sbin/sshd or /bin/* or\n  /etc/network/* or /opt/Elastic/* or /opt/TrendMicro* or /opt/aws/* or /opt/eset/* or /opt/rapid7/* or /run/containerd/* or /run/k3s/* or\n  /snap/* or /tmp/dpkg-licenses* or /tmp/newroot/* or /usr/bin/* or /var/lib/amagent/* or /var/lib/docker/* or /vz/*\n  ) or\n  process.executable:(/run/containerd/* or /srv/snp/docker/* or /tmp/.criu*)\n)",
        "new_terms_fields": [
          "process.parent.executable"
        ],
        "history_window_start": "now-14d",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Service Path Modification",
        "description": "Identifies attempts to modify a service path by an unusual process. Attackers may attempt to modify existing services for persistence or privilege escalation.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 105,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Rule Type: BBR",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1112",
                "name": "Modify Registry",
                "reference": "https://attack.mitre.org/techniques/T1112/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1543",
                "name": "Create or Modify System Process",
                "reference": "https://attack.mitre.org/techniques/T1543/",
                "subtechnique": [
                  {
                    "id": "T1543.003",
                    "name": "Windows Service",
                    "reference": "https://attack.mitre.org/techniques/T1543/003/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1543",
                "name": "Create or Modify System Process",
                "reference": "https://attack.mitre.org/techniques/T1543/",
                "subtechnique": [
                  {
                    "id": "T1543.003",
                    "name": "Windows Service",
                    "reference": "https://attack.mitre.org/techniques/T1543/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.path",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "8a85098a-b1d6-4607-b1d1-0eaeb6e65cb0",
        "rule_id": "f243fe39-83a4-46f3-a3b6-707557a102df",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:14.571Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:17:09.949Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "registry where host.os.type == \"windows\" and event.type == \"change\" and\n  registry.path : (\n    \"HKLM\\\\SYSTEM\\\\*ControlSet*\\\\Services\\\\*\\\\ImagePath\",\n    \"\\\\REGISTRY\\\\MACHINE\\\\SYSTEM\\\\*ControlSet*\\\\Services\\\\*\\\\ImagePath\"\n  ) and not (\n    process.executable : (\n      \"?:\\\\Program Files\\\\*.exe\",\n      \"?:\\\\Program Files (x86)\\\\*.exe\",\n      \"?:\\\\Windows\\\\System32\\\\services.exe\",\n      \"?:\\\\Windows\\\\WinSxS\\\\*\"\n    )\n  )",
        "language": "eql",
        "index": [
          "logs-endpoint.events.registry-*",
          "endgame-*",
          "logs-windows.sysmon_operational-*",
          "winlogbeat-*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious Network Connection via systemd",
        "description": "Detects suspicious network events executed by systemd, potentially indicating persistence through a systemd backdoor. Systemd is a system and service manager for Linux operating systems, used to initialize and manage system processes. Attackers can backdoor systemd for persistence by creating or modifying systemd unit files to execute malicious scripts or commands, or by replacing legitimate systemd binaries with compromised ones, ensuring that their malicious code is automatically executed at system startup or during certain system events.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 3,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Tactic: Command and Control",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1543",
                "name": "Create or Modify System Process",
                "reference": "https://attack.mitre.org/techniques/T1543/",
                "subtechnique": [
                  {
                    "id": "T1543.002",
                    "name": "Systemd Service",
                    "reference": "https://attack.mitre.org/techniques/T1543/002/"
                  }
                ]
              },
              {
                "id": "T1574",
                "name": "Hijack Execution Flow",
                "reference": "https://attack.mitre.org/techniques/T1574/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0011",
              "name": "Command and Control",
              "reference": "https://attack.mitre.org/tactics/TA0011/"
            }
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            }
          }
        ],
        "setup": "## Setup\n\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "66050503-b9bf-47aa-9c77-408113fe06fb",
        "rule_id": "f3818c85-2207-4b51-8a28-d70fb156ee87",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:14.574Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:17:09.983Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by host.id with maxspan=5s\n  [process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and\n   process.parent.name == \"systemd\" and process.name in (\n     \"python*\", \"php*\", \"perl\", \"ruby\", \"lua*\", \"openssl\", \"nc\", \"netcat\", \"ncat\", \"telnet\", \"awk\"\n   )\n  ] by process.entity_id\n  [network where host.os.type == \"linux\" and event.action == \"connection_attempted\" and event.type == \"start\" and\n   not process.executable == \"/tmp/newroot/bin/curl\"] by process.parent.entity_id",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Potential curl CVE-2023-38545 Exploitation",
        "description": "Detects potential exploitation of curl CVE-2023-38545 by monitoring for vulnerable command line arguments in conjunction with an unusual command line length. A flaw in curl version <= 8.3 makes curl vulnerable to a heap based buffer overflow during the SOCKS5 proxy handshake. Upgrade to curl version >= 8.4 to patch this vulnerability. This exploit can be executed with and without the use of environment variables. For increased visibility, enable the collection of http_proxy, HTTPS_PROXY and ALL_PROXY environment variables based on the instructions provided in the setup guide of this rule.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 6,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Use Case: Vulnerability",
          "Tactic: Execution",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://curl.se/docs/CVE-2023-38545.html",
          "https://daniel.haxx.se/blog/2023/10/11/curl-8-4-0/",
          "https://twitter.com/_JohnHammond/status/1711986412554531015"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1203",
                "name": "Exploitation for Client Execution",
                "reference": "https://attack.mitre.org/techniques/T1203/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\nElastic Defend integration does not collect environment variable logging by default.\nIn order to capture this behavior, this rule requires a specific configuration option set within the advanced settings of the Elastic Defend integration.\n #### To set up environment variable capture for an Elastic Agent policy:\n- Go to â€œSecurity â†’ Manage â†’ Policiesâ€.\n- Select an â€œElastic Agent policyâ€.\n- Click â€œShow advanced settingsâ€.\n- Scroll down or search for â€œlinux.advanced.capture_env_varsâ€.\n- Enter the names of environment variables you want to capture, separated by commas.\n- For this rule the linux.advanced.capture_env_vars variable should be set to \"http_proxy,HTTPS_PROXY,ALL_PROXY\".\n- Click â€œSaveâ€.\nAfter saving the integration change, the Elastic Agents running this policy will be updated and the rule will function properly.\nFor more information on capturing environment variables refer to the [helper guide](https://www.elastic.co/guide/en/security/current/environment-variable-capture.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.env_vars",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "3bfda88f-f8cf-4b6b-89e5-7403b91a0c86",
        "rule_id": "f41296b4-9975-44d6-9486-514c6f635b2d",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:14.577Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:17:09.995Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and process.name == \"curl\" \nand (\n  process.args like (\"--socks5-hostname\", \"--proxy\", \"--preproxy\", \"socks5*\") or \n  process.env_vars like (\"http_proxy=socks5h://*\", \"HTTPS_PROXY=socks5h://*\", \"ALL_PROXY=socks5h://*\")\n) and length(process.command_line) > 255 and not (\n  process.parent.name in (\"cf-agent\", \"agent-run\", \"agent-check\", \"rudder\", \"agent-inventory\", \"cf-execd\") or\n  process.args like \"/opt/rudder/*\" or\n  process.parent.executable like (\"/vz/root/*\", \"/var/rudder/*\")\n)",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "DPKG Package Installed by Unusual Parent Process",
        "description": "This rule detects the installation of a Debian package (dpkg) by an unusual parent process. The dpkg command is used to install, remove, and manage Debian packages on a Linux system. Attackers can abuse the dpkg command to install malicious packages on a system.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 2,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.makeuseof.com/how-deb-packages-are-backdoored-how-to-detect-it/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1543",
                "name": "Create or Modify System Process",
                "reference": "https://attack.mitre.org/techniques/T1543/"
              },
              {
                "id": "T1546",
                "name": "Event Triggered Execution",
                "reference": "https://attack.mitre.org/techniques/T1546/",
                "subtechnique": [
                  {
                    "id": "T1546.016",
                    "name": "Installer Packages",
                    "reference": "https://attack.mitre.org/techniques/T1546/016/"
                  }
                ]
              },
              {
                "id": "T1574",
                "name": "Hijack Execution Flow",
                "reference": "https://attack.mitre.org/techniques/T1574/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1195",
                "name": "Supply Chain Compromise",
                "reference": "https://attack.mitre.org/techniques/T1195/",
                "subtechnique": [
                  {
                    "id": "T1195.002",
                    "name": "Compromise Software Supply Chain",
                    "reference": "https://attack.mitre.org/techniques/T1195/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "2282fc39-8aed-49e2-bad2-e0664829abd4",
        "rule_id": "f4d1c0ac-aedb-4063-9fa6-cc651eb5e6ee",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:14.580Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:17:10.019Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "host.os.type:linux and event.category:process and event.type:start and event.action:exec and process.name:dpkg and\nprocess.args:(\"-i\" or \"--install\")",
        "new_terms_fields": [
          "process.parent.executable"
        ],
        "history_window_start": "now-7d",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "WMIC Remote Command",
        "description": "Identifies the use of wmic.exe to run commands on remote hosts. While this can be used by administrators legitimately, attackers can abuse this built-in utility to achieve lateral movement.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 107,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Lateral Movement",
          "Data Source: Elastic Defend",
          "Rule Type: BBR",
          "Data Source: Sysmon",
          "Data Source: Elastic Endgame",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1021",
                "name": "Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1021/",
                "subtechnique": [
                  {
                    "id": "T1021.006",
                    "name": "Windows Remote Management",
                    "reference": "https://attack.mitre.org/techniques/T1021/006/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1047",
                "name": "Windows Management Instrumentation",
                "reference": "https://attack.mitre.org/techniques/T1047/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "42414ede-a802-48e2-a347-50e009192735",
        "rule_id": "f59668de-caa0-4b84-94c1-3a1549e1e798",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:14.583Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:17:10.035Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.name : \"WMIC.exe\" and\n  process.args : \"*node:*\" and\n  process.args : (\"call\", \"set\", \"get\") and\n  not process.args : (\"*/node:localhost*\", \"*/node:\\\"127.0.0.1\\\"*\", \"/node:127.0.0.1\")",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "winlogbeat-*"
        ],
        "filters": []
      },
      {
        "name": "Setcap setuid/setgid Capability Set",
        "description": "This rule monitors for the addition of the cap_setuid+ep or cap_setgid+ep capabilities via setcap. Setuid (Set User ID) and setgid (Set Group ID) are Unix-like OS features that enable processes to run with elevated privileges, based on the file owner or group. Threat actors can exploit these attributes to achieve persistence by creating malicious binaries, allowing them to maintain control over a compromised system with elevated permissions.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Setcap setuid/setgid Capability Set\n\nSetuid (Set User ID) and setgid (Set Group ID) are Unix-like OS features that enable processes to run with elevated privileges, based on the file owner or group.\n\nThreat actors can exploit these attributes to achieve persistence by creating malicious binaries, allowing them to maintain control over a compromised system with elevated permissions.\n\nThis rule monitors for the addition of the cap_setuid+ep or cap_setgid+ep capabilities via setcap.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n> This investigation guide uses [placeholder fields](https://www.elastic.co/guide/en/security/current/osquery-placeholder-fields.html) to dynamically pass alert data into Osquery queries. Placeholder fields were introduced in Elastic Stack version 8.7.0. If you're using Elastic Stack version 8.6.0 or earlier, you'll need to manually adjust this investigation guide's queries to ensure they properly run.\n\n#### Possible Investigation Steps\n\n- Investigate the file that was targeted by the addition of the setuid/setgid capability through OSQuery.\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence and whether they are located in expected locations.\n  - !{osquery{\"label\":\"Osquery - Retrieve Running Processes by User\",\"query\":\"SELECT pid, username, name FROM processes p JOIN users u ON u.uid = p.uid ORDER BY username\"}}\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Validate the activity is not related to planned patches, updates, network administrator activity, or legitimate software installations.\n- Investigate whether the altered scripts call other malicious scripts elsewhere on the file system. \n  - If scripts or executables were dropped, retrieve the files and determine if they are malicious:\n    - Use a private sandboxed malware analysis system to perform analysis.\n      - Observe and collect information about the following activities:\n        - Attempts to contact external domains and addresses.\n          - Check if the domain is newly registered or unexpected.\n          - Check the reputation of the domain or IP address.\n        - File access, modification, and creation activities.\n        - Cron jobs, services and other persistence mechanisms.\n            - !{osquery{\"label\":\"Osquery - Retrieve Crontab Information\",\"query\":\"SELECT * FROM crontab\"}}\n- Investigate abnormal behaviors by the subject process/user such as network connections, file modifications, and any other spawned child processes.\n  - Investigate listening ports and open sockets to look for potential command and control traffic or data exfiltration.\n    - !{osquery{\"label\":\"Osquery - Retrieve Listening Ports\",\"query\":\"SELECT pid, address, port, socket, protocol, path FROM listening_ports\"}}\n    - !{osquery{\"label\":\"Osquery - Retrieve Open Sockets\",\"query\":\"SELECT pid, family, remote_address, remote_port, socket, state FROM process_open_sockets\"}}\n  - Identify the user account that performed the action, analyze it, and check whether it should perform this kind of action.\n    - !{osquery{\"label\":\"Osquery - Retrieve Information for a Specific User\",\"query\":\"SELECT * FROM users WHERE username = {{user.name}}\"}}\n- Investigate whether the user is currently logged in and active.\n    - !{osquery{\"label\":\"Osquery - Investigate the Account Authentication Status\",\"query\":\"SELECT * FROM logged_in_users WHERE user = {{user.name}}\"}}\n\n### False Positive Analysis\n\n- If this activity is related to new benign software installation activity, consider adding exceptions â€” preferably with a combination of user and command line conditions.\n- If this activity is related to a system administrator that performed these actions for administrative purposes, consider adding exceptions for this specific administrator user account. \n- Try to understand the context of the execution by thinking about the user, machine, or business purpose. A small number of endpoints, such as servers with unique software, might appear unusual but satisfy a specific business need.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Leverage the incident response data and logging to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 6,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            }
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1548",
                "name": "Abuse Elevation Control Mechanism",
                "reference": "https://attack.mitre.org/techniques/T1548/",
                "subtechnique": [
                  {
                    "id": "T1548.001",
                    "name": "Setuid and Setgid",
                    "reference": "https://attack.mitre.org/techniques/T1548/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "3e16dd22-07be-40ed-8806-40b3f41a891e",
        "rule_id": "f5c005d3-4e17-48b0-9cd7-444d48857f97",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:14.586Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:17:10.040Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"linux\" and event.type == \"start\" and event.action in (\"exec\", \"exec_event\") and \nprocess.name == \"setcap\" and process.args : \"cap_set?id+ep\" and not (\n  process.parent.name in (\"jem\", \"vzctl\") or\n  process.args like \"/usr/bin/new?idmap\"\n)",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*",
          "endgame-*"
        ],
        "filters": []
      },
      {
        "name": "Masquerading Space After Filename",
        "description": "This rules identifies a process created from an executable with a space appended to the end of the filename. This may indicate an attempt to masquerade a malicious file as benign to gain user execution. When a space is added to the end of certain files, the OS will execute the file according to it's true filetype instead of it's extension. Adversaries can hide a program's true filetype by changing the extension of the file. They can then add a space to the end of the name so that the OS automatically executes the file when it's double-clicked.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 7,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "OS: macOS",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.picussecurity.com/resource/blog/picus-10-critical-mitre-attck-techniques-t1036-masquerading"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1036",
                "name": "Masquerading",
                "reference": "https://attack.mitre.org/techniques/T1036/",
                "subtechnique": [
                  {
                    "id": "T1036.006",
                    "name": "Space after Filename",
                    "reference": "https://attack.mitre.org/techniques/T1036/006/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.args",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "e27817dd-f3ec-4a12-acdd-f7959fcc8864",
        "rule_id": "f5fb4598-4f10-11ed-bdc3-0242ac120002",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:14.589Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:17:10.045Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type:(\"linux\",\"macos\") and event.type == \"start\" and\nprocess.executable regex~ \"\"\"/[a-z0-9\\s_\\-\\\\./]+\\s\"\"\" and not (\n  process.name in (\"ls\", \"find\", \"grep\", \"xkbcomp\") or\n  process.executable like (\"/opt/nessus_agent/*\", \"/opt/gitlab/sv/gitlab-exporter/*\", \"/tmp/ansible-admin/*\") or\n  process.parent.args in (\n    \"./check_rubrik\", \"/usr/bin/check_mk_agent\", \"/etc/rubrik/start_stop_bootstrap.sh\", \"/etc/rubrik/start_stop_agent.sh\"\n  )\n)",
        "language": "eql",
        "index": [
          "auditbeat-*",
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Potential Privilege Escalation via Linux DAC permissions",
        "description": "Identifies potential privilege escalation exploitation of DAC (Discretionary access control) file permissions. The rule identifies exploitation of DAC checks on sensitive file paths via suspicious processes whose capabilities include CAP_DAC_OVERRIDE (where a process can bypass all read write and execution checks) or CAP_DAC_READ_SEARCH (where a process can read any file or perform any executable permission on the directories).",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 3,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1068",
                "name": "Exploitation for Privilege Escalation",
                "reference": "https://attack.mitre.org/techniques/T1068/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.thread.capabilities.effective",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.thread.capabilities.permitted",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "b71dc845-e214-400f-a9c6-29900918f6ba",
        "rule_id": "f7c70f2e-4616-439c-85ac-5b98415042fe",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:14.592Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:17:10.094Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "event.category:process and host.os.type:linux and event.type:start and event.action:exec and\n(process.thread.capabilities.permitted:CAP_DAC_* or process.thread.capabilities.effective: CAP_DAC_*) and\nprocess.command_line:(*sudoers* or *passwd* or *shadow* or */root/*) and not (\n  user.id : \"0\" or\n  process.name : (\n    \"tar\" or \"getent\" or \"su\" or \"stat\" or \"dirname\" or \"chown\" or \"sudo\" or \"dpkg-split\" or \"dpkg-deb\" or \"dpkg\" or\n    \"podman\" or \"awk\" or \"passwd\" or \"dpkg-maintscript-helper\" or \"mutt_dotlock\" or \"nscd\" or \"logger\" or \"gpasswd\"\n  ) or\n  process.executable : /usr/lib/*/lxc/rootfs/* or\n  process.parent.name : (\n    \"dpkg\" or \"java\" or *postinst or \"dpkg-preconfigure\" or \"gnome-shell\"\n  )\n)",
        "new_terms_fields": [
          "process.executable"
        ],
        "history_window_start": "now-10d",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "First Occurrence of Personal Access Token (PAT) Use For a GitHub User",
        "description": "A new PAT was used for a GitHub user not previously seen in the last 14 days.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 204,
        "tags": [
          "Domain: Cloud",
          "Use Case: Threat Detection",
          "Use Case: UEBA",
          "Tactic: Persistence",
          "Rule Type: BBR",
          "Data Source: Github"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1098",
                "name": "Account Manipulation",
                "reference": "https://attack.mitre.org/techniques/T1098/",
                "subtechnique": [
                  {
                    "id": "T1098.001",
                    "name": "Additional Cloud Credentials",
                    "reference": "https://attack.mitre.org/techniques/T1098/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "github",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "github.hashed_token",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "github.programmatic_access_type",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "user.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "2fe91acf-54c7-4a5d-a2e6-2ef4a3163396",
        "rule_id": "f94e898e-94f1-4545-8923-03e4b2866211",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:14.595Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:17:10.114Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "event.dataset:\"github.audit\" and event.category:\"configuration\" and\ngithub.hashed_token:* and user.name:* and\ngithub.programmatic_access_type:(\"OAuth access token\" or \"Fine-grained personal access token\")",
        "new_terms_fields": [
          "user.name",
          "github.hashed_token"
        ],
        "history_window_start": "now-14d",
        "index": [
          "logs-github.audit-*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "High Number of Cloned GitHub Repos From PAT",
        "description": "Detects a high number of unique private repo clone events originating from a single personal access token within a short time period.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 204,
        "tags": [
          "Domain: Cloud",
          "Use Case: Threat Detection",
          "Use Case: UEBA",
          "Tactic: Execution",
          "Data Source: Github"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1648",
                "name": "Serverless Execution",
                "reference": "https://attack.mitre.org/techniques/T1648/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "github",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "github.programmatic_access_type",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "github.repository_public",
            "type": "boolean",
            "ecs": false
          }
        ],
        "id": "52a6e631-6b31-4904-beed-4d3d975cb62a",
        "rule_id": "fb0afac5-bbd6-49b0-b4f8-44e5381e1587",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:14.597Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:17:10.727Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "threshold",
        "query": "event.dataset:\"github.audit\" and event.category:\"configuration\" and event.action:\"git.clone\" and\ngithub.programmatic_access_type:(\"OAuth access token\" or \"Fine-grained personal access token\") and\ngithub.repository_public:false",
        "threshold": {
          "field": [
            "github.hashed_token"
          ],
          "value": 1,
          "cardinality": [
            {
              "field": "github.repo",
              "value": 10
            }
          ]
        },
        "index": [
          "logs-github.audit-*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "First Occurrence of IP Address For GitHub Personal Access Token (PAT)",
        "description": "Detects a new IP address used for a GitHub PAT not previously seen in the last 14 days.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 204,
        "tags": [
          "Domain: Cloud",
          "Use Case: Threat Detection",
          "Use Case: UEBA",
          "Tactic: Initial Access",
          "Rule Type: BBR",
          "Data Source: Github"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1078",
                "name": "Valid Accounts",
                "reference": "https://attack.mitre.org/techniques/T1078/",
                "subtechnique": [
                  {
                    "id": "T1078.004",
                    "name": "Cloud Accounts",
                    "reference": "https://attack.mitre.org/techniques/T1078/004/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "github",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "github.actor_ip",
            "type": "ip",
            "ecs": false
          },
          {
            "name": "github.hashed_token",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "github.programmatic_access_type",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "e9cf0024-e2f2-465a-9edc-f1a17f44c2f2",
        "rule_id": "fc909baa-fb34-4c46-9691-be276ef4234c",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:14.689Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:17:10.738Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "event.dataset:\"github.audit\" and event.category:\"configuration\" and\ngithub.actor_ip:* and github.hashed_token:* and\ngithub.programmatic_access_type:(\"OAuth access token\" or \"Fine-grained personal access token\")",
        "new_terms_fields": [
          "github.hashed_token",
          "github.actor_ip"
        ],
        "history_window_start": "now-14d",
        "index": [
          "logs-github.audit-*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "GitHub App Deleted",
        "description": "Detects the deletion of a GitHub app either from a repo or an organization.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 204,
        "tags": [
          "Domain: Cloud",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Data Source: Github"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1648",
                "name": "Serverless Execution",
                "reference": "https://attack.mitre.org/techniques/T1648/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "github",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "github.category",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "b91c83cb-564b-4608-baff-43cd0bee56f2",
        "rule_id": "fd01b949-81be-46d5-bcf8-284395d5f56d",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:15.042Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:17:10.748Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "configuration where event.dataset == \"github.audit\" and github.category == \"integration_installation\" and event.type == \"deletion\"",
        "language": "eql",
        "index": [
          "logs-github.audit-*"
        ],
        "filters": []
      },
      {
        "name": "Potential Sudo Token Manipulation via Process Injection",
        "description": "This rule detects potential sudo token manipulation attacks through process injection by monitoring the use of a debugger (gdb) process followed by a successful uid change event during the execution of the sudo process. A sudo token manipulation attack is performed by injecting into a process that has a valid sudo token, which can then be used by attackers to activate their own sudo token. This attack requires ptrace to be enabled in conjunction with the existence of a living process that has a valid sudo token with the same uid as the current user.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 107,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/nongiach/sudo_inject"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1055",
                "name": "Process Injection",
                "reference": "https://attack.mitre.org/techniques/T1055/",
                "subtechnique": [
                  {
                    "id": "T1055.008",
                    "name": "Ptrace System Calls",
                    "reference": "https://attack.mitre.org/techniques/T1055/008/"
                  }
                ]
              },
              {
                "id": "T1548",
                "name": "Abuse Elevation Control Mechanism",
                "reference": "https://attack.mitre.org/techniques/T1548/",
                "subtechnique": [
                  {
                    "id": "T1548.003",
                    "name": "Sudo and Sudo Caching",
                    "reference": "https://attack.mitre.org/techniques/T1548/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.group.id",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.session_leader.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "7f157427-e29e-488c-97bd-f882414f6125",
        "rule_id": "ff9bc8b9-f03b-4283-be58-ee0a16f5a11b",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:15.045Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:17:10.821Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by host.id, process.session_leader.entity_id with maxspan=15s\n[ process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and \n  process.name == \"gdb\" and process.user.id != \"0\" and process.group.id != \"0\" ]\n[ process where host.os.type == \"linux\" and event.action == \"uid_change\" and event.type == \"change\" and \n  process.name == \"sudo\" and process.user.id == \"0\" and process.group.id == \"0\" ]",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Unusual Instance Metadata Service (IMDS) API Request",
        "description": "This rule identifies potentially malicious processes attempting to access the cloud service provider's instance metadata service (IMDS) API endpoint, which can be used to retrieve sensitive instance-specific information such as instance ID, public IP address, and even temporary security credentials if role's are assumed by that instance. The rule monitors for various tools and scripts like curl, wget, python, and perl that might be used to interact with the metadata API.",
        "risk_score": 47,
        "severity": "medium",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 2,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Tactic: Discovery",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://hackingthe.cloud/aws/general-knowledge/intro_metadata_service/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1552",
                "name": "Unsecured Credentials",
                "reference": "https://attack.mitre.org/techniques/T1552/",
                "subtechnique": [
                  {
                    "id": "T1552.005",
                    "name": "Cloud Instance Metadata API",
                    "reference": "https://attack.mitre.org/techniques/T1552/005/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1580",
                "name": "Cloud Infrastructure Discovery",
                "reference": "https://attack.mitre.org/techniques/T1580/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.entity_id",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.working_directory",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "3cd01cf0-d177-4acb-8ddd-2cc7cf05aaea",
        "rule_id": "ecc0cd54-608e-11ef-ab6d-f661ea17fbce",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:15.053Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:17:08.997Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "sequence by host.id,  process.parent.entity_id with maxspan=1s\n[process where host.os.type == \"linux\" and event.type == \"start\" and event.action == \"exec\" and process.name : (\n    \"curl\", \"wget\", \"python*\", \"perl*\", \"php*\", \"ruby*\", \"lua*\", \"telnet\", \"pwsh\",\n    \"openssl\", \"nc\", \"ncat\", \"netcat\", \"awk\", \"gawk\", \"mawk\", \"nawk\", \"socat\", \"node\"\n    ) or process.executable : (\n      \"./*\", \"/tmp/*\", \"/var/tmp/*\", \"/var/www/*\", \"/dev/shm/*\", \"/etc/init.d/*\", \"/etc/rc*.d/*\",\n      \"/etc/cron*\", \"/etc/update-motd.d/*\", \"/boot/*\", \"/srv/*\", \"/run/*\", \"/etc/rc.local\"\n    ) or\n    process.command_line: \"*169.254.169.254*\" and\n    not (process.working_directory: (\n          \"/opt/rapid7*\",\n          \"/opt/nessus*\",\n          \"/snap/amazon-ssm-agent*\",\n          \"/var/snap/amazon-ssm-agent/*\",\n          \"/var/log/amazon/ssm/*\",\n          \"/srv/snp/docker/overlay2*\",\n          \"/opt/nessus_agent/var/nessus/*\") or\n        process.executable: (\n          \"/opt/rumble/bin/rumble-agent*\",\n          \"/opt/aws/inspector/bin/inspectorssmplugin\") or\n        process.parent.executable: (\n          \"/usr/bin/setup-policy-routes\",\n          \"/usr/share/ec2-instance-connect/*\",\n          \"/var/lib/amazon/ssm/*\")\n        )\n]\n[network where host.os.type == \"linux\"\n  and event.action == \"connection_attempted\"\n  and destination.ip == \"169.254.169.254\"]",
        "language": "eql",
        "index": [
          "logs-endpoint.events.*"
        ],
        "filters": []
      },
      {
        "name": "Attempt to Modify an Okta Policy Rule",
        "description": "Detects attempts to modify a rule within an Okta policy. An adversary may attempt to modify an Okta policy rule in order to weaken an organization's security controls.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Attempt to Modify an Okta Policy Rule\n\nThe modification of an Okta policy rule can be an indication of malicious activity as it may aim to weaken an organization's security controls.\n\n#### Possible investigation steps:\n\n- Identify the actor related to the alert by reviewing `okta.actor.id`, `okta.actor.type`, `okta.actor.alternate_id`, or `okta.actor.display_name` fields in the alert.\n- Review the `okta.client.user_agent.raw_user_agent` field to understand the device and software used by the actor.\n- Examine the `okta.outcome.reason` field for additional context around the modification attempt.\n- Check the `okta.outcome.result` field to confirm the rule modification attempt.\n- Check if there are multiple rule modification attempts from the same actor or IP address (`okta.client.ip`).\n- Check for successful logins immediately following the modification attempt.\n- Verify whether the actor's activity aligns with typical behavior or if any unusual activity took place around the time of the modification attempt.\n\n### False positive analysis:\n\n- Check if there were issues with the Okta system at the time of the modification attempt. This could indicate a system error rather than a genuine threat activity.\n- Check the geographical location (`okta.request.ip_chain.geographical_context`) and time of the modification attempt. If these match the actor's normal behavior, it might be a false positive.\n- Verify the actor's administrative rights to ensure they are correctly configured.\n\n### Response and remediation:\n\n- If unauthorized modification is confirmed, initiate the incident response process.\n- Immediately lock the affected actor account and require a password change.\n- Consider resetting MFA tokens for the actor and require re-enrollment.\n- Check if the compromised account was used to access or alter any sensitive data or systems.\n- If a specific modification technique was used, ensure your systems are patched or configured to prevent such techniques.\n- Assess the criticality of affected services and servers.\n- Work with your IT team to minimize the impact on users and maintain business continuity.\n- If multiple accounts are affected, consider a broader reset or audit of MFA tokens.\n- Implement security best practices [outlined](https://www.okta.com/blog/2019/10/9-admin-best-practices-to-keep-your-org-secure/) by Okta.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).",
        "output_index": "",
        "version": 411,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Tactic: Defense Evasion",
          "Data Source: Okta"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Consider adding exceptions to this rule to filter false positives if Okta MFA rules are regularly modified in your organization."
        ],
        "references": [
          "https://help.okta.com/en/prod/Content/Topics/Security/Security_Policies.htm",
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.007",
                    "name": "Disable or Modify Cloud Firewall",
                    "reference": "https://attack.mitre.org/techniques/T1562/007/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "34d664f9-d3f5-484e-ab5c-a76f693bf9d4",
        "rule_id": "000047bb-b27a-47ec-8b62-ef1a5d2c9e19",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:15.057Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:38.119Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset:okta.system and event.action:policy.rule.update",
        "language": "kuery"
      },
      {
        "name": "Suspicious Activity Reported by Okta User",
        "description": "Detects when a user reports suspicious activity for their Okta account. These events should be investigated, as they can help security teams identify when an adversary is attempting to gain access to their network.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 409,
        "tags": [
          "Use Case: Identity and Access Audit",
          "Data Source: Okta",
          "Tactic: Initial Access"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-360s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "A user may report suspicious activity on their Okta account in error."
        ],
        "references": [
          "https://developer.okta.com/docs/reference/api/system-log/",
          "https://developer.okta.com/docs/reference/api/event-types/",
          "https://www.elastic.co/security-labs/testing-okta-visibility-and-detection-dorothy",
          "https://www.elastic.co/security-labs/monitoring-okta-threats-with-elastic-security",
          "https://www.elastic.co/security-labs/starter-guide-to-understanding-okta"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0001",
              "name": "Initial Access",
              "reference": "https://attack.mitre.org/tactics/TA0001/"
            },
            "technique": [
              {
                "id": "T1078",
                "name": "Valid Accounts",
                "reference": "https://attack.mitre.org/techniques/T1078/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1078",
                "name": "Valid Accounts",
                "reference": "https://attack.mitre.org/techniques/T1078/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1078",
                "name": "Valid Accounts",
                "reference": "https://attack.mitre.org/techniques/T1078/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1078",
                "name": "Valid Accounts",
                "reference": "https://attack.mitre.org/techniques/T1078/"
              }
            ]
          }
        ],
        "setup": "The Okta Fleet integration, Filebeat module, or similarly structured data is required to be compatible with this rule.",
        "related_integrations": [
          {
            "package": "okta",
            "version": "^3.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.dataset",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "4b615067-6c7b-46c0-a4d0-88129f842a0d",
        "rule_id": "f994964f-6fce-4d75-8e79-e16ccc412588",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:15.060Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:17:10.130Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "filebeat-*",
          "logs-okta*"
        ],
        "filters": [],
        "query": "event.dataset:okta.system and event.action:user.account.report_suspicious_activity_by_enduser",
        "language": "kuery"
      },
      {
        "name": "System Binary Moved or Copied",
        "description": "This rule monitors for the copying or moving of a system binary. Adversaries may copy/move and rename system binaries to evade detection. Copying a system binary to a different location should not occur often, so if it does, the activity should be investigated.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 13,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://intezer.com/blog/research/kaiji-new-chinese-linux-malware-turning-to-golang/",
          "https://www.elastic.co/security-labs/sequel-on-persistence-mechanisms"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1036",
                "name": "Masquerading",
                "reference": "https://attack.mitre.org/techniques/T1036/",
                "subtechnique": [
                  {
                    "id": "T1036.003",
                    "name": "Rename System Utilities",
                    "reference": "https://attack.mitre.org/techniques/T1036/003/"
                  }
                ]
              },
              {
                "id": "T1564",
                "name": "Hide Artifacts",
                "reference": "https://attack.mitre.org/techniques/T1564/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.Ext.original.extension",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "file.Ext.original.path",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "ce6a2e83-1a40-4487-8bb8-74520c8d877c",
        "rule_id": "fda1d332-5e08-4f27-8a9b-8c802e3292a6",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:15.064Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:17:10.772Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"linux\" and event.type == \"change\" and event.action == \"rename\" and process.name != null and\nfile.Ext.original.path : (\n  \"/bin/*\", \"/usr/bin/*\", \"/usr/local/bin/*\", \"/sbin/*\", \"/usr/sbin/*\", \"/usr/local/sbin/*\"\n) and not (\n  process.executable in (\n    \"/bin/dpkg\", \"/usr/bin/dpkg\", \"/bin/dockerd\", \"/usr/bin/dockerd\", \"/usr/sbin/dockerd\", \"/bin/microdnf\",\n    \"/usr/bin/microdnf\", \"/bin/rpm\", \"/usr/bin/rpm\", \"/bin/snapd\", \"/usr/bin/snapd\", \"/bin/yum\", \"/usr/bin/yum\",\n    \"/bin/dnf\", \"/usr/bin/dnf\", \"/bin/podman\", \"/usr/bin/podman\", \"/bin/dnf-automatic\", \"/usr/bin/dnf-automatic\",\n    \"/bin/pacman\", \"/usr/bin/pacman\", \"/usr/bin/dpkg-divert\", \"/bin/dpkg-divert\", \"/sbin/apk\", \"/usr/sbin/apk\",\n    \"/usr/local/sbin/apk\", \"/usr/bin/apt\", \"/usr/sbin/pacman\", \"/bin/podman\", \"/usr/bin/podman\", \"/usr/bin/puppet\",\n    \"/bin/puppet\", \"/opt/puppetlabs/puppet/bin/puppet\", \"/usr/bin/chef-client\", \"/bin/chef-client\",\n    \"/bin/autossl_check\", \"/usr/bin/autossl_check\", \"/proc/self/exe\", \"/dev/fd/*\",  \"/usr/bin/pamac-daemon\",\n    \"/bin/pamac-daemon\", \"/usr/lib/snapd/snapd\", \"/usr/local/bin/dockerd\", \"/usr/libexec/netplan/generate\",\n    \"/usr/bin/update-alternatives\", \"/bin/update-alternatives\", \"/usr/sbin/update-alternatives\",\n    \"/sbin/update-alternatives\", \"/usr/bin/pip3\", \"/bin/pip3\", \"/usr/local/bin/pip3\", \"/usr/local/bin/node\",\n    \"/bin/node\", \"/usr/bin/node\", \"/sbin/apk\", \"/usr/sbin/apk\", \"/usr/local/sbin/apk\", \"/usr/bin/pip\", \"/bin/pip\",\n    \"/usr/local/bin/pip\", \"/usr/libexec/platform-python\", \"/usr/bin/platform-python\", \"/bin/platform-python\",\n    \"/usr/lib/systemd/systemd\", \"/usr/sbin/sshd\", \"/sbin/sshd\", \"/usr/local/sbin/sshd\", \"/usr/sbin/crond\", \"/sbin/crond\",\n    \"/usr/local/sbin/crond\", \"/usr/sbin/gdm\"\n  ) or\n  process.name like (\n    \"python*\", \"packagekitd\", \"systemd\", \"ln\", \"platform-python\", \"dnf_install\", \"runc\", \"apt-get\", \"ssm-agent-worker\",\n    \"convert-usrmerge\", \"updatenow.static-cpanelsync\", \"apk\", \"exe\", \"php\", \"containerd-shim-runc-v2\", \"dpkg\", \"sed\",\n    \"platform-python*\", \"gedit\", \"crond\", \"sshd\", \"ruby\", \"sudo\", \"chainctl\", \"update-alternatives\", \"pip*\"\n  ) or\n  file.Ext.original.path : (\n    \"/bin/*.tmp\", \"/usr/bin/*.tmp\", \"/usr/local/bin/*.tmp\", \"/sbin/*.tmp\", \"/usr/sbin/*.tmp\", \"/usr/local/sbin/*.tmp\"\n  ) or\n  file.extension in (\"swp\", \"swpx\", \"swx\", \"dpkg-remove\") or\n  file.Ext.original.extension == \"dpkg-new\" or\n  process.executable : (\"/nix/store/*\", \"/var/lib/dpkg/*\", \"/tmp/vmis.*\", \"/snap/*\", \"/dev/fd/*\") or\n  process.executable == null or\n  (process.name == \"sed\" and file.name : \"sed*\") or\n  (process.name == \"perl\" and file.name : \"e2scrub_all.tmp*\") \n)",
        "language": "eql",
        "index": [
          "logs-endpoint.events.file*"
        ],
        "filters": []
      },
      {
        "name": "Cron Job Created or Modified",
        "description": "This rule monitors for (ana)cron jobs being created or renamed. Linux cron jobs are scheduled tasks that can be leveraged by system administrators to set up scheduled tasks, but may be abused by malicious actors for persistence, privilege escalation and command execution. By creating or modifying cron job configurations, attackers can execute malicious commands or scripts at predefined intervals, ensuring their continued presence and enabling unauthorized activities.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Cron Job Created or Modified\nLinux cron jobs are scheduled tasks that run at specified intervals or times, managed by the cron daemon. \n\nBy creating or modifying cron job configurations, attackers can execute malicious commands or scripts at predefined intervals, ensuring their continued presence and enabling unauthorized activities.\n\nThis rule monitors the creation of cron jobs by monitoring for file creation and rename events in the most common cron job task location directories.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n> This investigation guide uses [placeholder fields](https://www.elastic.co/guide/en/security/current/osquery-placeholder-fields.html) to dynamically pass alert data into Osquery queries. Placeholder fields were introduced in Elastic Stack version 8.7.0. If you're using Elastic Stack version 8.6.0 or earlier, you'll need to manually adjust this investigation guide's queries to ensure they properly run.\n\n#### Possible Investigation Steps\n\n- Investigate the cron job file that was created or modified.\n- Investigate whether any other files in any of the available cron job directories have been altered through OSQuery.\n  - !{osquery{\"label\":\"Osquery - Retrieve File Listing Information\",\"query\":\"SELECT * FROM file WHERE (path LIKE '/etc/cron.allow.d/%' OR path LIKE '/etc/cron.d/%' OR path LIKE '/etc/cron.hourly/%'\\nOR path LIKE '/etc/cron.daily/%' OR path LIKE '/etc/cron.weekly/%' OR path LIKE '/etc/cron.monthly/%' OR path LIKE\\n'/var/spool/cron/crontabs/%')\\n\"}}\n  - !{osquery{\"label\":\"Osquery - Retrieve Cron File Information\",\"query\":\"SELECT * FROM file WHERE (path = '/etc/cron.allow' OR path = '/etc/cron.deny' OR path = '/etc/crontab')\\n\"}}\n  - !{osquery{\"label\":\"Osquery - Retrieve Additional File Listing Information\",\"query\":\"SELECT f.path, u.username AS file_owner, g.groupname AS group_owner, datetime(f.atime, 'unixepoch') AS\\nfile_last_access_time, datetime(f.mtime, 'unixepoch') AS file_last_modified_time, datetime(f.ctime, 'unixepoch') AS\\nfile_last_status_change_time, datetime(f.btime, 'unixepoch') AS file_created_time, f.size AS size_bytes FROM file f LEFT\\nJOIN users u ON f.uid = u.uid LEFT JOIN groups g ON f.gid = g.gid WHERE ( path LIKE '/etc/cron.allow.d/%' OR path LIKE\\n'/etc/cron.d/%' OR path LIKE '/etc/cron.hourly/%' OR path LIKE '/etc/cron.daily/%' OR path LIKE '/etc/cron.weekly/%' OR\\npath LIKE '/etc/cron.monthly/%' OR path LIKE '/var/spool/cron/crontabs/%')\\n\"}}\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence and whether they are located in expected locations.\n  - !{osquery{\"label\":\"Osquery - Retrieve Running Processes by User\",\"query\":\"SELECT pid, username, name FROM processes p JOIN users u ON u.uid = p.uid ORDER BY username\"}}\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Validate the activity is not related to planned patches, updates, network administrator activity, or legitimate software installations.\n- Investigate whether the altered scripts call other malicious scripts elsewhere on the file system. \n  - If scripts or executables were dropped, retrieve the files and determine if they are malicious:\n    - Use a private sandboxed malware analysis system to perform analysis.\n      - Observe and collect information about the following activities:\n        - Attempts to contact external domains and addresses.\n          - Check if the domain is newly registered or unexpected.\n          - Check the reputation of the domain or IP address.\n        - File access, modification, and creation activities.\n- Investigate abnormal behaviors by the subject process/user such as network connections, file modifications, and any other spawned child processes.\n  - Investigate listening ports and open sockets to look for potential command and control traffic or data exfiltration.\n    - !{osquery{\"label\":\"Osquery - Retrieve Listening Ports\",\"query\":\"SELECT pid, address, port, socket, protocol, path FROM listening_ports\"}}\n    - !{osquery{\"label\":\"Osquery - Retrieve Open Sockets\",\"query\":\"SELECT pid, family, remote_address, remote_port, socket, state FROM process_open_sockets\"}}\n  - Identify the user account that performed the action, analyze it, and check whether it should perform this kind of action.\n    - !{osquery{\"label\":\"Osquery - Retrieve Information for a Specific User\",\"query\":\"SELECT * FROM users WHERE username = {{user.name}}\"}}\n- Investigate whether the user is currently logged in and active.\n    - !{osquery{\"label\":\"Osquery - Investigate the Account Authentication Status\",\"query\":\"SELECT * FROM logged_in_users WHERE user = {{user.name}}\"}}\n\n### False Positive Analysis\n\n- If this activity is related to new benign software installation activity, consider adding exceptions â€” preferably with a combination of user and command line conditions.\n- If this activity is related to a system administrator who uses cron jobs for administrative purposes, consider adding exceptions for this specific administrator user account. \n- Try to understand the context of the execution by thinking about the user, machine, or business purpose. A small number of endpoints, such as servers with unique software, might appear unusual but satisfy a specific business need.\n\n### Related Rules\n\n- Suspicious File Creation in /etc for Persistence - 1c84dd64-7e6c-4bad-ac73-a5014ee37042\n- Potential Persistence Through Run Control Detected - 0f4d35e4-925e-4959-ab24-911be207ee6f\n- Potential Persistence Through init.d Detected - 474fd20e-14cc-49c5-8160-d9ab4ba16c8b\n- Systemd Timer Created - 7fb500fa-8e24-4bd1-9480-2a819352602c\n- Systemd Service Created - 17b0a495-4d9f-414c-8ad0-92f018b8e001\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Delete the service/timer or restore its original configuration.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Leverage the incident response data and logging to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 14,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Tactic: Privilege Escalation",
          "Tactic: Execution",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://pberba.github.io/security/2022/01/30/linux-threat-hunting-for-persistence-systemd-timers-cron/",
          "https://www.elastic.co/security-labs/primer-on-persistence-mechanisms"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1053",
                "name": "Scheduled Task/Job",
                "reference": "https://attack.mitre.org/techniques/T1053/",
                "subtechnique": [
                  {
                    "id": "T1053.003",
                    "name": "Cron",
                    "reference": "https://attack.mitre.org/techniques/T1053/003/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1053",
                "name": "Scheduled Task/Job",
                "reference": "https://attack.mitre.org/techniques/T1053/",
                "subtechnique": [
                  {
                    "id": "T1053.003",
                    "name": "Cron",
                    "reference": "https://attack.mitre.org/techniques/T1053/003/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1053",
                "name": "Scheduled Task/Job",
                "reference": "https://attack.mitre.org/techniques/T1053/",
                "subtechnique": [
                  {
                    "id": "T1053.003",
                    "name": "Cron",
                    "reference": "https://attack.mitre.org/techniques/T1053/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires data coming in from Elastic Defend.\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration on a Linux System:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/8.10/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.Ext.original.extension",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "file.extension",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "46ebfef5-7c89-47fc-a46d-a7ec31bb75da",
        "rule_id": "ff10d4d8-fea7-422d-afb1-e5a2702369a9",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:15.068Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:17:10.797Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "file where host.os.type == \"linux\" and\nevent.action in (\"rename\", \"creation\") and file.path : (\n  \"/etc/cron.allow\", \"/etc/cron.deny\", \"/etc/cron.d/*\", \"/etc/cron.hourly/*\", \"/etc/cron.daily/*\", \"/etc/cron.weekly/*\",\n  \"/etc/cron.monthly/*\", \"/etc/crontab\", \"/var/spool/cron/crontabs/*\", \"/var/spool/anacron/*\"\n) and not (\n  process.executable in (\n    \"/bin/dpkg\", \"/usr/bin/dpkg\", \"/bin/dockerd\", \"/usr/bin/dockerd\", \"/usr/sbin/dockerd\", \"/bin/microdnf\",\n    \"/usr/bin/microdnf\", \"/bin/rpm\", \"/usr/bin/rpm\", \"/bin/snapd\", \"/usr/bin/snapd\", \"/bin/yum\", \"/usr/bin/yum\",\n    \"/bin/dnf\", \"/usr/bin/dnf\", \"/bin/podman\", \"/usr/bin/podman\", \"/bin/dnf-automatic\", \"/usr/bin/dnf-automatic\",\n    \"/bin/pacman\", \"/usr/bin/pacman\", \"/usr/bin/dpkg-divert\", \"/bin/dpkg-divert\", \"/sbin/apk\", \"/usr/sbin/apk\",\n    \"/usr/local/sbin/apk\", \"/usr/bin/apt\", \"/usr/sbin/pacman\", \"/bin/podman\", \"/usr/bin/podman\", \"/usr/bin/puppet\",\n    \"/bin/puppet\", \"/opt/puppetlabs/puppet/bin/puppet\", \"/usr/bin/chef-client\", \"/bin/chef-client\",\n    \"/bin/autossl_check\", \"/usr/bin/autossl_check\", \"/proc/self/exe\", \"/dev/fd/*\",  \"/usr/bin/pamac-daemon\",\n    \"/bin/pamac-daemon\", \"/usr/local/bin/dockerd\", \"/opt/elasticbeanstalk/bin/platform-engine\",\n    \"/opt/puppetlabs/puppet/bin/ruby\", \"/usr/libexec/platform-python\", \"/opt/imunify360/venv/bin/python3\",\n    \"/opt/eset/efs/lib/utild\", \"/usr/sbin/anacron\", \"/usr/bin/podman\", \"/kaniko/kaniko-executor\"\n  ) or\n  file.path like (\"/var/spool/cron/crontabs/tmp.*\", \"/etc/cron.d/jumpcloud-updater\") or\n  file.extension in (\"swp\", \"swpx\", \"swx\", \"dpkg-remove\") or\n  file.Ext.original.extension == \"dpkg-new\" or\n  process.executable : (\n    \"/nix/store/*\", \"/var/lib/dpkg/*\", \"/tmp/vmis.*\", \"/snap/*\", \"/dev/fd/*\", \"/usr/libexec/platform-python*\"\n  ) or\n  process.executable == null or\n  process.name in (\n    \"crond\", \"executor\", \"puppet\", \"droplet-agent.postinst\", \"cf-agent\", \"schedd\", \"imunify-notifier\", \"perl\",\n    \"jumpcloud-agent\", \"crio\", \"dnf_install\", \"utild\"\n  ) or\n  (process.name == \"sed\" and file.name : \"sed*\") or\n  (process.name == \"perl\" and file.name : \"e2scrub_all.tmp*\") \n)",
        "language": "eql",
        "index": [
          "logs-endpoint.events.file*"
        ],
        "filters": []
      },
      {
        "name": "AWS Bedrock Guardrails Detected Multiple Policy Violations Within a Single Blocked Request",
        "description": "Identifies multiple violations of AWS Bedrock guardrails within a single request, resulting in a block action, increasing the likelihood of malicious intent. Multiple violations implies that a user may be intentionally attempting to cirvumvent security controls, access sensitive information, or possibly exploit a vulnerability in the system.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Amazon Bedrock Guardrail Multiple Policy Violations Within a Single Blocked Request.\n\nAmazon Bedrock Guardrail is a set of features within Amazon Bedrock designed to help businesses apply robust safety and privacy controls to their generative AI applications.\n\nIt enables users to set guidelines and filters that manage content quality, relevancy, and adherence to responsible AI practices.\n\nThrough Guardrail, organizations can define \"denied topics\" to prevent the model from generating content on specific, undesired subjects,\nand they can establish thresholds for harmful content categories, including hate speech, violence, or offensive language.\n\n#### Possible investigation steps\n\n- Identify the user account and the user request that caused multiple policy violations and whether it should perform this kind of action.\n- Investigate the user activity that might indicate a potential brute force attack.\n- Investigate other alerts associated with the user account during the past 48 hours.\n- Consider the time of day. If the user is a human (not a program or script), did the activity take place during a normal time of day?\n- Examine the account's prompts and responses in the last 24 hours.\n- If you suspect the account has been compromised, scope potentially compromised assets by tracking Amazon Bedrock model access, prompts generated, and responses to the prompts by the account in the last 24 hours.\n\n### False positive analysis\n\n- Verify the user account that caused multiple policy violations, is not testing any new model deployments or updated compliance policies in Amazon Bedrock guardrails.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Disable or limit the account during the investigation and response.\n- Identify the possible impact of the incident and prioritize accordingly; the following actions can help you gain context:\n    - Identify the account role in the cloud environment.\n    - Identify if the attacker is moving laterally and compromising other Amazon Bedrock Services.\n    - Identify any regulatory or legal ramifications related to this activity.\n- Review the permissions assigned to the implicated user group or role behind these requests to ensure they are authorized and expected to access bedrock and ensure that the least privilege principle is being followed.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection via the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 3,
        "tags": [
          "Domain: LLM",
          "Data Source: AWS Bedrock",
          "Data Source: AWS S3",
          "Resources: Investigation Guide",
          "Use Case: Policy Violation",
          "Mitre Atlas: T0051",
          "Mitre Atlas: T0054"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "10m",
        "from": "now-3600s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Legitimate misunderstanding by users or overly strict policies"
        ],
        "references": [
          "https://docs.aws.amazon.com/bedrock/latest/userguide/guardrails-components.html",
          "https://atlas.mitre.org/techniques/AML.T0051",
          "https://atlas.mitre.org/techniques/AML.T0054",
          "https://www.elastic.co/security-labs/elastic-advances-llm-security"
        ],
        "max_signals": 100,
        "threat": [],
        "setup": "## Setup\n\nThis rule requires that guardrails are configured in AWS Bedrock. For more information, see the AWS Bedrock documentation:\n\nhttps://docs.aws.amazon.com/bedrock/latest/userguide/guardrails-create.html\n",
        "related_integrations": [],
        "required_fields": [],
        "id": "0c63bb90-84a0-43dd-9f8c-6271e63ca5a0",
        "rule_id": "f4c2515a-18bb-47ce-a768-1dc4e7b0fe6c",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:15.384Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:17:10.006Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "esql",
        "language": "esql",
        "query": "from logs-aws_bedrock.invocation-*\n| where gen_ai.policy.action == \"BLOCKED\"\n| eval policy_violations = mv_count(gen_ai.policy.name)\n| where policy_violations > 1\n| keep gen_ai.policy.action, policy_violations, user.id, gen_ai.request.model.id, cloud.account.id, user.id\n| stats total_unique_request_violations = count(*) by policy_violations, user.id, gen_ai.request.model.id, cloud.account.id\n| sort total_unique_request_violations desc"
      },
      {
        "name": "System Shells via Services",
        "description": "Windows services typically run as SYSTEM and can be used as a privilege escalation opportunity. Malware or penetration testers may run a shell as a service to gain SYSTEM permissions.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating System Shells via Services\n\nAttackers may configure existing services or create new ones to execute system shells to elevate their privileges from administrator to SYSTEM. They can also configure services to execute these shells with persistence payloads.\n\nThis rule looks for system shells being spawned by `services.exe`, which is compatible with the above behavior.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify how the service was created or modified. Look for registry changes events or Windows events related to service activities (for example, 4697 and/or 7045).\n  - Examine the created and existent services, the executables or drivers referenced, and command line arguments for suspicious entries.\n    - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n    - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n    - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the referenced files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n- Check for commands executed under the spawned shell.\n\n### False positive analysis\n\n- This activity should not happen legitimately. The security team should address any potential benign true positive (B-TP), as this configuration can put the user and the domain at risk.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Delete the service or restore it to the original configuration.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 415,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Tactic: Execution",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: SentinelOne",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: System",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1543",
                "name": "Create or Modify System Process",
                "reference": "https://attack.mitre.org/techniques/T1543/",
                "subtechnique": [
                  {
                    "id": "T1543.003",
                    "name": "Windows Service",
                    "reference": "https://attack.mitre.org/techniques/T1543/003/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  },
                  {
                    "id": "T1059.003",
                    "name": "Windows Command Shell",
                    "reference": "https://attack.mitre.org/techniques/T1059/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "761d6293-816b-413b-bdae-13a15ed7ba4f",
        "rule_id": "0022d47d-39c7-4f69-a232-4fe9dc7a3acd",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:16.893Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:23.162Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  process.parent.name : \"services.exe\" and\n  process.name : (\"cmd.exe\", \"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\") and\n\n  /* Third party FP's */\n  not process.args : \"NVDisplay.ContainerLocalSystem\"",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.*",
          "endgame-*",
          "logs-system.security*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-m365_defender.event-*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Potential Credential Access via Windows Utilities",
        "description": "Identifies the execution of known Windows utilities often abused to dump LSASS memory or the Active Directory database (NTDS.dit) in preparation for credential access.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Potential Credential Access via Windows Utilities\n\nLocal Security Authority Server Service (LSASS) is a process in Microsoft Windows operating systems that is responsible for enforcing security policy on the system. It verifies users logging on to a Windows computer or server, handles password changes, and creates access tokens.\n\nThe `Ntds.dit` file is a database that stores Active Directory data, including information about user objects, groups, and group membership.\n\nThis rule looks for the execution of utilities that can extract credential data from the LSASS memory and Active Directory `Ntds.dit` file.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate abnormal behaviors observed by the subject process, such as network connections, registry or file modifications, and any spawned child processes.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Examine the command line to identify what information was targeted.\n- Identify the target computer and its role in the IT environment.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Any activity that triggered the alert and is not inherently malicious must be monitored by the security team.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- If the host is a domain controller (DC):\n  - Activate your incident response plan for total Active Directory compromise.\n  - Review the privileges assigned to users that can access the DCs, to ensure that the least privilege principle is being followed and to reduce the attack surface.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 315,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Tactic: Defense Evasion",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: SentinelOne",
          "Data Source: Sysmon"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://lolbas-project.github.io/",
          "https://www.elastic.co/security-labs/elastic-protects-against-data-wiper-malware-targeting-ukraine-hermeticwiper"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1003",
                "name": "OS Credential Dumping",
                "reference": "https://attack.mitre.org/techniques/T1003/",
                "subtechnique": [
                  {
                    "id": "T1003.001",
                    "name": "LSASS Memory",
                    "reference": "https://attack.mitre.org/techniques/T1003/001/"
                  },
                  {
                    "id": "T1003.003",
                    "name": "NTDS",
                    "reference": "https://attack.mitre.org/techniques/T1003/003/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1218",
                "name": "System Binary Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1218/",
                "subtechnique": [
                  {
                    "id": "T1218.011",
                    "name": "Rundll32",
                    "reference": "https://attack.mitre.org/techniques/T1218/011/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "03f3010e-6469-429e-88c1-0179caef3061",
        "rule_id": "00140285-b827-4aee-aa09-8113f58a08f3",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:16.896Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:23.156Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n(\n  (\n    (?process.pe.original_file_name : \"procdump\" or process.name : \"procdump.exe\") and process.args : \"-ma\"\n  ) or\n  (\n    process.name : \"ProcessDump.exe\" and not process.parent.executable regex~ \"\"\"C:\\\\Program Files( \\(x86\\))?\\\\Cisco Systems\\\\.*\"\"\"\n  ) or\n  (\n    (?process.pe.original_file_name : \"WriteMiniDump.exe\" or process.name : \"WriteMiniDump.exe\") and\n      not process.parent.executable regex~ \"\"\"C:\\\\Program Files( \\(x86\\))?\\\\Steam\\\\.*\"\"\"\n  ) or\n  (\n    (?process.pe.original_file_name : \"RUNDLL32.EXE\" or process.name : \"RUNDLL32.exe\") and\n      (process.args : \"MiniDump*\" or process.command_line : \"*comsvcs.dll*#24*\")\n  ) or\n  (\n    (?process.pe.original_file_name : \"RdrLeakDiag.exe\" or process.name : \"RdrLeakDiag.exe\") and\n      process.args : \"/fullmemdmp\"\n  ) or\n  (\n    (?process.pe.original_file_name : \"SqlDumper.exe\" or process.name : \"SqlDumper.exe\") and\n      process.args : \"0x01100*\") or\n  (\n    (?process.pe.original_file_name : \"TTTracer.exe\" or process.name : \"TTTracer.exe\") and\n      process.args : \"-dumpFull\" and process.args : \"-attach\") or\n  (\n    (?process.pe.original_file_name : \"ntdsutil.exe\" or process.name : \"ntdsutil.exe\") and\n      process.args : \"create*full*\") or\n  (\n    (?process.pe.original_file_name : \"diskshadow.exe\" or process.name : \"diskshadow.exe\") and process.args : \"/s\")\n)",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*"
        ],
        "filters": []
      },
      {
        "name": "Potential Cookies Theft via Browser Debugging",
        "description": "Identifies the execution of a Chromium based browser with the debugging process argument, which may indicate an attempt to steal authentication cookies. An adversary may steal web application or service session cookies and use them to gain access web applications or Internet services as an authenticated user without needing credentials.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 207,
        "tags": [
          "Domain: Endpoint",
          "OS: Linux",
          "OS: Windows",
          "OS: macOS",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Data Source: Elastic Defend"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "Developers performing browsers plugin or extension debugging."
        ],
        "references": [
          "https://github.com/defaultnamehere/cookie_crimes",
          "https://embracethered.com/blog/posts/2020/cookie-crimes-on-mirosoft-edge/",
          "https://github.com/rapid7/metasploit-framework/blob/master/documentation/modules/post/multi/gather/chrome_cookies.md",
          "https://posts.specterops.io/hands-in-the-cookie-jar-dumping-cookies-with-chromiums-remote-debugger-port-34c4f468844e"
        ],
        "max_signals": 33,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1539",
                "name": "Steal Web Session Cookie",
                "reference": "https://attack.mitre.org/techniques/T1539/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nIf enabling an EQL rule on a non-elastic-agent index (such as beats) for versions <8.2,\nevents will not define `event.ingested` and default fallback for EQL rules was not added until version 8.2.\nHence for this rule to work effectively, users will need to add a custom ingest pipeline to populate\n`event.ingested` to @timestamp.\nFor more details on adding a custom ingest pipeline refer - https://www.elastic.co/guide/en/fleet/current/data-streams-pipeline-tutorial.html\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "4f158119-9ce8-4c28-8293-7fcdfa6e2477",
        "rule_id": "027ff9ea-85e7-42e3-99d2-bbb7069e02eb",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:16.905Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:23.167Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where event.type in (\"start\", \"process_started\", \"info\") and\n  process.name in (\n             \"Microsoft Edge\",\n             \"chrome.exe\",\n             \"Google Chrome\",\n             \"google-chrome-stable\",\n             \"google-chrome-beta\",\n             \"google-chrome\",\n             \"msedge.exe\") and\n   process.args : (\"--remote-debugging-port=*\",\n                   \"--remote-debugging-targets=*\",\n                   \"--remote-debugging-pipe=*\") and\n   process.args : \"--user-data-dir=*\" and not process.args:\"--remote-debugging-port=0\"",
        "language": "eql",
        "index": [
          "auditbeat-*",
          "winlogbeat-*",
          "logs-endpoint.events.*",
          "logs-windows.*"
        ],
        "filters": []
      },
      {
        "name": "Unusual Windows User Calling the Metadata Service",
        "description": "Looks for anomalous access to the cloud platform metadata service by an unusual user. The metadata service may be targeted in order to harvest credentials or user data scripts containing secrets.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 206,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Rule Type: ML",
          "Rule Type: Machine Learning",
          "Tactic: Credential Access"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "15m",
        "from": "now-2700s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "A newly installed program, or one that runs under a new or rarely used user context, could trigger this detection rule. Manual interrogation of the metadata service during debugging or troubleshooting could trigger this rule."
        ],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1552",
                "name": "Unsecured Credentials",
                "reference": "https://attack.mitre.org/techniques/T1552/",
                "subtechnique": [
                  {
                    "id": "T1552.005",
                    "name": "Cloud Instance Metadata API",
                    "reference": "https://attack.mitre.org/techniques/T1552/005/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThis rule requires the installation of associated Machine Learning jobs, as well as data coming in from one of the following integrations:\n- Elastic Defend\n- Windows\n\n### Anomaly Detection Setup\n\nOnce the rule is enabled, the associated Machine Learning job will start automatically. You can view the Machine Learning job linked under the \"Definition\" panel of the detection rule. If the job does not start due to an error, the issue must be resolved for the job to commence successfully. For more details on setting up anomaly detection jobs, refer to the [helper guide](https://www.elastic.co/guide/en/kibana/current/xpack-ml-anomalies.html).\n\n### Elastic Defend Integration Setup\nElastic Defend is integrated into the Elastic Agent using Fleet. Upon configuration, the integration allows the Elastic Agent to monitor events on your host and send data to the Elastic Security app.\n\n#### Prerequisite Requirements:\n- Fleet is required for Elastic Defend.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n\n#### The following steps should be executed in order to add the Elastic Defend integration to your system:\n- Go to the Kibana home page and click \"Add integrations\".\n- In the query bar, search for \"Elastic Defend\" and select the integration to see more details about it.\n- Click \"Add Elastic Defend\".\n- Configure the integration name and optionally add a description.\n- Select the type of environment you want to protect, either \"Traditional Endpoints\" or \"Cloud Workloads\".\n- Select a configuration preset. Each preset comes with different default settings for Elastic Agent, you can further customize these later by configuring the Elastic Defend integration policy. [Helper guide](https://www.elastic.co/guide/en/security/current/configure-endpoint-integration-policy.html).\n- We suggest selecting \"Complete EDR (Endpoint Detection and Response)\" as a configuration setting, that provides \"All events; all preventions\"\n- Enter a name for the agent policy in \"New agent policy name\". If other agent policies already exist, you can click the \"Existing hosts\" tab and select an existing policy instead.\nFor more details on Elastic Agent configuration settings, refer to the [helper guide](https://www.elastic.co/guide/en/fleet/current/agent-policy.html).\n- Click \"Save and Continue\".\n- To complete the integration, select \"Add Elastic Agent to your hosts\" and continue to the next section to install the Elastic Agent on your hosts.\nFor more details on Elastic Defend refer to the [helper guide](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n\n### Windows Integration Setup\nThe Windows integration allows you to monitor the Windows OS, services, applications, and more.\n\n#### The following steps should be executed in order to add the Elastic Agent System integration \"windows\" to your system:\n- Go to the Kibana home page and click â€œAdd integrationsâ€.\n- In the query bar, search for â€œWindowsâ€ and select the integration to see more details about it.\n- Click â€œAdd Windowsâ€.\n- Configure the integration name and optionally add a description.\n- Review optional and advanced settings accordingly.\n- Add the newly installed â€œwindowsâ€ to an existing or a new agent policy, and deploy the agent on your system from which windows log files are desirable.\n- Click â€œSave and Continueâ€.\n- For more details on the integration refer to the [helper guide](https://docs.elastic.co/integrations/windows).\n",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [],
        "id": "e71a1099-5a93-47af-ba91-ac9077eb6836",
        "rule_id": "df197323-72a8-46a9-a08e-3f5b04a4a97a",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:16.907Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:35.985Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "machine_learning",
        "anomaly_threshold": 75,
        "machine_learning_job_id": [
          "v3_windows_rare_metadata_user"
        ]
      },
      {
        "name": "System Service Discovery through built-in Windows Utilities",
        "description": "Detects the usage of commonly used system service discovery techniques, which attackers may use during the reconnaissance phase after compromising a system in order to gain a better understanding of the environment and/or escalate privileges.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 109,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Data Source: Elastic Defend",
          "Data Source: Elastic Endgame",
          "Rule Type: BBR",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1007",
                "name": "System Service Discovery",
                "reference": "https://attack.mitre.org/techniques/T1007/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args_count",
            "type": "long",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "6d3e9906-93ca-4be2-96f3-27b9b935a1e1",
        "rule_id": "e0881d20-54ac-457f-8733-fe0bc5d44c55",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:16.910Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:36.000Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (\n  ((process.name: \"net.exe\" or process.pe.original_file_name == \"net.exe\" or (process.name : \"net1.exe\" and \n    not process.parent.name : \"net.exe\")) and process.args : (\"start\", \"use\") and process.args_count == 2) or\n  ((process.name: \"sc.exe\" or process.pe.original_file_name == \"sc.exe\") and process.args: (\"query\", \"q*\")) or\n  ((process.name: \"tasklist.exe\" or process.pe.original_file_name == \"tasklist.exe\") and process.args: \"/svc\") or\n  (process.name : \"psservice.exe\" or process.pe.original_file_name == \"psservice.exe\")\n  ) and not user.id : \"S-1-5-18\"",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.*",
          "endgame-*",
          "logs-system.security*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious .NET Reflection via PowerShell",
        "description": "Detects the use of Reflection.Assembly to load PEs and DLLs in memory in PowerShell scripts. Attackers use this method to load executables and DLLs without writing to the disk, bypassing security solutions.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Suspicious .NET Reflection via PowerShell\n\nPowerShell is one of the main tools system administrators use for automation, report routines, and other tasks. This makes it available for use in various environments, and creates an attractive way for attackers to execute code.\n\nAttackers can use .NET reflection to load PEs and DLLs in memory. These payloads are commonly embedded in the script, which can circumvent file-based security protections.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Examine the script content that triggered the detection; look for suspicious DLL imports, collection or exfiltration capabilities, suspicious functions, encoded or compressed data, and other potentially malicious characteristics.\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Examine file or network events from the involved PowerShell process for suspicious behavior.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Evaluate whether the user needs to use PowerShell to complete tasks.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the script using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately outside engineering or IT business units. As long as the analyst did not identify malware or suspicious activity related to the user or host, this alert can be dismissed.\n\n### Related rules\n\n- PowerShell PSReflect Script - 56f2e9b5-4803-4e44-a0a4-a52dc79d57fe\n- Potential Process Injection via PowerShell - 2e29e96a-b67c-455a-afe4-de6183431d0d\n- PowerShell Suspicious Payload Encoded and Compressed - 81fe9dc6-a2d7-4192-a2d8-eed98afc766a\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Restrict PowerShell usage outside of IT and engineering business units using GPOs, AppLocker, Intune, or similar software.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 316,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Tactic: Execution",
          "Resources: Investigation Guide",
          "Data Source: PowerShell Logs"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://docs.microsoft.com/en-us/dotnet/api/system.reflection.assembly.load"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1620",
                "name": "Reflective Code Loading",
                "reference": "https://attack.mitre.org/techniques/T1620/"
              },
              {
                "id": "T1055",
                "name": "Process Injection",
                "reference": "https://attack.mitre.org/techniques/T1055/",
                "subtechnique": [
                  {
                    "id": "T1055.001",
                    "name": "Dynamic-link Library Injection",
                    "reference": "https://attack.mitre.org/techniques/T1055/001/"
                  },
                  {
                    "id": "T1055.002",
                    "name": "Portable Executable Injection",
                    "reference": "https://attack.mitre.org/techniques/T1055/002/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'PowerShell Script Block Logging' logging policy must be enabled.\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nAdministrative Templates >\nWindows PowerShell >\nTurn on PowerShell Script Block Logging (Enable)\n```\n\nSteps to implement the logging policy via registry:\n\n```\nreg add \"hklm\\SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\ScriptBlockLogging\" /v EnableScriptBlockLogging /t REG_DWORD /d 1\n```\n",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "file.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "powershell.file.script_block_text",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "193fee06-99dd-4d6b-8595-4cdc34747d40",
        "rule_id": "e26f042e-c590-4e82-8e05-41e81bd822ad",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:16.913Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:36.005Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-windows.powershell*"
        ],
        "filters": [
          {
            "meta": {
              "negate": true
            },
            "query": {
              "wildcard": {
                "file.path": {
                  "case_insensitive": true,
                  "value": "C:\\\\Program Files\\\\Microsoft Monitoring Agent\\\\Agent\\\\Health Service State\\\\Monitoring Host Temporary Files*\\\\AvailabilityGroupMonitoring.ps1"
                }
              }
            }
          }
        ],
        "query": "event.category:process and host.os.type:windows and\n  powershell.file.script_block_text : (\n    \"[System.Reflection.Assembly]::Load\" or\n    \"[Reflection.Assembly]::Load\"\n  ) and\n  not powershell.file.script_block_text : (\n        (\"CommonWorkflowParameters\" or \"RelatedLinksHelpInfo\") and\n        \"HelpDisplayStrings\"\n  ) and\n  not (powershell.file.script_block_text :\n        (\"Get-SolutionFiles\" or \"Get-VisualStudio\" or \"Select-MSBuildPath\") and\n        file.name : \"PathFunctions.ps1\"\n  ) and\n  not powershell.file.script_block_text : (\n        \"Microsoft.PowerShell.Workflow.ServiceCore\" and \"ExtractPluginProperties([string]$pluginDir\"\n  ) and \n  \n  not powershell.file.script_block_text : (\"reflection.assembly]::Load('System.\" or \"LoadWithPartialName('Microsoft.\" or \"::Load(\\\"Microsoft.\" or \"Microsoft.Build.Utilities.Core.dll\") and \n  \n  not user.id : \"S-1-5-18\"",
        "language": "kuery"
      },
      {
        "name": "Windows Subsystem for Linux Enabled via Dism Utility",
        "description": "Detects attempts to enable the Windows Subsystem for Linux using Microsoft Dism utility. Adversaries may enable and use WSL for Linux to avoid detection.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Windows Subsystem for Linux Enabled via Dism Utility\n\nThe Windows Subsystem for Linux (WSL) lets developers install a Linux distribution (such as Ubuntu, OpenSUSE, Kali, Debian, Arch Linux, etc) and use Linux applications, utilities, and Bash command-line tools directly on Windows, unmodified, without the overhead of a traditional virtual machine or dualboot setup. Attackers may abuse WSL to avoid security protections on a Windows host and perform a wide range of attacks.\n\nThis rule identifies attempts to enable WSL using the Dism utility. It monitors for the execution of Dism and checks if the command line contains the string \"Microsoft-Windows-Subsystem-Linux\". \n\n### Possible investigation steps\n\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Validate the activity is not related to planned patches, updates, network administrator activity, or legitimate software installations.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n\n### False positive analysis\n\n- This is a dual-use tool, meaning its usage is not inherently malicious. Analysts can dismiss the alert if the administrator is aware of the activity, no other suspicious activity was identified, and WSL is homologated and approved in the environment.\n\n### Related Rules\n\n- Execution via Windows Subsystem for Linux - db7dbad5-08d2-4d25-b9b1-d3a1e4a15efd\n- Suspicious Execution via Windows Subsystem for Linux - 3e0eeb75-16e8-4f2f-9826-62461ca128b7\n- Host Files System Changes via Windows Subsystem for Linux - e88d1fe9-b2f4-48d4-bace-a026dc745d4b\n- Windows Subsystem for Linux Distribution Installed - a1699af0-8e1e-4ed0-8ec1-89783538a061\n\n### Response and Remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 209,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://blog.f-secure.com/hunting-for-windows-subsystem-for-linux/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1202",
                "name": "Indirect Command Execution",
                "reference": "https://attack.mitre.org/techniques/T1202/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "58a0ea21-0c51-4e53-a8c4-e96e8f72ce4e",
        "rule_id": "e2e0537d-7d8f-4910-a11d-559bcf61295a",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:16.916Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:36.011Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type : \"start\" and\n (process.name : \"Dism.exe\" or ?process.pe.original_file_name == \"DISM.EXE\") and \n process.command_line : \"*Microsoft-Windows-Subsystem-Linux*\"",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Process Activity via Compiled HTML File",
        "description": "Compiled HTML files (.chm) are commonly distributed as part of the Microsoft HTML Help system. Adversaries may conceal malicious code in a CHM file and deliver it to a victim for execution. CHM content is loaded by the HTML Help executable program (hh.exe).",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Process Activity via Compiled HTML File\n\nCHM (Compiled HTML) files are a format for delivering online help files on Windows. CHM files are compressed compilations of various content, such as HTML documents, images, and scripting/web-related programming languages such as VBA, JScript, Java, and ActiveX.\n\nWhen users double-click CHM files, the HTML Help executable program (`hh.exe`) will execute them. `hh.exe` also can be used to execute code embedded in those files, PowerShell scripts, and executables. This makes it useful for attackers not only to proxy the execution of malicious payloads via a signed binary that could bypass security controls, but also to gain initial access to environments via social engineering methods.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate any abnormal behavior by the subject process such as network connections, registry or file modifications, and any spawned child processes.\n- Investigate the parent process to gain understanding of what triggered this behavior.\n  - Retrieve `.chm`, `.ps1`, and other files that were involved to further examination.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the process executables, scripts and help files retrieved from the system using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- If the malicious file was delivered via phishing:\n  - Block the email sender from sending future emails.\n  - Block the malicious web pages.\n  - Remove emails from the sender from mailboxes.\n  - Consider improvements to the security awareness program.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 312,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Data Source: Elastic Endgame",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [
          "The HTML Help executable program (hh.exe) runs whenever a user clicks a compiled help (.chm) file or menu item that opens the help file inside the Help Viewer. This is not always malicious, but adversaries may abuse this technology to conceal malicious code."
        ],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1204",
                "name": "User Execution",
                "reference": "https://attack.mitre.org/techniques/T1204/",
                "subtechnique": [
                  {
                    "id": "T1204.002",
                    "name": "Malicious File",
                    "reference": "https://attack.mitre.org/techniques/T1204/002/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1218",
                "name": "System Binary Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1218/",
                "subtechnique": [
                  {
                    "id": "T1218.001",
                    "name": "Compiled HTML File",
                    "reference": "https://attack.mitre.org/techniques/T1218/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "58fe1e53-cb56-4f71-9d13-838781824bc5",
        "rule_id": "e3343ab9-4245-4715-b344-e11c56b0a47f",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:16.919Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:36.021Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n process.parent.name : \"hh.exe\" and\n process.name : (\"mshta.exe\", \"cmd.exe\", \"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\", \"cscript.exe\", \"wscript.exe\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "First Time Seen NewCredentials Logon Process",
        "description": "Identifies a new credentials logon type performed by an unusual process. This may indicate the existence of an access token forging capability that are often abused to bypass access control restrictions.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 105,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/pt/blog/how-attackers-abuse-access-token-manipulation"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1134",
                "name": "Access Token Manipulation",
                "reference": "https://attack.mitre.org/techniques/T1134/",
                "subtechnique": [
                  {
                    "id": "T1134.001",
                    "name": "Token Impersonation/Theft",
                    "reference": "https://attack.mitre.org/techniques/T1134/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.event_data.LogonProcessName",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "winlog.event_data.SubjectUserName",
            "type": "keyword",
            "ecs": false
          },
          {
            "name": "winlog.logon.type",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "e72576bf-bb36-40e7-a7f2-304311be352f",
        "rule_id": "e468f3f6-7c4c-45bb-846a-053738b3fe5d",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:16.922Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:36.030Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "event.category:\"authentication\" and host.os.type:\"windows\" and winlog.logon.type:\"NewCredentials\" and winlog.event_data.LogonProcessName:(Advapi* or \"Advapi  \") and not winlog.event_data.SubjectUserName:*$ and not process.executable :???\\\\Program?Files*",
        "new_terms_fields": [
          "process.executable"
        ],
        "history_window_start": "now-7d",
        "index": [
          "winlogbeat-*",
          "logs-system.*",
          "logs-windows.*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Kerberos Pre-authentication Disabled for User",
        "description": "Identifies the modification of an account's Kerberos pre-authentication options. An adversary with GenericWrite/GenericAll rights over the account can maliciously modify these settings to perform offline password cracking attacks such as AS-REP roasting.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Kerberos Pre-authentication Disabled for User\n\nKerberos pre-authentication is an account protection against offline password cracking. When enabled, a user requesting access to a resource initiates communication with the Domain Controller (DC) by sending an Authentication Server Request (AS-REQ) message with a timestamp that is encrypted with the hash of their password. If and only if the DC is able to successfully decrypt the timestamp with the hash of the userâ€™s password, it will then send an Authentication Server Response (AS-REP) message that contains the Ticket Granting Ticket (TGT) to the user. Part of the AS-REP message is signed with the userâ€™s password. Microsoft's security monitoring [recommendations](https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4738) state that `'Don't Require Preauth' â€“ Enabled` should not be enabled for user accounts because it weakens security for the accountâ€™s Kerberos authentication.\n\nAS-REP roasting is an attack against Kerberos for user accounts that do not require pre-authentication, which means that if the target user has pre-authentication disabled, an attacker can request authentication data for it and get a TGT that can be brute-forced offline, similarly to Kerberoasting.\n\n#### Possible investigation steps\n\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Determine if the target account is sensitive or privileged.\n- Inspect the account activities for suspicious or abnormal behaviors in the alert timeframe.\n\n### False positive analysis\n\n- Disabling pre-authentication is a bad security practice and should not be allowed in the domain. The security team should map and monitor any potential benign true positives (B-TPs), especially if the target account is privileged.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Reset the target account's password if there is any risk of TGTs having been retrieved.\n- Re-enable the preauthentication option or disable the target account.\n- Review the privileges assigned to the involved users to ensure that the least privilege principle is being followed.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 213,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Tactic: Defense Evasion",
          "Tactic: Privilege Escalation",
          "Resources: Investigation Guide",
          "Use Case: Active Directory Monitoring",
          "Data Source: Active Directory",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://harmj0y.medium.com/roasting-as-reps-e6179a65216b",
          "https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4738",
          "https://github.com/atc-project/atomic-threat-coverage/blob/master/Atomic_Threat_Coverage/Logging_Policies/LP_0026_windows_audit_user_account_management.md"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1558",
                "name": "Steal or Forge Kerberos Tickets",
                "reference": "https://attack.mitre.org/techniques/T1558/",
                "subtechnique": [
                  {
                    "id": "T1558.004",
                    "name": "AS-REP Roasting",
                    "reference": "https://attack.mitre.org/techniques/T1558/004/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1078",
                "name": "Valid Accounts",
                "reference": "https://attack.mitre.org/techniques/T1078/",
                "subtechnique": [
                  {
                    "id": "T1078.002",
                    "name": "Domain Accounts",
                    "reference": "https://attack.mitre.org/techniques/T1078/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'Audit User Account Management' logging policy must be configured for (Success, Failure).\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nPolicies >\nWindows Settings >\nSecurity Settings >\nAdvanced Audit Policies Configuration >\nAudit Policies >\nAccount Management >\nAudit User Account Management (Success,Failure)\n```\n",
        "related_integrations": [
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.code",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "message",
            "type": "match_only_text",
            "ecs": true
          },
          {
            "name": "winlog.api",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "6da666bc-3019-43f2-bdfe-464f2fef739f",
        "rule_id": "e514d8cd-ed15-4011-84e2-d15147e059f1",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:16.935Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:36.051Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-system.*",
          "logs-windows.*"
        ],
        "filters": [],
        "query": "event.code:4738 and winlog.api:\"wineventlog\" and message:\"'Don't Require Preauth' - Enabled\"",
        "language": "kuery"
      },
      {
        "name": "Unusual Process Spawned by a Parent Process",
        "description": "A machine learning job has detected a suspicious Windows process. This process has been classified as malicious in two ways. It was predicted to be malicious by the ProblemChild supervised ML model, and it was found to be an unusual child process name, for the parent process, by an unsupervised ML model. Such a process may be an instance of suspicious or malicious activity, possibly involving LOLbins, that may be resistant to detection using conventional search rules.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 107,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Living off the Land Attack Detection",
          "Rule Type: ML",
          "Rule Type: Machine Learning",
          "Tactic: Defense Evasion"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "15m",
        "from": "now-2700s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/guide/en/security/current/prebuilt-ml-jobs.html",
          "https://docs.elastic.co/en/integrations/problemchild",
          "https://www.elastic.co/security-labs/detecting-living-off-the-land-attacks-with-new-elastic-integration"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1036",
                "name": "Masquerading",
                "reference": "https://attack.mitre.org/techniques/T1036/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe rule requires the Living off the Land (LotL) Attack Detection integration assets to be installed, as well as Windows process events collected by integrations such as Elastic Defend or Winlogbeat.  \n\n### LotL Attack Detection Setup\nThe LotL Attack Detection integration detects living-off-the-land activity in Windows process events.\n\n#### Prerequisite Requirements:\n- Fleet is required for LotL Attack Detection.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n- Windows process events collected by the [Elastic Defend](https://docs.elastic.co/en/integrations/endpoint) integration or Winlogbeat(https://www.elastic.co/guide/en/beats/winlogbeat/current/_winlogbeat_overview.html).\n- To install Elastic Defend, refer to the [documentation](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n- To set up and run Winlogbeat, follow [this](https://www.elastic.co/guide/en/beats/winlogbeat/current/winlogbeat-installation-configuration.html) guide.\n\n#### The following steps should be executed to install assets associated with the LotL Attack Detection integration:\n- Go to the Kibana homepage. Under Management, click Integrations.\n- In the query bar, search for Living off the Land Attack Detection and select the integration to see more details about it.\n- Follow the instructions under the **Installation** section.\n- For this rule to work, complete the instructions through **Add preconfigured anomaly detection jobs**.\n",
        "related_integrations": [
          {
            "package": "problemchild",
            "version": "^2.0.0"
          },
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [],
        "id": "c2a5cd69-0d34-4463-bf1c-1eda1685aa68",
        "rule_id": "ea09ff26-3902-4c53-bb8e-24b7a5d029dd",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:16.941Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:36.097Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "machine_learning",
        "anomaly_threshold": 75,
        "machine_learning_job_id": [
          "problem_child_rare_process_by_parent"
        ]
      },
      {
        "name": "PowerShell Script with Webcam Video Capture Capabilities",
        "description": "Detects PowerShell scripts that can be used to record webcam video. Attackers can capture this information to extort or spy on victims.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 106,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Collection",
          "Data Source: PowerShell Logs"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/EmpireProject/Empire/blob/master/lib/modules/powershell/collection/WebcamRecorder.py"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0009",
              "name": "Collection",
              "reference": "https://attack.mitre.org/tactics/TA0009/"
            },
            "technique": [
              {
                "id": "T1125",
                "name": "Video Capture",
                "reference": "https://attack.mitre.org/techniques/T1125/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'PowerShell Script Block Logging' logging policy must be enabled.\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nAdministrative Templates >\nWindows PowerShell >\nTurn on PowerShell Script Block Logging (Enable)\n```\n\nSteps to implement the logging policy via registry:\n\n```\nreg add \"hklm\\SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\ScriptBlockLogging\" /v EnableScriptBlockLogging /t REG_DWORD /d 1\n```\n",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "powershell.file.script_block_text",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "dc269bad-2669-4f03-9cbe-a8e09421bd80",
        "rule_id": "eb44611f-62a8-4036-a5ef-587098be6c43",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:16.944Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:36.102Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-windows.powershell*"
        ],
        "filters": [],
        "query": "event.category:process and host.os.type:windows and\n  powershell.file.script_block_text : (\n    \"NewFrameEventHandler\" or\n    \"VideoCaptureDevice\" or\n    \"DirectX.Capture.Filters\" or\n    \"VideoCompressors\" or\n    \"Start-WebcamRecorder\" or\n    (\n      (\"capCreateCaptureWindowA\" or\n       \"capCreateCaptureWindow\" or\n       \"capGetDriverDescription\") and\n      (\"avicap32.dll\" or \"avicap32\")\n    )\n  )",
        "language": "kuery"
      },
      {
        "name": "IIS HTTP Logging Disabled",
        "description": "Identifies when Internet Information Services (IIS) HTTP Logging is disabled on a server. An attacker with IIS server access via a webshell or other mechanism can disable HTTP Logging as an effective anti-forensics measure.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating IIS HTTP Logging Disabled\n\nIIS (Internet Information Services) is a Microsoft web server software used to host websites and web applications on Windows. It provides features for serving dynamic and static content, and can be managed through a graphical interface or command-line tools.\n\nIIS logging is a data source that can be used for security monitoring, forensics, and incident response. It contains mainly information related to requests done to the web server, and can be used to spot malicious activities like webshells. Adversaries can tamper, clear, and delete this data to evade detection, cover their tracks, and slow down incident response.\n\nThis rule monitors commands that disable IIS logging.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n  - Verify if any other anti-forensics behaviors were observed.\n- Verify whether the logs stored in the `C:\\inetpub\\logs\\logfiles\\w3svc1` directory were deleted after this action.\n- Check if this operation is done under change management and approved according to the organization's policy.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Re-enable affected logging components, services, and security monitoring.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 312,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Endgame",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 33,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.002",
                    "name": "Disable Windows Event Logging",
                    "reference": "https://attack.mitre.org/techniques/T1562/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "f99ff3ba-91c0-488d-9ce3-d846cb538c7b",
        "rule_id": "ebf1adea-ccf2-4943-8b96-7ab11ca173a5",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:16.950Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:36.129Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (process.name : \"appcmd.exe\" or ?process.pe.original_file_name == \"appcmd.exe\") and\n  process.args : \"/dontLog*:*True\" and\n  not process.parent.name : \"iissetup.exe\"",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "PowerShell Kerberos Ticket Request",
        "description": "Detects PowerShell scripts that have the capability of requesting kerberos tickets, which is a common step in Kerberoasting toolkits to crack service accounts.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating PowerShell Kerberos Ticket Request\n\nPowerShell is one of the main tools system administrators use for automation, report routines, and other tasks, making it available for use in various environments, creating an attractive way for attackers to execute code.\n\nAccounts associated with a service principal name (SPN) are viable targets for Kerberoasting attacks, which use brute force to crack the user password, which is used to encrypt a Kerberos TGS ticket.\n\nAttackers can use PowerShell to request these Kerberos tickets, with the intent of extracting them from memory to perform Kerberoasting.\n\n#### Possible investigation steps\n\n- Examine the script content that triggered the detection; look for suspicious DLL imports, collection or exfiltration capabilities, suspicious functions, encoded or compressed data, and other potentially malicious characteristics.\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate if the script was executed, and if so, which account was targeted.\n- Validate if the account has an SPN associated with it.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Check if the script has any other functionality that can be potentially malicious.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Review event ID [4769](https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4769) related to this account and service name for additional information.\n\n### False positive analysis\n\n- A possible false positive can be identified if the script content is not malicious/harmful or does not request Kerberos tickets for user accounts, as computer accounts are not vulnerable to Kerberoasting due to complex password requirements and policy.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services. Prioritize privileged accounts.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 213,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Resources: Investigation Guide",
          "Data Source: PowerShell Logs"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://cobalt.io/blog/kerberoast-attack-techniques",
          "https://github.com/EmpireProject/Empire/blob/master/data/module_source/credentials/Invoke-Kerberoast.ps1"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1003",
                "name": "OS Credential Dumping",
                "reference": "https://attack.mitre.org/techniques/T1003/"
              },
              {
                "id": "T1558",
                "name": "Steal or Forge Kerberos Tickets",
                "reference": "https://attack.mitre.org/techniques/T1558/",
                "subtechnique": [
                  {
                    "id": "T1558.003",
                    "name": "Kerberoasting",
                    "reference": "https://attack.mitre.org/techniques/T1558/003/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'PowerShell Script Block Logging' logging policy must be enabled.\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nAdministrative Templates >\nWindows PowerShell >\nTurn on PowerShell Script Block Logging (Enable)\n```\n\nSteps to implement the logging policy via registry:\n\n```\nreg add \"hklm\\SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\ScriptBlockLogging\" /v EnableScriptBlockLogging /t REG_DWORD /d 1\n```\n",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "powershell.file.script_block_text",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "bb42ccd9-6524-4ac3-a99b-d3bcd79c18da",
        "rule_id": "eb610e70-f9e6-4949-82b9-f1c5bcd37c39",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:16.947Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:36.117Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-windows.powershell*"
        ],
        "filters": [],
        "query": "event.category:process and host.os.type:windows and\n  powershell.file.script_block_text : (\n    KerberosRequestorSecurityToken\n  ) and not user.id : (\"S-1-5-18\" or \"S-1-5-20\") and\n  not powershell.file.script_block_text : (\n    (\"sentinelbreakpoints\" and (\"Set-PSBreakpoint\" or \"Set-HookFunctionTabs\")) or\n    (\"function global\" and \"\\\\windows\\\\sentinel\\\\4\")\n  )",
        "language": "kuery"
      },
      {
        "name": "AdFind Command Activity",
        "description": "This rule detects the Active Directory query tool, AdFind.exe. AdFind has legitimate purposes, but it is frequently leveraged by threat actors to perform post-exploitation Active Directory reconnaissance. The AdFind tool has been observed in Trickbot, Ryuk, Maze, and FIN6 campaigns. For Winlogbeat, this rule requires Sysmon.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating AdFind Command Activity\n\n[AdFind](http://www.joeware.net/freetools/tools/adfind/) is a freely available command-line tool used to retrieve information from Active Directory (AD). Network discovery and enumeration tools like `AdFind` are useful to adversaries in the same ways they are effective for network administrators. This tool provides quick ability to scope AD person/computer objects and understand subnets and domain information. There are many [examples](https://thedfirreport.com/category/adfind/) of this tool being adopted by ransomware and criminal groups and used in compromises.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Examine the command line to determine what information was retrieved by the tool.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n\n### False positive analysis\n\n- This rule has a high chance to produce false positives as it is a legitimate tool used by network administrators.\n- If this rule is noisy in your environment due to expected activity, consider adding exceptions â€” preferably with a combination of user and command line conditions.\n- Malicious behavior with `AdFind` should be investigated as part of a step within an attack chain. It doesn't happen in isolation, so reviewing previous logs/activity from impacted machines can be very telling.\n\n### Related rules\n\n- Windows Network Enumeration - 7b8bfc26-81d2-435e-965c-d722ee397ef1\n- Enumeration of Administrator Accounts - 871ea072-1b71-4def-b016-6278b505138d\n- Enumeration Command Spawned via WMIPrvSE - 770e0c4d-b998-41e5-a62e-c7901fd7f470\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 314,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "http://www.joeware.net/freetools/tools/adfind/",
          "https://thedfirreport.com/2020/05/08/adfind-recon/",
          "https://www.fireeye.com/blog/threat-research/2020/05/tactics-techniques-procedures-associated-with-maze-ransomware-incidents.html",
          "https://www.cybereason.com/blog/dropping-anchor-from-a-trickbot-infection-to-the-discovery-of-the-anchor-malware",
          "https://www.fireeye.com/blog/threat-research/2019/04/pick-six-intercepting-a-fin6-intrusion.html",
          "https://usa.visa.com/dam/VCOM/global/support-legal/documents/fin6-cybercrime-group-expands-threat-To-ecommerce-merchants.pdf"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1016",
                "name": "System Network Configuration Discovery",
                "reference": "https://attack.mitre.org/techniques/T1016/"
              },
              {
                "id": "T1018",
                "name": "Remote System Discovery",
                "reference": "https://attack.mitre.org/techniques/T1018/"
              },
              {
                "id": "T1069",
                "name": "Permission Groups Discovery",
                "reference": "https://attack.mitre.org/techniques/T1069/",
                "subtechnique": [
                  {
                    "id": "T1069.002",
                    "name": "Domain Groups",
                    "reference": "https://attack.mitre.org/techniques/T1069/002/"
                  }
                ]
              },
              {
                "id": "T1087",
                "name": "Account Discovery",
                "reference": "https://attack.mitre.org/techniques/T1087/",
                "subtechnique": [
                  {
                    "id": "T1087.002",
                    "name": "Domain Account",
                    "reference": "https://attack.mitre.org/techniques/T1087/002/"
                  }
                ]
              },
              {
                "id": "T1482",
                "name": "Domain Trust Discovery",
                "reference": "https://attack.mitre.org/techniques/T1482/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "2b9c5194-b19d-463c-888c-43aebbe0b7e3",
        "rule_id": "eda499b8-a073-4e35-9733-22ec71f57f3a",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:16.956Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:36.138Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (process.name : \"AdFind*.exe\" or ?process.pe.original_file_name == \"AdFind.exe\") and\n  process.args : (\"objectcategory=computer\", \"(objectcategory=computer)\",\n                  \"objectcategory=person\", \"(objectcategory=person)\",\n                  \"objectcategory=subnet\", \"(objectcategory=subnet)\",\n                  \"objectcategory=group\", \"(objectcategory=group)\",\n                  \"objectcategory=organizationalunit\", \"(objectcategory=organizationalunit)\",\n                  \"objectcategory=attributeschema\", \"(objectcategory=attributeschema)\",\n                  \"domainlist\", \"dcmodes\", \"adinfo\", \"dclist\", \"computers_pwnotreqd\", \"trustdmp\")",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "winlogbeat-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Process Execution from an Unusual Directory",
        "description": "Identifies process execution from suspicious default Windows directories. This is sometimes done by adversaries to hide malware in trusted paths.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Process Execution from an Unusual Directory\n\nThis rule identifies processes that are executed from suspicious default Windows directories. Adversaries may abuse this technique by planting malware in trusted paths, making it difficult for security analysts to discern if their activities are malicious or take advantage of exceptions that may apply to these paths.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes, examining their executable files for prevalence, location, and valid digital signatures.\n- Investigate any abnormal behavior by the subject process, such as network connections, registry or file modifications, and any spawned child processes.\n- Examine arguments and working directory to determine the program's source or the nature of the tasks it is performing.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Inspect the host for suspicious or abnormal behavior in the alert timeframe.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the process executable using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n\n### False positive analysis\n\n- If this activity is expected and noisy in your environment, consider adding exceptions â€” preferably with a combination of executable and signature conditions.\n\n### Related Rules\n\n- Unusual Windows Path Activity - 445a342e-03fb-42d0-8656-0367eb2dead5\n- Execution from Unusual Directory - Command Line - cff92c41-2225-4763-b4ce-6f71e5bda5e6\n\n### Response and Remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 313,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/security-labs/invisible-miners-unveiling-ghostengine",
          "https://www.elastic.co/security-labs/siestagraph-new-implant-uncovered-in-asean-member-foreign-ministry"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1036",
                "name": "Masquerading",
                "reference": "https://attack.mitre.org/techniques/T1036/",
                "subtechnique": [
                  {
                    "id": "T1036.005",
                    "name": "Match Legitimate Name or Location",
                    "reference": "https://attack.mitre.org/techniques/T1036/005/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.executable",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "c7ca6e9d-354d-415a-9694-ca768721feb9",
        "rule_id": "ebfe1448-7fac-4d59-acea-181bd89b1f7f",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:16.953Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:36.134Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  /* add suspicious execution paths here */\n  process.executable : (\n    \"?:\\\\PerfLogs\\\\*.exe\", \"?:\\\\Users\\\\Public\\\\*.exe\", \"?:\\\\Windows\\\\Tasks\\\\*.exe\",\n    \"?:\\\\Intel\\\\*.exe\", \"?:\\\\AMD\\\\Temp\\\\*.exe\", \"?:\\\\Windows\\\\AppReadiness\\\\*.exe\",\n    \"?:\\\\Windows\\\\ServiceState\\\\*.exe\", \"?:\\\\Windows\\\\security\\\\*.exe\", \"?:\\\\Windows\\\\IdentityCRL\\\\*.exe\",\n    \"?:\\\\Windows\\\\Branding\\\\*.exe\", \"?:\\\\Windows\\\\csc\\\\*.exe\", \"?:\\\\Windows\\\\DigitalLocker\\\\*.exe\",\n    \"?:\\\\Windows\\\\en-US\\\\*.exe\", \"?:\\\\Windows\\\\wlansvc\\\\*.exe\", \"?:\\\\Windows\\\\Prefetch\\\\*.exe\",\n    \"?:\\\\Windows\\\\Fonts\\\\*.exe\", \"?:\\\\Windows\\\\diagnostics\\\\*.exe\", \"?:\\\\Windows\\\\TAPI\\\\*.exe\",\n    \"?:\\\\Windows\\\\INF\\\\*.exe\", \"?:\\\\Windows\\\\System32\\\\Speech\\\\*.exe\", \"?:\\\\windows\\\\tracing\\\\*.exe\",\n    \"?:\\\\windows\\\\IME\\\\*.exe\", \"?:\\\\Windows\\\\Performance\\\\*.exe\", \"?:\\\\windows\\\\intel\\\\*.exe\",\n    \"?:\\\\windows\\\\ms\\\\*.exe\", \"?:\\\\Windows\\\\dot3svc\\\\*.exe\", \"?:\\\\Windows\\\\panther\\\\*.exe\",\n    \"?:\\\\Windows\\\\RemotePackages\\\\*.exe\", \"?:\\\\Windows\\\\OCR\\\\*.exe\", \"?:\\\\Windows\\\\appcompat\\\\*.exe\",\n    \"?:\\\\Windows\\\\apppatch\\\\*.exe\", \"?:\\\\Windows\\\\addins\\\\*.exe\", \"?:\\\\Windows\\\\Setup\\\\*.exe\",\n    \"?:\\\\Windows\\\\Help\\\\*.exe\", \"?:\\\\Windows\\\\SKB\\\\*.exe\", \"?:\\\\Windows\\\\Vss\\\\*.exe\",\n    \"?:\\\\Windows\\\\Web\\\\*.exe\", \"?:\\\\Windows\\\\servicing\\\\*.exe\", \"?:\\\\Windows\\\\CbsTemp\\\\*.exe\",\n    \"?:\\\\Windows\\\\Logs\\\\*.exe\", \"?:\\\\Windows\\\\WaaS\\\\*.exe\", \"?:\\\\Windows\\\\ShellExperiences\\\\*.exe\",\n    \"?:\\\\Windows\\\\ShellComponents\\\\*.exe\", \"?:\\\\Windows\\\\PLA\\\\*.exe\", \"?:\\\\Windows\\\\Migration\\\\*.exe\",\n    \"?:\\\\Windows\\\\debug\\\\*.exe\", \"?:\\\\Windows\\\\Cursors\\\\*.exe\", \"?:\\\\Windows\\\\Containers\\\\*.exe\",\n    \"?:\\\\Windows\\\\Boot\\\\*.exe\", \"?:\\\\Windows\\\\bcastdvr\\\\*.exe\", \"?:\\\\Windows\\\\assembly\\\\*.exe\",\n    \"?:\\\\Windows\\\\TextInput\\\\*.exe\", \"?:\\\\Windows\\\\security\\\\*.exe\", \"?:\\\\Windows\\\\schemas\\\\*.exe\",\n    \"?:\\\\Windows\\\\SchCache\\\\*.exe\", \"?:\\\\Windows\\\\Resources\\\\*.exe\", \"?:\\\\Windows\\\\rescache\\\\*.exe\",\n    \"?:\\\\Windows\\\\Provisioning\\\\*.exe\", \"?:\\\\Windows\\\\PrintDialog\\\\*.exe\", \"?:\\\\Windows\\\\PolicyDefinitions\\\\*.exe\",\n    \"?:\\\\Windows\\\\media\\\\*.exe\", \"?:\\\\Windows\\\\Globalization\\\\*.exe\", \"?:\\\\Windows\\\\L2Schemas\\\\*.exe\",\n    \"?:\\\\Windows\\\\LiveKernelReports\\\\*.exe\", \"?:\\\\Windows\\\\ModemLogs\\\\*.exe\",\n    \"?:\\\\Windows\\\\ImmersiveControlPanel\\\\*.exe\"\n  ) and\n  \n  not process.name : (\n    \"SpeechUXWiz.exe\", \"SystemSettings.exe\", \"TrustedInstaller.exe\",\n    \"PrintDialog.exe\", \"MpSigStub.exe\", \"LMS.exe\", \"mpam-*.exe\"\n  ) and\n  not process.executable :\n            (\"?:\\\\Intel\\\\Wireless\\\\WUSetupLauncher.exe\",\n             \"?:\\\\Intel\\\\Wireless\\\\Setup.exe\",\n             \"?:\\\\Intel\\\\Move Mouse.exe\",\n             \"?:\\\\windows\\\\Panther\\\\DiagTrackRunner.exe\",\n             \"?:\\\\Windows\\\\servicing\\\\GC64\\\\tzupd.exe\",\n             \"?:\\\\Users\\\\Public\\\\res\\\\RemoteLite.exe\",\n             \"?:\\\\Users\\\\Public\\\\IBM\\\\ClientSolutions\\\\*.exe\",\n             \"?:\\\\Users\\\\Public\\\\Documents\\\\syspin.exe\",\n             \"?:\\\\Users\\\\Public\\\\res\\\\FileWatcher.exe\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*"
        ],
        "filters": []
      },
      {
        "name": "ImageLoad via Windows Update Auto Update Client",
        "description": "Identifies abuse of the Windows Update Auto Update Client (wuauclt.exe) to load an arbitrary DLL. This behavior is used as a defense evasion technique to blend-in malicious activity with legitimate Windows software.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "timeline_id": "e70679c2-6cde-4510-9764-4823df18f7db",
        "timeline_title": "Comprehensive Process Timeline",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating ImageLoad via Windows Update Auto Update Client\n\nThe Windows Update Auto Update Client (wuauclt.exe) is the component responsible for managing system updates. However, adversaries may abuse this process to load a malicious DLL and execute malicious code while blending into a legitimate system mechanism. \n\nThis rule identifies potential abuse for code execution by monitoring for specific process arguments (\"/RunHandlerComServer\" and \"/UpdateDeploymentProvider\") and common writable paths where the target DLL can be placed (e.g., \"C:\\Users\\*.dll\", \"C:\\ProgramData\\*.dll\", etc.).\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate any abnormal behavior by the subject process, such as network connections, registry or file modifications, and any spawned child processes.\n- Examine the command line and identify the DLL location.\n- Examine whether the DLL is signed.\n- Retrieve the DLL and determine if it is malicious:\n  - Analyze the file using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate the behavior of child processes, such as network connections, registry or file modifications, and any spawned processes.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Any activity that triggered the alert and is not inherently malicious must be monitored by the security team.\n\n### Response and Remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 314,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Tactic: Execution",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://dtm.uk/wuauclt/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1218",
                "name": "System Binary Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1218/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "76a4d4b4-4420-4668-9910-8ff4abe17279",
        "rule_id": "edf8ee23-5ea7-4123-ba19-56b41e424ae3",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:16.959Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:36.143Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (?process.pe.original_file_name == \"wuauclt.exe\" or process.name : \"wuauclt.exe\") and\n   /* necessary windows update client args to load a dll */\n   process.args : \"/RunHandlerComServer\" and process.args : \"/UpdateDeploymentProvider\" and\n   /* common paths writeable by a standard user where the target DLL can be placed */\n   process.args : (\"C:\\\\Users\\\\*.dll\", \"C:\\\\ProgramData\\\\*.dll\", \"C:\\\\Windows\\\\Temp\\\\*.dll\", \"C:\\\\Windows\\\\Tasks\\\\*.dll\")",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "winlogbeat-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "SIP Provider Modification",
        "description": "Identifies modifications to the registered Subject Interface Package (SIP) providers. SIP providers are used by the Windows cryptographic system to validate file signatures on the system. This may be an attempt to bypass signature validation checks or inject code into critical processes.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 310,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Sysmon",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: SentinelOne"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/mattifestation/PoCSubjectInterfacePackage"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1553",
                "name": "Subvert Trust Controls",
                "reference": "https://attack.mitre.org/techniques/T1553/",
                "subtechnique": [
                  {
                    "id": "T1553.003",
                    "name": "SIP and Trust Provider Hijacking",
                    "reference": "https://attack.mitre.org/techniques/T1553/003/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.data.strings",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "registry.path",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "registry.value",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "4c72d220-66ac-4ab5-b60c-1e46c2844a59",
        "rule_id": "f2c7b914-eda3-40c2-96ac-d23ef91776ca",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:16.962Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:36.163Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "registry where host.os.type == \"windows\" and event.type == \"change\" and registry.value : (\"Dll\", \"$Dll\") and\n  registry.path: (\n    \"*\\\\SOFTWARE\\\\Microsoft\\\\Cryptography\\\\OID\\\\EncodingType 0\\\\CryptSIPDllPutSignedDataMsg\\\\{*}\\\\Dll\",\n    \"*\\\\SOFTWARE\\\\WOW6432Node\\\\Microsoft\\\\Cryptography\\\\OID\\\\EncodingType 0\\\\CryptSIPDllPutSignedDataMsg\\\\{*}\\\\Dll\",\n    \"*\\\\SOFTWARE\\\\Microsoft\\\\Cryptography\\\\Providers\\\\Trust\\\\FinalPolicy\\\\{*}\\\\$Dll\",\n    \"*\\\\SOFTWARE\\\\WOW6432Node\\\\Microsoft\\\\Cryptography\\\\Providers\\\\Trust\\\\FinalPolicy\\\\{*}\\\\$Dll\"\n    ) and\n  registry.data.strings:\"*.dll\" and\n  not (process.name : \"msiexec.exe\" and registry.data.strings : \"mso.dll\") and\n  not (process.name : \"regsvr32.exe\" and registry.data.strings == \"WINTRUST.DLL\")",
        "language": "eql",
        "index": [
          "logs-endpoint.events.registry-*",
          "endgame-*",
          "logs-windows.sysmon_operational-*",
          "winlogbeat-*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*"
        ],
        "filters": []
      },
      {
        "name": "Sensitive Privilege SeEnableDelegationPrivilege assigned to a User",
        "description": "Identifies the assignment of the SeEnableDelegationPrivilege sensitive \"user right\" to a user. The SeEnableDelegationPrivilege \"user right\" enables computer and user accounts to be trusted for delegation. Attackers can abuse this right to compromise Active Directory accounts and elevate their privileges.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Sensitive Privilege SeEnableDelegationPrivilege assigned to a User\n\nKerberos delegation is an Active Directory feature that allows user and computer accounts to impersonate other accounts, act on their behalf, and use their privileges. Delegation (constrained and unconstrained) can be configured for user and computer objects.\n\nEnabling unconstrained delegation for a computer causes the computer to store the ticket-granting ticket (TGT) in memory at any time an account connects to the computer, so it can be used by the computer for impersonation when needed. Risk is heightened if an attacker compromises computers with unconstrained delegation enabled, as they could extract TGTs from memory and then replay them to move laterally on the domain. If the attacker coerces a privileged user to connect to the server, or if the user does so routinely, the account will be compromised and the attacker will be able to pass-the-ticket to privileged assets.\n\nSeEnableDelegationPrivilege is a user right that is controlled within the Local Security Policy of a domain controller and is managed through Group Policy. This setting is named **Enable computer and user accounts to be trusted for delegation**.\n\nIt is critical to control the assignment of this privilege. A user with this privilege and write access to a computer can control delegation settings, perform the attacks described above, and harvest TGTs from any user that connects to the system.\n\n#### Possible investigation steps\n\n- Investigate how the privilege was assigned to the user and who assigned it.\n- Investigate other potentially malicious activity that was performed by the user that assigned the privileges using the `user.id` and `winlog.activity_id` fields as a filter during the past 48 hours.\n- Investigate other alerts associated with the users/host during the past 48 hours.\n\n### False positive analysis\n\n- The SeEnableDelegationPrivilege privilege should not be assigned to users. If this rule is triggered in your environment legitimately, the security team should notify the administrators about the risks of using it.\n\n### Related rules\n\n- KRBTGT Delegation Backdoor - e052c845-48d0-4f46-8a13-7d0aba05df82\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Remove the privilege from the account.\n- Review the privileges of the administrator account that performed the action.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 213,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Tactic: Persistence",
          "Data Source: Active Directory",
          "Resources: Investigation Guide",
          "Use Case: Active Directory Monitoring",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://blog.harmj0y.net/activedirectory/the-most-dangerous-user-right-you-probably-have-never-heard-of/",
          "https://github.com/SigmaHQ/sigma/blob/master/rules/windows/builtin/security/win_alert_active_directory_user_control.yml",
          "https://twitter.com/_nwodtuhs/status/1454049485080907776",
          "https://www.thehacker.recipes/ad/movement/kerberos/delegations",
          "https://github.com/atc-project/atomic-threat-coverage/blob/master/Atomic_Threat_Coverage/Logging_Policies/LP_0105_windows_audit_authorization_policy_change.md"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1558",
                "name": "Steal or Forge Kerberos Tickets",
                "reference": "https://attack.mitre.org/techniques/T1558/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1098",
                "name": "Account Manipulation",
                "reference": "https://attack.mitre.org/techniques/T1098/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'Audit Authorization Policy Change' logging policy must be configured for (Success, Failure).\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nWindows Settings >\nSecurity Settings >\nAdvanced Audit Policy Configuration >\nAudit Policies >\nPolicy Change >\nAudit Authorization Policy Change (Success,Failure)\n```\n",
        "related_integrations": [
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.code",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.event_data.PrivilegeList",
            "type": "keyword",
            "ecs": false
          }
        ],
        "id": "2abc4823-d335-4a7d-9da4-118d66fa814a",
        "rule_id": "f494c678-3c33-43aa-b169-bb3d5198c41d",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:16.965Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:36.193Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-system.*",
          "logs-windows.*"
        ],
        "filters": [],
        "query": "event.action:\"Authorization Policy Change\" and event.code:4704 and\n  winlog.event_data.PrivilegeList:\"SeEnableDelegationPrivilege\"",
        "language": "kuery"
      },
      {
        "name": "WRITEDAC Access on Active Directory Object",
        "description": "Identifies the access on an object with WRITEDAC permissions. With the WRITEDAC permission, the user can perform a Write Discretionary Access Control List (WriteDACL) operation, which is used to modify the access control rules associated with a specific object within Active Directory. Attackers may abuse this privilege to grant themselves or other compromised accounts additional rights, ultimately compromising the target object, resulting in privilege escalation, lateral movement, and persistence.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 107,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Active Directory",
          "Use Case: Active Directory Monitoring",
          "Rule Type: BBR",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.blackhat.com/docs/us-17/wednesday/us-17-Robbins-An-ACE-Up-The-Sleeve-Designing-Active-Directory-DACL-Backdoors.pdf"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1222",
                "name": "File and Directory Permissions Modification",
                "reference": "https://attack.mitre.org/techniques/T1222/",
                "subtechnique": [
                  {
                    "id": "T1222.001",
                    "name": "Windows File and Directory Permissions Modification",
                    "reference": "https://attack.mitre.org/techniques/T1222/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'Audit Directory Service Access' logging policy must be configured for (Success, Failure).\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nPolicies >\nWindows Settings >\nSecurity Settings >\nAdvanced Audit Policies Configuration >\nAudit Policies >\nDS Access >\nAudit Directory Service Access (Success,Failure)\n```\n",
        "related_integrations": [
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.code",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.event_data.AccessMask",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "eb41b3f4-386d-49ce-8b2c-ab2eda8b9fb0",
        "rule_id": "f5861570-e39a-4b8a-9259-abd39f84cb97",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:16.972Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:36.208Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-system.security*",
          "logs-windows.*"
        ],
        "filters": [],
        "query": "host.os.type: \"windows\" and event.action : (\"Directory Service Access\" or \"object-operation-performed\") and\n  event.code : \"4662\" and winlog.event_data.AccessMask:\"0x40000\"",
        "language": "kuery"
      },
      {
        "name": "Suspicious Windows Process Cluster Spawned by a Parent Process",
        "description": "A machine learning job combination has detected a set of one or more suspicious Windows processes with unusually high scores for malicious probability. These process(es) have been classified as malicious in several ways. The process(es) were predicted to be malicious by the ProblemChild supervised ML model. If the anomaly contains a cluster of suspicious processes, each process has the same parent process name, and the aggregate score of the event cluster was calculated to be unusually high by an unsupervised ML model. Such a cluster often contains suspicious or malicious activity, possibly involving LOLbins, that may be resistant to detection using conventional search rules.",
        "risk_score": 21,
        "severity": "low",
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 107,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Living off the Land Attack Detection",
          "Rule Type: ML",
          "Rule Type: Machine Learning",
          "Tactic: Defense Evasion"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "15m",
        "from": "now-2700s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/guide/en/security/current/prebuilt-ml-jobs.html",
          "https://docs.elastic.co/en/integrations/problemchild",
          "https://www.elastic.co/security-labs/detecting-living-off-the-land-attacks-with-new-elastic-integration"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1036",
                "name": "Masquerading",
                "reference": "https://attack.mitre.org/techniques/T1036/"
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe rule requires the Living off the Land (LotL) Attack Detection integration assets to be installed, as well as Windows process events collected by integrations such as Elastic Defend or Winlogbeat.  \n\n### LotL Attack Detection Setup\nThe LotL Attack Detection integration detects living-off-the-land activity in Windows process events.\n\n#### Prerequisite Requirements:\n- Fleet is required for LotL Attack Detection.\n- To configure Fleet Server refer to the [documentation](https://www.elastic.co/guide/en/fleet/current/fleet-server.html).\n- Windows process events collected by the [Elastic Defend](https://docs.elastic.co/en/integrations/endpoint) integration or Winlogbeat(https://www.elastic.co/guide/en/beats/winlogbeat/current/_winlogbeat_overview.html).\n- To install Elastic Defend, refer to the [documentation](https://www.elastic.co/guide/en/security/current/install-endpoint.html).\n- To set up and run Winlogbeat, follow [this](https://www.elastic.co/guide/en/beats/winlogbeat/current/winlogbeat-installation-configuration.html) guide.\n\n#### The following steps should be executed to install assets associated with the LotL Attack Detection integration:\n- Go to the Kibana homepage. Under Management, click Integrations.\n- In the query bar, search for Living off the Land Attack Detection and select the integration to see more details about it.\n- Follow the instructions under the **Installation** section.\n- For this rule to work, complete the instructions through **Add preconfigured anomaly detection jobs**.\n",
        "related_integrations": [
          {
            "package": "problemchild",
            "version": "^2.0.0"
          },
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [],
        "id": "2b49107f-8b81-4601-8df2-0e9fb2cd004a",
        "rule_id": "f5d9d36d-7c30-4cdb-a856-9f653c13d4e0",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:16.974Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:36.213Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "machine_learning",
        "anomaly_threshold": 75,
        "machine_learning_job_id": [
          "problem_child_high_sum_by_parent"
        ]
      },
      {
        "name": "Rare SMB Connection to the Internet",
        "description": "This rule detects rare internet network connections via the SMB protocol. SMB is commonly used to leak NTLM credentials via rogue UNC path injection.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 208,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Exfiltration",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.securify.nl/en/blog/living-off-the-land-stealing-netntlm-hashes/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0010",
              "name": "Exfiltration",
              "reference": "https://attack.mitre.org/tactics/TA0010/"
            },
            "technique": [
              {
                "id": "T1048",
                "name": "Exfiltration Over Alternative Protocol",
                "reference": "https://attack.mitre.org/techniques/T1048/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "destination.ip",
            "type": "ip",
            "ecs": true
          },
          {
            "name": "destination.port",
            "type": "long",
            "ecs": true
          },
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "network.transport",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pid",
            "type": "long",
            "ecs": true
          },
          {
            "name": "source.ip",
            "type": "ip",
            "ecs": true
          }
        ],
        "id": "c1ec3b26-cf96-401b-ae0b-5adc820b6eff",
        "rule_id": "f580bf0a-2d23-43bb-b8e1-17548bb947ec",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:16.969Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:36.203Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "event.category:network and host.os.type:windows and process.pid:4 and \n  network.transport:tcp and destination.port:(139 or 445) and \n  source.ip:(\n    10.0.0.0/8 or\n    172.16.0.0/12 or\n    192.168.0.0/16\n  ) and\n  not destination.ip:(\n    10.0.0.0/8 or\n    127.0.0.0/8 or\n    169.254.0.0/16 or\n    172.16.0.0/12 or\n    192.0.0.0/24 or\n    192.0.0.0/29 or\n    192.0.0.8/32 or\n    192.0.0.9/32 or\n    192.0.0.10/32 or\n    192.0.0.170/32 or\n    192.0.0.171/32 or\n    192.0.2.0/24 or\n    192.31.196.0/24 or\n    192.52.193.0/24 or\n    192.168.0.0/16 or\n    192.88.99.0/24 or\n    224.0.0.0/4 or\n    100.64.0.0/10 or\n    192.175.48.0/24 or\n    198.18.0.0/15 or\n    198.51.100.0/24 or\n    203.0.113.0/24 or\n    240.0.0.0/4 or\n    \"::1\" or\n    \"FE80::/10\" or\n    \"FF00::/8\"\n  )",
        "new_terms_fields": [
          "destination.ip"
        ],
        "history_window_start": "now-7d",
        "index": [
          "logs-endpoint.events.network-*",
          "winlogbeat-*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*"
        ],
        "filters": [],
        "language": "kuery"
      },
      {
        "name": "Windows Firewall Disabled via PowerShell",
        "description": "Identifies when the Windows Firewall is disabled using PowerShell cmdlets, which can help attackers evade network constraints, like internet and network lateral communication restrictions.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Windows Firewall Disabled via PowerShell\n\nWindows Defender Firewall is a native component that provides host-based, two-way network traffic filtering for a device and blocks unauthorized network traffic flowing into or out of the local device.\n\nAttackers can disable the Windows firewall or its rules to enable lateral movement and command and control activity.\n\nThis rule identifies patterns related to disabling the Windows firewall or its rules using the `Set-NetFirewallProfile` PowerShell cmdlet.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Inspect the host for suspicious or abnormal behavior in the alert timeframe.\n\n### False positive analysis\n\n- This mechanism can be used legitimately. Check whether the user is an administrator and is legitimately performing troubleshooting.\n- In case of an allowed benign true positive (B-TP), assess adding rules to allow needed traffic and re-enable the firewall.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Re-enable the firewall with its desired configurations.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Review the privileges assigned to the involved users to ensure that the least privilege principle is being followed.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 311,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Tactic: Execution",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Austin Songer"
        ],
        "false_positives": [
          "Windows Firewall can be disabled by a system administrator. Verify whether the user identity, user agent, and/or hostname should be making changes in your environment. Windows Profile being disabled by unfamiliar users should be investigated. If known behavior is causing false positives, it can be exempted from the rule."
        ],
        "references": [
          "https://docs.microsoft.com/en-us/powershell/module/netsecurity/set-netfirewallprofile?view=windowsserver2019-ps",
          "https://www.tutorialspoint.com/how-to-get-windows-firewall-profile-settings-using-powershell",
          "http://powershellhelp.space/commands/set-netfirewallrule-psv5.php",
          "http://woshub.com/manage-windows-firewall-powershell/"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1562",
                "name": "Impair Defenses",
                "reference": "https://attack.mitre.org/techniques/T1562/",
                "subtechnique": [
                  {
                    "id": "T1562.004",
                    "name": "Disable or Modify System Firewall",
                    "reference": "https://attack.mitre.org/techniques/T1562/004/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "b7db548a-3e95-4370-a09a-47aefecee0bd",
        "rule_id": "f63c8e3c-d396-404f-b2ea-0379d3942d73",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:16.977Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:36.218Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (\n    process.name : (\"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\") or\n    ?process.pe.original_file_name in (\"powershell.exe\", \"pwsh.dll\", \"powershell_ise.exe\")\n  ) and\n  process.args : \"*Set-NetFirewallProfile*\" and\n  process.args : \"*-Enabled*\" and process.args : \"*False*\" and\n  process.args : (\"*-All*\", \"*Public*\", \"*Domain*\", \"*Private*\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Delete Volume USN Journal with Fsutil",
        "description": "Identifies use of the fsutil.exe to delete the volume USNJRNL. This technique is used by attackers to eliminate evidence of files created during post-exploitation activities.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Delete Volume USN Journal with Fsutil\n\nThe Update Sequence Number (USN) Journal is a feature in the NTFS file system used by Microsoft Windows operating systems to keep track of changes made to files and directories on a disk volume. The journal records metadata for changes such as file creation, deletion, modification, and permission changes. It is used by the operating system for various purposes, including backup and recovery, file indexing, and file replication.\n\nThis artifact can provide valuable information in forensic analysis, such as programs executed (prefetch file operations), file modification events in suspicious directories, deleted files, etc. Attackers may delete this artifact in an attempt to cover their tracks, and this rule identifies the usage of the `fsutil.exe` utility to accomplish it.\n\nConsider using the Elastic Defend integration instead of USN Journal, as the Elastic Defend integration provides more visibility and context in the file operations it records.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n  - Verify if any other anti-forensics behaviors were observed.\n- Review file operation logs from Elastic Defend for suspicious activity the attacker tried to hide.\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 311,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Endgame",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1070",
                "name": "Indicator Removal",
                "reference": "https://attack.mitre.org/techniques/T1070/",
                "subtechnique": [
                  {
                    "id": "T1070.004",
                    "name": "File Deletion",
                    "reference": "https://attack.mitre.org/techniques/T1070/004/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "772e5fcd-95f8-44b0-9679-8f8bc3e60d26",
        "rule_id": "f675872f-6d85-40a3-b502-c0d2ef101e92",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:16.980Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:36.223Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (process.name : \"fsutil.exe\" or ?process.pe.original_file_name == \"fsutil.exe\") and\n  process.args : \"deletejournal\" and process.args : \"usn\"",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Potential Active Directory Replication Account Backdoor",
        "description": "Identifies the modification of the nTSecurityDescriptor attribute in a domain object with rights related to DCSync to a user/computer account. Attackers can use this backdoor to re-obtain access to hashes of any user/computer.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 104,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Data Source: Active Directory",
          "Use Case: Active Directory Monitoring",
          "Data Source: System"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://twitter.com/menasec1/status/1111556090137903104",
          "https://www.specterops.io/assets/resources/an_ace_up_the_sleeve.pdf",
          "https://github.com/SigmaHQ/sigma/blob/master/rules/windows/builtin/security/win_security_account_backdoor_dcsync_rights.yml",
          "https://learn.microsoft.com/en-us/windows/win32/adschema/r-ds-replication-get-changes-all",
          "https://learn.microsoft.com/en-us/windows/win32/adschema/r-ds-replication-get-changes",
          "https://learn.microsoft.com/en-us/windows/win32/adschema/r-ds-replication-get-changes-in-filtered-set"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1003",
                "name": "OS Credential Dumping",
                "reference": "https://attack.mitre.org/techniques/T1003/",
                "subtechnique": [
                  {
                    "id": "T1003.006",
                    "name": "DCSync",
                    "reference": "https://attack.mitre.org/techniques/T1003/006/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "The 'Audit Directory Service Changes' logging policy must be configured for (Success, Failure).\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nPolicies >\nWindows Settings >\nSecurity Settings >\nAdvanced Audit Policies Configuration >\nAudit Policies >\nDS Access >\nAudit Directory Service Changes (Success,Failure)\n```",
        "related_integrations": [
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.action",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.code",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "winlog.event_data.AttributeLDAPDisplayName",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "winlog.event_data.AttributeValue",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "074a0527-460d-4f26-a037-fa2450bb9a75",
        "rule_id": "f8822053-a5d2-46db-8c96-d460b12c36ac",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:16.983Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:38.023Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-system.security*",
          "logs-windows.forwarded*"
        ],
        "filters": [],
        "query": "event.action:(\"Directory Service Changes\" or \"directory-service-object-modified\") and event.code:\"5136\" and\n  winlog.event_data.AttributeLDAPDisplayName:\"nTSecurityDescriptor\" and\n  winlog.event_data.AttributeValue : (\n    (\n      *1131f6ad-9c07-11d1-f79f-00c04fc2dcd2;;S-1-5-21-* and\n      *1131f6aa-9c07-11d1-f79f-00c04fc2dcd2;;S-1-5-21-* and\n      *89e95b76-444d-4c62-991a-0facbeda640c;;S-1-5-21-*\n    )\n  )",
        "language": "kuery"
      },
      {
        "name": "Remote File Copy to a Hidden Share",
        "description": "Identifies a remote file copy attempt to a hidden network share. This may indicate lateral movement or data staging activity.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 312,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Lateral Movement",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/security-labs/hunting-for-lateral-movement-using-event-query-language"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0008",
              "name": "Lateral Movement",
              "reference": "https://attack.mitre.org/tactics/TA0008/"
            },
            "technique": [
              {
                "id": "T1021",
                "name": "Remote Services",
                "reference": "https://attack.mitre.org/techniques/T1021/",
                "subtechnique": [
                  {
                    "id": "T1021.002",
                    "name": "SMB/Windows Admin Shares",
                    "reference": "https://attack.mitre.org/techniques/T1021/002/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "6009ddae-b3be-4f18-a0a6-b7dc4b9bf34a",
        "rule_id": "fa01341d-6662-426b-9d0c-6d81e33c8a9d",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:16.986Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:38.049Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (\n    process.name : (\"cmd.exe\", \"powershell.exe\", \"xcopy.exe\") and\n    process.args : (\"copy*\", \"move*\", \"cp\", \"mv\") or\n    process.name : \"robocopy.exe\"\n  ) and process.args : \"*\\\\\\\\*\\\\*$*\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "winlogbeat-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Potential Application Shimming via Sdbinst",
        "description": "The Application Shim was created to allow for backward compatibility of software as the operating system codebase changes over time. This Windows functionality has been abused by attackers to stealthily gain persistence and arbitrary code execution in legitimate Windows processes.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "output_index": "",
        "version": 312,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Persistence",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0003",
              "name": "Persistence",
              "reference": "https://attack.mitre.org/tactics/TA0003/"
            },
            "technique": [
              {
                "id": "T1546",
                "name": "Event Triggered Execution",
                "reference": "https://attack.mitre.org/techniques/T1546/",
                "subtechnique": [
                  {
                    "id": "T1546.011",
                    "name": "Application Shimming",
                    "reference": "https://attack.mitre.org/techniques/T1546/011/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1546",
                "name": "Event Triggered Execution",
                "reference": "https://attack.mitre.org/techniques/T1546/",
                "subtechnique": [
                  {
                    "id": "T1546.011",
                    "name": "Application Shimming",
                    "reference": "https://attack.mitre.org/techniques/T1546/011/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "ce1d381c-b99b-4a65-8c09-ee6192cc4192",
        "rule_id": "fd4a992d-6130-4802-9ff8-829b89ae801f",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:16.988Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:38.069Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and process.name : \"sdbinst.exe\" and\n  process.args : \"?*\" and\n  not (process.args : \"-m\" and process.args : \"-bg\") and\n  not process.args : \"-mm\"",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Suspicious CertUtil Commands",
        "description": "Identifies suspicious commands being used with certutil.exe. CertUtil is a native Windows component which is part of Certificate Services. CertUtil is often abused by attackers to live off the land for stealthier command and control or data exfiltration.",
        "risk_score": 47,
        "severity": "medium",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "timeline_id": "e70679c2-6cde-4510-9764-4823df18f7db",
        "timeline_title": "Comprehensive Process Timeline",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Suspicious CertUtil Commands\n\n`certutil.exe` is a command line utility program that is included with Microsoft Windows operating systems. It is used to manage and manipulate digital certificates and certificate services on computers running Windows.\n\nAttackers can abuse `certutil.exe` utility to download and/or deobfuscate malware, offensive security tools, and certificates from external sources to take the next steps in a compromised environment. This rule identifies command line arguments used to accomplish these behaviors.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Examine the command line to determine the nature of the execution.\n  - If files were downloaded, retrieve them and check whether they were run, and under which security context.\n  - If files were obfuscated or deobfuscated, retrieve them.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the involved files using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n\n### False positive analysis\n\n- If this rule is noisy in your environment due to expected activity, consider adding exceptions â€” preferably with a combination of user and command line conditions.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 311,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Defense Evasion",
          "Data Source: Elastic Endgame",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic",
          "Austin Songer"
        ],
        "false_positives": [],
        "references": [
          "https://twitter.com/Moriarty_Meng/status/984380793383370752",
          "https://twitter.com/egre55/status/1087685529016193025",
          "https://www.sysadmins.lv/blog-en/certutil-tips-and-tricks-working-with-x509-file-format.aspx",
          "https://docs.microsoft.com/en-us/archive/blogs/pki/basic-crl-checking-with-certutil",
          "https://www.elastic.co/security-labs/siestagraph-new-implant-uncovered-in-asean-member-foreign-ministry"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1140",
                "name": "Deobfuscate/Decode Files or Information",
                "reference": "https://attack.mitre.org/techniques/T1140/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "4022e051-ddf3-4b74-88db-ae667bce1c9c",
        "rule_id": "fd70c98a-c410-42dc-a2e3-761c71848acf",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:16.991Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:38.074Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "process where host.os.type == \"windows\" and event.type == \"start\" and\n  (process.name : \"certutil.exe\" or ?process.pe.original_file_name == \"CertUtil.exe\") and\n  process.args : (\"?decode\", \"?encode\", \"?urlcache\", \"?verifyctl\", \"?encodehex\", \"?decodehex\", \"?exportPFX\")",
        "language": "eql",
        "index": [
          "winlogbeat-*",
          "logs-endpoint.events.process-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      },
      {
        "name": "Svchost spawning Cmd",
        "description": "Identifies a suspicious parent child process relationship with cmd.exe descending from svchost.exe",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "timeline_id": "e70679c2-6cde-4510-9764-4823df18f7db",
        "timeline_title": "Comprehensive Process Timeline",
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Svchost spawning Cmd\n\nThe Service Host process (SvcHost) is a system process that can host one, or multiple, Windows services in the Windows NT family of operating systems. Note that `Svchost.exe` is reserved for use by the operating system and should not be used by non-Windows services.\n\nThis rule looks for the creation of the `cmd.exe` process with `svchost.exe` as its parent process. This is an unusual behavior that can indicate the masquerading of a malicious process as `svchost.exe` or exploitation for privilege escalation.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate any abnormal behavior by the subject process such as network connections, registry or file modifications, and any spawned child processes.\n- Examine the host for derived artifacts that indicate suspicious activities:\n  - Analyze the process executable using a private sandboxed analysis system.\n  - Observe and collect information about the following activities in both the sandbox and the alert subject host:\n    - Attempts to contact external domains and addresses.\n      - Use the Elastic Defend network events to determine domains and addresses contacted by the subject process by filtering by the process' `process.entity_id`.\n      - Examine the DNS cache for suspicious or anomalous entries.\n        - !{osquery{\"label\":\"Osquery - Retrieve DNS Cache\",\"query\":\"SELECT * FROM dns_cache\"}}\n    - Use the Elastic Defend registry events to examine registry keys accessed, modified, or created by the related processes in the process tree.\n    - Examine the host services for suspicious or anomalous entries.\n      - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n      - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Investigate potentially compromised accounts. Analysts can do this by searching for login events (for example, 4624) to the target host after the registry modification.\n\n\n### False positive analysis\n\n- This activity is unlikely to happen legitimately. Benign true positives (B-TPs) can be added as exceptions if necessary.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 418,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Execution",
          "Resources: Investigation Guide",
          "Data Source: Elastic Endgame",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Sysmon",
          "Data Source: SentinelOne"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://nasbench.medium.com/demystifying-the-svchost-exe-process-and-its-command-line-options-508e9114e747"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/"
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "sentinel_one_cloud_funnel",
            "version": "^1.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.command_line",
            "type": "wildcard",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "a4f6e281-3657-4b31-9049-42c162874454",
        "rule_id": "fd7a6052-58fa-4397-93c3-4795249ccfa2",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:16.994Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:38.079Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "new_terms",
        "query": "host.os.type:windows and event.category:process and event.type:start and process.parent.name:\"svchost.exe\" and\nprocess.name:(\"cmd.exe\" or \"Cmd.exe\" or \"CMD.EXE\") and\nnot process.command_line : \"\\\"cmd.exe\\\" /C sc control hptpsmarthealthservice 211\"",
        "new_terms_fields": [
          "host.id",
          "process.command_line",
          "user.id"
        ],
        "history_window_start": "now-14d",
        "index": [
          "logs-endpoint.events.process-*",
          "winlogbeat-*",
          "logs-windows.forwarded*",
          "logs-windows.sysmon_operational-*",
          "endgame-*",
          "logs-system.security*",
          "logs-m365_defender.event-*",
          "logs-sentinel_one_cloud_funnel.*"
        ],
        "filters": [
          {
            "meta": {
              "negate": true
            },
            "query": {
              "wildcard": {
                "process.args": {
                  "case_insensitive": true,
                  "value": "?:\\\\Windows\\\\system32\\\\silcollector.cmd"
                }
              }
            }
          },
          {
            "meta": {
              "negate": true
            },
            "query": {
              "wildcard": {
                "process.command_line": {
                  "case_insensitive": true,
                  "value": "*?:\\\\Program Files\\\\Npcap\\\\CheckStatus.bat*"
                }
              }
            }
          },
          {
            "meta": {
              "negate": true
            },
            "query": {
              "wildcard": {
                "process.command_line": {
                  "case_insensitive": true,
                  "value": "*?:\\\\Program Files*\\\\Pulseway\\\\watchdog.bat*"
                }
              }
            }
          },
          {
            "meta": {
              "negate": true
            },
            "query": {
              "wildcard": {
                "process.command_line": {
                  "case_insensitive": true,
                  "value": "cmd /C \".\\\\inetsrv\\\\iissetup.exe /keygen \""
                }
              }
            }
          }
        ],
        "language": "kuery"
      },
      {
        "name": "PowerShell Kerberos Ticket Dump",
        "description": "Detects PowerShell scripts that have the capability of dumping Kerberos tickets from LSA, which potentially indicates an attacker's attempt to acquire credentials for lateral movement.",
        "risk_score": 73,
        "severity": "high",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating PowerShell Kerberos Ticket Dump\n\nKerberos is an authentication protocol that relies on tickets to grant access to network resources. Adversaries may abuse this protocol to acquire credentials for lateral movement within a network.\n\nThis rule indicates the use of scripts that contain code capable of dumping Kerberos tickets, which can indicate potential PowerShell abuse for credential theft.\n\n### Possible investigation steps\n\n- Examine the script content that triggered the detection; look for suspicious DLL imports, collection or exfiltration capabilities, suspicious functions, encoded or compressed data, and other potentially malicious characteristics.\n- Investigate the script execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Investigate if the script was executed, and if so, which account was targeted.\n- Identify the account involved and contact the owner to confirm whether they are aware of this activity.\n- Check if the script has any other functionality that can be potentially malicious.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Investigate other potentially compromised accounts and hosts. Review login events (like 4624) for suspicious events involving the subject and target accounts.\n\n### False positive analysis\n\n- If this activity is expected and noisy in your environment, consider adding exceptions â€” preferably with a combination of file path and user ID conditions.\n\n### Related Rules\n\n- PowerShell Kerberos Ticket Request - eb610e70-f9e6-4949-82b9-f1c5bcd37c39\n\n### Response and Remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n  - If malicious activity is confirmed, perform a broader investigation to identify the scope of the compromise and determine the appropriate remediation steps.\n- Isolate the involved hosts to prevent further post-compromise behavior.\n- Disable or limit involved accounts during the investigation and response.\n- If the triage identified malware, search the environment for additional compromised hosts.\n  - Implement temporary network rules, procedures, and segmentation to contain the malware.\n  - Stop suspicious processes.\n  - Immediately block the identified indicators of compromise (IoCs).\n  - Inspect the affected systems for additional malware backdoors like reverse shells, reverse proxies, or droppers that attackers could use to reinfect the system.\n- Remove and block malicious artifacts identified during triage.\n- Reimage the host operating system or restore the compromised files to clean versions.\n- Restrict PowerShell usage outside of IT and engineering business units using GPOs, AppLocker, Intune, or similar software.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 107,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Credential Access",
          "Data Source: PowerShell Logs"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://github.com/MzHmO/PowershellKerberos/blob/main/dumper.ps1"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0006",
              "name": "Credential Access",
              "reference": "https://attack.mitre.org/tactics/TA0006/"
            },
            "technique": [
              {
                "id": "T1003",
                "name": "OS Credential Dumping",
                "reference": "https://attack.mitre.org/techniques/T1003/"
              },
              {
                "id": "T1558",
                "name": "Steal or Forge Kerberos Tickets",
                "reference": "https://attack.mitre.org/techniques/T1558/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'PowerShell Script Block Logging' logging policy must be enabled.\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nAdministrative Templates >\nWindows PowerShell >\nTurn on PowerShell Script Block Logging (Enable)\n```\n\nSteps to implement the logging policy via registry:\n\n```\nreg add \"hklm\\SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\ScriptBlockLogging\" /v EnableScriptBlockLogging /t REG_DWORD /d 1\n```\n",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "powershell.file.script_block_text",
            "type": "unknown",
            "ecs": false
          }
        ],
        "id": "352e52a5-4dd0-4d62-88f1-75b429ac263e",
        "rule_id": "fddff193-48a3-484d-8d35-90bb3d323a56",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:16.998Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:38.084Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-windows.powershell*"
        ],
        "filters": [],
        "query": "event.category:process and host.os.type:windows and\n  powershell.file.script_block_text : (\n    \"LsaCallAuthenticationPackage\" and\n    (\n      \"KerbRetrieveEncodedTicketMessage\" or\n      \"KerbQueryTicketCacheMessage\" or\n      \"KerbQueryTicketCacheExMessage\" or\n      \"KerbQueryTicketCacheEx2Message\" or\n      \"KerbRetrieveTicketMessage\" or\n      \"KerbDecryptDataMessage\"\n    )\n  )",
        "language": "kuery"
      },
      {
        "name": "PowerShell Script with Password Policy Discovery Capabilities",
        "description": "Identifies the use of Cmdlets and methods related to remote execution activities using WinRM. Attackers can abuse WinRM to perform lateral movement using built-in tools.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "",
        "building_block_type": "default",
        "output_index": "",
        "version": 107,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Discovery",
          "Tactic: Execution",
          "Data Source: PowerShell Logs",
          "Rule Type: BBR"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "60m",
        "from": "now-7140s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0007",
              "name": "Discovery",
              "reference": "https://attack.mitre.org/tactics/TA0007/"
            },
            "technique": [
              {
                "id": "T1201",
                "name": "Password Policy Discovery",
                "reference": "https://attack.mitre.org/techniques/T1201/"
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "## Setup\n\nThe 'PowerShell Script Block Logging' logging policy must be enabled.\nSteps to implement the logging policy with Advanced Audit Configuration:\n\n```\nComputer Configuration >\nAdministrative Templates >\nWindows PowerShell >\nTurn on PowerShell Script Block Logging (Enable)\n```\n\nSteps to implement the logging policy via registry:\n\n```\nreg add \"hklm\\SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\ScriptBlockLogging\" /v EnableScriptBlockLogging /t REG_DWORD /d 1\n```\n",
        "related_integrations": [
          {
            "package": "windows",
            "version": "^2.0.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.category",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "powershell.file.script_block_text",
            "type": "unknown",
            "ecs": false
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "c5d5557f-0de1-4b2b-afee-7f3fe8505b7a",
        "rule_id": "fe25d5bc-01fa-494a-95ff-535c29cc4c96",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:17.022Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:38.089Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "query",
        "index": [
          "winlogbeat-*",
          "logs-windows.powershell*"
        ],
        "filters": [],
        "query": "event.category: \"process\" and host.os.type:windows and\n(\n  powershell.file.script_block_text: (\n    \"Get-ADDefaultDomainPasswordPolicy\" or\n    \"Get-ADFineGrainedPasswordPolicy\" or\n    \"Get-ADUserResultantPasswordPolicy\" or\n    \"Get-DomainPolicy\" or\n    \"Get-GPPPassword\" or\n    \"Get-PassPol\"\n  )\n  or\n  powershell.file.script_block_text: (\n    (\"defaultNamingContext\" or \"ActiveDirectory.DirectoryContext\" or \"ActiveDirectory.DirectorySearcher\") and\n    (\n      (\n        \".MinLengthPassword\" or\n        \".MinPasswordAge\" or\n        \".MaxPasswordAge\"\n      ) or\n      (\n        \"minPwdAge\" or\n        \"maxPwdAge\" or\n        \"minPwdLength\"\n      ) or\n      (\n        \"msDS-PasswordSettings\"\n      )\n    )\n  )\n) and not powershell.file.script_block_text : (\n    \"sentinelbreakpoints\" and \"Set-PSBreakpoint\" and \"PowerSploitIndicators\"\n  )\n  and not \n  (\n    powershell.file.script_block_text : (\"43c15630-959c-49e4-a977-758c5cc93408\" and \"CmdletsToExport\" and \"ActiveDirectory.Types.ps1xml\")\n  )\n  and not user.id : \"S-1-5-18\"",
        "language": "kuery"
      },
      {
        "name": "Service Control Spawned via Script Interpreter",
        "description": "Identifies Service Control (sc.exe) spawning from script interpreter processes to create, modify, or start services. This can potentially indicate an attempt to elevate privileges or maintain persistence.",
        "risk_score": 21,
        "severity": "low",
        "timestamp_override": "event.ingested",
        "timestamp_override_fallback_disabled": false,
        "license": "Elastic License v2",
        "note": "## Triage and analysis\n\n### Investigating Service Control Spawned via Script Interpreter\n\nWindows services are background processes that run with SYSTEM privileges and provide specific functionality or support to other applications and system components.\n\nThe `sc.exe` command line utility is used to manage and control Windows services on a local or remote computer. Attackers may use `sc.exe` to create, modify, and start services to elevate their privileges from administrator to SYSTEM.\n\n> **Note**:\n> This investigation guide uses the [Osquery Markdown Plugin](https://www.elastic.co/guide/en/security/master/invest-guide-run-osquery.html) introduced in Elastic Stack version 8.5.0. Older Elastic Stack versions will display unrendered Markdown in this guide.\n\n#### Possible investigation steps\n\n- Investigate the process execution chain (parent process tree) for unknown processes. Examine their executable files for prevalence, whether they are located in expected locations, and if they are signed with valid digital signatures.\n- Examine the command line, registry changes events, and Windows events related to service activities (for example, 4697 and/or 7045) for suspicious characteristics.\n  - Examine the created and existent services, the executables or drivers referenced, and command line arguments for suspicious entries.\n    - !{osquery{\"label\":\"Osquery - Retrieve All Services\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services\"}}\n    - !{osquery{\"label\":\"Osquery - Retrieve Services Running on User Accounts\",\"query\":\"SELECT description, display_name, name, path, pid, service_type, start_type, status, user_account FROM services WHERE\\nNOT (user_account LIKE '%LocalSystem' OR user_account LIKE '%LocalService' OR user_account LIKE '%NetworkService' OR\\nuser_account == null)\\n\"}}\n    - !{osquery{\"label\":\"Osquery - Retrieve Service Unsigned Executables with Virustotal Link\",\"query\":\"SELECT concat('https://www.virustotal.com/gui/file/', sha1) AS VtLink, name, description, start_type, status, pid,\\nservices.path FROM services JOIN authenticode ON services.path = authenticode.path OR services.module_path =\\nauthenticode.path JOIN hash ON services.path = hash.path WHERE authenticode.result != 'trusted'\\n\"}}\n  - Retrieve the referenced files' SHA-256 hash values using the PowerShell `Get-FileHash` cmdlet and search for the existence and reputation of the hashes in resources like VirusTotal, Hybrid-Analysis, CISCO Talos, Any.run, etc.\n- Identify the user account that performed the action and whether it should perform this kind of action.\n- Contact the account owner and confirm whether they are aware of this activity.\n- Investigate other alerts associated with the user/host during the past 48 hours.\n- Assess whether this behavior is prevalent in the environment by looking for similar occurrences across hosts.\n\n### False positive analysis\n\n- This activity is not inherently malicious if it occurs in isolation. As long as the analyst did not identify suspicious activity related to the user, host, and service, such alerts can be dismissed.\n\n### Response and remediation\n\n- Initiate the incident response process based on the outcome of the triage.\n- Isolate the involved host to prevent further post-compromise behavior.\n- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.\n- Delete the service or restore it to the original configuration.\n- Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.\n- Determine the initial vector abused by the attacker and take action to prevent reinfection through the same vector.\n- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the mean time to respond (MTTR).\n",
        "output_index": "",
        "version": 213,
        "tags": [
          "Domain: Endpoint",
          "OS: Windows",
          "Use Case: Threat Detection",
          "Tactic: Privilege Escalation",
          "Tactic: Defense Evasion",
          "Tactic: Execution",
          "Data Source: Elastic Endgame",
          "Resources: Investigation Guide",
          "Data Source: Elastic Defend",
          "Data Source: System",
          "Data Source: Microsoft Defender for Endpoint",
          "Data Source: Crowdstrike"
        ],
        "enabled": false,
        "risk_score_mapping": [],
        "severity_mapping": [],
        "interval": "5m",
        "from": "now-540s",
        "to": "now",
        "actions": [],
        "exceptions_list": [],
        "author": [
          "Elastic"
        ],
        "false_positives": [],
        "references": [
          "https://www.elastic.co/security-labs/invisible-miners-unveiling-ghostengine"
        ],
        "max_signals": 100,
        "threat": [
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0004",
              "name": "Privilege Escalation",
              "reference": "https://attack.mitre.org/tactics/TA0004/"
            },
            "technique": [
              {
                "id": "T1543",
                "name": "Create or Modify System Process",
                "reference": "https://attack.mitre.org/techniques/T1543/",
                "subtechnique": [
                  {
                    "id": "T1543.003",
                    "name": "Windows Service",
                    "reference": "https://attack.mitre.org/techniques/T1543/003/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0002",
              "name": "Execution",
              "reference": "https://attack.mitre.org/tactics/TA0002/"
            },
            "technique": [
              {
                "id": "T1047",
                "name": "Windows Management Instrumentation",
                "reference": "https://attack.mitre.org/techniques/T1047/"
              },
              {
                "id": "T1059",
                "name": "Command and Scripting Interpreter",
                "reference": "https://attack.mitre.org/techniques/T1059/",
                "subtechnique": [
                  {
                    "id": "T1059.001",
                    "name": "PowerShell",
                    "reference": "https://attack.mitre.org/techniques/T1059/001/"
                  },
                  {
                    "id": "T1059.003",
                    "name": "Windows Command Shell",
                    "reference": "https://attack.mitre.org/techniques/T1059/003/"
                  },
                  {
                    "id": "T1059.005",
                    "name": "Visual Basic",
                    "reference": "https://attack.mitre.org/techniques/T1059/005/"
                  }
                ]
              }
            ]
          },
          {
            "framework": "MITRE ATT&CK",
            "tactic": {
              "id": "TA0005",
              "name": "Defense Evasion",
              "reference": "https://attack.mitre.org/tactics/TA0005/"
            },
            "technique": [
              {
                "id": "T1218",
                "name": "System Binary Proxy Execution",
                "reference": "https://attack.mitre.org/techniques/T1218/",
                "subtechnique": [
                  {
                    "id": "T1218.010",
                    "name": "Regsvr32",
                    "reference": "https://attack.mitre.org/techniques/T1218/010/"
                  },
                  {
                    "id": "T1218.011",
                    "name": "Rundll32",
                    "reference": "https://attack.mitre.org/techniques/T1218/011/"
                  }
                ]
              }
            ]
          }
        ],
        "setup": "",
        "related_integrations": [
          {
            "package": "endpoint",
            "version": "^8.2.0"
          },
          {
            "package": "system",
            "version": "^1.6.4"
          },
          {
            "package": "windows",
            "version": "^2.0.0"
          },
          {
            "package": "m365_defender",
            "version": "^2.0.0"
          },
          {
            "package": "crowdstrike",
            "version": "^1.1.0"
          }
        ],
        "required_fields": [
          {
            "name": "event.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "host.os.type",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.args",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.parent.name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "process.pe.original_file_name",
            "type": "keyword",
            "ecs": true
          },
          {
            "name": "user.id",
            "type": "keyword",
            "ecs": true
          }
        ],
        "id": "8648d2d7-0d1b-45f8-94a3-f88c8945d70a",
        "rule_id": "e8571d5f-bea1-46c2-9f56-998de2d3ed95",
        "immutable": true,
        "rule_source": {
          "type": "external",
          "is_customized": false
        },
        "updated_at": "2024-12-16T15:18:16.938Z",
        "updated_by": "elastic",
        "created_at": "2024-12-16T15:16:36.072Z",
        "created_by": "elastic",
        "revision": 1,
        "type": "eql",
        "query": "/* This rule is not compatible with Sysmon due to user.id issues */\n\nprocess where host.os.type == \"windows\" and event.type == \"start\" and\n  (process.name : \"sc.exe\" or ?process.pe.original_file_name == \"sc.exe\") and\n  process.parent.name : (\"cmd.exe\", \"wscript.exe\", \"rundll32.exe\", \"regsvr32.exe\",\n                         \"wmic.exe\", \"mshta.exe\",\"powershell.exe\", \"pwsh.exe\") and\n  process.args:(\"config\", \"create\", \"start\", \"delete\", \"stop\", \"pause\") and\n  /* exclude SYSTEM SID - look for service creations by non-SYSTEM user */\n  not user.id : \"S-1-5-18\"",
        "language": "eql",
        "index": [
          "logs-endpoint.events.process-*",
          "logs-system.security*",
          "winlogbeat-*",
          "logs-windows.forwarded*",
          "endgame-*",
          "logs-m365_defender.event-*",
          "logs-crowdstrike.fdr*"
        ],
        "filters": []
      }
    ],
    "skipped": []
  },
  "errors": [
    {
      "message": "Rule update for rule 37b211e8-4e2f-440f-86d8-06cc8f158cfa has a rule type change. All 'pick_version' values for rule must match 'TARGET'",
      "rules": [
        {
          "rule_id": "37b211e8-4e2f-440f-86d8-06cc8f158cfa"
        }
      ]
    }
  ]
}